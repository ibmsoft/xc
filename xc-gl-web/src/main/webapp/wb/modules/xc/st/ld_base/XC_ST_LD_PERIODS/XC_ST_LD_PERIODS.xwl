{"inframe":false,"title":"库存会计期管理","hidden":false,"roles":{"default":1},"children":[{"configs":{"loginRequired":"false","serverScript":"//---------------------获取当前模块语言对应的.json文件，放到request中----------------\ncom.xzsoft.xip.platform.util.XipUtil.getCurrentLang(request,\"xc/st/ld_base/XC_ST_LD_PERIODS/json/XC_ST_LD_PERIODS\");","itemId":"module"},"events":{"finalize":"function returnRowFn(r,type){\n    if(type==='xip_pub_orgs'){\n        app.LEDGER_NAME.setValue(r.data.LEDGER_NAME);\n        app.LEDGER_ID.setValue(r.data.LEDGER_ID);\n        app.ORG_ID.setValue(r.data.ORG_ID);\n        app.queryBtn.fireEvent('click');\n    }\n}\nfunction clearOtherFn(type){\n    if(type=='xip_pub_orgs'){\n        app.LEDGER_NAME.setValue(null);\n        app.LEDGER_ID.setValue(null);\n        app.ORG_ID.setValue(null);\n    }\n}"},"children":[{"configs":{"itemId":"tools"},"children":[{"configs":{"autoLoad":"true","itemId":"orgInitStore","url":"m?xwl=xc/com-lov/ORG_PICK/DB/ORG_SELECT_BY_LEDGER"},"events":{"load":"if(store.getCount() > 0){\n    app.LEDGER_ID.setValue(store.getAt(0).get('LEDGER_ID'));\n    app.LEDGER_NAME.setValue(store.getAt(0).get('LEDGER_NAME'));\n    app.ORG_ID.setValue(store.getAt(0).get('ORG_ID'));\n    app.ORG_XWL.ORG_ID.setValue(store.getAt(0).get('ORG_ID'));\n    app.ORG_XWL.ORG_NAME.setValue(store.getAt(0).get('ORG_NAME'));\n    app.queryBtn.fireEvent('click');\n}"},"children":[],"expanded":false,"type":"store"}],"expanded":true,"type":"folder"},{"configs":{"title":"{#XC_ST_LD_PERIODS_syncBtn#}","height":"500","width":"800","layout":"border","closeAction":"hide","buttonAlign":"center","itemId":"syncWindow","dialog":"true"},"events":{"ok":"var rec = app.syncGrid.getSelection();\nif(rec.length === 0){\n    Wb.toast('{#XC_ST_LD_PERIODS_qxzxytbdsj#}');\n    return;\n}\n//得到上一个会计期，进而判断上一个会计期是否已经同步\nvar lastPeriod = null;\nvar store = app.syncGrid.store;\nfor(var i = 0;i < store.getCount();i++){\n    if(rec[rec.length - 1].data.PERIOD_CODE == store.getAt(i).data.PERIOD_CODE && i >= 0){\n        if(rec[rec.length - 1].data.PERIOD_CODE == store.getAt(store.getCount()-1).data.PERIOD_CODE)\n            lastPeriod = null;\n        else\n            lastPeriod = store.getAt(i+1).data.PERIOD_CODE;\n    }\n}\n//选择的不是第一个会计期\nif(!Wb.isEmpty(lastPeriod)){\n\tWb.request({\n    url : 'm?xwl=xc/st/common/data/stLdPeriodSelect',\n        params : {ST_PERIODS : lastPeriod,LEDGER_ID : app.LEDGER_ID.getValue()},\n        success : function(resp){\n            var res = Wb.decode(resp.responseText);\n            if(res.total > 0){\n                sync();\n            }\n            else{\n                Wb.toast('{#XC_ST_LD_PERIODS_sqkjqwtbqxtbsqkjq#}');//上期会计期未同步，请先同步上期会计期！\n            }\n        }\n    });\n}\nelse\n    sync();\nfunction sync(){\n\tWb.request({\n        url : 'm?xwl=xc/st/ld_base/XC_ST_LD_PERIODS/data/stLdPeriodInsert', \n        params : {ORG_ID : app.ORG_ID.getValue(),'infoArray' : Wb.encode(Wb.getData(rec))},\n        success: function(resp) {\n            app.syncGrid.store.load({params : {LEDGER_ID : app.LEDGER_ID.getValue()}});\n            app.queryBtn.fireEvent('click');\n            Wb.toast('{#XC_ST_LD_PERIODS_tbcg#}');\n        }\n    });\n}"},"children":[{"configs":{"region":"center","selType":"checkboxmodel","itemId":"syncGrid"},"children":[{"configs":{"itemId":"store","url":"m?xwl=xc/st/ld_base/XC_ST_LD_PERIODS/data/glLdPeriodSelect"},"children":[],"expanded":false,"type":"store"},{"configs":{"itemId":"columns"},"children":[{"configs":{"text":"{#XC_ST_LD_PERIODS_NUMBER_COL#}","align":"center","width":"50","xtype":"rownumberer","titleAlign":"center","itemId":"NUMBER_COL"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#XC_ST_LD_PERIODS_PERIOD_CODE#}","width":"100","dataIndex":"PERIOD_CODE","titleAlign":"center","itemId":"PERIOD_CODE_COL"},"children":[],"expanded":true,"type":"column"},{"configs":{"text":"{#XC_ST_LD_PERIODS_YEAR#}","width":"100","dataIndex":"YEAR","titleAlign":"center","itemId":"YEAR_COL"},"children":[],"expanded":true,"type":"column"},{"configs":{"text":"{#XC_ST_LD_PERIODS_START_DATE#}","width":"100","dataIndex":"START_DATE","titleAlign":"center","itemId":"START_DATE_COL"},"children":[],"expanded":true,"type":"column"},{"configs":{"text":"{#XC_ST_LD_PERIODS_END_DATE#}","width":"100","dataIndex":"END_DATE","titleAlign":"center","itemId":"END_DATE_COL"},"children":[],"expanded":true,"type":"column"},{"configs":{"text":"{#XC_ST_LD_PERIODS_PERIODS_STATUS#}","width":"100","dataIndex":"LD_PERIOD_STATUS_NAME","titleAlign":"center","itemId":"PERIODS_STATUS_COL"},"children":[],"expanded":true,"type":"column"}],"expanded":true,"type":"array"}],"expanded":true,"type":"grid"}],"expanded":true,"type":"window"},{"configs":{"layout":"border","itemId":"viewport1"},"children":[{"configs":{"region":"north","itemId":"search_form"},"children":[{"configs":{"layout":"column","margin":"5 0 5 0","itemId":"row1","border":"false"},"children":[{"configs":{"layout":"form","columnWidth":".249","itemId":"row1_1","border":"false"},"children":[{"configs":{"file":"m?xwl=xc/com-lov/ORG_PICK/ORG_ALL_PICK","itemId":"ORG_XWL"},"children":[],"expanded":false,"type":"xwl"}],"expanded":true,"type":"panel"},{"configs":{"layout":"form","columnWidth":".249","itemId":"row1_2","border":"false"},"children":[{"configs":{"labelWidth":"80","labelAlign":"right","itemId":"YEAR","fieldLabel":"年度"},"events":{"specialkey":"if(e.getKey() == 13){\n\tapp.queryBtn.fireEvent('click');\n}"},"children":[],"expanded":false,"type":"text"}],"expanded":true,"type":"panel"},{"configs":{"layout":"column","columnWidth":".249","margin":"5 0 0 0","itemId":"row1_4","border":"false"},"children":[{"configs":{"text":"{#XC_ST_LD_PERIODS_searchButton#}","itemId":"queryBtn","iconCls":"seek_icon"},"events":{"click":"app.grid.store.load({params : {LEDGER_ID : app.LEDGER_ID.getValue(),\n                              YEAR : app.YEAR.getValue()}});"},"children":[],"expanded":false,"type":"button"},{"configs":{"text":"{#XC_ST_LD_PERIODS_resetButton#}","itemId":"clearBtn","iconCls":"refresh_icon"},"events":{"click":"app.search_form.getForm().reset();\napp.queryBtn.fireEvent('click');"},"children":[],"expanded":false,"type":"button"}],"expanded":true,"type":"panel"},{"configs":{"layout":"form","columnWidth":".249","itemId":"rowHide","border":"false"},"children":[{"configs":{"labelWidth":"80","readOnly":"true","hidden":"true","labelAlign":"right","itemId":"LEDGER_NAME","fieldLabel":"账簿"},"children":[],"expanded":false,"type":"text"},{"configs":{"labelWidth":"80","readOnly":"true","hidden":"true","labelAlign":"right","itemId":"LEDGER_ID","fieldLabel":"账簿ID"},"children":[],"expanded":false,"type":"text"},{"configs":{"labelWidth":"80","readOnly":"true","hidden":"true","labelAlign":"right","itemId":"ORG_ID","fieldLabel":"组织ID"},"children":[],"expanded":false,"type":"text"}],"expanded":true,"type":"panel"}],"expanded":true,"type":"panel"}],"expanded":true,"type":"form"},{"configs":{"region":"center","barExportAllButtons":"false","barExportButtons":"false","itemId":"grid","editable":"true"},"children":[{"configs":{"itemId":"store","url":"m?xwl=xc/st/common/data/stLdPeriodSelect"},"children":[],"expanded":false,"type":"store"},{"configs":{"itemId":"tbar"},"children":[{"configs":{"text":"{#XC_ST_LD_PERIODS_syncBtn#}","itemId":"syncBtn","iconCls":"record_copy_icon"},"events":{"click":"if(Wb.isEmpty(app.ORG_XWL.ORG_NAME.getValue())){\n\tWb.toast('{#XC_ST_LD_PERIODS_qxxzzzzjxtbcz#}');\n    return;\n}\n//判断当前账簿是否启用库存开始会计期\nWb.request({\n        url : 'm?xwl=xc/st/common/data/xcGlLedgerSelectByLedgerId',\n        params : {LEDGER_ID : app.LEDGER_ID.getValue()},\n        success : function(resp){\n            var res = Wb.decode(resp.responseText).rows[0];\n            if(Wb.isEmpty(res.ST_PERIOD_CODE))\n                Wb.toast('{#XC_ST_LD_PERIODS_dqzzdydzbmyqykckskjq#}');//当前组织对应的账簿没有启用库存开始会计期！\n            else{\n                app.syncGrid.store.load({params : {LEDGER_ID : app.LEDGER_ID.getValue()}});\n                app.syncWindow.show();\n            }\n        }\n    });"},"children":[],"expanded":false,"type":"button"}],"expanded":true,"type":"toolbar"},{"configs":{"itemId":"columns"},"children":[{"configs":{"text":"{#XC_ST_LD_PERIODS_NUMBER_COL#}","align":"center","width":"50","xtype":"rownumberer","titleAlign":"center","itemId":"NUMBER_COL"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#XC_ST_LD_PERIODS_ST_PERIODS#}","width":"100","dataIndex":"ST_PERIODS","titleAlign":"center","itemId":"ST_PERIODS_COL"},"children":[],"expanded":true,"type":"column"},{"configs":{"text":"{#XC_ST_LD_PERIODS_START_DATE#}","width":"100","dataIndex":"START_DATE","titleAlign":"center","itemId":"START_DATE_COL"},"children":[],"expanded":true,"type":"column"},{"configs":{"text":"{#XC_ST_LD_PERIODS_END_DATE#}","width":"100","dataIndex":"END_DATE","titleAlign":"center","itemId":"END_DATE_COL"},"children":[],"expanded":true,"type":"column"},{"configs":{"text":"{#XC_ST_LD_PERIODS_PERIODS_STATUS#}","width":"100","dataIndex":"PERIODS_STATUS","titleAlign":"center","itemId":"PERIODS_STATUS_COL","renderer":"if(value == '0')\n  return '{#XC_ST_LD_PERIODS_status_0#}';\nif(value == '1')\n  return '{#XC_ST_LD_PERIODS_status_1#}';\nif(value == '2')\n  return '{#XC_ST_LD_PERIODS_status_2#}';\nif(value == '3')\n  return '{#XC_ST_LD_PERIODS_status_3#}';"},"children":[{"configs":{"pickList":"[\n  ['0','{#XC_ST_LD_PERIODS_status_0#}'],\n  ['1','{#XC_ST_LD_PERIODS_status_1#}'],\n  ['2','{#XC_ST_LD_PERIODS_status_2#}'],\n  ['3','{#XC_ST_LD_PERIODS_status_3#}']\n]","itemId":"editor"},"events":{"change":"/*\n  1、未打开、打开、冻结、关闭4个状态\n  2、打开第一个会计期时需要确认所有仓库期初已经记账，否则不能打开账簿。\n  3、会计期需要依次打开，上期未关闭本期不能打开（第一个会计期除外），系统默认按打开会计期处理业务\n  4、打开的会计期支持冻结和取消冻结，冻结后本会计期不能处理新增和修改业务单据，但能够进行查询业务，但会计平台制单不受影响。冻结时需要判断本会计期是否有未提交业务单据，如果存在则给出提示，是否强制冻结，强制冻结后未提交单据将来只能提交到下一会计期\n  5、上期处于冻结期时，新增出入库单据时只能录入到下一会计期，单据提交后处于未记账状态。当打开下一会计期时将这部分单据自动记账\n  6、关闭会计期时需要控制本会计期财务业务处理完毕，否则不能关闭\n*/\nvar rec = app.grid.getSelection();\n//得到上一个会计期，进而判断上一个会计期是否已经同步\nvar lastPeriod = null;\nvar store = app.grid.store;\nfor(var i = 0;i < store.getCount();i++){\n    if(rec[0].data.ST_PERIODS == store.getAt(i).data.ST_PERIODS && i >= 0){\n        if(rec[0].data.ST_PERIODS == store.getAt(store.getCount()-1).data.ST_PERIODS)\n            lastPeriod = null;\n        else\n            lastPeriod = store.getAt(i+1).data.ST_PERIODS;\n    }\n}\nvar msg = null;\nif(newValue == '1'){//打开\n    msg = '{#XC_ST_LD_PERIODS_sqkjqwgbbqkjqbndk#}';//上期会计期未关闭，本期会计期不能打开！\n    //判断当前账簿下的会计期是否有打开的\n\tWb.request({\n        url : 'm?xwl=xc/st/common/data/stLdPeriodSelect',\n        params : {LEDGER_ID : app.LEDGER_ID.getValue(),PERIODS_STATUS : '1'},\n        success : function(resp){\n            var res = Wb.decode(resp.responseText);\n            if(res.total > 0)\n                Wb.toast('{#XC_ST_LD_PERIODS_dqzbyjdkkjqbnzdkyg#}');//当前账簿下已经打开会计期，不能再打开一个！\n            else\n                checkInfo();\n        }\n    });\n}\nif(newValue == '2'){//关闭\n    msg = '{#XC_ST_LD_PERIODS_sqkjqwgbbqkjqbngb#}';//上期会计期未关闭，本期会计期不能关闭！\n    //判断当前账簿下的会计期是否正在发生业务，不能关闭\n\tWb.request({\n        url : 'm?xwl=xc/st/ld_base/XC_ST_LD_PERIODS/data/stPeriodIsUseAndBizStatus',\n        params : {START_DATE : rec[0].data.START_DATE,END_DATE : rec[0].data.END_DATE,STATUS : \"= '1'\"},\n        success : function(resp){\n            var res = Wb.decode(resp.responseText);\n            if(res.total > 0)\n                Wb.toast(\"{#XC_ST_LD_PERIODS_dqkjqzzfsywbngb#}\");//当前账簿下的会计期是否正在发生业务，不能关闭\n            else\n                checkInfo();\n        }\n    });\n}\nif(newValue == '3'){//冻结\n    msg = '{#XC_ST_LD_PERIODS_sqkjqwtbqxtbsqkdj#}';//上期会计期未关闭，本期会计期不能冻结！\n    //冻结时需要判断本会计期是否有未提交业务单据，如果存在则给出提示，是否强制冻结，强制冻结后未提交单据将来只能提交到下一会计期\n\tWb.request({\n        url : 'm?xwl=xc/st/ld_base/XC_ST_LD_PERIODS/data/stPeriodIsUseAndBizStatus',\n        params : {START_DATE : rec[0].data.START_DATE,END_DATE : rec[0].data.END_DATE,STATUS : \"<> '1'\"},\n        success : function(resp){\n            var res = Wb.decode(resp.responseText);\n            if(res.total > 0){\n                Ext.Msg.confirm('{#XC_ST_LD_PERIODS_warning#}','{#XC_ST_LD_PERIODS_dqkjqxywtjdywdj#}',function(id){\n                    if(id == 'yes')\n                        checkInfo();\n                    else\n                        app.queryBtn.fireEvent('click');\n                });\n            }\n            else\n                checkInfo();\n        }\n    });\n}\nif(newValue == '0'){//未打开\n\tcheckInfo();\n}\nfunction checkInfo(){\n    //选择的不是第一个会计期\n    if(!Wb.isEmpty(lastPeriod)){\n        //判断上一个会计期是否已经关闭\n        Wb.request({\n        url : 'm?xwl=xc/st/common/data/stLdPeriodSelect',\n            params : {ST_PERIODS : lastPeriod,LEDGER_ID : app.LEDGER_ID.getValue()},\n            success : function(resp){\n                var res = Wb.decode(resp.responseText);\n                if(res.total > 0){\n                    //上期会计期是未打开状态/或者是打开状态，都不能打开本期会计期\n                    if(res.rows[0].PERIODS_STATUS == '0' || res.rows[0].PERIODS_STATUS == '1')\n                        Wb.toast(msg);\n                    else\n                        changeStatus();\n                }\n            }\n        });\n    }\n    else{\n        //打开第一个会计期时需要确认所有仓库期初已经记账，否则不能打开账簿会计期\n        //根据账簿查询库存期初是否全部已经记账\n        Wb.request({\n            url : 'm?xwl=xc/st/st_business/XC_ST_WH_ENTRY/data/stWhEntryHSelect',\n            params : {LEDGER_ID : app.LEDGER_ID.getValue(),INIT : '0'},\n            success : function(resp){\n                var res = Wb.decode(resp.responseText);\n                if(res.total > 0)\n                    Wb.toast('{#XC_ST_LD_PERIODS_czqcdjwjzbndkzbkjq#}');//存在期初单据未记账，不能打开账簿会计期！\n                else\n                    changeStatus();\n            }\n        });\n    }\n}\nfunction changeStatus(){\n    Wb.request({\n        url : 'm?xwl=xc/st/ld_base/XC_ST_LD_PERIODS/data/stLdPeriodUpdateStatus',\n        params : {LEDGER_ID : rec[0].data.LEDGER_ID,ST_PERIODS : rec[0].data.ST_PERIODS,PERIODS_STATUS : newValue},\n        success : function(resp){\n            app.queryBtn.fireEvent('click');\n        }\n    });\n}","focus":"var rec = app.grid.getSelection();\nif(rec[0].data.PERIODS_STATUS != '0'){\n    combo.getStore().removeAt(0);\n}\n//得到当前账簿启用的是那个开始会计期，在开始会计期下面的不能修改\nWb.request({\n    url : 'm?xwl=xc/st/common/data/xcGlLedgerSelectByLedgerId',\n    params : {LEDGER_ID : app.LEDGER_ID.getValue()},\n    success : function(resp){\n        var res = Wb.decode(resp.responseText).rows[0];\n        if(rec[0].data.ST_PERIODS < res.ST_PERIOD_CODE)\n            app.PERIODS_STATUS_COL.getEditor().setReadOnly(true);\n        else\n            app.PERIODS_STATUS_COL.getEditor().setReadOnly(false);\n    }\n});","blur":"combo.getStore().reload();"},"children":[],"expanded":true,"type":"combo"}],"expanded":true,"type":"column"}],"expanded":true,"type":"array"}],"expanded":true,"type":"grid"}],"expanded":true,"type":"viewport"}],"expanded":true,"type":"module"}],"pageLink":"","iconCls":""}