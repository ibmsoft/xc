{"inframe":false,"title":"选择物料公用界面(先进先出法)","hidden":false,"roles":{"default":1},"children":[{"configs":{"loginRequired":"false","serverScript":"//---------------------获取当前模块语言对应的.json文件，放到request中----------------\ncom.xzsoft.xip.platform.util.XipUtil.getCurrentLang(request,\"xc/st/common/json/XC_ST_COMMON\");","itemId":"module"},"events":{"initialize":"var LEDGER_ID = null;\nvar ORG_ID = null;\nExt.apply(app,{\n\tinitWin:function(params){\n        Ext.apply(app,params);\n        app.editWinN = new Ext.window.Window(app.window);\n        app.LEDGER_ID.setValue(params.LEDGER_ID);\n        app.ORG_ID.setValue(params.ORG_ID);\n        app.PURCHASE_SALE.setValue(params.PURCHASE_SALE);\n        app.WAREHOUSE_ID.setValue(params.WAREHOUSE_ID);\n        app.ENTRY_H_ID.setValue(params.ENTRY_H_ID);\n        app.grid.store.load();\n        app.editWinN.show();\n    }\n});"},"children":[{"configs":{"title":"{#XC_ST_COMMON_xzwl#}","height":"550","layout":"border","width":"1000","resizable":"false","closeAction":"hide","itemId":"window","border":"false","modal":"true"},"events":{"hide":"app.hideFun();"},"children":[{"configs":{"region":"north","itemId":"form1","border":"false"},"children":[{"configs":{"layout":"column","margin":"5 0 5 0","itemId":"tr1","border":"false"},"children":[{"configs":{"layout":"form","columnWidth":".3","itemId":"td1_1","border":"false"},"children":[{"configs":{"labelWidth":"80","labelAlign":"right","itemId":"MATERIAL_TYPE_NAME","fieldLabel":"{#XC_ST_COMMON_MATERIAL_TYPE_NAME#}"},"events":{"specialkey":"if(e.getKey()===13) {\n  app.queryBtn.fireEvent('click');\n}"},"children":[],"expanded":false,"type":"text"},{"configs":{"labelWidth":"80","hidden":"true","labelAlign":"right","itemId":"LEDGER_ID","fieldLabel":"账簿ID"},"children":[],"expanded":false,"type":"text"},{"configs":{"labelWidth":"80","hidden":"true","labelAlign":"right","itemId":"ORG_ID","fieldLabel":"组织ID"},"children":[],"expanded":false,"type":"text"},{"configs":{"labelWidth":"80","hidden":"true","value":"ST_WZ","labelAlign":"right","itemId":"MATERIAL_PRO","fieldLabel":"物料属性"},"children":[],"expanded":false,"type":"text"},{"configs":{"labelWidth":"80","hidden":"true","labelAlign":"right","itemId":"PURCHASE_SALE","fieldLabel":"是否可采购/销售"},"children":[],"expanded":false,"type":"text"},{"configs":{"labelWidth":"80","hidden":"true","labelAlign":"right","itemId":"WAREHOUSE_ID","fieldLabel":"仓库ID"},"children":[],"expanded":false,"type":"text"},{"configs":{"labelWidth":"80","hidden":"true","labelAlign":"right","itemId":"ENTRY_H_ID","fieldLabel":"入库单主ID"},"children":[],"expanded":false,"type":"text"}],"expanded":true,"type":"panel"},{"configs":{"layout":"form","columnWidth":".3","itemId":"td1_2","border":"false"},"children":[{"configs":{"labelWidth":"100","labelAlign":"right","itemId":"MATERIAL_CODE_NAME","fieldLabel":"{#XC_ST_COMMON_MATERIAL_CODE_NAME#}"},"events":{"specialkey":"if(e.getKey()===13) {\n  app.queryBtn.fireEvent('click');\n}"},"children":[],"expanded":false,"type":"text"}],"expanded":true,"type":"panel"},{"configs":{"layout":"form","columnWidth":".3","itemId":"td1_3","border":"false"},"children":[{"configs":{"labelWidth":"100","labelAlign":"right","itemId":"SERIAL_BATCH_NUM","fieldLabel":"{#XC_ST_COMMON_pc_xlh#}"},"events":{"specialkey":"if(e.getKey()===13) {\n  app.queryBtn.fireEvent('click');\n}"},"children":[],"expanded":false,"type":"text"}],"expanded":true,"type":"panel"},{"configs":{"layout":"form","columnWidth":".1","itemId":"row1_4","border":"false"},"children":[{"configs":{"layout":"column","itemId":"row1_3_1","border":"false"},"children":[{"configs":{"text":"{#XC_ST_COMMON_queryBtn#}","itemId":"queryBtn","iconCls":"seek_icon"},"events":{"click":"app.grid.store.load({params : {MATERIAL_TYPE_NAME : app.MATERIAL_TYPE_NAME.getValue(),\n                               MATERIAL_CODE_NAME : app.MATERIAL_CODE_NAME.getValue(),\n                               SERIAL_BATCH_NUM : app.SERIAL_BATCH_NUM.getValue()}});"},"children":[],"expanded":false,"type":"button"},{"configs":{"text":"{#XC_ST_COMMON_resetBtn#}","hidden":"true","itemId":"clearBtn","iconCls":"refresh_icon"},"events":{"click":"app.MATERIAL_TYPE_NAME.reset();\napp.MATERIAL_CODE_NAME.reset();\napp.queryBtn.fireEvent('click');"},"children":[],"expanded":false,"type":"button"}],"expanded":true,"type":"panel"}],"expanded":true,"type":"panel"}],"expanded":true,"type":"panel"}],"expanded":true,"type":"form"},{"configs":{"region":"center","selType":"checkboxmodel","barExportButtons":"false","barExportAllButtons":"false","sortableColumns":"false","itemId":"grid","editable":"true"},"events":{"tagEvents":"'cellclick' : function(grid1,td,cellIndex,record,tr,rowIndex,e,eOpts){\n    //序列号窗口\n    if(cellIndex == 12){\n        if(rowIndex != 0){\n            if(Wb.isEmpty(record.data.SERIAL_BATCH_NUM)){\n                for(var i = 0;i < rowIndex;i++){\n                    var rec_1 = grid1.store.getAt(i);\n                    var XCSL_1 = rec_1.get('XCSL');\n                    var CKSL_1 = rec_1.get('CKSL');\n                    var SERIAL_BATCH_NUM_1 = rec_1.get('SERIAL_BATCH_NUM');\n                    var MATERIAL_CODE_1 = rec_1.get('MATERIAL_CODE');\n                    if(XCSL_1 != CKSL_1 && Wb.isEmpty(SERIAL_BATCH_NUM_1) && record.data.MATERIAL_CODE == MATERIAL_CODE_1){\n                        Wb.toast(\"请按先进先出规则出库！\");\n                        return false;\n                    }\n                }\n            }\n            else{\n                for(var i = 0;i < rowIndex;i++){\n                    var rec_2 = grid1.store.getAt(i);\n                    var XCSL_2 = rec_2.get('XCSL');\n                    var CKSL_2 = rec_2.get('CKSL');\n                    var SERIAL_BATCH_NUM_2 = rec_2.get('SERIAL_BATCH_NUM');\n                    var MATERIAL_CODE_2 = rec_2.get('MATERIAL_CODE');\n                    if(XCSL_2 != CKSL_2 && !Wb.isEmpty(SERIAL_BATCH_NUM_2) && record.data.SERIAL_BATCH_NUM == SERIAL_BATCH_NUM_2 && record.data.MATERIAL_CODE == MATERIAL_CODE_2){\n                        Wb.toast(\"请按先进先出规则出库！\");\n                        return false;\n                    }\n                }\n            }\n        }\n    }\n}"},"children":[{"configs":{"itemId":"store","url":"m?xwl=xc/st/common/st_com_lov/XC_ST_MATERIAL_LOV/data/stMaterialParamsSelect_XJXC_GBJJ"},"events":{"beforeload":"operation.params = Wb.getValue(app.form1);"},"children":[],"expanded":false,"type":"store"},{"configs":{"itemId":"tbar"},"children":[{"configs":{"text":"{#XC_ST_COMMON_commitBtn#}","itemId":"commitBtn","iconCls":"check_icon"},"events":{"click":"var recs = app.grid.getSelection();\nif (!recs.length) {\n    Wb.toast(\"{#XC_ST_COMMON_qzsxzytjl#}\");//请选择至少一条记录！\n    return;\n}\nvar isContinue = false;\nfor(var i = 0;i < recs.length;i++){\n    if(Wb.isEmpty(recs[i].data.CKSL)){\n        Wb.toast('{#XC_ST_COMMON_qlrcksl#}');\n        isContinue = false;\n        return false;\n    }\n    else if(Wb.isEmpty(recs[i].data.CKCB)){\n        Wb.toast('{#XC_ST_COMMON_qlrckcb#}');\n        isContinue = false;\n        return false;\n    }\n    else{\n        isContinue = true;\n    }\n    var row = app.grid.store.indexOf(recs[i]);//获得选中行号\n    if(row > 0){\n        for(var j = 0;j < row;j++){\n            var data = app.grid.store.getAt(j);\n            if(!Wb.isEmpty(recs[i].data.SERIAL_BATCH_NUM)){\n                if(recs[i].data.SERIAL_BATCH_NUM == data.get('SERIAL_BATCH_NUM') && recs[i].data.MATERIAL_CODE == data.get('MATERIAL_CODE') && app.grid.getSelection()[i - 1] === undefined){\n                    Wb.toast(\"请按先进先出规则出库！\");\n                    return false;\n                }\n            }\n            else{\n                if(Wb.isEmpty(data.get('SERIAL_BATCH_NUM')) && recs[i].data.MATERIAL_CODE == data.get('MATERIAL_CODE') && app.grid.getSelection()[i - 1] === undefined){\n                    Wb.toast(\"请按先进先出规则出库！\");\n                    return false;\n                }\n            }\n        }\n    }\n}\nif(isContinue){\n    app.hideFun(recs);\n    app.window.close();\n}"},"children":[],"expanded":false,"type":"button"},{"configs":{"text":"{#XC_ST_COMMON_closeBtn#}","itemId":"closeBtn","iconCls":"delete_icon"},"events":{"click":"app.window.close();"},"children":[],"expanded":false,"type":"button"}],"expanded":true,"type":"toolbar"},{"configs":{"itemId":"columns"},"children":[{"configs":{"text":"{#XC_ST_COMMON_NUMBER_COL#}","align":"center","width":"50","xtype":"rownumberer","titleAlign":"center","itemId":"NUMBER_COL"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#XC_ST_COMMON_ENTRY_H_CODE_1#}","width":"130","dataIndex":"ENTRY_H_CODE","titleAlign":"center","itemId":"ENTRY_H_CODE_COL"},"children":[],"expanded":true,"type":"column"},{"configs":{"text":"{#XC_ST_COMMON_ENTRY_L_CODE#}","width":"80","dataIndex":"ENTRY_L_CODE","titleAlign":"center","itemId":"ENTRY_L_CODE_COL"},"children":[],"expanded":true,"type":"column"},{"configs":{"text":"{#XC_ST_COMMON_rkrq#}","width":"80","dataIndex":"BIZ_DATE","titleAlign":"center","itemId":"CREATION_DATE_COL"},"children":[],"expanded":true,"type":"column"},{"configs":{"text":"{#XC_ST_COMMON_MATERIAL_CODE#}","width":"100","dataIndex":"MATERIAL_CODE","titleAlign":"center","itemId":"MATERIAL_CODE_COL"},"children":[],"expanded":true,"type":"column"},{"configs":{"text":"{#XC_ST_COMMON_MATERIAL_NAME#}","width":"120","dataIndex":"MATERIAL_NAME","titleAlign":"center","itemId":"MATERIAL_NAME_COL"},"children":[],"expanded":true,"type":"column"},{"configs":{"text":"{#XC_ST_COMMON_MATERIAL_TYPE_NAME#}","hidden":"true","width":"150","dataIndex":"MATERIAL_TYPE_NAME","titleAlign":"center","itemId":"MATERIAL_TYPE_NAME_COL"},"children":[],"expanded":true,"type":"column"},{"configs":{"text":"{#XC_ST_COMMON_MATERIAL_PRO#}","hidden":"true","width":"100","dataIndex":"MATERIAL_PRO_NAME","titleAlign":"center","itemId":"MATERIAL_PRO_NAME_COL"},"children":[],"expanded":true,"type":"column"},{"configs":{"text":"{#XC_ST_COMMON_pc_xlh#}","width":"100","dataIndex":"SERIAL_BATCH_NUM","titleAlign":"center","itemId":"SERIAL_BATCH_NUM_COL"},"children":[],"expanded":true,"type":"column"},{"configs":{"text":"{#XC_ST_COMMON_xcl#}","align":"right","width":"100","dataIndex":"XCSL","titleAlign":"center","itemId":"XCSL_COL"},"children":[],"expanded":true,"type":"column"},{"configs":{"text":"{#XC_ST_COMMON_jccb#}","align":"right","width":"100","dataIndex":"JCCB","format":"0,000.00","titleAlign":"center","itemId":"JCCB_COL"},"children":[],"expanded":true,"type":"column"},{"configs":{"text":"<font color='red'>*<\/font>{#XC_ST_COMMON_cksl#}","align":"right","width":"100","dataIndex":"CKSL","titleAlign":"center","itemId":"CKSL_COL"},"children":[{"configs":{"allowBlank":"false","minValue":"0","itemId":"editor"},"events":{"change":"var rec = app.grid.getSelection()[0];\nvar row = app.grid.store.indexOf(rec);//获得选中行号\nif(Wb.isEmpty(rec.data.XCSL) || rec.data.XCSL === undefined || newValue === 0 || Wb.isEmpty(newValue)){\n    number.setValue(null);\n    rec.set('CKCB',null);\n}\nelse{\n    number.setMaxValue(rec.data.XCSL);\n    if(newValue > rec.data.XCSL)\n        rec.set('CKCB',null);\n    else\n        rec.set('CKCB',newValue / rec.data.XCSL * rec.data.JCCB);\n}\nfor(var i = 0;i < app.grid.store.getCount(); i++){\n    if(row < i){\n        var data = app.grid.store.getAt(i);\n        if(!Wb.isEmpty(rec.data.SERIAL_BATCH_NUM)){\n            if(!Wb.isEmpty(data.get('SERIAL_BATCH_NUM')) && rec.data.SERIAL_BATCH_NUM == data.get('SERIAL_BATCH_NUM') && rec.data.MATERIAL_CODE == data.get('MATERIAL_CODE')){\n                data.set(\"CKSL\",null);\n                data.set(\"CKCB\",null);\n            }\n        }\n        else{\n            if(Wb.isEmpty(data.get('SERIAL_BATCH_NUM')) && rec.data.MATERIAL_CODE == data.get('MATERIAL_CODE')){\n                data.set(\"CKSL\",null);\n                data.set(\"CKCB\",null);\n            }\n        }\n    }\n}"},"children":[],"expanded":false,"type":"number"}],"expanded":true,"type":"column"},{"configs":{"text":"{#XC_ST_COMMON_ckcb#}","align":"right","width":"100","dataIndex":"CKCB","format":"0,000.00","titleAlign":"center","itemId":"CKCB_COL"},"children":[],"expanded":true,"type":"column"}],"expanded":false,"type":"array"}],"expanded":true,"type":"grid"}],"expanded":true,"type":"window"}],"expanded":true,"type":"module"}],"pageLink":"","iconCls":""}