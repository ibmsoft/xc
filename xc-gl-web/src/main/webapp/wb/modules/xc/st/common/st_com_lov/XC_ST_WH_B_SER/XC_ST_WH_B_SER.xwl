{"inframe":false,"title":"入库及退货批次OR序列号公用界面","hidden":false,"roles":{"default":1},"children":[{"configs":{"loginRequired":"false","serverScript":"//---------------------获取当前模块语言对应的.json文件，放到request中----------------\ncom.xzsoft.xip.platform.util.XipUtil.getCurrentLang(request,\"xc/st/common/json/XC_ST_COMMON\");","itemId":"module"},"events":{"initialize":"var BUSINESS_H_ID = null;\nvar BUSINESS_L_ID = null;\nvar LEDGER_ID = null;\nvar ORG_ID = null;\nvar MATERIAL_ID = null;\nvar LOCATION_ID = null;\nvar LOCATION_NAME = null;\nvar SERIAL_BATCH = null;//序列号还是批号\nvar QTY = 0;\nvar BUSINESS_TYPE_ID = null;\nvar B_LOCATION_ID = '';\nExt.apply(app,{\n\tinitWin:function(params){\n        Ext.apply(app,params);\n        app.window = new Ext.window.Window(app.window);\n        BUSINESS_H_ID = params.BUSINESS_H_ID;\n        BUSINESS_L_ID = params.BUSINESS_L_ID;\n        LEDGER_ID = params.LEDGER_ID;\n        ORG_ID = params.ORG_ID;\n        MATERIAL_ID = params.MATERIAL_ID;\n        LOCATION_ID = params.LOCATION_ID;\n        LOCATION_NAME = params.LOCATION_NAME;\n        BUSINESS_TYPE_ID = params.BUSINESS_TYPE_ID;\n        if(Wb.isEmpty(LOCATION_ID)){\n            app.LOCATION_NAME_COL.hide();\n        }\n        //通过业务主ID、行ID和货位ID得到B_LOCATION_ID\n\t\tWb.request({\n            url : 'm?xwl=xc/st/common/st_com_lov/XC_ST_WH_B_SER/data/stWhBLocationSelect',\n            params : {BUSINESS_H_ID : BUSINESS_H_ID,BUSINESS_L_ID : BUSINESS_L_ID,LOCATION_ID : LOCATION_ID},\n            async : false,\n            success : function(resp){\n                var rec = Wb.decode(resp.responseText);\n                if(rec.total > 0)\n                    B_LOCATION_ID = rec.rows[0].B_LOCATION_ID;\n            }\n        });\n        //通过物料ID查询当前物料是序列号还是批号\n        Wb.request({\n            url : 'm?xwl=xc/st/common/st_com_lov/XC_ST_MATERIAL_LOV/data/stMaterialParamsSelect_RKD',\n            params : {LEDGER_ID : LEDGER_ID,MATERIAL_ID : MATERIAL_ID},\n            async : false,\n            success : function(resp){\n                var rec = Wb.decode(resp.responseText).rows[0];\n                var title = null;\n                app.window.show();\n                if(params.DOC_CAT_CODE != 'QTRK' && params.DOC_CAT_CODE != 'CGRK')\n                    controlShowOrHide();\n                if(params.STATUS != '1' && !Wb.isEmpty(params.STATUS) || params.opType == 'Seek'){//提交之后不能修改\n                    app.tbar.hide();\n                    app.SERIAL_BATCH_NUM_COL.getEditor().setReadOnly(true);\n                    app.QTY_COL.getEditor().setReadOnly(true);\n                }\n                if(rec.IS_BATCH == 'Y'){\n                    SERIAL_BATCH = 'PH';\n                    QTY = 1;\n                    title = '{#XC_ST_COMMON_PH#}';//批号\n                }\n                else if(rec.IS_SERIAL == 'Y'){\n                    SERIAL_BATCH = 'XLH';\n                    QTY = 1;\n                    title = '{#XC_ST_COMMON_XLH#}';//序列号\n                }\n                else{\n                    Wb.toast('{#XC_ST_COMMON_wlmyqypihclh#}');//物料没有启用批次或序列号！\n                    app.window.hide();\n                }\n                app.MATERIAL_NAME.setValue(rec.MATERIAL_NAME);\n                app.QTY.setValue(params.QTY);\n                app.window.setTitle('{#XC_ST_COMMON_record#}'+title);\n                app.grid.store.load({params : {LOCATION_ID : LOCATION_ID,BUSINESS_H_ID : BUSINESS_H_ID,BUSINESS_L_ID : BUSINESS_L_ID}});\n            }\n        });\n    }\n});\nfunction controlShowOrHide(){\n    app.addBtn.hide();\n    app.delBtns.hide();\n    app.saveBtn.hide();\n    app.SERIAL_BATCH_NUM_COL.getEditor().setReadOnly(true);\n    app.MATERIAL_NAME.hide();\n    app.QTY.hide();\n    app.QTY_COL.hide();\n    app.SERIAL_BATCH_NUM.show();\n}"},"children":[{"configs":{"height":"400","width":"650","layout":"border","closeAction":"hide","border":"false","itemId":"window","modal":"true"},"events":{"hide":"app.hideFun();"},"children":[{"configs":{"region":"north","itemId":"form"},"children":[{"configs":{"layout":"column","margin":"5 0 5 0","border":"false","itemId":"row1"},"children":[{"configs":{"layout":"form","columnWidth":".33","border":"false","itemId":"row1_1"},"children":[{"configs":{"labelWidth":"80","readOnly":"true","labelAlign":"right","itemId":"MATERIAL_NAME","fieldLabel":"{#XC_ST_COMMON_MATERIAL#}"},"children":[],"expanded":false,"type":"text"}],"expanded":true,"type":"panel"},{"configs":{"layout":"form","columnWidth":".33","border":"false","itemId":"row1_2"},"children":[{"configs":{"labelWidth":"80","readOnly":"true","labelAlign":"right","itemId":"QTY","fieldLabel":"{#XC_ST_COMMON_rksl#}"},"children":[],"expanded":false,"type":"number"}],"expanded":true,"type":"panel"},{"configs":{"layout":"form","columnWidth":".33","border":"false","itemId":"row2_1"},"children":[{"configs":{"labelWidth":"80","hidden":"true","labelAlign":"right","itemId":"SERIAL_BATCH_NUM","fieldLabel":"{#XC_ST_COMMON_pc_xlh#}"},"events":{"specialkey":"if(e.getKey()===13) {\n  app.grid.store.load({params : {LOCATION_ID : LOCATION_ID,BUSINESS_H_ID : BUSINESS_H_ID,BUSINESS_L_ID : BUSINESS_L_ID,SERIAL_BATCH_NUM : app.SERIAL_BATCH_NUM.getValue()}});\n}"},"children":[],"expanded":false,"type":"text"}],"expanded":true,"type":"panel"}],"expanded":true,"type":"panel"}],"expanded":true,"type":"form"},{"configs":{"region":"center","pagingBar":"false","selType":"checkboxmodel","itemId":"grid","editable":"true"},"events":{"tagEvents":"cellclick:function(view, td, cellIndex, record, tr, rowIndex, event, options){\n    if(cellIndex == 6){\n        app.CKSL_COL.getEditor().setMaxValue(record.get('PCXCL'));\n    }\n}"},"children":[{"configs":{"itemId":"store","url":"m?xwl=xc/st/common/st_com_lov/XC_ST_WH_B_SER/data/stWhBSerSelect"},"children":[],"expanded":false,"type":"store"},{"configs":{"itemId":"tbar"},"children":[{"configs":{"text":"{#XC_ST_COMMON_addBtn#}","itemId":"addBtn","iconCls":"file_add_icon"},"events":{"click":"Wb.addEdit(app.grid,[{B_SERIAL_ID : Xip.getId(),\n                      MATERIAL_ID : MATERIAL_ID,\n                      BUSINESS_L_ID : BUSINESS_L_ID,\n                      BUSINESS_H_ID : BUSINESS_H_ID,\n                      LOCATION_ID : LOCATION_ID,\n                      LOCATION_NAME : LOCATION_NAME,\n                      SERIAL_BATCH : SERIAL_BATCH,\n                      ORG_ID : ORG_ID,\n                      LEDGER_ID : LEDGER_ID,\n                      BUSINESS_TYPE_ID : BUSINESS_TYPE_ID,\n                      B_LOCATION_ID : B_LOCATION_ID,\n                      QTY : QTY}]);\nvar rec = app.grid.getSelection();//获得选中数据\nvar row = app.grid.store.indexOf(rec[0]);//获得选中行号\nvar e = app.grid.plugins[0];\ne.completeEdit();\ne.startEditByPosition({row:row,column:3});//开始编辑"},"children":[],"expanded":false,"type":"button"},{"configs":{"text":"{#XC_ST_COMMON_deleteBtn#}","itemId":"delBtns","iconCls":"file_delete_icon"},"events":{"click":"var recs = app.grid.getSelection();//获得选中数据\nif (!recs.length) {//选中的数据条数\n\tWb.toast('{#XC_ST_COMMON_qxzxyscdjl#}');\n\treturn;\n}\nWb.confirm('{#XC_ST_COMMON_qdyscxzd#} ' + recs.length + ' {#XC_ST_COMMON_tjlm#}',function() {\n    Wb.request({\n        url : 'm?xwl=xc/st/common/st_com_lov/XC_ST_WH_B_SER/data/stWhBSerDelete',\n        params : {'infoArray' : Wb.encode(Wb.getData(recs))},//传参\n        success: function(resp){\n            Wb.toast('{#XC_ST_COMMON_sccg#}');\n            Wb.remove(app.grid,recs);\n        }\n    });\n});"},"children":[],"expanded":false,"type":"button"},{"configs":{"text":"{#XC_ST_COMMON_saveBtn#}","itemId":"saveBtn","iconCls":"save_icon"},"events":{"click":"var rec = app.grid.getSelection();//选择一行信息\nvar modify = app.grid.store.getModifiedRecords();\nif(modify === '' || modify.length === 0){\n    Wb.toast('{#XC_ST_COMMON_mysjxybc#}');//没有数据需要保存！\n\treturn;\n}\nif(!Wb.verifyGrid(app.grid))//验证数据是否合法\n\treturn;\n//通过明细算出主表中的金额值\nvar totalQty = 0;\nfor (var i = 0; i < app.grid.getStore().getCount(); i++) {\n    var r = app.grid.getStore().getAt(i);\n    totalQty = totalQty + r.get('QTY');\n}\nif(totalQty != app.QTY.getValue()){\n    Wb.toast('{#XC_ST_COMMON_rkslhebxdy#}');//入库数量必须等于货位入库数量，请重新录入！\n\treturn;\n}\nWb.sync({\n    grid : app.grid,\n    url : 'm?xwl=xc/st/common/st_com_lov/XC_ST_WH_B_SER/data/stWhBSerUpdate',\n    success : function(resp) {\n        Wb.toast('{#XC_ST_COMMON_sjbccg#}');//数据保存成功！\n        app.grid.store.load({params : {LOCATION_ID : LOCATION_ID,BUSINESS_H_ID : BUSINESS_H_ID,BUSINESS_L_ID : BUSINESS_L_ID}});\n    }\n});"},"children":[],"expanded":false,"type":"button"}],"expanded":true,"type":"toolbar"},{"configs":{"itemId":"columns"},"children":[{"configs":{"text":"{#XC_ST_COMMON_NUMBER_COL#}","xtype":"rownumberer","width":"50","align":"center","titleAlign":"center","itemId":"NUMBER_COL"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#XC_ST_COMMON_LOCATION_NAME#}","width":"150","dataIndex":"LOCATION_NAME","titleAlign":"center","itemId":"LOCATION_NAME_COL"},"children":[],"expanded":true,"type":"column"},{"configs":{"text":"{#XC_ST_COMMON_PH#}","width":"100","dataIndex":"SERIAL_BATCH_NUM","titleAlign":"center","itemId":"SERIAL_BATCH_NUM_COL"},"children":[{"configs":{"allowBlank":"false","itemId":"editor"},"events":{"change":"var rec = app.grid.getSelection();//获得选中数据\nvar row = app.grid.store.indexOf(rec[0]);//获得选中行号\nif(SERIAL_BATCH == 'XLH'){\n    for(var i = 0;i < app.grid.store.getCount();i++){\n        var data = app.grid.store.getAt(i);\n        if(newValue == data.get(\"SERIAL_BATCH_NUM\") && row != i && !Wb.isEmpty(newValue)){\n            text.setValue(null);\n            Wb.toast('{#XC_ST_COMMON_XLH#} \"' + newValue + '\" {#XC_ST_COMMON_yjcz#}');\n            return;\n        }\n    }\n}","specialkey":"if(e.getKey()===13) {\n    app.addBtn.fireEvent('click');\n}"},"children":[],"expanded":false,"type":"text"}],"expanded":false,"type":"column"},{"configs":{"text":"{#XC_ST_COMMON_rksl#}","width":"100","align":"right","dataIndex":"QTY","titleAlign":"center","itemId":"QTY_COL"},"children":[{"configs":{"decimalPrecision":"6","allowBlank":"false","minValue":"0","itemId":"editor"},"children":[],"expanded":false,"type":"number"}],"expanded":false,"type":"column"}],"expanded":true,"type":"array"}],"expanded":true,"type":"grid"}],"expanded":true,"type":"window"}],"expanded":true,"type":"module"}],"pageLink":"","iconCls":""}