{"inframe":false,"title":"专项预算单录入","hidden":false,"roles":{"default":1},"children":[{"configs":{"initScript":"var userId = request.getSession().getAttribute(\"XzSessionVars\").get('userId');\n\nvar protocol = request.getProtocol() ;\nvar ipAddr = request.getServerName();\nvar port = request.getServerPort() ;\nvar ctxPath = request.getContextPath() ;\n\nvar pp = protocol.substr(0,5) ;\nprotocol = (pp.indexOf(\"https\") == -1 ? \"http\" : \"https\") ;\nvar url = protocol + \"://\" + ipAddr +\":\" + port + ctxPath ;\n\nrequest.setAttribute('contextPath',ctxPath);\nrequest.setAttribute(\"userId\",userId);\nrequest.setAttribute(\"appIP\",url);\nvar appId = request.getSession().getAttribute(\"XzSessionVars\").get('appId');\nrequest.setAttribute(\"funId\",request.getParameter('funId'));\nrequest.setAttribute(\"appId\",request.getParameter('appId'));","loginRequired":"false","serverScript":"//三方语言，引入对应的json文件\ncom.xzsoft.xip.platform.util.XipUtil.getCurrentLang(request,'xc/bg/biz/bg-prj-doc/json/bg-spe-doc');","itemId":"module"},"events":{"initialize":"var buttonChange = 'insertButton';\nvar bg_doc_id = '';\nvar flag = 'false';"},"children":[{"configs":{"itemId":"store"},"children":[{"configs":{"pageSize":"-1","autoLoad":"true","itemId":"ledger_store","url":"m?xwl=xc/com-qry/gl-ledgers/select-sec-fd-ledgers"},"events":{"success":"if(store.getCount() > 0 && buttonChange !== 'editButton'){\n    if(flag == 'false'){\n        app.LEDGER_ID.setValue(store.getAt(0).get('LEDGER_ID'));\n        flag = 'true';\n    }\n}"},"children":[],"expanded":false,"type":"store"},{"configs":{"pageSize":"-1","autoLoad":"true","itemId":"mode_store","url":"m?xwl=xc/bg/biz/bg-ex-doc/bg-ex-docDB/ctrl-modeSelect"},"children":[],"expanded":false,"type":"store"},{"configs":{"itemId":"buttons"},"children":[{"configs":{"text":"{#save#}","itemId":"saveButton","iconCls":"save_icon"},"events":{"click":"if(app.LEDGER_ID.getValue() === null){\n    Wb.toast('{#saveMsg1#}');\n    return;\n}\nif(!Wb.verify(app.bg_doc_form)){\n    return;\n}\nif(buttonChange === 'insertButton'){\n    saveInsert();\n}\nelse if(buttonChange === 'editButton'){\n    saveEdit();\n}\nfunction saveInsert(){\n    Wb.request({\n        url: 'm?xwl=xc/bg/biz/bg-ex-doc/bg-ex-docDB/ruleCodeSelect',\n        params : {LEDGER_ID : app.LEDGER_ID.getValue(),BG_CAT_CODE : app.BG_CAT_CODE.getValue()},\n        success: function(respCode) {\n            var temp = Wb.decode(respCode.responseText);//从后台获取数据\n            if(temp.total > 0){\n                var ruleCode = temp.rows[0].RULE_CODE;\n                if(ruleCode !== null){\n                    Wb.request({\n                        url : '{#contextPath#}' +'/getDocCodeAction.do?method=getDocCode',//后台java代码生成\n                        method : 'POST',\n                        async : false,//异步传参\n                        params : {ledgerId : app.LEDGER_ID.getValue(),\n                                  ruleCode : ruleCode,\n                                  categoryId : '',\n                                  year : '',\n                                  month : '',\n                                  userId : '{#XIP.userId#}'\n                                 },\n                        success : function(resp){\n                            var temp = Wb.decode(resp.responseText);//从后台获取数据\n                            if(temp !== null){\n                                app.BG_DOC_CODE.setValue(temp.bgDocCode);\n                                Wb.request({\n                                    url: 'm?xwl=xc/bg/qry/bg-doc-qry/bg-doc-qryDB/bg-docInsert',\n                                    out : app.bg_doc_form,\n                                    success: function(resp) {\n                                        saveDtl();\n                                        buttonChange = 'editButton';\n                                        app.LEDGER_ID.setReadOnly(true);\n                                    }\n                                });\n                            }\n                        }\n                    });\n                }\n                else{\n                    Wb.toast('{#saveMsg2#}');\n                }\n\t\t\t}\n            else{\n                Wb.toast('{#saveMsg2#}');\n            }\n        }\n\t});\n}\nfunction saveEdit(){\n    Wb.request({\n        url: 'm?xwl=xc/bg/qry/bg-doc-qry/bg-doc-qryDB/bg-docEdit',\n        out : app.bg_doc_form,\n        success: function(resp) {\n            saveDtl();\n        }\n    });\n}\nfunction saveDtl(){\n    Wb.sync({\n        grid : app.bg_doc_dtl_grid,\n        url : 'm?xwl=xc/bg/qry/bg-doc-qry/bg-doc-qryDB/bg-doc-dtlUpdate',\n        message : '{#saveMsg3#}',\n        success : function(resp) {\n            Wb.toast('{#saveMsg4#}');\n            app.bg_doc_dtl_grid.store.load({params : {BG_DOC_ID : app.BG_DOC_ID.getValue()}});\n        }\n    });\n}"},"children":[],"expanded":false,"type":"button"},{"configs":{"text":"{#submit#}","itemId":"submitButton","iconCls":"check_icon"},"events":{"click":"if(!app.bg_doc_form.getForm().isValid()){\n    Wb.toast('{#submitMsg1#}');\n    return;\n}\nWb.request({\n\turl : 'm?xwl=xc/bg/biz/bg-ex-doc/bg-ex-docDB/selectBgDocById',\n    params : {BG_DOC_ID : app.BG_DOC_ID.getValue()},\n    success : function(resp){\n        var temp = Wb.decode(resp.responseText);\n        if(temp.rows[0].COUNT == '0'){\n            Wb.toast('{#submitMsg2#}');\n            return;\n        }\n        else {\n            Wb.request({//账簿级流程\n                url : 'm?xwl=xc/bg/qry/bg-doc-qry/bg-doc-qryDB/bg-ld-catSelectProcess',\n                params : {LEDGER_ID : app.LEDGER_ID.getValue(),BG_CAT_CODE : app.BG_CAT_CODE.getValue()},\n                success : function(ldResp){\n                    var ldTemp = Wb.decode(ldResp.responseText);\n                    var processCODE = '';\n                    if(ldTemp.total === 0){\n                        Wb.request({//全局流程\n                            url : 'm?xwl=xc/bg/qry/bg-doc-qry/bg-doc-qryDB/bg-catSelectProcess',\n                            params : {BG_CAT_CODE : app.BG_CAT_CODE.getValue()},\n                            success : function(catResp){\n                                var catTemp = Wb.decode(catResp.responseText);\n                                if(catTemp.total === 0){\n                                    Wb.toast('{#submitMsg5#}');\n                                    return;\n                                }\n                                else{\n                                    processCODE = catTemp.rows[0].PROCESS_CODE;\n                                    submitProcess(processCODE);\n                                }\n                            }\n                        });\n                    }\n                    else{\n                        processCODE = ldTemp.rows[0].PROCESS_CODE;\n                        submitProcess(processCODE);\n                    }\n                }\n            });\n        }\n    }\n});\nfunction submitProcess(processCODE){//提交流程的方法\n    var opType = '';//余额汇总类型\n    var password = '';\n    Wb.request({//得到当前登录人的密码\n        url : 'm?xwl=xc/bg/qry/bg-doc-qry/bg-doc-qryDB/passwordSelectByName',\n        params : {USER_NAME : '{#XIP.userName#}'},\n        success : function(resp){\n            password = Wb.decode(resp.responseText).rows[0].PASSWORD;\n        }\n    });\n    if(app.INS_CODE.getValue() === null || app.INS_CODE.getValue() === ''){\n        var json = {\n            'APP_IP':'{#appIP#}',\n            'loginName':'{#XIP.userName#}',\n            'password':password,\n\t\t\t'opType':'BG03',\n            'e_business_id':app.BG_DOC_ID.getValue()\n        };\n        XipWf.startAndSubmitByProcess(processCODE,json,function(e){\n            if(e.flag === 0){\n                app.INS_CODE.setValue(e.instanceCode);\n                app.submitButton.setDisabled(true);\n                app.saveButton.setDisabled(true);\n                app.addButton.setDisabled(true);\n                app.deleteButton.setDisabled(true);\n                Wb.toast('{#submitMsg9#}');\n            }\n            else if(e.flag === 1){\n                Wb.toast(e.msg) ;\n            }else{}\n        });\n    }\n    else{\n        Wb.toast('{#submitMsg10#}');\n        return false;\n    }\n}"},"children":[],"expanded":false,"type":"button"}],"expanded":true,"type":"array"}],"expanded":true,"type":"folder"},{"configs":{"itemId":"viewport1"},"children":[{"configs":{"autoShow":"true","height":"312","layout":"border","width":"1000","closeAction":"hide","resizable":"false","buttons":"app.buttons","buttonAlign":"center","defaultFocus":"LEDGER_ID","border":"false","itemId":"bg_doc_window","modal":"true"},"events":{"show":"Wb.request({//得到UUID\n    url : 'm?xwl=xc/bg/qry/bg-doc-qry/bg-doc-qryDB/getUUID',\n    success : function(res){\n        var temp = Ext.decode(res.responseText);\n        app.BG_DOC_ID.setValue(temp.uuid);\n        app.BG_CAT_CODE.setValue(\"BG03\");\n        app.START_DATE.setValue(Ext.Date.parse(Ext.util.Format.date(new Date(),'Y-m-d'),'Y-m-d'));\n        app.END_DATE.setValue(Ext.Date.parse('9999-12-31','Y-m-d'));\n        app.AUDIT_STATUS.setValue(\"A\");\n    }\n});"},"children":[{"configs":{"region":"north","border":"false","itemId":"formPanel"},"children":[{"configs":{"text":"{#title#}","style":"fontSize:25px","margin":"20 0 20 0","labelAlign":"center","itemId":"titleLabel"},"children":[],"expanded":false,"type":"label"},{"configs":{"region":"center","border":"false","itemId":"bg_doc_form"},"children":[{"configs":{"tagConfigs":"baseCls:'my-panel-no-border'","border":"false","itemId":"rowHide"},"children":[{"configs":{"labelWidth":"80","height":"32","hidden":"true","width":"220","columnWidth":"0.36","labelAlign":"right","itemId":"BG_CAT_CODE","fieldLabel":"{#bgType#}"},"children":[],"expanded":true,"type":"combo"},{"configs":{"labelWidth":"80","height":"22","hidden":"true","width":"220","columnWidth":"0.36","labelAlign":"right","itemId":"BG_DOC_ID","fieldLabel":"{#bgId#}"},"children":[],"expanded":true,"type":"combo"},{"configs":{"labelWidth":"80","readOnly":"true","height":"22","hidden":"true","width":"220","columnWidth":"0.36","labelAlign":"right","itemId":"AUDIT_STATUS","fieldLabel":"{#auditStatus#}"},"children":[],"expanded":false,"type":"text"},{"configs":{"labelWidth":"80","height":"22","readOnly":"true","hidden":"true","width":"220","columnWidth":"0.36","labelAlign":"right","itemId":"INS_CODE","fieldLabel":"{#insCode#}"},"children":[],"expanded":false,"type":"text"}],"expanded":true,"type":"panel"},{"configs":{"tagConfigs":"baseCls:'my-panel-no-border'","layout":"column","margin":"10 0 10 0","border":"false","itemId":"row1"},"children":[{"configs":{"tagConfigs":"columnWidth : 0.32","labelWidth":"80","allowBlank":"false","store":"app.ledger_store","displayField":"LEDGER_NAME","valueField":"LEDGER_ID","labelAlign":"right","itemId":"LEDGER_ID","fieldLabel":"<font color='red'>*<\/font>{#ledger#}","editable":"false"},"events":{"change":"var ledger_id = app.LEDGER_ID.getValue();\nWb.request({\n    url : 'm?xwl=xc/bg/biz/bg-ex-doc/bg-ex-docDB/orgsSelect',//判断是否有会计科目数据\n    params : {LEDGER_ID : ledger_id},//传参\n    success: function(resp){\n        var temp = Wb.decode(resp.responseText);\n        if(temp.total > 0){\n            app.ORG_ID.setValue(temp.rows[0].ORG_NAME);\n\t\t}\n        else{\n            app.ORG_ID.setValue('');\n        }\n    }\n});"},"children":[],"expanded":true,"type":"combo"},{"configs":{"tagConfigs":"columnWidth : 0.32","labelWidth":"80","readOnly":"true","labelAlign":"right","itemId":"ORG_ID","fieldLabel":"{#org#}","editable":"false"},"children":[],"expanded":true,"type":"combo"}],"expanded":true,"type":"panel"},{"configs":{"tagConfigs":"baseCls:'my-panel-no-border'","layout":"column","margin":"10 0 0 0","border":"false","itemId":"row2"},"children":[{"configs":{"tagConfigs":"columnWidth : 0.32","labelWidth":"80","height":"22","readOnly":"true","emptyText":"{#emptyText2#}","labelAlign":"right","itemId":"BG_DOC_CODE","fieldLabel":"{#bgCode#}"},"children":[],"expanded":false,"type":"text"},{"configs":{"tagConfigs":"columnWidth : 0.32","labelWidth":"80","labelAlign":"right","itemId":"BG_DOC_NAME","fieldLabel":"{#bgName#}"},"children":[],"expanded":false,"type":"text"},{"configs":{"tagConfigs":"columnWidth : 0.32","labelWidth":"80","value":"{#XIP.empName#}","labelAlign":"right","itemId":"CREATE_BY","fieldLabel":"{#createBy#}"},"events":{"change":"app.bg_doc_dtl_grid.store.removeAll();//改变预算版本之后，吧预算单明细中的数据移除store中"},"children":[],"expanded":true,"type":"combo"}],"expanded":true,"type":"panel"},{"configs":{"tagConfigs":"baseCls:'my-panel-no-border'","layout":"column","margin":"10 0 0 0","border":"false","itemId":"row3"},"children":[{"configs":{"tagConfigs":"columnWidth : 0.64","labelWidth":"80","labelAlign":"right","itemId":"BG_DOC_DESC","fieldLabel":"{#description#}"},"children":[],"expanded":false,"type":"textarea"},{"configs":{"tagConfigs":"columnWidth : 0.32","labelWidth":"80","labelAlign":"right","itemId":"BG_AMT","fieldLabel":"{#bgAmt#}"},"children":[],"expanded":false,"type":"number"}],"expanded":true,"type":"panel"},{"configs":{"tagConfigs":"baseCls:'my-panel-no-border'","layout":"column","margin":"10 0 10 0","border":"false","itemId":"row4"},"children":[{"configs":{"tagConfigs":"columnWidth : 0.32","labelWidth":"80","labelAlign":"right","itemId":"END_DATE","fieldLabel":"{#endDate#}"},"children":[],"expanded":false,"type":"date"},{"configs":{"tagConfigs":"columnWidth : 0.32","labelWidth":"80","labelAlign":"right","itemId":"START_DATE","fieldLabel":"{#startDate#}"},"children":[],"expanded":false,"type":"date"},{"configs":{"tagConfigs":"columnWidth : 0.32","labelWidth":"80","store":"app.mode_store","displayField":"VAL_NAME","valueField":"VAL_CODE","labelAlign":"right","itemId":"CTRL_MODE","fieldLabel":"{#ctrlMode#}"},"events":{"change":"app.bg_doc_dtl_grid.store.removeAll();//改变预算版本之后，吧预算单明细中的数据移除store中"},"children":[],"expanded":true,"type":"combo"}],"expanded":true,"type":"panel"}],"expanded":true,"type":"form"}],"expanded":true,"type":"form"}],"expanded":true,"type":"window"}],"expanded":true,"type":"viewport"}],"expanded":true,"type":"module"}],"pageLink":"","iconCls":"window_icon"}