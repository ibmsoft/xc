{"inframe":true,"title":"新建或编辑借款单","hidden":false,"roles":{"default":1},"children":[{"configs":{"loginRequired":"false","jsLinks":"[\"xip/js/xipWfTouch.js\"]","serverScript":"// TODO: 单据ID\nvar exDocId = request.getParameter(\"docId\") ;\nrequest.setAttribute(\"docId\", exDocId) ;\n\n// TODO: 账簿ID\nvar ldId = request.getParameter(\"ledgerId\") ;\nrequest.setAttribute(\"ledgerId\", ldId) ;\n\n// TODO: 操作模式: add-新增, edit-编辑\nvar opMode = request.getParameter(\"opMode\") ;\nif(opMode === \"\" || opMode === null){\n  opMode = \"add\" ;\n}\nrequest.setAttribute(\"opMode\", opMode) ;\n\n// TODO: 接入页面类型：single-单据填报页面 , list-单据列表页面\nvar accessPage = request.getParameter(\"accessPage\") ;\nif(accessPage === \"\" || accessPage === null){\n  accessPage = \"single\" ;\n}\nrequest.setAttribute(\"accessPage\", accessPage) ;\n\n// TODO: 如果单据ID存在, 则更新单据信息 ; 否则为新增单据信息\nif(exDocId !== null && exDocId !== \"\" && exDocId !== undefined){\n  var docJson = com.xzsoft.xc.ex.util.XCEXWebBuilderUtil.getExDocById(exDocId) ;\n  request.setAttribute(\"docJSON\", docJson) ;\n}\n\n// TODO: 系统根路径\nrequest.setAttribute(\"ctxPath\", request.getContextPath());\n\n// TODO: 访问路径\nvar protocol = request.getProtocol() ;\nvar ipAddr = request.getServerName();\nvar port = request.getServerPort() ;\nvar ctxPath = request.getContextPath() ;\nvar pp = protocol.substr(0,5) ;\nprotocol = (pp.indexOf(\"https\") == -1 ? \"http\" : \"https\") ;\nvar url = protocol + \"://\" + ipAddr +\":\" + port + ctxPath ;\nrequest.setAttribute(\"appIP\",url);","itemId":"module"},"events":{"initialize":"// TODO: 表单对象\nWb.apply(app, {\n  xipMainNav: null,\n  init: function(mainNav,params) {\n    if (mainNav) {\n      app.xipMainNav = mainNav;\n    }\n  }\n});\n\n\n// TODO: 保存单据\nfunction saveDoc(){\n  var ledgerId = app.LEDGER_ID.getValue() ;\n  var deptId = app.DEPT_ID.getValue() ;\n  var exReason = app.EX_REASON.getValue() ;\n  var amount = app.AMOUNT.getValue() ;\n  if(ledgerId === \"\" || ledgerId === null || ledgerId === undefined){\n    Wb.info(\"请选择账簿\") ;\n    return false ;\n  }\n  if(deptId === \"\" || deptId === null || deptId === undefined){\n    Wb.info(\"请选择成本中心\") ;\n    return false ;  \n  }\n  if(exReason === \"\" || exReason === null || exReason === undefined){\n    Wb.info(\"请填写借款事由\") ;\n    return false ;  \n  }\n  if(amount === \"\" || amount === null || amount === undefined){\n    Wb.info(\"请录入申请金额\") ;\n    return false ;\n  }\n  \n  // 提交请求处理\n  Wb.request({\n    url: '{#ctxPath#}'+'/exDocsAction.do?method=saveOrUpdateDoc',\n    async : false ,\n    timeout : 3600000,\n    params: {\n      'infoJson'  : Wb.encode(Wb.getValue(app.content))\n    },\n    success: function(resp) {\n      var response = Wb.decode(resp.responseText) ;\n      Wb.info(response.msg) ;\n\n      if(response.flag == \"0\"){\n        app.EX_DOC_ID.setValue(response.docId) ;\n        app.EX_DOC_CODE.setValue(response.docCode) ;\n        // 加载单据列表\n        var accessPage = '{#accessPage#}' ; // 接入页面类型：single-单据填报 , list-单据列表\n        if(accessPage == \"list\" && typeof app.loadDocGrid == 'function'){\n          app.loadDocGrid();\n        }\n      }else{\n        app.saveBtn.enable() ;\n        app.submitBtn.enable() ;\n        return  ;\n      }\n    }\n  });\n}\n\n// TODO: 提交单据流程\nfunction submitDoc(response){\n  // 取得流程编码、电脑端审批表单和移动端审批表单\n  var processCode = response.PROCESS_CODE ;\n  var pcApproveForm = '{#appIP#}' + response.PC_A_FORM_URL ;\n  var mobileApproveForm = '{#appIP#}' + response.M_A_FORM_URL ;\n\n  // 如果流程编码存在, 则提交流程审批处理\n  if(processCode !== \"\" && processCode !== null && processCode !== undefined){\n\n    // 如果项目未指定，则设置默认值为 \"-1\"\n    var prjId = app.PROJECT_ID.getValue() ;\n    if(prjId === null || prjId === \"\" || prjId === undefined){\n      prjId = \"-1\" ;\n    }\n\n    // 流程业务实体属性赋值\n    var json = {\n      'AMT'          : app.AMOUNT.getValue(),\n      'APP_IP'       : '{#appIP#}',\n      'DEPT_ID'      : app.DEPT_ID.getValue() ,\n      'DEPT_NAME'    : app.DEPT_ID.getRecord().data.DEPT_NAME,\n      'EMP_ID'       : '{#XIP.empId#}',\n      'EX_CAT_NAME'  : '借款单',\n      'loginName'    : '{#XIP.userName#}',\n      'M_A_FORM'     : mobileApproveForm,\n      'ORG_ID'       : app.ORG_ID.getValue(),\n      'PC_A_FORM'    : pcApproveForm,\n      'PROJECT_ID'   : prjId,\n      'e_business_id': app.EX_DOC_ID.getValue(),\n      'billType'     : 'EX02',\n      'ledgerId'     : app.LEDGER_ID.getValue() \n    } ;      \n\n    // 操作模式：add-新增, edit-编辑\n    var opmode = '{#opMode#}' ;\n    var accessPage = '{#accessPage#}' ; // 接入页面类型：single-单据填报 , list-单据列表\n    \n    if(opmode === 'add'){ \n      // 新增模式\n      XipWf.startAndSubmitByProcess(app.xipMainNav,processCode,json,function(e){\n        if(e.flag === 0){\n          Wb.info('提交成功!');\n          app.INS_CODE.setValue(e.instanceCode);\n          app.revokeBtn.show() ;\n          // 加载Grid\n          \n        }else{\n          app.saveBtn.enable();\n          app.submitBtn.enable();\n          Wb.info(e.msg) ;\n        }\n      });  \n      \n    }else if(opmode === 'edit'){ \n      // 编辑模式\n      var _auditStatus = app.AUDIT_STATUS.getValue() ;\n      var _insCode = app.INS_CODE.getValue();\n      if(_auditStatus === 'A'){\n        XipWf.startAndSubmitByProcess(app.xipMainNav,processCode,json,function(e){\n          if(e.flag === 0){\n            Wb.info('提交成功!');\n            app.INS_CODE.setValue(e.instanceCode);\n            app.revokeBtn.show() ;\n            // 加载Grid\n            \n          }else{\n            app.saveBtn.enable();\n            app.submitBtn.enable();\n            Wb.info(e.msg) ;\n          }\n        }); \n        \n      }else if(_auditStatus === 'D'){\n        XipWf.submitInstance(app.xipMainNav, _insCode, json, function(e){\n          if(e.flag === 0){\n            Wb.info('提交成功!');\n            app.INS_CODE.setValue(e.instanceCode);\n            app.revokeBtn.show() ;\n            // 加载Grid\n            \n          }else{\n            app.saveBtn.enable();\n            app.submitBtn.enable();\n            Wb.info(e.msg) ;\n          }\n        }) ;\n        \n      }else if(_auditStatus === 'R'){\t\t\n        XipWf.restartAndSubmitByProcess(app.xipMainNav, _insCode, null, json, function(e){\n          if(e.flag === 0){\n            Wb.info('提交成功!');\n            app.INS_CODE.setValue(e.instanceCode);\n            app.revokeBtn.show() ;\n            // 加载Grid\n            \n          }else{\n            app.saveBtn.enable();\n            app.submitBtn.enable();\n            Wb.info(e.msg) ;\n          }\n        }) ;\n      }\n    }\n    \n  }else{\n    Wb.info('借款单未指定审批流程, 请确认') ;\n  }\n}"},"children":[{"configs":{"layout":"fit","scrollable":"true","itemId":"viewport1"},"children":[{"configs":{"itemId":"container"},"children":[{"configs":{"border":"0","itemId":"content"},"events":{"initialize":"var opMode = '{#opMode#}' ;\nif(opMode == 'add'){ \n  // 新增单据\n  app.CREATED_BY.setValue('{#XIP.userId#}') ;\n  app.CREATED_BY_NAME.setValue('{#XIP.empName#}')　;\n  app.BIZ_DATE.setValue(new Date());\n  app.INS_CODE.setValue() ;\n  app.AUDIT_STATUS.setValue('A') ;\n  app.EX_CAT_CODE.setValue('EX02') ;\n  app.EX_DOC_CODE.setValue() ;\n  app.EX_DOC_ID.setValue() ;\n  \n}else if(opMode == 'edit'){\n  // 修改单据\n  var dataJson = Wb.decode('{#docJSON#}') ;\n  Wb.setValue(app.content, dataJson) ;\n  // 处理业务日期\n  var bizDate = dataJson.BIZ_DATE ;\n  app.BIZ_DATE.setValue(Wb.strToDate(bizDate)); \n  // 审批状态为E或C时,置灰按钮\n  var as = dataJson.AUDIT_STATUS ;\n  if(as === 'E' || as == 'C'){\n    app.saveBtn.hide() ;\n    app.submitBtn.hide() ;\n    if(as == 'C'){\n      app.revokeBtn.show();\n    }\n  }\n  // 加载账簿\n  app.LEDGER_ID.getStore().load({\n    callback : function(){\n      app.LEDGER_ID.setValue(dataJson.LEDGER_ID) ;      \n    }\n  }) ;\n}"},"children":[{"configs":{"labelWidth":"120","displayField":"LEDGER_NAME","valueField":"LEDGER_ID","label":"<font color='red'>*<\/font>账簿：","clearIcon":"false","itemId":"LEDGER_ID"},"events":{"change":"var dataJson = '{#docJSON#}' ;\nif(dataJson !== null && dataJson !== \"\" && dataJson !== undefined && dataJson !== \"{}\"){\n  dataJson = Wb.decode(dataJson) ;\n}\n\n// 加载组织\napp.ORG_ID.getStore().load({\n  callback : function(){\n    app.ORG_ID.setValue(select.getRecord().data.ORG_ID) ;\n  }\n}) ;\n// 加载成本中心\napp.DEPT_ID.getStore().load({\n  params : {'ledgerId' : newValue} ,\n  callback : function(){\n    if(dataJson !== null && dataJson !== \"\" && dataJson !== undefined && dataJson !== \"{}\"){\n      app.DEPT_ID.setValue(dataJson.DEPT_ID);\n    }else{\n      // 设置默认成本中心\n      Wb.request({\n        url: 'm?xwl=xc/ex/common-db/query/select-default-dept',\n        async:false,\n        params: {\n          'orgId' : select.getRecord().data.ORG_ID\n        },\n        success: function(resp) {\n          var response = Wb.decode(resp.responseText) ;\n          var r = response.rows[0] ;\n          var _deptId = r.DEPT_ID ;\n          Wb.setValue(app.DEPT_ID,{'DEPT_ID':_deptId}) ;\n        }\n      });\n    }\n  }\n}) ;\n\n"},"children":[{"configs":{"autoLoad":"true","itemId":"store","url":"m?xwl=xc/com-qry/gl-ledgers/select-sec-fd-ledgers"},"events":{"load":"// 新增模式\nvar opMode = '{#opMode#}' ;\nif(opMode == 'add'){\n  if(store.getCount() == 1){ \n    var ldId = records[0].data.LEDGER_ID ;\n    Wb.setValue(app.LEDGER_ID,{'LEDGER_ID':ldId}) ;\n  }\n}"},"children":[],"expanded":false,"type":"tstore"}],"expanded":true,"type":"tselect"},{"configs":{"labelWidth":"120","displayField":"DEPT_NAME","valueField":"DEPT_ID","label":"<font color='red'>*<\/font>成本中心：","clearIcon":"false","itemId":"DEPT_ID"},"events":{"change":"// TODO: 设置项目信息\nvar dataJson = '{#docJSON#}' ;\nif(dataJson !== null && dataJson !== \"\" && dataJson !== undefined && dataJson !== \"{}\"){\n  dataJson = Wb.decode(dataJson) ;\n}\napp.PROJECT_ID.getStore().load({\n  callback : function(){\n    if(dataJson !== null && dataJson !== \"\" && dataJson !== undefined && dataJson !== \"{}\"){\n      app.PROJECT_ID.setValue(dataJson.PROJECT_ID) ;\n    }\n  }\n}) ;"},"children":[{"configs":{"autoLoad":"true","itemId":"store","url":"m?xwl=xc/ex/common-db/query/select-ld-depts"},"events":{"beforeload":"var proxy = this.getProxy();\nproxy._extraParams.ledgerId = app.LEDGER_ID.getValue() ;\nproxy._extraParams.textStr = '%' ;\n"},"children":[],"expanded":false,"type":"tstore"}],"expanded":true,"type":"tselect"},{"configs":{"labelWidth":"120","xtype":"textareafield","label":"<font color='red'>*<\/font>借款事由：","itemId":"EX_REASON"},"children":[],"expanded":false,"type":"ttext"},{"configs":{"labelWidth":"120","readOnly":"true","label":"借款人：","itemId":"CREATED_BY_NAME"},"children":[],"expanded":false,"type":"ttext"},{"configs":{"labelWidth":"120","displayField":"PROJECT_NAME","valueField":"PROJECT_ID","label":"项目：","itemId":"PROJECT_ID"},"children":[{"configs":{"autoLoad":"true","itemId":"store","url":"m?xwl=xc/ex/common-db/query/select-ld-projects"},"events":{"beforeload":"var proxy = this.getProxy();\nproxy._extraParams.ledgerId = app.LEDGER_ID.getValue() ;    \nproxy._extraParams.deptId = app.DEPT_ID.getValue() ;\nproxy._extraParams.textStr = '%' ;"},"children":[],"expanded":false,"type":"tstore"}],"expanded":true,"type":"tselect"},{"configs":{"labelWidth":"120","label":"<font color='red'>*<\/font>借款金额：","clearIcon":"false","itemId":"AMOUNT"},"children":[],"expanded":false,"type":"tnumber"},{"configs":{"labelWidth":"120","readOnly":"true","displayField":"ORG_NAME","hidden":"true","valueField":"ORG_ID","label":"组织：","itemId":"ORG_ID"},"children":[{"configs":{"autoLoad":"true","itemId":"store","url":"m?xwl=xc/ex/common-db/query/select-ld-org"},"events":{"beforeload":"var proxy = this.getProxy();\nproxy._extraParams.ledgerId = app.LEDGER_ID.getValue() ;"},"children":[],"expanded":false,"type":"tstore"}],"expanded":true,"type":"tselect"},{"configs":{"labelWidth":"120","readOnly":"true","hidden":"true","label":"业务日期：","clearIcon":"false","itemId":"BIZ_DATE"},"children":[],"expanded":false,"type":"tdate"},{"configs":{"labelWidth":"120","readOnly":"true","hidden":"true","label":"流程实例编码","itemId":"INS_CODE"},"children":[],"expanded":false,"type":"ttext"},{"configs":{"labelWidth":"120","readOnly":"true","hidden":"true","label":"借款人ID：","itemId":"CREATED_BY"},"children":[],"expanded":false,"type":"ttext"},{"configs":{"labelWidth":"120","readOnly":"true","hidden":"true","label":"流程审批状态：","itemId":"AUDIT_STATUS"},"children":[],"expanded":false,"type":"ttext"},{"configs":{"labelWidth":"120","hidden":"true","label":"单据类型编码","itemId":"EX_CAT_CODE"},"children":[],"expanded":false,"type":"ttext"},{"configs":{"labelWidth":"120","hidden":"true","label":"单据编号：","itemId":"EX_DOC_CODE"},"children":[],"expanded":false,"type":"ttext"},{"configs":{"labelWidth":"120","hidden":"true","label":"单据ID","itemId":"EX_DOC_ID"},"children":[],"expanded":false,"type":"ttext"},{"configs":{"docked":"bottom","style":"background:0","border":"0","itemId":"saveToolbar"},"children":[{"configs":{"itemId":"spacer1"},"children":[],"expanded":false,"type":"tspacer"},{"configs":{"text":"保存","itemId":"saveBtn"},"events":{"tap":"// 保存单据\nsaveDoc() ;"},"children":[],"expanded":false,"type":"tbutton"},{"configs":{"text":"提交","itemId":"submitBtn"},"events":{"tap":"// TODO: 保存单据信息\nsaveDoc() ;\n\n// TODO: 失效按钮，防止重复提交\napp.saveBtn.disable() ;\napp.submitBtn.disable() ;\n\n// TODO: 根据费用单据类型获取审批流程和审批表单信息\nWb.request({\n  url    : '{#ctxPath#}'+'/exDocsAction.do?method=getProcAndFormsByCat',\n  async  : false,\n  timeout: 3600000,\n  params : {\n    'ledgerId' : app.LEDGER_ID.getValue(),\n    'docCat'   : 'EX02',\n    'isChkBg'  : 'N',\n    'exDocId'  : app.EX_DOC_ID.getValue()\n  },\n  success: function(resp) {\n    var response = Wb.decode(resp.responseText) ;\n    if(response.flag == \"0\"){\n      // 提交审批\n      submitDoc(response) ; \n    }else{\n      Wb.toast(response.msg) ;\n    }\n  }\n});\n"},"children":[],"expanded":false,"type":"tbutton"},{"configs":{"text":"撤回","hidden":"true","itemId":"revokeBtn"},"events":{"tap":"var auditStatus = app.AUDIT_STATUS.getValue() ;\nvar insCode = app.INS_CODE.getValue() ;\n\nif(auditStatus == 'A'){\n  Wb.info('单据尚未提交审批');\n\n}else if(auditStatus == 'D'){\n  Wb.info('单据审批流程已驳回');\n\n}else if(auditStatus == 'R'){\n  Wb.info('单据审批流程已撤回');\n\n}else if(auditStatus == 'C'){\n  \n  // 撤回流程\n  if(insCode === null || insCode === \"\"){\n    Wb.info('未找到流程实例编码') ;\n    return false;\n  }else{\n    app.revokeBtn.disable() ;\n    XipWf.revokeByInstance(insCode,function(e){\n      if(e.flag === 0){\n        app.AUDIT_STATUS.setValue('R') ;\n      }else{\n        app.revokeBtn.enable() ;\n      }\n      Wb.info(e.msg);\n    });\n  }\n}else if(auditStatus == 'E'){\n  Wb.info('单据审批流程已完成');\n}  "},"children":[],"expanded":false,"type":"tbutton"},{"configs":{"itemId":"spacer11"},"children":[],"expanded":false,"type":"tspacer"}],"expanded":true,"type":"ttoolbar"}],"expanded":true,"type":"tfieldset"}],"expanded":true,"type":"tcontainer"}],"expanded":true,"type":"tviewport"}],"expanded":true,"type":"module"}],"pageLink":"","iconCls":""}