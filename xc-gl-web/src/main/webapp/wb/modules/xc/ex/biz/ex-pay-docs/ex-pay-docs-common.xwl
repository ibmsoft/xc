{"inframe":false,"title":"","hidden":false,"roles":{"default":1},"children":[{"configs":{"loginRequired":"false","serverScript":"//---------------------获取当前模块语言对应的.json文件，放到request中----------------\ncom.xzsoft.xip.platform.util.XipUtil.getCurrentLang(request,\"xc/ex/biz/ex-chk-docs/json/ex-chk-docs\");\n// TODO: 系统根目录\nvar ctxPath = request.getContextPath();\nrequest.setAttribute('contextPath',ctxPath);\n\nvar out = java.lang.System.out ;\n\n// TODO: 操作类型:add-新增付款单,edit-编辑付款单\nvar opType = request.getParameter(\"opType\") ;  \nrequest.setAttribute(\"optype\",opType) ;\n\n// TODO: 付款单ID\nvar payId = request.getParameter(\"payId\") ;\nrequest.setAttribute(\"payId\",payId) ;\n\n// TODO: 编辑付款单时根据付款单ID加载付款单基础信息\nif(opType == 'edit'){\n  var json = com.xzsoft.xc.ex.util.XCEXWebBuilderUtil.getPayDocBeanById(payId) ;\n  request.setAttribute(\"payDocJson\",json) ;\n}\n  \n// TODO: 加载凭证信息\nvar headId = request.getParameter(\"headId\") ;\nrequest.setAttribute(\"headId\", headId) ;\n\n// TODO: 模板类型: normal-金额式, amount-数量金额式, foreign-外币金额式\nrequest.setAttribute(\"vtype\",\"normal\") ; \n","itemId":"module"},"events":{"initialize":"// TODO: 窗口对象\nExt.apply(app,{\n\tinitWindow:function(params){\n      Ext.apply(params);\n      var pageMode = params.pageMode ; // 操作模式：chk-从单据复核生成付款单,pay-从单据支付生成付款单\n      var title = params.title ;\n      var headId = params.headId ;\n      var payId = params.payId ;\n      var ledgerId = params.ledgerId ;\n      var caId = params.caId ;\n      var caName = params.caName ;\n      \n      // 窗口标题\n      app.window1.setTitle(title)  ;\n      // 设置账簿、付款方式\n      if(ledgerId !== null && ledgerId !== \"\" && ledgerId !== undefined){\n        Wb.setValue(app.LEDGER_ID,{'LEDGER_ID':ledgerId}) ;\n\t\tapp.LEDGER_ID.setReadOnly(true) ;\n      }else{\n        app.PAY_TYPE.setReadOnly(true) ;\n      }   \n      // 加载付款单明细\n      if(payId !== \"\" && payId !== null){\n        app.exPayDtlGrid.store.load() ;\n      }\n      // 处理现金流量项目\n      app.CA_ID.setValue(caId) ;\n      app.CASH_ITEMS.setValue(caName);\n      \n      // 单据复核进入生成付款单 >> 加入所选的报销单\n      if(pageMode === 'chk'){ \n        // 所选报销单\n        var selArray = Wb.decode(params.selArray) ; \n        // 定义模型\n        Ext.define('exDocModel', {  \n            extend: 'Ext.data.Model',  \n            fields: [  \n                {name: 'EX_DOC_ID'},  \n                {name: 'EX_DOC_CODE'},\n                {name: 'EMP_ID'},\n                {name: 'EMP_NAME'},\n                {name: 'BANK_NAME'},\n                {name: 'BANK_NO'},\n                {name: 'AMOUNT'},\n                {name: 'CANCEL_AMT'},\n                {name: 'TOPIC_PAY_AMT'}\n             ]  \n        });\n\t\tvar i = 0;\n        Ext.each(selArray, function(r){\n          var docId = r.EX_DOC_ID ;\n          // 判断当前Grid中是否存在此报销单, 返回-1表示不存在\n          var store = app.exPayDtlGrid.getStore() ;\n          var idx = store.find('EX_DOC_ID',docId) ;\n          if(idx == -1){\n            var TOPIC_PAY_AMT = r.AMOUNT - r.CANCEL_AMT ;\n            var rr = Ext.create('exDocModel', {\n              'EX_DOC_ID'    : r.EX_DOC_ID , \n              'EX_DOC_CODE'  : r.EX_DOC_CODE ,\n              'EMP_ID'       : r.CREATED_BY ,\n              'EMP_NAME'     : r.CLAIMSPEOPER ,\n              'BANK_NAME'    : r.BANK_NAME ,\n              'BANK_NO'      : r.BANK_NO ,\n              'AMOUNT'       : r.AMOUNT ,\n              'CANCEL_AMT'   : r.CANCEL_AMT ,\n              'TOPIC_PAY_AMT': TOPIC_PAY_AMT\n            }); \n            i++ ;\n            store.insert(i,rr);\n          }\n        }) ;\n      }\n      // 打开新增窗口\n      app.window1.show();\n    }\n \n});\n\n// TODO: 保存凭证\nfunction saveVoucher(infoJson,infoArray){\n  // 进度条\n  var msg = Ext.MessageBox.show({\n    title:'{#progress1#}',\n    msg:'{#progress2#}',\n    width:240,\n    wait:true,\n    progress :true,\n    closable :false\n  });\n\n  // 提交请求执行凭证保存\n  Wb.request({\n    url: '{#contextPath#}'+'/exCheckAndPayAction.do?method=saveVoucher',\n    timeout : 3600000 ,\n    params: {\n      'infoJson'  : infoJson,\n      'infoArray' : infoArray\n    },\n    success: function(resp) {\n      msg.hide();\n      if(typeof app.loadGridData == 'function'){\n        app.loadGridData() ;\n      }\n      var response = Wb.decode(resp.responseText) ;\n      Wb.info(response.msg) ;\n    }\n  });\n}\n\n// TODO: 提交凭证\nfunction submitVoucher(infoJson,infoArray){\n  // 进度条\n  var msg = Ext.MessageBox.show({\n    title:'{#progress1#}',\n    msg:'{#progress2#}',\n    width:240,\n    wait:true,\n    progress :true,\n    closable :false\n  });\n\n  // 辅助参数\n  var json = {\n    'bizType'   : 'EXPAY',\n    'payId'     : app.EX_PAY_ID.getValue(),\n    'exCatCode' : 'EX06'\n  } ;\n\n  // 提交请求执行凭证提交\n  Wb.request({\n    url: '{#contextPath#}'+'/exCheckAndPayAction.do?method=submitVoucher',\n    timeout : 3600000 ,\n    params: {\n      'infoJson'  : infoJson,\n      'infoArray' : infoArray,\n      'paramJson' : Wb.encode(json) \n    },\n    success: function(resp) {\n      msg.hide();\n      var response = Wb.decode(resp.responseText) ;\n      if(response.flag === \"0\"){\n        app.window1.hide() ;\n        if(typeof app.loadGridData == 'function'){\n          app.loadGridData() ;\n        }\n      }\n      Wb.info(response.msg) ;\n    }\n  });\n}\n"},"children":[{"configs":{"maximized":"true","height":"600","layout":"fit","width":"1000","resizable":"false","itemId":"window1","dialog":"false","modal":"true","maximizable":"false"},"children":[{"configs":{"border":"false","itemId":"tabPanel2"},"events":{"beforerender":"app.edit_v_xwl.xwl_v_panel.setTitle('{#Voucher#}');"},"children":[{"configs":{"title":"{#EX_PAY#}","layout":"border","buttonAlign":"center","border":"false","itemId":"exPayPanel"},"events":{"activate":"app.exPayPanel.setTitle('{#EX_PAY#}');"},"children":[{"configs":{"region":"north","style":"border-width:0px","layout":"form","border":"false","itemId":"exPayForm"},"events":{"afterrender":"// TODO: 操作类型\nvar optype = '{#optype#}' ;\nif(optype == 'edit'){\n  // TODO: 设置付款单付款单信息\n  var jsonStr = '{#payDocJson#}' ;\n  var formJson = Wb.decode(jsonStr) ;\n  Wb.setValue(app.exPayForm, formJson) ;\n  // 支付日期\n  var payDate = formJson.EX_PAY_DATE ;\n  app.EX_PAY_DATE.setValue(Wb.strToDate(payDate)) ;\n}\n"},"children":[{"configs":{"tagConfigs":"baseCls:'my-panel-no-border'","layout":"column","margin":"10 0 0 0","itemId":"panel3"},"children":[{"configs":{"tagConfigs":"columnWidth:0.3","labelWidth":"100","readOnly":"true","hidden":"true","labelAlign":"right","itemId":"EX_PAY_ID","fieldLabel":"支付单ID"},"children":[],"expanded":false,"type":"text"},{"configs":{"tagConfigs":"columnWidth:0.3","labelWidth":"100","readOnly":"true","labelAlign":"right","itemId":"EX_PAY_CODE","fieldLabel":"{#EX_PAY_CODE#}"},"children":[],"expanded":false,"type":"text"},{"configs":{"tagConfigs":"columnWidth:0.3","labelWidth":"100","readOnly":"true","hidden":"true","labelAlign":"right","itemId":"USER_NAME","fieldLabel":"{#USER_NAME#}"},"events":{"afterrender":"var optype = '{#opType#}' ;\nif(optype == 'add'){\n  app.USER_NAME.setValue('{#XIP.userName#}') ;\n  \n}"},"children":[],"expanded":false,"type":"text"},{"configs":{"tagConfigs":"columnWidth:0.35","labelWidth":"100","readOnly":"true","labelAlign":"right","itemId":"EMP_NAME","fieldLabel":"{#USER_NAME#}"},"events":{"afterrender":"var optype = '{#opType#}' ;\nif(optype == 'add'){\n  app.EMP_NAME.setValue('{#XIP.empName#}') ;\n  \n}"},"children":[],"expanded":false,"type":"text"},{"configs":{"tagConfigs":"columnWidth:0.3","labelWidth":"100","readOnly":"true","hidden":"true","value":"{#XIP.userId#}","labelAlign":"right","itemId":"CREATED_BY","fieldLabel":"制单人ID"},"children":[],"expanded":false,"type":"text"},{"configs":{"tagConfigs":"columnWidth:0.3","labelWidth":"100","allowBlank":"true","format":"Y-m-d","labelAlign":"right","itemId":"EX_PAY_DATE","fieldLabel":"<font color='red'>*<\/font>{#EX_PAY_DATE#}"},"events":{"beforerender":"date.setValue(new Date());"},"children":[],"expanded":false,"type":"date"}],"expanded":true,"type":"panel"},{"configs":{"tagConfigs":"baseCls:'my-panel-no-border'","layout":"column","margin":"10 0 0 0","itemId":"panel31"},"children":[{"configs":{"tagConfigs":"columnWidth:0.3","labelWidth":"100","allowBlank":"true","displayField":"LEDGER_NAME","valueField":"LEDGER_ID","labelAlign":"right","itemId":"LEDGER_ID","fieldLabel":"<font color='red'>*<\/font>{#LEDGER_NAME#}","editable":"false"},"events":{"select":"app.PAY_TYPE.setReadOnly(false) ;"},"children":[{"configs":{"itemId":"store","autoLoad":"true","url":"m?xwl=xc/com-qry/gl-ledgers/select-sec-fd-ledgers"},"events":{"load":"// TODO: 如果只有一个账簿\nif(store.getCount == 1){\n  var r = records[0] ;\n  Wb.setValue(app.LEDGER_ID,{'LEDGER_ID':r.data.LEDGER_ID}) ;\n}"},"children":[],"expanded":false,"type":"store"}],"expanded":false,"type":"combo"},{"configs":{"tagConfigs":"columnWidth:0.35","labelWidth":"100","displayField":"MODE_NAME","valueField":"MODE_ID","labelAlign":"right","itemId":"PAY_TYPE","fieldLabel":"<font color='red'>*<\/font>{#PAY_TYPE#}","editable":"false"},"events":{"select":"\nvar r = records[0] ;\n// 如果付款方式为银行类型, 则需要选择付款账号\nvar modeType = r.data.MODE_TYPE ;\nif(modeType == 'bank'){\n  app.DEPOSIT_BANK_ID.setReadOnly(false) ;\n}else{\n  app.DEPOSIT_BANK_ID.setReadOnly(true) ;\n}\n"},"children":[{"configs":{"itemId":"store","autoLoad":"true","url":"m?xwl=xc/ex/biz/ex-pay-docs/ex-pay-docsDB/common-db/select-pay-type"},"events":{"beforeload":"// TODO: 传入账簿参数\nstore.proxy.extraParams.LEDGER_ID = app.LEDGER_ID.getValue();"},"children":[],"expanded":false,"type":"store"}],"expanded":false,"type":"combo"},{"configs":{"tagConfigs":"columnWidth:0.3","labelWidth":"100","readOnly":"true","displayField":"DEPOSIT_BANK_NAME","valueField":"DEPOSIT_BANK_ID","labelAlign":"right","itemId":"DEPOSIT_BANK_ID","fieldLabel":"{#DEPOSIT_BANK_ID#}","editable":"false"},"children":[{"configs":{"itemId":"store","autoLoad":"true","url":"m?xwl=xc/ex/common-db/query/select-ld-deposit-banks"},"events":{"beforeload":"store.proxy.extraParams.ledgerId = app.LEDGER_ID.getValue() ;"},"children":[],"expanded":false,"type":"store"}],"expanded":false,"type":"combo"},{"configs":{"tagConfigs":"columnWidth:0.3","labelWidth":"100","readOnly":"true","hidden":"true","labelAlign":"right","itemId":"V_STATUS","fieldLabel":"凭证状态"},"children":[],"expanded":false,"type":"text"},{"configs":{"tagConfigs":"columnWidth:0.3","labelWidth":"100","readOnly":"true","hidden":"true","labelAlign":"right","itemId":"PAY_STATUS","fieldLabel":"付款状态"},"children":[],"expanded":false,"type":"text"}],"expanded":true,"type":"panel"},{"configs":{"tagConfigs":"baseCls:'my-panel-no-border'","layout":"column","margin":"10 0 0 0","itemId":"panel32"},"children":[{"configs":{"tagConfigs":"columnWidth:0.65","labelWidth":"100","labelAlign":"right","itemId":"EX_PAY_DESC","fieldLabel":"<font color='red'>*<\/font>{#EX_PAY_DESC1#}"},"children":[],"expanded":false,"type":"text"},{"configs":{"tagConfigs":"columnWidth:0.3","labelWidth":"100","readOnly":"true","value":"0","labelAlign":"right","itemId":"EX_PAY_T_AMT","fieldLabel":"{#EX_PAY_T_AMT1#}"},"children":[],"expanded":false,"type":"text"}],"expanded":true,"type":"panel"},{"configs":{"tagConfigs":"baseCls:'my-panel-no-border'","layout":"column","margin":"10 0 10 0","itemId":"panel33"},"children":[{"configs":{"readOnly":"true","hidden":"true","itemId":"CA_ID","fieldLabel":"现金流量项目ID"},"children":[],"expanded":false,"type":"text"},{"configs":{"tagConfigs":"columnWidth:0.65","labelWidth":"100","triggerCls":"x-form-search-trigger","labelAlign":"right","itemId":"CASH_ITEMS","fieldLabel":"<font color='red'>*<\/font>{#CASH_ITEMS1#}"},"children":[{"configs":{"tagConfigs":"minWidth : 550","height":"300","forceFit":"true","itemId":"pickComp"},"events":{"itemclick":"app.CA_ID.setValue(record.data.CA_ID) ;\napp.CASH_ITEMS.setValue(record.data.CA_DISPLAY_NAME) ;\napp.pickComp.hide() ;\n"},"children":[{"configs":{"itemId":"tbar"},"children":[{"configs":{"labelWidth":"70","width":"300","emptyText":"{#queryCodeOrName#}","labelAlign":"right","itemId":"itemCodeOrName"},"events":{"specialkey":"// 支持回车键\nif(Ext.EventObject.getKey()==13){\n    app.findCashItemsBtn.fireEvent('click');\n}"},"children":[],"expanded":false,"type":"text"},{"configs":{"width":"25","itemId":"findCashItemsBtn","iconCls":"seek_icon","tooltip":"查询"},"events":{"click":"app.pickComp.getStore().load() ;"},"children":[],"expanded":false,"type":"button"},{"configs":{"width":"25","itemId":"resetCashitemsBtn","iconCls":"cancel_icon","tooltip":"{#clearInfo#}"},"events":{"click":"app.CA_ID.setValue() ;\napp.CASH_ITEMS.setValue() ;\napp.itemCodeOrName.setValue() ;\napp.findCashItemsBtn.fireEvent('click') ;"},"children":[],"expanded":false,"type":"button"}],"expanded":true,"type":"toolbar"},{"configs":{"autoLoad":"true","itemId":"store","url":"m?xwl=xc/ex/common-db/query/select-cash-items"},"events":{"beforeload":"store.proxy.extraParams.textStr = app.itemCodeOrName.getValue() ;"},"children":[],"expanded":true,"type":"store"},{"configs":{"itemId":"columns"},"children":[{"configs":{"text":"ID","hidden":"true","dataIndex":"CA_ID","titleAlign":"center","itemId":"CA_ID_COL"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#CA_CODE_COL#}","width":"100","dataIndex":"CA_CODE","titleAlign":"center","itemId":"CA_CODE_COL"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#CA_NAME_COL#}","width":"350","dataIndex":"CA_NAME","titleAlign":"center","itemId":"CA_NAME_COL"},"children":[],"expanded":false,"type":"column"}],"expanded":true,"type":"array"}],"expanded":true,"type":"grid"}],"expanded":true,"type":"picker"}],"expanded":true,"type":"panel"}],"expanded":true,"type":"form"},{"configs":{"region":"center","pagingBar":"false","multiSelect":"true","itemId":"exPayDtlGrid","viewConfig":"{\n enableTextSelection:true\n}"},"children":[{"configs":{"pageSize":"-1","autoLoad":"false","itemId":"store","url":"m?xwl=xc/ex/biz/ex-pay-docs/ex-pay-docsDB/edit-pay-doc-db/select-paydoc-dtls"},"events":{"datachanged":"// TODO: 计算付款单的付款总额\nvar totalAmt = 0;\n// 获取Grid当前行信息\nvar rows = Wb.getData(app.exPayDtlGrid) ;\n// 计算付款总额\nExt.each(rows, function(r){\n  var payAmt = r.TOPIC_PAY_AMT ; // 支付金额\n  if(payAmt){\n    totalAmt += parseInt(payAmt) ;\n  }\n}) ;\napp.EX_PAY_T_AMT.setValue(totalAmt) ;\n","beforeload":"// TODO: 加载前参数信息\nstore.proxy.extraParams.exPayId = '{#payId#}' ;\nstore.proxy.extraParams.ledgerId = app.LEDGER_ID.getValue() ;"},"children":[],"expanded":false,"type":"store"},{"configs":{"itemId":"tbar"},"children":[{"configs":{"text":"{#addLine#}","itemId":"addBtn","iconCls":"file_add_icon"},"events":{"click":"// TODO: 判断是否选择了账簿\nvar ledgerId = app.LEDGER_ID.getValue() ;\nif(ledgerId === null || ledgerId === \"\" || ledgerId === undefined){\n  Wb.toast('{#reviewRec1#}') ;\n  return false ; \n}\n// TODO: 支付单ID\nvar exPayId = app.EX_PAY_ID.getValue() ;\n\n// TODO: 打开选择挂账支付单据页面\nvar win = new Ext.window.Window(app._window2);\nwin.setTitle('{#title4#}');\nwin.setWidth(document.body.clientWidth*(0.7)) ;\nwin.show();\n\n// TODO: 加载数据\napp.exPayDtlAddGrid.store.load({\n\tparams : {\n      'ledgerId':app.LEDGER_ID.getValue() ,\n      'docCode':app.docCode.getValue()\n    }\n});\n\n"},"children":[],"expanded":false,"type":"button"},{"configs":{"text":"{#delLine#}","itemId":"delBtn","iconCls":"file_delete_icon"},"events":{"click":"Wb.remove(app.exPayDtlGrid);"},"children":[],"expanded":false,"type":"button"}],"expanded":true,"type":"toolbar"},{"configs":{"itemId":"columns"},"children":[{"configs":{"text":"{#ORDERBY#}","xtype":"rownumberer","width":"50","align":"center","titleAlign":"center","itemId":"number"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"费用单据ID","hidden":"true","width":"110","dataIndex":"EX_DOC_ID","titleAlign":"center","itemId":"EX_DOC_ID_COL","renderer":"metaData.style = 'overflow:auto;text-overflow: ellipsis;white-space: nowrap;white-space:normal;line-height:20px;';   \nreturn value;"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#EX_DOC_CODE#}","width":"110","dataIndex":"EX_DOC_CODE","titleAlign":"center","itemId":"EX_DOC_CODE_COL"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"员工ID","hidden":"true","width":"110","dataIndex":"EMP_ID","titleAlign":"center","itemId":"EMP_ID_COL"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#EMP_NAME1#}","width":"110","dataIndex":"EMP_NAME","titleAlign":"center","itemId":"EMP_NAME_COL"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#BANK_NAME_COL#}","width":"250","dataIndex":"BANK_NAME","titleAlign":"center","itemId":"BANK_NAME_COL"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#BANK_NO_COL#}","width":"200","dataIndex":"BANK_NO","titleAlign":"center","itemId":"BANK_NO_COL"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#AMOUNT#}","width":"100","align":"right","dataIndex":"AMOUNT","format":"0,000.00","titleAlign":"center","itemId":"AMOUNT_COL"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#CANCEL_AMT#}","width":"100","align":"right","dataIndex":"CANCEL_AMT","format":"0,000.00","titleAlign":"center","itemId":"CANCEL_AMT_COL"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#TOPIC_PAY_AMT#}","width":"100","align":"right","dataIndex":"TOPIC_PAY_AMT","format":"0,000.00","titleAlign":"center","itemId":"TOPIC_PAY_AMT_COL"},"children":[],"expanded":false,"type":"column"}],"expanded":true,"type":"array"}],"expanded":true,"type":"grid"},{"configs":{"itemId":"buttons"},"children":[{"configs":{"text":"{#saveCreatBtn#}","itemId":"saveCreatBtn","iconCls":"save_icon"},"events":{"click":"// 是否选择账簿\nvar ledgerId = app.LEDGER_ID.getValue();\nif(ledgerId === null || ledgerId === \"\" || ledgerId === undefined){\n  Wb.toast(\"{#reviewRec1#}\") ;\n  return false ;\n}\n// 是否选择付款方式\nvar payType = app.PAY_TYPE.getValue() ;\nif(payType === null || payType === \"\" || payType === undefined){\n  Wb.toast(\"{#saveCreatInfo1#}\") ;\n  return false ;\n}\n// 获取付款方式类型\nvar pos = app.PAY_TYPE.getStore().find('MODE_ID',payType) ;\nvar r = app.PAY_TYPE.getStore().getAt(pos) ;\nvar modeType = r.data.MODE_TYPE ;\n// 付款账号\nvar bankId = app.DEPOSIT_BANK_ID.getValue() ;\nif(modeType==='bank' && (bankId === null || bankId === \"\" || bankId === undefined)){\n  Wb.toast(\"{#saveCreatInfo2#}\") ;\n  return false ;\n}\n// 现金流量项目\nvar cashId = app.CA_ID.getValue() ;\nif(cashId === null || cashId === \"\" || cashId === undefined){\n  Wb.toast(\"{#saveCreatInfo3#}\") ;\n  return false ;\n}\n\n// TODO: 判断是否添加付款明细\nvar v_store = app.exPayDtlGrid.getStore();\nif(v_store.getCount()===0){\n  Wb.toast(\"{#saveCreatInfo4#}\") ;\n  return false ;\n}\n\n// TODO: 取得付款单ID, 如果ID为空则新建付款单; 非空则为编辑付款单\nvar payId = app.EX_PAY_ID.getValue() ;\n\n// TODO: 进度条\nvar msg = Ext.MessageBox.show({\n  title:'{#progress1#}',\n  msg:'{#progress2#}',\n  width:240,\n  wait:true,\n  progress :true,\n  closable :false\n});\n\n// 付款单表头信息\nvar infoJson = Wb.encode(Wb.getValue(app.exPayForm)) ;\n// 付款单明细信息\nvar infoArray = Wb.encode(Wb.getData(app.exPayDtlGrid)) ;\n\n// 如果付款单ID为空则新建付款单, 否则修改付款单。\nif(payId === \"\" || payId === null || payId === undefined){ \n  // 提交请求新建付款单\n  Wb.request({\n    url: '{#contextPath#}'+'/exCheckAndPayAction.do?method=createPayDoc',\n    timeout : 3600000,\n    params: {\n      'infoJson' : infoJson ,\n      'infoArray': infoArray\n    },\n    success: function(resp) {\n      msg.hide() ;\n      var response = Wb.decode(resp.responseText);\n      if(response.flag == '0'){\n        Wb.toast(\"{#saveCreatInfo5#}\") ;\n        // 设置支付单ID\n        var _payId = response.payId ;\n        app.EX_PAY_ID.setValue(_payId) ;\n        // 失效按钮\n        app.saveCreatBtn.disable() ;\n        \n        // 加载父页面待处理付款单信息\n        if(typeof app.loadGridData == 'function'){\n          app.loadGridData();\n        }\n        // 加载凭证编辑界面信息\n        initVoucher(response.headId) ;\n        \n      }else{\n        Wb.info(\"{#saveCreatInfo6#}: \"+response.msg) ;\n      }\n    }\n  });\n  \n}else{\n  // 提交请求修改付款单\n  Wb.request({\n    url: '{#contextPath#}'+'/exCheckAndPayAction.do?method=editPayDoc',\n    timeout : 3600000,\n    params: {\n      'infoJson' : infoJson ,\n      'infoArray': infoArray\n    },\n    success: function(resp) {\n      msg.hide() ;\n      var response = Wb.decode(resp.responseText);\n      if(response.flag == '0'){\n        Wb.info(\"{#saveCreatInfo7#}\") ;\n        app.saveCreatBtn.disable() ;\n        // 加载父页面待处理付款单信息\n        if(app.loadGridData){\n          app.loadGridData();\n        }\n        // 加载凭证编辑界面信息\n        initVoucher(response.headId) ;\n      }else{\n        Wb.info(\"{#saveCreatInfo8#}: \"+response.msg) ;\n      }\n    }\n  });\n}\n\n// TODO: 保存并生成凭证后加载凭证编辑界面信息\nfunction initVoucher(headId){\n  if(headId !== null && headId !== \"\" && headId !== undefined){\n    // 加载凭证头信息\n    Wb.request({\n      url: 'm?xwl=xc/gl/journal/data-db/common-data/select-v-head',\n      params: {'headId':headId},\n      success: function(resp) {\n        var headJson = Wb.decode(resp.responseText) ;\n        Wb.setValue(app.edit_v_xwl.form1,headJson) ;\n        Wb.setValue(app.edit_v_xwl.bbar,headJson) ;\n        // 处理会计日期\n        var accDate = headJson.accountDate ;\n        app.edit_v_xwl.accountDate.setValue(Wb.strToDate(accDate)) ;\n      }\n    });\n    // 加载凭证分录行\n    app.edit_v_xwl.grid1.getStore().load({\n      params :{'headId':headId}\n    }) ;\n  }\n}\n"},"children":[],"expanded":false,"type":"button"}],"expanded":true,"type":"array"}],"expanded":true,"type":"panel"},{"configs":{"file":"m?xwl=xc/gl/journal/v-windows/new-xwl-voucher","itemId":"edit_v_xwl"},"children":[],"expanded":false,"type":"xwl"}],"expanded":true,"type":"tab"}],"expanded":true,"type":"window"},{"configs":{"title":"新增","height":"600","layout":"border","buttonAlign":"center","itemId":"window2","dialog":"false","modal":"true"},"children":[{"configs":{"region":"center","multiSelect":"true","selType":"checkboxmodel","forceFit":"true","itemId":"exPayDtlAddGrid"},"children":[{"configs":{"autoLoad":"false","itemId":"store","url":"m?xwl=xc/ex/biz/ex-pay-docs/ex-pay-docsDB/add-pay-doc-db/select-checked-exdocs"},"children":[],"expanded":false,"type":"store"},{"configs":{"itemId":"tbar"},"children":[{"configs":{"labelWidth":"80","labelAlign":"right","itemId":"docCode","fieldLabel":"{#EX_DOC_CODE#}"},"events":{"specialkey":"if (e.getKey() == Ext.EventObject.ENTER) {\n  app.exPayDtlAddGrid.store.load({\n      params : {\n        'ledgerId':app.LEDGER_ID.getValue() ,\n        'docCode':app.docCode.getValue()\n      }\n  });\n}"},"children":[],"expanded":false,"type":"text"}],"expanded":true,"type":"toolbar"},{"configs":{"itemId":"columns"},"children":[{"configs":{"text":"序号","width":"50","xtype":"rownumberer","align":"center","titleAlign":"center","itemId":"rownum"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"报销单ID","hidden":"true","dataIndex":"EX_DOC_ID","itemId":"EX_DOC_ID_COL"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#EX_DOC_CODE#}","width":"110","dataIndex":"EX_DOC_CODE","titleAlign":"center","itemId":"EX_DOC_CODE_COL","renderer":"metaData.style = 'overflow:auto;text-overflow: ellipsis;white-space: nowrap;white-space:normal;line-height:20px;';   \nreturn value;"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"单据分类编码","hidden":"true","width":"110","dataIndex":"EX_CAT_CODE","titleAlign":"center","itemId":"EX_CAT_CODE_COL"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#EX_CAT_NAME#}","width":"110","dataIndex":"EX_CAT_NAME","titleAlign":"center","itemId":"EX_CAT_NAME_COL"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#AMOUNT#}","align":"right","dataIndex":"AMOUNT","titleAlign":"center","format":"0,000.00","itemId":"AMOUNT_COL"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#BIZ_DATE#}","align":"center","xtype":"datecolumn","width":"110","dataIndex":"BIZ_DATE","titleAlign":"center","itemId":"BIZ_DATE_COL"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#DEPT_NAME#}","width":"110","dataIndex":"DEPT_NAME","titleAlign":"center","itemId":"DEPT_NAME_COL"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"项目ID","hidden":"true","width":"110","dataIndex":"PROJECT_ID","titleAlign":"center","itemId":"PROJECT_ID_COL"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#PROJECT_NAME#}","width":"110","dataIndex":"PROJECT_NAME","titleAlign":"center","itemId":"PROJECT_NAME_COL"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#EX_REASON#}","width":"250","dataIndex":"EX_REASON","titleAlign":"center","itemId":"EX_REASON_COL"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"员工ID","hidden":"true","dataIndex":"EMP_ID","itemId":"EMP_ID_COL"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#EMP_NAME1#}","hidden":"true","dataIndex":"EMP_NAME","itemId":"EMP_NAME_COL"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#BANK_NO_COL#}","hidden":"true","dataIndex":"BANK_NAME","itemId":"BANK_NAME_COL"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#BANK_NO_COL#}","hidden":"true","dataIndex":"BANK_NO","itemId":"BANK_NO_COL"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#CANCEL_AMT#}","hidden":"true","dataIndex":"CANCEL_AMT","itemId":"CANCEL_AMT_COL"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#TOPIC_PAY_AMT#}","hidden":"true","dataIndex":"TOPIC_PAY_AMT","itemId":"TOPIC_PAY_AMT_COL"},"children":[],"expanded":false,"type":"column"}],"expanded":true,"type":"array"}],"expanded":true,"type":"grid"},{"configs":{"itemId":"buttons"},"children":[{"configs":{"text":"{#okButton#}","itemId":"sureBtn","iconCls":"ok_icon"},"events":{"click":"// 本次选择的报销单\nvar rows = app.exPayDtlAddGrid.getSelection() ;\n// 付款单明细\nvar store = app.exPayDtlGrid.getStore() ;\n\n// 循环记录将所选报销单添加到付款单明细\nif(rows.length === 0){\n  Wb.toast('{#okRec1#}') ;\n  return false ;\n}else{\n  Ext.define('exDocModel', {  \n      extend: 'Ext.data.Model',  \n      fields: [  \n          {name: 'EX_DOC_ID'},  \n          {name: 'EX_DOC_CODE'},\n          {name: 'EMP_ID'},\n          {name: 'EMP_NAME'},\n          {name: 'BANK_NAME'},\n          {name: 'BANK_NO'},\n          {name: 'AMOUNT'},\n          {name: 'CANCEL_AMT'},\n          {name: 'TOPIC_PAY_AMT'}\n       ]  \n  });\n  \n  Ext.each(rows, function(r){\n    var docId = r.data.EX_DOC_ID ;\n    // 判断当前Grid中是否存在此报销单, 返回-1表示不存在\n    var idx = store.find('EX_DOC_ID',docId) ;\n    if(idx == -1){\n      var rr = Ext.create('exDocModel', {\n        'EX_DOC_ID'    : r.data.EX_DOC_ID , \n        'EX_DOC_CODE'  : r.data.EX_DOC_CODE ,\n        'EMP_ID'       : r.data.EMP_ID ,\n        'EMP_NAME'     : r.data.EMP_NAME ,\n        'BANK_NAME'    : r.data.BANK_NAME ,\n        'BANK_NO'      : r.data.BANK_NO ,\n        'AMOUNT'       : r.data.AMOUNT ,\n        'CANCEL_AMT'   : r.data.CANCEL_AMT ,\n        'TOPIC_PAY_AMT': r.data.TOPIC_PAY_AMT \n      }); \n      store.insert(0,rr);\n    }\n  }) ;\n  \n  // 隐藏窗口\n  app.window2.hide() ;\n}\n"},"children":[],"expanded":false,"type":"button"},{"configs":{"text":"{#cancelsButton#}","itemId":"cancelBtn","iconCls":"cancel_icon"},"events":{"click":"app.window2.hide();"},"children":[],"expanded":false,"type":"button"}],"expanded":true,"type":"array"}],"expanded":true,"type":"window"}],"expanded":true,"type":"module"}],"pageLink":"","iconCls":""}