{"inframe":true,"title":"新建或编辑差旅报销单","hidden":false,"roles":{"default":1},"children":[{"configs":{"loginRequired":"false","jsLinks":"[\"xip/js/xipWfTouch.js\"]","serverScript":"// TODO: 单据ID\nvar exDocId = request.getParameter(\"docId\") ;\nrequest.setAttribute(\"docId\", exDocId) ;\n\n// TODO: 账簿ID\nvar ldId = request.getParameter(\"ledgerId\") ;\nrequest.setAttribute(\"ledgerId\", ldId) ;\n\n// TODO: 操作模式: add-新增, edit-编辑\nvar opMode = request.getParameter(\"opMode\") ;\nif(opMode === \"\" || opMode === null){\n  opMode = \"add\" ;\n}\nrequest.setAttribute(\"opMode\", opMode) ;\n\n// TODO: 接入页面类型：single-单据填报页面 , list-单据列表页面\nvar accessPage = request.getParameter(\"accessPage\") ;\nif(accessPage === \"\" || accessPage === null){\n  accessPage = \"single\" ;\n}\nrequest.setAttribute(\"accessPage\", accessPage) ;\n\n// TODO: 如果单据ID存在, 则更新单据信息 ; 否则为新增单据信息\nif(exDocId !== null && exDocId !== \"\" && exDocId !== undefined){\n  var docJson = com.xzsoft.xc.ex.util.XCEXWebBuilderUtil.getExDocById(exDocId) ;\n  request.setAttribute(\"docJSON\", docJson) ;\n}\n\n// TODO: 系统根路径\nrequest.setAttribute(\"ctxPath\", request.getContextPath());\n\n// TODO: 访问路径\nvar protocol = request.getProtocol() ;\nvar ipAddr = request.getServerName();\nvar port = request.getServerPort() ;\nvar ctxPath = request.getContextPath() ;\nvar pp = protocol.substr(0,5) ;\nprotocol = (pp.indexOf(\"https\") == -1 ? \"http\" : \"https\") ;\nvar url = protocol + \"://\" + ipAddr +\":\" + port + ctxPath ;\nrequest.setAttribute(\"appIP\",url);","itemId":"module"},"events":{"initialize":"// TODO: 表单对象\nWb.apply(app, {\n  xipMainNav: null,\n  init: function(mainNav,params) {\n    if (mainNav) {\n      app.xipMainNav = mainNav;\n    }\n  }\n});\n\n// TODO: 添加一条明细行记录\nfunction addDtlContainer(record){\n  // 容器个数\n  var idx = app.detailContainers.items.length  ;\n  idx++ ;\n  var t_label = '明细'+idx+'' ;\n \n  var toolbar = new Ext.Toolbar({\n    style:{'background':'#F7F7F7','border-bottom':'1px solid #DDDDDD'},\n    items: [\n      {\n        xtype: \"label\",\n        html: \"<span style='color:gray'>\"+t_label+\"<\/span>\"\n      },{\n        xtype: \"spacer\"\n      },{\n        xtype: \"button\",\n//         text: \"删除\",\n        iconCls : 'cancel_icon',\n        style:'background:0;border:0',\n        listeners:{\n          tap: function(){\n            var fieldset = this.getParent().getParent();\n            var dtlContainer = fieldset.getParent();\n            app.detailContainers.remove(dtlContainer);\n          }\n        }\n      }]\n  });\n\n  var container = Ext.create('Ext.Container',{\n    xtype: 'container',\n    items:[{\n      name:\"dtlContent\",\n      xtype:\"fieldset\",\n      items:[\n        toolbar,\n        {\n          hidden: true,\n          name: \"EX_DTL_ID\",\n          xtype: \"textfield\",\n          listeners:{\n            initialize:function(text,opts){\n              if(record !== null && record !== \"\" && record !== undefined){\n                text.setValue(record.EX_DTL_ID) ;\n              }\n            }\n          }\n        },{\n          name: \"EX_ITEM_ID\",\n          label: \"<font color=red>*<\/font>费用项目:\",\n          labelWidth: 110,\n          clearIcon: false,\n          store: app.exItemsStore,\n          displayField: \"EX_ITEM_NAME\",\n          valueField: \"EX_ITEM_ID\",\n          xtype: \"selectfield\",\n          listeners:{\n            initialize:function(select,opts){\n              if(record !== null && record !== \"\" && record !== undefined){\n                select.getStore().load({\n                  params : {\n                    'ledgerId' : record.LEDGER_ID,\n                    'catCode' : 'EX03',\n                    'textStr' : '%'\n                  },\n                  callback : function(){\n                    select.setValue(record.EX_ITEM_ID) ;\n                  }\n                }) ;\n              }\n            },\n            change:function(select, newValue, oldValue, eOpts){\n              var bgItemId = select.getRecord().data.BG_ITEM_ID ;\n              var fieldset = this.getParent();\n              var recBgItemId = fieldset.getAt(3);\n              if(Ext.isEmpty(recBgItemId.getValue())){\n                recBgItemId.setValue(bgItemId);\n              }\n            }\n          }\n        },{\n          name: \"BG_ITEM_ID\",\n          label: \"预算项目:\",\n          labelWidth: 110,\n          store: app.bgItemsStore,\n          displayField: \"BG_ITEM_NAME\",\n          valueField: \"BG_ITEM_ID\",\n          xtype: \"selectfield\",\n          listeners:{\n            initialize:function(select,opts){\n              if(record !== null && record !== \"\" && record !== undefined){\n                select.getStore().load({\n                  params : {\n                    'ledgerId' : record.LEDGER_ID,\n                    'textStr' : '%'\n                  },\n                  callback : function(){\n                    select.setValue(record.BG_ITEM_ID) ;\n                  }\n                }) ;                \n              }\n            }\n          }\n        },{\n          name: \"EX_DTL_AMT\",\n          label: \"<font color=red>*<\/font>金额:\",\n          labelWidth: 110,\n          clearIcon: false,\n          minValue:0,\n          xtype: \"numberfield\",\n          listeners:{\n            initialize:function(number,opts){\n              if(record !== null && record !== \"\" && record !== undefined){\n                number.setValue(record.EX_DTL_AMT) ;\n              }\n            },\n            change:function(number, newValue, oldValue, eOpts){\n              var oldAmt = app.AMOUNT.getValue() ;\n              var newAmt = Number(oldAmt)+Number(newValue)-Number(oldValue) ;\n              app.AMOUNT.setValue(newAmt) ;\n            }\n          }\n        },{\n          name: \"START_DATE\",\n          label: \"出发日期:\",\n          labelWidth: 110,\n          picker:{\n            yearTo:2999,\n            listeners:{\n              show:function(picker, eOpts){\n                picker.setValue(new Date());\n              },\n              cancel:function(picker, eOpts){\n                picker.setValue(null);\n              }\n            }\n          },\n          xtype: \"datepickerfield\",\n          listeners:{\n            initialize:function(date,opts){\n              if(startDate !== null && startDate !== \"\" && startDate !== undefined){\n                var startDate = record.START_DATE ;\n                date.setValue(new Date(startDate));\n              }\n            }\n          }\n        },{\n          name: \"END_DATE\",\n          label: \"到达日期:\",\n          labelWidth: 110,\n          picker:{\n            yearTo:2999,\n            listeners:{\n              show:function(picker, eOpts){\n                picker.setValue(new Date());\n              },\n              cancel:function(picker, eOpts){\n                picker.setValue(null);\n              }\n            }\n          },\n          xtype: \"datepickerfield\",\n          listeners:{\n            initialize:function(date,opts){\n              if(endDate !== null && endDate !== \"\" && endDate !== undefined){\n                var endDate = record.END_DATE ;\n                date.setValue(new Date(endDate));\n              }\n            }\n          }\n        },{\n          name: \"START_POS\",\n          label: \"出发地点:\",\n          labelWidth: 110,\n          xtype: \"textfield\",\n          listeners:{\n            initialize:function(text,opts){\n              if(record !== null && record !== \"\" && record !== undefined){\n                text.setValue(record.START_POS) ;\n              }\n            }\n          }\n        },{\n          name: \"END_POS\",\n          label: \"到达地点:\",\n          labelWidth: 110,\n          xtype: \"textfield\",\n          listeners:{\n            initialize:function(text,opts){\n              if(record !== null && record !== \"\" && record !== undefined){\n                text.setValue(record.END_POS) ;\n              }\n            }\n          }\n        },{\n          name: \"DOC_NUM\",\n          label: \"单据数量:\",\n          clearIcon: false,\n          labelWidth: 110,\n          minValue:0,\n          xtype: \"numberfield\",\n          listeners:{\n            initialize:function(number,opts){\n              if(record !== null && record !== \"\" && record !== undefined){\n                number.setValue(record.DOC_NUM) ;\n              }\n            }\n          }\n        },{\n          name: \"EX_DTL_DESC\",\n          label: \"说明:\",\n          labelWidth: 110,\n          xtype: \"textareafield\",\n          listeners:{\n            initialize:function(text,opts){\n              if(record !== null && record !== \"\" && record !== undefined){\n                text.setValue(record.EX_DTL_DESC) ;\n              }\n            }\n          }\n        }]\n    }]\n  });\n  return container;\n}\n\n// TODO: 获取单据明细信息\nfunction getDetailRecords(){\n  var detailJson = {} ;\n  var flag = 0 ;\n  var msg = \"\" ;\n  \n  //明细的数量\n  var count = app.detailContainers.items.length;\n  var datas = [] ;\n  //获取明细数据\n  for(var i=0;i<count;i++){\n    var dtl = app.detailContainers.getAt(i);\t//获取明细容器\n    var fieldset = dtl.getAt(0);\t//获取fieldset\n    var ex_dtl_id = fieldset.getAt(1).getValue();\n    var ex_item_id = fieldset.getAt(2).getValue();\n    if(ex_item_id === \"\" || ex_item_id === null || ex_item_id === undefined){\n      flag++ ;\n      msg += \"明细\"+(i+1)+\"未录入费用项目; \" ;\n    }\n    var bg_item_id = fieldset.getAt(3).getValue();\n    var ex_dtl_amt = fieldset.getAt(4).getValue();\n    if(ex_dtl_amt === \"\" || ex_dtl_amt === null || ex_dtl_amt === undefined){\n      flag++ ;\n      msg += \"明细\"+(i+1)+\"未录入单据金额; \" ;\n    }\n    var start_date = fieldset.getAt(5).getValue();\n    if(!Ext.isEmpty(start_date)&&Ext.Date.format(start_date,'Y-m-d H:i:s') == '1901-01-01 00:00:00') start_date = null;\n    var end_date = fieldset.getAt(6).getValue();\n    if(!Ext.isEmpty(end_date)&&Ext.Date.format(end_date,'Y-m-d H:i:s') == '1901-01-01 00:00:00') end_date = null;\n    var start_pos = fieldset.getAt(7).getValue();\n    var end_pos = fieldset.getAt(8).getValue();\n    var doc_num = fieldset.getAt(9).getValue();\n    var ex_dtl_desc = fieldset.getAt(10).getValue();\n    var data = {\n      'EX_DTL_ID'\t:\tex_dtl_id,\n      'EX_DOC_ID'\t:\tapp.EX_DOC_ID.getValue(),\n      'EX_ITEM_ID'\t:\tex_item_id,\n      'BG_ITEM_ID'\t:\tbg_item_id,\n      'EX_DTL_AMT'\t:\tex_dtl_amt,\n      'START_DATE'\t:\tstart_date,\n      'END_DATE'\t:\tend_date,\n      'START_POS'\t:\tstart_pos,\n      'END_POS'\t\t:\tend_pos,\n      'DOC_NUM'\t\t:\tdoc_num,\n      'EX_DTL_DESC'\t:\tex_dtl_desc\n    };\n    datas.push(data);\n  }\n  \n  // 判断是否存在非法记录\n  if(flag > 0){\n    detailJson.flag = \"1\" ;\n    detailJson.msg = msg ;\n  }else{\n    detailJson.flag = \"0\" ;\n    detailJson.datas = datas ;\n  }\n  return detailJson ;\n}\n\n\n// TODO: 保存单据\nfunction saveDoc(){\n  var ledgerId = app.LEDGER_ID.getValue() ;\n  var deptId = app.DEPT_ID.getValue() ;\n  var exReason = app.EX_REASON.getValue() ;\n  var amount = app.AMOUNT.getValue() ;\n  var lendAmt = app.LEND_AMT.getValue() ;\n  var cancelAmt = app.CANCEL_AMT.getValue() ;\n  if(ledgerId === \"\" || ledgerId === null || ledgerId === undefined){\n    Wb.info(\"请选择账簿\") ;\n    return false ;\n  }\n  if(deptId === \"\" || deptId === null || deptId === undefined){\n    Wb.info(\"请选择成本中心\") ;\n    return false ;  \n  }\n  if(exReason === \"\" || exReason === null || exReason === undefined){\n    Wb.info(\"请填写报销说明\") ;\n    return false ;  \n  }\n  if(cancelAmt === \"\" || cancelAmt === null || cancelAmt === undefined){\n    Wb.info(\"请录入核销金额\") ;\n    return false ;\n  }\n  if(Number(cancelAmt) > Number(lendAmt)){\n    Wb.info('核销金额不能大于借款余额') ;\n    return false ;\n  }\n  if(Number(cancelAmt) > Number(amount)){\n    Wb.info('核销金额不能大于单据金额') ;\n    return false ;\n  }\n\n  // 明细行\n  var lineArray = [] ;\n  var lines = app.detailContainers.items.length  ;\n  if(lines === 0){\n    Wb.info('请添加明细') ;\n    return false ;\n  }else{\n    // 获取单据明细数据\n    var detailJson = getDetailRecords() ;\n    if(detailJson.flag == \"1\"){\n      Wb.info(detailJson.msg) ;\n      return false ;\n    }else{\n      lineArray = detailJson.datas ;\n    }\n  }\n\n  // 提交请求处理\n  Wb.request({\n    url: '{#ctxPath#}'+'/exDocsAction.do?method=saveOrUpdateDoc',\n    async : false ,\n    timeout : 3600000,\n    params: {\n      'infoJson'  : Wb.encode(Wb.getValue(app.content)),\n      'lineArray' : Wb.encode(lineArray) \n    },\n    success: function(resp) {\n      var response = Wb.decode(resp.responseText) ;\n      Wb.info(response.msg) ;\n      \n      if(response.flag == \"0\"){\n        app.EX_DOC_ID.setValue(response.docId) ;\n        app.EX_DOC_CODE.setValue(response.docCode) ;\n      }else{\n        app.addBtn.enable();\n        app.saveBtn.enable() ;\n        app.submitBtn.enable() ;\n        return  ;\n      }\n    }\n  });\n}\n\n// TODO: 提交单据\nfunction submitDoc(response){\n  \n  // 取得流程编码、电脑端审批表单和移动端审批表单\n  var processCode = response.PROCESS_CODE ;\n  var pcApproveForm = '{#appIP#}' + response.PC_A_FORM_URL ;\n  var mobileApproveForm = '{#appIP#}' + response.M_A_FORM_URL ;\n\n  // 如果流程编码存在, 则提交流程审批处理\n  if(processCode !== \"\" && processCode !== null && processCode !== undefined){\n\n    // 如果项目未指定，则设置默认值为 \"-1\"\n    var prjId = app.PROJECT_ID.getValue() ;\n    if(prjId === null || prjId === \"\" || prjId === undefined){\n      prjId = \"-1\" ;\n    }\n\n    // 流程业务实体属性赋值\n    var json = {\n      'AMT'          : app.AMOUNT.getValue(),\n      'APP_IP'       : '{#appIP#}',\n      'DEPT_ID'      : app.DEPT_ID.getValue() ,\n      'DEPT_NAME'    : app.DEPT_ID.getRecord().data.DEPT_NAME,\n      'EMP_ID'       : '{#XIP.empId#}',\n      'EX_CAT_NAME'  : '差旅报销单',\n      'loginName'    : '{#XIP.userName#}',\n      'M_A_FORM'     : mobileApproveForm,\n      'ORG_ID'       : app.ORG_ID.getValue(),\n      'PC_A_FORM'    : pcApproveForm,\n      'PROJECT_ID'   : prjId,\n      'e_business_id': app.EX_DOC_ID.getValue(),\n      'billType'     : 'EX03',\n      'ledgerId'     : app.LEDGER_ID.getValue() ,\n      'APPLY_DOC_ID' : app.APPLY_EX_DOC_ID.getValue()  \n    } ;      \n\n    // 操作模式：add-新增, edit-编辑\n    var opmode = '{#opMode#}' ;\n    // 接入页面类型：single-单据填报 , list-单据列表\n    var accessPage = '{#accessPage#}' ; \n    \n    if(opmode === 'add'){ \n      // 新增模式\n      XipWf.startAndSubmitByProcess(app.xipMainNav,processCode,json,function(e){\n        if(e.flag === 0){\n          Wb.info('提交成功!');\n          app.INS_CODE.setValue(e.instanceCode);\n          app.revokeBtn.show() ;\n\n        }else{\n          app.addBtn.enable();\n          app.saveBtn.enable();\n          app.submitBtn.enable();\n          Wb.info(e.msg) ;\n        }\n      });  \n      \n    }else if(opmode === 'edit'){ \n      // 编辑模式\n      var _auditStatus = app.AUDIT_STATUS.getValue() ;\n      var _insCode = app.INS_CODE.getValue();\n      if(_auditStatus === 'A'){\n        XipWf.startAndSubmitByProcess(app.xipMainNav,processCode,json,function(e){\n          if(e.flag === 0){\n            Wb.info('提交成功!');\n            app.INS_CODE.setValue(e.instanceCode);\n            app.revokeBtn.show() ;\n\n          }else{\n            app.addBtn.enable();\n            app.saveBtn.enable();\n            app.submitBtn.enable();\n            Wb.info(e.msg) ;\n          }\n        }); \n        \n      }else if(_auditStatus === 'D'){\n        XipWf.submitInstance(app.xipMainNav, _insCode, json, function(e){\n          if(e.flag === 0){\n            Wb.info('提交成功!');\n            app.INS_CODE.setValue(e.instanceCode);\n            app.revokeBtn.show() ;\n\n          }else{\n            app.addBtn.enable();\n            app.saveBtn.enable();\n            app.submitBtn.enable();\n            Wb.info(e.msg) ;\n          }\n        }) ;\n        \n      }else if(_auditStatus === 'R'){\t\t\n        XipWf.restartAndSubmitByProcess(app.xipMainNav, _insCode, null, json, function(e){\n          if(e.flag === 0){\n            Wb.info('提交成功!');\n            app.INS_CODE.setValue(e.instanceCode);\n            app.revokeBtn.show() ;\n\n          }else{\n            app.addBtn.enable();\n            app.saveBtn.enable();\n            app.submitBtn.enable();\n            Wb.info(e.msg) ;\n          }\n        }) ;\n      }\n    }\n\n  }else{\n    Wb.info('差旅报销单未指定审批流程, 请确认') ;\n  }\n}\n\n\n\n\n\n\n\n\n\n"},"children":[{"configs":{"itemId":"stores"},"children":[{"configs":{"itemId":"exItemsStore","url":"m?xwl=xc/ex/common-db/query/select-ld-ex-items"},"events":{"beforeload":"store.getProxy()._extraParams.ledgerId = app.LEDGER_ID.getValue() ;\nstore.getProxy()._extraParams.catCode = 'EX03' ;\nstore.getProxy()._extraParams.textStr = '%' ;"},"children":[],"expanded":false,"type":"tstore"},{"configs":{"itemId":"bgItemsStore","url":"m?xwl=xc/ex/common-db/query/select-ld-bg-items"},"events":{"beforeload":"store.getProxy()._extraParams.ledgerId = app.LEDGER_ID.getValue() ;\nstore.getProxy()._extraParams.textStr = '%' ;"},"children":[],"expanded":false,"type":"tstore"}],"expanded":false,"type":"folder"},{"configs":{"layout":"fit","itemId":"viewport1"},"children":[{"configs":{"scrollable":"true","itemId":"container"},"children":[{"configs":{"docked":"bottom","style":"background:0","border":"0","itemId":"toolbar"},"children":[{"configs":{"itemId":"spacer1"},"children":[],"expanded":false,"type":"tspacer"},{"configs":{"text":"添加明细","itemId":"addBtn"},"events":{"tap":"var container = addDtlContainer();\napp.detailContainers.add(container);"},"children":[],"expanded":false,"type":"tbutton"},{"configs":{"text":"保存","itemId":"saveBtn"},"events":{"tap":"// 保存单据\nsaveDoc() ;"},"children":[],"expanded":false,"type":"tbutton"},{"configs":{"text":"提交","itemId":"submitBtn"},"events":{"tap":"// 保存单据\nsaveDoc() ;\n\n// 置灰按钮防止重复提交\napp.addBtn.disable() ;\napp.saveBtn.disable() ;\napp.submitBtn.disable() ;\n\n\n// 根据费用单据类型获取审批流程和审批表单信息\nWb.request({\n  url    : '{#ctxPath#}'+'/exDocsAction.do?method=getProcAndFormsByCat',\n  async  : false,\n  timeout: 3600000,\n  params : {\n    'ledgerId' : app.LEDGER_ID.getValue(),\n    'docCat'   : 'EX03'\n  },\n  success: function(resp) {\n    var response = Wb.decode(resp.responseText) ;\n    if(response.flag == \"0\"){\n        // 执行阶段：BGCHK-预算校验,QRY-单据类型信息查询\n        var phase = response.phase ;\n        if(phase === 'BGCHK'){\n          // -1 校验不通过或者校验异常；0 校验通过；1校验不通过，但预算不是绝对控制，给出警告提示    \n          var chkFlag = response.chkFlag ;\n          if(chkFlag === \"-1\"){\n              app.addBtn.enable() ;\n              app.saveBtn.enable() ;\n              app.submitBtn.enable() ;\n              Wb.info(response.msg) ;\n              return ;\n          }else if(chkFlag === \"1\"){\n              Ext.Msg.confirm('警告',response.msg,function(id){\n                if(id=='yes'){\n                  submitDoc(response) ;\n                }else{\n                  app.addBtn.enable() ;\n                  app.saveBtn.enable() ;\n                  app.submitBtn.enable() ;\n                }\n              });\n          }\n        }else{\n          submitDoc(response) ;\n        } \n    }else{\n      app.addBtn.enable() ;\n      app.saveBtn.enable() ;\n      app.submitBtn.enable() ;\n      Wb.info(response.msg) ;\n    }\n  }\n});\n"},"children":[],"expanded":false,"type":"tbutton"},{"configs":{"text":"撤回","hidden":"true","itemId":"revokeBtn"},"events":{"tap":"var auditStatus = app.AUDIT_STATUS.getValue() ;\nvar insCode = app.INS_CODE.getValue() ;\n\nif(auditStatus == 'A'){\n  Wb.info('单据尚未提交审批');\n\n}else if(auditStatus == 'D'){\n  Wb.info('单据审批流程已驳回');\n\n}else if(auditStatus == 'R'){\n  Wb.info('单据审批流程已撤回');\n\n}else if(auditStatus == 'C'){\n  \n  // 撤回流程\n  if(insCode === null || insCode === \"\"){\n    Wb.info('未找到流程实例编码') ;\n    return false;\n  }else{\n    app.revokeBtn.disable() ;\n    XipWf.revokeByInstance(insCode,function(e){\n      if(e.flag === 0){\n        app.AUDIT_STATUS.setValue('R') ;\n      }else{\n        app.revokeBtn.enable() ;\n      }\n      Wb.info(e.msg);\n    });\n  }\n}else if(auditStatus == 'E'){\n  Wb.info('单据审批流程已完成');\n}  "},"children":[],"expanded":false,"type":"tbutton"},{"configs":{"text":"附件","itemId":"attchBtn"},"events":{"tap":"// TODO: 附件上传\nvar exDocId = app.EX_DOC_ID.getValue() ;\nif(exDocId === null || exDocId === \"\" || exDocId === undefined){\n  Wb.info('单据尚未保存不能添加附件') ;\n  return false ;\n}\n\n// 获取附件分类\t\nWb.request({\n  url : '{#ctxPath#}'+'/exDocsAction.do?method=getProcAndFormsByCat',\n  timeout : 3600000,\n  params: {\n    'ledgerId' : app.LEDGER_ID.getValue(),\n    'docCat'   : 'EX03'\n  },\n  success: function(resp) {\n    var response = Wb.decode(resp.responseText) ;\n    var attCat = response.ATT_CAT_CODE ;\n    if(response.flag === \"0\"){\n      if(attCat === null || attCat === \"\" || attCat === undefined){\n        Wb.info('差旅报销单未设置附件分类') ;\n      }else{\n        var ex_doc_id = app.EX_DOC_ID.getValue() ;\n        var ex_doc_code = app.EX_DOC_CODE.getValue() ;\n        var orgId = app.ORG_ID.getValue() ;\n        // 挂载附件\n        Xip.showAttachmentManagerTouch(app.xipMainNav,'{#XIP.userId#}',ex_doc_id,orgId,attCat,ex_doc_code ,'Y','Y','Y',function(){},10) ;\n      }\n    }else{\n      Wb.info(response.msg) ;\n    }\n  }\n});"},"children":[],"expanded":false,"type":"tbutton"},{"configs":{"itemId":"spacer2"},"children":[],"expanded":false,"type":"tspacer"}],"expanded":true,"type":"ttoolbar"},{"configs":{"itemId":"baseContainer"},"children":[{"configs":{"border":"0","itemId":"content"},"events":{"initialize":"var opMode = '{#opMode#}' ;\nif(opMode == 'add'){ \n  // 新增单据\n  app.CREATED_BY.setValue('{#XIP.userId#}') ;\n  app.BIZ_DATE.setValue(new Date());\n  app.INS_CODE.setValue() ;\n  app.AUDIT_STATUS.setValue('A') ;\n  app.EX_CAT_CODE.setValue('EX03') ;\n  app.EX_DOC_CODE.setValue() ;\n  app.EX_DOC_ID.setValue();\n\n}else if(opMode == 'edit'){\n  // 修改单据\n  var dataJson = Wb.decode('{#docJSON#}') ;\n  dataJson.AMOUNT = 0 ;\n  Wb.setValue(app.content, dataJson) ;\n  // 处理业务日期\n  var bizDate = dataJson.BIZ_DATE ;\n  app.BIZ_DATE.setValue(Wb.strToDate(bizDate)); \n  \n  // 审批状态为E或C时,置灰按钮\n  var as = dataJson.AUDIT_STATUS ;\n  if(as === 'E' || as == 'C'){\n    app.addBtn.hide() ;\n    app.saveBtn.hide() ;\n    app.submitBtn.hide() ;\n    if(as == 'C'){\n      app.revokeBtn.show();\n    }\n  } \n  // 加载账簿\n  app.LEDGER_ID.getStore().load({\n    callback : function(){\n      app.LEDGER_ID.setValue(dataJson.LEDGER_ID) ;      \n    }\n  }) ;  \n  \n}"},"children":[{"configs":{"labelWidth":"110","displayField":"LEDGER_NAME","valueField":"LEDGER_ID","label":"<font color='red'>*<\/font>账簿：","clearIcon":"false","itemId":"LEDGER_ID"},"events":{"change":"var dataJson = '{#docJSON#}' ;\nif(dataJson !== null && dataJson !== \"\" && dataJson !== undefined && dataJson !== \"{}\"){\n  dataJson = Wb.decode(dataJson) ;\n}\n// 加载组织\napp.ORG_ID.getStore().load({\n  callback : function(){\n    app.ORG_ID.setValue(select.getRecord().data.ORG_ID) ;\n  }\n}) ;\n\n// 加载成本中心\napp.DEPT_ID.getStore().load({\n  callback : function(){\n    if(dataJson !== null && dataJson !== \"\" && dataJson !== undefined && dataJson !== \"{}\"){\n      app.DEPT_ID.setValue(dataJson.DEPT_ID) ;\n    }else{\n      // 设置默认成本中心\n      Wb.request({\n        url: 'm?xwl=xc/ex/common-db/query/select-default-dept',\n        async:false,\n        params: {\n          'orgId' : select.getRecord().data.ORG_ID\n        },\n        success: function(resp) {\n          var response = Wb.decode(resp.responseText) ;\n          var r = response.rows[0] ;\n          var _deptId = r.DEPT_ID ;\n          Wb.setValue(app.DEPT_ID,{'DEPT_ID':_deptId}) ;\n        }\n      });\n    }\n  }\n}) ;\n// 加载费用申请单\napp.APPLY_EX_DOC_ID.getStore().load({\n  callback : function(){\n    if(dataJson !== null && dataJson !== \"\" && dataJson !== undefined && dataJson !== \"{}\"){\n      app.APPLY_EX_DOC_ID.setValue(dataJson.APPLY_EX_DOC_ID) ;   \n    } \n  }\n}) ;\n//加载费用项目和预算项目\napp.exItemsStore.load() ;\napp.bgItemsStore.load() ;\n\n// 计算还款余额\nWb.request({\n  url   : '{#ctxPath#}/borrowMoneyAction.do?method=getUserImprest',\n  async : false,\n  params: {\n    'ledgerId' : app.LEDGER_ID.getValue(),\n    'userId'   : app.CREATED_BY.getValue()\n  },\n  success:function(resp){\n    var obj = Wb.decode(resp.responseText);\n    if(!Ext.isEmpty(obj)){\n      Wb.setValue(app.LEND_AMT,{'LEND_AMT':obj.iaBal}) ;\n    }\n  }\n});\n"},"children":[{"configs":{"autoLoad":"true","itemId":"store","url":"m?xwl=xc/com-qry/gl-ledgers/select-sec-fd-ledgers"},"events":{"load":"// 新增模式\nvar opMode = '{#opMode#}' ;\nif(opMode == 'add'){\n  if(store.getCount() == 1){ \n    var ldId = records[0].data.LEDGER_ID ;\n    Wb.setValue(app.LEDGER_ID,{'LEDGER_ID':ldId}) ;\n  }  \n}"},"children":[],"expanded":false,"type":"tstore"}],"expanded":true,"type":"tselect"},{"configs":{"labelWidth":"110","displayField":"DEPT_NAME","valueField":"DEPT_ID","label":"<font color='red'>*<\/font>成本中心：","clearIcon":"false","itemId":"DEPT_ID"},"events":{"change":"// TODO: 设置项目信息\nvar dataJson = '{#docJSON#}' ;\nif(dataJson !== null && dataJson !== \"\" && dataJson !== undefined && dataJson !== \"{}\"){\n  dataJson = Wb.decode(dataJson) ;\n}\napp.PROJECT_ID.getStore().load({\n  callback : function(){\n    if(dataJson !== null && dataJson !== \"\" && dataJson !== undefined && dataJson !== \"{}\"){\n      app.PROJECT_ID.setValue(dataJson.PROJECT_ID) ;\n    }\n  }\n}) ;"},"children":[{"configs":{"autoLoad":"true","itemId":"store","url":"m?xwl=xc/ex/common-db/query/select-ld-depts"},"events":{"beforeload":"var proxy = this.getProxy() ;\nproxy._extraParams.ledgerId = app.LEDGER_ID.getValue() ;\nproxy._extraParams.textStr = '%' ;"},"children":[],"expanded":false,"type":"tstore"}],"expanded":false,"type":"tselect"},{"configs":{"labelWidth":"110","xtype":"textareafield","label":"<font color='red'>*<\/font>报销说明：","itemId":"EX_REASON"},"children":[],"expanded":true,"type":"ttext"},{"configs":{"labelWidth":"110","displayField":"EX_DOC_NAME","valueField":"EX_DOC_ID","label":"申请单：","itemId":"APPLY_EX_DOC_ID"},"events":{"change":"var docCode = app.APPLY_EX_DOC_ID.getRecord().data.EX_DOC_CODE ;"},"children":[{"configs":{"autoLoad":"true","itemId":"store","url":"m?xwl=xc/ex/common-db/query/select-ld-apply-docs"},"events":{"beforeload":"var proxy = this.getProxy() ;\nproxy._extraParams.ledgerId = app.LEDGER_ID.getValue();\n"},"children":[],"expanded":false,"type":"store"}],"expanded":false,"type":"tselect"},{"configs":{"labelWidth":"110","displayField":"PROJECT_NAME","valueField":"PROJECT_ID","label":"项目：","itemId":"PROJECT_ID"},"children":[{"configs":{"autoLoad":"true","itemId":"store","url":"m?xwl=xc/ex/common-db/query/select-ld-projects"},"events":{"beforeload":"var proxy = this.getProxy() ;\nproxy._extraParams.ledgerId = app.LEDGER_ID.getValue() ;\nproxy._extraParams.deptId = app.DEPT_ID.getValue() ;\nproxy._extraParams.textStr = '%' ;"},"children":[],"expanded":false,"type":"tstore"}],"expanded":false,"type":"tselect"},{"configs":{"labelWidth":"110","readOnly":"true","value":"0","label":"报销金额：","clearIcon":"false","itemId":"AMOUNT","disabled":"true"},"children":[],"expanded":false,"type":"tnumber"},{"configs":{"labelWidth":"110","readOnly":"true","value":"0","label":"借款余额：","clearIcon":"false","itemId":"LEND_AMT","disabled":"true"},"children":[],"expanded":false,"type":"tnumber"},{"configs":{"labelWidth":"110","value":"0","label":"<font color='red'>*<\/font>核销金额：","clearIcon":"false","itemId":"CANCEL_AMT"},"children":[],"expanded":false,"type":"tnumber"},{"configs":{"labelWidth":"110","readOnly":"true","displayField":"ORG_NAME","hidden":"true","valueField":"ORG_ID","label":"组织：","itemId":"ORG_ID"},"children":[{"configs":{"autoLoad":"true","itemId":"store","url":"m?xwl=xc/ex/common-db/query/select-ld-org"},"events":{"beforeload":"var proxy = this.getProxy() ;\nproxy._extraParams.ledgerId = app.LEDGER_ID.getValue() ;"},"children":[],"expanded":false,"type":"tstore"}],"expanded":false,"type":"tselect"},{"configs":{"labelWidth":"110","readOnly":"true","hidden":"true","label":"业务日期：","clearIcon":"false","itemId":"BIZ_DATE"},"children":[],"expanded":false,"type":"tdate"},{"configs":{"labelWidth":"110","readOnly":"true","hidden":"true","label":"申请人：","itemId":"CREATED_BY"},"children":[],"expanded":false,"type":"ttext"},{"configs":{"labelWidth":"110","readOnly":"true","hidden":"true","label":"流程实例编码","itemId":"INS_CODE"},"children":[],"expanded":false,"type":"ttext"},{"configs":{"labelWidth":"110","readOnly":"true","hidden":"true","label":"流程审批状态：","itemId":"AUDIT_STATUS"},"children":[],"expanded":false,"type":"ttext"},{"configs":{"labelWidth":"110","hidden":"true","label":"单据类型编码","itemId":"EX_CAT_CODE"},"children":[],"expanded":false,"type":"ttext"},{"configs":{"labelWidth":"110","hidden":"true","label":"单据编号：","itemId":"EX_DOC_CODE"},"children":[],"expanded":false,"type":"ttext"},{"configs":{"labelWidth":"110","hidden":"true","label":"单据ID","itemId":"EX_DOC_ID"},"children":[],"expanded":false,"type":"ttext"}],"expanded":true,"type":"tfieldset"}],"expanded":true,"type":"tcontainer"},{"configs":{"itemId":"detailContainers"},"events":{"initialize":"var opMode = '{#opMode#}' ;\nif(opMode == 'edit'){\n  var dataJson = Wb.decode('{#docJSON#}') ;\n  \n  // TODO: 加载明细\n  Wb.request({\n    url: 'm?xwl=xc/ex/qry/ex-my-doc-qry/data/select-ex-doc-dtls',\n    params: {'exDocId':app.EX_DOC_ID.getValue()},\n    timeout : 3600000,\n    async : false ,\n    success: function(resp) {\n      var response = Wb.decode(resp.responseText) ;\n      var records = response.rows ;\n      for(var i=0; i<records.length; i++){\n        var r = records[i] ;\n        r.LEDGER_ID = dataJson.LEDGER_ID ;\n        var _container = addDtlContainer(r);\n        app.detailContainers.add(_container);\n      }\n    }\n  });  \n}\n"},"children":[],"expanded":true,"type":"tcontainer"}],"expanded":true,"type":"tcontainer"}],"expanded":true,"type":"tviewport"}],"expanded":true,"type":"module"}],"pageLink":"","iconCls":""}