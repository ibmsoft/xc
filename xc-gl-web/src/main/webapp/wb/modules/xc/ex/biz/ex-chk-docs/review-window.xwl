{"inframe":false,"title":"复核及入账详情","hidden":false,"roles":{"default":1},"children":[{"configs":{"initScript":"var ctxPath = request.getContextPath() ;\nrequest.setAttribute('contextPath',ctxPath);","serverScript":"//---------------------获取当前模块语言对应的.json文件，放到request中----------------\ncom.xzsoft.xip.platform.util.XipUtil.getCurrentLang(request,\"xc/ex/biz/ex-chk-docs/json/ex-chk-docs\");\n// TODO: 凭证头ID\nvar headId = request.getParameter(\"headId\") ;\nrequest.setAttribute(\"headId\", headId) ;\n\n// TODO: 模板类型: normal-金额式, amount-数量金额式, foreign-外币金额式\nrequest.setAttribute(\"vtype\", \"normal\") ;\n\n// 系统根目录\nrequest.setAttribute(\"contextPath\", request.getContextPath()) ;\n\n","itemId":"module"},"events":{"finalize":"var ledgerId = '';//账簿ID\nvar vHeadId = '';//凭证头ID\nvar exCatCode = '';//单据类型\nvar exDocId = '';//单据ID\nvar insCode = '';//实例编码\nvar amount = '';//单据金额\nvar cancelAmt = '';//核销金额\nvar payMethod = '' ;\nvar payId = '' ;\nvar url = '';\nvar createdBy = '' ;\n//定义窗口对象\nExt.apply(app,{\n    initWindow:function(params){\n        Ext.apply(app,params);\n        ledgerId = params.ledgerId;//账簿ID\n        vHeadId = params.vHeadId;//凭证头ID\n        createdBy = params.createdBy;//单据创建人\n        exCatCode = params.exCatCode;//单据类型\n        exDocId = params.exDocId;//单据ID\n        payMethod = params.payMethod ; // 支付方式\n        insCode = params.insCode;//实例编码\n        payId = params.payId ;\n        amount = params.amount;//单据金额\n        cancelAmt = params.cancelAmt;//核销金额\n        url = params.docFormUrl ;\n        if(payId !== null && payId !== ''){\n            Wb.request({\n                url : 'm?xwl=xc/ex/biz/ex-chk-docs/ex-chk-docsDB/windowDB/payInfoSelect',\n                params : {EX_PAY_ID : payId},\n                success : function(resp){\n                    var temp = Wb.decode(resp.responseText);\n                    app.PAY_TYPE.setValue(temp.rows[0].PAY_TYPE);\n                    app.DEPOSIT_BANK_ID.setValue(temp.rows[0].DEPOSIT_BANK_NAME);\n                    app.CASH_ITEMS1.setValue(temp.rows[0].CA_DISPLAY_NAME);\n                }\n            });\n        }\n        app.hidePayId.setValue(payId) ;\n        app.VERFY_DATE.setValue(params.finDate);\n        if(payMethod !== null && payMethod !== ''){\n          app.PAY_METHOD.setValue(payMethod);\n          app.PAY_METHOD.setReadOnly(true);\n        }\n        \n        if(exCatCode === 'EX02'){//借款单\n            app.souDou_panel.setHeight(240);\n        }\n        if(exCatCode === 'EX03'){//差旅报销单\n          app.CANCEL_AMT.setValue(cancelAmt);//核销金额\n        }\n        if(exCatCode === 'EX04'){//费用报销单\n          app.CANCEL_AMT.setValue(cancelAmt);//核销金额\n        }\n        if(exCatCode === 'EX05'){//还款单\n          app.souDou_panel.setHeight(240);\n          app.CANCEL_AMT.setValue(amount); // 还款金额\n        }\n      \n        // TODO: 如果已生成凭证,则凭证按钮置灰\n        if(vHeadId !== null && vHeadId !== \"\" && vHeadId !== undefined){\n          app.createDocButton.setDisabled(true);\n        }\n        /*\n        会计日期：会计日期：当前登录日期所在会计期如果打开状态，取当前日期；如果没有打开，\n        先前找到最大打开会计期最后一天，为会计日期；如果没有找到，日期为空。\n        */\n        if(params.finDate === null || params.finDate === ''){\n            Wb.request({//凭证日期查询\n                url : 'm?xwl=xc/ex/biz/ex-chk-docs/ex-chk-docsDB/windowDB/voucherDateSelect',\n                params : {LEDGER_ID : ledgerId,NOWDATE : Ext.util.Format.date(new Date(),'Y-m-d')},\n                success : function(resp){\n                    var temp = Wb.decode(resp.responseText);\n                    if(temp.total > 0){\n                        if(temp.rows[0].LD_PERIOD_STATUS == '1'){//会计期打开\n                            app.VERFY_DATE.setValue(new Date());//当前日期\n                        }\n                        if(temp.rows[0].LD_PERIOD_STATUS !== '1'){//会计期没有打开\n                            app.VERFY_DATE.setValue(new Date());//如果没有打开，先前找到最大打开会计期最后一天，为会计日期\n                        }\n                    }\n                    else {\n                        app.VERFY_DATE.setValue('');//空值\n                    }\n                }\n            });\n        }\n\t\t// TODO: 已生成凭证\n        if(Ext.isEmpty(vHeadId)){\n          Wb.request({//是否允许挂账支付\n              url : 'm?xwl=xc/ex/biz/ex-chk-docs/ex-chk-docsDB/windowDB/ledger-is-cr-parSelect',\n              params : {LEDGER_ID : ledgerId},//传参\n              success : function(resp){\n                  var temp = Wb.decode(resp.responseText);//返回的数据\n                  if(temp.rows[0].IS_CR_PAY === 'Y'){//允许挂账支付\n                      app.PAY_METHOD.setReadOnly(false);//允许挂账支付---支付方式设为可以选择\n                  }\n                  //借款单和还款单只能采用立即支付方式进行支付。\n                  if(temp.rows[0].IS_CR_PAY === 'N' || temp.rows[0].IS_CR_PAY === null || temp.rows[0].IS_CR_PAY === '' || exCatCode == 'EX02' || exCatCode == 'EX05'){//不允许挂账支付\n                      app.PAY_METHOD.setValue('1');//不允许挂账支付---支付方式设为默认的立即支付\n                      app.PAY_METHOD.setReadOnly(true);//不允许挂账支付---支付方式设为只读\n                  }\n              }\n          });\n        }\n\n        // 加载业务单据\n        souDocView(url);\n        app.review_window.show();//显示窗口     \n    }\n});\n\n// TODO: 原始单据界面\nfunction souDocView(url){\n    Wb.run({\n        url : url.substring(1),\n        params : {\n          'exDocId' : exDocId,\n          'opMode' : 'CHECK'\n        },\n        success : function(obj) {\n          app.souDou_panel.add(obj.viewport1);\n          obj.initViewport({\n            getCancelAmt:function(cancel_amt,exPayDesc){\n              app.CANCEL_AMT.setValue(cancel_amt);\n              app.EX_PAY_DESC.setValue(exPayDesc);\n            }\n          });\n        }\n    });\n}\n\n// TODO: 保存凭证\nfunction saveVoucher(infoJson,infoArray){\n\n  // TODO: 进度条\n  var msg = Ext.MessageBox.show({\n    title:'{#progress1#}',\n    msg:'{#progress2#}',\n    width:240,\n    wait:true,\n    progress :true,\n    closable :false\n  });\n\n  // 提交请求执行凭证保存\n  Wb.request({\n    url: '{#contextPath#}'+'/exCheckAndPayAction.do?method=saveVoucher',\n    timeout : 3600000 ,\n    params: {\n      'infoJson'  : infoJson,\n      'infoArray' : infoArray\n    },\n    success: function(resp) {\n      msg.hide();\n      if(typeof app.loadGridData == 'function'){\n        app.loadGridData() ;\n      }\n      var response = Wb.decode(resp.responseText) ;\n      Wb.info(response.msg) ;\n    }\n  });\n}\n\n// TODO: 提交凭证\nfunction submitVoucher(infoJson,infoArray){\n  // TODO: 进度条\n  var msg = Ext.MessageBox.show({\n    title:'{#progress1#}',\n    msg:'{#progress2#}',\n    width:240,\n    wait:true,\n    progress :true,\n    closable :false\n  });\n  // 辅助参数\n  var json = {\n    'docId'     : exDocId,\n    'payId'     : app.hidePayId.getValue(),\n    'bizType'   : 'EXCHK',\n    'payMethod' : app.PAY_METHOD.getValue(),\n    'exCatCode' : exCatCode,\n    'createdBy' : createdBy\n  } ;\n\n  // 提交请求执行凭证提交\n  Wb.request({\n    url: '{#contextPath#}'+'/exCheckAndPayAction.do?method=submitVoucher',\n    timeout : 3600000 ,\n    params: {\n      'infoJson'  : infoJson,\n      'infoArray' : infoArray,\n      'paramJson' : Wb.encode(json) \n    },\n    success: function(resp) {\n      msg.hide();\n      var response = Wb.decode(resp.responseText) ;\n      if(response.flag === \"0\"){\n        app.review_window.hide() ;\n        if(typeof app.loadGridData == 'function'){\n          app.loadGridData() ;\n        }\n      }\n      Wb.info(response.msg) ;\n    }\n  });\n}\n"},"children":[{"configs":{"maximized":"true","title":"{#FinTitle#}","frame":"true","height":"500","autoScroll":"true","width":"920","layout":"fit","closeAction":"hide","resizable":"false","border":"false","itemId":"review_window","modal":"true"},"events":{"hide":"// TODO: 刷新主界面表格数据\napp.loadGridData() ;"},"children":[{"configs":{"border":"false","itemId":"review_tab"},"events":{"beforerender":"app.edit_v_xwl.xwl_v_panel.setTitle('{#Voucher#}');"},"children":[{"configs":{"tagConfigs":"baseCls : 'my-panel-no-border'","title":"{#Original#}","frame":"true","autoScroll":"true","itemId":"dource_doc_panel"},"children":[{"configs":{"tagConfigs":"baseCls : 'my-panel-no-border'","height":"500","frame":"true","layout":"fit","border":"false","itemId":"souDou_panel"},"children":[],"expanded":true,"type":"panel"},{"configs":{"margin":"-20 0 0 0","buttonAlign":"center","border":"false","itemId":"currDou_form"},"children":[{"configs":{"tagConfigs":"baseCls : 'my-panel-no-border'","frame":"true","hidden":"true","layout":"column","margin":"10 0 0 0","border":"false","itemId":"hide_panel"},"children":[{"configs":{"tagConfigs":"columnWidth : 0.33","labelWidth":"90","labelAlign":"right","itemId":"CANCEL_AMT","fieldLabel":"核销金额"},"children":[],"expanded":false,"type":"text"},{"configs":{"hidden":"true","itemId":"EX_PAY_DESC","fieldLabel":"立即支付付款单描述"},"children":[],"expanded":false,"type":"text"},{"configs":{"tagConfigs":"columnWidth : 0.55","labelWidth":"80","displayField":"CA_DISPLAY_NAME","hidden":"true","valueField":"CA_ID","labelAlign":"right","itemId":"CASH_ITEMS","fieldLabel":"现金流量"},"events":{"beforequery":"//对下拉框增加模糊查询处理\nvar combo = plan.combo ;\nif(!plan.forceAll){\n    var value = plan.query;\n    combo.store.filterBy(function(record,id){\n        var text = record.get(combo.displayField);\n        return (text.indexOf(value)!=-1);\n    });\n    combo.expand();\n    return false;\n}","select":"var ca_code = records[0].data.CA_CODE ;\nvar _ca_name = records[0].data.CA_NAME ;\nvar ca_id = records[0].data.CA_ID ;\napp.CASH_CODE.setValue(ca_code);\napp.CASH_ID.setValue(ca_id) ;\napp.CASH_ITEMS.setRawValue(_ca_name);"},"children":[],"expanded":true,"type":"combo"},{"configs":{"labelWidth":"80","readOnly":"true","hidden":"true","labelAlign":"right","itemId":"CASH_CODE","fieldLabel":"现金流量项目"},"children":[],"expanded":false,"type":"text"},{"configs":{"labelWidth":"80","hidden":"true","labelAlign":"right","itemId":"CASH_ID","fieldLabel":"现金流量项ID"},"children":[],"expanded":false,"type":"text"},{"configs":{"hidden":"true","itemId":"hidePayId","fieldLabel":"付款单ID"},"children":[],"expanded":false,"type":"text"}],"expanded":false,"type":"panel"},{"configs":{"tagConfigs":"baseCls : 'my-panel-no-border'","frame":"true","layout":"column","margin":"0 0 5 10","border":"false","itemId":"style_panel"},"children":[{"configs":{"tagConfigs":"columnWidth : 0.298","labelWidth":"90","allowBlank":"false","labelAlign":"right","itemId":"VERFY_DATE","fieldLabel":"<font color='red'>*<\/font>{#VERFY_DATE#}"},"children":[],"expanded":false,"type":"date"},{"configs":{"tagConfigs":"columnWidth : 0.398","labelWidth":"100","allowBlank":"false","displayField":"VAL_NAME","valueField":"VAL_CODE","labelAlign":"right","itemId":"PAY_METHOD","fieldLabel":"<font color='red'>*<\/font>{#PAY_METHOD#}","editable":"false"},"events":{"change":"if(newValue == '2'){//挂账支付\n    app.PAY_TYPE.setReadOnly(true);\n    app.PAY_TYPE.reset();\n    app.CASH_ITEMS1.reset();\n    app.PAY_TYPE.allowBlank = true;\n    app.CASH_ITEMS1.setReadOnly(true);\n    app.CASH_ITEMS1.allowBlank = true;\n}\nif(newValue == '1'){//立即支付\n    app.PAY_TYPE.setReadOnly(false);\n    app.PAY_TYPE.allowBlank = false;\n    app.CASH_ITEMS1.setReadOnly(false);\n    app.CASH_ITEMS1.allowBlank = false;\n}"},"children":[{"configs":{"autoLoad":"true","itemId":"store","url":"m?xwl=xc/ex/biz/ex-chk-docs/ex-chk-docsDB/windowDB/payMethodSelect"},"children":[],"expanded":false,"type":"store"}],"expanded":false,"type":"combo"},{"configs":{"tagConfigs":"columnWidth : 0.298","labelWidth":"100","readOnly":"true","displayField":"MODE_NAME","valueField":"MODE_ID","labelAlign":"right","itemId":"PAY_TYPE","fieldLabel":"{#PAY_TYPE#}","editable":"false"},"events":{"change":"Wb.request({\n    url : 'm?xwl=xc/ex/biz/ex-chk-docs/ex-chk-docsDB/windowDB/payTypeSelect',\n    params : {LEDGER_ID : ledgerId,MODE_ID : newValue},//传参\n    success : function(resp){\n        var temp = Wb.decode(resp.responseText);//返回的数据\n        if(temp.rows[0].MODE_TYPE !== 'bank'){//付款方式不为银行\n            app.DEPOSIT_BANK_ID.reset();\n            app.DEPOSIT_BANK_ID.allowBlank = true;\n            app.DEPOSIT_BANK_ID.setReadOnly(true);\n        }\n        if(temp.rows[0].MODE_TYPE == 'bank' && newValue !== null){//付款方式为银行并且付款科目不为空\n            app.DEPOSIT_BANK_ID.setReadOnly(false);\n            app.DEPOSIT_BANK_ID.allowBlank = false;\n        }\n    }\n});"},"children":[{"configs":{"autoLoad":"true","itemId":"store","url":"m?xwl=xc/ex/biz/ex-chk-docs/ex-chk-docsDB/windowDB/payTypeSelect"},"events":{"beforeload":"store.proxy.extraParams.LEDGER_ID = ledgerId;"},"children":[],"expanded":false,"type":"store"}],"expanded":false,"type":"combo"}],"expanded":true,"type":"panel"},{"configs":{"tagConfigs":"baseCls : 'my-panel-no-border'","frame":"true","layout":"column","margin":"20 0 5 10","border":"false","itemId":"style_panel1"},"children":[{"configs":{"tagConfigs":"columnWidth : 0.298","labelWidth":"90","readOnly":"true","displayField":"DEPOSIT_BANK_NAME","valueField":"DEPOSIT_BANK_ID","labelAlign":"right","itemId":"DEPOSIT_BANK_ID","fieldLabel":"{#DEPOSIT_BANK_ID#}","editable":"false"},"children":[{"configs":{"autoLoad":"true","itemId":"store","url":"m?xwl=xc/ex/common-db/query/select-ld-deposit-banks"},"events":{"beforeload":"store.proxy.extraParams.ledgerId = ledgerId;"},"children":[],"expanded":false,"type":"store"}],"expanded":false,"type":"combo"},{"configs":{"tagConfigs":"columnWidth : 0.398","labelWidth":"100","readOnly":"true","triggerCls":"x-form-search-trigger","labelAlign":"right","itemId":"CASH_ITEMS1","fieldLabel":"{#CASH_ITEMS1#}"},"children":[{"configs":{"tagConfigs":"minWidth : 550","height":"250","store":"app.cash_store","barExportButtons":"false","barRefreshButton":"false","itemId":"pickComp"},"events":{"itemclick":"var picker = this.ownerCmp;\napp.CASH_ITEMS.setValue(record.get('CA_ID'));\npicker.setValue(record.data.CA_DISPLAY_NAME);\npicker.collapse();\napp.cash_items_text.reset();"},"children":[{"configs":{"itemId":"tbar"},"children":[{"configs":{"labelWidth":"70","width":"300","emptyText":"{#queryCodeOrName#}","labelAlign":"right","itemId":"itemCodeOrName"},"events":{"specialkey":"if(Ext.EventObject.getKey()==13){\n    app.findCashItemsBtn.fireEvent('click');\n}"},"children":[],"expanded":false,"type":"text"},{"configs":{"width":"25","itemId":"findCashItemsBtn","iconCls":"seek_icon","tooltip":"查询"},"events":{"click":"app.pickComp.getStore().load() ;"},"children":[],"expanded":false,"type":"button"},{"configs":{"width":"25","itemId":"resetCashItemsBtn","iconCls":"cancel_icon","tooltip":"{#clearInfo#}"},"events":{"click":"app.CASH_ITEMS1.reset();\n// app.CASH_ITEMS1.getPicker().hide();\napp.itemCodeOrName.setValue() ;\napp.findCashItemsBtn.fireEvent('click') ;\napp.CASH_ITEMS.reset();"},"children":[],"expanded":false,"type":"button"}],"expanded":true,"type":"toolbar"},{"configs":{"autoLoad":"true","itemId":"store","url":"m?xwl=xc/ex/common-db/query/select-cash-items"},"events":{"beforeload":"store.proxy.extraParams.textStr = app.itemCodeOrName.getValue() ;"},"children":[],"expanded":false,"type":"store"},{"configs":{"itemId":"columns"},"children":[{"configs":{"text":"ID","hidden":"true","dataIndex":"CA_ID","titleAlign":"center","itemId":"CA_ID_COL"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#CA_CODE_COL#}","width":"100","dataIndex":"CA_CODE","titleAlign":"center","itemId":"CA_CODE_COL"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#CA_NAME_COL#}","width":"350","dataIndex":"CA_NAME","titleAlign":"center","itemId":"CA_NAME_COL"},"children":[],"expanded":false,"type":"column"}],"expanded":true,"type":"array"}],"expanded":true,"type":"grid"}],"expanded":false,"type":"picker"}],"expanded":true,"type":"panel"},{"configs":{"itemId":"buttons"},"children":[{"configs":{"tagConfigs":"columnWidth : 0.08","text":"{#returnButton#}","hidden":"true","margin":"0 0 0 10","itemId":"returnButton","iconCls":"left_icon"},"events":{"click":"if(insCode === null || insCode === '') {\n\tWb.warn('该报销单没有提交，不能退回！');\n\treturn;\n}\nTaskUtil.doBack('EX_DOC_ID','退回操作','EX_DOC_ID','returnButton',insCode,exDocId);"},"children":[],"expanded":false,"type":"button"},{"configs":{"tagConfigs":"columnWidth : 0.08","text":"{#createDocButton#}","margin":"0 0 0 10","itemId":"createDocButton","iconCls":"script_icon"},"events":{"click":"// TODO: 验证form表单框录入值是否合法\nif(!Wb.verify(app.currDou_form)){\n  return;\n}\n// 凭证日期\nvar accDate = Ext.util.Format.date(app.VERFY_DATE.getValue(),'Y-m-d') ;   \n// 支付方式\nvar payMethod = app.PAY_METHOD.getValue() ;  \n// 付款方式\nvar payType = app.PAY_TYPE.getValue() ;      \nif(payType === null || payType === \"\" || payType === undefined){\n  payType = '' ;\n}\n// 付款账号\nvar bankId = app.DEPOSIT_BANK_ID.getValue() ;\nif(bankId === null || bankId === \"\" || bankId === undefined){\n  bankId = '' ;\n}\n// 现金流量项目\nvar cashId = app.CASH_ITEMS.getValue() ;     \n// 核销金额\ncancelAmt = app.CANCEL_AMT.getValue() ;\nif(cancelAmt === null || cancelAmt === \"\" || cancelAmt === undefined){\n  cancelAmt = 0 ;\n}\n// 本次支付金额\nvar payAmt = amount - cancelAmt ;   \n// 如果还款单,则本次还款金额为复核时修改后的金额\nif(exCatCode === 'EX05'){ \n  payAmt = cancelAmt ;\n}\n// 本次支付金额为0,则不允许采用挂账支付\nif(payAmt === 0 &&　payMethod　=== '2'){\n  Wb.toast('{#createDoc1#}') ;\n  return false ;\n}\n\n// TODO: 定义参数\nvar paramJson = {\n  'ledgerId'\t:\tledgerId,\n  'accDate'\t\t:\taccDate,\n  'payMethod'\t:\tpayMethod,\t\t\n  'payType'\t\t:\tpayType,\t\t\n  'bankId'\t\t:\tbankId,\t\t\n  'cashId'\t\t:\tcashId,\t\t\n  'exCatCode'\t:   exCatCode,\t\t\n  'exDocId'\t\t:\texDocId,\t\t\n  'cancelAmt'\t:\tcancelAmt,\t\t\n  'payAmt'\t\t:\tpayAmt,\n  'exPayDesc'   :   app.EX_PAY_DESC.getValue()\n} ;\n\n// TODO: 进度条\nvar msg = Ext.MessageBox.show({\n  title:'{#progress1#}',\n  msg:'{#progress2#}',\n  width:240,\n  wait:true,\n  progress :true,\n  closable :false\n});\n\n// TODO: 提交请求复核单据\nWb.request({\n  url: '{#contextPath#}' +'/exCheckAndPayAction.do?method=checkEXDoc',\n  timeout : 3600000,\n  params: {\n    'params':Wb.encode(paramJson)\n  },\n  success: function(resp) {\n    msg.hide() ;\n    var response = Wb.decode(resp.responseText);\n    if(response.flag == '0'){\n      Wb.info(\"{#createDoc2#}\") ;\n      app.createDocButton.disable() ;\n      app.loadGridData();\n      app.hidePayId.setValue(response.payId) ; // 付款单ID\n      app.PAY_METHOD.setReadOnly(true) ;\n      // 凭证头ID\n      var headId = response.headId ;\n      if(headId !== null && headId !== \"\" && headId !== undefined){\n        // 加载凭证头信息\n        Wb.request({\n          url: 'm?xwl=xc/gl/journal/data-db/common-data/select-v-head',\n          params: {'headId':headId},\n          success: function(resp) {\n            var headJson = Wb.decode(resp.responseText) ;\n            Wb.setValue(app.edit_v_xwl.form1,headJson) ;\n            Wb.setValue(app.edit_v_xwl.bbar,headJson) ;\n            // 处理会计日期\n            var accDate = headJson.accountDate ;\n            app.edit_v_xwl.accountDate.setValue(Wb.strToDate(accDate)) ;\n          }\n        });\n        // 加载凭证分录行\n        app.edit_v_xwl.grid1.getStore().load({\n          params :{'headId':headId}\n        }) ;\n      }\n    }else{\n      Wb.info(\"{#createDoc3#}: \"+response.msg) ;\n    }\n  }\n});\n"},"children":[],"expanded":false,"type":"button"}],"expanded":true,"type":"array"}],"expanded":true,"type":"form"}],"expanded":true,"type":"panel"},{"configs":{"file":"m?xwl=xc/gl/journal/v-windows/new-xwl-voucher","itemId":"edit_v_xwl"},"children":[],"expanded":false,"type":"xwl"}],"expanded":true,"type":"tab"}],"expanded":true,"type":"window"}],"expanded":true,"type":"module"}],"pageLink":"","iconCls":"window_icon"}