{"inframe":false,"title":"单据复核及入账","hidden":false,"roles":{"default":1},"children":[{"configs":{"initScript":"var userId = request.getSession().getAttribute(\"XzSessionVars\").get('userId');\n\nvar protocol = request.getProtocol() ;\nvar ipAddr = request.getServerName();\nvar port = request.getServerPort() ;\nvar ctxPath = request.getContextPath() ;\n\nvar pp = protocol.substr(0,5) ;\nprotocol = (pp.indexOf(\"https\") == -1 ? \"http\" : \"https\") ;\n\nvar url = protocol + \"://\" + ipAddr +\":\" + port + ctxPath ;\n\nrequest.setAttribute('contextPath',ctxPath);\nrequest.setAttribute(\"userId\",userId);\nrequest.setAttribute(\"appIP\",url);\nvar appId = request.getSession().getAttribute(\"XzSessionVars\").get('appId');\nrequest.setAttribute(\"funId\",request.getParameter('funId'));\nrequest.setAttribute(\"appId\",request.getParameter('appId'));","serverScript":"//---------------------获取当前模块语言对应的.json文件，放到request中----------------\ncom.xzsoft.xip.platform.util.XipUtil.getCurrentLang(request,\"xc/ex/biz/ex-chk-docs/json/ex-chk-docs\");","head":"<style type=\"text/css\">\n  .my_custom_grid .x-grid-row{\n      height:50px;\n  }\n  .my_custom_grid .x-grid-editor .x-form-text{\n      height:49px;\n  }\n  .my_custom_grid .x-grid-cell{\n      font: normal 12px/13px tahoma, arial, verdana, sans-serif;\n  }\n  .my_custom_grid .x-grid-cell{\n      border-color: #d0d0d0;\n  }\n  .my_custom_grid .x-grid-with-col-lines .x-grid-cell {\n    border-right-width: 1px;\n  }\n  .my_custom_grid .x-grid-with-row-lines .x-grid-td {\n    border-bottom-width: 1px;\n}\n<\/style>\n\n<script type=\"text/javascript\" src=\"{#contextPath#}/workflow/util/taskUtil.js\"><\/script>","itemId":"module"},"events":{"finalize":"var ledgerId = '';"},"children":[{"configs":{"title":"{#returnReason#}","height":"200","width":"500","layout":"fit","closeAction":"hide","dialog":"true","itemId":"win","modal":"true"},"events":{"ok":"// TODO: 执行单据取消处理\nvar rows = app.no_chk_docs_grid.getSelection() ;\nif(rows.length != 1){\n  Wb.toast('{#cancelRec1#}') ;\n  return false ;\n}else{\n  var r = rows[0].data ;\n  var docId = r.EX_DOC_ID ;\n  \n  var cr = app.cancel_reason.getValue() ;\n  if(cr === null || cr === \"\" || cr === undefined){\n    Wb.toast('{#returnReason1#}') ;\n    return false ;\n  }\n  \n  // TODO: 进度条\n  var msg = Ext.MessageBox.show({\n    title:'{#progress1#}',\n    msg:'{#progress2#}',\n    width:240,\n    wait:true,\n    progress :true,\n    closable :false\n  });\n  // 提交请求\n  Wb.request({\n    url: '{#contextPath#}' +'/exCheckAndPayAction.do?method=cancelDoc',\n    timeout : 3600000,\n    params: {\n      'docId'   : docId,\n      'cancelReason' : app.cancel_reason.getValue()\n    },\n    success: function(resp) {\n      msg.hide() ;\n      app.win.hide() ;\n      var response = Wb.decode(resp.responseText) ;\n      if(response.flag === \"0\"){\n        app.no_searchButton.fireEvent('click') ;\n      }\n      Wb.toast(response.msg) ;\n    }\n  });\n  \n}"},"children":[{"configs":{"layout":"fit","border":"false","itemId":"form"},"children":[{"configs":{"emptyText":"--{#returnReason1#}---","itemId":"cancel_reason"},"children":[],"expanded":false,"type":"textarea"}],"expanded":true,"type":"form"}],"expanded":false,"type":"window"},{"configs":{"maximized":"true","title":"{#printDocButton#}","height":"450","width":"800","layout":"fit","closeAction":"hide","html":"<iframe id='exDocPrintFormUrl' src='' scrolling=no frameborder=0 width=100% height=100% ><\/iframe>","border":"false","itemId":"printDocWin","modal":"true","maximizable":"true"},"children":[],"expanded":false,"type":"window"},{"configs":{"itemId":"columns"},"children":[{"configs":{"itemId":"chk_docs_columns"},"children":[{"configs":{"text":"{#ORDERBY#}","align":"center","xtype":"rownumberer","width":"50","titleAlign":"center","itemId":"ORDERBY"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"账簿ID","hidden":"true","dataIndex":"LEDGER_ID","titleAlign":"center","itemId":"LEDGER_ID_COL"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"费用单据ID","hidden":"true","width":"100","dataIndex":"EX_DOC_ID","titleAlign":"center","itemId":"EX_DOC_ID_COL"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#EX_DOC_CODE#}","width":"120","dataIndex":"EX_DOC_CODE","titleAlign":"center","itemId":"EX_DOC_CODE_COL"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#EX_REASON#}","width":"150","dataIndex":"EX_REASON","titleAlign":"center","itemId":"EX_REASON_COL"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#AMOUNT#}","align":"right","width":"120","dataIndex":"AMOUNT","format":"0,000.00","titleAlign":"center","itemId":"AMOUNT_COL"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#CANCEL_AMT#}","hidden":"true","align":"right","width":"80","dataIndex":"CANCEL_AMT","format":"0,000.00","titleAlign":"center","itemId":"CANCEL_AMT_COL"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"单据类型","hidden":"true","width":"100","dataIndex":"EX_CAT_CODE","titleAlign":"center","itemId":"EX_CAT_CODE_COL"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#EX_CAT_NAME#}","width":"100","dataIndex":"EX_CAT_NAME","titleAlign":"center","itemId":"EX_CAT_NAME_COL"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"报销人","hidden":"true","width":"80","dataIndex":"CREATED_BY","titleAlign":"center","itemId":"CREATED_BY_COL"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#CLAIMSPEOPER#}","width":"80","dataIndex":"CLAIMSPEOPER","titleAlign":"center","itemId":"CLAIMSPEOPER_COL"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#DEPT_NAME#}","width":"100","dataIndex":"DEPT_NAME","titleAlign":"center","itemId":"DEPT_NAME_COL"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#PROJECT_NAME#}","width":"150","dataIndex":"PROJECT_NAME","titleAlign":"center","itemId":"PROJECT_NAME_COL"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#ORG_NAME#}","hidden":"true","width":"150","dataIndex":"ORG_NAME","titleAlign":"center","itemId":"ORG_NAME_COL"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#CREATION_DATE#}","xtype":"datecolumn","width":"80","dataIndex":"CREATION_DATE","titleAlign":"center","itemId":"CREATION_DATE_COL"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#V_STATUS#}","width":"100","dataIndex":"V_STATUS","titleAlign":"center","itemId":"V_STATUS_COL","renderer":"if(value === '1')\n    return \"凭证未生成\";\nif(value === '2')\n\treturn \"凭证已生成\";\nif(value === '3')\n    return \"凭证已复核\";\nif(value === '4')\n    return \"凭证已取消\";"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#CREATED_NAME#}","hidden":"true","width":"100","dataIndex":"CREATED_NAME","titleAlign":"center","itemId":"CREATED_NAME_COL"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#AUDIT_DATE#}","xtype":"datecolumn","width":"100","dataIndex":"AUDIT_DATE","titleAlign":"center","itemId":"AUDIT_DATE_COL"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"复核日期","hidden":"true","width":"100","dataIndex":"FIN_DATE","titleAlign":"center","itemId":"FIN_DATE_COL"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"审核人","hidden":"true","width":"100","dataIndex":"VERIFIER","titleAlign":"center","itemId":"VERIFIER_COL"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"审核日期","hidden":"true","xtype":"datecolumn","width":"100","dataIndex":"VERFY_DATE","titleAlign":"center","itemId":"VERFY_DATE_COL"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"实例编码","hidden":"true","width":"100","dataIndex":"INS_CODE","titleAlign":"center","itemId":"INS_CODE_COL"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"审批状态","hidden":"true","width":"100","dataIndex":"AUDIT_STATUS","titleAlign":"center","itemId":"AUDIT_STATUS_COL","renderer":"if(value == 'A'){\n\treturn '起草';\n}\nelse if(value == 'C'){\n\treturn '运行中';\n}\nelse if(value == 'R'){\n\treturn '撤回';\n}\nelse if(value == 'E'){\n\treturn '结束';\n}\nelse if(value == 'D'){\n\treturn '驳回';\n}"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#AUDIT_STATUS_DESC#}","hidden":"true","width":"100","dataIndex":"AUDIT_STATUS_DESC","titleAlign":"center","itemId":"AUDIT_STATUS_DESC_COL"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"当前审批人","hidden":"true","width":"100","dataIndex":"ADUIT_USERS","titleAlign":"center","itemId":"ADUIT_USERS_COL"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"签收状态","hidden":"true","width":"100","dataIndex":"SIGN_STATUS","titleAlign":"center","itemId":"SIGN_STATUS_COL","renderer":"if(value === '2')\n  return '已签收';"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"原始单据签收日期","hidden":"true","xtype":"datecolumn","width":"100","dataIndex":"SIGN_DATE","titleAlign":"center","itemId":"SIGN_DATE_COL"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"支付方式","hidden":"true","width":"100","dataIndex":"PAY_METHOD","titleAlign":"center","itemId":"PAY_METHOD_COL","renderer":"if(value == '1')\n    return '立即支付';\nif(value == '2')\n    return '挂账支付';"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"支付类型","hidden":"true","width":"100","dataIndex":"PAY_TYPE","titleAlign":"center","itemId":"PAY_TYPE_COL"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#PAY_STATUS#}","width":"100","dataIndex":"PAY_STATUS","titleAlign":"center","itemId":"PAY_STATUS_COL","renderer":"if(value == 'Y')\n    return '已付款';\nif(value == 'N' || value === null || value === '')\n    return '未付款';"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"支付单ID","hidden":"true","width":"100","dataIndex":"EX_PAY_ID","titleAlign":"center","itemId":"EX_PAY_ID_COL"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"凭证头ID","hidden":"true","width":"100","dataIndex":"V_HEAD_ID","titleAlign":"center","itemId":"V_HEAD_ID_COL"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"开户行","hidden":"true","dataIndex":"BANK_NAME","itemId":"BANK_NAME_COL"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"银行账号","hidden":"true","dataIndex":"BANK_NO","itemId":"BANK_NO_COL"},"children":[],"expanded":false,"type":"column"}],"expanded":true,"type":"array"}],"expanded":false,"type":"folder"},{"configs":{"layout":"fit","itemId":"viewport1"},"children":[{"configs":{"border":"false","itemId":"chk_tab"},"children":[{"configs":{"title":"{#NoProcessed#}","layout":"border","border":"false","itemId":"untreated_panel"},"events":{"deactivate":"// app.resetButton.fireEvent('click');\n// app.searchButton.fireEvent('click');"},"children":[{"configs":{"region":"north","itemId":"no_search_form"},"children":[{"configs":{"tagConfigs":"baseCls : 'my-panel-no-border'","layout":"column","margin":"10 0 0 0","border":"false","itemId":"no_row1"},"children":[{"configs":{"tagConfigs":"columnWidth : 0.25","labelWidth":"100","displayField":"LEDGER_NAME","valueField":"LEDGER_ID","emptyText":"{#selectInfo1#}","labelAlign":"right","itemId":"no_ledgers_com","fieldLabel":"{#LEDGER_NAME#}","editable":"false"},"events":{"change":"ledgerId = newValue;\napp.ledgers_com.setValue(newValue);\napp.dept_com.reset();\napp.project_com.reset();\napp.searchButton.fireEvent('click');","select":"app.no_searchButton.fireEvent('click');","specialkey":"if(Ext.EventObject.getKey()==13){\n\tapp.no_searchButton.fireEvent('click');\n}"},"children":[{"configs":{"pageSize":"-1","autoLoad":"true","itemId":"store","url":"m?xwl=xc/com-qry/gl-ledgers/select-sec-fd-ledgers"},"events":{"load":"if(store.getCount() ===1){\n  Wb.setValue(app.no_ledgers_com, {'no_ledgers_com':records[0].data.LEDGER_ID}) ;\n}"},"children":[],"expanded":false,"type":"store"}],"expanded":true,"type":"combo"},{"configs":{"tagConfigs":"columnWidth : 0.25","labelWidth":"100","labelAlign":"right","itemId":"no_cat_code","fieldLabel":"{#EX_DOC_CODE#}"},"events":{"change":"if(text.getValue() === ''){\n    app.no_searchButton.fireEvent('click');\n}","specialkey":"if(Ext.EventObject.getKey()==13){\n\tapp.no_searchButton.fireEvent('click');\n}"},"children":[],"expanded":false,"type":"text"},{"configs":{"tagConfigs":"columnWidth : 0.16","labelWidth":"100","labelAlign":"right","itemId":"no_users","fieldLabel":"{#CLAIMSPEOPER#}"},"events":{"change":"if(text.getValue() === ''){\n    app.no_searchButton.fireEvent('click');\n}","specialkey":"if(Ext.EventObject.getKey()==13){\n\tapp.no_searchButton.fireEvent('click');\n}"},"children":[],"expanded":false,"type":"text"}],"expanded":false,"type":"panel"},{"configs":{"tagConfigs":"baseCls : 'my-panel-no-border'","layout":"column","margin":"10 0 10 0","border":"false","itemId":"no_row2"},"children":[{"configs":{"tagConfigs":"columnWidth : 0.25","labelWidth":"100","labelAlign":"right","itemId":"no_dept_com","fieldLabel":"{#DEPT_NAME#}"},"events":{"change":"if(text.getValue() === ''){\n    app.no_searchButton.fireEvent('click');\n}","specialkey":"if(Ext.EventObject.getKey()==13){\n    app.no_searchButton.fireEvent('click');\n}"},"children":[],"expanded":false,"type":"text"},{"configs":{"tagConfigs":"columnWidth : 0.25","labelWidth":"100","labelAlign":"right","itemId":"no_project_com","fieldLabel":"{#PROJECT_NAME#}"},"events":{"change":"if(text.getValue() === ''){\n    app.no_searchButton.fireEvent('click');\n}","specialkey":"if(Ext.EventObject.getKey()==13){\n    app.no_searchButton.fireEvent('click');\n}"},"children":[],"expanded":true,"type":"text"},{"configs":{"tagConfigs":"columnWidth : 0.08","text":"{#queryBtn#}","margin":"0 0 0 20","itemId":"no_searchButton","iconCls":"seek_icon"},"events":{"click":"var params = {\n    LEDGER_ID : ledgerId,\n\tDEPT_ID : Ext.String.escape(app.no_dept_com.getValue()),\n\tPROJECT_ID : Ext.String.escape(app.no_project_com.getValue()),\n    EX_DOC_CODE : Ext.String.escape(app.no_cat_code.getValue()),\n    CREATED_BY : Ext.String.escape(app.no_users.getValue())\n};\napp.no_chk_docs_grid.store.load({params : params});//查询（重新加载数据）"},"children":[],"expanded":false,"type":"button"},{"configs":{"tagConfigs":"columnWidth : 0.08","text":"{#clearBtn#}","margin":"0 0 0 20","itemId":"no_resetButton","iconCls":"refresh_icon"},"events":{"click":"app.no_search_form.getForm().reset();\napp.no_searchButton.fireEvent('click');\napp.search_form.getForm().reset();\napp.searchButton.fireEvent('click');"},"children":[],"expanded":false,"type":"button"}],"expanded":false,"type":"panel"}],"expanded":false,"type":"form"},{"configs":{"region":"center","columns":"app.chk_docs_columns","border":"false","itemId":"no_chk_docs_grid"},"events":{"itemdblclick":"app.reviewButton.fireEvent('click');"},"children":[{"configs":{"autoLoad":"true","itemId":"store","url":"m?xwl=xc/ex/biz/ex-chk-docs/ex-chk-docsDB/ex-chk-docsSelectN"},"events":{"beforeload":"store.proxy.extraParams.LEDGER_ID = app.no_ledgers_com.getValue();"},"children":[],"expanded":false,"type":"store"},{"configs":{"itemId":"tbar"},"children":[{"configs":{"text":"{#reviewButton#}","itemId":"reviewButton","iconCls":"check_icon"},"events":{"click":"var rec = app.no_chk_docs_grid.getSelection();//选择记录\nif(app.no_ledgers_com.getValue() === '' || app.no_ledgers_com.getValue() === null){\n\tWb.toast('{#reviewRec1#}');\n    return;\n}\nif (rec.length > 1 || rec.length === 0) {//大于一条或没选择会警告\n\tWb.toast('{#reviewRec2#}');\n    return;\n}\nif (rec[0].data.V_STATUS == '3') {//大于一条或没选择会警告\n\tWb.toast('{#reviewRec3#}');\n    return;\n}else{\n    var r = rec[0].data;\n    Wb.run({\n        url : 'm?xwl=xc/ex/biz/ex-chk-docs/review-window',\n        params : {\n          'headId' : r.V_HEAD_ID\n        },\n        success : function(appObj){\n            appObj.initWindow({\n                loadGridData : function(){\n                    app.no_searchButton.fireEvent('click') ;\n                    app.searchButton.fireEvent('click');\n                },\n                ledgerId :\tledgerId,\t\t//账簿\n                exDocId :\tr.EX_DOC_ID,\t//费用单据ID\n                exDocCode :\tr.EX_DOC_CODE,\t//费用单据编码\n                amount :\tr.AMOUNT,\t\t//单据金额\n                cancelAmt :\tr.CANCEL_AMT,\t//核销金额\n                exCatCode : r.EX_CAT_CODE,\t//单据类型\n                payMethod : r.PAY_METHOD,\t//支付方式\n                payType :\tr.PAY_TYPE,\t\t//支付类型\n                payId :\t\tr.EX_PAY_ID ,\t//支付单ID\n                finDate :\tr.FIN_DATE ,\t//复核日期\n                vHeadId :\tr.V_HEAD_ID,\t//凭证头ID\n                vStatus :\tr.V_STATUS,\t\t//凭证状态\n                createdBy : r.CREATED_BY,\t//凭证创建人\n                docFormUrl : r.PC_A_FORM_URL ,\n                createdByName : r.CLAIMSPEOPER \n            });\n        }\n    });\n}"},"children":[],"expanded":false,"type":"button"},{"configs":{"text":"{#cancelButton#}","itemId":"cancelButton","iconCls":"first_icon"},"events":{"click":"// TODO: 执行单据取消处理\nvar rows = app.no_chk_docs_grid.getSelection() ;\nif(rows.length != 1){\n  Wb.toast('{#cancelRec1#}') ;\n  return false ;\n}else{\n  app.win.show();\n}\n"},"children":[],"expanded":false,"type":"button"},{"configs":{"text":"退回","hidden":"true","itemId":"returnButton","iconCls":"left_icon"},"events":{"click":"var rows = app.no_chk_docs_grid.getSelection();\nif(app.no_ledgers_com.getValue() === '' || app.no_ledgers_com.getValue() === null){\n\tWb.toast('请选择账簿进行查询！');\n    return;\n}\nif (rows.length > 1 || rows.length === 0) {//大于一条或没选择会警告\n    Wb.toast('请选择一条需要复核的记录。');\n    return;\n}\nelse if(rows[0].data.INS_CODE === null || rows[0].data.INS_CODE === '') {\n\tWb.toast('该报销单没有提交，不能退回！');\n\treturn;\n}\nelse {\n\t/**\n\t* 回退处理\n\t* @param {} taskId\t\t\t\t:\t待办ID\n\t* @param {} comment\t\t\t\t:\t审批意见\n\t* @param {} backToActivityId\t:\t发起回退业务的节点ID\n\t* @param {} buttonCode\t\t\t:\t按钮编码\n\t* @param {} insCode\t\t\t\t:\t实例编码\n\t* @param {} bizId\t\t\t\t:\t业务ID\n\t*/\n    TaskUtil.doBack('EX_DOC_ID','退回操作','EX_DOC_ID','returnButton',rows[0].data.INS_CODE,rows[0].data.EX_DOC_ID);\n\n}"},"children":[],"expanded":false,"type":"button"},{"configs":{"text":"{#annexButton#}","itemId":"annexButton","iconCls":"attach_icon"},"events":{"click":"// TODO: 请选择单据\nvar rows = app.no_chk_docs_grid.getSelection();\n\n// TODO: 一次只能选择一张单据\nif(rows.length > 1 || rows.length === 0) {\n  Wb.toast('{#annexRec1#}') ;\n  return;\n  \n}else{\n  // 账簿ID和单据类型\n  var ledgerId = rows[0].data.LEDGER_ID ;\n  var docCat = rows[0].data.EX_CAT_CODE ;\n  \n  // 获取附件分类\n  Wb.request({\n    url: '{#contextPath#}'+'/exDocsAction.do?method=getAttCatCode',\n    params: {\n      'ledgerId' : ledgerId,\n      'docCat'   : docCat\n    },\n    success: function(resp) {\n      var response = Wb.decode(resp.responseText) ;\n      if(response.flag == \"0\"){\n        // 附件分类码\n        var att_cat_code = response.attCat ;\n        // 上传附件\n        Xip.showAttachmentManager('{#XIP.userId#}',rows[0].data.EX_DOC_ID,'',att_cat_code,rows[0].data.EX_DOC_CODE,'Y','Y','Y',function(){},2);  \n        \n      }else{\n        Wb.info(response.msg) ;\n      }\n    }\n  });    \n}"},"children":[],"expanded":false,"type":"button"},{"configs":{"text":"{#monitorBtn#}","itemId":"monitorBtn","iconCls":"viewport_icon"},"events":{"click":"// TODO: 选中记录行\nvar rows = app.no_chk_docs_grid.getSelection();\nif(rows.length != 1){\n  Wb.toast('请选择 1 条需要监控流程审批的单据');\n}else{\n  var insCode= rows[0].data.INS_CODE ;\n  if(insCode !== null && insCode !== \"\" && insCode !== undefined){\n    // 打开流程监控图\n    XipWf.showMonitorPage(insCode);\n    \n  }else{\n    Wb.toast('单据尚未提交审批');\n  }\n}"},"children":[],"expanded":false,"type":"button"}],"expanded":true,"type":"toolbar"}],"expanded":true,"type":"grid"}],"expanded":false,"type":"panel"},{"configs":{"title":"{#Processed#}","layout":"border","border":"false","itemId":"processed_panel"},"events":{"deactivate":"// app.no_resetButton.fireEvent('click');\n// app.no_searchButton.fireEvent('click');"},"children":[{"configs":{"region":"north","itemId":"search_form"},"children":[{"configs":{"tagConfigs":"baseCls : 'my-panel-no-border'","layout":"column","margin":"10 0 0 0","border":"false","itemId":"row1"},"children":[{"configs":{"tagConfigs":"columnWidth : 0.25","labelWidth":"100","store":"app.windows","displayField":"LEDGER_NAME","valueField":"LEDGER_ID","emptyText":"{#selectInfo1#}","labelAlign":"right","itemId":"ledgers_com","fieldLabel":"{#LEDGER_NAME#}","editable":"false"},"events":{"change":"ledgerId = newValue;\napp.no_ledgers_com.setValue(newValue);\napp.no_dept_com.reset();\napp.no_project_com.reset();\napp.no_searchButton.fireEvent('click');","select":"app.searchButton.fireEvent('click');","specialkey":"if(Ext.EventObject.getKey()==13){\n\tapp.searchButton.fireEvent('click');\n}"},"children":[{"configs":{"pageSize":"-1","autoLoad":"true","itemId":"store","url":"m?xwl=xc/com-qry/gl-ledgers/select-sec-fd-ledgers"},"children":[],"expanded":false,"type":"store"}],"expanded":true,"type":"combo"},{"configs":{"tagConfigs":"columnWidth : 0.25","labelWidth":"100","labelAlign":"right","itemId":"cat_code","fieldLabel":"{#EX_DOC_CODE#}"},"events":{"change":"if(text.getValue() === ''){\n    app.searchButton.fireEvent('click');\n}","specialkey":"if(Ext.EventObject.getKey()==13){\n\tapp.searchButton.fireEvent('click');\n}"},"children":[],"expanded":false,"type":"text"},{"configs":{"tagConfigs":"columnWidth : 0.16","labelWidth":"100","labelAlign":"right","itemId":"users","fieldLabel":"{#CLAIMSPEOPER#}"},"events":{"change":"if(text.getValue() === ''){\n    app.searchButton.fireEvent('click');\n}","specialkey":"if(Ext.EventObject.getKey()==13){\n\tapp.searchButton.fireEvent('click');\n}"},"children":[],"expanded":false,"type":"text"}],"expanded":true,"type":"panel"},{"configs":{"tagConfigs":"baseCls : 'my-panel-no-border'","layout":"column","margin":"10 0 10 0","border":"false","itemId":"row2"},"children":[{"configs":{"tagConfigs":"columnWidth : 0.25","labelWidth":"100","labelAlign":"right","itemId":"dept_com","fieldLabel":"{#DEPT_NAME#}"},"events":{"change":"if(text.getValue() === ''){\n    app.searchButton.fireEvent('click');\n}","specialkey":"if(Ext.EventObject.getKey()==13){\n\tapp.searchButton.fireEvent('click');\n}"},"children":[],"expanded":false,"type":"text"},{"configs":{"tagConfigs":"columnWidth : 0.25","labelWidth":"100","labelAlign":"right","itemId":"project_com","fieldLabel":"{#PROJECT_NAME#}"},"events":{"change":"if(text.getValue() === ''){\n    app.searchButton.fireEvent('click');\n}","specialkey":"if(Ext.EventObject.getKey()==13){\n\tapp.searchButton.fireEvent('click');\n}"},"children":[],"expanded":true,"type":"text"},{"configs":{"tagConfigs":"columnWidth : 0.08","text":"{#queryBtn#}","margin":"0 0 0 20","itemId":"searchButton","iconCls":"seek_icon"},"events":{"click":"var params = {\n    LEDGER_ID : ledgerId,\n\tDEPT_ID : Ext.String.escape(app.dept_com.getValue()),\n\tPROJECT_ID : Ext.String.escape(app.project_com.getValue()),\n    EX_DOC_CODE : Ext.String.escape(app.cat_code.getValue()),\n    CREATED_BY : Ext.String.escape(app.users.getValue())\n};\napp.chk_docs_grid.store.load({params : params});//查询（重新加载数据）"},"children":[],"expanded":false,"type":"button"},{"configs":{"tagConfigs":"columnWidth : 0.08","text":"{#clearBtn#}","margin":"0 0 0 20","itemId":"resetButton","iconCls":"refresh_icon"},"events":{"click":"app.search_form.getForm().reset();\napp.searchButton.fireEvent('click');\napp.no_search_form.getForm().reset();\napp.no_searchButton.fireEvent('click');"},"children":[],"expanded":false,"type":"button"}],"expanded":true,"type":"panel"}],"expanded":false,"type":"form"},{"configs":{"region":"center","multiSelect":"true","selType":"rowmodel","columns":"app.chk_docs_columns","border":"false","itemId":"chk_docs_grid"},"events":{"itemdblclick":"app.reviewDetailsButton.fireEvent('click');"},"children":[{"configs":{"autoLoad":"true","itemId":"store","url":"m?xwl=xc/ex/biz/ex-chk-docs/ex-chk-docsDB/ex-chk-docsSelectY"},"children":[],"expanded":false,"type":"store"},{"configs":{"itemId":"tbar"},"children":[{"configs":{"text":"{#reviewDetailsButton#}","itemId":"reviewDetailsButton","iconCls":"preview_icon"},"events":{"click":"var rec = app.chk_docs_grid.getSelection();//选择记录\nif(app.ledgers_com.getValue() === '' || app.ledgers_com.getValue() === null){\n    Wb.toast('{#reviewRec1#}') ;\n    return;\n}\nif (rec.length > 1 || rec.length === 0) {//大于一条或没选择会警告\n    Wb.toast('{#seekRec1#}') ;\n    return;\n}\nelse{\n    var r = rec[0].data;\n    Wb.run({\n        url : 'm?xwl=xc/ex/biz/ex-chk-docs/review-window',\n        params :{\n          'headId' : r.V_HEAD_ID \n        },\n        success : function(appObj){\n            appObj.initWindow({\n                loadGridData : function(){\n                    app.no_searchButton.fireEvent('click') ;\n                },\n                ledgerId :\tledgerId,\t\t//账簿\n                exDocId :\tr.EX_DOC_ID,\t//费用单据ID\n                exDocCode :\tr.EX_DOC_CODE,\t//费用单据编码\n                amount :\tr.AMOUNT,\t\t//单据金额\n                cancelAmt :\tr.CANCEL_AMT,\t//核销金额\n                exCatCode : r.EX_CAT_CODE,\t//单据类型\n                payMethod : r.PAY_METHOD,\t//支付方式\n                payType :\tr.PAY_TYPE,\t\t//支付类型\n                payId :\t\tr.EX_PAY_ID ,\t//支付单ID\n                finDate :\tr.FIN_DATE ,\t//复核日期\n                vHeadId :\tr.V_HEAD_ID,\t//凭证头ID\n                vStatus :\tr.V_STATUS,\t\t//凭证状态\n                docFormUrl : r.PC_A_FORM_URL ,\n                createdBy : r.CREATED_BY\t//凭证创建人\n            });\n        }\n    });\n}"},"children":[],"expanded":false,"type":"button"},{"configs":{"text":"{#cancelReviewButton#}","itemId":"cancelReviewButton","iconCls":"cancel_icon"},"events":{"click":"// TODO: 获取选中记录\nvar rows = app.chk_docs_grid.getSelection();\n\nif(rows.length === 0){\n  Wb.toast('{#cancelReviewRec1#}') ;\n  return false ;\n}else{\n  // TODO: 进度条\n  var msg = Ext.MessageBox.show({\n    title:'{#progress1#}',\n    msg:'{#progress2#}',\n    width:240,\n    wait:true,\n    progress :true,\n    closable :false\n  });\n  \n  // 单据ID数组\n  var docArray = [] ;\n  var rr ;\n  var i = 0 ;\n  Wb.each(rows , function(r){\n    var docId = r.data.EX_DOC_ID ; // 单据ID\n    var catCode = r.data.EX_CAT_CODE ;\n    if(catCode == 'EX02'){ // 借款单\n      i++ ;\n      rr = r ;\n    }\n    var paramJson = {'EX_DOC_ID' : docId,'EX_CAT_CODE' : catCode} ;\n    docArray.push(paramJson) ;\n  }) ;\n  // 如果存在借款单,则不允许取消\n  if(i>0){\n    msg.hide() ;\n    Wb.toast(\"{#cancelReviewRec2#}【\"+rr.data.EX_DOC_CODE+\"】{#cancelReviewRec3#}\") ;\n    return false ;\n  }\n  \n  // TODO: 提交请求执行取消复核处理\n  Wb.request({\n    url: '{#contextPath#}'+'/exCheckAndPayAction.do?method=uncheckEXDoc',\n    timeout : 3600000 ,\n    params: {\n      'params' : Wb.encode(docArray)\n    },\n    success: function(resp) {\n      msg.hide();\n      var response = Wb.decode(resp.responseText) ;\n      if(response.flag === \"0\"){\n        app.searchButton.fireEvent('click') ;\n        app.no_searchButton.fireEvent('click');\n      }\n      Wb.info(response.msg) ;    \n    }\n  });\n}\n\n"},"children":[],"expanded":false,"type":"button"},{"configs":{"text":"{#createPaymentButton#}","itemId":"createPaymentButton","iconCls":"file_add_icon"},"events":{"click":"// TODO: 账簿是否合法\nvar ledgerId = app.ledgers_com.getValue() ;\t\nif(ledgerId === '' || ledgerId === null || ledgerId === undefined){\n    Wb.toast('{#reviewRec1#}') ;\n    return false;\n}\n\n// TODO: 所选挂账报销单\nvar rows = app.chk_docs_grid.getSelection();\nif (rows.length === 0) {\n  Wb.toast('{#createPaymentRec1#}') ;\n  return false;\n}else{\n  // 校验数据合法性\n  var i =0 ;\n  var rr ;\n  var payAmt = 0 ; \n  Wb.each(rows,function(r){\n    var payMethod = r.data.PAY_METHOD ;   // 支付方式\n    var payId = r.data.EX_PAY_ID ;        // 支付单ID\n    var docCode = r.data.EX_DOC_CODE ;    // 报销单编码\n    var totalAmt = r.data.AMOUNT ;\n    var cancelAmt = r.data.CANCEL_AMT ;\n    payAmt += (parseInt(totalAmt)-parseInt(cancelAmt)) ;\n    \n    if(payId !== \"\" && payId !== null && payId !== undefined){\n      i++ ;\n      rr = r ;\n    }   \n  }) ;\n  \n  if(i>0){\n    Wb.toast('{#createPaymentRec2#}<font color=red>【'+rr.data.EX_DOC_CODE+'】<\/font>{#createPaymentRec3#}');\n    return ;\n  }\n  \n  // TODO: 进入付款单编辑界面\n  Wb.run({\n    url : 'm?xwl=xc/ex/biz/ex-pay-docs/ex-pay-docs-common',\n    params : {\n      'opType' : 'add',\n      'payId'  : '',\n      'headId' : '',\n      'amount' : payAmt\n    },\n    success :function(appObj){\n      appObj.initWindow({\n        pageMode : 'chk',\n        title : '{#title1#}',\n        headId : '',\n        payId : '',\n        ledgerId : ledgerId,\n        selArray : Wb.encode(Wb.getData(rows)) \n      });\n    }\n  });\n}\n \n"},"children":[],"expanded":false,"type":"button"},{"configs":{"text":"{#viewDocButton#}","itemId":"viewDocButton","iconCls":"preview_icon"},"events":{"click":"// TODO: 选择记录\nvar rec = app.chk_docs_grid.getSelection();\n\n// TODO: 一次查看一张单据凭证信息\nif(rec.length > 1 || rec.length === 0){\n  Wb.toast('{#seekRec2#}') ;\n  return false ;\n}\n\n// TODO: 凭证头ID\nvar headId = rec[0].data.V_HEAD_ID ;\nvar ledgerId = app.ledgers_com.getValue() ;\n\n// TODO: 凭证查看\nWb.run({\n\turl:'m?xwl=xc/gl/journal/v-windows/view-voucher-win',\n\tparams : {\n        'op'     : 'view',\n        'vt'     : 'normal',\n        'headId' : headId\n\t},\n\tsuccess:function(appObj){\n      appObj.initWindow({\n        title : '{#title2#}',\n        ledgerId : ledgerId\n      });\n\t}\n});"},"children":[],"expanded":false,"type":"button"},{"configs":{"text":"{#printDocButton#}","itemId":"printDocButton","iconCls":"printer_icon"},"events":{"click":"// TODO: 获得选中数据\nvar rows = app.chk_docs_grid.getSelection();\n\n// TODO: 选择单据 \nif(rows.length === 0 || rows.length >1){\n  Wb.toast('{#printDoc#}') ;\n  return false ;\n  \n}else{\n  var r = rows[0].data ;\n  \n  var docId = r.EX_DOC_ID ;\n  var catName = r.EX_CAT_AME ;\n  var formUrl = r.PC_P_FORM_URL ;\n  var taskTab = r.TASK_TAB ;\n  \n  // 判断单据类型是否绑定打印表单\n  if(formUrl === null || formUrl === \"\" || formUrl === undefined || formUrl === \"/\"){\n    Wb.toast(catName+'未绑定电脑端打印表单,请确认!') ;\n    return false ;\n  }else{\n    // 打开打印界面\n    app.printDocWin.show() ;\n    document.getElementById('exDocPrintFormUrl').src = '{#appIP#}'+formUrl+\"&exDocId=\"+docId+\"&tab=\"+taskTab ;\n  }  \n}"},"children":[],"expanded":false,"type":"button"},{"configs":{"text":"{#annexButton#}","itemId":"annexButton","iconCls":"attach_icon"},"events":{"click":"// TODO: 获得选中数据\nvar rows = app.chk_docs_grid.getSelection();\n\n// TODO: 选择单据 \nif(rows.length === 0){\n  Wb.toast('{#annexRec1#}') ;\n  return false ;\n  \n}else if(rows.length >1){\n  Wb.toast('{#annexRec1#}') ;\n  return false ;  \n  \n}else{\n  // 账簿ID和单据类型\n  var ledgerId = rows[0].data.LEDGER_ID ;\n  var docCat = rows[0].data.EX_CAT_CODE ;\n  \n  // 获取附件分类\n  Wb.request({\n    url: '{#contextPath#}'+'/exDocsAction.do?method=getAttCatCode',\n    params: {\n      'ledgerId' : ledgerId,\n      'docCat'   : docCat\n    },\n    success: function(resp) {\n      var response = Wb.decode(resp.responseText) ;\n      if(response.flag == \"0\"){\n        // 附件分类码\n        var att_cat_code = response.attCat ;\n        // 上传附件\n        Xip.showAttachmentManager('{#XIP.userId#}',rows[0].data.EX_DOC_ID,'',att_cat_code,rows[0].data.EX_DOC_CODE,'Y','Y','Y',function(){},2);    \n        \n      }else{\n        Wb.info(response.msg) ;\n      }\n    }\n  });   \n}"},"children":[],"expanded":false,"type":"button"}],"expanded":true,"type":"toolbar"}],"expanded":true,"type":"grid"}],"expanded":true,"type":"panel"}],"expanded":true,"type":"tab"}],"expanded":true,"type":"viewport"}],"expanded":true,"type":"module"}],"pageLink":"","iconCls":"grid_icon"}