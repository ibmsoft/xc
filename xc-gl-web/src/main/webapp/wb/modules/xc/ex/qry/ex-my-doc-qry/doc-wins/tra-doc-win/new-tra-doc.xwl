{"inframe":false,"title":"新建或修改差旅报销单","hidden":false,"roles":{"default":1},"children":[{"configs":{"loginRequired":"false","jsLinks":"[\"xip/js/xipWf.js\"]","serverScript":"//---------------------获取当前模块语言对应的.json文件，放到request中----------------\ncom.xzsoft.xip.platform.util.XipUtil.getCurrentLang(request,\"xc/ex/qry/ex-my-doc-qry/doc-wins/json/ex-doc-win\");\n// TODO: 单据ID\nvar exDocId = request.getParameter(\"exDocId\") ;\nrequest.setAttribute(\"exDocId\", exDocId) ;\n\n// TODO: 操作模式: add-新增, edit-编辑, copy-复制\nvar opMode = request.getParameter(\"opMode\") ;\nrequest.setAttribute(\"opMode\", opMode) ;\n\n// TODO: 角色模式：admin-财务管理员模式，其他-普通员工模式\nvar roleMode = request.getParameter(\"roleMode\") ;\nrequest.setAttribute(\"roleMode\", roleMode) ;\n\n// TODO: 接入页面类型：single-单据填报页面 , list-单据列表页面\nvar accessPage = request.getParameter(\"accessPage\") ;\nrequest.setAttribute(\"accessPage\", accessPage) ;\n\n// TODO: 如果单据ID存在, 则更新单据信息 ; 否则为新增单据信息\nif(exDocId !== null && exDocId !== \"\" && exDocId !== undefined){\n  var docJson = com.xzsoft.xc.ex.util.XCEXWebBuilderUtil.getExDocById(exDocId) ;\n  request.setAttribute(\"docJSON\", docJson) ;\n}\n\n// TODO: 根目录\nrequest.setAttribute(\"ctxPath\", request.getContextPath()) ;\n\n// TODO: 访问路径\nvar protocol = request.getProtocol() ;\nvar ipAddr = request.getServerName();\nvar port = request.getServerPort() ;\nvar ctxPath = request.getContextPath() ;\nvar pp = protocol.substr(0,5) ;\nprotocol = (pp.indexOf(\"https\") == -1 ? \"http\" : \"https\") ;\nvar url = protocol + \"://\" + ipAddr +\":\" + port + ctxPath ;\nrequest.setAttribute(\"appIP\",url);","itemId":"module"},"events":{"initialize":"// TODO: 定义窗口对象\nExt.apply(app,{\n  initWindow:function(params){\n    Ext.apply(app, params);    \n    app.newWin.show() ;\n  }\n});\n\n// TODO: 流程提交处理\nfunction submitDoc(response){\n  \n  // TODO: 取得流程编码、电脑端审批表单和移动端审批表单\n  var processCode = response.PROCESS_CODE ;\n  var pcApproveForm = response.PC_A_FORM_URL ;\n  var mobileApproveForm = response.M_A_FORM_URL ;\n\n  // 电脑端和移动端审批表单为变量需要设置为全路径\n  pcApproveForm = '{#appIP#}' +  pcApproveForm ;\n  mobileApproveForm = '{#appIP#}' +  mobileApproveForm ;\n\n  // TODO: 如果流程编码存在, 则提交流程审批处理\n  if(processCode !== \"\" && processCode !== null && processCode !== undefined){\n\n    // 如果项目未指定，则设置默认值为 \"-1\"\n    var prjId = app.PROJECT_ID.getValue() ;\n    if(prjId === null || prjId === \"\" || prjId === undefined){\n      prjId = \"-1\" ;\n    }\n\n    // 流程业务实体属性赋值\n    var json = {\n      'AMT'          : app.AMOUNT.getValue(),\n      'APP_IP'       : '{#appIP#}',\n      'DEPT_ID'      : app.DEPT_ID.getValue() ,\n      'DEPT_NAME'    : app.DEPT_NAME.getValue(),\n      'EMP_ID'       : '{#XIP.empId#}',\n      'EX_CAT_NAME'  : '{#tra-title#}',\n      'loginName'    : '{#XIP.userName#}',\n      'M_A_FORM'     : mobileApproveForm,\n      'ORG_ID'       : app.ORG_ID.getValue(),\n      'PC_A_FORM'    : pcApproveForm,\n      'PROJECT_ID'   : prjId,\n      'e_business_id': app.EX_DOC_ID.getValue(),\n      'billType'     : 'EX03',\n      'ledgerId'     : app.LEDGER_ID.getValue(),\n      'APPLY_DOC_ID' : app.APPLY_EX_DOC_ID.getValue()  \n    } ;      \n\n    // 操作模式：add-新增, edit-编辑, copy-复制\n    var opmode = '{#opMode#}' ;\n    if(opmode === 'add' || opmode === 'copy'){ // 新增或复制模式\n\n      var accessPage = '{#accessPage#}' ;\t// 接入页面类型：single-单据填报 , list-单据列表\n      XipWf.startAndSubmitByProcess(processCode,json,function(e){\n        if(e.flag === 0){\n          // 置灰按钮\n          app.saveBtn.disable();\n          app.submitBtn.disable() ;\n          \n          Wb.toast('{#submitInfo1#}'); \n          app.INS_CODE.setValue(e.instanceCode) ;\n          if(accessPage == 'list' && typeof app.loadDocGrid == 'function'){\n            app.loadDocGrid();\n          }\n        }else{\n          Wb.toast(e.msg) ;\n        }\n      });  \n      \n    }else if(opmode === 'edit'){ // 编辑模式   \n      var _auditStatus = app.AUDIT_STATUS.getValue() ;\n      var _insCode = app.INS_CODE.getValue();\n      if(_auditStatus === 'A'){\n        XipWf.startAndSubmitByProcess(processCode,json,function(e){\n          if(e.flag === 0){\n            // 置灰按钮\n            app.saveBtn.disable();\n            app.submitBtn.disable() ;\n            \n            Wb.toast('{#submitInfo1#}'); \n            app.INS_CODE.setValue(e.instanceCode) ;\n            if(typeof app.loadDocGrid == 'function'){\n              app.loadDocGrid();\n            }\n          }else{\n            Wb.toast(e.msg) ;\n          }\n        });      \n        \n      }else if(_auditStatus === 'D'){\n        // 驳回 -> 按流程实例提交流程\n        XipWf.submitInstance(_insCode,json,function(e){\n          if(e.flag === 0){\n            // 置灰按钮\n            app.saveBtn.disable();\n            app.submitBtn.disable() ;\n            \n            Wb.toast('{#submitInfo1#}'); \n            app.INS_CODE.setValue(e.instanceCode) ;\n            if(typeof app.loadDocGrid == 'function'){\n              app.loadDocGrid();\n            }\n          }else{\n            Wb.toast(e.msg);\n          }\n        },null);\n        \n      }else if(_auditStatus === 'R'){\n        // 撤回 -> 按流程实例启动并提交流程\n        XipWf.restartAndSubmitByProcess(_insCode,processCode,json,function(e){\n          if(e.flag === 0){\n            // 置灰按钮\n            app.saveBtn.disable();\n            app.submitBtn.disable() ;\n            \n            Wb.toast('{#submitInfo1#}'); \n            app.INS_CODE.setValue(e.instanceCode) ;\n            if(typeof app.loadDocGrid == 'function'){\n              app.loadDocGrid();\n            }\n          }else{\n            Wb.toast(e.msg);\n          }\n        },null);\n      }     \n    }\n\n  }else{\n    Wb.toast('{#submitInfo5#}'); \n  }  \n}"},"children":[{"configs":{"footerScript":"/**\nname:treeNodeQuery(实现树的模糊查找)\ndesc:根据名称查询节点在树中的位置\nparams:text(节点名称)\nparams:by(依据字段<树查询默认为'text'>)\nparams:treeId(树的ID)\n*/\nfunction treeNodeQuery(text,by,treeId) { \n \n  if(Ext.isEmpty(by))\n    by = 'text';\n  var menuFunTree = treeId;\n  menuFunTree.expandAll(function(){\n      var view = menuFunTree.getView(),\n      me = menuFunTree,\n      nodesAndParents = [];\n  menuFunTree.getRootNode().cascadeBy(function(tree, view) {\n        var uiNode = view.getNodeByRecord(this);\n        if (uiNode) {\n            Ext.get(uiNode).setDisplayed('table-row');\n        }\n    }, null, [menuFunTree, view]);\n    //添加匹配的节点和他们的父节点到nodesAndParents数组.\n    menuFunTree.getRootNode().cascadeBy(function(tree, view) {\n      var currNode = this;\n      if (currNode && currNode.data[by] && currNode.data[by].toString().toLowerCase().indexOf(text.toLowerCase()) > -1) {\n             menuFunTree.expandPath(currNode.getPath());\n             while (currNode.parentNode) {\n                nodesAndParents.push(currNode.id);\n                currNode = currNode.parentNode;\n            }\n        }\n    }, null, [menuFunTree, view]);\n    // 将不在nodesAndParents数组中的节点隐藏\n    // 将根节点放在显示数组中\n    nodesAndParents.push(menuFunTree.getRootNode().id);\n    menuFunTree.getRootNode().cascadeBy(function(tree, view){\n        var uiNode = view.getNodeByRecord(this);\n        if (uiNode && !Ext.Array.contains(nodesAndParents, this.id)) {\n            Ext.get(uiNode).setDisplayed('none');\n        }\n    }, null, [menuFunTree, view]);\n  });\n}\n","itemId":"querytreefun"},"children":[],"expanded":false,"type":"clientscript"},{"configs":{"maximized":"true","autoShow":"true","height":"document.body.clientHeight*0.7","width":"document.body.clientWidth*0.8","layout":"border","itemId":"newWin","modal":"true","maximizable":"true"},"events":{"beforeshow":"// TODO: 操作模式：add-新增, edit-编辑, copy-复制\nvar opMode = '{#opMode#}' ;\n\nif(opMode === 'add'){  \n  app.CREATED_BY.setValue('{#XIP.userId#}') ;\n  app.CREATED_BY_NAME.setValue('{#XIP.empName#}') ;\n  app.EX_CAT_CODE.setValue('EX03') ;\n  app.BIZ_DATE.setValue(new Date()) ;\n  app.INS_CODE.setValue() ;\n  app.AUDIT_STATUS.setValue('A') ;\n  \n}else if(opMode === 'edit'){  \n  var dataJson = Wb.decode('{#docJSON#}') ;\n  Wb.setValue(app.form, dataJson) ;\n  // TODO: 设置业务日期\n  var bizDate = dataJson.BIZ_DATE ;\n  app.BIZ_DATE.setValue(Wb.strToDate(bizDate));\n  app.grid1.getStore().load() ;\n  // 按钮不可编辑(如果当前角色模式非财务模式且单据已在审批中或审批通过则不允许再编辑)\n  var roleMode = '{#roleMode#}' ;\n  if(roleMode === 'admin'){\n    app.saveBtn.hide() ;\n    app.submitBtn.hide() ;\n    app.addNextBtn.hide() ;\n    app.saveAndChkBG.show() ;\n    app.LEDGER_ID.disable() ;\n  }else{\n    if(dataJson.AUDIT_STATUS === 'C' || dataJson.AUDIT_STATUS === 'E'){\n      app.saveBtn.disable() ;\n      app.submitBtn.disable() ;\n    }\n  }\n  // 计算借款余额\n  Wb.request({\n    url   : '{#ctxPath#}/borrowMoneyAction.do?method=getUserImprest',\n    async : false,\n    params: {\n      'ledgerId' : dataJson.LEDGER_ID,\n      'userId'   : dataJson.CREATED_BY\n    },\n    success:function(resp){\n      var obj = Wb.decode(resp.responseText);\n      if(!Ext.isEmpty(obj)){\n        Wb.setValue(app.LEND_AMT,{'LEND_AMT':obj.iaBal}) ;\n      }\n    }\n  });\n  \n}else if(opMode === 'copy'){  \n  var dataJson = Wb.decode('{#docJSON#}') ;\n  Wb.setValue(app.form,dataJson) ;\n  app.BIZ_DATE.setValue(new Date()) ;\n  \n  var store = app.grid1.getStore() ;\n  store.load({\n    callback : function(){\n      if(store.getCount() > 0){\n        for(var i=0; i<store.getCount(); i++){\n          var r = store.getAt(i) ;\n          r.set('EX_DTL_ID','') ;\n          r.set('EX_DOC_ID','') ;\n        }\n      }\n    }\n  }) ;\n  // 计算借款余额\n  Wb.request({\n    url   : '{#ctxPath#}/borrowMoneyAction.do?method=getUserImprest',\n    async : false,\n    params: {\n      'ledgerId' : dataJson.LEDGER_ID,\n      'userId'   : dataJson.CREATED_BY\n    },\n    success:function(resp){\n      var obj = Wb.decode(resp.responseText);\n      if(!Ext.isEmpty(obj)){\n        Wb.setValue(app.LEND_AMT,{'LEND_AMT':obj.iaBal}) ;\n      }\n    }\n  }); \n  // 清空相关数据\n  app.APPLY_EX_DOC_ID.setValue() ;\n  app.APPLY_EX_DOC_CODE.setValue() ;\n  app.EX_DOC_CODE.setValue() ;\n  app.EX_DOC_ID.setValue() ;\n  app.AUDIT_STATUS.setValue('A') ;\n  app.INS_CODE.setValue() ;\n\n}else{\n  \n}","close":"// TODO: 接入页面类型：single-单据填报页面 , list-单据列表页面\nvar accPage = '{#accessPage#}' ;\nif(accPage == 'single'){\n  var win = window;\n  while(win != win.parent){\n    win = win.parent;\n  }\n  var tabPanel = win.app.funTabPanel;\n  //获取当前激活页签\n  var actTab = tabPanel.activeTab;\n  //关闭页签\n  tabPanel.remove(actTab);  \n}"},"children":[{"configs":{"region":"north","border":"false","itemId":"form"},"children":[{"configs":{"itemId":"tbar"},"children":[{"configs":{"text":"{#saveBtn#}","itemId":"saveBtn","iconCls":"save_icon"},"events":{"click":"// TODO: 校验数据\nvar ledgerId = app.LEDGER_ID.getValue() ;\nvar bizDate = app.BIZ_DATE.getValue() ;\nvar deptId = app.DEPT_ID.getValue() ;\nvar exReason = app.EX_REASON.getValue() ;\nvar totalAmt = app.AMOUNT.getValue() ;\nvar lendAmt = app.LEND_AMT.getValue() ;\nvar cancelAmt = app.CANCEL_AMT.getValue() ;\nif(ledgerId === \"\" || ledgerId === null || ledgerId === undefined){\n  Wb.toast(\"{#saveInfo1#}\") ;\n  return false ;\n}\nif(bizDate === \"\" || bizDate === null || bizDate === undefined){\n  Wb.toast(\"{#saveInfo2#}\") ;\n  return false ;  \n}\nif(deptId === \"\" || deptId === null || deptId === undefined){\n  Wb.toast(\"{#saveInfo3#}\") ;\n  return false ;  \n}\nif(exReason === \"\" || exReason === null || exReason === undefined){\n  Wb.toast(\"{#saveInfo13#}\") ;\n  return false ;  \n}\nif(cancelAmt === \"\" || cancelAmt === null || cancelAmt === undefined){\n  Wb.toast(\"{#saveInfo14#}\") ;\n  return false ;\n}\n// 核销金额是否合法\nif(Number(cancelAmt) > Number(lendAmt)){\n  Wb.toast(\"{#saveInfo15#}\") ;\n  app.CANCEL_AMT.setValue(lendAmt) ;\n  return false ;\n}\nif(Number(cancelAmt) > Number(totalAmt)){\n  Wb.toast(\"{#saveInfo16#}\") ;\n  app.CANCEL_AMT.setValue(totalAmt) ;\n  return false ;\n}\n\n// 判读是否存在明细行\nvar totalDtls = app.grid1.getStore().getCount() ;\nif(totalDtls === 0){\n  Wb.toast(\"{#saveInfo17#}\") ;\n  return false ;\n}\n\n// TODO: 进度条\nvar msg = Ext.MessageBox.show({\n  title:'{#progress1#}',\n  msg:'{#progress2#}',\n  width:240,\n  wait:true,\n  progress :true,\n  closable :false\n});\n\n// 获取表单数据并删除picker信息\nvar paramJson = Wb.getValue(app.form) ;\ndelete paramJson.pickComp ;\n\n// TODO: 提交请求处理\nWb.request({\n  url: '{#ctxPath#}'+'/exDocsAction.do?method=saveOrUpdateDoc',\n  timeout : 3600000,\n  params: {\n    'infoJson'  : Wb.encode(paramJson),\n    'lineArray' : Wb.encode(Wb.getData(app.grid1)) \n  },\n  success: function(resp) {\n    msg.hide() ;\n    var response = Wb.decode(resp.responseText) ;\n    Wb.toast(response.msg) ;\n    if(response.flag == \"0\"){\n      // 设置单据ID和编号\n      app.EX_DOC_ID.setValue(response.docId) ;\n      app.EX_DOC_CODE.setValue(response.docCode) ;\n      // 加载单据明细\n      app.grid1.getStore().load() ;\n      // 加载单据列表\n      if(typeof app.loadDocGrid == 'function'){\n        app.loadDocGrid();\n      }\n    }else{\n      return ;\n    }\n  }\n});"},"children":[],"expanded":false,"type":"button"},{"configs":{"text":"{#submitBtn#}","itemId":"submitBtn","iconCls":"ok_icon"},"events":{"click":"// 保存表单数据\napp.saveBtn.fireEvent('click') ;\n\n// 账簿是否启用预算检查\nvar store = app.LEDGER_ID.getStore();\nvar idx = store.find('LEDGER_ID',app.LEDGER_ID.getValue()) ;\nvar rr = store.getAt(idx) ;\nvar BG_IS_CHK = rr.data.BG_IS_CHK ;\nif(BG_IS_CHK === \"\" || BG_IS_CHK === null || BG_IS_CHK === undefined){\n  BG_IS_CHK = 'N' ;\n}\n\n// 根据费用单据类型获取审批流程和审批表单信息\nWb.request({\n  url    : '{#ctxPath#}'+'/exDocsAction.do?method=getProcAndFormsByCat',\n  async  : true,\n  timeout: 3600000,\n  params : {\n    'ledgerId' : app.LEDGER_ID.getValue(),\n    'docCat'   : 'EX03',\n    'isChkBg'  : BG_IS_CHK,\n    'exDocId'  : app.EX_DOC_ID.getValue()\n  },\n  success: function(resp) {\n    var response = Wb.decode(resp.responseText) ;\n    if(response.flag == \"0\"){\n        // 执行阶段：BGCHK-预算校验,QRY-单据类型信息查询\n        var phase = response.phase ;\n        if(phase === 'BGCHK'){\n          // -1 校验不通过或者校验异常；0 校验通过；1校验不通过，但预算不是绝对控制，给出警告提示    \n          var chkFlag = response.chkFlag ;\n          if(chkFlag === \"-1\"){\n              Wb.info(response.msg) ;\n              return ;\n          }else if(chkFlag === \"1\"){\n              Ext.Msg.confirm('{#warning1#}',response.msg,function(id){\n                if(id=='yes'){\n                  submitDoc(response) ;\n                }\n              });\n          }\n        }else{\n          submitDoc(response) ;\n        }\n    }else{\n        Wb.toast(response.msg) ;\n    }\n  }\n});\n"},"children":[],"expanded":false,"type":"button"},{"configs":{"text":"{#saveBtn#}","hidden":"true","itemId":"saveAndChkBG","iconCls":"save_icon"},"events":{"click":"// TODO: 校验数据\nvar ledgerId = app.LEDGER_ID.getValue() ;\nvar bizDate = app.BIZ_DATE.getValue() ;\nvar deptId = app.DEPT_ID.getValue() ;\nvar exReason = app.EX_REASON.getValue() ;\nvar totalAmt = app.AMOUNT.getValue() ;\nvar lendAmt = app.LEND_AMT.getValue() ;\nvar cancelAmt = app.CANCEL_AMT.getValue() ;\nif(ledgerId === \"\" || ledgerId === null || ledgerId === undefined){\n  Wb.toast(\"{#saveInfo1#}\") ;\n  return false ;\n}\nif(bizDate === \"\" || bizDate === null || bizDate === undefined){\n  Wb.toast(\"{#saveInfo2#}\") ;\n  return false ;  \n}\nif(deptId === \"\" || deptId === null || deptId === undefined){\n  Wb.toast(\"{#saveInfo3#}\") ;\n  return false ;  \n}\nif(exReason === \"\" || exReason === null || exReason === undefined){\n  Wb.toast(\"{#saveInfo13#}\") ;\n  return false ;  \n}\nif(cancelAmt === \"\" || cancelAmt === null || cancelAmt === undefined){\n  Wb.toast(\"{#saveInfo14#}\") ;\n  return false ;\n}\n// 核销金额是否合法\nif(Number(cancelAmt) > Number(lendAmt)){\n  Wb.toast(\"{#saveInfo15#}\") ;\n  app.CANCEL_AMT.setValue(lendAmt) ;\n  return false ;\n}\nif(Number(cancelAmt) > Number(totalAmt)){\n  Wb.toast(\"{#saveInfo16#}\") ;\n  app.CANCEL_AMT.setValue(totalAmt) ;\n  return false ;\n}\n\n// 判读是否存在明细行\nvar totalDtls = app.grid1.getStore().getCount() ;\nif(totalDtls === 0){\n  Wb.toast(\"{#saveInfo17#}\") ;\n  return false ;\n}\n\n// TODO: 进度条\nvar msg = Ext.MessageBox.show({\n  title:'{#progress1#}',\n  msg:'{#progress2#}',\n  width:240,\n  wait:true,\n  progress :true,\n  closable :false\n});\n\n// 获取表单数据并删除picker信息\nvar paramJson = Wb.getValue(app.form) ;\nparamJson.ROLE_MODE = \"FIN\" ;\t// 角色模式：FIN-财务模式, 其他-普通模式\ndelete paramJson.pickComp ;  \n\n// 流程状态： 如果流程既不是审批中也不是审批通过状态, 则不用执行预算校验处理。\nvar BG_IS_CHK ;\nvar auditStatus = app.AUDIT_STATUS.getValue() ;\nif(auditStatus === 'C' || auditStatus === 'E'){\n  // 账簿是否启用预算检查\n  var store = app.LEDGER_ID.getStore();\n  var idx = store.find('LEDGER_ID',app.LEDGER_ID.getValue()) ;\n  var rr = store.getAt(idx) ;\n  BG_IS_CHK = rr.data.BG_IS_CHK ;\n  if(BG_IS_CHK === \"\" || BG_IS_CHK === null || BG_IS_CHK === undefined){\n    BG_IS_CHK = 'N' ;\n  }\n}else{\n  BG_IS_CHK = \"N\" ;\n}\n\n// TODO: 提交请求处理\nWb.request({\n  url : '{#ctxPath#}'+'/exDocsAction.do?method=checkBudgetAndUpdateDoc',\n  async : true,\n  params : {\n    'infoJson'  : Wb.encode(paramJson),\n    'lineArray' : Wb.encode(Wb.getData(app.grid1)) ,\n    'isChkBg'   : BG_IS_CHK,\n    'ingoreBgWarning' : 'N'  // 忽略预算警告\n  },\n  success: function(resp) {\n    msg.hide() ;\n    var response = Wb.decode(resp.responseText) ;\n    if(response.flag == \"0\"){\n      if(typeof app.loadDocGrid == 'function'){\n        app.loadDocGrid();\n      }\n      Wb.toast(response.msg) ;\n      \n    }else{\n      if(response.bgFlag == \"-1\"){ \n        // 预算校验不通过且绝对控制\n        Wb.info(response.msg) ;\n\n      }else if(response.bgFlag == \"1\"){ \n        // 预算校验不通过且预警控制\n        Ext.Msg.confirm('{#warning1#}',response.msg,function(id){\n          if(id=='yes'){\n            Wb.request({\n              url : '{#ctxPath#}'+'/exDocsAction.do?method=checkBudgetAndUpdateDoc',\n              async : true,\n              params : {\n                'infoJson'  : Wb.encode(paramJson),\n                'isChkBg'   : BG_IS_CHK,\n                'ingoreBgWarning' : 'Y'\n              },\n              success: function(resp) {\n                msg.hide() ;\n                var response = Wb.decode(resp.responseText) ;\n                if(response.flag == \"0\"){\n                  if(typeof app.loadDocGrid == 'function'){\n                    app.loadDocGrid();\n                  }\n                }\n                Wb.toast(response.msg) ;\n              }\n            });\n          }\n        });\n\n      }else{\n        Wb.info(response.msg) ;\n      }\n    }\n  }\n});\n"},"children":[],"expanded":false,"type":"button"},{"configs":{"text":"{#addAttchBtn#}","itemId":"addAttchBtn","iconCls":"attach_icon"},"events":{"click":"// 账簿\nvar _ledgerId = app.LEDGER_ID.getValue() ;\nif(_ledgerId === \"\" || _ledgerId === null || _ledgerId === undefined){\n  Wb.toast(\"{#saveInfo1#}\") ;\n  return false ;\n}\n// 单据ID和编码\nvar ex_doc_id = app.EX_DOC_ID.getValue() ;\nvar ex_doc_code = app.EX_CAT_CODE.getValue();\nif(ex_doc_id === null || ex_doc_id === \"\" || ex_doc_id === undefined){\n  Wb.toast(\"{#attchInfo1#}\") ;\n  return false ;\n}\n\n// 获取附件分类\t\nWb.request({\n  url : '{#ctxPath#}'+'/exDocsAction.do?method=getProcAndFormsByCat',\n  timeout : 3600000,\n  params: {\n    'ledgerId' : _ledgerId,\n    'docCat'   : \"EX03\"\n  },\n  success: function(resp) {\n    var response = Wb.decode(resp.responseText) ;\n    var attCat = response.ATT_CAT_CODE ;\n    if(response.flag === \"0\"){\n      if(attCat === null || attCat === \"\" || attCat === undefined){\n        Wb.toast(\"{#attchInfo2#}\") ;\n      }else{\n        // 挂载附件\n        Xip.showAttachmentManager('{#XIP.userId#}',ex_doc_id,'',attCat,ex_doc_code,'Y','Y','Y',function(){},2);\n      }\n    }else{\n      Wb.toast(response.msg) ;\n    }\n  }\n});\n"},"children":[],"expanded":false,"type":"button"},{"configs":{"text":"{#addNextBtn#}","itemId":"addNextBtn","iconCls":"save_all_icon"},"events":{"click":"// TODO: 新增下一个\nExt.Msg.confirm('{#prompt1#}','{#prompt2#}',function(id){\n  if(id=='yes'){\n      // 启用按钮\n      app.saveBtn.enable() ;\n      app.submitBtn.enable() ;\n      \n      // 清除表单数据\n      app.form.getForm().reset() ;\n\n      // 设置初始化数据\n      app.CREATED_BY.setValue('{#XIP.userId#}') ;\n      app.CREATED_BY_NAME.setValue('{#XIP.empName#}') ;\n      app.EX_CAT_CODE.setValue('EX03') ;\n      app.BIZ_DATE.setValue(new Date()) ;\n      app.AUDIT_STATUS.setValue('A') ;\n\n      // 加载账簿信息\n      app.LEDGER_ID.getStore().load() ;\n\n      // 清除表格数据\n      app.grid1.getStore().removeAll();\n\n      // 计算借款余额\n      var ldId = app.LEDGER_ID.getValue();\n      if(ldId !== null && ldId !== \"\" && ldId !== undefined){\n        Wb.request({\n          url   : '{#ctxPath#}/borrowMoneyAction.do?method=getUserImprest',\n          async : false,\n          params: {\n            'ledgerId' : ldId,\n            'userId'   : app.CREATED_BY.getValue()\n          },\n          success:function(resp){\n            var obj = Wb.decode(resp.responseText);\n            if(!Ext.isEmpty(obj)){\n              app.LEND_AMT.setValue(obj.iaBal) ;\n            }\n          }\n        });\n      }\n  }\n});\n"},"children":[],"expanded":false,"type":"button"}],"expanded":true,"type":"toolbar"},{"configs":{"region":"north","layout":"column","border":"false","itemId":"formPanel"},"children":[{"configs":{"height":"40","layout":"fit","columnWidth":"1","border":"false","itemId":"t_panel"},"children":[{"configs":{"style":"fontSize:20px","html":"<b>{#tra-title#}<\/b>","margin":"10 10 10 10","labelAlign":"center","itemId":"title"},"children":[],"expanded":false,"type":"label"}],"expanded":true,"type":"panel"},{"configs":{"height":"30","layout":"column","columnWidth":"1","border":"false","itemId":"tr1"},"children":[{"configs":{"tagConfigs":"columnWidth:0.3","labelWidth":"100","allowBlank":"false","displayField":"LEDGER_NAME","valueField":"LEDGER_ID","labelAlign":"right","itemId":"LEDGER_ID","fieldLabel":"<font color='red'>*<\/font>{#LEDGER_NAME#}"},"events":{"select":"// 获取当前选中记录\nvar r = records[0].data ;\n// 设置账簿\nvar ldId = r.LEDGER_ID ;\nWb.setValue(app.LEDGER_ID,{'LEDGER_ID':ldId}) ;\n// 设置组织\nvar orgId = r.ORG_ID ;\napp.ORG_ID.getStore().load() ;\nWb.setValue(app.ORG_ID,{'ORG_ID':orgId}) ;\n// 设置默认成本中心\nWb.request({\n  url: 'm?xwl=xc/ex/common-db/query/select-default-dept',\n  async:false,\n  params: {'orgId':orgId},\n  success: function(resp) {\n    var response = Wb.decode(resp.responseText) ;\n    var r = response.rows[0] ;\n    var _deptId = r.DEPT_ID ;\n    var _deptName = r.DEPT_NAME ;\n    Wb.setValue(app.DEPT_ID,{'DEPT_ID':_deptId}) ;\n    Wb.setValue(app.DEPT_NAME,{'DEPT_NAME':_deptName}) ;\n  }\n});\n// 计算借款余额\nWb.request({\n  url   : '{#ctxPath#}/borrowMoneyAction.do?method=getUserImprest',\n  async : false,\n  params: {\n    'ledgerId' : ldId,\n    'userId'   : app.CREATED_BY.getValue()\n  },\n  success:function(resp){\n    var obj = Wb.decode(resp.responseText);\n    if(!Ext.isEmpty(obj)){\n      Wb.setValue(app.LEND_AMT,{'LEND_AMT':obj.iaBal}) ;\n    }\n  }\n});"},"children":[{"configs":{"pageSize":"-1","itemId":"store","autoLoad":"true","url":"m?xwl=xc/com-qry/gl-ledgers/select-fd-ledgers-by-hr"},"events":{"success":"// TODO: 如果只存在一个账簿则设置为默认账簿\nvar exDocId = '{#exDocId#}' ;\nvar c1 = (exDocId=== \"\" || exDocId=== null || exDocId=== undefined) ;\n// 新增时处理默认值, 编辑时不处理\nif(store.getCount() == 1 && c1){ \n  var r = store.getAt(0) ;\n  // 设置账簿\n  var ldId = r.get('LEDGER_ID') ;\n  Wb.setValue(app.LEDGER_ID,{'LEDGER_ID':ldId}) ;\n  // 设置组织\n  var orgId = r.get('ORG_ID') ;\n  app.ORG_ID.getStore().load() ;\n  Wb.setValue(app.ORG_ID,{'ORG_ID':orgId}) ;\n  // 设置默认成本中心\n  Wb.request({\n    url: 'm?xwl=xc/ex/common-db/query/select-default-dept',\n    async:false,\n    params: {'orgId':orgId},\n    success: function(resp) {\n      var response = Wb.decode(resp.responseText) ;\n      var r = response.rows[0] ;\n      var _deptId = r.DEPT_ID ;\n      var _deptName = r.DEPT_NAME ;\n      Wb.setValue(app.DEPT_ID,{'DEPT_ID':_deptId}) ;\n      Wb.setValue(app.DEPT_NAME,{'DEPT_NAME':_deptName}) ;\n    }\n  });  \n  // 计算借款余额\n  Wb.request({\n    url   : '{#ctxPath#}/borrowMoneyAction.do?method=getUserImprest',\n    async : false,\n    params: {\n      'ledgerId' : ldId,\n      'userId'   : app.CREATED_BY.getValue() \n    },\n    success:function(resp){\n      var obj = Wb.decode(resp.responseText);\n      if(!Ext.isEmpty(obj)){\n        Wb.setValue(app.LEND_AMT,{'LEND_AMT':obj.iaBal}) ;\n      }\n    }\n  });\n}\n\n"},"children":[],"expanded":false,"type":"store"}],"expanded":true,"type":"combo"},{"configs":{"tagConfigs":"columnWidth:0.4","labelWidth":"100","readOnly":"true","displayField":"ORG_NAME","valueField":"ORG_ID","labelAlign":"right","itemId":"ORG_ID","fieldLabel":"{#ORG_NAME#}"},"children":[{"configs":{"itemId":"store","autoLoad":"true","url":"m?xwl=xc/ex/common-db/query/select-ld-org"},"events":{"beforeload":"store.proxy.extraParams.ledgerId = app.LEDGER_ID.getValue() ;"},"children":[],"expanded":false,"type":"store"}],"expanded":true,"type":"combo"},{"configs":{"tagConfigs":"columnWidth:0.3","labelWidth":"100","triggerCls":"x-form-search-trigger","margin":"0 10 0 0","labelAlign":"right","itemId":"APPLY_EX_DOC_CODE","fieldLabel":"{#APPLY_EX_DOC_CODE#}"},"children":[{"configs":{"tagConfigs":"{\n  minWidth:500\n}","height":"300","barPageButton":"false","barExportAllButtons":"false","barExportButtons":"false","barRefreshButton":"false","forceFit":"true","itemId":"pickComp"},"events":{"itemclick":"// TODO: 设置值申请单ID和申请单编号\nvar applyDocId = record.get('EX_DOC_ID') ;\nvar applyDocCode = record.get('EX_DOC_CODE') ;\nvar applyAmount = record.get('AMOUNT') ; // 申请金额\n\napp.APPLY_EX_DOC_ID.setValue(applyDocId) ;\napp.APPLY_EX_DOC_CODE.setValue(applyDocCode) ;\n\n// TODO: 设置报销金额的最大值\nif(applyAmount !== null && applyAmount !== \"\" && applyAmount !== undefined){\n  app.AMOUNT.setMaxValue(applyAmount) ;\n}\n\nvar picker = this.ownerCmp;\npicker.setValue(applyDocCode) ;\n\npicker.collapse();"},"children":[{"configs":{"autoLoad":"true","itemId":"store","url":"m?xwl=xc/ex/qry/ex-my-doc-qry/data/select-my-apply-docs"},"events":{"beforeload":"store.proxy.extraParams.ledgerId = app.LEDGER_ID.getValue();\nstore.proxy.extraParams.textStr = app.docCodeOrReason.getValue();"},"children":[],"expanded":false,"type":"store"},{"configs":{"itemId":"tbar"},"children":[{"configs":{"emptyText":"{#queryCodeOrName1#}","itemId":"docCodeOrReason"},"events":{"specialkey":"// TODO: 执行查询\nif(Ext.EventObject.getKey() == 13){\n  app.findLdApplyDocs.fireEvent('click');\n}"},"children":[],"expanded":false,"type":"text"},{"configs":{"itemId":"findLdApplyDocs","iconCls":"seek_icon"},"events":{"click":"app.pickComp.getStore().load() ;"},"children":[],"expanded":false,"type":"button"},{"configs":{"itemId":"clearLdApplyDocs","iconCls":"cancel_icon","tooltip":"{#clearInfo#}"},"events":{"click":"app.APPLY_EX_DOC_CODE.setValue() ;\napp.APPLY_EX_DOC_ID.setValue() ;\napp.docCodeOrReason.setValue() ;\napp.findLdApplyDocs.fireEvent('click') ;"},"children":[],"expanded":false,"type":"button"}],"expanded":true,"type":"toolbar"},{"configs":{"itemId":"columns"},"children":[{"configs":{"text":"申请单ID","hidden":"true","dataIndex":"EX_DOC_ID","itemId":"EX_DOC_ID_PCR"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#APPLY_EX_DOC_CODE#}","dataIndex":"EX_DOC_CODE","titleAlign":"center","itemId":"EX_DOC_CODE_PCR","flex":"1"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#APPLY_EX_REASON#}","dataIndex":"EX_REASON","titleAlign":"center","itemId":"EX_REASON_PCR","flex":"1 "},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#APPLY_AMOUNT#}","xtype":"numbercolumn","align":"right","dataIndex":"AMOUNT","titleAlign":"center","format":"0,000.00","itemId":"AMOUNT_PCR"},"children":[],"expanded":false,"type":"column"}],"expanded":true,"type":"array"}],"expanded":true,"type":"grid"}],"expanded":true,"type":"picker"}],"expanded":true,"type":"panel"},{"configs":{"height":"30","layout":"column","columnWidth":"1","border":"false","itemId":"tr2"},"children":[{"configs":{"tagConfigs":"columnWidth:0.3","labelWidth":"100","readOnly":"true","labelAlign":"right","itemId":"EX_DOC_CODE","fieldLabel":"{#EX_DOC_CODE#}"},"children":[],"expanded":false,"type":"text"},{"configs":{"tagConfigs":"columnWidth:0.4","labelWidth":"100","readOnly":"true","labelAlign":"right","itemId":"CREATED_BY_NAME","fieldLabel":"{#CREATED_BY_NAME#}"},"children":[],"expanded":true,"type":"text"},{"configs":{"tagConfigs":"columnWidth:0.3","labelWidth":"100","allowBlank":"false","margin":"0 10 0 0","labelAlign":"right","itemId":"BIZ_DATE","fieldLabel":"<font color='red'>*<\/font>{#BIZ_DATE#}"},"children":[],"expanded":false,"type":"date"}],"expanded":true,"type":"panel"},{"configs":{"height":"30","layout":"column","columnWidth":"1","border":"false","itemId":"tr3"},"children":[{"configs":{"tagConfigs":"columnWidth:0.3","labelWidth":"100","triggerCls":"x-form-search-trigger","labelAlign":"right","itemId":"DEPT_NAME","fieldLabel":"<font color='red'>*<\/font>{#DEPT_NAME#}","editable":"false"},"events":{"expand":"app.findLdDepts.fireEvent('click') ;"},"children":[{"configs":{"tagConfigs":"minWidth:420","height":"240","barExportAllButtons":"false","barExportButtons":"false","itemId":"pickComp","forceFit":"true"},"events":{"itemclick":"// TODO: 选择成本中心\nvar deptId = record.get('DEPT_ID') ;\nvar deptName = record.get('DEPT_NAME') ;\n\napp.DEPT_NAME.setValue(deptName) ;\napp.DEPT_ID.setValue(deptId) ;\n\n// 清空项目\napp.PROJECT_ID.setValue() ;\napp.PROJECT_NAME.setValue() ;\n\n// app.pickComp.hide() ;\nvar picker = this.ownerCmp;\npicker.collapse();"},"children":[{"configs":{"itemId":"store","url":"m?xwl=xc/ex/common-db/query/select-ld-depts"},"events":{"beforeload":"// TODO: 扩展参数\nstore.proxy.extraParams.ledgerId = app.LEDGER_ID.getValue() ;\nstore.proxy.extraParams.textStr = app.deptCodeOrName.getValue() ;"},"children":[],"expanded":false,"type":"store"},{"configs":{"itemId":"columns"},"children":[{"configs":{"text":"部门ID","hidden":"true","width":"50","dataIndex":"DEPT_ID","titleAlign":"center","itemId":"DEPT_ID_COL"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#DEPT_CODE_COL#}","width":"100","dataIndex":"DEPT_CODE","titleAlign":"center","itemId":"DEPT_CODE_COL"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#DEPT_NAME_COL#}","width":"200","dataIndex":"DEPT_NAME","titleAlign":"center","itemId":"DEPT_NAME_COL"},"children":[],"expanded":false,"type":"column"}],"expanded":true,"type":"array"},{"configs":{"itemId":"tbar"},"children":[{"configs":{"emptyText":"{#queryCodeOrName#}","itemId":"deptCodeOrName"},"events":{"specialkey":"if(Ext.EventObject.getKey() == 13){\n  app.findLdDepts.fireEvent('click') ;\n}"},"children":[],"expanded":false,"type":"text"},{"configs":{"itemId":"findLdDepts","iconCls":"seek_icon"},"events":{"click":"// TODO: 加载成本中心\napp.pickComp.getStore().load() ;"},"children":[],"expanded":false,"type":"button"},{"configs":{"itemId":"clearLdDepts","iconCls":"cancel_icon","tooltip":"{#clearInfo#}"},"events":{"click":"app.DEPT_ID.setValue();\napp.DEPT_NAME.setValue() ;\napp.deptCodeOrName.setValue() ;\napp.findLdDepts.fireEvent('click') ;"},"children":[],"expanded":false,"type":"button"}],"expanded":true,"type":"toolbar"}],"expanded":true,"type":"grid"}],"expanded":false,"type":"picker"},{"configs":{"tagConfigs":"columnWidth:0.69","labelWidth":"100","triggerCls":"x-form-search-trigger","labelAlign":"right","itemId":"PROJECT_NAME","fieldLabel":"{#PROJECT_NAME#}"},"events":{"expand":"app.findLdPrj.fireEvent('click') ;"},"children":[{"configs":{"tagConfigs":"minWidth:420","height":"240","barExportAllButtons":"false","barExportButtons":"false","itemId":"pickComp","forceFit":"true"},"events":{"itemclick":"// TODO: 选择PA项目\nvar prjId = record.get('PROJECT_ID') ;\nvar prjName = record.get('PROJECT_NAME') ;\n\napp.PROJECT_ID.setValue(prjId) ;\napp.PROJECT_NAME.setValue(prjName) ;\n\n// app.pickComp.hide() ;\nvar picker = this.ownerCmp;\npicker.collapse();"},"children":[{"configs":{"itemId":"store","url":"m?xwl=xc/ex/common-db/query/select-ld-projects"},"events":{"beforeload":"store.proxy.extraParams.ledgerId = app.LEDGER_ID.getValue();\nstore.proxy.extraParams.deptId = app.DEPT_ID.getValue();"},"children":[],"expanded":false,"type":"store"},{"configs":{"itemId":"columns"},"children":[{"configs":{"text":"项目ID","hidden":"true","dataIndex":"PROJECT_ID","itemId":"PROJECT_ID_COL"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#PROJECT_CODE_COL#}","width":"100","dataIndex":"PROJECT_CODE","titleAlign":"center","itemId":"PROJECT_CODE_COL"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#PROJECT_NAME_COL#}","width":"200","dataIndex":"PROJECT_NAME","titleAlign":"center","itemId":"PROJECT_NAME_COL"},"children":[],"expanded":false,"type":"column"}],"expanded":true,"type":"array"},{"configs":{"itemId":"tbar"},"children":[{"configs":{"emptyText":"{#queryCodeOrName#}","itemId":"prjCodeOrName"},"events":{"specialkey":"// TODO: 加载PA项目信息\nif(Ext.EventObject.getKey() == 13){\n  app.findLdPrj.fireEvent('click');\n}"},"children":[],"expanded":false,"type":"text"},{"configs":{"itemId":"findLdPrj","iconCls":"seek_icon"},"events":{"click":"app.pickComp.getStore().load() ;"},"children":[],"expanded":false,"type":"button"},{"configs":{"itemId":"clearLdPrj","iconCls":"cancel_icon","tooltip":"{#clearInfo#}"},"events":{"click":"// TODO: 清除PA项目\napp.PROJECT_ID.setValue() ;\napp.PROJECT_NAME.setValue() ;\napp.prjCodeOrName.setValue() ;\napp.findLdPrj.fireEvent('click') ;"},"children":[],"expanded":false,"type":"button"}],"expanded":true,"type":"toolbar"}],"expanded":true,"type":"grid"}],"expanded":false,"type":"picker"}],"expanded":true,"type":"panel"},{"configs":{"height":"30","layout":"column","columnWidth":"1","border":"false","itemId":"tr4"},"children":[{"configs":{"tagConfigs":"columnWidth:1","labelWidth":"100","margin":"0 10 0 0","labelAlign":"right","itemId":"EX_REASON","fieldLabel":"<font color='red'>*<\/font>{#TRA_EX_REASON#}"},"children":[],"expanded":false,"type":"text"}],"expanded":true,"type":"panel"},{"configs":{"height":"30","layout":"column","columnWidth":"1","border":"false","itemId":"tr5"},"children":[{"configs":{"tagConfigs":"columnWidth:0.3,regex:/^\\d*\\.{0,1}\\d{0,2}$/","labelWidth":"100","readOnly":"true","decimalPrecision":"2","minValue":"0","labelAlign":"right","itemId":"AMOUNT","fieldLabel":"{#TRA_AMONNT#}"},"children":[],"expanded":false,"type":"number"},{"configs":{"tagConfigs":"columnWidth:0.4,regex:/^\\d*\\.{0,1}\\d{0,2}$/","labelWidth":"100","readOnly":"true","decimalPrecision":"2","minValue":"0","value":"0","labelAlign":"right","itemId":"LEND_AMT","fieldLabel":"{#LEND_AMONNT1#}"},"children":[],"expanded":false,"type":"number"},{"configs":{"tagConfigs":"columnWidth:0.3,regex:/^\\d*\\.{0,1}\\d{0,2}$/","labelWidth":"100","decimalPrecision":"2","minValue":"0","value":"0","margin":"0 10 0 0","labelAlign":"right","itemId":"CANCEL_AMT","fieldLabel":"<font color='red'>*<\/font>{#CANCEL_AMT#}"},"children":[],"expanded":false,"type":"number"}],"expanded":true,"type":"panel"},{"configs":{"hidden":"true","itemId":"h_panel"},"children":[{"configs":{"readOnly":"true","hidden":"true","itemId":"EX_CAT_CODE","fieldLabel":"单据分类"},"children":[],"expanded":false,"type":"text"},{"configs":{"hidden":"true","itemId":"EX_DOC_ID","fieldLabel":"单据ID"},"children":[],"expanded":false,"type":"text"},{"configs":{"hidden":"true","itemId":"INS_CODE","fieldLabel":"流程实例编码"},"children":[],"expanded":false,"type":"text"},{"configs":{"readOnly":"true","hidden":"true","itemId":"AUDIT_STATUS","fieldLabel":"流程审批状态"},"children":[],"expanded":false,"type":"text"},{"configs":{"itemId":"APPLY_EX_DOC_ID","fieldLabel":"费用申请单ID"},"children":[],"expanded":false,"type":"text"},{"configs":{"readOnly":"true","hidden":"true","itemId":"CREATED_BY","fieldLabel":"申请人ID"},"children":[],"expanded":true,"type":"text"},{"configs":{"hidden":"true","itemId":"DEPT_ID","fieldLabel":"成本中心ID"},"children":[],"expanded":false,"type":"text"},{"configs":{"hidden":"true","itemId":"PROJECT_ID","fieldLabel":"PA项目ID"},"children":[],"expanded":false,"type":"text"}],"expanded":true,"type":"panel"}],"expanded":false,"type":"panel"}],"expanded":true,"type":"form"},{"configs":{"region":"center","multiSelect":"false","forceFit":"true","border":"true","itemId":"grid1","simpleSelect":"false","editable":"true"},"children":[{"configs":{"itemId":"tbar"},"children":[{"configs":{"text":"{#addLine#}","itemId":"addLine","iconCls":"file_add_icon"},"events":{"click":"Ext.define('lineModel', {  \n  extend: 'Ext.data.Model',  \n  fields: [  \n    {name: 'EX_DTL_ID'},  \n    {name: 'EX_DOC_ID'},\n    {name: 'EX_ITEM_ID'},\n    {name: 'EX_ITEM_NAME'},\n    {name: 'BG_ITEM_ID'},  \n    {name: 'BG_ITEM_NAME'},  \n    {name: 'EX_DTL_AMT'},  \n    {name: 'START_DATE'},  \n    {name: 'END_DATE'},  \n    {name: 'START_POS'},  \n    {name: 'END_POS'},  \n    {name: 'DOC_NUM'},\n    {name: 'EX_DTL_DESC'}\n  ]  \n});\nvar r = Ext.create('lineModel', {\n  'EX_DTL_ID':'',\n  'EX_DOC_ID':'',\n  'EX_ITEM_ID':'',\n  'EX_ITEM_NAME':'',\n  'BG_ITEM_ID':'', \n  'BG_ITEM_NAME':'',\n  'EX_DTL_AMT': '',\n  'START_DATE':'',\n  'END_DATE':'',\n  'START_POS':'',\n  'END_POS':'',\n  'DOC_NUM':'',\n  'EX_DTL_DESC':''\n});\nvar store = app.grid1.getStore() ;\nvar p = store.getCount() ;\nstore.insert(p,r);"},"children":[],"expanded":false,"type":"button"},{"configs":{"text":"{#delLine#}","itemId":"delLine","iconCls":"file_delete_icon"},"events":{"click":"// 选中行\nvar selRow = app.grid1.getSelection() ;\nif(selRow.length === 0){\n  Wb.toast('{#deleteInfo1#}') ;\n  return false ;\n}\n// 选中行金额\nvar r = selRow[0] ;\nvar amt = r.data.EX_DTL_AMT ;\n// 计算合计数\nvar amount = app.AMOUNT.getValue();\napp.AMOUNT.setValue(amount-amt) ;\n// 删除行\nvar store = app.grid1.getStore() ;\nstore.remove(r) ;"},"children":[],"expanded":false,"type":"button"}],"expanded":true,"type":"toolbar"},{"configs":{"autoLoad":"false","itemId":"store","url":"m?xwl=xc/ex/qry/ex-my-doc-qry/data/select-ex-doc-dtls"},"events":{"beforeload":"store.proxy.extraParams.exDocId = app.EX_DOC_ID.getValue() ;"},"children":[],"expanded":false,"type":"store"},{"configs":{"itemId":"columns"},"children":[{"configs":{"text":"{#ORDERBY#}","align":"center","width":"50","xtype":"rownumberer","titleAlign":"center","itemId":"rownum"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"明细ID","hidden":"true","dataIndex":"EX_DTL_ID","titleAlign":"center","itemId":"EX_DTL_ID_COL"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"单据ID","hidden":"true","dataIndex":"EX_DOC_ID","titleAlign":"center","itemId":"EX_DOC_ID_COL"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"费用项ID","hidden":"true","dataIndex":"EX_ITEM_ID","titleAlign":"center","itemId":"EX_ITEM_ID_COL"},"children":[],"expanded":true,"type":"column"},{"configs":{"text":"{#EX_ITEM_NAME#}","width":"150","dataIndex":"EX_ITEM_NAME","titleAlign":"center","itemId":"EX_ITEM_NAME_COL"},"children":[{"configs":{"triggerCls":"x-form-search-trigger","itemId":"editor"},"events":{"expand":"app.treeName.reset();\n"},"children":[{"configs":{"rootVisible":"false","tagConfigs":"minWidth:450","height":"250","normalName":"exTreePanel","itemId":"pickComp"},"events":{"itemclick":"if(!record.data.leaf){\n  return ;\n}\nvar exItemId = record.data.EX_ITEM_ID;\nvar exItemName = record.data.text;\nvar bgItemId = record.data.BG_ITEM_ID;\nvar bgItemName = record.data.BG_ITEM_NAME;\nvar r = app.grid1.getSelection()[0] ;\nr.set('EX_ITEM_ID', exItemId) ;\nr.set('EX_ITEM_NAME', exItemName) ;\n\nif(!Ext.isEmpty(bgItemId)){\n  r.set('BG_ITEM_ID', bgItemId) ;\n}\nif(!Ext.isEmpty(bgItemName)){\n  r.set('BG_ITEM_NAME', bgItemName) ;\n}\nvar picker = this.ownerCmp;\npicker.setValue(exItemName) ;\npicker.collapse();","beforeload":"if(Ext.isEmpty(app.LEDGER_ID.getValue)){\n  return false ;\n}"},"children":[{"configs":{"autoLoad":"false","itemId":"store","url":"{#ctxPath#}/exItemTreeAction.do?method=getExItemTree","fields":"[{name:'LEDGER_ID'},{name:'EX_ITEM_ID'},{name:'text'},{name:'EX_ITEM_UP_ID'},{name:'EX_ITEM_CODE'},{name:'BG_ITEM_ID'},{name:'BG_ITEM_NAME'}]"},"events":{"beforeload":"if(Ext.isEmpty(app.LEDGER_ID.getValue)){\n  return false ;\n}else{\n operation.params.ledgerId = app.LEDGER_ID.getValue();\n operation.params.exDocCat = 'EX03';\n operation.params.exCodeName ='';\n}"},"children":[],"expanded":false,"type":"treestore"},{"configs":{"itemId":"tbar"},"children":[{"configs":{"text":"-","itemId":"item1"},"children":[],"expanded":false,"type":"item"},{"configs":{"width":"120","labelAlign":"right","itemId":"treeName"},"events":{"specialkey":"app.treeQueryBtn.fireEvent('click');"},"children":[],"expanded":false,"type":"text"},{"configs":{"text":"-","itemId":"item2"},"children":[],"expanded":false,"type":"item"},{"configs":{"itemId":"treeQueryBtn","iconCls":"seek_icon"},"events":{"click":"treeNodeQuery(app.treeName.getValue(),'text', app.exTreePanel);"},"children":[],"expanded":false,"type":"button"},{"configs":{"text":"-","itemId":"item3"},"children":[],"expanded":false,"type":"item"}],"expanded":true,"type":"toolbar"}],"expanded":true,"type":"tree"}],"expanded":true,"type":"picker"}],"expanded":true,"type":"column"},{"configs":{"text":"预算项ID","hidden":"true","dataIndex":"BG_ITEM_ID","titleAlign":"center","itemId":"BG_ITEM_ID_COL"},"children":[],"expanded":true,"type":"column"},{"configs":{"text":"{#BG_ITEM_NAME#}","width":"150","dataIndex":"BG_ITEM_NAME","titleAlign":"center","itemId":"BG_ITEM_NAME_COL"},"children":[{"configs":{"triggerCls":"x-form-search-trigger","itemId":"editor"},"events":{"expand":"app.findLdBgItems.fireEvent('click') ;"},"children":[{"configs":{"tagConfigs":"minWidth:450","height":"240","barExportAllButtons":"false","barExportButtons":"false","forceFit":"true","normalName":"bgPickComp","itemId":"pickComp"},"events":{"itemclick":"// TODO: 选择预算项目\nvar bgItemId = record.get('BG_ITEM_ID') ;\nvar bgItemName = record.get('BG_ITEM_NAME') ;\n\n// TODO: 当前选中记录行\nvar r = app.grid1.getSelection()[0] ;\n\nr.set('BG_ITEM_ID', bgItemId) ;\nr.set('BG_ITEM_NAME', bgItemName) ;\n\n// TODO: 获取picker\nvar picker = this.ownerCmp;\npicker.setValue(bgItemName) ;\npicker.collapse();\n"},"children":[{"configs":{"itemId":"store","url":"m?xwl=xc/ex/common-db/query/select-ld-bg-items"},"events":{"beforeload":"// TODO: 扩展参数\nstore.proxy.extraParams.ledgerId=app.LEDGER_ID.getValue() ;\nstore.proxy.extraParams.textStr=app.bgItemCodeOrName.getValue() ;"},"children":[],"expanded":false,"type":"store"},{"configs":{"itemId":"columns"},"children":[{"configs":{"text":"预算项目ID","hidden":"true","width":"50","dataIndex":"BG_ITEM_ID","itemId":"EX_ITEM_ID_PCR"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#BG_ITEM_CODE_COL#}","width":"100","dataIndex":"BG_ITEM_CODE","titleAlign":"center","itemId":"EX_ITEM_CODE_PCR"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#BG_ITEM_NAME_COL#}","width":"200","dataIndex":"BG_ITEM_NAME","titleAlign":"center","itemId":"EX_ITEM_NAME_PCR"},"children":[],"expanded":false,"type":"column"}],"expanded":true,"type":"array"},{"configs":{"itemId":"tbar"},"children":[{"configs":{"emptyText":"{#queryCodeOrName#}","itemId":"bgItemCodeOrName"},"events":{"specialkey":"if(Ext.EventObject.getKey() == 13){\n  app.findLdBgItems.fireEvent('click');\n}"},"children":[],"expanded":false,"type":"text"},{"configs":{"itemId":"findLdBgItems","iconCls":"seek_icon"},"events":{"click":"app.bgPickComp.getStore().load() ;"},"children":[],"expanded":false,"type":"button"},{"configs":{"itemId":"clearLdBgItems","iconCls":"cancel_icon","tooltip":"{#clearInfo#}"},"events":{"click":"// TODO: 清空预算项目信息并清空\nvar r = app.grid1.getSelection()[0] ;\nr.set('BG_ITEM_ID', '') ;\nr.set('BG_ITEM_NAME', '') ;\napp.BG_ITEM_NAME_COL.getEditor().setValue() ;\napp.bgItemCodeOrName.setValue() ;\napp.findLdBgItems.fireEvent('click') ;"},"children":[],"expanded":false,"type":"button"}],"expanded":true,"type":"toolbar"}],"expanded":true,"type":"grid"}],"expanded":true,"type":"picker"}],"expanded":true,"type":"column"},{"configs":{"text":"{#AMOUNT#}","align":"right","width":"120","dataIndex":"EX_DTL_AMT","format":"0,000.00","titleAlign":"center","itemId":"EX_DTL_AMT_COL"},"children":[{"configs":{"decimalPrecision":"2","allowBlank":"false","minValue":"0","value":"0","itemId":"editor"},"events":{"blur":"// 原金额\nvar amount = app.AMOUNT.getValue() ;\nif(amount === null || amount === \"\" || amount === undefined){\n  amount = 0 ;\n}\n// 修改前金额\nvar r = app.grid1.getSelection()[0] ;\nvar oldAmt = r.data.EX_DTL_AMT ;\nif(oldAmt === null || oldAmt === \"\" || oldAmt === undefined){\n  oldAmt = 0 ;\n}\n// 修改后金额\nvar amt = number.getValue() ;\n// 合计值\napp.AMOUNT.setValue(amount+amt-oldAmt) ;"},"children":[],"expanded":false,"type":"number"}],"expanded":false,"type":"column"},{"configs":{"text":"{#START_DATE_COL#}","align":"center","dataIndex":"START_DATE","format":"Y-m-d","titleAlign":"center","itemId":"START_DATE_COL"},"children":[{"configs":{"itemId":"editor"},"children":[],"expanded":false,"type":"date"}],"expanded":true,"type":"column"},{"configs":{"text":"{#END_DATE_COL#}","align":"center","dataIndex":"END_DATE","format":"Y-m-d","titleAlign":"center","itemId":"END_DATE_COL"},"children":[{"configs":{"itemId":"editor"},"children":[],"expanded":false,"type":"date"}],"expanded":true,"type":"column"},{"configs":{"text":"{#START_POS_COL#}","width":"120","dataIndex":"START_POS","titleAlign":"center","itemId":"START_POS_COL"},"children":[{"configs":{"itemId":"editor"},"children":[],"expanded":false,"type":"textarea"}],"expanded":true,"type":"column"},{"configs":{"text":"{#END_POS_COL#}","width":"120","dataIndex":"END_POS","titleAlign":"center","itemId":"END_POS_COL"},"children":[{"configs":{"itemId":"editor"},"children":[],"expanded":false,"type":"textarea"}],"expanded":true,"type":"column"},{"configs":{"text":"{#DOC_NUM_COL#}","width":"80","align":"center","dataIndex":"DOC_NUM","titleAlign":"center","itemId":"DOC_NUM_COL"},"children":[{"configs":{"decimalPrecision":"0","allowBlank":"false","minValue":"0","itemId":"editor"},"children":[],"expanded":false,"type":"number"}],"expanded":true,"type":"column"},{"configs":{"text":"{#EX_DTL_DESC_COL#}","width":"180","dataIndex":"EX_DTL_DESC","titleAlign":"center","itemId":"EX_DTL_DESC_COL"},"children":[{"configs":{"itemId":"editor"},"children":[],"expanded":false,"type":"textarea"}],"expanded":true,"type":"column"}],"expanded":true,"type":"array"}],"expanded":true,"type":"grid"}],"expanded":true,"type":"window"}],"expanded":true,"type":"module"}],"pageLink":"","iconCls":"window_icon"}