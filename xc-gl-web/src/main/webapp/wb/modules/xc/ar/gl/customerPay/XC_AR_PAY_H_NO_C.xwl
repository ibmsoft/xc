{"inframe":false,"title":"拆分出来的应付单无容器模式","hidden":false,"roles":{"default":1},"children":[{"configs":{"serverScript":"var contextPath = request.getContextPath();\nrequest.setAttribute(\"contextPath\",contextPath);\ncom.xzsoft.xip.platform.util.XipUtil.getCurrentLang(request,'xc/ar/gl/customerPay/json/XC_AR_PAY_H_NO_C');","itemId":"module"},"events":{"initialize":"Wb.isInsert = 'Y'; //操作类型\nvar init = '0';\nExt.apply(app, {\n  initWin: function(params) {\n    Ext.apply(app, params);\n    app.editWinN = new Ext.window.Window(app.editWinN);\n    app.editWinN.show();\n    Wb.AR_PAY_H_ID = params.AR_PAY_H_ID;\n    Wb.IsInsert = params.IS_INSERT;\n    if (Wb.IsInsert == 'Y') {\n      init = '0';\n    } else {\n      init = '1';\n    }\n\n    Wb.request({\n      url: 'm?xwl=xc/ar/gl/customerPay/DB/LOV_XC_AR_PAY_DETAIL_H',\n      //后台java代码生成\n      method: 'POST',\n      async: false,\n      //异步传参\n      params: {\n        AR_PAY_H_ID: Wb.AR_PAY_H_ID,\n        INIT: init\n      },\n      success: function(resp) {\n        var r = Wb.decode(resp.responseText);\n        Wb.request({\n          url: 'm?xwl=xc/ar/gl/customerPay/DB/XC_AR_SELECT_DATE',\n          //后台java代码生成\n          method: 'POST',\n          async: false,\n          //异步传参\n          params: {\n            LEDGER_ID:r.LEDGER_ID\n          },\n          success: function(respDate) {\n\n            var rDate = Wb.decode(respDate.responseText);\n\n            r.GL_DATE = rDate.LAST_M_DATE;\n            Wb.setValue(app.editWinN, r);\n            app.PAY_ACC_ID_XWL.PAY_ACC_NAME.setValue(r.SALE_ACC_ID_NAME);\n            app.PAY_ACC_ID_XWL.PAY_ACC_ID.setValue(r.SALE_ACC_ID);\n            if (r.CUSTOMER_ID!='00') {\n              app.CUSTOMER_ID_XWL.CUSTOMER_NAME.setReadOnly(true);\n            }else{\n              app.CUSTOMER_ID_XWL.CUSTOMER_NAME.setReadOnly(false);\n              app.CUSTOMER_ID_XWL.QUERY_LEDGER_ID.setValue(r.LEDGER_ID);\n            }\n            if (r.PROJECT_ID!='00') {\n              app.PROJECT_ID_XWL.PROJECT_NAME.setReadOnly(true);\n            }else{\n              app.PROJECT_ID_XWL.PROJECT_NAME.setReadOnly(false);\n            }\n            if (r.DEPT_ID!='00') {\n              app.DEPT_ID_XWL.DEPT_NAME.setReadOnly(true);\n            }else{\n              app.DEPT_ID_XWL.DEPT_NAME.setReadOnly(false);\n            }\n            app.AR_CONTRACT_ID_XWL.QUERY_LEDGER_ID.setValue(r.LEDGER_ID);\n            app.AR_CONTRACT_ID_XWL.AR_CONTRACT_NAME.setFieldLabel('<font color=\"red\">*<\/font>'+'{#customerPay_contract#}');\n            app.AR_CONTRACT_ID_XWL.QUERY_CUSTOMER_ID.setValue(app.CUSTOMER_ID_XWL.CUSTOMER_ID.getValue());\n            app.AR_CONTRACT_ID_XWL.AR_CONTRACT_NAME.allowBlank=false;\n            app.PROJECT_ID_XWL.QUERY_LEDGER_ID.setValue(r.LEDGER_ID);\n            app.PROJECT_ID_XWL.QUERY_DEPT_ID.setValue(app.DEPT_ID_XWL.DEPT_ID.getValue());\n            app.DEPT_ID_XWL.QUERY_LEDGER_ID.setValue(r.LEDGER_ID);\n            app.LEDGER_ID_XWL.LEDGER_NAME.setReadOnly(true);\n            app.PAY_ACC_ID_XWL.PAY_ACC_NAME.setReadOnly(true);\n\n            if (Wb.IsInsert == 'Y') {\n              app.AR_PAY_CUSTOMER_H_ID.setValue(r.AR_PAY_H_ID);\n              app.AR_PAY_H_ID.setValue(Xip.getId());\n              Wb.request({\n                url:'m?xwl=xc/ar/gl/customerPay/DB/getSplitAmount',\n                params:{'AR_PAY_H_ID':Wb.AR_PAY_H_ID,'sql':'1=1'},\n                success:function(resp){\n                  var rec = Wb.decode(resp.responseText);\n                  app.AMOUNT.setValue(rec.rows[0].amount);\n                }\n              });\n            }\n          }\n        });\n\n      }\n    });\n  }\n});\n\nfunction returnRowFn(r, type) {\n  if (type == 'xc_gl_ledgers') {\n    app.CUSTOMER_ID_XWL.QUERY_LEDGER_ID.setValue(r.data.LEDGER_ID);\n    app.PROJECT_ID_XWL.QUERY_LEDGER_ID.setValue(r.data.LEDGER_ID);\n    app.DEPT_ID_XWL.QUERY_LEDGER_ID.setValue(r.data.LEDGER_ID);\n    app.PAY_ACC_ID_XWL.QUERY_LEDGER_ID.setValue(r.data.LEDGER_ID);\n  }\n    if(type=='xc_ar_customers'){\n    app.AR_CONTRACT_ID_XWL.QUERY_CUSTOMER_ID.setValue(r.data.CUSTOMER_ID);\n    app.AR_CONTRACT_ID_XWL.AR_CONTRACT_NAME.setValue('');\n  }\n  if(type==\"xip_pub_depts\"){\n    app.PROJECT_ID_XWL.QUERY_DEPT_ID.setValue(r.data.DEPT_ID);\n    app.PROJECT_ID_XWL.PROJECT_NAME.setValue('');\n  }\n}\nfunction clearOtherFn(type) {\n  if(type=='xc_ar_customers'){\n    app.AR_CONTRACT_ID_XWL.AR_CONTRACT_NAME.setValue('');\n  }\n  if(type==\"xip_pub_depts\"){\n    app.PROJECT_ID_XWL.PROJECT_NAME.setValue('');\n  }\n}"},"children":[{"configs":{"itemId":"winTbar"},"children":[{"configs":{"text":"{#save#}","itemId":"saveBtn","iconCls":"save_icon"},"events":{"click":"app.CUSTOMER_ID_XWL.CUSTOMER_NAME.allowBlank=false;\nif(app.AMOUNT.getValue()==0){\n  Wb.toast('{#saveMsg4#}');\n  return;\n}\nif(Wb.IsInsert=='Y'){\n  Wb.request({\n    url:'m?xwl=xc/ar/gl/customerPay/DB/getSplitAmount',\n    params:{'AR_PAY_H_ID':app.AR_PAY_CUSTOMER_H_ID.getValue(),'sql':'1=1'},\n    success:function(resp){\n      var rec =Wb.decode(resp.responseText);\n      if(app.AMOUNT.getValue()>rec.rows[0].amount){\n        Wb.toast('{#saveMsg1#}');\n        app.AMOUNT.setValue(rec.rows[0].amount);\n        return;\n      }else{\n        if (app.form1.isValid()) {\n          Wb.request({\n            url: 'm?xwl=xc/ar/gl/customerPay/DB/XC_AR_PAY_H_PUB_ERROR_ALERT',\n            params: {\n              AR_PAY_H_ID: app.AR_PAY_H_ID.getValue(),\n              AR_PAY_CUSTOMER_H_ID: app.AR_PAY_CUSTOMER_H_ID.getValue(),\n              AMOUNT:app.AMOUNT.getValue(),\n              sql: 'SELECT 1 '+\n              ' FROM xc_ar_pay_h WHERE AR_PAY_H_ID={?AR_PAY_CUSTOMER_H_ID?} '+\n              ' and ABS(AMOUNT)+ '+\n              ' IFNULL((SELECT ABS(AMOUNT) '+\n              ' FROM xc_ar_pay_h WHERE AR_PAY_H_ID={?AR_PAY_H_ID?} ),0)- '+\n              ' IFNULL((SELECT SUM(ABS(AMOUNT))+{?decimal.AMOUNT?} '+\n              ' FROM xc_ar_pay_h WHERE AR_PAY_CUSTOMER_H_ID={?AR_PAY_CUSTOMER_H_ID?} ),{?decimal.AMOUNT?})<0 ',\n              errorMsg: '拆分金额超过原始起初金额！'\n            },\n            success: function(resp) {\n              Wb.request({\n                url:'{#contextPath#}'+'/arInvGlBaseAction.do?method=splitYuS',\n                params:{'json':Wb.getValue(app.form1)},\n                success:function(resp){\n                  var rec = Wb.decode(resp.responseText);\n                  if(rec.flag=='0'){\n                    Wb.info('{#saveMsg2#}');\n                    Wb.IsInsert = 'N';\n                    app.AR_PAY_H_CODE.setValue(rec.code);\n                  }if(rec.flag=='1'){\n                    Wb.info(rec.msg);                  \n                  }\n                }\n              });\n            }\n          });\n        } else {\n          Wb.toast('{#saveMsg3#}');\n          return;\n        }\n      }\n    }\n  });\n}else{\n  var sql = 'AR_PAY_H_ID !='+\"'\"+app.AR_PAY_H_ID.getValue()+\"'\";\n  Wb.request({\n    url:'m?xwl=xc/ar/gl/customerPay/DB/getSplitAmount1',\n    params:{'AR_PAY_H_ID':app.AR_PAY_CUSTOMER_H_ID.getValue(),'sql':sql,'payHId':app.AR_PAY_H_ID.getValue()},\n    success:function(resp){\n      var rec =Wb.decode(resp.responseText);\n      if(app.AMOUNT.getValue()>rec.rows[0].amount){\n        Wb.toast('{#saveMsg1#}');\n        app.AMOUNT.setValue(rec.rows[0].amount);\n        return;\n      }else{\n        if (app.form1.isValid()) {\n          Wb.request({\n            url: 'm?xwl=xc/ar/gl/customerPay/DB/XC_AR_PAY_H_PUB_ERROR_ALERT',\n            params: {\n              AR_PAY_H_ID: app.AR_PAY_H_ID.getValue(),\n              AR_PAY_CUSTOMER_H_ID: app.AR_PAY_CUSTOMER_H_ID.getValue(),\n              AMOUNT:app.AMOUNT.getValue(),\n              sql: 'SELECT 1 '+\n              ' FROM xc_ar_pay_h WHERE AR_PAY_H_ID={?AR_PAY_CUSTOMER_H_ID?} '+\n              ' and ABS(AMOUNT)+ '+\n              ' IFNULL((SELECT ABS(AMOUNT) '+\n              ' FROM xc_ar_pay_h WHERE AR_PAY_H_ID={?AR_PAY_H_ID?} ),0)- '+\n              ' IFNULL((SELECT SUM(ABS(AMOUNT))+{?decimal.AMOUNT?} '+\n              ' FROM xc_ar_pay_h WHERE AR_PAY_CUSTOMER_H_ID={?AR_PAY_CUSTOMER_H_ID?} ),{?decimal.AMOUNT?})<0 ',\n              errorMsg: '拆分金额超过原始起初金额！'\n            },\n            success: function(resp) {\n              Wb.request({\n                url:'{#contextPath#}'+'/arInvGlBaseAction.do?method=splitYuS',\n                params:{'json':Wb.getValue(app.form1)},\n                success:function(resp){\n                  var rec = Wb.decode(resp.responseText);\n                  if(rec.flag=='0'){\n                    Wb.info('{#saveMsg2#}');\n                    Wb.IsInsert = 'N';\n                    app.AR_PAY_H_CODE.setValue(rec.code);\n                  }if(rec.flag=='1'){\n                    Wb.info(rec.msg);                  \n                  }\n                }\n              });\n            }\n          });\n        } else {\n          Wb.toast('{#saveMsg3#}');\n          return;\n        }\n      }\n    }\n  });\n}\n"},"children":[],"expanded":false,"type":"button"}],"expanded":true,"type":"toolbar"},{"configs":{"tbar":"app.winTbar","maximized":"true","layout":"fit","itemId":"editWinN"},"events":{"close":"app.hideFun();"},"children":[{"configs":{"region":"north","border":"false","itemId":"form1"},"children":[{"configs":{"text":"{#label#}","style":"fontSize:20px","margin":"10 0 20 0","labelAlign":"center","itemId":"label1"},"children":[],"expanded":false,"type":"label"},{"configs":{"tagConfigs":"baseCls : 'my-panel-no-border'","layout":"column","itemId":"tr1"},"children":[{"configs":{"tagConfigs":"baseCls : 'my-panel-no-border'","layout":"form","columnWidth":".245","itemId":"td_1_1"},"children":[{"configs":{"file":"m?xwl=xc/com-lov/LEDGER_ID_PICK/LEDGER_ID_PICK_SEC","itemId":"LEDGER_ID_XWL"},"children":[],"expanded":false,"type":"xwl"},{"configs":{"hidden":"true","itemId":"AR_PAY_H_ID"},"children":[],"expanded":false,"type":"text"},{"configs":{"hidden":"true","itemId":"AR_PAY_CUSTOMER_H_ID"},"children":[],"expanded":false,"type":"text"},{"configs":{"hidden":"true","itemId":"INIT"},"children":[],"expanded":false,"type":"text"},{"configs":{"hidden":"true","value":"{#XIP.userId#}","itemId":"USER_ID","fieldLabel":"USER_ID"},"children":[],"expanded":false,"type":"text"}],"expanded":false,"type":"panel"},{"configs":{"tagConfigs":"baseCls : 'my-panel-no-border'","layout":"form","columnWidth":".245","itemId":"td_1_2"},"children":[{"configs":{"labelWidth":"80","readOnly":"true","allowBlank":"false","pickList":"[['SKD_YUSK','{#payDocPre#}']]","labelAlign":"right","itemId":"AR_DOC_CAT_CODE","fieldLabel":"<span style=\"color: rgb(255, 0, 0);\">*<\/span>{#docType#}"},"events":{"select":"if(combo.getValue()=='PTFP'){\n  app.tr4.hide();\n}else{\n  app.tr4.show();\n}"},"children":[],"expanded":false,"type":"combo"}],"expanded":true,"type":"panel"},{"configs":{"tagConfigs":"baseCls : 'my-panel-no-border'","layout":"form","columnWidth":".245","itemId":"td_1_3"},"children":[{"configs":{"labelWidth":"80","readOnly":"true","labelAlign":"right","itemId":"AR_PAY_H_CODE","fieldLabel":"<span style=\"color: rgb(255, 0, 0);\">*<\/span>{#docCode#}"},"children":[],"expanded":false,"type":"text"}],"expanded":false,"type":"panel"},{"configs":{"tagConfigs":"baseCls : 'my-panel-no-border'","layout":"form","columnWidth":".245","itemId":"td_1_4"},"children":[{"configs":{"labelWidth":"80","readOnly":"true","labelAlign":"right","itemId":"GL_DATE","fieldLabel":"<span style=\"color: rgb(255, 0, 0);\">*<\/span>{#glDate#}"},"children":[],"expanded":false,"type":"date"}],"expanded":true,"type":"panel"}],"expanded":true,"type":"panel"},{"configs":{"tagConfigs":"baseCls : 'my-panel-no-border'","layout":"column","itemId":"tr2"},"children":[{"configs":{"tagConfigs":"baseCls : 'my-panel-no-border'","layout":"form","columnWidth":".245","itemId":"td_2_1"},"children":[{"configs":{"file":"m?xwl=xc/ar/ar-com-lov/AR_CUSTOMER_ID_PICK/AR_CUSTOMER_ID_PICK","itemId":"CUSTOMER_ID_XWL"},"children":[],"expanded":false,"type":"xwl"}],"expanded":true,"type":"panel"},{"configs":{"tagConfigs":"baseCls : 'my-panel-no-border'","layout":"form","columnWidth":".245","itemId":"td_1_3"},"children":[{"configs":{"file":"m?xwl=xc/ar/gl/customerPay/DEPT_ID_PICK/DEPT_ID_LD","itemId":"DEPT_ID_XWL"},"children":[],"expanded":false,"type":"xwl"}],"expanded":false,"type":"panel"},{"configs":{"tagConfigs":"baseCls : 'my-panel-no-border'","layout":"form","columnWidth":".245","itemId":"td_2_2"},"children":[{"configs":{"file":"m?xwl=xc/com-lov/PROJECT_ID_PICK/PROJECT_ID_LD","itemId":"PROJECT_ID_XWL"},"children":[],"expanded":false,"type":"xwl"}],"expanded":true,"type":"panel"},{"configs":{"tagConfigs":"baseCls : 'my-panel-no-border'","layout":"form","columnWidth":".245","itemId":"td_2_4"},"children":[{"configs":{"file":"m?xwl=xc/ar/ar-com-lov/AR_CONTRACT_ID_PICK/AR_CONTRACT_ID_PICK_ALL","itemId":"AR_CONTRACT_ID_XWL"},"children":[],"expanded":false,"type":"xwl"}],"expanded":true,"type":"panel"}],"expanded":true,"type":"panel"},{"configs":{"tagConfigs":"baseCls : 'my-panel-no-border'","layout":"column","itemId":"tr3"},"children":[{"configs":{"tagConfigs":"baseCls : 'my-panel-no-border'","layout":"form","columnWidth":".245","itemId":"td_3_1"},"children":[{"configs":{"file":"m?xwl=xc/ar/ar-com-lov/ACC_ID_PICK/PAY_ACC_ID_PICK","itemId":"PAY_ACC_ID_XWL"},"children":[],"expanded":false,"type":"xwl"}],"expanded":true,"type":"panel"},{"configs":{"tagConfigs":"baseCls : 'my-panel-no-border'","layout":"form","columnWidth":".245","itemId":"td_3_2"},"children":[{"configs":{"labelWidth":"80","allowBlank":"false","labelAlign":"right","itemId":"AMOUNT","fieldLabel":"<span style=\"color: rgb(255, 0, 0);\">*<\/span>{#amount#}"},"children":[],"expanded":false,"type":"number"}],"expanded":true,"type":"panel"},{"configs":{"tagConfigs":"baseCls : 'my-panel-no-border'","layout":"form","columnWidth":".490","itemId":"td_3_3"},"children":[{"configs":{"labelWidth":"80","allowBlank":"true","labelAlign":"right","itemId":"DESCRIPTION","fieldLabel":"<span style=\"color: rgb(255, 0, 0);\">*<\/span>{#description#}"},"children":[],"expanded":false,"type":"text"}],"expanded":true,"type":"panel"}],"expanded":false,"type":"panel"},{"configs":{"hidden":"true","layout":"column","itemId":"tr4"},"children":[{"configs":{"itemId":"SALE_CCID","fieldLabel":"SALE_CCID"},"children":[],"expanded":false,"type":"text"}],"expanded":true,"type":"panel"}],"expanded":true,"type":"form"}],"expanded":true,"type":"window"}],"expanded":true,"type":"module"}],"pageLink":"{container:false}","iconCls":""}