{"inframe":true,"title":"我的销售发票","hidden":false,"roles":{"default":1},"children":[{"configs":{"initScript":"var userId = request.getSession().getAttribute(\"XzSessionVars\").get('userId');\n\nvar protocol = request.getProtocol() ;\nvar ipAddr = request.getServerName();\nvar port = request.getServerPort() ;\nvar ctxPath = request.getContextPath() ;\n\nprotocol = (protocol == \"HTTP/1.1\" ? \"http\" : \"https\") ;\nvar url = protocol + \"://\" + ipAddr +\":\" + port + ctxPath ;\n\nrequest.setAttribute('contextPath',ctxPath);\nrequest.setAttribute(\"userId\",userId);\nrequest.setAttribute(\"appIP\",url);\nvar appId = request.getSession().getAttribute(\"XzSessionVars\").get('appId');\nrequest.setAttribute(\"funId\",request.getParameter('funId'));\nrequest.setAttribute(\"appId\",request.getParameter('appId'));","serverScript":"//---------------------获取当前模块语言对应的.json文件，放到request中----------------\ncom.xzsoft.xip.platform.util.XipUtil.getCurrentLang(request,\"xc/ar/touch/inv/json/XC_AR_INVOICE_H_NO_C\");\nvar op = request.getParameter('op');\nvar arDocCat = request.getParameter('arDocCat');\nvar arInvHId = request.getParameter('arInvHId');\nvar ledgerId = request.getParameter('ledgerId');\nrequest.setAttribute('op',op);\nrequest.setAttribute('arDocCat',arDocCat);\nrequest.setAttribute('arInvHId',arInvHId);\nrequest.setAttribute('ledgerId',ledgerId);","head":"<style type=\"text/css\">    \n.x-hidebar .x-toolbar{display:none !important;}\n<\/style>","itemId":"module"},"events":{"finalize":"var flag = 'false';\nvar loadList;//传入的list\nvar saveStatus = '';\nvar deleteDtl = [];","initialize":"//初始化数据，（编辑）\nWb.apply(app,{\n\tmainNav : null,\n\tloadList : null,\n    flashStore:function(list){\n        loadList = list;\n    },\n\tinit : function(x){\n\t\t//接受导航栏\n\t\tmainNav = x;\n\t}\n});\n//创建一个销售发票明细对象\nfunction createInvoiceDtl(){\n\tvar toolBar = new Ext.Toolbar({\n\t\tstyle : {'background':'#F7F7F7','border-bottom':'1px solid #DDDDDD'},\n\t\titems : [{\n            xtype : \"label\",\n            html : \"\"\n\t\t},{\n            xtype : \"spacer\"\n\t\t},{\n            xtype : \"button\",\n            text : \"{#delBtn#}\",\n            listeners:{\n\t\t\t\ttap: function(){\n                    var fieldset = this.getParent().getParent();\n                    var dtlContainer = fieldset.getParent();\n                    var invoiceDtlID = fieldset.getAt(8).getValue();\n\t\t\t\t\tExt.Msg.confirm('{#confirm#}','{#confirm1#}',function(btn){\n                        if(btn === 'yes'){\n                            saveStatus = 'update';\n                            var deleteData =  {AR_INV_L_ID : invoiceDtlID};\n                            deleteDtl.push(deleteData);\n                            app.rowContainer.remove(dtlContainer);\n                        }\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\t\t}]\n\t});\n\tvar container = Ext.create('Ext.Container',{\n        xtype : 'container',\n        createInstance: false,\n        items :[{\n          name : \"fieldSet\",\n          xtype : \"fieldset\",\n          items:[\n            toolBar,\n            {\n              hidden : true,\n              name : \"invoiceDtl\",\n              xtype : \"textfield\"\n            },{\n              name : \"AR_SALE_TYPE_ID\",\n              label : \"<font color=red>*<\/font>{#AR_SALE_TYPE_NAME#}\",\n              labelWidth : 100,\n              store : app.saleStore,\n              displayField : \"AR_SALE_TYPE_NAME\",\n              valueField : \"AR_SALE_TYPE_ID\",\n              clearIcon: false,\n              xtype : \"selectfield\",\n              listeners : {\n                  change : function(select, newValue, oldValue, options){\n                      saveStatus = 'update';\n                  }\n              }\n            },{\n              name : \"PRODUCT_ID\",\n              label : \"{#PRODUCT_ID#}\",\n              labelWidth : 100,\n              hidden : true,\n              readOnly : true,\n              createInstance: false,\n              xtype : \"textfield\"\n            },{\n              name : \"PRODUCT_NAME\",\n              label : \"{#PRODUCT_NAME#}\",\n              labelWidth : 100,\n              readOnly : true,\n              createInstance: false,\n              xtype : \"textfield\"\n            },{\n              name : \"QTY\",\n              label : \"<font color=red>*<\/font>{#QTY#}\",\n              labelWidth : 100,\n              clearIcon: false,\n              createInstance: false,\n              xtype : \"numberfield\",\n              listeners: {\n                  change: function(number, newValue, oldValue, options) {\n                      saveStatus = 'update';\n                  }\n              }\n            },{\n              name : \"DIM_CODE\",\n              label : \"<font color=red>*<\/font>{#DIM_NAME#}\",\n              labelWidth : 100,\n              store : app.dimStore,\n              displayField : \"DIM_NAME\",\n              valueField : \"DIM_CODE\",\n              clearIcon: false,\n              xtype : \"selectfield\",\n              listeners : {\n                  change : function(select, newValue, oldValue, options) {\n                      saveStatus = 'update';\n                  }\n              }\n            },{\n              name : \"AMOUNT\",\n              label : \"<font color=red>*<\/font>{#AMOUNT#}\",\n              labelWidth : 100,\n              clearIcon : false,\n              createInstance: false,\n              xtype : \"numberfield\",\n              listeners: {\n                  change: function(number, newValue, oldValue, options) {\n                      saveStatus = 'update';\n                  }\n              }\n            },{\n              name : \"TAX\",\n              label : \"<font color=red>*<\/font>{#TAX_RATE#}\",\n              labelWidth : 100,\n              clearIcon: false,\n              maxValue: 17,\n              minValue: 0,\n              createInstance: false,\n              xtype : \"numberfield\",\n              listeners: {\n                  change: function(number, newValue, oldValue, options) {\n                      saveStatus = 'update';\n                  }\n              }\n            },{\n              name : \"TAX_AMT\",\n              label : \"<font color=red>*<\/font>{#TAX_AMT#}\",\n              labelWidth : 100,\n              clearIcon: false,\n              createInstance: false,\n              xtype : \"numberfield\",\n              listeners: {\n                  change: function(number, newValue, oldValue, options) {\n                      saveStatus = 'update';\n                  }\n              }\n            },{\n              name : \"INV_AMOUNT\",\n              label : \"<font color=red>*<\/font>{#INV_AMOUNT#}\",\n              labelWidth : 100,\n              clearIcon: false,\n              createInstance: false,\n              xtype : \"numberfield\",\n              listeners: {\n                  change: function(number, newValue, oldValue, options) {\n                      saveStatus = 'update';\n                  }\n              }\n            },{\n              name : \"AR_INV_L_ID\",\n              label : \"行ID\",\n              labelWidth : 100,\n              hidden : true,\n              xtype : \"textfield\"\n            },{\n              name : \"L_AR_INV_H_ID\",\n              label : \"蓝字发票主ID\",\n              labelWidth : 100,\n              hidden : true,\n              xtype : \"textfield\"\n            },{\n              name : \"L_AR_INV_L_ID\",\n              label : \"蓝字发票行ID\",\n              labelWidth : 100,\n              hidden : true,\n              xtype : \"textfield\"\n            },{\n              name : \"MODEL\",\n              label : \"{#MODEL#}\",\n              labelWidth : 100,\n              hidden : true,\n              xtype : \"textfield\"\n            },{\n              name : \"DESCRIPTION\",\n              label : \"{#DESCRIPTION#}\",\n              labelWidth : 100,\n              hidden : true,\n              xtype : \"textfield\"\n            }]\n        }]\n    });\n\treturn container;\n}\n//设置销售发票明细\nfunction setDtlsTitle(){\n\tvar count = app.rowContainer.items.length;\n\tfor(var i = 0;i < count;i++){\n        var dtlContainer = app.rowContainer.getAt(i);//明细容器\n        var fieldset = dtlContainer.getAt(0);\n        var toolbar = fieldset.getAt(0);\n        var label = toolbar.getAt(0);\n      \n        var button = toolbar.getAt(2);\n        if(app.SYS_AUDIT_STATUS.getValue() !== 'A' && app.SYS_AUDIT_STATUS.getValue() !== '' && app.SYS_AUDIT_STATUS.getValue() !== null){\n            button.hide();\n        }\n        label.setHtml('<span style=\"color:gray;font-size:14px\">{#saveDtlWarn1#}'+(i+1)+'<\/span>');\n\t}\n}\n//获取销售发票明细的数据\nfunction getInvoiceDtlsDatas(){\n  //销售发票明细的数量\n  var count = app.rowContainer.items.length;\n  //定义明细数据集合\n  var datas = [];\n  //获取明细数据\n  for(var i = 0;i < count;i++){\n      var dtl = app.rowContainer.getAt(i);//获取明细容器\n      var fieldset = dtl.getAt(0);//获取fieldset\n      var AR_SALE_TYPE_ID = fieldset.getAt(2).getValue();//销售类型ID\n      var PRODUCT_ID = fieldset.getAt(3).getValue();//产品ID\n      var QTY = fieldset.getAt(5).getValue();//数量\n      var DIM_CODE = fieldset.getAt(6).getValue();//计量单位\n      var AMOUNT = fieldset.getAt(7).getValue();//无税金额\n      var TAX = fieldset.getAt(8).getValue();//税率\n      var TAX_AMT = fieldset.getAt(9).getValue();//税额\n      var INV_AMOUNT = fieldset.getAt(10).getValue();//价税合计\n      var AR_INV_L_ID = fieldset.getAt(11).getValue();//行ID\n      var L_AR_INV_H_ID = fieldset.getAt(12).getValue();//行ID\n      var L_AR_INV_L_ID = fieldset.getAt(13).getValue();//行ID\n      var MODEL = fieldset.getAt(14).getValue();//行ID\n      var DESCRIPTION = fieldset.getAt(15).getValue();//行ID\n      var data = {\n          AR_SALE_TYPE_ID : AR_SALE_TYPE_ID,\n          PRODUCT_ID : PRODUCT_ID,\n          QTY : QTY,\n          DIM_CODE : DIM_CODE,\n          AMOUNT : AMOUNT,\n          TAX : TAX,\n          TAX_AMT : TAX_AMT,\n          INV_AMOUNT : INV_AMOUNT,\n          AR_INV_L_ID : AR_INV_L_ID,\n          L_AR_INV_H_ID : L_AR_INV_H_ID,\n          L_AR_INV_L_ID : L_AR_INV_L_ID,\n          PRICE : 0,\n          INV_PRICE : 0,\n          MODEL : MODEL,\n          DESCRIPTION : app.DESCRIPTION.getValue()\n      };\n      datas.push(data);\n\t}\n\treturn datas;\n}\n//获取行信息的金额数据，并且给主信息价税合计和税额赋值\nfunction setAmount(){\n    //销售发票明细的数量\n    var count = app.rowContainer.items.length;\n    //通过明细算出主表中的金额值\n    var INV_AMOUNT = 0;//价税合计\n    var AMOUNT = 0;//金额(无税)\n    var TAX_AMT = 0;//税额\n    for (var i = 0; i < count; i++) {\n        INV_AMOUNT = INV_AMOUNT + fieldset.getAt(10).getValue();//价税合计\n        AMOUNT = AMOUNT + fieldset.getAt(7).getValue();//无税金额\n        TAX_AMT = TAX_AMT +fieldset.getAt(9).getValue();//税额\n    }\n    app.AMOUNT.setValue(AMOUNT);\n    app.TAX_AMT.setValue(TAX_AMT);\n    app.INV_AMOUNT.setValue(INV_AMOUNT);\n}\n\n//给销售明细赋值\nfunction setInvoiceDtlsDatas(dtlData){\n    var count = dtlData.length;\n    //获取明细数据\n    for(var i = 0;i < count;i++){\n        var container = createInvoiceDtl();\n        app.rowContainer.add(container);\n        setDtlsTitle();\n        var dtl = app.rowContainer.getAt(i);//获取明细容器\n        var fieldset = dtl.getAt(0);//获取fieldset\n        var dtlDatas = dtlData[i];//单条明细数据\n        fieldset.getAt(2).setValue(dtlDatas.AR_SALE_TYPE_ID);//AR_SALE_TYPE_ID\n        fieldset.getAt(3).setValue(dtlDatas.PRODUCT_ID);//BG_ITEM_ID\n        fieldset.getAt(5).setValue(dtlDatas.QTY);//QTY\n        fieldset.getAt(6).setValue(dtlDatas.DIM_CODE);//DIM_CODE\n        fieldset.getAt(7).setValue(dtlDatas.AMOUNT);//AMOUNT\n        fieldset.getAt(8).setValue(dtlDatas.TAX);//TAX\n        fieldset.getAt(9).setValue(dtlDatas.TAX_AMT);//TAX_AMT\n        fieldset.getAt(10).setValue(dtlDatas.INV_AMOUNT);//INV_AMOUNT\n        fieldset.getAt(11).setValue(dtlDatas.AR_INV_L_ID);//AR_INV_L_ID\n        fieldset.getAt(12).setValue(dtlDatas.L_AR_INV_H_ID);//L_AR_INV_H_ID\n        fieldset.getAt(13).setValue(dtlDatas.L_AR_INV_L_ID);//L_AR_INV_L_ID\n        fieldset.getAt(14).setValue(dtlDatas.MODEL);//MODEL\n        fieldset.getAt(15).setValue(dtlDatas.DESCRIPTION);//DESCRIPTION\n    }\n}\n//判断销售发票明细是否为空\nfunction judgemDtlIsNull(){\n    var returnMsg = '';\n    //获取销售发票明细参数\n    var rowTabInfo = getInvoiceDtlsDatas();\n\n    for(var i = 0;i < rowTabInfo.length;i++){\n        var data = rowTabInfo[i];\n        if(Ext.isEmpty(data.AR_SALE_TYPE_ID)){\n            returnMsg = '{#saveDtlWarn1#}' + (i + 1) + '：{#saveDtlWarn2#}';\n            break;\n        }\n        if(Ext.isEmpty(data.QTY)){\n            returnMsg = '{#saveDtlWarn1#}' + (i + 1) + '：{#saveDtlWarn4#}';\n            break;\n        }\n        if(Ext.isEmpty(data.DIM_CODE)){\n            returnMsg = '{#saveDtlWarn1#}' + (i + 1) + '：{#saveDtlWarn3#}';\n            break;\n        }\n        if(Ext.isEmpty(data.TAX)){\n            returnMsg = '{#saveDtlWarn1#}' + (i + 1) + '：{#saveDtlWarn5#}';\n            break;\n        }\n        if(Ext.isEmpty(data.TAX_AMT)){\n            returnMsg = '{#saveDtlWarn1#}' + (i + 1) + '：{#saveDtlWarn6#}';\n            break;\n        }\n        if(Ext.isEmpty(data.INV_AMOUNT)){\n            returnMsg = '{#saveDtlWarn1#}' + (i + 1) + '： {#saveDtlWarn7#}';\n            break;\n        }\n    }\n    return returnMsg;\n}"},"children":[{"configs":{"itemId":"stores"},"children":[{"configs":{"itemId":"ledgerStore","autoLoad":"true","url":"m?xwl=xc/ar/touch/inv/xc_ar_invoice_myDB/ledgersSelect"},"events":{"success":"if(store.getCount() > 0 && '{#op#}' === 'insert'){\n    if(flag == 'false'){\n        if('{#ledgerId#}' === null || '{#ledgerId#}' === ''){\n            app.LEDGER_ID.setValue(store.getAt(0).get('LEDGER_ID'));\n        }\n        else{\n            app.LEDGER_ID.setValue('{#ledgerId#}');\n        }\n        flag = 'true';\n    }\n}"},"children":[],"expanded":false,"type":"tstore"},{"configs":{"itemId":"customerStore","url":"m?xwl=xc/ar/touch/inv/xc_ar_invoice_myDB/customerSelect"},"events":{"beforeload":"store.getProxy().setExtraParams({\"LEDGER_ID\" : app.LEDGER_ID.getValue()});"},"children":[],"expanded":false,"type":"tstore"},{"configs":{"itemId":"contractStore","url":"m?xwl=xc/ar/touch/inv/xc_ar_invoice_myDB/contractSelect"},"children":[],"expanded":false,"type":"tstore"},{"configs":{"itemId":"deptStore","url":"m?xwl=xc/ar/touch/inv/xc_ar_invoice_myDB/deptSelect"},"children":[],"expanded":false,"type":"tstore"},{"configs":{"itemId":"projectStore","url":"m?xwl=xc/ar/touch/inv/xc_ar_invoice_myDB/proSelect"},"events":{"beforeload":"store.getProxy().setExtraParams({\"LEDGER_ID\" : app.LEDGER_ID.getValue()});"},"children":[],"expanded":false,"type":"tstore"},{"configs":{"autoLoad":"true","itemId":"dimStore","url":"m?xwl=xc/ar/touch/inv/xc_ar_invoice_myDB/dimSelect"},"children":[],"expanded":false,"type":"tstore"},{"configs":{"itemId":"productStore","url":"m?xwl=xc/ar/touch/inv/xc_ar_invoice_myDB/selectProductInfo"},"children":[],"expanded":false,"type":"tstore"},{"configs":{"itemId":"saleStore","url":"m?xwl=xc/ar/touch/inv/xc_ar_invoice_myDB/arSaleTypeSelect"},"events":{"beforeload":"store.getProxy().setExtraParams({\"LEDGER_ID\" : app.LEDGER_ID.getValue()});"},"children":[],"expanded":false,"type":"tstore"}],"expanded":true,"type":"folder"},{"configs":{"title":"{#CUSTOMER_NAME#}","layout":"fit","itemId":"customerContainer","createInstance":"false"},"events":{"painted":"app.searchVButton.fireEvent('tap');"},"children":[{"configs":{"docked":"top","itemId":"toolbar"},"children":[{"configs":{"placeHolder":"{#CUSTOMER_INFO#}","labelWidth":"100","labelAlign":"left","itemId":"CUSTOMER_INFO"},"events":{"action":"app.searchVButton.fireEvent('tap');"},"children":[],"expanded":false,"type":"ttext"},{"configs":{"glyph":"f002","itemId":"searchVButton"},"events":{"tap":"var params = {\n    LEDGER_ID : app.LEDGER_ID.getValue(),\n\tCUSTOMER_INFO : app.CUSTOMER_INFO.getValue()\n};\napp.customerStore.load({params : params});//查询（重新加载数据）"},"children":[],"expanded":false,"type":"tbutton"}],"expanded":true,"type":"ttoolbar"},{"configs":{"cls":"x-hidebar","store":"app.customerStore","scrollToTopOnRefresh":"true","useSimpleItems":"true","rowNumber":"true","itemId":"customerGrid"},"events":{"itemsingletap":"app.CUSTOMER_ID.setValue(record.get('CUSTOMER_ID'));\napp.CUSTOMER_NAME.setValue(record.get('CUSTOMER_NAME'));\nmainNav.pop();"},"children":[{"configs":{"itemId":"columns"},"children":[{"configs":{"text":"{#order#}","hidden":"true","align":"center","width":"60","xtype":"rownumberer","itemId":"NUMBER_COL"},"children":[],"expanded":false,"type":"tcolumn"},{"configs":{"text":"客户ID","hidden":"true","dataIndex":"CUSTOMER_ID","itemId":"CUSTOMER_ID_COL"},"children":[],"expanded":false,"type":"tcolumn"},{"configs":{"text":"{#CUSTOMER_NAME#}","dataIndex":"CUSTOMER_NAME","itemId":"CUSTOMER_NAME_COL"},"children":[],"expanded":false,"type":"tcolumn"}],"expanded":true,"type":"array"}],"expanded":true,"type":"tgrid"}],"expanded":false,"type":"tcontainer"},{"configs":{"title":"{#PROJECT_NAME#}","layout":"fit","itemId":"proContainer","createInstance":"false"},"events":{"painted":"app.searchPButton.fireEvent('tap');"},"children":[{"configs":{"docked":"top","itemId":"toolbar"},"children":[{"configs":{"placeHolder":"{#PROJECT_INFO#}","labelWidth":"100","labelAlign":"left","itemId":"PROJECT_INFO"},"events":{"action":"app.searchPButton.fireEvent('tap');"},"children":[],"expanded":false,"type":"ttext"},{"configs":{"glyph":"f002","itemId":"searchPButton"},"events":{"tap":"var params = {\n    LEDGER_ID : app.LEDGER_ID.getValue(),\n\tPROJECT_INFO : app.PROJECT_INFO.getValue(),\n    DEPT_ID : app.DEPT_ID.getValue()\n};\napp.projectStore.load({params : params});//查询（重新加载数据）"},"children":[],"expanded":false,"type":"tbutton"}],"expanded":true,"type":"ttoolbar"},{"configs":{"cls":"x-hidebar","store":"app.projectStore","scrollToTopOnRefresh":"true","useSimpleItems":"true","rowNumber":"true","itemId":"proGrid"},"events":{"itemsingletap":"app.DEPT_ID.setValue(record.get('DEPT_ID'));\napp.PROJECT_ID.setValue(record.get('PROJECT_ID'));\napp.PROJECT_NAME.setValue(record.get('PROJECT_NAME'));\nmainNav.pop();"},"children":[{"configs":{"itemId":"columns"},"children":[{"configs":{"text":"{#order#}","hidden":"true","align":"center","width":"60","xtype":"rownumberer","itemId":"NUMBER_COL"},"children":[],"expanded":false,"type":"tcolumn"},{"configs":{"text":"项目ID","hidden":"true","dataIndex":"PROJECT_ID","itemId":"PROJECT_ID_COL"},"children":[],"expanded":false,"type":"tcolumn"},{"configs":{"text":"{#DEPT_NAME#}","dataIndex":"DEPT_NAME","itemId":"DEPT_NAME_COL"},"children":[],"expanded":false,"type":"tcolumn"},{"configs":{"text":"{#PROJECT_NAME#}","dataIndex":"PROJECT_NAME","itemId":"PROJECT_NAME_COL"},"children":[],"expanded":false,"type":"tcolumn"}],"expanded":true,"type":"array"}],"expanded":true,"type":"tgrid"}],"expanded":false,"type":"tcontainer"},{"configs":{"layout":"fit","itemId":"viewport"},"children":[{"configs":{"scrollable":"true","itemId":"container"},"events":{"initialize":"if('{#op#}' === 'insert'){\n    app.AR_INV_H_ID.setValue(Xip.getId());\n    app.BIZ_DATE.setValue(new Date());\n    app.AUDIT_STATUS.setValue('A');\n    saveStatus = 'insert';\n}\nif('{#arDocCat#}' === 'ZZSPT'){\n    app.AR_DOC_CAT_CODE.setValue('ZZSPT');\n    app.AR_CAT_NAME.setValue('增值税普通发票');\n}\nif('{#arDocCat#}' === 'ZZS'){\n    app.AR_DOC_CAT_CODE.setValue('ZZS');\n    app.AR_CAT_NAME.setValue('增值税专用发票');\n}\nif('{#op#}' === 'update'){\n    app.LEDGER_ID.setReadOnly(true);\n    saveStatus = 'update';\n    Wb.request({\n        url : 'm?xwl=xc/ar/touch/inv/xc_ar_invoice_myDB/ar_invoiceHSelectById',\n        params : {AR_INV_H_ID : '{#arInvHId#}'},\n        success : function(resp){\n            var data = Wb.decode(resp.responseText).rows[0];\n            app.customerStore.load({params : {LEDGER_ID : data.LEDGER_ID},callback : function(){\n                app.deptStore.load({params : {LEDGER_ID : data.LEDGER_ID},callback : function(){\n                    app.contractStore.load({params : {LEDGER_ID : data.LEDGER_ID,CUSTOMER_ID : data.CUSTOMER_ID},callback : function(){\n                        app.projectStore.load({params : {LEDGER_ID : data.LEDGER_ID,DEPT_ID : data.DEPT_ID},callback : function(){\n                            Wb.setValue(app.mainFieldset,data);\n                            app.BIZ_DATE.setValue(Ext.Date.parse(data.BIZ_DATE, \"Y-m-d H:i:s.u\"));\n                            Wb.request({\n                                url : 'm?xwl=xc/ar/touch/inv/xc_ar_invoice_myDB/ar_invoiceLSelectById',\n                                params : {AR_INV_H_ID : '{#arInvHId#}'},\n                                success : function(resp){\n                                    var temp = Wb.decode(resp.responseText);\n//                                     app.bgItemStore.load({params : {AR_PUR_TYPE_ID : temp.rows[0].AR_PUR_TYPE_ID,LEDGER_ID : data.LEDGER_ID},callback : function(){\n                                        setInvoiceDtlsDatas(temp.rows);\n//                                     }});\n                                }\n                            });\n                        }});\n                    }});\n                }});\n            }});\n            if(data.SYS_AUDIT_STATUS !== 'A' && data.SYS_AUDIT_STATUS !== '' && data.SYS_AUDIT_STATUS !== null){\n                app.saveButton.hide();\n                app.addInvoiceDtlButton.hide();\n                app.annexButton.hide();\n                app.submitButton.hide();\n                app.monitorBtn.show();\n                app.withdrawBtn.show();\n            }\n            if(data.AUDIT_STATUS === 'E'){\n                app.withdrawBtn.hide();\n            }\n        }\n    });\n}\n"},"children":[{"configs":{"itemId":"mainContainer"},"children":[{"configs":{"itemId":"mainFieldset"},"children":[{"configs":{"hidden":"true","itemId":"hidePanel"},"children":[{"configs":{"labelWidth":"100","hidden":"true","label":"销售发票ID","labelAlign":"left","itemId":"AR_INV_H_ID"},"children":[],"expanded":false,"type":"ttext"},{"configs":{"labelWidth":"100","hidden":"true","label":"流程状态","labelAlign":"left","itemId":"AUDIT_STATUS"},"children":[],"expanded":false,"type":"ttext"},{"configs":{"labelWidth":"100","label":"业务状态","labelAlign":"left","itemId":"SYS_AUDIT_STATUS"},"children":[],"expanded":false,"type":"ttext"},{"configs":{"labelWidth":"100","hidden":"true","label":"流程编码","labelAlign":"left","itemId":"INS_CODE"},"children":[],"expanded":false,"type":"ttext"},{"configs":{"labelWidth":"100","hidden":"true","label":"销售发票编码","labelAlign":"left","itemId":"AR_INV_H_CODE"},"children":[],"expanded":false,"type":"ttext"},{"configs":{"labelWidth":"100","readOnly":"true","hidden":"true","label":"<font color=\"red\">*<\/font>成本中心","labelAlign":"left","itemId":"DEPT_NAME"},"children":[],"expanded":false,"type":"ttext"},{"configs":{"labelWidth":"100","hidden":"true","label":"业务日期","labelAlign":"left","itemId":"BIZ_DATE"},"children":[],"expanded":false,"type":"tdate"},{"configs":{"labelWidth":"100","hidden":"true","label":"蓝字发票","labelAlign":"left","itemId":"L_AR_INV_H_ID"},"children":[],"expanded":false,"type":"ttext"},{"configs":{"labelWidth":"100","hidden":"true","label":"原始发票号","labelAlign":"left","itemId":"INV_NO"},"children":[],"expanded":false,"type":"ttext"}],"expanded":true,"type":"tpanel"},{"configs":{"labelWidth":"100","store":"app.ledgerStore","displayField":"LEDGER_NAME","valueField":"LEDGER_ID","label":"<font color=\"red\">*<\/font>{#LEDGER#}","clearIcon":"false","labelAlign":"left","itemId":"LEDGER_ID"},"events":{"change":"app.contractStore.load({params : {LEDGER_ID : newValue,CUSTOMER_ID : app.CUSTOMER_ID.getValue()}});\napp.deptStore.load({params : {LEDGER_ID : newValue}});\napp.saleStore.load({params : {LEDGER_ID : newValue}});\napp.CUSTOMER_ID.reset();\napp.CUSTOMER_NAME.reset();\napp.PROJECT_ID.reset();\napp.PROJECT_NAME.reset();\nsaveStatus = 'update';"},"children":[],"expanded":false,"type":"tselect"},{"configs":{"labelWidth":"100","readOnly":"true","hidden":"true","label":"<font color=\"red\">*<\/font>发票类型","labelAlign":"left","itemId":"AR_DOC_CAT_CODE"},"children":[],"expanded":false,"type":"ttext"},{"configs":{"labelWidth":"100","readOnly":"true","label":"<font color=\"red\">*<\/font>{#AR_DOC_CAT_CODE#}","labelAlign":"left","itemId":"AR_CAT_NAME"},"children":[],"expanded":false,"type":"ttext"},{"configs":{"labelWidth":"100","readOnly":"true","hidden":"true","label":"<font color=\"red\">*<\/font>客户","labelAlign":"left","itemId":"CUSTOMER_ID"},"events":{"change":"app.contractStore.load({params : {LEDGER_ID : app.LEDGER_ID.getValue(),CUSTOMER_ID : app.CUSTOMER_ID.getValue()}});\nsaveStatus = 'update';"},"children":[],"expanded":false,"type":"ttext"},{"configs":{"labelWidth":"100","readOnly":"true","label":"<font color=\"red\">*<\/font>{#CUSTOMER_NAME#}","labelAlign":"left","itemId":"CUSTOMER_NAME"},"events":{"clearicontap":"app.AR_CONTRACT_ID.reset();","focus":"var customerContainer = mainNav.down('#customerContainer');\nif (customerContainer === null || customerContainer === undefined) {\n    mainNav.push(app._customerContainer);\n}\nelse{\n    mainNav.setActiveItem(customerContainer);\n}"},"children":[],"expanded":false,"type":"ttext"},{"configs":{"labelWidth":"100","store":"app.contractStore","displayField":"AR_CONTRACT_NAME","valueField":"AR_CONTRACT_ID","label":"{#AR_CONTRACT_NAME#}","labelAlign":"left","itemId":"AR_CONTRACT_ID"},"events":{"clearicontap":"saveStatus = 'update';","change":"if(newValue !== null && newValue !== '' && newValue !== undefined){\n    app.CUSTOMER_ID.setValue((app.AR_CONTRACT_ID.getRecord().data.CUSTOMER_ID));\n    app.CUSTOMER_NAME.setValue((app.AR_CONTRACT_ID.getRecord().data.CUSTOMER_NAME));\n    saveStatus = 'update';\n}","focus":"app.contractStore.load({params : {LEDGER_ID : app.LEDGER_ID.getValue(),CUSTOMER_ID : app.CUSTOMER_ID.getValue()}});"},"children":[],"expanded":false,"type":"tselect"},{"configs":{"labelWidth":"100","store":"app.deptStore","displayField":"DEPT_NAME","valueField":"DEPT_ID","label":"<font color=\"red\">*<\/font>{#DEPT_NAME#}","labelAlign":"left","itemId":"DEPT_ID"},"events":{"change":"app.PROJECT_ID.reset();\napp.PROJECT_NAME.reset();\nsaveStatus = 'update';"},"children":[],"expanded":true,"type":"tselect"},{"configs":{"labelWidth":"100","readOnly":"true","hidden":"true","label":"项目ID","labelAlign":"left","itemId":"PROJECT_ID"},"events":{"change":"saveStatus = 'update';"},"children":[],"expanded":false,"type":"ttext"},{"configs":{"labelWidth":"100","readOnly":"true","label":"{#PROJECT_NAME#}","labelAlign":"left","itemId":"PROJECT_NAME"},"events":{"focus":"var proContainer = mainNav.down('#proContainer');\nif (proContainer === null || proContainer === undefined) {\n    mainNav.push(app._proContainer);\n}\nelse{\n    mainNav.setActiveItem(proContainer);\n}"},"children":[],"expanded":false,"type":"ttext"},{"configs":{"labelWidth":"100","readOnly":"true","hidden":"true","label":"{#AMOUNT#}","clearIcon":"false","labelAlign":"left","itemId":"AMOUNT"},"children":[],"expanded":false,"type":"tnumber"},{"configs":{"labelWidth":"100","readOnly":"true","label":"<font color=\"red\">*<\/font>{#INV_AMOUNT#}","clearIcon":"false","labelAlign":"left","itemId":"INV_AMOUNT"},"children":[],"expanded":false,"type":"tnumber"},{"configs":{"labelWidth":"100","readOnly":"true","label":"<font color=\"red\">*<\/font>{#TAX_AMT#}","clearIcon":"false","labelAlign":"left","itemId":"TAX_AMT"},"events":{"change":"// var count = app.rowContainer.items.length;\n// var invAmout = 0;\n// for(var i = 0;i < count;i++){\n//     var dtl = app.rowContainer.getAt(i);//获取明细容器\n//     var fieldset = dtl.getAt(0);//获取fieldset\n//     invAmout = invAmout + fieldset.getAt(5).getValue();//采购类型ID\n// }\n// app.INV_AMOUNT.setValue(invAmout + app.TAX_AMT.getValue());\n// app.AMOUNT.setValue(invAmout + app.TAX_AMT.getValue());\nsaveStatus = 'update';"},"children":[],"expanded":false,"type":"tnumber"},{"configs":{"labelWidth":"100","minValue":"0","label":"<font color=\"red\">*<\/font>{#TAX_RATE#}(%)","clearIcon":"false","labelAlign":"left","itemId":"TAX_RATE","maxValue":"17"},"events":{"change":"saveStatus = 'update';","blur":"if(number.getValue() > number.getMaxValue()){\n    number.setValue(number.getMaxValue());\n}\nif(number.getValue() < number.getMinValue()){\n    number.setValue(number.getMinValue());\n}"},"children":[],"expanded":false,"type":"tnumber"},{"configs":{"labelWidth":"100","readOnly":"true","hidden":"true","label":"{#CANCEL_AMT#}","labelAlign":"left","itemId":"CANCEL_AMT"},"events":{"change":"saveStatus = 'update';"},"children":[],"expanded":false,"type":"tnumber"},{"configs":{"labelWidth":"100","label":"<font color=\"red\">*<\/font>{#DESCRIPTION#}","clearIcon":"false","labelAlign":"left","itemId":"DESCRIPTION"},"events":{"change":"saveStatus = 'update';"},"children":[],"expanded":false,"type":"ttext"}],"expanded":true,"type":"tfieldset"}],"expanded":true,"type":"tcontainer"},{"configs":{"itemId":"rowContainer"},"children":[],"expanded":false,"type":"tcontainer"},{"configs":{"docked":"bottom","style":"background:0;border-color:#C0C0C0","itemId":"buttons"},"children":[{"configs":{"itemId":"spacer1"},"children":[],"expanded":false,"type":"tspacer"},{"configs":{"text":"{#addBtn#}","itemId":"addInvoiceDtlButton"},"events":{"tap":"var container = createInvoiceDtl();\napp.rowContainer.add(container);\nsetDtlsTitle();"},"children":[],"expanded":false,"type":"tbutton"},{"configs":{"text":"{#saveBtn#}","itemId":"saveButton"},"events":{"tap":"if(app.LEDGER_ID.getValue() === null){\n    Wb.info('{#saveWarn1#}');\n    return;\n}\nif(app.CUSTOMER_ID.getValue() === ''){\n    Wb.info('{#saveWarn2#}');\n    return;\n}\nif(app.DEPT_ID.getValue() === null){\n    Wb.info('{#saveWarn3#}');\n    return;\n}\nif(app.TAX_AMT.getValue() === null || app.TAX_AMT.getValue() === ''){\n    Wb.info('{#saveWarn4#}');\n    return;\n}\nif(app.TAX_RATE.getValue() === null || app.TAX_RATE.getValue() === ''){\n    Wb.info('{#saveWarn5#}');\n    return;\n}\nif(app.DESCRIPTION.getValue() === ''){\n    Wb.info('{#saveWarn6#}');\n    return;\n}\n//判断是否有采购发票明细\nvar invoiceDtlCount = app.rowContainer.items;\nif(invoiceDtlCount.length === 0){\n    Wb.info('{#saveWarn7#}');\n    return;\n}\n//获取采购发票明细参数\nvar rowTabInfo = getInvoiceDtlsDatas();\n//金额赋值\nsetAmount();\n//判断明细是否为空\nvar message = judgemDtlIsNull();\nif(message !== ''){\n    Wb.info(message);\n    return;\n}\nWb.request({\n\turl : '{#contextPath#}'+'/arInvoiceAction.do?method=saveOrUpdateArInvoice',\n    params : {'mainTabInfo' : Wb.encode(Wb.getValue(app.mainFieldset)),rowTabInfo : rowTabInfo,deleteDtl : deleteDtl},\n    success : function(resp){\n        var record = Wb.decode(resp.responseText);\n        var msg = record.msg;\n        if(record.flag === '0'){\n\t\t\tapp.INV_AMOUNT.setValue(record.srcAmt);\n            app.LEDGER_ID.setReadOnly(true);\n            app.CUSTOMER_NAME.setReadOnly(true);\n            saveStatus = 'save';\n        }\n        Wb.info(msg);\n        loadList.store.reload();//加载我的采购发票页面\n    }\n});"},"children":[],"expanded":false,"type":"tbutton"},{"configs":{"text":"{#enclosureBtn#}","itemId":"annexButton"},"events":{"tap":"var temp_id = app.AR_INV_H_ID.getValue();\nvar temp_code = app.AR_INV_H_CODE.getValue();\nif(saveStatus !== 'save'){\n\tWb.info('{#enclosureWarn1#}');\n    return;\n}\nWb.request({\n    url : '{#contextPath#}' + '/arInvoiceAction.do?method=getArAttCatCode',\n    params : {LEDGER_ID : app.LEDGER_ID.getValue(),AR_DOC_CAT_CODE : app.AR_DOC_CAT_CODE.getValue()},\n    success : function(resp){\n        var temp = Wb.decode(resp.responseText);\n        if(temp.flag == '0'){\n            var attCatCode = temp.attCatCode;\n            Xip.showAttachmentManagerTouch(mainNav,'{#XIP.userId#}',temp_id,'',attCatCode,temp_code,'Y','Y','Y',function(){},10);\n        }\n        else{\n            Wb.info(temp.msg);\n        }\n    }\n});"},"children":[],"expanded":false,"type":"tbutton"},{"configs":{"text":"{#submitButton#}","itemId":"submitButton"},"events":{"tap":"if(saveStatus !== 'save' && '{#op#}' === 'insert'){\n\tWb.info('请先保存销售发票，再进行流程提交');\n\tWb.info('{#enclosureWarn1#}');\n    return;\n}\nWb.request({\n    url : 'm?xwl=xc/ar/touch/inv/xc_ar_invoice_myDB/ar_invoiceHSelectById',\n    params : {AR_INV_H_ID : app.AR_INV_H_ID.getValue()},\n    success : function(resp){\n        if(Wb.decode(resp.responseText).total === 0){\n            Wb.info('请先保存销售发票，再进行流程提交！');\n            Wb.info('{#enclosureWarn1#}');\n            return;\n        }\n        //判断是否有销售发票明细\n        var invoiceDtlCount = app.rowContainer.items;\n        if(invoiceDtlCount.length === 0){\n            Wb.info('请添加销售发票明细，再进行流程提交！');\n            Wb.info('{#enclosureWarn1#}');\n            return;\n        }\n        //判断明细是否为空\n        var message = judgemDtlIsNull();\n        if(message !== ''){\n            Wb.info(message);\n            return;\n        }\n        Wb.request({\n            url : '{#contextPath#}' + '/arInvoiceAction.do?method=getArInvoiceProcAndForms',\n            params : {LEDGER_ID : app.LEDGER_ID.getValue(),\n                      AR_DOC_CAT_CODE : app.AR_DOC_CAT_CODE.getValue()\n            },\n            success : function(resp){\n                var temp = Wb.decode(resp.responseText);\n                if(temp.flag === '0'){\n                    //取得流程编码、电脑端审批表单和移动端审批表单\n                    var processCODE = temp.PROCESS_CODE;\n                    var pcApproveForm = temp.PC_A_FORM_URL;\n                    var mobileApproveForm = temp.M_A_FORM_URL;\n                    var orgId = temp.ORG_ID;\n                    if(pcApproveForm === \"\" || pcApproveForm === null || pcApproveForm === undefined){\n                        Wb.info('{#submitWarn7#}：'+app.AR_CAT_NAME.getDisplayValue()+'{#submitWarn8#}');\n                        return;\n                    }\n                    //电脑端和移动端审批表单为变量需要设置为全路径\n                    pcApproveForm = '{#appIP#}' +  '/' + pcApproveForm;\n                    mobileApproveForm = '{#appIP#}' +  mobileApproveForm;\n                    //如果流程编码存在, 则提交流程审批处理\n                    if(processCODE !== \"\" && processCODE !== null && processCODE !== undefined){\n                        //如果项目未指定，则设置默认值为 \"-1\"\n                        var prjId = app.PROJECT_ID.getValue() ;\n                        if(prjId === null || prjId === \"\" || prjId === undefined){\n                            prjId = \"-1\" ;\n                        }\n                        var auditStatus = app.AUDIT_STATUS.getValue();\n                        var json = {\n                            'ARP_IP'\t\t\t: '{#appIP#}',\n                            'EMP_ID'\t\t\t: '{#XIP.empId#}',\n                            'loginName'\t\t\t: '{#XIP.userName#}',\n                            'AR_DOC_CAT_NAME'\t: app.AR_CAT_NAME.getValue(),\n                            'M_A_FORM'\t\t\t: mobileApproveForm,\n                            'PC_A_FORM'\t\t\t: pcApproveForm,\n                            'arCatCode'\t\t\t: 'XSFP',\n                            'billType'\t\t\t: app.AR_DOC_CAT_CODE.getValue(),\n                            'DEPT_ID'\t\t\t: app.DEPT_ID.getValue() ,\n                            'DEPT_NAME'\t\t\t: app.DEPT_ID.getRecord().data.DEPT_NAME,\n                            'PROJECT_ID'\t\t: prjId,\n                            'ORG_ID'\t\t\t: orgId,\n                            'ledgerId'\t\t\t: app.LEDGER_ID.getValue(),\n                            'AMT'\t\t\t\t: app.INV_AMOUNT.getValue(),\n                            'ABSAMT'\t\t\t: Math.abs(app.INV_AMOUNT.getValue()),//金额绝对值\n                            'e_business_id'\t\t: app.AR_INV_H_ID.getValue()\n                        };\n                        if(auditStatus === 'A'){//起草状态\n                            XipWf.startAndSubmitByProcess(mainNav,processCODE,json,function(e){//提交流程\n                                if(e.flag === 0){\n                                    app.INS_CODE.setValue(e.instanceCode);\n                                    app.saveButton.hide();\n                                    app.addInvoiceDtlButton.hide();\n                                    app.annexButton.hide();\n                                    app.submitButton.hide();\n                                    app.monitorBtn.show();\n                                    app.withdrawBtn.show();\n                                    app.AUDIT_STATUS.setValue('C');\n                                    Wb.info('{#submitWarn2#}');\n                                    loadList.store.reload();//加载我的销售发票页面\n                                }\n                                else if(e.flag === 1){\n                                    Wb.info(e.msg) ;\n                                }else{}\n                            });\n                        }\n                        else if(auditStatus === 'D'){//驳回状态\n                            XipWf.submitInstance(mainNav,app.INS_CODE.getValue(),json,function(e){//提交流程\n                                if(e.flag === 0){\n                                    app.saveButton.hide();\n                                    app.addInvoiceDtlButton.hide();\n                                    app.annexButton.hide();\n                                    app.submitButton.hide();\n                                    app.monitorBtn.show();\n                                    app.withdrawBtn.show();\n                                    app.AUDIT_STATUS.setValue('C');\n                                    Wb.info('{#submitWarn2#}');\n                                    loadList.store.reload();//加载我的销售发票页面\n                                }\n                                else if(e.flag === 1){\n                                    Wb.info(e.msg) ;\n                                }else{}\n                            });\n                        }\n                        else if(auditStatus === 'R'){//撤回状态\n                            XipWf.restartAndSubmitByProcess(mainNav,app.INS_CODE.getValue(),processCODE,json,function(e){//提交流程\n                                if(e.flag === 0){\n                                    app.saveButton.hide();\n                                    app.addInvoiceDtlButton.hide();\n                                    app.annexButton.hide();\n                                    app.submitButton.hide();\n                                    app.monitorBtn.show();\n                                    app.withdrawBtn.show();\n                                    app.AUDIT_STATUS.setValue('C');\n                                    Wb.info('{#submitWarn2#}');\n                                    loadList.store.reload();//加载我的销售发票页面\n                                }\n                                else if(e.flag === 1){\n                                    Wb.info(e.msg) ;\n                                }else{}\n                            });\n                        }\n                        else if(auditStatus === 'E' || auditStatus === 'C'){//运行中、结束状态\n                            Wb.info('{#submitWarn3#}');\n                            return false;\n                        }\n                        else{\n                            Wb.info('{#submitWarn4#}');\n                              return false;\n                        }\n                    }\n                    else{\n                        Wb.info('{#submitWarn7#}：'+app.AR_CAT_NAME.getValue()+'{#submitWarn9#}');\n                    }\n                }\n                else{\n                    Wb.info(temp.msg);\n                }\n            }\n        });\n    }\n});"},"children":[],"expanded":false,"type":"tbutton"},{"configs":{"text":"{#monitorBtn#}","hidden":"true","itemId":"monitorBtn"},"events":{"tap":"if(app.INS_CODE.getValue() === null || app.INS_CODE.getValue() === ''){\n\tWb.info('{#monitorWarn1#}');\n}\nelse{\n    XipWf.showMonitorPage(mainNav,app.INS_CODE.getValue());\n}"},"children":[],"expanded":false,"type":"tbutton"},{"configs":{"text":"{#withdrawBtn#}","hidden":"true","itemId":"withdrawBtn"},"events":{"tap":"if(app.INS_CODE.getValue() === null || app.INS_CODE.getValue() === '') {\n\tWb.info('{#withdrawWarn1#}');\n\treturn;\n}\nelse if(app.AUDIT_STATUS.getValue() === 'E') {\n\tWb.info('{#withdrawWarn2#}');\n\treturn;\n}\nelse if(app.AUDIT_STATUS.getValue() === 'R'){\n\tWb.info('{#withdrawWarn3#}');\n    return;\n}\nelse {\n\t//撤回流程\n\tXipWf.revokeByInstance(app.INS_CODE.getValue(),function(e){\n        if(e.flag === 0){\n            app.AUDIT_STATUS.setValue('A');\n            app.saveButton.show();\n            app.addInvoiceDtlButton.show();\n            app.annexButton.show();\n            app.submitButton.show();\n            app.monitorBtn.hide();\n            app.withdrawBtn.hide();\n            Wb.info(e.msg);\n          }\n          else if(e.flag === 1){\n              Wb.info(e.msg);\n          }\n          loadList.store.reload();//加载我的采购发票页面\n\t});\n}"},"children":[],"expanded":false,"type":"tbutton"},{"configs":{"itemId":"spacer2"},"children":[],"expanded":false,"type":"tspacer"}],"expanded":true,"type":"ttoolbar"}],"expanded":true,"type":"tcontainer"}],"expanded":true,"type":"tviewport"}],"expanded":true,"type":"module"}],"pageLink":"","iconCls":""}