{"inframe":false,"title":"付款申请行信息保存","hidden":false,"roles":{"default":1},"children":[{"configs":{"serverScript":"// TODO: 查询采购结算付款申请明细的付款金额是否超过对应应付单的未申请金额\nvar recs = Wb.decode(request.getParameter('create'));\nWb.each(recs, function(rec) {\n  if(app.get('AP_DOC_CAT_CODE')=='CGJS'){\n    app.run('select 1 from xc_ap_inv_gl_h where AP_INV_GL_H_ID=\\''+rec.AP_INV_GL_H_ID+'\\' and (NO_PAY_AMT-OCCUPY_AMT-\\''+rec.AMOUNT+'\\')<0', {\n      errorText: '付款申请金额超过未申请金额。'\n    });\n  }\n  rec.CREATION_DATE = new Date();\n  rec.CREATED_BY = request.getSession().getAttribute(\"XzSessionVars\").get('userId');\n  rec.LAST_UPDATE_DATE = new Date();\n  rec.LAST_UPDATED_BY = request.getSession().getAttribute(\"XzSessionVars\").get('userId');\n  rec.AP_PAY_REQ_H_CODE = app.get('AP_PAY_REQ_H_CODE');\n});\nif(!Wb.isEmpty(recs)&&'[]'!=recs){\n  request.setAttribute('insertRows', Wb.encode(recs));\n  if(app.get('AP_DOC_CAT_CODE')=='CGJS'){\n    request.setAttribute('insertTransRows', request.getAttribute('insertRows'));\n  }\n}\n\nrecs = Wb.decode(request.getParameter('update'));\nWb.each(recs, function(rec) {\n  rec.LAST_UPDATE_DATE = new Date();\n  rec.LAST_UPDATED_BY = request.getSession().getAttribute(\"XzSessionVars\").get('userId');\n});\nif(!Wb.isEmpty(recs)&&'[]'!=recs){\n  request.setAttribute('updateRows', Wb.encode(recs));\n  if(app.get('AP_DOC_CAT_CODE')=='CGJS'){\n    request.setAttribute('updateTransRows', request.getAttribute('updateRows'));\n  }\n}\nrecs = Wb.decode(request.getParameter('destroy'));\nif(!Wb.isEmpty(recs)&&'[]'!=recs){\n  request.setAttribute('deleteRows', Wb.encode(recs));\n  if(app.get('AP_DOC_CAT_CODE')=='CGJS'){\n    request.setAttribute('deleteTransRows',  request.getAttribute('deleteRows'));\n  }\n}","itemId":"module"},"children":[{"configs":{"oracle":"insert into xc_ap_pay_req_l (\n  AP_PAY_REQ_L_ID,\n  AP_PAY_REQ_H_ID,\n  AP_INV_GL_H_ID,\n  AP_CONTRACT_ID,\n  AP_PUR_TYPE_ID,\n  BG_ITEM_ID,\n  AMOUNT,\n  PAID_AMT,\n  NO_PAY_AMT,\n  DESCRIPTION,\n  CREATION_DATE,\n  CREATED_BY,\n  LAST_UPDATE_DATE,\n  LAST_UPDATED_BY\n) values (\n  {?varchar.AP_PAY_REQ_L_ID?},\n  {?varchar.AP_PAY_REQ_H_ID?},\n  {?varchar.AP_INV_GL_H_ID?},\n  {?varchar.AP_CONTRACT_ID?},\n  {?varchar.AP_PUR_TYPE_ID?},\n  {?varchar.BG_ITEM_ID?},\n  {?decimal.AMOUNT?},\n  {?decimal.PAID_AMT?},\n  {?decimal.NO_PAY_AMT?},\n  {?varchar.DESCRIPTION?},\n  sysdate,\n  {?XIP.userId?},\n  sysdate,\n  {?XIP.userId?}\n)","itemId":"insert","mysql":"insert into xc_ap_pay_req_l (\n  AP_PAY_REQ_L_ID,\n  AP_PAY_REQ_H_ID,\n  AP_INV_GL_H_ID,\n  AP_CONTRACT_ID,\n  AP_PUR_TYPE_ID,\n  BG_ITEM_ID,\n  AMOUNT,\n  PAID_AMT,\n  NO_PAY_AMT,\n  DESCRIPTION,\n  CREATION_DATE,\n  CREATED_BY,\n  LAST_UPDATE_DATE,\n  LAST_UPDATED_BY\n) values (\n  {?varchar.AP_PAY_REQ_L_ID?},\n  {?varchar.AP_PAY_REQ_H_ID?},\n  {?varchar.AP_INV_GL_H_ID?},\n  {?varchar.AP_CONTRACT_ID?},\n  {?varchar.AP_PUR_TYPE_ID?},\n  {?varchar.BG_ITEM_ID?},\n  {?decimal.AMOUNT?},\n  {?decimal.PAID_AMT?},\n  {?decimal.NO_PAY_AMT?},\n  {?varchar.DESCRIPTION?},\n  SYSDATE(),\n  {?XIP.userId?},\n  SYSDATE(),\n  {?XIP.userId?}\n)"},"children":[],"expanded":false,"type":"sqlswitcher"},{"configs":{"oracle":"update xc_ap_inv_gl_h set \nOCCUPY_AMT = OCCUPY_AMT+{?decimal.AMOUNT?},\nLAST_UPDATE_DATE=sysdate,\nLAST_UPDATED_BY={?XIP.userId?}   \nwhere AP_INV_GL_H_ID={?varchar.AP_INV_GL_H_ID?}","itemId":"updateInvGlByInsert","mysql":"update xc_ap_inv_gl_h set \nOCCUPY_AMT = OCCUPY_AMT+{?decimal.AMOUNT?},\nLAST_UPDATE_DATE=SYSDATE(),\nLAST_UPDATED_BY={?XIP.userId?} \nwhere AP_INV_GL_H_ID={?varchar.AP_INV_GL_H_ID?}"},"children":[],"expanded":false,"type":"sqlswitcher"},{"configs":{"oracle":"update xc_ap_inv_gl_h set \n OCCUPY_AMT = OCCUPY_AMT-{?decimal.AMOUNT?},\n LAST_UPDATE_DATE=sysdate,\n LAST_UPDATED_BY={?XIP.userId?}   \nwhere AP_INV_GL_H_ID={?varchar.AP_INV_GL_H_ID?}","itemId":"updateInvGlByDelete","mysql":"update xc_ap_inv_gl_h set \nOCCUPY_AMT = OCCUPY_AMT-{?decimal.AMOUNT?},\nLAST_UPDATE_DATE=SYSDATE(),\nLAST_UPDATED_BY={?XIP.userId?} \nwhere AP_INV_GL_H_ID={?varchar.AP_INV_GL_H_ID?}"},"children":[],"expanded":false,"type":"sqlswitcher"},{"configs":{"oracle":"update xc_ap_pay_req_l set \n  AP_INV_GL_H_ID={?varchar.AP_INV_GL_H_ID?},\n  AP_CONTRACT_ID={?varchar.AP_CONTRACT_ID?},\n  AP_PUR_TYPE_ID={?varchar.AP_PUR_TYPE_ID?},\n  BG_ITEM_ID={?varchar.BG_ITEM_ID?},\n  AMOUNT={?decimal.AMOUNT?},\n  DESCRIPTION={?varchar.DESCRIPTION?},\n  LAST_UPDATE_DATE=sysdate,\n  LAST_UPDATED_BY={?XIP.userId?} \n where AP_PAY_REQ_L_ID={?varchar.AP_PAY_REQ_L_ID?}","itemId":"update","mysql":"update xc_ap_pay_req_l set \n  AP_INV_GL_H_ID={?varchar.AP_INV_GL_H_ID?},\n  AP_CONTRACT_ID={?varchar.AP_CONTRACT_ID?},\n  AP_PUR_TYPE_ID={?varchar.AP_PUR_TYPE_ID?},\n  BG_ITEM_ID={?varchar.BG_ITEM_ID?},\n  AMOUNT={?decimal.AMOUNT?},\n  DESCRIPTION={?varchar.DESCRIPTION?},\n  LAST_UPDATE_DATE=SYSDATE(),\n  LAST_UPDATED_BY={?XIP.userId?} \n where AP_PAY_REQ_L_ID={?varchar.AP_PAY_REQ_L_ID?}"},"children":[],"expanded":false,"type":"sqlswitcher"},{"configs":{"oracle":"INSERT INTO xc_ap_inv_trans (\nTRANS_ID,SOURCE_ID,SOURCE_DTL_ID,AP_INV_GL_H_ID,AP_PAY_H_ID,\nGL_DATE,SOURCE_TAB,AP_DOC_CAT_CODE,AP_CONTRACT_ID,VENDOR_ID,\nREQ_AMT,TRANS_STATUS,CCID,\nCREATION_DATE,CREATED_BY,LAST_UPDATE_DATE,LAST_UPDATED_BY,\nAP_DOC_CODE,DESCRIPTION\n) VALUES (\nUUID(),{?varchar.AP_PAY_REQ_H_ID?},{?varchar.AP_PAY_REQ_L_ID?},{?varchar.AP_INV_GL_H_ID?},{?varchar.AP_PAY_H_ID?},\nSYSDATE(),'XC_AP_PAY_REQ_H','SQ',(SELECT AP_CONTRACT_ID FROM xc_ap_inv_gl_h WHERE AP_INV_GL_H_ID={?varchar.AP_INV_GL_H_ID?}),(SELECT VENDOR_ID FROM xc_ap_inv_gl_h WHERE AP_INV_GL_H_ID={?varchar.AP_INV_GL_H_ID?}),\n{?decimal.AMOUNT?},'0',(SELECT AP_CCID_DEBT FROM xc_ap_inv_gl_h b WHERE b.AP_INV_GL_H_ID={?varchar.AP_INV_GL_H_ID?}),\nsysdate,{?XIP.userId?},sysdate,{?XIP.userId?},\n{?varchar.AP_PAY_REQ_H_CODE?},{?DESCRIPTION?}\n)","itemId":"insertTrans","mysql":"INSERT INTO xc_ap_inv_trans (\nTRANS_ID,SOURCE_ID,SOURCE_DTL_ID,AP_INV_GL_H_ID,AP_PAY_H_ID,\nGL_DATE,SOURCE_TAB,AP_DOC_CAT_CODE,AP_CONTRACT_ID,VENDOR_ID,\nREQ_AMT,TRANS_STATUS,CCID,\nCREATION_DATE,CREATED_BY,LAST_UPDATE_DATE,LAST_UPDATED_BY,\nAP_DOC_CODE,DESCRIPTION\n) VALUES (\nUUID(),{?varchar.AP_PAY_REQ_H_ID?},{?varchar.AP_PAY_REQ_L_ID?},{?varchar.AP_INV_GL_H_ID?},{?varchar.AP_PAY_H_ID?},\nSYSDATE(),'XC_AP_PAY_REQ_H','SQ',(SELECT AP_CONTRACT_ID FROM xc_ap_inv_gl_h WHERE AP_INV_GL_H_ID={?varchar.AP_INV_GL_H_ID?}),(SELECT VENDOR_ID FROM xc_ap_inv_gl_h WHERE AP_INV_GL_H_ID={?varchar.AP_INV_GL_H_ID?}),\n{?decimal.AMOUNT?},'0',(SELECT AP_CCID_DEBT FROM xc_ap_inv_gl_h b WHERE b.AP_INV_GL_H_ID={?varchar.AP_INV_GL_H_ID?}),\nSYSDATE(),{?XIP.userId?},SYSDATE(),{?XIP.userId?},\n{?varchar.AP_PAY_REQ_H_CODE?},{?DESCRIPTION?}\n)"},"children":[],"expanded":false,"type":"sqlswitcher"},{"configs":{"sql":"delete from xc_ap_inv_trans \n where SOURCE_ID={?varchar.AP_PAY_REQ_H_ID?} \n and SOURCE_DTL_ID={?varchar.AP_PAY_REQ_L_ID?}\n AND AP_INV_GL_H_ID = {?varchar.AP_INV_GL_H_ID?}","transaction":"start","arrayName":"deleteTransRows","itemId":"query1"},"children":[],"expanded":false,"type":"query"},{"configs":{"sql":"{#updateInvGlByDelete#}","arrayName":"deleteRows","itemId":"query2"},"children":[],"expanded":false,"type":"query"},{"configs":{"sql":"{#insertTrans#}","arrayName":"insertTransRows","itemId":"query3"},"children":[],"expanded":false,"type":"query"},{"configs":{"sql":"{#updateInvGlByInsert#}","arrayName":"insertRows","itemId":"query4"},"children":[],"expanded":false,"type":"query"},{"configs":{"sql":"delete from xc_ap_pay_req_l where AP_PAY_REQ_L_ID={?varchar.AP_PAY_REQ_L_ID?}","arrayName":"deleteRows","itemId":"query5"},"children":[],"expanded":false,"type":"query"},{"configs":{"sql":"{#update#}","arrayName":"updateRows","itemId":"query6"},"children":[],"expanded":false,"type":"query"},{"configs":{"sql":"{#insert#}","arrayName":"insertRows","itemId":"query7"},"children":[],"expanded":false,"type":"query"}],"expanded":true,"type":"module"}],"pageLink":"","iconCls":""}