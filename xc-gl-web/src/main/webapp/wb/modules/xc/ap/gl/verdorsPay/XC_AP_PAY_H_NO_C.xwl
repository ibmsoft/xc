{"inframe":false,"title":"拆分出来的应付单无容器模式","hidden":false,"roles":{"default":1},"children":[{"configs":{"serverScript":"var contextPath = request.getContextPath();\nrequest.setAttribute(\"contextPath\",contextPath);\ncom.xzsoft.xip.platform.util.XipUtil.getCurrentLang(request,'xc/ap/gl/verdorsPay/json/XC_AP_PAY_H_NO_C');","itemId":"module"},"events":{"initialize":"Wb.isInsert = 'Y'; //操作类型\nvar init = '0';\nExt.apply(app, {\n  initWin: function(params) {\n    Ext.apply(app, params);\n    app.editWinN = new Ext.window.Window(app.editWinN);\n    app.editWinN.show();\n    Wb.AP_PAY_H_ID = params.AP_PAY_H_ID;\n    Wb.IsInsert = params.IS_INSERT;\n    if (Wb.IsInsert == 'Y') {\n      init = '0';\n    } else {\n      init = '1';\n      Wb.AP_PAY_VENDOR_H_ID = params.AP_PAY_VENDOR_H_ID;\n    }\n    Wb.request({\n      url: 'm?xwl=xc/ap/gl/verdorsPay/DB/LOV_XC_AP_PAY_DETAIL_H',\n      //后台java代码生成\n      method: 'POST',\n      async: false,\n      //异步传参\n      params: {\n        AP_PAY_H_ID: Wb.AP_PAY_H_ID,\n        INIT: init\n      },\n      success: function(resp) {\n        var r = Wb.decode(resp.responseText);\n        Wb.request({\n          url: 'm?xwl=xc/ap/gl/vendors/DB/XC_AP_SELECT_DATE',\n          //后台java代码生成\n          method: 'POST',\n          async: false,\n          //异步传参\n          params: {\n            LEDGER_ID:r.LEDGER_ID\n          },\n          success: function(respDate) {\n\n            var rDate = Wb.decode(respDate.responseText);\n\n            r.GL_DATE = rDate.LAST_M_DATE;\n            Wb.setValue(app.editWinN, r);\n            if(Wb.IsInsert == 'Y'){\n              Wb.request({\n                url:'m?xwl=xc/ap/gl/verdorsPay/DB/getSplitAmount',\n                params:{'AP_PAY_H_ID':Wb.AP_PAY_H_ID,'sql':'1=1'},\n                success:function(resp){\n                  var rec = Wb.decode(resp.responseText);\n                  app.AMOUNT.setValue(rec.rows[0].amount);\n                }\n              });\n            }\n\n\n            if(r.VENDOR_ID=='00'){\n              app.VENDOR_ID_XWL.VENDOR_NAME.setReadOnly(false);\n              app.VENDOR_ID_XWL.QUERY_LEDGER_ID.setValue(r.LEDGER_ID);\n            }else{\n              app.VENDOR_ID_XWL.VENDOR_NAME.setReadOnly(true);\n            }\n            app.AP_CONTRACT_ID_XWL.QUERY_LEDGER_ID.setValue(r.LEDGER_ID);\n            app.AP_CONTRACT_ID_XWL.QUERY_VENDOR_ID.setValue(app.VENDOR_ID_XWL.VENDOR_ID.getValue());\n            app.AP_CONTRACT_ID_XWL.AP_CONTRACT_NAME.allowBlank =false;\n            app.AP_CONTRACT_ID_XWL.AP_CONTRACT_NAME.setFieldLabel('<font color=\"red\">*<\/font>合同');\n            app.PROJECT_ID_XWL.QUERY_LEDGER_ID.setValue(r.LEDGER_ID);\n            app.DEPT_ID_XWL.QUERY_LEDGER_ID.setValue(r.LEDGER_ID);\n            app.LEDGER_ID_XWL.LEDGER_NAME.setReadOnly(true);\n            app.AP_PAY_ACC_ID_XWL.PAY_ACC_NAME.setReadOnly(true);\n            if (Wb.IsInsert == 'Y') {\n              app.AP_PAY_VENDOR_H_ID.setValue(Wb.AP_PAY_H_ID);\n              app.AP_PAY_H_ID.setValue(Xip.getId());\n            }\n\n          }\n        });\n\n      }\n    });\n\n  }\n});\n\nfunction returnRowFn(r, type) {\n  if (type == 'xc_gl_ledgers') {\n    app.VENDOR_ID_XWL.QUERY_LEDGER_ID.setValue(r.data.LEDGER_ID);\n    app.PROJECT_ID_XWL.QUERY_LEDGER_ID.setValue(r.data.LEDGER_ID);\n    app.DEPT_ID_XWL.QUERY_LEDGER_ID.setValue(r.data.LEDGER_ID);\n    app.AP_PAY_ACC_ID_XWL.QUERY_LEDGER_ID.setValue(r.data.LEDGER_ID);\n  }\n  if(type==\"xip_pub_depts\"){\n    app.PROJECT_ID_XWL.QUERY_DEPT_ID.setValue(r.data.DEPT_ID);\n    app.AP_CONTRACT_ID_XWL.AP_CONTRACT_NAME.setValue('');\n  }\n  if(type == 'xc_ap_vendors'){\n    app.AP_CONTRACT_ID_XWL.QUERY_VENDOR_ID.setValue(r.data.VENDOR_ID);\n     app.PROJECT_ID_XWL.PROJECT_NAME.setValue('');\n  }\n}\nfunction clearOtherFn(type) {\n  if (type == 'xc_gl_ledgers') {}\n  if(type == 'xc_ap_vendors'){\n    app.AP_CONTRACT_ID_XWL.AP_CONTRACT_NAME.setValue('');\n  }\n  if(type==\"xip_pub_depts\"){\n    app.PROJECT_ID_XWL.PROJECT_NAME.setValue('');\n  }\n}"},"children":[{"configs":{"itemId":"winTbar"},"children":[{"configs":{"text":"{#save#}","itemId":"saveBtn","iconCls":"save_icon"},"events":{"click":"if(app.AMOUNT.getValue()==0){\n  Wb.toast('{#saveMsg4#}');\n  return;\n}\nif (Wb.IsInsert == 'Y') {\n  Wb.request({\n    url:'m?xwl=xc/ap/gl/verdorsPay/DB/getSplitAmount',\n    params:{'AP_PAY_H_ID': Wb.AP_PAY_H_ID,'sql':'1=1'},\n    success:function(resp){\n      var rec = Wb.decode(resp.responseText);\n      if(app.AMOUNT.getValue()>rec.rows[0].amount){\n        Wb.toast('{#editorMsg1#}');\n        app.AMOUNT.setValue(rec.rows[0].amount);\n      }else{\n        if (app.form1.isValid()) {\n          Wb.request({\n            url: 'm?xwl=xc/ap/gl/verdorsPay/DB/XC_AP_PAY_H_PUB_ERROR_ALERT',\n            params: {\n              AP_PAY_H_ID: app.AP_PAY_H_ID.getValue(),\n              AP_PAY_VENDOR_H_ID: app.AP_PAY_VENDOR_H_ID.getValue(),\n              AMOUNT:app.AMOUNT.getValue(),\n              sql: 'SELECT 1 '+\n              ' FROM xc_ap_pay_h WHERE AP_PAY_H_ID={?AP_PAY_VENDOR_H_ID?} '+\n              ' and ABS(AMOUNT)+ '+\n              ' IFNULL((SELECT ABS(AMOUNT) '+\n              ' FROM xc_ap_pay_h WHERE AP_PAY_H_ID={?AP_PAY_H_ID?} ),0)- '+\n              ' IFNULL((SELECT SUM(ABS(AMOUNT))+{?decimal.AMOUNT?} '+\n              ' FROM xc_ap_pay_h WHERE AP_PAY_VENDOR_H_ID={?AP_PAY_VENDOR_H_ID?} ),{?decimal.AMOUNT?})<0 ',\n              errorMsg: '{#saveMsg1#}'\n            },\n            success: function(resp) {\n              Wb.request({\n                url:'{#contextPath#}'+'/apInvGlCommonAction.do?method=splitYuF',\n                params:{'json':Wb.getValue(app.form1)},\n                success:function(resp){\n                  var rec = Wb.decode(resp.responseText);\n                  if(rec.flag=='0'){\n                    Wb.info('{#saveMsg2#}');\n                    Wb.IsInsert = 'N';\n                    app.AP_PAY_H_CODE.setValue(rec.code);\n                  }if(rec.flag=='1'){\n                    Wb.info(rec.msg);                  \n                  }\n                }\n              });\n            }\n          });\n        } else {\n          Wb.toast('{#saveMsg3#}');\n          return;\n        }\n      }\n    }\n  });\n\n}else{\n  var sql = 'b.AP_PAY_H_ID !='+\"'\"+ Wb.AP_PAY_H_ID+\"'\";\n  Wb.request({\n    url:'m?xwl=xc/ap/gl/verdorsPay/DB/getSplitAmount1',\n    params:{'AP_PAY_H_ID': app.AP_PAY_VENDOR_H_ID.getValue(),'sql':sql,'payHId':app.AP_PAY_H_ID.getValue()},\n    success:function(resp){\n      var rec = Wb.decode(resp.responseText);\n      if(app.AMOUNT.getValue()>rec.rows[0].amount){\n        Wb.toast('{#editorMsg1#}');\n        app.AMOUNT.setValue(rec.rows[0].amount);\n      }else{\n        if (app.form1.isValid()) {\n          Wb.request({\n            url: 'm?xwl=xc/ap/gl/verdorsPay/DB/XC_AP_PAY_H_PUB_ERROR_ALERT',\n            params: {\n              AP_PAY_H_ID: app.AP_PAY_H_ID.getValue(),\n              AP_PAY_VENDOR_H_ID: app.AP_PAY_VENDOR_H_ID.getValue(),\n              AMOUNT:app.AMOUNT.getValue(),\n              sql: 'SELECT 1 '+\n              ' FROM xc_ap_pay_h WHERE AP_PAY_H_ID={?AP_PAY_VENDOR_H_ID?} '+\n              ' and ABS(AMOUNT)+ '+\n              ' IFNULL((SELECT ABS(AMOUNT) '+\n              ' FROM xc_ap_pay_h WHERE AP_PAY_H_ID={?AP_PAY_H_ID?} ),0)- '+\n              ' IFNULL((SELECT SUM(ABS(AMOUNT))+{?decimal.AMOUNT?} '+\n              ' FROM xc_ap_pay_h WHERE AP_PAY_VENDOR_H_ID={?AP_PAY_VENDOR_H_ID?} ),{?decimal.AMOUNT?})<0 ',\n              errorMsg: '{#saveMsg1#}'\n            },\n            success: function(resp) {\n              Wb.request({\n                url:'{#contextPath#}'+'/apInvGlCommonAction.do?method=splitYuF',\n                params:{'json':Wb.getValue(app.form1)},\n                success:function(resp){\n                  var rec = Wb.decode(resp.responseText);\n                  if(rec.flag=='0'){\n                    Wb.info('{#saveMsg2#}');\n                    Wb.IsInsert = 'N';\n                    app.AP_PAY_H_CODE.setValue(rec.code);\n                  }if(rec.flag=='1'){\n                    Wb.info(rec.msg);                  \n                  }\n                }\n              });\n            }\n          });\n        } else {\n          Wb.toast('{#saveMsg3#}');\n          return;\n        }\n      }\n    }\n  });\n\n}\n"},"children":[],"expanded":false,"type":"button"}],"expanded":true,"type":"toolbar"},{"configs":{"tbar":"app.winTbar","maximized":"true","layout":"fit","itemId":"editWinN"},"events":{"close":"app.hideFun();"},"children":[{"configs":{"region":"north","itemId":"form1","border":"false"},"children":[{"configs":{"text":"{#prePay_distribute#}","style":"fontSize:20px","margin":"10 0 20 0","labelAlign":"center","itemId":"label1"},"children":[],"expanded":false,"type":"label"},{"configs":{"tagConfigs":"baseCls : 'my-panel-no-border'","layout":"column","itemId":"tr1"},"children":[{"configs":{"tagConfigs":"baseCls : 'my-panel-no-border'","layout":"form","columnWidth":".245","itemId":"td_1_1"},"children":[{"configs":{"file":"m?xwl=xc/com-lov/LEDGER_ID_PICK/LEDGER_ID_PICK_SEC","itemId":"LEDGER_ID_XWL"},"children":[],"expanded":false,"type":"xwl"},{"configs":{"hidden":"true","itemId":"AP_PAY_H_ID"},"children":[],"expanded":false,"type":"text"},{"configs":{"hidden":"true","itemId":"AP_PAY_VENDOR_H_ID"},"children":[],"expanded":false,"type":"text"},{"configs":{"hidden":"true","itemId":"INIT"},"children":[],"expanded":false,"type":"text"},{"configs":{"hidden":"true","value":"{#XIP.userId#}","itemId":"USER_ID","fieldLabel":"USER_ID"},"children":[],"expanded":false,"type":"text"}],"expanded":true,"type":"panel"},{"configs":{"tagConfigs":"baseCls : 'my-panel-no-border'","layout":"form","columnWidth":".245","itemId":"td_1_2"},"children":[{"configs":{"labelWidth":"80","readOnly":"true","allowBlank":"false","labelAlign":"right","pickList":"[['FKD_YUFK','{#payDocPre#}']]","itemId":"AP_DOC_CAT_CODE","fieldLabel":"<span style=\"color: rgb(255, 0, 0);\">*<\/span>{#docType#}"},"children":[],"expanded":false,"type":"combo"}],"expanded":true,"type":"panel"},{"configs":{"tagConfigs":"baseCls : 'my-panel-no-border'","layout":"form","columnWidth":".245","itemId":"td_1_3"},"children":[{"configs":{"labelWidth":"80","readOnly":"true","labelAlign":"right","itemId":"AP_PAY_H_CODE","fieldLabel":"<span style=\"color: rgb(255, 0, 0);\">*<\/span>{#docCode#}"},"children":[],"expanded":false,"type":"text"}],"expanded":true,"type":"panel"},{"configs":{"tagConfigs":"baseCls : 'my-panel-no-border'","layout":"form","columnWidth":".245","itemId":"td_1_4"},"children":[{"configs":{"labelWidth":"80","readOnly":"true","labelAlign":"right","itemId":"GL_DATE","fieldLabel":"<span style=\"color: rgb(255, 0, 0);\">*<\/span>{#glDate#}"},"children":[],"expanded":false,"type":"date"}],"expanded":true,"type":"panel"}],"expanded":true,"type":"panel"},{"configs":{"tagConfigs":"baseCls : 'my-panel-no-border'","layout":"column","itemId":"tr2"},"children":[{"configs":{"tagConfigs":"baseCls : 'my-panel-no-border'","layout":"form","columnWidth":".245","itemId":"td_2_1"},"children":[{"configs":{"file":"m?xwl=xc/ap/gl/VENDOR_ID_PICK/VENDOR_ID_LD","itemId":"VENDOR_ID_XWL"},"children":[],"expanded":false,"type":"xwl"}],"expanded":true,"type":"panel"},{"configs":{"tagConfigs":"baseCls : 'my-panel-no-border'","layout":"form","columnWidth":".245","itemId":"td_1_3"},"children":[{"configs":{"file":"m?xwl=xc/ap/gl/DEPT_ID_PICK/DEPT_ID_LD","itemId":"DEPT_ID_XWL"},"children":[],"expanded":false,"type":"xwl"}],"expanded":false,"type":"panel"},{"configs":{"tagConfigs":"baseCls : 'my-panel-no-border'","layout":"form","columnWidth":".245","itemId":"td_2_2"},"children":[{"configs":{"file":"m?xwl=xc/com-lov/PROJECT_ID_PICK/PROJECT_ID_LD","itemId":"PROJECT_ID_XWL"},"children":[],"expanded":false,"type":"xwl"}],"expanded":false,"type":"panel"},{"configs":{"tagConfigs":"baseCls : 'my-panel-no-border'","layout":"form","columnWidth":".245","itemId":"td_2_4"},"children":[{"configs":{"file":"m?xwl=xc/ap/ap-com-lov/AP_CONTRACT_ID_PICK/AP_CONTRACT_ID_PICK_ALL","itemId":"AP_CONTRACT_ID_XWL"},"children":[],"expanded":false,"type":"xwl"}],"expanded":true,"type":"panel"}],"expanded":true,"type":"panel"},{"configs":{"tagConfigs":"baseCls : 'my-panel-no-border'","layout":"column","itemId":"tr3"},"children":[{"configs":{"tagConfigs":"baseCls : 'my-panel-no-border'","layout":"form","columnWidth":".245","itemId":"td_3_1"},"children":[{"configs":{"file":"m?xwl=xc/ap/ap-com-lov/ACC_ID_PICK/PAY_ACC_ID_PICK","itemId":"AP_PAY_ACC_ID_XWL"},"children":[],"expanded":false,"type":"xwl"}],"expanded":true,"type":"panel"},{"configs":{"tagConfigs":"baseCls : 'my-panel-no-border'","layout":"form","columnWidth":".245","itemId":"td_3_2"},"children":[{"configs":{"labelWidth":"80","allowBlank":"false","minValue":"0","labelAlign":"right","itemId":"AMOUNT","fieldLabel":"<span style=\"color: rgb(255, 0, 0);\">*<\/span>{#amount#}"},"children":[],"expanded":false,"type":"number"}],"expanded":true,"type":"panel"},{"configs":{"tagConfigs":"baseCls : 'my-panel-no-border'","layout":"form","columnWidth":".490","itemId":"td_3_3"},"children":[{"configs":{"labelWidth":"80","allowBlank":"false","labelAlign":"right","itemId":"DESCRIPTION","fieldLabel":"<span style=\"color: rgb(255, 0, 0);\">*<\/span>{#description#}"},"children":[],"expanded":false,"type":"text"}],"expanded":true,"type":"panel"}],"expanded":true,"type":"panel"},{"configs":{"hidden":"true","itemId":"PAY_CCID"},"children":[],"expanded":false,"type":"text"}],"expanded":true,"type":"form"}],"expanded":true,"type":"window"}],"expanded":true,"type":"module"}],"pageLink":"{container:false}","iconCls":""}