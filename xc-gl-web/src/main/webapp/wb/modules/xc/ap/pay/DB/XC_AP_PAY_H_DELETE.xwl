{"inframe":false,"title":"","hidden":false,"roles":{"default":1},"children":[{"configs":{"serverScript":"// TODO: 首先判断审核状态是否是审核通过状态，是的话不让删除\nvar recs = Wb.decode(request.getParameter('destroy'));\nvar  rs, meta, row, p_cgjs_rows = [],p_yufk_rows = [],p_qtfk_rows = [] , p_pay_l_rows = [];\nWb.each(recs, function(rec) {\n    app.run('SELECT 1 FROM xc_ap_pay_h WHERE AP_PAY_H_ID=\\''+rec.AP_PAY_H_ID+'\\' AND V_STATUS >=3 ',{ \n       errorText:'此付款单凭证已经审核通过，不允许删除'\n\t});\n \n// TODO: 判断是否采购结算或者采购结算红字，不管是申请单还是应付单都是针对应付单做的付款，删除付款单后要把钱还到应付单的未付金额。\nif('FKD_CGJS'==rec.AP_DOC_CAT_CODE||'FKD_CGJS-H'==rec.AP_DOC_CAT_CODE){\n  //Wb.each(recs, function(rec) {\n    rs = app.run('select * from xc_ap_pay_l where AP_PAY_H_ID=\\''+rec.AP_PAY_H_ID+'\\'');\n    meta = rs.getMetaData();\n    while (rs.next()) {\n      row = Wb.getRecord(rs, meta);\n      p_cgjs_rows.push(row);\n    }\n  //});\n}\nif('FKD_YUFK'==rec.AP_DOC_CAT_CODE||'FKD_YUFK-H'==rec.AP_DOC_CAT_CODE){\n  p_yufk_rows.push(rec);\n}\nif('FKD_QTFK'==rec.AP_DOC_CAT_CODE||'FKD_QTFK-H'==rec.AP_DOC_CAT_CODE){\n  p_qtfk_rows.push(rec);\n}\nrs = app.run('select * from xc_ap_pay_l where AP_PAY_H_ID=\\''+rec.AP_PAY_H_ID+'\\'');\n    meta = rs.getMetaData();\n    while (rs.next()) {\n      row = Wb.getRecord(rs, meta);\n      p_pay_l_rows.push(row);\n    }\n});\nrequest.setAttribute('deleteYfkTransRows',Wb.encode(p_yufk_rows));\nrequest.setAttribute('deleteQtfkTransRows',Wb.encode(p_qtfk_rows));\nrequest.setAttribute('deleteCgjsTransRows',Wb.encode(p_cgjs_rows));\nrequest.setAttribute('updateReqRows',Wb.encode(p_pay_l_rows));\n\n\n\n\n","itemId":"module"},"children":[{"configs":{"sql":"delete from xc_ap_pay_l where AP_PAY_H_ID={?varchar.AP_PAY_H_ID?}","transaction":"start","arrayName":"destroy","itemId":"query1"},"children":[],"expanded":false,"type":"query"},{"configs":{"sql":"delete from xc_ap_pay_h where AP_PAY_H_ID={?varchar.AP_PAY_H_ID?}","arrayName":"destroy","itemId":"query2"},"children":[],"expanded":false,"type":"query"},{"configs":{"sql":"delete from xc_ap_inv_trans where SOURCE_ID = {?AP_PAY_H_ID?} and AP_DOC_CAT_CODE='YUFK'","arrayName":"deleteYfkTransRows","itemId":"query3"},"children":[],"expanded":false,"type":"query"},{"configs":{"sql":"delete from xc_ap_inv_trans where SOURCE_ID = {?AP_PAY_H_ID?} and AP_DOC_CAT_CODE='FK'","arrayName":"deleteQtfkTransRows","itemId":"query4"},"children":[],"expanded":false,"type":"query"},{"configs":{"sql":"delete from xc_ap_inv_trans where SOURCE_ID = {?AP_PAY_H_ID?} and SOURCE_DTL_ID={?AP_INV_GL_L_ID?} and AP_DOC_CAT_CODE='FK'","arrayName":"deleteCgjsTransRows","itemId":"query5"},"children":[],"expanded":false,"type":"query"},{"configs":{"sql":"update xc_ap_inv_gl_h set \nPAID_AMT=PAID_AMT-{?decimal.AMOUNT?},\nNO_PAY_AMT=NO_PAY_AMT+{?decimal.AMOUNT?} where \n AP_INV_GL_H_ID = {?varchar.AP_INV_GL_H_ID?}","arrayName":"deleteCgjsTransRows","itemId":"query6"},"children":[],"expanded":false,"type":"query"},{"configs":{"sql":"update xc_ap_pay_req_h set \nPAID_AMT=PAID_AMT-{?decimal.AMOUNT?},\nNO_PAY_AMT=NO_PAY_AMT+{?decimal.AMOUNT?} where \n AP_PAY_REQ_H_ID = {?varchar.AP_PAY_REQ_H_ID?}","arrayName":"updateReqRows","itemId":"query7"},"children":[],"expanded":false,"type":"query"}],"expanded":true,"type":"module"}],"pageLink":"","iconCls":""}