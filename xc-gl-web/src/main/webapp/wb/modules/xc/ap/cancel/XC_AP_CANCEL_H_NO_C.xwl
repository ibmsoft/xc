{"inframe":false,"title":"","hidden":false,"roles":{"default":1},"children":[{"configs":{"serverScript":"// 获取模块语言对应的json文件\ncom.xzsoft.xip.platform.util.XipUtil.getCurrentLang(request,\"xc/ap/cancel/XC_AP_CANCEL\");\n\nvar contextPath = request.getContextPath();\nrequest.setAttribute(\"contextPath\",contextPath);\n\nrequest.setAttribute('opmode','view');\nrequest.setAttribute('vtype','normal');\n","itemId":"module"},"events":{"initialize":"Wb.keyValue = '';\nWb.isInsert = 'Y';\nWb.apCancelType = 'YFHYUF';\nWb.ap_inv_gl_h_id = '';//应付单id\nWb.ap_inv_h_id = '';//采购发票id\nWb.flag = '';\nWb.recordFormData = null;//记录表单数据\n\nExt.apply(app, {\n  initWin: function(params) {\n    Ext.apply(app, params);\n    app.editWinN = new Ext.window.Window(app.editWinN);\n    app.editWinN.show();\n\n    app.AP_CANCEL_TYPE.setValue(params.AP_CANCEL_TYPE);\n    Wb.isInsert = params.IS_INSERT;\n    Wb.keyValue = params.AP_CANCEL_H_ID;\n    Wb.apCancelType = params.AP_CANCEL_TYPE;\n    Wb.ap_inv_gl_h_id = params.AP_INV_GL_H_ID;\n    Wb.ap_inv_h_id = params.AP_INV_H_ID;\n    Wb.flag = params.flag;\n\n\n    //隐藏新增按钮\n    if(Wb.flag == 'cancel'){\n      app.addBtn.hide();\n    }\n    if(Wb.isInsert=='Y'){\n      app.AP_CANCEL_H_ID.setValue(Xip.getId());\n      app.GL_DATE.setValue(new Date());\n      app.verfyBtn.setDisabled(true);\n      app.cancelVerfyBtn.setDisabled(true);\n      \n      app.grid1.getStore().reload({params:{\n        AP_CANCEL_H_ID:app.AP_CANCEL_H_ID.getValue()\n      }});\n\n      //判断应付单id是否为空\n      if(!Wb.isEmpty(Wb.ap_inv_gl_h_id)){\n        Wb.request({\n          url: 'm?xwl=xc/ap/gl/DB/XC_AP_INV_GL_H_SELECT_BY_ID',\n          params: {AP_INV_GL_H_ID:Wb.ap_inv_gl_h_id},\n          success: function(resp) {\n            var r = Wb.decode(resp.responseText);\n            app.LEDGER_ID_XWL.LEDGER_ID.setValue(r.LEDGER_ID);\n            app.LEDGER_ID_XWL.LEDGER_NAME.setValue(r.LEDGER_NAME);\n            updateGlDATEMinValue(r.LEDGER_ID);//修改业务日期最小值\n            app.AP_INV_GL_H_ID_XWL.AP_INV_GL_H_ID.setValue(Wb.ap_inv_gl_h_id);\n            app.AP_INV_GL_H_ID_XWL.AP_INV_GL_H_CODE.setValue(r.AP_INV_GL_H_CODE);\n            app.VENDOR_ID_XWL.VENDOR_ID.setValue(r.VENDOR_ID);\n            app.VENDOR_ID_XWL.VENDOR_NAME.setValue(r.VENDOR_NAME);\n            app.SRC_ID.setValue(Wb.ap_inv_gl_h_id);\n            app.AP_INV_GL_H_ID.setValue(Wb.ap_inv_gl_h_id);\n            app.LEDGER_ID_XWL.LEDGER_NAME.setReadOnly(true);\n            app.AP_INV_GL_H_ID_XWL.AP_INV_GL_H_CODE.setReadOnly(true);\n            app.VENDOR_ID_XWL.VENDOR_NAME.setReadOnly(true);\n            app.SRC_AMT.setReadOnly(true);\n            app.AP_CONTRACT_ID.setValue(r.AP_CONTRACT_ID);\n\n          }\n        });\n      }\n      //判断采购发票id是否为空\n      if(!Wb.isEmpty(Wb.ap_inv_h_id)){\n        Wb.request({\n          url: 'm?xwl=xc/ap/gl/DB/XC_AP_INV_PRE_SELECT',\n          params: {\n            AP_INV_H_ID:Wb.ap_inv_h_id,\n            AP_CANCEL_H_ID:app.AP_CANCEL_H_ID.getValue(),\n            AP_CANCEL_TYPE:'YFHYUF'\n          },\n          success: function(resp) {\n            var r = Wb.decode(resp.responseText);\n            var i = 0;\n            Wb.each(r.rows, function(row) {\n              app.grid1.getStore().add(row);\n            });\n          }\n        });\n      }\n\n      //若应付单id和采购发票id都为空，则进行初始化操作\n      if(Ext.isEmpty(Wb.ap_inv_gl_h_id) && Ext.isEmpty(Wb.ap_inv_h_id)){\n        app.ldInitStore.load();\n      }\n\n    }//Y结束\n\n    if(Wb.isInsert=='N'){\n      Wb.request({\n        url: 'm?xwl=xc/ap/cancel/DB/XC_AP_CANCEL_H_SELECT_BY_ID',\n        params: {AP_CANCEL_H_ID:Wb.keyValue},\n        success: function(resp) {\n          var r = Wb.decode(resp.responseText);\n          if(r.V_STATUS == \"1\" || r.V_STATUS === '' || r.V_STATUS === null){\n            app.saveBtn.setDisabled(false);\n            app.verfyBtn.setDisabled(false);\n            app.cancelVerfyBtn.setDisabled(true);\n          }else{\n            app.saveBtn.setDisabled(true);\n            app.verfyBtn.setDisabled(true);\n            app.cancelVerfyBtn.setDisabled(false);\n          }\n          \n          r.GL_DATE=Wb.strToDate(r.GL_DATE);\n          Wb.setValue(app.editWinN,r);\n          updateGlDATEMinValue(r.LEDGER_ID);//修改业务日期最小值\n          \n          app.LEDGER_ID_XWL.LEDGER_NAME.setReadOnly(true);\n          Wb.apCancelType = r.AP_CANCEL_TYPE;\n          \n          app.VENDOR_ID_XWL.QUERY_LEDGER_ID.setValue(r.LEDGER_ID);\n          app.AP_INV_GL_H_ID_XWL.QUERY_LEDGER_ID.setValue(r.LEDGER_ID);\n          app.AP_INV_GL_H_ID_XWL.QUERY_VENDOR_ID.setValue(r.VENDOR_ID);\n          app.AP_INV_GL_H_ID_XWL.QUERY_CANCEL_TYPE.setValue(r.AP_CANCEL_TYPE);\n          app.AP_PAY_H_ID_XWL.QUERY_LEDGER_ID.setValue(r.LEDGER_ID);\n          app.AP_PAY_H_ID_XWL.QUERY_VENDOR_ID.setValue(r.VENDOR_ID);\n          \n          app.grid1.getStore().reload({params:{\n            AP_CANCEL_H_ID:Wb.keyValue\n          }});\n\n          Wb.recordFormData = Wb.encode(Wb.getValue(app.form1));//记录表单数据\n\n        }\n      });\n    }\n\n    if(Wb.isInsert=='S'){\n      Wb.request({\n        url: 'm?xwl=xc/ap/cancel/DB/XC_AP_CANCEL_H_SELECT_BY_ID',\n        params: {AP_CANCEL_H_ID:Wb.keyValue},\n        success: function(resp) {\n          var r = Wb.decode(resp.responseText);\n          r.GL_DATE=Wb.strToDate(r.GL_DATE);\n          Wb.setValue(app.editWinN,r);\n          updateGlDATEMinValue(r.LEDGER_ID);//修改业务日期最小值\n          app.AP_INV_GL_H_ID_XWL.QUERY_VENDOR_ID.setValue(r.VENDOR_ID);\n          app.AP_PAY_H_ID_XWL.QUERY_VENDOR_ID.setValue(r.VENDOR_ID);\n          Wb.apCancelType = r.AP_CANCEL_TYPE;\n          app.grid1.getStore().reload({params:{\n            AP_CANCEL_H_ID:Wb.keyValue\n          }});\n\n          Wb.recordFormData = Wb.encode(Wb.getValue(app.form1));//记录表单数据\n        }\n      });\n      app.form1Tbar.hide();\n      app.grid1Tbar.hide();\n      //置灰ReadOnly true\n      app.LEDGER_ID_XWL.LEDGER_NAME.setReadOnly(true);\n      app.GL_DATE.setReadOnly(true);\n      app.VENDOR_ID_XWL.VENDOR_NAME.setReadOnly(true);\n      app.AP_INV_GL_H_ID_XWL.AP_INV_GL_H_CODE.setReadOnly(true);\n      app.AP_PAY_H_ID_XWL.AP_PAY_H_CODE.setReadOnly(true);\n      app.DESCRIPTION.setReadOnly(true);\n    }\n    app.LEDGER_ID_XWL.LEDGER_NAME.allowBlank=false;\n  }\n});\nfunction returnRowFn(r,type){\n  if(type=='xc_gl_ledgers'){\n    updateGlDATEMinValue(r.data.LEDGER_ID);//修改业务日期最小值\n    //供应商\n    app.VENDOR_ID_XWL.QUERY_LEDGER_ID.setValue(r.data.LEDGER_ID);\n    app.VENDOR_ID_XWL.VENDOR_ID.reset();\n    app.VENDOR_ID_XWL.VENDOR_NAME.reset();\n    //应付单\n    app.AP_INV_GL_H_ID_XWL.QUERY_LEDGER_ID.setValue(r.data.LEDGER_ID);\n    app.AP_INV_GL_H_ID_XWL.QUERY_VENDOR_ID.reset();\n    app.AP_INV_GL_H_ID_XWL.AP_INV_GL_H_ID.reset();\n    app.AP_INV_GL_H_ID_XWL.AP_INV_GL_H_CODE.reset();\n    //付款单\n    app.AP_PAY_H_ID_XWL.QUERY_LEDGER_ID.setValue(r.data.LEDGER_ID);\n    app.AP_PAY_H_ID_XWL.QUERY_VENDOR_ID.reset();\n    app.AP_PAY_H_ID_XWL.AP_PAY_H_ID.reset();\n    app.AP_PAY_H_ID_XWL.AP_PAY_H_CODE.reset();\n    app.grid1.store.removeAll();\n  }\n  if (type == 'xc_ap_vendors') {\n    app.AP_INV_GL_H_ID_XWL.QUERY_VENDOR_ID.setValue(r.data.VENDOR_ID);\n    app.AP_PAY_H_ID_XWL.QUERY_VENDOR_ID.setValue(r.data.VENDOR_ID);\n    //应付单\n    app.AP_INV_GL_H_ID_XWL.AP_INV_GL_H_ID.reset();\n    app.AP_INV_GL_H_ID_XWL.AP_INV_GL_H_CODE.reset();\n    //付款单\n    app.AP_PAY_H_ID_XWL.AP_PAY_H_ID.reset();\n    app.AP_PAY_H_ID_XWL.AP_PAY_H_CODE.reset();\n    //其它\n    app.SRC_ID.reset();\n    app.grid1.store.removeAll();\n  }\n  if(type=='xc_ap_inv_gl_h'){\n    app.SRC_ID.setValue(r.data.AP_INV_GL_H_ID);\n  }\n  if(type=='xc_ap_pay_h'){\n    app.SRC_ID.setValue(r.data.AP_PAY_H_ID);\n  }\n\n}\n\nfunction clearOtherFn(type){\n  if(type=='xc_gl_ledgers'){\n    //账簿\n    app.LEDGER_ID_XWL.LEDGER_ID.reset();\n    app.LEDGER_ID_XWL.LEDGER_NAME.reset();\n    //供应商\n    app.VENDOR_ID_XWL.QUERY_LEDGER_ID.reset();\n    app.VENDOR_ID_XWL.VENDOR_ID.reset();\n    app.VENDOR_ID_XWL.VENDOR_NAME.reset();\n    //应付单\n    app.AP_INV_GL_H_ID_XWL.QUERY_LEDGER_ID.reset();\n    app.AP_INV_GL_H_ID_XWL.QUERY_VENDOR_ID.reset();\n    app.AP_INV_GL_H_ID_XWL.AP_INV_GL_H_ID.reset();\n    app.AP_INV_GL_H_ID_XWL.AP_INV_GL_H_CODE.reset();\n    //付款单\n    app.AP_PAY_H_ID_XWL.QUERY_LEDGER_ID.reset();\n    app.AP_PAY_H_ID_XWL.QUERY_VENDOR_ID.reset();\n    app.AP_PAY_H_ID_XWL.AP_PAY_H_ID.reset();\n    app.AP_PAY_H_ID_XWL.AP_PAY_H_CODE.reset();\n    //其它\n    app.SRC_ID.reset();\n    app.grid1.store.removeAll();\n  }\n  if(type == 'xc_ap_vendors'){\n    //应付单\n    app.AP_INV_GL_H_ID_XWL.QUERY_VENDOR_ID.reset();\n    app.AP_INV_GL_H_ID_XWL.AP_INV_GL_H_ID.reset();\n    app.AP_INV_GL_H_ID_XWL.AP_INV_GL_H_CODE.reset();\n    //付款单\n    app.AP_PAY_H_ID_XWL.QUERY_VENDOR_ID.reset();\n    app.AP_PAY_H_ID_XWL.AP_PAY_H_ID.reset();\n    app.AP_PAY_H_ID_XWL.AP_PAY_H_CODE.reset();\n    //其它\n    app.SRC_ID.reset();\n    app.grid1.store.removeAll();\n  }\n  if(type=='xc_ap_inv_gl_h'){\n    app.SRC_ID.reset();\n  }\n  if(type=='xc_ap_pay_h'){\n    app.SRC_ID.reset();\n  }\n}\n\n//判断单据是否被修改过\nfunction whetherModified(){\n  var a = Wb.encode(Wb.getValue(app.form1));//记录表单数据\n  if(a != Wb.recordFormData){//判断表单数据是否相等\n    return true;\n  }\n  var count1 = app.grid1.getStore().getModifiedRecords().length;//被修改的记录数\n  if(count1 > 0){\n    return true;\n  }\n  var count2 = app.grid1.getStore().getRemovedRecords().length;//被删除的记录数\n  if(count2 > 0){\n    return true;\n  }\n  return false;\n}\n\n/*\n  修改业务日期最小值（业务日期不可小于账簿开始会计期）\n  参数是账簿id\n*/\nfunction updateGlDATEMinValue(ledgerId){\n  Wb.request({\n    async : false,\n    url : 'm?xwl=xc/ap/pay/DB/selectLedgerStartDate',\n    params : {LEDGER_ID : ledgerId},\n    success : function(resp){\n\n      var startDate = Wb.decode(resp.responseText).START_DATE;\n      \n      \n      if(!Wb.isEmpty(startDate)){\n        app.GL_DATE.setMinValue(Wb.strToDate(startDate));\n      }else{\n        app.GL_DATE.setMinValue();\n      }\n    }\n  });\n}\n\n/*\n  将表单所有组件设为只读\n*/\n"},"children":[{"configs":{"itemId":"request"},"children":[{"configs":{"itemId":"ldInitStore","url":"m?xwl=xc/com-lov/LEDGER_ID_PICK/DB/XC_GL_LEDGERS_SELECT_SEC"},"events":{"load":"\nif(!Wb.isEmpty(Wb.ap_inv_gl_h_id)){\n}else{\n\n  Wb.ledgerStore = store;\n  app.LEDGER_ID_XWL.LEDGER_ID.setValue(store.getAt(0).get('LEDGER_ID'));\n  app.LEDGER_ID_XWL.LEDGER_NAME.setValue(store.getAt(0).get('LEDGER_NAME'));\n\n  app.AP_INV_GL_H_ID_XWL.QUERY_LEDGER_ID.setValue(store.getAt(0).get('LEDGER_ID'));\n  app.VENDOR_ID_XWL.QUERY_LEDGER_ID.setValue(store.getAt(0).get('LEDGER_ID'));\n  app.AP_PAY_H_ID_XWL.QUERY_LEDGER_ID.setValue(store.getAt(0).get('LEDGER_ID'));\n  \n  updateGlDATEMinValue(store.getAt(0).get('LEDGER_ID'));//修改业务日期最小值\n}\n"},"children":[],"expanded":false,"type":"store"}],"expanded":true,"type":"folder"},{"configs":{"itemId":"form1Tbar"},"children":[{"configs":{"text":"{#ADD#}","itemId":"addBtn","iconCls":"file_add_icon"},"events":{"click":"app.form1.getForm().reset();\napp.AP_CANCEL_H_ID.setValue(Xip.getId());\n\napp.saveBtn.setDisabled(false);\napp.verfyBtn.setDisabled(true);\n\nvar ledger_store = app.LEDGER_ID_XWL.LEDGER_NAME.getPicker().getStore();\nledger_store.load({\n  scope : this,\n  callback : function(records, operation, success){\n    app.LEDGER_ID_XWL.LEDGER_ID.setValue(records[0].data.LEDGER_ID);\n    app.LEDGER_ID_XWL.LEDGER_NAME.setValue(records[0].data.LEDGER_NAME);\n    returnRowFn(records[0], \"xc_gl_ledgers\");\n    app.GL_DATE.setValue(new Date());\n    app.AP_CANCEL_TYPE.setValue(Wb.apCancelType);\n    app.LEDGER_ID_XWL.LEDGER_NAME.setReadOnly(false);\n    app.AP_INV_GL_H_ID_XWL.QUERY_LEDGER_ID.setValue(records[0].data.LEDGER_ID);\n    app.VENDOR_ID_XWL.QUERY_LEDGER_ID.setValue(records[0].data.LEDGER_ID);\n    app.AP_PAY_H_ID_XWL.QUERY_LEDGER_ID.setValue(records[0].data.LEDGER_ID);\n  }\n});\n\n\n\n\nWb.isInsert = 'Y';\napp.grid1.getStore().reload({params:{\n  AP_CANCEL_H_ID:app.AP_CANCEL_H_ID.getValue()\n}});\n\n"},"children":[],"expanded":false,"type":"button"},{"configs":{"text":"{#SAVE#}","itemId":"saveBtn","iconCls":"save_icon"},"events":{"click":"var cancelType = app.AP_CANCEL_TYPE.getValue();//核销类型\nvar srcId = \"\";//核销源单号\nvar srcAmt = 0;//核销金额\nvar dtlCount = app.grid1.getStore().getCount();//明细行的数量\n\n// 计算核销金额\nfor(var i = 0;i < app.grid1.getStore().getCount();i++){\n\tvar r = app.grid1.getStore().getAt(i);\n    srcAmt = srcAmt+r.get('TARGET_AMT');\n}\napp.SRC_AMT.setValue(srcAmt);\n\n\nif(!Wb.verify(app.form1)){\n\tWb.toast(\"{#bdczfkxhzsrdsjbhf#}\");//表单存在非空项或者输入的数据不合法！\n    return;\n}\nvar getCount = app.grid1.getStore().getCount();\nif(getCount===0){\n    Wb.toast(\"{#qxtjmxsj#}\");//请先添加明细数据!\n    return;\n}\nif(!Wb.verifyGrid(app.grid1)){\n    Wb.toast(\"{#bgczfkxhzsrdsjbhf#}\");//表格存在非空项或者输入的数据不合法！\n    return;\n}\n\n//验证核销金额是否超过单据余额\nvar yue = 0;\nif(cancelType == \"YFHYUF\" || cancelType == \"YFHYS\" || cancelType == \"YFHLDC\"){\n  Wb.request({\n    async:false,\n    url:'m?xwl=xc/ap/cancel/DB/select_inv_yue_by_invId',\n    params:{AP_INV_GL_H_ID:app.AP_INV_GL_H_ID_XWL.AP_INV_GL_H_ID.getValue()},\n    success:function(resp){\n      yue = Wb.decode(resp.responseText).YUE;\n    }\n  });\n}\nif(cancelType == \"YUFHLDC\"){//预付红蓝对冲\n  Wb.request({\n    async:false,\n    url:'m?xwl=xc/ap/cancel/DB/select_pay_yue_by_payId',\n    params:{AP_PAY_H_ID:app.AP_PAY_H_ID_XWL.AP_PAY_H_ID.getValue()},\n    success:function(resp){\n      yue = Wb.decode(resp.responseText).YUE;\n    }\n  });\n}\n\nif(Math.abs(srcAmt) > Math.abs(yue)){\n  Wb.toast(\"{#hxjebkcgdjye#}\");//核销金额不可超过单据余额！\n  return;\n}\n\n//获取 新增、修改、删除 的记录\nvar newRecs = Wb.getData(app.grid1.store.getNewRecords());\nvar updateRecs = Wb.getData(app.grid1.store.getUpdatedRecords());\nvar deleteRecs = Wb.getData(app.grid1.store.getRemovedRecords());\n\n//保存数据\nWb.request({\n  url:'{#contextPath#}/apCancelAction.do?method=saveCancel',\n  params : {\n    opType : Wb.isInsert,\n    cancelH : Wb.getValue(app.form1),\n    newRecs : newRecs,\n    updateRecs : updateRecs,\n    deleteRecs : deleteRecs\n  },\n  success : function(resp){\n    var obj = Wb.decode(resp.responseText);\n    if(obj.flag == '0'){\n      Wb.toast(obj.msg);\n      app.AP_CANCEL_H_ID.setValue(obj.AP_CANCEL_H_ID); \n      app.AP_CANCEL_H_CODE.setValue(obj.AP_CANCEL_H_CODE);\n      app.V_HEAD_ID.setValue(obj.V_HEAD_ID);\n      app.V_STATUS.setValue(\"1\");\n      app.verfyBtn.setDisabled(false);\n      Wb.isInsert = \"N\";\n      app.grid1.store.load({\n        params : {AP_CANCEL_H_ID: app.AP_CANCEL_H_ID.getValue()}\n      });\n      Wb.recordFormData = Wb.encode(Wb.getValue(app.form1));//记录表单数据\n    }else{\n      Wb.toast(obj.msg);\n    }\n  }\n  \n});\n"},"children":[],"expanded":false,"type":"button"},{"configs":{"text":"{#VERIFY#}","itemId":"verfyBtn","iconCls":"up_icon"},"events":{"click":"//验证单据是否被修改\nif(whetherModified()){\n  Wb.toast(\"{#djybxu_qxbcdj#}\");//单据已被修改，请先保存单据！\n  return false;\n}\n\nif(app.V_STATUS.getValue() == \"3\"){//单据已经审核通过！\n  Wb.toast(\"{#djyjshtg#}\");//单据已经审核通过！\n  return;\n}\nelse{\n  var docArray = [] ;\n  var paramJson = {'headId' : app.V_HEAD_ID.getValue(),'apId':app.AP_CANCEL_H_ID.getValue(),apCatCode:'HXD'} ;\n  docArray.push(paramJson) ;\n  Wb.request({\n    url: '{#contextPath#}'+'/apVoucherAction.do?method=checkVoucher',\n    params: Wb.apply({apInfo: docArray}),\n    success: function(resp) {\n      var record = Wb.decode(resp.responseText);\n      var msg = record.msg;\n      if(record.flag === '0'){\n        Wb.toast(msg);\n        app.V_STATUS.setValue(\"3\");\n        app.saveBtn.setDisabled(true);\n        app.verfyBtn.setDisabled(true);\n        app.cancelVerfyBtn.setDisabled(false);\n      }\n      if(record.flag === '1'){\n        Wb.toast(msg);\n      }\n    }\n  });\n}"},"children":[],"expanded":false,"type":"button"},{"configs":{"text":"{#CANCEL_VERIFY#}","itemId":"cancelVerfyBtn","iconCls":"user_delete_icon"},"events":{"click":"\nvar docArray = [] ;\nvar paramJson = {'headId' : app.V_HEAD_ID.getValue(),'apId':app.AP_CANCEL_H_ID.getValue(),apCatCode:'HXD'} ;\ndocArray.push(paramJson) ;\nWb.request({\n  url: '{#contextPath#}'+'/apVoucherAction.do?method=cancelCheckVoucher',\n  params: Wb.apply({apInfo: docArray}),\n  success: function(resp) {\n    var record = Wb.decode(resp.responseText);\n    var msg = record.msg;\n    if(record.flag === '0'){\n      Wb.toast(msg);\n      app.V_STATUS.setValue(\"1\");\n      app.saveBtn.setDisabled(false);\n      app.verfyBtn.setDisabled(false);\n      app.cancelVerfyBtn.setDisabled(true);\n    }\n    if(record.flag === '1'){\n      Wb.toast(msg);\n    }\n  }\n});\n"},"children":[],"expanded":false,"type":"button"}],"expanded":true,"type":"toolbar"},{"configs":{"maximized":"true","height":"600","width":"1000","layout":"fit","closeAction":"hide","itemId":"editWinN"},"events":{"hide":"app.hideFun();"},"children":[{"configs":{"border":"false","itemId":"tabs"},"events":{"beforetabchange":"//加载凭证信息\nif(newCard.title === app.edit_v_xwl.xwl_v_panel.title){\n    Wb.request({\n        url: 'm?xwl=xc/gl/journal/data-db/common-data/select-v-head',\n        params: {'headId' : app.V_HEAD_ID.getValue()},\n        success: function(resp) {\n            var headJson = Wb.decode(resp.responseText);\n            Wb.setValue(app.edit_v_xwl.form1,headJson);\n            Wb.setValue(app.edit_v_xwl.bbar,headJson);\n            //处理会计日期\n            var accDate = headJson.accountDate;\n            app.edit_v_xwl.accountDate.setValue(Wb.strToDate(accDate));\n        }\n    });\n    // 加载凭证分录行\n    app.edit_v_xwl.grid1.getStore().load({params :{'headId':app.V_HEAD_ID.getValue()}});\n}"},"children":[{"configs":{"title":"{#HXD#}","layout":"border","itemId":"tab1"},"children":[{"configs":{"tbar":"app.form1Tbar","region":"north","height":"150","itemId":"form1"},"children":[{"configs":{"style":"fontSize:20px","html":"<font style=\"\">{#HXD#}<\/font>","margin":"10 0 20 0","labelAlign":"center","itemId":"title"},"children":[],"expanded":false,"type":"label"},{"configs":{"layout":"column","margin":"10 10 0 0","border":"false","itemId":"tr1"},"children":[{"configs":{"layout":"fit","columnWidth":".25","border":"false","itemId":"td_1_1"},"children":[{"configs":{"file":"m?xwl=xc/com-lov/LEDGER_ID_PICK/LEDGER_ID_PICK_SEC","itemId":"LEDGER_ID_XWL"},"children":[],"expanded":false,"type":"xwl"}],"expanded":true,"type":"panel"},{"configs":{"layout":"fit","columnWidth":".25","border":"false","itemId":"td_1_2"},"children":[{"configs":{"labelWidth":"80","readOnly":"true","allowBlank":"false","pickList":"[\n\t['YFHYUF','{#YFHYUF#}'],\n  \t['YFHYS','{#YFHYS#}'],\n  \t['YFHLDC','{#YFHLDC#}'],\n  \t['YUFHLDC','{#YUFHLDC#}']\n]","labelAlign":"right","itemId":"AP_CANCEL_TYPE","fieldLabel":"<span style=\"color: rgb(255, 0, 0);\">*<\/span>{#AP_CANCEL_TYPE#}"},"events":{"change":"/*\n  单据类型被修改之后，需要修改一些其它相关的东西 \n*/\n\nif(newValue == \"YFHYUF\"){\n  app.gridSelect.setText(\"{#FKD#}\");\n  app.SRC_CODE_COL.setText(\"{#FKD#}\");\n  app.VENDOR_NAME_COL.setText(\"{#VENDOR#}\");\n  app.td_2_2_1.show();\n  app.AP_INV_GL_H_ID_XWL.QUERY_CANCEL_TYPE.setValue('YFHYUF');\n  app.AP_INV_GL_H_ID_XWL.AP_INV_GL_H_CODE.allowBlank=false;\n  app.AP_INV_GL_H_ID_XWL.AP_INV_GL_H_CODE.setFieldLabel(\"<font color='red'>*<\/font>{#YFD#}\");\n  app.VENDOR_NAME_COL.hide();\n  \n}else if(newValue == \"YFHYS\"){\n  app.gridSelect.setText(\"{#YSD#}\");\n  app.SRC_CODE_COL.setText(\"{#YSD#}\");\n  app.VENDOR_NAME_COL.setText(\"{#CUSTOMER#}\");\n  app.td_2_2_1.show();\n  app.AP_INV_GL_H_ID_XWL.QUERY_CANCEL_TYPE.setValue('YFHYS');\n  app.AP_INV_GL_H_ID_XWL.AP_INV_GL_H_CODE.allowBlank=false;\n  app.AP_INV_GL_H_ID_XWL.AP_INV_GL_H_CODE.setFieldLabel(\"<font color='red'>*<\/font>{#YFD#}\");\n  app.VENDOR_NAME_COL.show();\n  \n}else if(newValue == \"YFHLDC\"){\n  app.gridSelect.setText(\"{#YFD#}\");\n  app.SRC_CODE_COL.setText(\"{#YFD#}\");\n  app.VENDOR_NAME_COL.setText(\"{#VENDOR#}\");\n  app.td_2_2_1.show();\n  app.AP_INV_GL_H_ID_XWL.QUERY_CANCEL_TYPE.setValue('YFHLDC');\n  app.AP_INV_GL_H_ID_XWL.AP_INV_GL_H_CODE.allowBlank=false;\n  app.AP_INV_GL_H_ID_XWL.AP_INV_GL_H_CODE.setFieldLabel(\"<font color='red'>*<\/font>{#YFD#}\");\n  app.VENDOR_NAME_COL.hide();\n  \n}else if(newValue == \"YUFHLDC\"){\n  app.gridSelect.setText(\"{#FKD#}\");\n  app.SRC_CODE_COL.setText(\"{#FKD#}\");\n  app.VENDOR_NAME_COL.setText(\"{#VENDOR#}\");\n  app.td_2_2_2.show();\n  app.AP_PAY_H_ID_XWL.AP_PAY_H_CODE.allowBlank=false;\n  app.AP_PAY_H_ID_XWL.AP_PAY_H_CODE.setFieldLabel(\"<font color='red'>*<\/font>{#FKD#}\");\n  app.VENDOR_NAME_COL.hide();\n}"},"children":[],"expanded":false,"type":"combo"}],"expanded":true,"type":"panel"},{"configs":{"layout":"fit","columnWidth":".25","border":"false","itemId":"td_1_3"},"children":[{"configs":{"labelWidth":"80","readOnly":"true","labelAlign":"right","itemId":"AP_CANCEL_H_CODE","fieldLabel":"<span style=\"color: rgb(255, 0, 0);\">*<\/span>{#AP_CANCEL_H_CODE2#}"},"children":[],"expanded":false,"type":"text"}],"expanded":true,"type":"panel"},{"configs":{"layout":"fit","columnWidth":".25","border":"false","itemId":"td_1_4"},"children":[{"configs":{"labelWidth":"80","allowBlank":"false","labelAlign":"right","itemId":"GL_DATE","fieldLabel":"<span style=\"color: rgb(255, 0, 0);\">*<\/span>{#POSTING_DATE#}","editable":"false"},"children":[],"expanded":false,"type":"date"}],"expanded":true,"type":"panel"}],"expanded":true,"type":"panel"},{"configs":{"layout":"column","margin":"10 10 0 0","border":"false","itemId":"tr2"},"children":[{"configs":{"layout":"fit","columnWidth":".25","border":"false","itemId":"td_2_1"},"children":[{"configs":{"file":"m?xwl=xc/com-lov/VENDOR_ID_PICK/VENDOR_ID_LD","itemId":"VENDOR_ID_XWL"},"children":[],"expanded":false,"type":"xwl"}],"expanded":true,"type":"panel"},{"configs":{"hidden":"true","layout":"fit","columnWidth":".25","border":"false","itemId":"td_2_2_1"},"children":[{"configs":{"file":"m?xwl=xc/ap/ap-com-lov/AP_INV_GL_H_ID_PICK/AP_INV_GL_H_ID_PICK_HL","itemId":"AP_INV_GL_H_ID_XWL"},"children":[],"expanded":false,"type":"xwl"}],"expanded":true,"type":"panel"},{"configs":{"hidden":"true","layout":"fit","columnWidth":".25","border":"false","itemId":"td_2_2_2"},"children":[{"configs":{"file":"m?xwl=xc/ap/ap-com-lov/AP_PAY_H_ID_PICK/AP_PAY_H_ID_PICK_YUFK_H","itemId":"AP_PAY_H_ID_XWL"},"children":[],"expanded":false,"type":"xwl"}],"expanded":true,"type":"panel"},{"configs":{"tagConfigs":"baseCls : 'my-panel-no-border'","layout":"fit","columnWidth":".25","itemId":"td_2_3"},"children":[{"configs":{"labelWidth":"80","readOnly":"true","allowBlank":"false","labelAlign":"right","itemId":"SRC_AMT","fieldLabel":"<span style=\"color: rgb(255, 0, 0);\">*<\/span>{#CANCEL_AMT#}"},"children":[],"expanded":false,"type":"number"}],"expanded":true,"type":"panel"},{"configs":{"tagConfigs":"baseCls : 'my-panel-no-border'","layout":"fit","columnWidth":".25","itemId":"td_2_4"},"children":[{"configs":{"labelWidth":"80","allowBlank":"false","labelAlign":"right","itemId":"DESCRIPTION","fieldLabel":"<span style=\"color: rgb(255, 0, 0);\">*<\/span>{#DESCRIPTION#}"},"children":[],"expanded":false,"type":"text"}],"expanded":true,"type":"panel"}],"expanded":true,"type":"panel"},{"configs":{"hidden":"true","itemId":"hidden_p"},"children":[{"configs":{"itemId":"AP_CANCEL_H_ID"},"children":[],"expanded":false,"type":"text"},{"configs":{"labelWidth":"80","labelAlign":"right","itemId":"SRC_ID"},"children":[],"expanded":false,"type":"text"},{"configs":{"itemId":"V_HEAD_ID","fieldLabel":"凭证头ID"},"children":[],"expanded":false,"type":"text"},{"configs":{"value":"草稿","itemId":"V_STATUS"},"children":[],"expanded":false,"type":"text"},{"configs":{"value":"{#XIP.userId#}","itemId":"USER_ID"},"children":[],"expanded":false,"type":"text"}],"expanded":true,"type":"panel"}],"expanded":true,"type":"form"},{"configs":{"region":"center","itemId":"grid1"},"children":[{"configs":{"itemId":"store","url":"m?xwl=xc/ap/cancel/DB/XC_AP_CANCEL_L_SELECT"},"children":[],"expanded":false,"type":"store"},{"configs":{"normalName":"grid1Tbar","itemId":"tbar"},"children":[{"configs":{"text":"{#gridSelect#}","itemId":"gridSelect","iconCls":"select_all_icon"},"events":{"click":"\nvar apCcancelHId = app.AP_CANCEL_H_ID.getValue();\nvar apCancelType = app.AP_CANCEL_TYPE.getValue();\n\nvar ledgerId = app.LEDGER_ID_XWL.LEDGER_ID.getValue();\n\nvar vendorId = app.VENDOR_ID_XWL.VENDOR_ID.getValue();\n\n\nvar src_id = app.SRC_ID.getValue();\n\nif(Wb.isEmpty(ledgerId)){\n  Wb.toast(\"{#qxxzzb#}\");//请先选择账簿！\n  return false;\n}\nif(Wb.isEmpty(vendorId)){\n  Wb.toast(\"{#qxxzgys#}\");//请先选择供应商！\n  return false;\n}\nif(Wb.isEmpty(src_id)){\n  Wb.toast(\"{#qxxzyfdhzfkd#}\");//请先选择应付单或者付款单！\n  return false;\n}\n\nvar curGrid = app.grid1;\n//应付核预付 预付红蓝对冲\nif(Wb.apCancelType=='YFHYUF'||Wb.apCancelType=='YUFHLDC'){\n  Wb.run({\n    url: 'm?xwl=xc/ap/cancel/LOV/LOV_XC_AP_PAY_H', \n    success: function(app) {\n      app.initWin({\n        AP_CANCEL_TYPE:apCancelType,\n        VENDOR_ID:vendorId,\n        LEDGER_ID:ledgerId,\n\t\tSRC_ID : src_id,\n        hideFun:function(rs){\n          Wb.each(rs, function(r) {\n            r.set('AP_CANCEL_L_ID',Xip.getId());\n            r.set('AP_CANCEL_H_ID',apCcancelHId);\n            r.set('AP_CANCEL_TYPE',apCancelType);\n            r.set('TARGET_ID',r.get('AP_PAY_H_ID'));\n            r.set('TARGET_AMT',r.get('PAY_AMT'));\n            r.set('SRC_CODE',r.get('AP_PAY_H_CODE'));\n            var grid1Store = curGrid.getStore();\n            for(var i=0;i<grid1Store.getCount();i++){\n              var gr = grid1Store.getAt(i);\n              if(gr.get('TARGET_ID')==r.get('TARGET_ID')){\n                return false;\n              }\n            }\n            Wb.add(curGrid, {\n              AP_CANCEL_L_ID:Xip.getId(),\n              AP_CANCEL_H_ID:apCcancelHId,\n              AP_CANCEL_TYPE:apCancelType,\n              TARGET_ID:r.get('AP_PAY_H_ID'),\n              TARGET_AMT:r.get('PAY_AMT'),\n              SRC_CODE:r.get('AP_PAY_H_CODE'),\n              AP_CONTRACT_NAME:r.get('AP_CONTRACT_NAME'),\n              VENDOR_NAME:r.get('VENDOR_NAME'),\n              DEPT_NAME:r.get('DEPT_NAME'),\n              PROJECT_NAME:r.get('PROJECT_NAME'),\n              ACC_NAME:r.get('ACC_NAME'),\n              DESCRIPTION:r.get('DESCRIPTION')\n            }, 'after', 1, false);\n          });\n        }\n      });\n    }\n  });\n}\n//应付红蓝对冲\nif(Wb.apCancelType=='YFHLDC'){\n  Wb.run({\n    url: 'm?xwl=xc/ap/cancel/LOV/LOV_XC_AP_INV_GL_H', \n    success: function(app) {\n      app.initWin({\n        AP_CANCEL_TYPE:apCancelType,\n        VENDOR_ID:vendorId,\n        LEDGER_ID:ledgerId,\n\t\tSRC_ID : src_id,\n        hideFun:function(rs){\n          Wb.each(rs, function(r) {\n            r.set('AP_CANCEL_L_ID',Xip.getId());\n            r.set('AP_CANCEL_H_ID',apCcancelHId);\n            r.set('AP_CANCEL_TYPE',apCancelType);\n            r.set('TARGET_ID',r.get('AP_INV_GL_H_ID'));\n            r.set('TARGET_AMT',r.get('PAY_AMT'));\n            r.set('SRC_CODE',r.get('AP_INV_GL_H_CODE'));\n            var grid1Store = curGrid.getStore();\n            for(var i=0;i<grid1Store.getCount();i++){\n              var gr = grid1Store.getAt(i);\n              if(gr.get('TARGET_ID')==r.get('TARGET_ID')){\n                return false;\n              }\n            }\n            Wb.add(curGrid, {\n              AP_CANCEL_L_ID:Xip.getId(),\n              AP_CANCEL_H_ID:apCcancelHId,\n              AP_CANCEL_TYPE:apCancelType,\n              TARGET_ID:r.get('AP_INV_GL_H_ID'),\n              TARGET_AMT:r.get('PAY_AMT'),\n              SRC_CODE:r.get('AP_INV_GL_H_CODE'),\n              AP_CONTRACT_NAME:r.get('AP_CONTRACT_NAME'),\n              VENDOR_NAME:r.get('VENDOR_NAME'),\n              DEPT_NAME:r.get('DEPT_NAME'),\n              PROJECT_NAME:r.get('PROJECT_NAME'),\n              ACC_NAME:r.get('ACC_NAME'),\n              DESCRIPTION:r.get('DESCRIPTION')\n            }, 'after', 1, false);\n          });\n        }\n      });\n    }\n  });\n}\n//应付核应收\nif (Wb.apCancelType=='YFHYS'){\n  Wb.run({\n    url: 'm?xwl=xc/ap/cancel/LOV/LOV_XC_AR_INV_GL_H', \n    success: function(app) {\n      app.initWin({\n        AP_CANCEL_TYPE:apCancelType,\n        VENDOR_ID:vendorId,\n        LEDGER_ID:ledgerId,\n\t\tSRC_ID : src_id,\n        hideFun:function(rs){\n          Wb.each(rs, function(r) {\n            r.set('AP_CANCEL_L_ID',Xip.getId());\n            r.set('AP_CANCEL_H_ID',apCcancelHId);\n            r.set('AP_CANCEL_TYPE',apCancelType);\n            r.set('TARGET_ID',r.get('AP_INV_GL_H_ID'));\n            r.set('TARGET_AMT',r.get('PAY_AMT'));\n            r.set('SRC_CODE',r.get('AP_INV_GL_H_CODE'));\n            var grid1Store = curGrid.getStore();\n            for(var i=0;i<grid1Store.getCount();i++){\n              var gr = grid1Store.getAt(i);\n              if(gr.get('TARGET_ID')==r.get('TARGET_ID')){\n                return false;\n              }\n            }\n            Wb.add(curGrid, {\n              AP_CANCEL_L_ID:Xip.getId(),\n              AP_CANCEL_H_ID:apCcancelHId,\n              AP_CANCEL_TYPE:apCancelType,\n              TARGET_ID:r.get('AR_INV_GL_H_ID'),\n              TARGET_AMT:r.get('PAY_AMT'),\n              SRC_CODE:r.get('AR_INV_GL_H_CODE'),\n              AP_CONTRACT_NAME:r.get('AR_CONTRACT_NAME'),\n              VENDOR_NAME:r.get('CUSTOMER_NAME'),\n              DEPT_NAME:r.get('DEPT_NAME'),\n              PROJECT_NAME:r.get('PROJECT_NAME'),\n              ACC_NAME:r.get('ACC_NAME'),\n              DESCRIPTION:r.get('DESCRIPTION')\n            }, 'after', 1, false);\n          });\n        }\n      });\n    }\n  });\n\n}\n\n"},"children":[],"expanded":false,"type":"button"},{"configs":{"text":"{#DELETE#}","itemId":"delBtn","iconCls":"file_delete_icon"},"events":{"click":"Ext.Msg.confirm(\"{#ts#}\", \"{#qdyscm#}\", function (button) {// 提示  确定要删除吗？\n    if (button == \"yes\") {\n      Wb.remove(app.grid1);\n    }\n});"},"children":[],"expanded":false,"type":"button"}],"expanded":true,"type":"toolbar"},{"configs":{"itemId":"columns"},"children":[{"configs":{"text":"{#SERIAL_NUMBER#}","align":"center","width":"50","xtype":"rownumberer","titleAlign":"center","itemId":"ROWNUM_COL"},"children":[],"expanded":false,"type":"column"},{"configs":{"width":"150","dataIndex":"SRC_CODE","titleAlign":"center","itemId":"SRC_CODE_COL"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#CONTRACT#}","width":"150","dataIndex":"AP_CONTRACT_NAME","titleAlign":"center","itemId":"AP_CONTRACT_NAME_COL"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#VENDOR#}","width":"200","dataIndex":"VENDOR_NAME","titleAlign":"center","itemId":"VENDOR_NAME_COL"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#DEPT#}","width":"100","dataIndex":"DEPT_NAME","titleAlign":"center","itemId":"DEPT_NAME_COL"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#PROJECT#}","width":"100","dataIndex":"PROJECT_NAME","titleAlign":"center","itemId":"PROJECT_NAME_COL"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#SUBJECT#}","width":"100","dataIndex":"ACC_NAME","titleAlign":"center","itemId":"ACC_NAME_COL"},"children":[],"expanded":true,"type":"column"},{"configs":{"text":"{#CANCEL_AMT#}","align":"right","width":"100","dataIndex":"TARGET_AMT","format":"0,000.00","titleAlign":"center","itemId":"TARGET_AMT_COL"},"children":[],"expanded":true,"type":"column"},{"configs":{"text":"{#DESCRIPTION#}","width":"200","dataIndex":"DESCRIPTION","titleAlign":"center","itemId":"DESCRIPTION_COL"},"children":[],"expanded":false,"type":"column"}],"expanded":true,"type":"array"}],"expanded":true,"type":"grid"}],"expanded":true,"type":"panel"},{"configs":{"file":"m?xwl=xc/gl/journal/v-windows/new-xwl-voucher","itemId":"edit_v_xwl"},"children":[],"expanded":false,"type":"xwl"}],"expanded":true,"type":"tab"}],"expanded":true,"type":"window"}],"expanded":true,"type":"module"}],"pageLink":"","iconCls":""}