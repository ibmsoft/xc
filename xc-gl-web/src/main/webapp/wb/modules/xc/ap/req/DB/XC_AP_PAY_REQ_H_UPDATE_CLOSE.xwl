{"inframe":false,"title":"付款申请单关闭/打开关闭","hidden":false,"roles":{"default":1},"children":[{"configs":{"serverScript":"var  rs, meta, row, rows = [];\nvar recs = Wb.decode(request.getParameter('closeRec'));\nvar isClose = true;\nWb.each(recs, function(rec) {\n  if(rec.AP_DOC_CAT_CODE=='CGJS'){\n    rs = app.run('select a.AP_PAY_REQ_L_ID,a.AP_PAY_REQ_H_ID,a.AP_INV_GL_H_ID,a.AP_CONTRACT_ID,a.AP_PUR_TYPE_ID,a.BG_ITEM_ID,a.AMOUNT,a.PAID_AMT,a.NO_PAY_AMT,a.DESCRIPTION,b.AP_PAY_REQ_H_CODE,b.AP_DOC_CAT_CODE from xc_ap_pay_req_l a ,xc_ap_pay_req_h b where a.AP_PAY_REQ_H_ID=\\''+rec.AP_PAY_REQ_H_ID+'\\' and a.AP_INV_GL_H_ID is not null and a.AP_PAY_REQ_H_ID = b.AP_PAY_REQ_H_ID');\n    meta = rs.getMetaData();\n    if(rec.IS_CLOSE=='Y'){\n      isClose = true;\n    }else{\n      isClose = false;\n    }\n    while (rs.next()) {\n      row = Wb.getRecord(rs, meta);\n      if(!isClose){\n        app.run('select 1 from xc_ap_inv_gl_h where AP_INV_GL_H_ID=\\''+row.AP_INV_GL_H_ID+'\\' and (NO_PAY_AMT-OCCUPY_AMT-\\''+row.AMOUNT+'\\')<0', {\n          errorText: '付款申请金额超过未支付金额。'\n        });\n      }\n      rows.push(row);\n    }\n  }else{\n  \tapp.run('update xc_ap_pay_req_h set IS_CLOSE=\\'Y\\' where AP_PAY_REQ_H_ID=\\''+rec.AP_PAY_REQ_H_ID+'\\'');\n  }\n    \n});\nif(!isClose){\n  request.setAttribute('openRecL',Wb.encode(rows));\n}else{\n  request.setAttribute('closeRecL',Wb.encode(rows));\n}","itemId":"module"},"children":[{"configs":{"itemId":"update","oracle":"update xc_ap_pay_req_h set \nIS_CLOSE={?IS_CLOSE?},\nLAST_UPDATE_DATE=sysdate,\nLAST_UPDATED_BY={?XIP.userId?} \n\twhere AP_PAY_REQ_H_ID={?AP_PAY_REQ_H_ID?}","mysql":"update xc_ap_pay_req_h set \nIS_CLOSE={?IS_CLOSE?},\nLAST_UPDATE_DATE=SYSDATE(),\nLAST_UPDATED_BY={?XIP.userId?} \n\twhere AP_PAY_REQ_H_ID={?AP_PAY_REQ_H_ID?}"},"children":[],"expanded":false,"type":"sqlswitcher"},{"configs":{"sql":"{#update#}","transaction":"start","arrayName":"closeRec","itemId":"query1"},"children":[],"expanded":false,"type":"query"},{"configs":{"sql":"update xc_ap_inv_gl_h set \nOCCUPY_AMT = OCCUPY_AMT-({?decimal.AMOUNT?}-{?decimal.PAID_AMT?})\nwhere AP_INV_GL_H_ID={?AP_INV_GL_H_ID?}","arrayName":"closeRecL","itemId":"query2"},"children":[],"expanded":false,"type":"query"},{"configs":{"sql":"update xc_ap_inv_gl_h set OCCUPY_AMT = (select no_pay_amt from xc_ap_pay_req_l where AP_PAY_REQ_H_ID = {?AP_PAY_REQ_H_ID?} and AP_INV_GL_H_ID = {?AP_INV_GL_H_ID?}) where AP_INV_GL_H_ID={?AP_INV_GL_H_ID?}","arrayName":"openRecL","itemId":"query3"},"children":[],"expanded":false,"type":"query"},{"configs":{"sql":"insert into xc_ap_inv_trans(TRANS_ID,\n                           SOURCE_ID,\n                           REQ_AMT,\n                           AP_INV_GL_H_ID,\n                           AP_DOC_CAT_CODE,\n                           CREATION_DATE,\n                           CREATED_BY,\n                           LAST_UPDATE_DATE,\n                           LAST_UPDATED_BY,\n                           AP_DOC_CODE,\n                           DESCRIPTION) \nvalues(UUID(),\n      {?AP_PAY_REQ_H_ID?},\n      (select -no_pay_amt from xc_ap_pay_req_l where AP_PAY_REQ_H_ID = {?AP_PAY_REQ_H_ID?} and AP_INV_GL_H_ID = {?AP_INV_GL_H_ID?}),\n      {?AP_INV_GL_H_ID?},\n      {?AP_DOC_CAT_CODE?},\n      sysdate(),\n      {?XIP.userId?},\n      sysdate(),\n      {?XIP.userId?},\n      {?AP_PAY_REQ_H_CODE?},\n      '关闭申请单'\n      )","arrayName":"closeRecL","itemId":"query4"},"children":[],"expanded":false,"type":"query"}],"expanded":true,"type":"module"}],"pageLink":"","iconCls":""}