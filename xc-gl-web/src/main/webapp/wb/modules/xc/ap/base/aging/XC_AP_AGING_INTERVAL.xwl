{"inframe":false,"title":"账龄","hidden":false,"roles":{"default":1},"children":[{"configs":{"serverScript":"com.xzsoft.xip.platform.util.XipUtil.getCurrentLang(request,\"xc/ap/base/aging/XC_AP_AGING_INTERVAL\");","itemId":"module"},"children":[{"configs":{"itemId":"store1","url":"m?xwl=xc/ap/base/aging/data/selectDLexist"},"children":[],"expanded":false,"type":"store"},{"configs":{"layout":"border","itemId":"viewport1"},"children":[{"configs":{"region":"north","pagingBar":"false","selType":"rowmodel","height":"150","itemId":"grid1","editable":"true"},"events":{"itemclick":"\nvar VAL_CODE = record.data.VAL_CODE;//账龄大类\nvar optype =  record.data.OPTYPE;\nif(optype==\"add\"){\n  app.grid2.getStore().removeAll();\n\n}else{\n   app.grid2.getStore().removeAll();\n  app.grid2.store.load({params:{AGING_TYPE_CODE:VAL_CODE}} );\n \n}\n"},"children":[{"configs":{"itemId":"tbar"},"children":[{"configs":{"text":"{#addBtn#}","itemId":"addBtn","iconCls":"new_icon"},"events":{"click":"\n  \n\nvar bkid =  Xip.getId();\n\nWb.addEdit(app.grid1,[{VAL_SET_CODE:\"XC_AP_AGING_TYPE\",VAL_SET_DTL_ID:bkid,OPTYPE:'add'}]);\n"},"children":[],"expanded":false,"type":"button"},{"configs":{"text":"-","itemId":"item11"},"children":[],"expanded":false,"type":"item"},{"configs":{"text":"{#delBtn#}","itemId":"delBtn","iconCls":"application_delete_icon"},"events":{"click":"var rows=app.grid1.getSelectionModel().getSelection();\nif(rows.length===0){\n  Ext.Msg.alert('{#TIP#}','{#DELTIP#}');\n  return;\n}\nelse{\n  var flag = false;\n  Ext.Msg.confirm('{#TIP#}','{#DELOKTIP#}',function(a){\n    if(a=='yes'){\n      var idList = \"\" ;\n      var codelist=\"\";\n\n      Ext.each(rows,function(r){\n        var id = \"'\" + r.data.VAL_SET_DTL_ID + \"'\";\n        var code =  \"'\" + r.data.VAL_CODE + \"'\";\n        var type = r.data.OPTYPE;\n        if(type==\"add\"){\n          Wb.remove(app.grid1,r);\n        }else{\n          flag= true;\n          if(idList === \"\"){\n            idList = id ;\n          }else{\n            idList = idList+\",\"+id ;\n          }\n          if(codelist === \"\"){\n            codelist = code ;\n          }else{\n            codelist = codelist+\",\"+code ;\n          }\n        }\n\n\n      });\n      if(flag==true){\n        var json = {'AGING_TYPE_CODE' : codelist,'ids':idList} ;\n        Wb.request({\n          url : 'm?xwl=xc/ap/base/aging/data/deleteDL',\n          params :json,\n          success :function(response){\n\n            Wb.toast('{#DELTIP1#}');\n            //  Ext.Msg.alert(\"提示\",\"删除成功!\");\n            Wb.remove(app.grid1,rows);\n            app.grid2.getStore().removeAll();\n          }\n        });\n      }else{\n          Wb.toast('{#DELTIP1#}');\n      }\n\n    }\n  });\n}"},"children":[],"expanded":false,"type":"button"},{"configs":{"text":"-","itemId":"item12111"},"children":[],"expanded":true,"type":"item"},{"configs":{"text":"{#saveBtn#}","itemId":"saveBtn","iconCls":"ok_icon"},"events":{"click":"if (!Wb.verifyGrid(app.grid1)) //验证数据是否合法\n  return;\nvar rec = app.grid1.store.getModifiedRecords();\n\n\n\nfor(var i=0;i<rec.length;i++){\n  for(var j=0;j<rec.length;j++){\n    if(rec[i].data.VAL_CODE==rec[j].data.VAL_CODE&&rec[i].data.VAL_SET_DTL_ID!=rec[j].data.VAL_SET_DTL_ID){\n      Ext.Msg.alert('{#TIP#}',rec[i].data.VAL_CODE+\"{#MSG1#}\");\n      return false;\n    }\n  }\n\n  var flag=true;\n  var msg=\"\";\n  var vcode = rec[i].data.VAL_CODE;\n  Wb.request({\n    url: 'm?xwl=xc/ap/base/aging/data/selectDLexist',\n    params:{VAL_CODE:vcode,VAL_SET_DTL_ID:rec[i].data.VAL_SET_DTL_ID},\n    async:false,\n    method: 'POST',\n    success:function(response){\n      var response = Ext.JSON.decode(response.responseText);\n      var num = response.NUM;\n\n      if( num>0){\n\n        msg = vcode+\"{#MSG1#}\";\n        flag = false;\n\n\n      }\n    }\n  });\n\n  if(flag==false){\n    Ext.Msg.alert('{#TIP#}',msg);\n    return;\n  }\n\n}   \n\nWb.sync({\n  grid: app.grid1,\n  url: 'm?xwl=xc/ap/base/aging/data/save',\n  message: '{#message#}',\n  success: function(resp) {\n\n    Wb.reload(app.grid1);\n    Wb.toast('{#SAVETIP#}');\n  }\n});\n\n"},"children":[],"expanded":false,"type":"button"}],"expanded":true,"type":"toolbar"},{"configs":{"pageSize":"-1","autoLoad":"true","itemId":"store","url":"m?xwl=xc/ap/base/aging/data/selectDL"},"children":[],"expanded":false,"type":"store"},{"configs":{"itemId":"columns"},"children":[{"configs":{"xtype":"rownumberer","itemId":"Row_num"},"children":[],"expanded":false,"type":"column"},{"configs":{"hidden":"true","dataIndex":"OPTYPE","itemId":"column1"},"children":[],"expanded":false,"type":"column"},{"configs":{"hidden":"true","width":"160","dataIndex":"VAL_SET_DTL_ID","itemId":"VAL_SET_DTL_ID"},"children":[],"expanded":false,"type":"column"},{"configs":{"hidden":"true","width":"160","dataIndex":"VAL_SET_CODE","itemId":"VAL_SET_CODE"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"<font color='red'>*<\/font>{#VAL_CODE_COL#}","width":"160","dataIndex":"VAL_CODE","itemId":"VAL_CODE_COL"},"children":[{"configs":{"allowBlank":"false","itemId":"editor"},"children":[],"expanded":false,"type":"text"}],"expanded":true,"type":"column"},{"configs":{"text":"<font color='red'>*<\/font>{#VAL_NAME_COL#}","width":"200","dataIndex":"VAL_NAME","itemId":"VAL_NAME_COL"},"children":[{"configs":{"allowBlank":"false","itemId":"editor"},"children":[],"expanded":false,"type":"text"}],"expanded":false,"type":"column"},{"configs":{"text":"{#DESCRIPTION_COL#}","width":"300","dataIndex":"DESCRIPTION","itemId":"DESCRIPTION_COL"},"children":[{"configs":{"itemId":"editor"},"children":[],"expanded":false,"type":"text"}],"expanded":true,"type":"column"}],"expanded":true,"type":"array"}],"expanded":true,"type":"grid"},{"configs":{"region":"center","selType":"rowmodel","border":"true","itemId":"grid2","editable":"true"},"children":[{"configs":{"itemId":"tbar"},"children":[{"configs":{"text":"{#addBtn#}","hidden":"true","itemId":"addBtn","iconCls":"new_icon"},"events":{"click":"var rows=app.grid1.getSelectionModel().getSelection();\n  \nif(rows.length===0){\n  Ext.Msg.alert('{#TIP#}','{#MSG4#}');\n  return;\n}\n var optype =   rows[0].data.OPTYPE;\n\nif(optype==\"add\"){\n  Ext.Msg.alert('{#TIP#}','{#MSG5#}');\n  return;\n}\n\nvar typecode = rows[0].data.VAL_CODE;\nvar bkid =  Xip.getId();\n\n\nvar count = app.grid2.store.getCount();\n\nif(count<1){\n  Wb.startNum = 1;\n  Wb.addEdit(app.grid2,[{AP_INTERVAL_ID:bkid,AGING_TYPE_CODE:typecode,AGING_TYPE_NAME:rows[0].data.VAL_NAME,INTERVAL_START:1}]);\n\n}else{\n  \n  //Wb.addEdit(app.grid2,[{AR_INTERVAL_ID:bkid,AGING_TYPE_CODE:typecode,AGING_TYPE_NAME:rows[0].data.VAL_NAME}]);\n  \n}\n\n\n"},"children":[],"expanded":false,"type":"button"},{"configs":{"text":"-","itemId":"item11"},"children":[],"expanded":false,"type":"item"},{"configs":{"text":"{#delBtn#}","itemId":"delBtn","iconCls":"delete_icon"},"events":{"click":"/**var rows=app.grid2.getSelectionModel().getSelection();\nif(rows.length===0){\n  Ext.Msg.alert('提示','请选择要删除的记录!');\n  return;\n}\nelse{\n   Ext.Msg.confirm('提示','您确定要删除？',function(a){\n    if(a=='yes'){\n            \n      var idList = \"\" ;\n      Ext.each(rows,function(r){\n        var id = \"'\" + r.data.AP_INTERVAL_ID + \"'\";\n        if(idList === \"\"){\n          idList = id ;\n        }else{\n          idList = idList+\",\"+id ;\n        }\n      });\n      var json = {'ids' : idList} ;\n          Wb.request({\n           url : 'm?xwl=xc/ap/base/aging/data/delete',\n           params :json,\n           success :function(response){\n             \n               Wb.toast('删除成功。');\n         //  Ext.Msg.alert(\"提示\",\"删除成功!\");\n             Wb.remove(app.grid2,rows);\n           }\n        });\n    }\n   });\n}**/\nvar count = app.grid2.store.getCount();\n\nvar row;\nvar flag=false;\n\n\n\nExt.Msg.confirm('{#TIP#}','{#DELOKTIP2#}',function(a){\n  if(a=='yes'){\n    var idList = \"\" ;\n    if(count<2){\n      //仅存在一条记录\n      row = app.grid2.store.getAt(0);\n      var id = \"'\" + row.data.AP_INTERVAL_ID + \"'\";\n      idList = id ;\n    }else{\n      //存在大于两条记录默认删除倒数第二条，同时将最后一条的记录开始天数修改\n      var delindex = count-2;\n      row =  app.grid2.store.getAt(delindex);\n      var id = \"'\" + row.data.AP_INTERVAL_ID + \"'\";\n      idList = id ;\n      flag = true;\n      if(delindex>0){\n        //修改最后一条记录的起始天数\n        var preindex = count-3;\n        var r = app.grid2.store.getAt(preindex);\n        var startNum = r.data.INTERVAL_DAYS+ r.data.INTERVAL_START;\n        var lastrow =  app.grid2.store.getAt(count-1);\n        lastrow.set('INTERVAL_START',startNum) ;\n\n      }else{\n        //仅剩下最后一条记录\n        var lastrow =  app.grid2.store.getAt(count-1);\n        lastrow.set('INTERVAL_START',1) ;\n      }\n\n    }\n\n\n\n    /**    Ext.each(rows,function(r){\n\n        if(idList === \"\"){\n          idList = id ;\n        }else{\n          idList = idList+\",\"+id ;\n        }\n      });**/\n    var json = {'ids' : idList} ;\n    Wb.request({\n      url : 'm?xwl=xc/ap/base/aging/data/delete',\n      params :json,\n      success :function(response){\n        Wb.remove(app.grid2,row);\n\t\t   \n            Wb.toast('{#DELTIP1#}');\n     \n\n\n       \n      }\n    });\n  }\n});\n\n"},"children":[],"expanded":false,"type":"button"},{"configs":{"text":"-","itemId":"item111"},"children":[],"expanded":false,"type":"item"},{"configs":{"text":"{#saveBtn#}","itemId":"saveBtn","iconCls":"ok_icon"},"events":{"click":"if (!Wb.verifyGrid(app.grid2)) //验证数据是否合法\n  return;\nWb.sync({\n  grid: app.grid2,\n  url: 'm?xwl=xc/ap/base/aging/data/saveXC_AP_AGING_INTERVAL',\n  message: '{#message#}',\n  success: function(resp) {\n    \n     Wb.reload(app.grid2);\n    Wb.toast('{#SAVETIP#}');\n  }\n});"},"children":[],"expanded":false,"type":"button"}],"expanded":true,"type":"toolbar"},{"configs":{"itemId":"store","url":"m?xwl=xc/ap/base/aging/data/select"},"events":{"success":"var rows=app.grid1.getSelectionModel().getSelection();\n  \nif(rows.length===0){\n  Ext.Msg.alert('{#TIP#}','{#MSG4#}');\n  return;\n}\n var optype =   rows[0].data.OPTYPE;\n\nif(optype==\"add\"){\n  Ext.Msg.alert('{#TIP#}','{#MSG5#}');\n  return;\n}\n\nvar typecode = rows[0].data.VAL_CODE;\n\n\nvar bkid =  Xip.getId();\nvar count = app.grid2.store.getCount();\n\nif(count<1){\n  Wb.startNum = 1;\n  app.grid2.store.add([{AP_INTERVAL_ID:bkid,AGING_TYPE_CODE:typecode,AGING_TYPE_NAME:rows[0].data.VAL_NAME,AR_ROW_NUM:1,INTERVAL_START:1}]);\n //  Wb.addEdit(app.grid2,[{AR_INTERVAL_ID:bkid,AGING_TYPE_CODE:typecode,AGING_TYPE_NAME:rows[0].data.VAL_NAME,AR_ROW_NUM:1,INTERVAL_START:1}]);\n  \n}else{\n  \n  //Wb.addEdit(app.grid2,[{AR_INTERVAL_ID:bkid,AGING_TYPE_CODE:typecode,AGING_TYPE_NAME:rows[0].data.VAL_NAME}]);\n  \n}"},"children":[],"expanded":false,"type":"store"},{"configs":{"itemId":"columns"},"children":[{"configs":{"xtype":"rownumberer","itemId":"Row_num"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#AR_INTERVAL_ID_COL#}","hidden":"true","dataIndex":"AP_INTERVAL_ID","itemId":"AP_INTERVAL_ID_COL"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#AGING_TYPE_CODE_COL#}","hidden":"true","dataIndex":"AGING_TYPE_CODE","normalName":"AGING_TYPE_NAME","itemId":"AGING_TYPE_CODE_COL"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#AGING_TYPE_NAME_COL#}","dataIndex":"AGING_TYPE_NAME","itemId":"AGING_TYPE_NAME_COL"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"<font color='red'>*<\/font>{#INTERVAL_NAME_COL#}","width":"180","dataIndex":"INTERVAL_NAME","itemId":"INTERVAL_NAME_COL"},"children":[{"configs":{"allowBlank":"false","itemId":"editor"},"children":[],"expanded":false,"type":"text"}],"expanded":true,"type":"column"},{"configs":{"text":"{#INTERVAL_DAYS_COL#}","width":"150","dataIndex":"INTERVAL_DAYS","itemId":"INTERVAL_DAYS_COL"},"children":[{"configs":{"itemId":"editor"},"events":{"blur":"  app.grid2.plugins[0].completeEdit();\nvar rows=app.grid2.getSelectionModel().getSelection();\n\nvar row =rows[0];\nWb.startNum = row.data.INTERVAL_START;\nvar num = number.getValue();\nvar count = app.grid2.store.getCount();\nvar curindex = app.grid2.store.find('AP_INTERVAL_ID',row.data.AP_INTERVAL_ID);\n//当前修改的就是最后一行记录则其他数据不作修改，再新增一条即可\nif(curindex==(count-1)){\n  if(num!=null){\n\n    var snum =  Wb.startNum;\n    var  endnum = snum+num-1;\n\n\n    row.set('INTERVAL_END',endnum) ;\n\n    //填写了区间天数自动添加下一行\n  \n    var startday = endnum+1;\n    Wb.startNum = startday;\n    var bkid =  Xip.getId();\n    Wb.addEdit(app.grid2,[{AP_INTERVAL_ID:bkid,AGING_TYPE_CODE:rows[0].data.AGING_TYPE_CODE,AGING_TYPE_NAME:rows[0].data.AGING_TYPE_NAME,INTERVAL_START:startday}]);\n\n\n  }\n}else{\n \n  //编辑的不是最后一行，则修改了天数需要将下面的数据都进行修改\n  var i =curindex+1;\n   var selRec = app.grid2.store.getAt(curindex);\n  var endday = selRec.data.INTERVAL_START+num-1;\n  selRec.set('INTERVAL_END',endday) ;\n    app.grid2.plugins[0].completeEdit();\n  for(i;i<count;i++){\n  \n    var currec = app.grid2.store.getAt(i-1);\n    var rec = app.grid2.store.getAt(i);\n    var setstartnum = currec.data.INTERVAL_START+ currec.data.INTERVAL_DAYS ;\n    \n\n    rec.set('INTERVAL_START',setstartnum);\n    if(i!=(count-1)){\n       var setendnum = rec.data.INTERVAL_DAYS+setstartnum-1;\n      rec.set('INTERVAL_END',setendnum);\n    }\n   \n    \n    app.grid2.plugins[0].completeEdit();\n\n     \n  }\n  \n  \n  \n}\n\n\n"},"children":[],"expanded":false,"type":"number"}],"expanded":true,"type":"column"},{"configs":{"text":"{#INTERVAL_START_COL#}","width":"150","dataIndex":"INTERVAL_START","itemId":"INTERVAL_START_COL"},"children":[{"configs":{"itemId":"editor"},"children":[],"expanded":false,"type":"number"}],"expanded":true,"type":"column"},{"configs":{"text":"{#INTERVAL_END_COL#}","width":"150","dataIndex":"INTERVAL_END","itemId":"INTERVAL_END_COL"},"children":[],"expanded":true,"type":"column"}],"expanded":true,"type":"array"}],"expanded":true,"type":"grid"}],"expanded":true,"type":"viewport"}],"expanded":true,"type":"module"}],"pageLink":"","iconCls":""}