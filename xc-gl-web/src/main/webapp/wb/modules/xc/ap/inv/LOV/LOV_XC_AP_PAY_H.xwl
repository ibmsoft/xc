{"inframe":false,"title":"付款单选择LOV","hidden":false,"roles":{"default":1},"children":[{"configs":{"serverScript":"//---------------------获取当前模块语言对应的.json文件，放到request中----------------\ncom.xzsoft.xip.platform.util.XipUtil.getCurrentLang(request,\"xc/ap/inv/json/LOV_XC_AP_INVOICE\");","itemId":"module"},"events":{"initialize":"Ext.apply(app, {\n  initWin: function(params) {\n    Ext.apply(app, params);\n    app.lovWinN = new Ext.window.Window(app.lovWinN);\n    app.lovWinN.show();\n    Wb.apInvHId = params.AP_INV_H_ID;\n    Wb.ledgerId = params.LEDGER_ID;\n    app.AP_INV_H_ID.setValue(Wb.apInvHId);\n    app.LEDGER_ID.setValue(Wb.ledgerId);\n    app.AP_DOC_CAT_CODE.setValue(params.AP_DOC_CAT_CODE);\n    app.VENDOR_ID.setValue(params.VENDOR_ID);\n    app.AP_CONTRACT_ID.setValue(params.AP_CONTRACT_ID);\n    Wb.curData=params.curData,\n    app.grid1.getStore().load();\n  }\n});\n"},"children":[{"configs":{"maximized":"true","layout":"border","closeAction":"hide","itemId":"lovWinN","modal":"true"},"events":{"close":"app.hideFun();"},"children":[{"configs":{"region":"north","itemId":"form1"},"children":[{"configs":{"layout":"column","border":"false","itemId":"tr1"},"children":[{"configs":{"layout":"form","columnWidth":".245","border":"false","itemId":"td_1_1"},"children":[{"configs":{"labelWidth":"100","labelAlign":"right","itemId":"AP_CONTRACT_NAME","fieldLabel":"{#AP_CONTRACT_NAME#}"},"events":{"specialkey":"if(e.getKey()===13){app.queryBtn.fireEvent('click');}"},"children":[],"expanded":false,"type":"text"},{"configs":{"hidden":"true","itemId":"LEDGER_ID"},"children":[],"expanded":false,"type":"text"},{"configs":{"hidden":"true","itemId":"AP_INV_H_ID"},"children":[],"expanded":false,"type":"text"},{"configs":{"hidden":"true","itemId":"VENDOR_ID"},"children":[],"expanded":false,"type":"text"},{"configs":{"hidden":"true","itemId":"AP_CONTRACT_ID"},"children":[],"expanded":false,"type":"text"},{"configs":{"hidden":"true","itemId":"AP_DOC_CAT_CODE"},"children":[],"expanded":false,"type":"text"}],"expanded":true,"type":"panel"},{"configs":{"layout":"form","columnWidth":".245","border":"false","itemId":"td_1_2"},"children":[{"configs":{"labelWidth":"100","labelAlign":"right","itemId":"AP_PAY_H_CODE","fieldLabel":"{#AP_PAY_H_CODE#}"},"events":{"specialkey":"if(e.getKey()===13){app.queryBtn.fireEvent('click');}"},"children":[],"expanded":false,"type":"text"}],"expanded":true,"type":"panel"},{"configs":{"layout":"form","columnWidth":".245","border":"false","itemId":"td_1_3"},"children":[{"configs":{"labelWidth":"100","labelAlign":"right","itemId":"CREATED_BY_NAME","fieldLabel":"{#CREATED_BY_NAME#}"},"events":{"specialkey":"if(e.getKey()===13){app.queryBtn.fireEvent('click');}"},"children":[],"expanded":false,"type":"text"}],"expanded":true,"type":"panel"},{"configs":{"layout":"fit","columnWidth":".245","border":"false","itemId":"td_3_2"},"children":[{"configs":{"layout":"column","border":"false","itemId":"tr_3_2_1"},"children":[{"configs":{"layout":"form","columnWidth":".02","border":"false","itemId":"td_3_2_1_1"},"children":[{"configs":{"itemId":"空格"},"children":[],"expanded":false,"type":"label"}],"expanded":true,"type":"panel"},{"configs":{"layout":"form","columnWidth":".25","border":"false","itemId":"td_3_2_1_2"},"children":[{"configs":{"text":"{#queryBtn#}","itemId":"queryBtn","iconCls":"seek_icon"},"events":{"click":"Wb.reload(app.grid1);"},"children":[],"expanded":false,"type":"button"}],"expanded":true,"type":"panel"},{"configs":{"layout":"form","columnWidth":".25","border":"false","itemId":"td_3_2_1_3"},"children":[{"configs":{"text":"{#clearBtn#}","itemId":"clearBtn","iconCls":"refresh_icon"},"events":{"click":"app.AP_CONTRACT_NAME.setValue('');\napp.AP_PAY_H_CODE.setValue('');\napp.CREATED_BY_NAME.setValue('');\napp.queryBtn.fireEvent('click');"},"children":[],"expanded":false,"type":"button"}],"expanded":true,"type":"panel"}],"expanded":true,"type":"panel"}],"expanded":true,"type":"panel"}],"expanded":true,"type":"panel"}],"expanded":true,"type":"form"},{"configs":{"region":"center","selType":"checkboxmodel","itemId":"grid1","editable":"true"},"children":[{"configs":{"itemId":"store","url":"m?xwl=xc/ap/inv/LOV/DB/XC_AP_PAY_H_SELECT"},"events":{"beforeload":"operation.params = Wb.getValue(app.form1);"},"children":[],"expanded":false,"type":"store"},{"configs":{"itemId":"tbar"},"children":[{"configs":{"text":"{#commitBtn#}","itemId":"commitBtn","iconCls":"check_icon"},"events":{"click":"var recs = app.grid1.getSelection();\nif (!recs.length) {\n    Wb.toast('{#selectRec1#}');\n    return;\n}\nvar rows = Wb.getData(recs);\nvar cancelAmount = 0;\nvar isContinue = false;\nWb.each(rows, function(row) {\n    row.AP_INV_PRE_ID = Xip.getId();\n    row.AP_INV_H_ID = Wb.apInvHId;\n    if(Wb.isEmpty(row.CANCEL_AMT)){\n        Wb.toast('{#selectRec4#}');\n        isContinue = false;\n        return false;\n    }\n    else{\n        isContinue = true;\n    }\n//     if(Number(row.TARGET_AMT)+Number(row.CANCEL_AMT)>Number(row.AMOUNT)){\n//         isContinue = false;\n//         Wb.toast('{#selectRec5#}');\n//         return false;\n//     }\n    if(!Wb.isEmpty(row.CANCEL_AMT)){\n        isContinue = true;\n        cancelAmount = cancelAmount+row.CANCEL_AMT;\n    } \n});\nWb.request({\n\turl : 'm?xwl=xc/ap/inv/DB/XC_AP_INVOICE_H_SELECT_BY_ID',\n    params : {AP_INV_H_ID : Wb.apInvHId},\n    success : function(resp){\n        var temp = Wb.decode(resp.responseText);\n        var CANCEL_AMT = 0;\n        Wb.request({\n            url : 'm?xwl=xc/ap/inv/LOV/DB/XC_AP_INV_PRE_SELECT',\n            params : {AP_INV_H_ID : Wb.apInvHId},\n            success : function(resps){\n                var r = Wb.decode(resps.responseText);\n                for( var i = 0;i < r.total;i++){\n                    CANCEL_AMT = CANCEL_AMT + r.rows[i].CANCEL_AMT;\n                }\n                if (Math.abs(temp.INV_AMOUNT) < Math.abs(cancelAmount + CANCEL_AMT)){\n                    Wb.toast('{#selectRec7#}');\n                    return;\n                }\n                else{\n                    if(isContinue){\n                        var isExist = false;\n                        var cdata =  Wb.curData;\n                        Wb.each(rows, function(row) {\n                            var payId = row.AP_PAY_H_ID;\n                            cdata.each(function(record) {\n                                if(record.data.AP_PAY_H_ID==payId){\n                                    Wb.toast(record.data.DESCRIPTION+\" {#selectRec6#}\");\n                                    isExist = true;\n                                    return false;\n                                }\n                                isExist = false;\n                            });\n                        });\n                        if(isExist){\n                            return;\n                        }\n                        Wb.confirm('{#confirm2#} ' + recs.length + ' {#confirm3#}', function() {\n                            Wb.request({\n                                url: 'm?xwl=xc/ap/inv/DB/XC_AP_INV_PRE_INSERT_BATCH',\n                                params: Wb.apply({\n                                  preL : rows\n                                }),\n                                success: function(resp) {\n                                    app.hideFun(recs);\n                                    app.lovWinN.close(); \n                                }\n                            });\n                        });\n                    }\n                }\n            }\n        });\n    }\n});"},"children":[],"expanded":false,"type":"button"},{"configs":{"text":"{#closeBtn#}","itemId":"closeBtn","iconCls":"delete_icon"},"events":{"click":"app.lovWinN.close();"},"children":[],"expanded":false,"type":"button"}],"expanded":true,"type":"toolbar"},{"configs":{"itemId":"columns"},"children":[{"configs":{"text":"{#order#}","align":"center","xtype":"rownumberer","width":"50","titleAlign":"center","itemId":"ORDERBY"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#GL_DATE#}","hidden":"true","width":"100","dataIndex":"GL_DATE","titleAlign":"center","itemId":"GL_DATE_COL"},"children":[],"expanded":true,"type":"column"},{"configs":{"text":"{#AP_DOC_CAT_NAME#}","width":"100","dataIndex":"AP_DOC_CAT_NAME","titleAlign":"center","itemId":"AP_DOC_CAT_NAME_COL"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#AP_PAY_H_CODE_COL#}","width":"200","dataIndex":"AP_PAY_H_CODE","titleAlign":"center","itemId":"AP_PAY_H_CODE_COL"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#DESCRIPTION#}","width":"150","dataIndex":"DESCRIPTION","titleAlign":"center","itemId":"DESCRIPTION_COL"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#AMOUNT#}","hidden":"true","align":"right","width":"100","dataIndex":"AMOUNT","format":"0,000.00","titleAlign":"center","itemId":"AMOUNT_COL"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#TARGET_AMT#}","hidden":"true","align":"right","width":"100","dataIndex":"TARGET_AMT","format":"0,000.00","titleAlign":"center","itemId":"TARGET_AMT_COL"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#CAN_TARGET_AMT#}","align":"right","width":"100","dataIndex":"CAN_TARGET_AMT","format":"0,000.00","titleAlign":"center","itemId":"CAN_TARGET_AMT_COL"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#CANCEL_AMT#}","align":"right","width":"100","dataIndex":"CANCEL_AMT","format":"0,000.00","titleAlign":"center","itemId":"CANCEL_AMT_COL","renderer":"metaData.style='background-color:#ffffd0';\nreturn Wb.format(value,'0,000.00');"},"children":[{"configs":{"itemId":"editor"},"events":{"change":"if (app.AP_DOC_CAT_CODE.getValue() == 'FKD_YUFK-H') {\n    if(newValue > 0){\n        Wb.toast(\"{#selectRec8#}\");\n        return;\n    }\n}\nif (app.AP_DOC_CAT_CODE.getValue() == 'FKD_YUFK') {\n    if(newValue < 0){\n        Wb.toast(\"{#selectRec9#}\");\n        return;\n    }\n}","focus":"var rec = app.grid1.getSelection()[0];\nvar TARGET_AMT = rec.get('TARGET_AMT');\nvar AMOUNT = rec.get('AMOUNT');\nvar CAN_TARGET_AMT = rec.get('CAN_TARGET_AMT');\nif (app.AP_DOC_CAT_CODE.getValue() == 'FKD_YUFK-H') {\n\tnumber.setMaxValue(0);\n\tnumber.setMinValue(CAN_TARGET_AMT);\n}\nelse{\n\tnumber.setMinValue(0);\n\tnumber.setMaxValue(CAN_TARGET_AMT);\n}"},"children":[],"expanded":false,"type":"number"}],"expanded":true,"type":"column"},{"configs":{"text":"{#AP_CONTRACT_NAME_COL#}","width":"150","dataIndex":"AP_CONTRACT_NAME","titleAlign":"center","itemId":"AP_CONTRACT_NAME_COL"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#DEPT_NAME#}","width":"100","dataIndex":"DEPT_NAME","titleAlign":"center","itemId":"DEPT_NAME_COL"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#PROJECT_NAME#}","width":"120","dataIndex":"PROJECT_NAME","titleAlign":"center","itemId":"PROJECT_NAME_COL"},"children":[],"expanded":false,"type":"column"}],"expanded":true,"type":"array"}],"expanded":true,"type":"grid"}],"expanded":true,"type":"window"}],"expanded":true,"type":"module"}],"pageLink":"","iconCls":""}