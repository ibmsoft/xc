{"inframe":false,"title":"付款行信息保存","hidden":false,"roles":{"default":1},"children":[{"configs":{"serverScript":"\nvar recs = Wb.decode(request.getParameter('create'));\nvar dbtype = com.xzsoft.xip.platform.util.PlatformUtil.getDbType() ;\nWb.each(recs, function(rec) {\n  rec.CREATION_DATE = Wb.format(new Date());\n  rec.CREATED_BY = request.getSession().getAttribute(\"XzSessionVars\").get('userId');\n  rec.LAST_UPDATE_DATE = Wb.format(new Date());\n  rec.LAST_UPDATED_BY = request.getSession().getAttribute(\"XzSessionVars\").get('userId');\n  //应付核预付\n  if(rec.AP_CANCEL_TYPE=='YFHYUF'){\n    //修改应付单金额\n    var sql = \"UPDATE xc_ap_inv_gl_h SET CANCEL_AMT = CANCEL_AMT + \"+rec.TARGET_AMT+\",NO_PAY_AMT = NO_PAY_AMT - \"+rec.TARGET_AMT+\" WHERE AP_INV_GL_H_ID= (select SRC_ID from xc_ap_cancel_h where AP_CANCEL_H_ID = '\"+rec.AP_CANCEL_H_ID+\"') \";\n    app.run(sql,{transaction: 'start'});\n    //新增交易明细-应付单\n    var trans_id = java.util.UUID.randomUUID();\n    var transSql = \"INSERT INTO xc_ap_inv_trans ( \"+\n        \"TRANS_ID,\"+\n        \"SOURCE_ID,\"+\n        \"SOURCE_DTL_ID,\"+\n        \"AP_INV_GL_H_ID,\"+\n        \"AP_PAY_H_ID,\"+\n        \"GL_DATE,\"+\n        \"SOURCE_TAB,\"+\n        \"AP_DOC_CAT_CODE,\"+\n        \"AP_DOC_CODE,\"+\n        \"DESCRIPTION,\"+\n        \"AP_CONTRACT_ID,\"+\n        \"VENDOR_ID,\"+\n        \"DR_AMT,\"+\n        \"CR_AMT,\"+\n        \"REQ_AMT,\"+\n        \"TRANS_STATUS,\"+\n        \"CCID,\"+\n        \"CREATION_DATE,\"+\n        \"CREATED_BY,\"+\n        \"LAST_UPDATE_DATE,\"+\n        \"LAST_UPDATED_BY )\"+\n        \" VALUES \"+\n        \"( '\"+trans_id+\"',\"+\n        \"'\"+rec.AP_CANCEL_H_ID+\"',\"+\n        \"'\"+rec.AP_CANCEL_L_ID+\"',\"+\n        \"(select SRC_ID form xc_ap_cancel_h where AP_CANCEL_H_ID = '\"+rec.AP_CANCEL_H_ID+\"'), \"+\n        \"'\"+rec.TARGET_ID+\"',\"+\n        \"(select GL_DATE from xc_ap_cancel_h where AP_CANCEL_H_ID = '\"+rec.AP_CANCEL_H_ID+\"'),\"+\n        \"'XC_AP_CANCEL_H',\"+\n        \"'HX',\"+\n        \"(select AP_CANCEL_H_CODE from xc_ap_cancel_h where AP_CANCEL_H_ID = '\"+rec.AP_CANCEL_H_ID+\"'),\"+\n        \"(select DESCRIPTION from xc_ap_cancel_h where AP_CANCEL_H_ID = '\"+rec.AP_CANCEL_H_ID+\"'),\"+\n        \"'',\"+\n        \"'',\"+\n        \"0,\"+\n        \"\"+rec.TARGET_AMT*(-1)+\",\"+\n        \"0,\"+\n        \"'0',\"+\n        \"'',\"+\n        \"'\"+rec.CREATION_DATE+\"',\"+\n        \"'\"+rec.CREATED_BY+\"',\"+\n        \"'\"+rec.LAST_UPDATE_DATE+\"',\"+\n        \"'\"+rec.LAST_UPDATED_BY+\"')\";\n    app.run(transSql,{});\n  }\n  //应付核应收（待处理）\n  if(rec.AP_CANCEL_TYPE == 'YFHYS'){\n  }\n  //应付红蓝对冲\n  if(rec.AP_CANCEL_TYPE=='YFHLDC'){\n    //修改红应付单金额\n    var sql1 = \"UPDATE xc_ap_inv_gl_h SET CANCEL_AMT = CANCEL_AMT - \"+rec.TARGET_AMT+\",NO_PAY_AMT = NO_PAY_AMT + \"+rec.TARGET_AMT+\" WHERE AP_INV_GL_H_ID = (select SRC_ID from xc_ap_cancel_h where AP_CANCEL_H_ID = '\"+rec.AP_CANCEL_H_ID+\"') \";\n    app.run(sql1,{transaction: 'start'});\n    //修改蓝应付单金额\n    var sql2 = \"UPDATE xc_ap_inv_gl_h SET CANCEL_AMT = CANCEL_AMT + \"+rec.TARGET_AMT+\",NO_PAY_AMT = NO_PAY_AMT - \"+rec.TARGET_AMT+\" WHERE AP_INV_GL_H_ID = '\"+rec.TARGET_ID+\"' \";\n    app.run(sql2,{});\n    //新增交易明细-红应付单\n    var trans_id1 = java.util.UUID.randomUUID();\n    var sql3 = \"INSERT INTO xc_ap_inv_trans ( \"+\n        \"TRANS_ID,\"+\n        \"SOURCE_ID,\"+\n        \"SOURCE_DTL_ID,\"+\n        \"AP_INV_GL_H_ID,\"+\n        \"AP_PAY_H_ID,\"+\n        \"GL_DATE,\"+\n        \"SOURCE_TAB,\"+\n        \"AP_DOC_CAT_CODE,\"+\n        \"AP_DOC_CODE,\"+\n        \"DESCRIPTION,\"+\n        \"AP_CONTRACT_ID,\"+\n        \"VENDOR_ID,\"+\n        \"DR_AMT,\"+\n        \"CR_AMT,\"+\n        \"REQ_AMT,\"+\n        \"TRANS_STATUS,\"+\n        \"CCID,\"+\n        \"CREATION_DATE,\"+\n        \"CREATED_BY,\"+\n        \"LAST_UPDATE_DATE,\"+\n        \"LAST_UPDATED_BY )\"+\n        \" VALUES \"+\n        \"( '\"+trans_id1+\"',\"+\n        \"'\"+rec.AP_CANCEL_H_ID+\"',\"+\n        \"'\"+rec.AP_CANCEL_L_ID+\"',\"+\n        \"(select SRC_ID from xc_ap_cancel_h where AP_CANCEL_H_ID = '\"+rec.AP_CANCEL_H_ID+\"'), \"+\n        \"'',\"+\n        \"(select GL_DATE from xc_ap_cancel_h where AP_CANCEL_H_ID = '\"+rec.AP_CANCEL_H_ID+\"'),\"+\n        \"'XC_AP_CANCEL_H',\"+\n        \"'HX',\"+\n        \"(select AP_CANCEL_H_CODE from xc_ap_cancel_h where AP_CANCEL_H_ID = '\"+rec.AP_CANCEL_H_ID+\"'),\"+\n        \"(select DESCRIPTION from xc_ap_cancel_h where AP_CANCEL_H_ID = '\"+rec.AP_CANCEL_H_ID+\"'),\"+\n        \"'',\"+\n        \"'',\"+\n        \"0,\"+\n        \"\"+rec.TARGET_AMT+\",\"+\n        \"0,\"+\n        \"'0',\"+\n        \"'',\"+\n        \"'\"+rec.CREATION_DATE+\"',\"+\n        \"'\"+rec.CREATED_BY+\"',\"+\n        \"'\"+rec.LAST_UPDATE_DATE+\"',\"+\n        \"'\"+rec.LAST_UPDATED_BY+\"')\";\n    app.run(sql3,{});\n    //新增交易明细-蓝应付单\n    var trans_id2 = java.util.UUID.randomUUID();\n\tvar sql4 = \"INSERT INTO xc_ap_inv_trans ( \"+\n        \"TRANS_ID,\"+\n        \"SOURCE_ID,\"+\n        \"SOURCE_DTL_ID,\"+\n        \"AP_INV_GL_H_ID,\"+\n        \"AP_PAY_H_ID,\"+\n        \"GL_DATE,\"+\n        \"SOURCE_TAB,\"+\n        \"AP_DOC_CAT_CODE,\"+\n        \"AP_DOC_CODE,\"+\n        \"DESCRIPTION,\"+\n        \"AP_CONTRACT_ID,\"+\n        \"VENDOR_ID,\"+\n        \"DR_AMT,\"+\n        \"CR_AMT,\"+\n        \"REQ_AMT,\"+\n        \"TRANS_STATUS,\"+\n        \"CCID,\"+\n        \"CREATION_DATE,\"+\n        \"CREATED_BY,\"+\n        \"LAST_UPDATE_DATE,\"+\n        \"LAST_UPDATED_BY )\"+\n        \" VALUES \"+\n        \"( '\"+trans_id2+\"',\"+\n        \"'\"+rec.AP_CANCEL_H_ID+\"',\"+\n        \"'\"+rec.AP_CANCEL_L_ID+\"',\"+\n        \"'\"+rec.TARGET_ID+\"', \"+\n        \"'',\"+\n        \"(select GL_DATE from xc_ap_cancel_h where AP_CANCEL_H_ID = '\"+rec.AP_CANCEL_H_ID+\"'),\"+\n        \"'XC_AP_CANCEL_H',\"+\n        \"'HX',\"+\n        \"(select AP_CANCEL_H_CODE from xc_ap_cancel_h where AP_CANCEL_H_ID = '\"+rec.AP_CANCEL_H_ID+\"'),\"+\n        \"(select DESCRIPTION from xc_ap_cancel_h where AP_CANCEL_H_ID = '\"+rec.AP_CANCEL_H_ID+\"'),\"+\n        \"'',\"+\n        \"'',\"+\n        \"0,\"+\n        \"\"+rec.TARGET_AMT*(-1)+\",\"+\n        \"0,\"+\n        \"'0',\"+\n        \"'',\"+\n        \"'\"+rec.CREATION_DATE+\"',\"+\n        \"'\"+rec.CREATED_BY+\"',\"+\n        \"'\"+rec.LAST_UPDATE_DATE+\"',\"+\n        \"'\"+rec.LAST_UPDATED_BY+\"')\";\n    app.run(sql4,{});\n        \n    }\n  //预付红蓝对冲（无处理）\n  if(rec.AP_CANCEL_TYPE=='YUFHLDC'){}\n});\nrequest.setAttribute('create', Wb.encode(recs)); \n\nrecs = Wb.decode(request.getParameter('update'));\nWb.each(recs, function(rec) {\n  rec.LAST_UPDATE_DATE = new Date();\n  rec.LAST_UPDATED_BY = request.getSession().getAttribute(\"XzSessionVars\").get('userId');\n});\nrequest.setAttribute('update', Wb.encode(recs));\n\nrecs = Wb.decode(request.getParameter('destroy'));\nWb.each(recs, function(rec) {\n  //应付核预付\n  if(rec.AP_CANCEL_TYPE=='YFHYUF'){\n    //修改应付单金额\n    app.run(\"UPDATE xc_ap_inv_gl_h SET CANCEL_AMT = CANCEL_AMT - \"+data.TARGET_AMT+\",NO_PAY_AMT = NO_PAY_AMT + \"+data.TARGET_AMT+\" WHERE AP_INV_GL_H_ID= '\"+data.TARGET_ID+\"' \",{\n      transaction: 'start'\n    });\n    //删除交易明细\n    app.run('delete from xc_ap_inv_trans where SOURCE_ID=\\''+rec.AP_CANCEL_H_ID+'\\' and SOURCE_DTL_ID=\\''+rec.AP_CANCEL_L_ID+'\\'',{\n    });\n  }\n  //应付核应收\n  if(rec.AP_CANCEL_TYPE=='YFHYS'){}\n  //应付红蓝对冲\n  if(rec.AP_CANCEL_TYPE=='YFHLDC'){\n    //修改红应付单金额\n    var sql1 = \"UPDATE xc_ap_inv_gl_h SET CANCEL_AMT = CANCEL_AMT + \"+rec.TARGET_AMT+\",NO_PAY_AMT = NO_PAY_AMT - \"+rec.TARGET_AMT+\" WHERE AP_INV_GL_H_ID = (select SRC_ID from xc_ap_cancel_h where AP_CANCEL_H_ID = '\"+rec.AP_CANCEL_H_ID+\"') \";\n    app.run(sql1,{transaction: 'start'});\n    //修改蓝应付单金额\n    var sql2 = \"UPDATE xc_ap_inv_gl_h SET CANCEL_AMT = CANCEL_AMT - \"+rec.TARGET_AMT+\",NO_PAY_AMT = NO_PAY_AMT + \"+rec.TARGET_AMT+\" WHERE AP_INV_GL_H_ID = '\"+rec.TARGET_ID+\"' \";\n    app.run(sql2,{});\n    //删除交易明细-红应付单\n    var sql3 = \"delete from xc_ap_inv_trans where SOURCE_ID='\"+rec.AP_CANCEL_H_ID+\"' and SOURCE_DTL_ID='\"+rec.AP_CANCEL_L_ID+\"'\";\n    app.run(sql3,{});\n    //删除交易明细-蓝应付单(红蓝删除语句一样)\n\t//var sql4 = \"delete from xc_ap_inv_trans where SOURCE_ID='\"+rec.AP_CANCEL_H_ID+\"' and SOURCE_DTL_ID='\"+rec.AP_CANCEL_L_ID+\"'\";\n    //app.run(sql4,{});\n  }\n  //预付红蓝对冲\n  if(rec.AP_CANCEL_TYPE=='YUFHLDC'){}\n});\napp.update({\n  tableName: 'XC_AP_CANCEL_L'\n});","itemId":"module"},"children":[],"expanded":true,"type":"module"}],"pageLink":"","iconCls":""}