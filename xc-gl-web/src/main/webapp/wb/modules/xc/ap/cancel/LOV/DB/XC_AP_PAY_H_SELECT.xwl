{"inframe":false,"title":"查询付款单","hidden":false,"roles":{"default":1},"children":[{"configs":{"serverScript":"/*\n核销单 \n核销类型：应付核预付 预付红蓝对冲\n过滤条件1（死）：账簿、供应商、单据类型（预付款红蓝）、余额不为0、审核通过\n过滤条件2（活）：付款单编码、制单人\n过滤条件3（待考虑，暂不实现）：来源单据的合同\n*/\nvar sql = '';\nvar data = app.get();\n\nvar cancel_type = data.AP_CANCEL_TYPE;\n\n//核销类型\nif(cancel_type == 'YFHYUF'){\n\n  var results = app.run(\"SELECT AP_DOC_CAT_CODE,AP_CONTRACT_ID  FROM xc_ap_inv_gl_h WHERE AP_INV_GL_H_ID = '\"+data.SRC_ID+\"'\");\t\t\t\n\n  if(results.next()){\n    var ap_doc_cat_code = results.getString('AP_DOC_CAT_CODE');\n//     var ap_contract_id = results.getString('AP_CONTRACT_ID');\n    //合同\n//     if(!Wb.isEmpty(ap_contract_id)){\n//       sql += \" AND h.AP_CONTRACT_ID = '\"+ap_contract_id+\"'\";\n//     }\n    //单据类型//余额\n    if(ap_doc_cat_code == 'YFD'){\n      sql += \" AND h.AP_DOC_CAT_CODE = 'FKD_YUFK'\";\n      sql += \" AND l.NO_CANCEL_AMT > 0\";\n    }else if(ap_doc_cat_code == 'YFD-H'){\n      sql += \" AND h.AP_DOC_CAT_CODE = 'FKD_YUFK-H'\";\n      sql += \" AND l.NO_CANCEL_AMT < 0\";\n    }\n  }\n  \n}else if(cancel_type == 'YUFHLDC'){\n  //合同\n  //sql += \" AND h.AP_CONTRACT_ID = (SELECT AP_CONTRACT_ID FROM xc_ap_pay_h WHERE AP_PAY_H_ID = '\"+data.SRC_ID+\"')\";\n  //单据类型\n  sql += \" AND h.AP_DOC_CAT_CODE = 'FKD_YUFK'\";\n  //余额\n  sql += \" AND l.NO_CANCEL_AMT > 0\";\n}\n\n// //付款单编码\n// if(!Wb.isEmpty(data.AP_PAY_H_CODE)){\n//   sql += \" AND h.AP_PAY_H_CODE LIKE '%\"+data.AP_PAY_H_CODE+\"%'\";\n// }\n// //制单人\n// if(!Wb.isEmpty(data.CREATED_BY_NAME)){\n//   sql += \" AND emp.EMP_NAME LIKE '%\"+data.CREATED_BY_NAME+\"%'\";\n// }\n// //合同\n// if(!Wb.isEmpty(data.AP_CONTRACT_NAME)){\n//   sql += \" AND contrat.AP_CONTRACT_NAME LIKE '%\"+data.AP_CONTRACT_NAME+\"%'\";\n// }\nrequest.setAttribute('sql', sql);","itemId":"module"},"children":[{"configs":{"oracle":"SELECT\n\tl.AP_PAY_H_ID,\n\tNVL(l.AMOUNT,0) AS AMOUNT,\n\tNVL(l.CANCEL_AMT,0) AS CANCEL_AMT,\n\tNVL(l.NO_CANCEL_AMT,0) AS NO_CANCEL_AMT,\n\tl.ACC_ID,\n\tl.CCID,\n\th.AP_PAY_H_CODE,\n\th.GL_DATE,\n\th.DESCRIPTION,\n\th.AP_CONTRACT_ID,\n\th.VENDOR_ID,\n\th.DEPT_ID,\n\th.PROJECT_ID,\n\th.CREATED_BY,\n\taccount.ACC_NAME,\n\tccid.CCID_NAME,\n\tcontract.AP_CONTRACT_NAME,\n\tvendor.VENDOR_NAME,\n\tdept.DEPT_NAME,\n\tproject.PROJECT_NAME,\n\temp.EMP_NAME AS CREATED_BY_NAME\nFROM\n\txc_ap_pay_l l\n\t\tLEFT JOIN xc_gl_accounts account ON account.ACC_ID = l.ACC_ID\n\t\tLEFT JOIN xc_gl_ccid ccid ON ccid.CCID = l.CCID,\n  \txc_ap_pay_h h\n\t\tLEFT JOIN xc_gl_ledgers ledger ON ledger.LEDGER_ID = h.LEDGER_ID\n\t\tLEFT JOIN xc_ap_contract contract ON contract.AP_CONTRACT_ID = h.AP_CONTRACT_ID\n\t\tLEFT JOIN xc_ap_vendors vendor ON vendor.VENDOR_ID = h.VENDOR_ID\n\t\tLEFT JOIN xip_pub_depts dept ON dept.DEPT_ID = h.DEPT_ID\n\t\tLEFT JOIN xc_pm_projects project ON project.PROJECT_ID = h.PROJECT_ID\n\t\tLEFT JOIN xip_pub_emps emp ON emp.EMP_ID = (SELECT EMP_ID FROM xip_pub_users WHERE USER_ID=h.CREATED_BY)\nWHERE\n\tl.AP_PAY_H_ID = h.AP_PAY_H_ID\nAND h.LEDGER_ID = {?LEDGER_ID?}\nAND h.VENDOR_ID = {?VENDOR_ID?}\nAND h.V_STATUS >= 3\nAND h.AP_PAY_H_CODE IS NOT NULL\nAND h.AP_PAY_H_CODE <> ''\n{#sql#}\nAND (contract.AP_CONTRACT_CODE LIKE '%{#AP_CONTRACT_NAME#}%' OR contract.AP_CONTRACT_NAME LIKE '%{#AP_CONTRACT_NAME#}%')\nAND (h.AP_PAY_H_CODE LIKE '%{#AP_PAY_H_CODE#}%' OR h.DESCRIPTION LIKE '%{#AP_PAY_H_CODE#}%')\nAND emp.EMP_NAME LIKE '%{#CREATED_BY_NAME#}%'\n\nORDER BY \n\th.CREATION_DATE DESC","itemId":"sqlswitcher1","mysql":"SELECT\n\tl.AP_PAY_H_ID,\n\tIFNULL(l.AMOUNT,0) AS AMOUNT,\n\tIFNULL(l.CANCEL_AMT,0) AS CANCEL_AMT,\n\tIFNULL(l.NO_CANCEL_AMT,0) AS NO_CANCEL_AMT,\n\tl.ACC_ID,\n\tl.CCID,\n\th.AP_PAY_H_CODE,\n\th.GL_DATE,\n\th.DESCRIPTION,\n\th.AP_CONTRACT_ID,\n\th.VENDOR_ID,\n\th.DEPT_ID,\n\th.PROJECT_ID,\n\th.CREATED_BY,\n\taccount.ACC_NAME,\n\tccid.CCID_NAME,\n\tcontract.AP_CONTRACT_NAME,\n\tvendor.VENDOR_NAME,\n\tdept.DEPT_NAME,\n\tproject.PROJECT_NAME,\n\temp.EMP_NAME AS CREATED_BY_NAME\nFROM\n\txc_ap_pay_l l\n\t\tLEFT JOIN xc_gl_accounts account ON account.ACC_ID = l.ACC_ID\n\t\tLEFT JOIN xc_gl_ccid ccid ON ccid.CCID = l.CCID,\n  \txc_ap_pay_h h\n\t\tLEFT JOIN xc_gl_ledgers ledger ON ledger.LEDGER_ID = h.LEDGER_ID\n\t\tLEFT JOIN xc_ap_contract contract ON contract.AP_CONTRACT_ID = h.AP_CONTRACT_ID\n\t\tLEFT JOIN xc_ap_vendors vendor ON vendor.VENDOR_ID = h.VENDOR_ID\n\t\tLEFT JOIN xip_pub_depts dept ON dept.DEPT_ID = h.DEPT_ID\n\t\tLEFT JOIN xc_pm_projects project ON project.PROJECT_ID = h.PROJECT_ID\n\t\tLEFT JOIN xip_pub_emps emp ON emp.EMP_ID = (SELECT EMP_ID FROM xip_pub_users WHERE USER_ID=h.CREATED_BY)\nWHERE\n\tl.AP_PAY_H_ID = h.AP_PAY_H_ID\nAND h.LEDGER_ID = {?LEDGER_ID?}\nAND h.VENDOR_ID = {?VENDOR_ID?}\nAND h.V_STATUS >= 3\nAND h.AP_PAY_H_CODE IS NOT NULL\nAND h.AP_PAY_H_CODE <> ''\n{#sql#}\nAND (contract.AP_CONTRACT_CODE LIKE '%{#AP_CONTRACT_NAME#}%' OR contract.AP_CONTRACT_NAME LIKE '%{#AP_CONTRACT_NAME#}%')\nAND (h.AP_PAY_H_CODE LIKE '%{#AP_PAY_H_CODE#}%' OR h.DESCRIPTION LIKE '%{#AP_PAY_H_CODE#}%')\nAND emp.EMP_NAME LIKE '%{#CREATED_BY_NAME#}%'\n\nORDER BY \n\th.CREATION_DATE DESC"},"children":[],"expanded":false,"type":"sqlswitcher"},{"configs":{"sql":"{#sqlswitcher1#}","itemId":"dataprovider1"},"children":[],"expanded":false,"type":"dataprovider"}],"expanded":true,"type":"module"}],"pageLink":"","iconCls":"search_icon"}