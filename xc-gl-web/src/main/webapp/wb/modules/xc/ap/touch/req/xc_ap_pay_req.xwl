{"inframe":true,"title":"","hidden":false,"roles":{"default":1},"children":[{"configs":{"jsLinks":"[\"xip/js/xipWfTouch-debug.js\"]","serverScript":"// TODO: 应用访问全地址及根目录存入request对象\nvar protocol = request.getProtocol() ;\nvar ipAddr = request.getServerName();\nvar port = request.getServerPort() ;\nvar ctxPath = request.getContextPath() ;\n\nvar pp = protocol.substr(0,5) ;\nprotocol = (pp.indexOf(\"https\") == -1 ? \"http\" : \"https\") ;\n\nvar url = protocol + \"://\" + ipAddr +\":\" + port + ctxPath ;\n\nrequest.setAttribute(\"appIP\",url);\nrequest.setAttribute('contextPath',ctxPath);\n\n// TODO: 获取地址参数信息\nvar op = request.getParameter('op');//得到操作类型\nvar payReqHId = request.getParameter('ap_pay_req_h_id');//得到付款申请单主表ID\nvar status = request.getParameter('status');//得到审批状态\nvar docCatCode = request.getParameter('docCatCode');//得到单据类型\nvar funId = request.getParameter('funId') ;\nvar appId = request.getParameter('appId') ; \n//var bizId = request.getParameter('businessId');//流程中的主键ID\n\nrequest.setAttribute('op',op);\nrequest.setAttribute('payReqHId',payReqHId);\nrequest.setAttribute('status',status);\nrequest.setAttribute('docCatCode',docCatCode);\n//request.setAttribute('a_docId',bizId);\nrequest.setAttribute(\"funId\",funId);\nrequest.setAttribute(\"appId\",appId);\nrequest.setAttribute(\"userId\",'{#XIP.userId#}');\n\n","itemId":"module"},"events":{"initialize":"var loadList;//传入的list\nvar orderNo;//明细序号\nWb.isInsert = 'Y';\nvar deleteDtl = [];\nExt.apply(app,{//获取list\n  flashStore:function(list){\n    loadList = list;\n  }\n});\nWb.apply(app, {\n  xipMainNav: null,\n  init: function(mainNav) {\n    if (mainNav) {\n      app.xipMainNav = mainNav;\n    }\n  }\n});\n//通过付款申请单ID查找单据信息\nfunction seekById(payReqHId){\n  Wb.request({\n    url:'m?xwl=xc/ap/touch/req/xc_ap_pay_req_myDB/getPayReqHById',\n    params:{'payReqHId':payReqHId},\n    success:function(resp){\n      var rec = Wb.decode(resp.responseText);\n      var ledgerId = rec.rows[0].LEDGER_ID;\n      var docCatCode = rec.rows[0].AP_DOC_CAT_CODE;\n      var vendorId = rec.rows[0].VENDOR_ID;\n      var contractId =rec.rows[0].AP_CONTRACT_ID;\n      var deptId = rec.rows[0].DEPT_ID;\n      var projectId = rec.rows[0].PROJECT_ID;\n      var amount = rec.rows[0].AMOUNT;\n      var description = rec.rows[0].DESCRIPTION;\n      var accountName = rec.rows[0].ACCOUNT_NAME;\n      var bankName = rec.rows[0].DEPOSIT_BANK_NAME;\n      var bankAccount = rec.rows[0].BANK_ACCOUNT;\n      var insCode = rec.rows[0].INS_CODE;\n      app.VENDOR_ID.getStore().load({\n        params:{'ledger_id':ledgerId},\n        callback:function(){\n          app.DEPT_ID.getStore().load({\n            params:{'ledger_id':ledgerId},callback:function(){\n              app.ACCOUNT_NAME.getStore().load({\n                params:{'vendor_id':vendorId},\n                callback:function(){\n                  app.PROJECT_ID.getStore().load({ \n                    params:{'ledgerId':ledgerId,'deptId':deptId},\n                    callback:function(records, operation, success){\n                      app.AP_CONTRACT_ID.getStore().load({\n                      \tparams:{'ledgerId':ledgerId,'vendorId':vendorId},\n                        callback:function(){\n                        \tapp.AP_PAY_REQ_H_ID.setValue(payReqHId);\n                      \t\tapp.LEDGER_ID.setValue(ledgerId);\n                      \t\tapp.AP_DOC_CAT_CODE.setValue(docCatCode);\n                      \t\tapp.VENDOR_ID.setValue(vendorId);\n                      \t\tapp.AP_CONTRACT_ID.setValue(contractId);\n                      \t\tapp.DEPT_ID.setValue(deptId);\n                      \t\tapp.PROJECT_ID.setValue(projectId);\n                      \t\tapp.AMOUNT.setValue(amount);\n                     \t\tapp.DESCRIPTION.setValue(description);\n                      \t\tapp.ACCOUNT_NAME.setValue(accountName);\n                      \t\tapp.BANK_ACCOUNT.setValue(bankAccount);\n                      \t\tapp.DEPOSIT_BANK_NAME.setValue(bankName);\n                      \t\tapp.INS_CODE.setValue(insCode);\n                      \t\tapp.AP_CONTRACT_ID.setValue(contractId);\n                        }\n                      });//加载合同\n                      \n                    }\n                  });//加载项目\n                }\n              });\n            }\n          });//加载成本中心     \n        }\n      });//加载供应商\n\n\n\n\n\n    }\n  });\n}\n//通过付款申请单ID查找单据明细,并给明细赋值\nfunction seekDtlById(payReqHId){\n  Wb.request({\n    url:'m?xwl=xc/ap/touch/req/xc_ap_pay_req_myDB/getPayReqLById',\n    params:{'payReqHId':payReqHId},\n    success:function(resp){\n      var rec = Wb.decode(resp.responseText);\n      for(var i=0;i<rec.total;i++){\n        addDtl();\n        var dtl = app.containerdtl.getAt(i);\n        var fieldSet = dtl.getAt(0);\n        fieldSet.getAt(2).setValue(rec.rows[i].AP_INV_GL_H_ID);\n        fieldSet.getAt(3).setValue(rec.rows[i].ap_inv_gl_h_code);\n        fieldSet.getAt(5).setValue(rec.rows[i].AMOUNT);\n        fieldSet.getAt(1).setValue(rec.rows[i].AP_PAY_REQ_L_ID);\n        fieldSet.getAt(4).setHidden(true);//可支付金额隐藏\n        fieldSet.getAt(6).setValue(rec.rows[i].DESCRIPTION);\n        fieldSet.getAt(7).setValue(rec.rows[i].AP_CONTRACT_ID);\n      }\n    }\n  });\n}\nfunction addDtl(){\n  var toolbar = new Ext.Toolbar({\n    style:{'background':'#F7F7F7','border-bottom':'1px solid #DDDDDD'},\n    items: [\n      {\n        xtype: \"label\",\n        html: \"<span style='color:gray'>明细<\/span>\"\n      },\n      {\n        xtype: \"spacer\"\n      },\n      {\n        xtype: \"button\",\n        text: \"删除\",\n        listeners:{\n          tap: function(){\n            var filedSet = this.getParent().getParent();\n            var component = filedSet.getParent();\n            var reqLId = filedSet.getAt(1).getValue();\n            var invHId = filedSet.getAt(2).getValue();\n            Ext.Msg.confirm('提示','是否删除明细？',function(btn){\n              if(btn=='yes'){\n           \n                if(Ext.isEmpty(reqLId)){\n                  app.containerdtl.remove(component);\n                }else{\n\t\t\t\t\tvar deleteData = {'AP_PAY_REQ_L_ID':reqLId,'AP_INV_GL_H_ID':invHId};\n                \tdeleteDtl.push(deleteData);\n                  \t app.containerdtl.remove(component);\n                }       \n              }\n            });\n          }\n        }\n      }]\n  });\n\n  var container = Ext.create('Ext.Container',{\n    xtype: 'container',\n    items:[{\n      name:\"fieldSet\",\n      xtype:\"fieldset\",\n      items:[\n        toolbar,\n        {\n          hidden: true,\n          name: \"AP_PAY_REQ_L_ID\",\n          xtype: \"textfield\"\n        }, \n        {\n          name: \"AP_INV_GL_H_ID\",\n          label: \"<font color=red>*<\/font>应付单：\",\n          labelWidth: 100,\n          clearIcon: false,\n          hidden:true,\n          xtype: \"textfield\"\n        }, \n        {\n          name: \"AP_INV_GL_H_CODE\",\n          label: \"<font color=red>*<\/font>应付单：\",\n          labelWidth: 100,\n          clearIcon: false,\n          //readOnly:true,\n          xtype: \"textfield\",\n          listeners:{\n            focus:function(select,e,eOpts){\n              var invContainer = mainNav.down('#invContainer');\n              if (invContainer === null || invContainer === undefined) {\n                mainNav.push(app._invContainer);\n              }\n              else{\n                mainNav.setActiveItem(invContainer);\n                this.getParent().getParent().getAt(0).getAt(4).setHidden(false);//可支付金额显示\n              }\n              orderNo = this.getParent().getParent().getAt(0).getAt(0).getAt(0).getHtml().substring(42,43);\n\n            }\n          }\n        },\n        {\n          name: \"NO_REQ_AMT\",\n          label: \"<font color=red>*<\/font>可支付金额\",\n          labelWidth: 160,\n          readOnly:true,\n          xtype: \"numberfield\"\n        },\n        {\n          name: \"AMOUNT\",\n          label: \"<font color=red>*<\/font>申请金额\",\n          labelWidth: 100,\n          xtype: \"numberfield\",\n          listeners:{\n            change:function(text,newValue,oldValue){\n              var noReqAmt = this.getParent().getParent().getAt(0).getAt(4).getValue();\n              if(newValue>noReqAmt){\n\n              }\n            }\n          }\n        },\n        {\n          name: \"DESCRIPTION\",\n          label: \"<font color=red>*<\/font>摘要\",\n          labelWidth: 100,\n          xtype: \"textfield\"\n        },\n        {\n          name: \"AP_CONTRACT_ID\",\n          label: \"<font color=red>*<\/font>合同ID\",\n          labelWidth: 100,\n          hidden:true,\n          xtype: \"textfield\"\n        },\n        {\n          name: \"purTypeId\",\n          label: \"<font color=red>*<\/font>采购类型ID\",\n          labelWidth: 100,\n          hidden:true,\n          xtype: \"textfield\"\n        }\n      ]\n    }]\n  });\n  app.containerdtl.add(container);\n  //设置明细标题\n  var count = app.containerdtl.items.length;\n  for(var i=0; i<count; i++){\n    var label = toolbar.getAt(0);\n    label.setHtml('<span style=\"color:gray;font-size:14px\">明细'+(i+1)+'<\/span>');\n    var dtl = app.containerdtl.getAt(i);//获取明细容器\n    var fieldset = dtl.getAt(0);//获取fieldset\n    fieldset.getAt(1).setValue(Xip.getId());\n  }\n}\nfunction getReqDtl(){\n  //明细的数量\n  var count = app.containerdtl.items.length;\n  //定义明细数据集合\n  var datas = [];\n  //获取明细数据\n  for(var i=0;i<count;i++){\n    var dtl = app.containerdtl.getAt(i);//获取明细容器\n    var fieldset = dtl.getAt(0);//获取fieldset\n    var payReqLId = fieldset.getAt(1).getValue();\n    var payReqHId = app.AP_PAY_REQ_H_ID.getValue();\n    var invHId = fieldset.getAt(2).getValue();\n    var contractId = fieldset.getAt(7).getValue();\n    var amount =  fieldset.getAt(5).getValue();\n    var description  = fieldset.getAt(6).getValue();\n    var data = {\n      AP_PAY_REQ_L_ID:payReqLId,\n      AP_PAY_REQ_H_ID:payReqHId,\n      AP_INV_GL_H_ID:invHId,\n      AP_CONTRACT_ID:contractId,\n      AMOUNT:amount,\n      DESCRIPTION:description\n    };\n    datas.push(data);\n  }\n  return datas;\n\n}\n"},"children":[{"configs":{"layout":"fit","scrollable":"true","itemId":"viewport1"},"children":[{"configs":{"scrollable":"true","itemId":"containerTotal"},"events":{"initialize":"var op = '{#op#}';//操作类型\nvar docCatCode = '{#docCatCode#}';//单据类型\nvar status = '{#status#}';//审批状态\nvar payReqHId = '{#payReqHId#}';\nif(payReqHId!=''){\n seekById(payReqHId);\n seekDtlById(payReqHId);\n Wb.isInsert = 'N';\n}else{\n  \t  app.LEDGER_ID.getStore().load({\n      \tcallback:function(){\n        app.LEDGER_ID.setValue(app.LEDGER_ID.getStore().getAt(0).get('LEDGER_ID'));\n        }\n      });\n  \tapp.AP_DOC_CAT_CODE.getStore().load({\n    \tcallback:function(){\n        \tapp.AP_DOC_CAT_CODE.setValue(docCatCode);\n        }\n    });\n\tapp.AUDIT_STATUS.setValue('A');\n}\nif(docCatCode=='CGJS'){\n  app.AMOUNT.setReadOnly(true);\n}\napp.BIZ_DATE.setValue(new Date());//业务日期赋值\nif(status=='A'&&op=='write'&&docCatCode=='YUFK'){//状态：起草 单据类型：预付款\n   app.saveBtn.setHidden(false);\n   app.submitAndApprove.setHidden(false);\n   app.monitorBtn.setHidden(true);//按钮隐藏\n   app.traceBtn.setHidden(true);\n   app.cancelBtn.setHidden(true);\n   app.addDetailBtn.setHidden(true);\n}\nif(status=='A'&&op=='write'&&docCatCode=='CGJS'){//状态：起草 单据类型：采购结算\n   app.saveBtn.setHidden(false);\n   app.submitAndApprove.setHidden(false);\n   app.monitorBtn.setHidden(true);//按钮隐藏\n   app.traceBtn.setHidden(true);\n   app.cancelBtn.setHidden(true);\n   app.addDetailBtn.setHidden(false);\n}\nif(status=='A'&&op=='write'&&docCatCode=='YUFK'){//状态：起草 单据类型：预付款\n   app.saveBtn.setHidden(false);\n   app.submitAndApprove.setHidden(false);\n   app.monitorBtn.setHidden(true);//按钮隐藏\n   app.traceBtn.setHidden(true);\n   app.cancelBtn.setHidden(true);\n   app.addDetailBtn.setHidden(true);\n}\nif(status==''&&op=='write'&&docCatCode=='CGJS'){//状态：起草 单据类型：采购结算\n   app.saveBtn.setHidden(false);\n   app.submitAndApprove.setHidden(false);\n   app.monitorBtn.setHidden(true);//按钮隐藏\n   app.traceBtn.setHidden(true);\n   app.cancelBtn.setHidden(true);\n   app.addDetailBtn.setHidden(true);\n}\nif(status=='C'&&op=='write'&&docCatCode=='YUFK'){//状态：运行中 单据类型：预付款\n   app.saveBtn.setHidden(true);\n   app.submitAndApprove.setHidden(true);\n   app.monitorBtn.setHidden(false);//按钮隐藏\n   app.traceBtn.setHidden(false);\n   app.cancelBtn.setHidden(false);\n   app.addDetailBtn.setHidden(true);\n}\nif(status=='C'&&op=='write'&&docCatCode=='CGJS'){//状态：运行中 单据类型：采购结算\n   app.saveBtn.setHidden(true);\n   app.submitAndApprove.setHidden(true);\n   app.monitorBtn.setHidden(false);//按钮隐藏\n   app.traceBtn.setHidden(false);\n   app.cancelBtn.setHidden(false);\n   app.addDetailBtn.setHidden(true);\n}\nif(status=='D'&&op=='write'&&docCatCode=='YUFK'){//状态：驳回 单据类型：预付款\n   app.saveBtn.setHidden(false);\n   app.submitAndApprove.setHidden(false);\n   app.monitorBtn.setHidden(false);//按钮隐藏\n   app.traceBtn.setHidden(false);\n   app.cancel.setHidden(true);\n   app.addDetailBtn.setHidden(true);\n}\nif(status=='D'&&op=='write'&&docCatCode=='CGJS'){//状态：驳回 单据类型：采购结算\n   app.saveBtn.setHidden(false);\n   app.submitAndApprove.setHidden(false);\n   app.monitorBtn.setHidden(false);//按钮隐藏\n   app.traceBtn.setHidden(false);\n   app.cancel.setHidden(true);\n   app.addDetailBtn.setHidden(false);\n}\nif(status=='E'&&op=='write'&&docCatCode=='YUFK'){//状态：审批通过 单据类型：预付款\n   app.saveBtn.setHidden(true);\n   app.submitAndApprove.setHidden(true);\n   app.monitorBtn.setHidden(false);//按钮隐藏\n   app.traceBtn.setHidden(false);\n   app.cancelBtn.setHidden(true);\n   app.addDetailBtn.setHidden(true);\n}\nif(status=='E'&&op=='write'&&docCatCode=='CGJS'){//状态：审批通过 单据类型：采购结算\n   app.saveBtn.setHidden(true);\n   app.submitAndApprove.setHidden(true);\n   app.monitorBtn.setHidden(false);//按钮隐藏\n   app.traceBtn.setHidden(false);\n   app.cancelBtn.setHidden(false);\n   app.addDetailBtn.setHidden(true);\n}\nif(status=='R'&&op=='write'&&docCatCode=='YUFK'){//状态：撤回 单据类型：预付款\n   app.saveBtn.setHidden(false);\n   app.submitAndApprove.setHidden(false);\n   app.monitorBtn.setHidden(false);//按钮隐藏\n   app.traceBtn.setHidden(false);\n   app.cancelBtn.setHidden(true);\n   app.addDetailBtn.setHidden(true);\n}\nif(status=='R'&&op=='write'&&docCatCode=='CGJS'){//状态：撤回 单据类型：采购结算\n   app.saveBtn.setHidden(false);\n   app.submitAndApprove.setHidden(false);\n   app.monitorBtn.setHidden(false);//按钮隐藏\n   app.traceBtn.setHidden(false);\n   app.cancelBtn.setHidden(true);\n   app.addDetailBtn.setHidden(false);\n}\nif(status==''&&op=='write'&&docCatCode=='YUFK'){//状态：空 单据类型：预付款\n   app.saveBtn.setHidden(false);\n   app.submitAndApprove.setHidden(false);\n   app.monitorBtn.setHidden(true);//按钮隐藏\n   app.traceBtn.setHidden(true);\n   app.cancelBtn.setHidden(true);\n   app.addDetailBtn.setHidden(true);\n}\nif(status==''&&op=='write'&&docCatCode=='CGJS'){//状态：空 单据类型：采购结算\n   app.saveBtn.setHidden(false);\n   app.submitAndApprove.setHidden(false);\n   app.monitorBtn.setHidden(true);//按钮隐藏\n   app.traceBtn.setHidden(true);\n   app.cancelBtn.setHidden(true);\n   app.addDetailBtn.setHidden(false);\n}\n"},"children":[{"configs":{"itemId":"container1"},"children":[{"configs":{"itemId":"content","border":"0"},"children":[{"configs":{"labelWidth":"110","height":"50","displayField":"LEDGER_NAME","valueField":"LEDGER_ID","label":"<font color=\"red\">*<\/font>账 簿:","labelAlign":"left","itemId":"LEDGER_ID"},"events":{"change":"var ledger_id = app.LEDGER_ID.getValue();//账簿ID\napp.VENDOR_ID.getStore().load({params:{'ledger_id':ledger_id}});//加载供应商\napp.DEPT_ID.getStore().load({params:{'ledger_id':ledger_id}});//加载成本中心\napp.AP_CONTRACT_ID.getStore().load({params:{'vendorId':app.VENDOR_ID.getValue(),'ledgerId':newValue}});//加载合同\napp.PROJECT_ID.getStore().load({params:{'ledgerId':newValue,'deptId':app.DEPT_ID.getValue()}});\nWb.request({//组织ID赋值\n\turl:'m?xwl=xc/ap/touch/req/xc_ap_pay_req_myDB/select-ld-org',\n  \tparams:{'ledgerId':newValue},\n  \tsuccess:function(resp){\n      var record = Wb.decode(resp.responseText);\n      app.ORG_ID.setValue(record.rows[0].ORG_ID);\n    }\n});\n//清空\napp.VENDOR_ID.reset();//清空供应商\napp.AP_CONTRACT_ID.reset();//清空合同\napp.DEPT_ID.reset();//清空成本中心\napp.PROJECT_ID.reset();//清空项目"},"children":[{"configs":{"itemId":"store","autoLoad":"true","url":"m?xwl=xc/com-qry/gl-ledgers/select-sec-fd-ledgers"},"children":[],"expanded":false,"type":"tstore"}],"expanded":false,"type":"tselect"},{"configs":{"labelWidth":"110","readOnly":"true","displayField":"ap_cat_name","valueField":"ap_doc_cat_code","label":"<font color=\"red\">*<\/font>单据类型:","labelAlign":"left","itemId":"AP_DOC_CAT_CODE"},"children":[{"configs":{"itemId":"store","autoLoad":"true","url":"m?xwl=xc/ap/touch/req/xc_ap_pay_req_myDB/getDocCat"},"children":[],"expanded":false,"type":"tstore"}],"expanded":true,"type":"tselect"},{"configs":{"labelWidth":"110","readOnly":"true","displayField":"vendor_name","valueField":"vendor_id","label":"<font color=\"red\">*<\/font>供应商:","labelAlign":"left","itemId":"VENDOR_ID"},"events":{"change":"app.ACCOUNT_NAME.getStore().load({params:{'vendor_id':newValue}});//加载供应商开户名\napp.AP_CONTRACT_ID.getStore().load({params:{'vendorId':newValue,'ledgerId':app.LEDGER_ID.getValue()}});//加载合同\nif(!oldValue==''){\n app.AP_CONTRACT_ID.reset();//清空合同\n}\n","focus":"var vendorContainer = mainNav.down('#vendorContainer');\nif (vendorContainer === null || vendorContainer === undefined) {\n  mainNav.push(app.vendorContainer);\n}\nelse{\n  mainNav.setActiveItem(vendorContainer);\n}"},"children":[{"configs":{"itemId":"store","url":"m?xwl=xc/ap/touch/req/xc_ap_pay_req_myDB/getVendor"},"children":[],"expanded":false,"type":"tstore"}],"expanded":false,"type":"tselect"},{"configs":{"labelWidth":"110","displayField":"ap_contract_name","valueField":"ap_contract_id","label":"<font color=\"red\">*<\/font>合同名称:","labelAlign":"left","itemId":"AP_CONTRACT_ID"},"events":{"change":"Wb.request({\n\turl:'m?xwl=xc/ap/touch/req/xc_ap_pay_req_myDB/getContract',\n  \tparams:{'ledgerId':app.LEDGER_ID.getValue()},\n  \tsuccess:function(resp){\n     var rec = Wb.decode(resp.responseText);\n      for(var i=0;i<rec.total;i++){\n        if(rec.rows[i].ap_contract_id === newValue){\n          app.VENDOR_ID.setValue(rec.rows[i].vendor_id );\n        }\n      }\n    }\n});"},"children":[{"configs":{"itemId":"store","autoLoad":"true","url":"m?xwl=xc/ap/touch/req/xc_ap_pay_req_myDB/getContract"},"children":[],"expanded":false,"type":"tstore"}],"expanded":false,"type":"tselect"},{"configs":{"labelWidth":"110","displayField":"dept_name","valueField":"dept_id","label":"<font color=\"red\">*<\/font>成本中心:","labelAlign":"left","itemId":"DEPT_ID"},"events":{"change":"if(!oldValue==''){\n  app.PROJECT_ID.reset();//清空项目\n}\n"},"children":[{"configs":{"itemId":"store","url":"m?xwl=xc/ap/touch/req/xc_ap_pay_req_myDB/getDept"},"children":[],"expanded":false,"type":"tstore"}],"expanded":false,"type":"tselect"},{"configs":{"labelWidth":"110","readOnly":"true","displayField":"project_name","valueField":"project_id","label":"项目:","labelAlign":"left","itemId":"PROJECT_ID"},"events":{"focus":"var projectContainer = mainNav.down('#projectContainer');\nif (projectContainer === null || projectContainer === undefined) {\n  mainNav.push(app.projectContainer);//界面切到项目\n}\nelse{\n  mainNav.setActiveItem(projectContainer);\n}"},"children":[{"configs":{"itemId":"store","url":"m?xwl=xc/ap/touch/req/xc_ap_pay_req_myDB/getProject"},"children":[],"expanded":false,"type":"tstore"}],"expanded":false,"type":"tselect"},{"configs":{"labelWidth":"110","label":"申请金额：","clearIcon":"false","labelAlign":"left","itemId":"AMOUNT"},"children":[],"expanded":false,"type":"tnumber"},{"configs":{"labelWidth":"110","height":"100","xtype":"textareafield","label":"摘要：","labelAlign":"left","itemId":"DESCRIPTION"},"children":[],"expanded":false,"type":"ttext"}],"expanded":true,"type":"tfieldset"},{"configs":{"itemId":"field"},"children":[{"configs":{"labelWidth":"110","displayField":"ACCOUNT_NAME","valueField":"ACCOUNT_NAME","label":"开户名：","labelAlign":"left","itemId":"ACCOUNT_NAME"},"events":{"change":"Wb.request({//给开户行，银行账号赋值\n\turl:'m?xwl=xc/ap/touch/req/xc_ap_pay_req_myDB/getByAccountName',\n  \tparams:{'accountName':newValue,'vendorId':app.VENDOR_ID.getValue()},\n  \tsuccess:function(resp){\n    \tvar rec = Wb.decode(resp.responseText);\n      if(rec.total!==0){\n        app.DEPOSIT_BANK_NAME.setValue(rec.rows[0].BANK_NAME);\n        app.BANK_ACCOUNT.setValue(rec.rows[0].BANK_ACCOUNT);\n      }\n    }\n});"},"children":[{"configs":{"itemId":"store","url":"m?xwl=xc/ap/touch/req/xc_ap_pay_req_myDB/getAccountName"},"children":[],"expanded":false,"type":"tstore"}],"expanded":true,"type":"tselect"},{"configs":{"labelWidth":"110","label":"开户行：","labelAlign":"left","itemId":"DEPOSIT_BANK_NAME"},"children":[],"expanded":false,"type":"ttext"},{"configs":{"labelWidth":"110","label":"银行账号：","labelAlign":"left","itemId":"BANK_ACCOUNT"},"children":[],"expanded":false,"type":"ttext"}],"expanded":false,"type":"tfieldset"},{"configs":{"hidden":"true","itemId":"hiddenField"},"children":[{"configs":{"itemId":"AP_PAY_REQ_H_ID"},"children":[],"expanded":false,"type":"ttext"},{"configs":{"itemId":"AUDIT_STATUS"},"children":[],"expanded":false,"type":"ttext"},{"configs":{"itemId":"AP_PAY_REQ_H_CODE"},"children":[],"expanded":false,"type":"ttext"},{"configs":{"itemId":"ap_doc_cat_code"},"children":[],"expanded":true,"type":"ttext"},{"configs":{"label":"已付金额","itemId":"PAID_AMT"},"children":[],"expanded":false,"type":"ttext"},{"configs":{"label":"占用金额","itemId":"OCCUPY_AMT"},"children":[],"expanded":false,"type":"ttext"},{"configs":{"label":"未付金额","itemId":"NO_PAY_AMT"},"children":[],"expanded":false,"type":"ttext"},{"configs":{"label":"流程实例编码","itemId":"INS_CODE"},"children":[],"expanded":false,"type":"ttext"},{"configs":{"value":"{#XIP.userId#}","label":"申请人","itemId":"CREATED_BY"},"children":[],"expanded":false,"type":"ttext"},{"configs":{"label":"业务日期","itemId":"BIZ_DATE"},"children":[],"expanded":false,"type":"tdate"},{"configs":{"label":"组织ID","itemId":"ORG_ID"},"children":[],"expanded":false,"type":"ttext"}],"expanded":false,"type":"tfieldset"}],"expanded":true,"type":"tcontainer"},{"configs":{"itemId":"containerdtl"},"children":[],"expanded":true,"type":"tcontainer"},{"configs":{"docked":"bottom","height":"30","itemId":"toolbar1"},"children":[{"configs":{"itemId":"spacer1"},"children":[],"expanded":true,"type":"tspacer"},{"configs":{"text":"保存","itemId":"saveBtn"},"events":{"tap":"var srcAmt = 0;\nvar noPayAmt = 0 ;\n//采购结算需要保存付款申请 和 付款明细\nif (app.AP_DOC_CAT_CODE.getValue() == 'CGJS') {\n\n  var v_count = app.containerdtl.items.length;\n  if (v_count === 0) {\n    Wb.info('明细为空，不能保存！');\n    return;\n  }\n  var ledger = app.LEDGER_ID.getValue();\n  if(Wb.isEmpty(ledger)||ledger===''){\n    Wb.info('账簿为空，不能保存！');\n    return;\n  }\n  var vendor = app.VENDOR_ID.getValue();\n  if(Wb.isEmpty(vendor)||vendor===''){\n    Wb.info('供应商为空，不能保存！');\n    return;\n  }\n  var AMOUNT = 0;\n  for (var i = 0; i < v_count; i++) {\n    var dtl = app.containerdtl.getAt(i);\n    var fieldSet = dtl.getAt(0);\n    AMOUNT = AMOUNT + fieldSet.getAt(5).getValue();\n  }\n\n  if (Wb.isEmpty(AMOUNT) || AMOUNT === 0) {\n    Wb.info('金额不能为空或为0!');\n    return;\n  } else {\n    app.AMOUNT.setValue(AMOUNT);\n  }\n\n  /*if(fieldSet.getAt(5).getValue()>fieldSet.getAt(4).getValue()){\n     Wb.toast('申请金额不能大于可支付金额');\n    return;\n  }*/\n  if(Wb.isInsert=='Y'){\n    app.AP_PAY_REQ_H_ID.setValue(Xip.getId());\n  }\n  Wb.request({\n    url:'{#contextPath#}' + '/apPayReqCommonAction.do?method=savePay',\n    params:{'regHMsg':Wb.getValue(app.container1),'regLMsg':getReqDtl(),'deleteDtl':deleteDtl},\n    success:function(resp){\n      var rec = Wb.decode(resp.responseText);\n      if(rec.flag=='0'){\n        Wb.info('保存成功！');\n        Wb.isInsert = 'N';\n        loadList.store.load();\n      }else if(rec.flag=='1'){\n        Wb.info(rec.msg);\n      }\n    }\n  });\n}else if(app.AP_DOC_CAT_CODE.getValue() == 'YUFK'){\n  //预付款需要保存FORM1\n  var amount = app.AMOUNT.getValue();\n  if (Wb.isEmpty(amount) || amount === 0) {\n    Wb.toast('请填写申请金额！');\n    return false;\n  }\n  var ledger = app.LEDGER_ID.getValue();\n  if(Wb.isEmpty(ledger)||ledger===''){\n    Wb.info('账簿为空，不能保存！');\n    return;\n  }\n  var vendor = app.VENDOR_ID.getValue();\n  if(Wb.isEmpty(vendor)||vendor===''){\n    Wb.info('供应商为空，不能保存！');\n    return;\n  }\n  var contract = app.AP_CONTRACT_ID.getValue();\n  if(Wb.isEmpty(contract)||contract===''){\n    Wb.info('合同为空，不能保存！');\n    return;\n  }\n  if(Wb.isInsert=='Y'){\n    app.AP_PAY_REQ_H_ID.setValue(Xip.getId());\n  }\n    Wb.request({\n      url: '{#contextPath#}' + '/apPayReqCommonAction.do?method=savePay',\n      params: {'regHMsg':Wb.getValue(app.container1)},\n      success: function(resp) {\n        var rec = Wb.decode(resp.responseText);\n        if(rec.flag=='0'){\n          Wb.info('保存成功！');\n          Wb.isInsert = 'N';\n        }else if(rec.flag=='1'){\n          Wb.info(rec.msg);\n        }  \n      }\n    });\n}"},"children":[],"expanded":false,"type":"tbutton"},{"configs":{"text":"提交审批","itemId":"submitAndApprove"},"events":{"tap":"var op = '{#op#}';//操作类型\nvar docCatCode = app.AP_DOC_CAT_CODE.getValue();//申请单类型\n// 判断是否选择账簿\nvar ledgerId = app.LEDGER_ID.getValue() ;\nif(ledgerId === \"\" || ledgerId === \"\" || ledgerId === undefined){\n  Wb.toast('请选择账簿') ;\n  return false ;\n}\n\n// 判断单据是否已经保存\nvar reqHId = app.AP_PAY_REQ_H_ID.getValue();//付款申请单主ID\t\nif(reqHId==''||Wb.isEmpty(reqHId)){\n  Wb.toast('请先保存付款申请单信息后再启动流程!') ;\n  return false ;\n}\n\n// TODO: 员工信息\nvar _empId = '{#XIP.empId#}' ;\n\n// TODO: 根据费用单据类型获取审批流程和审批表单信息\nWb.request({\n  url    : '{#contextPath#}'+'/apPayReqCommonAction.do?method=getProcAndFormsByCat',\n  async  : false,\n  params : {\n    'LEDGER_ID' : app.LEDGER_ID.getValue(),\n    'AP_DOC_CAT_CODE'   : app.AP_DOC_CAT_CODE.getValue()\n  },\n  success: function(resp) {\n    var response = Wb.decode(resp.responseText) ;\n    if(response.flag == \"0\"){\n      // TODO: 取得流程编码、电脑端审批表单和移动端审批表单\n      var processCode = response.PROCESS_CODE ;\n      var pcApproveForm = response.PC_A_FORM_URL ;\n      var mobileApproveForm = response.M_A_FORM_URL ;\n\n      // 电脑端和移动端审批表单为变量需要设置为全路径\n      pcApproveForm = '{#appIP#}' +  '/'+pcApproveForm ;\n      mobileApproveForm = '{#appIP#}' +  mobileApproveForm ;\n\n      // TODO: 如果流程编码存在, 则提交流程审批处理\n      if(processCode !== \"\" && processCode !== null && processCode !== undefined){\n\n        // 如果项目未指定，则设置默认值为 \"-1\"\n        var prjId = app.PROJECT_ID.getValue() ;\n        if(prjId === null || prjId === \"\" || prjId === undefined){\n          prjId = \"-1\" ;\n        }\n        // 流程业务实体属性赋值\n        var json = {\n          'AMT'          : app.AMOUNT.getValue(),\n          'apCatCode'\t : 'FKSQD',\n          'APP_IP'       : '{#appIP#}',\n          'DEPT_ID'      : app.DEPT_ID.getValue() ,\n          'DEPT_NAME'    : app.DEPT_ID.getRecord().data.dept_name,\n          'EMP_ID'       : _empId,\n          'AP_DOC_CAT_NAME'  : app.AP_DOC_CAT_CODE.getRecord().data.ap_doc_cat_name,\n          'loginName'    : '{#XIP.userName#}',\n          'M_A_FORM'     : mobileApproveForm,\n          'PC_A_FORM'    : pcApproveForm,\n          'PROJECT_ID'   : prjId,\n          'e_business_id': reqHId,\n          'ledgerId'     : ledgerId,\n          'billType'\t : app.AP_DOC_CAT_CODE.getValue(),\n          'ORG_ID'\t\t : app.ORG_ID.getValue()\n        } ;  \n        var _auditStatus = app.AUDIT_STATUS.getValue() ;\n        var _insCode = app.INS_CODE.getValue();\n        if(_auditStatus=='A'){//起草状态\n          // 提交审批处理（流程启动并提交处理）\n          XipWf.startAndSubmitByProcess(app.xipMainNav,processCode,json,function(e){\n            if(e.flag === 0){\n              Wb.info('提交成功！');\n              if(op !== ''){\n                //加载我的单据页面\n                loadList.store.load();\n              }\n              app.INS_CODE.setValue(e.instanceCode);//流程编码赋值\n              app.saveBtn.setHidden(true);//按钮隐藏或显示\n              app.submitAndApprove.setHidden(true);\n              app.cancelBtn.setHidden(false);\n              app.monitorBtn.setHidden(false);\n              app.traceBtn.setHidden(false);\n              app.addDetailBtn.setHidden(true);\n            }else if(e.flag === 1){\n              Wb.info(e.msg) ;\n            }\n          });\n        }else if(_auditStatus=='D'){//驳回状态\n          XipWf.submitInstance(app.xipMainNav, _insCode, json, function(e){\n            if(e.flag === 0){\n              Wb.info('提交成功！');\n              if(op !== ''){\n                //加载我的单据页面\n                loadList.store.load();\n              }\n              app.INS_CODE.setValue(e.instanceCode);//流程编码赋值\n              app.saveBtn.setHidden(true);//按钮隐藏或显示\n              app.submitAndApprove.setHidden(true);\n              app.cancelBtn.setHidden(false);\n              app.monitorBtn.setHidden(false);\n              app.traceBtn.setHidden(false);\n              app.addDetailBtn.setHidden(true);\n            }else if(e.flag === 1){\n              Wb.info(e.msg) ;\n            }\n          }) ;\n        }else if(_auditStatus=='R'){//撤回状态\n          XipWf.restartAndSubmitByProcess(app.xipMainNav, _insCode, null, json, function(e){\n           if(e.flag === 0){\n              Wb.info('提交成功！');\n              if(op !== ''){\n                //加载我的单据页面\n                loadList.store.load();\n              }\n              app.INS_CODE.setValue(e.instanceCode);//流程编码赋值\n              app.saveBtn.setHidden(true);//按钮隐藏或显示\n              app.submitAndApprove.setHidden(true);\n              app.cancelBtn.setHidden(false);\n              app.monitorBtn.setHidden(false);\n              app.traceBtn.setHidden(false);\n              app.addDetailBtn.setHidden(true);\n            }else if(e.flag === 1){\n              Wb.info(e.msg) ;\n            }\n        }) ;\n        }\n\n\n      }else{\n        Wb.toast(app.AP_DOC_CAT_CODE.getRecord().data.ap_cat_name+'未指定审批流程, 请确认') ;\n      }\n\n    }else{\n      Wb.toast(response.msg) ;\n    }\n  }\n});\n\n"},"children":[],"expanded":true,"type":"tbutton"},{"configs":{"text":"流程监控","itemId":"monitorBtn"},"events":{"tap":"XipWf.showMonitorPage(app.xipMainNav,app.INS_CODE.getValue());//监控流程"},"children":[],"expanded":true,"type":"tbutton"},{"configs":{"text":"业务跟踪","itemId":"traceBtn"},"events":{"tap":"app.payReqHgrid.getStore().load({params:{'payReqHId':app.AP_PAY_REQ_H_ID.getValue()}});\nvar payReqHDtl = mainNav.down('#payReqHDtl');\nif (payReqHDtl === null || payReqHDtl === undefined) {\n  mainNav.push(app._payReqHDtl);\n}\nelse{\n  mainNav.setActiveItem(payReqHDtl);\n}"},"children":[],"expanded":true,"type":"tbutton"},{"configs":{"text":"撤回","itemId":"cancelBtn"},"events":{"tap":"XipWf.revokeByInstance(app.INS_CODE.getValue(),function(obj) {//撤回流程\n  Wb.request({\n    url : 'm?xwl=xc/ap/req/DB/saveAuditStatus',\n    params : {AP_PAY_REQ_H_ID:app.AP_PAY_REQ_H_ID.getValue(),AUDIT_STATUS:'R',INS_CODE : app.INS_CODE.getValue(),AUDIT_STATUS_DESC:'{#XIP.empName#}'+'撤回',AUDIT_DATE : null,SYS_AUDIT_STATUS:'A',SYS_AUDIT_STATUS_DESC:'草稿'}\n  });\n  Wb.info(obj.msg);\n});\nvar docCatCode = app.AP_DOC_CAT_CODE.getValue();\nif(docCatCode=='CGJS'){\n  app.saveBtn.setHidden(false);\n  app.submitBtn.setHidden(false);\n  app.addDetailBtn.setHidden(false);\n}else if(docCatCode=='YUFK'){\n  app.saveBtn.setHidden(false);\n  app.submitBtn.setHidden(false);\n}\napp.cancelBtn.setHidden(true);\nvar op = '{#op#}';\nif(op!=''){//op不为空\n  loadList.store.load();//加载我的单据页面\n}"},"children":[],"expanded":true,"type":"tbutton"},{"configs":{"text":"增加明细","itemId":"addDetailBtn"},"events":{"tap":"//添加明细\naddDtl();\n"},"children":[],"expanded":true,"type":"tbutton"},{"configs":{"itemId":"spacer11"},"children":[],"expanded":true,"type":"tspacer"}],"expanded":true,"type":"ttoolbar"},{"configs":{"hidden":"true","layout":"fit","scrollable":"true","itemId":"invContainer"},"events":{"painted":"app.invGlHList.getStore().load();"},"children":[{"configs":{"docked":"top","itemId":"toolbar2"},"children":[{"configs":{"labelWidth":"200","width":"500","label":"单据编号/制单人：","labelAlign":"left","itemId":"invHCode"},"children":[],"expanded":false,"type":"ttext"},{"configs":{"text":"查询","itemId":"selectBtn"},"events":{"tap":"app.invGlHList.getStore().load({params:{'invGlHCode':app.invHCode.getValue()}});//加载store"},"children":[],"expanded":false,"type":"tbutton"}],"expanded":true,"type":"ttoolbar"},{"configs":{"itemId":"invGlHList"},"events":{"itemsingletap":"var invContainer = mainNav.down('#invContainer');//应付单列表界面\nvar containerdtl = mainNav.down('#containerdtl');//明细container\nif (invContainer !== null || invContainer !== undefined) {//赋值\n  var dtl = containerdtl.getAt(orderNo-1);\n  var fieldSet = dtl.getAt(0);\n  fieldSet.getAt(2).setValue(record.data.AP_INV_GL_H_ID);\n  fieldSet.getAt(3).setValue(record.data.AP_INV_GL_H_CODE);\n  fieldSet.getAt(4).setValue(record.data.PAYABLE);\n  fieldSet.getAt(7).setValue(record.data.AP_CONTRACT_ID);\n  fieldSet.getAt(6).setValue(record.data.DESCRIPTION);\n\t\n}\nmainNav.setActiveItem(app.containerTotal);\n"},"children":[{"configs":{"itemId":"store","url":"m?xwl=xc/ap/touch/req/xc_ap_pay_req_myDB/getInvGlH"},"children":[],"expanded":false,"type":"tstore"},{"configs":{"itemId":"columns"},"children":[{"configs":{"text":"应付单ID","height":"30","hidden":"true","align":"center","dataIndex":"AP_INV_GL_H_ID","itemId":"invGlHIdCol"},"children":[],"expanded":false,"type":"tcolumn"},{"configs":{"text":"编号","height":"30","align":"center","width":"280","dataIndex":"AP_INV_GL_H_CODE","itemId":"invGlHCodeCol"},"children":[],"expanded":false,"type":"tcolumn"},{"configs":{"text":"日期","height":"30","align":"center","width":"150","dataIndex":"GL_DATE","itemId":"glDateCol"},"children":[],"expanded":false,"type":"tcolumn"},{"configs":{"text":"类型","height":"30","align":"center","width":"280","dataIndex":"AP_DOC_CAT_NAME","itemId":"docCatNameCol"},"children":[],"expanded":false,"type":"tcolumn"}],"expanded":true,"type":"array"}],"expanded":false,"type":"tgrid"}],"expanded":false,"type":"tcontainer"},{"configs":{"hidden":"true","layout":"fit","scrollable":"true","itemId":"vendorContainer"},"events":{"painted":"app.vendorList.getStore().load({params:{'ledger_id':app.LEDGER_ID.getValue()}});"},"children":[{"configs":{"docked":"top","itemId":"toolbar2"},"children":[{"configs":{"labelWidth":"200","width":"500","label":"供应商名称：","labelAlign":"left","itemId":"vendorName"},"children":[],"expanded":false,"type":"ttext"},{"configs":{"text":"查询","itemId":"selectBtn"},"events":{"tap":"app.vendorList.getStore().load({params:{'vendorName':app.vendorName.getValue(),'ledger_id':app.LEDGER_ID.getValue()}});//加载store"},"children":[],"expanded":false,"type":"tbutton"}],"expanded":true,"type":"ttoolbar"},{"configs":{"itemId":"vendorList"},"events":{"itemsingletap":"var vendorContainer = mainNav.down('#vendorContainer');//应付单列表界面\nif (vendorContainer !== null || vendorContainer !== undefined) {//赋值\n app.VENDOR_ID.setValue(record.data.vendor_id);\t\n}\nmainNav.setActiveItem(app.containerTotal);\n"},"children":[{"configs":{"itemId":"store","url":"m?xwl=xc/ap/touch/req/xc_ap_pay_req_myDB/getVendor"},"children":[],"expanded":false,"type":"tstore"},{"configs":{"itemId":"columns"},"children":[{"configs":{"text":"供应商ID","height":"30","hidden":"true","align":"center","dataIndex":"vendor_id","itemId":"vendorIdCol"},"children":[],"expanded":false,"type":"tcolumn"},{"configs":{"text":"合同ID","height":"30","hidden":"true","align":"center","dataIndex":"ap_contract_id","itemId":"contractIdCol"},"children":[],"expanded":false,"type":"tcolumn"},{"configs":{"text":"供应商名称","height":"30","align":"center","width":"280","dataIndex":"vendor_name","itemId":"vendorNameCol"},"children":[],"expanded":false,"type":"tcolumn"}],"expanded":true,"type":"array"}],"expanded":false,"type":"tgrid"}],"expanded":false,"type":"tcontainer"},{"configs":{"hidden":"true","layout":"fit","scrollable":"true","itemId":"projectContainer"},"events":{"painted":"app.projectList.getStore().load({params:{'ledgerId':app.LEDGER_ID.getValue(),'deptId':app.DEPT_ID.getValue()}});"},"children":[{"configs":{"docked":"top","itemId":"toolbar2"},"children":[{"configs":{"labelWidth":"200","width":"500","label":"项目名称：","labelAlign":"left","itemId":"projectName"},"children":[],"expanded":false,"type":"ttext"},{"configs":{"text":"查询","itemId":"selectBtn"},"events":{"tap":"app.vendorList.getStore().load({params:{'vendorName':app.vendorName.getValue(),'ledger_id':app.LEDGER_ID.getValue()}});//加载store"},"children":[],"expanded":false,"type":"tbutton"}],"expanded":true,"type":"ttoolbar"},{"configs":{"itemId":"projectList"},"events":{"itemsingletap":"var projectContainer = mainNav.down('#projectContainer');//应付单列表界面\nif (projectContainer !== null || projectContainer !== undefined) {//赋值\n app.PROJECT_ID.setValue(record.data.project_id);\n app.DEPT_ID.setValue(record.data.dept_id);\n}\nmainNav.setActiveItem(app.containerTotal);\n"},"children":[{"configs":{"itemId":"store","url":"m?xwl=xc/ap/touch/req/xc_ap_pay_req_myDB/getProject"},"children":[],"expanded":false,"type":"tstore"},{"configs":{"itemId":"columns"},"children":[{"configs":{"text":"项目ID","height":"30","hidden":"true","align":"center","dataIndex":"project_id","itemId":"projectIdCol"},"children":[],"expanded":false,"type":"tcolumn"},{"configs":{"text":"项目名称","height":"30","align":"center","width":"280","dataIndex":"project_name","itemId":"projectNameCol"},"children":[],"expanded":false,"type":"tcolumn"},{"configs":{"text":"成本中心ID","height":"30","hidden":"true","align":"center","width":"280","dataIndex":"dept_id","itemId":"deptIdCol"},"children":[],"expanded":false,"type":"tcolumn"}],"expanded":true,"type":"array"}],"expanded":true,"type":"tgrid"}],"expanded":false,"type":"tcontainer"},{"configs":{"hidden":"true","layout":"fit","itemId":"payReqHDtl"},"children":[{"configs":{"itemId":"payReqHgrid"},"children":[{"configs":{"itemId":"store","url":"m?xwl=xc/ap/touch/req/xc_ap_pay_req_myDB/getPayReqHById"},"children":[],"expanded":false,"type":"tstore"},{"configs":{"itemId":"columns"},"children":[{"configs":{"text":"编号","height":"30","hidden":"true","align":"center","dataIndex":"AP_PAY_REQ_H_CODE","itemId":"payReqHCodeCol"},"children":[],"expanded":false,"type":"tcolumn"},{"configs":{"text":"业务日期","height":"30","align":"center","width":"280","dataIndex":"BIZ_DATE","itemId":"bizDateCol"},"children":[],"expanded":false,"type":"tcolumn"},{"configs":{"text":"已付金额","height":"30","align":"center","width":"150","dataIndex":"PAID_AMT","itemId":"paidAmtCol"},"children":[],"expanded":false,"type":"tcolumn"}],"expanded":true,"type":"array"}],"expanded":true,"type":"tgrid"}],"expanded":false,"type":"tcontainer"}],"expanded":true,"type":"tcontainer"}],"expanded":true,"type":"tviewport"}],"expanded":true,"type":"module"}],"pageLink":"","iconCls":""}