{"inframe":false,"title":"","hidden":false,"roles":{"default":1},"children":[{"configs":{"serverScript":"// TODO: 首先判断审核状态是否是审核通过状态，是的话不让删除\nvar recs = Wb.decode(request.getParameter('destroy'));\nvar  rs, meta, row, YFHYUF_ROWS = [], YFHLDC_ROWS = [], YUFHLDC_ROWS = [], YFHYUF_L_ROWS = [], YFHLDC_L_ROWS = [], YUFHLDC_L_ROWS = [], rows = [];\nWb.each(recs, function(rec) {\n  app.run('SELECT 1 FROM xc_ap_cancel_h WHERE AP_CANCEL_H_ID=\\''+rec.AP_CANCEL_H_ID+'\\' AND V_STATUS >=3 ',{ \n     errorText:'此核销单凭证已经审核通过，不允许删除'\n  });\n  rs = app.run('select * from xc_ap_cancel_l where AP_CANCEL_H_ID=\\''+rec.AP_CANCEL_H_ID+'\\'');\n  meta = rs.getMetaData();\n  while (rs.next()) {\n    row = Wb.getRecord(rs, meta);\n    \n    if('YFHYUF'==rec.AP_CANCEL_TYPE){\n      YFHYUF_L_ROWS.push(row);\n    }\n    if('YFHLDC'==rec.AP_CANCEL_TYPE){\n      YFHLDC_L_ROWS.push(row);\n    }\n    \n    if('YUFHLDC'==rec.AP_CANCEL_TYPE){\n      YUFHLDC_L_ROWS.push(row);\n    }\n    \n    rows.push(row);\n    \n  }\n  \n  if('YFHYUF'==rec.AP_CANCEL_TYPE){\n    YFHYUF_ROWS.push(rec);\n  }\n    \n  if('YFHLDC'==rec.AP_CANCEL_TYPE){\n    YFHLDC_ROWS.push(rec);\n  }\n    \n  if('YUFHLDC'==rec.AP_CANCEL_TYPE){\n    YUFHLDC_ROWS.push(rec);\n  }\n  \n});\n\nrequest.setAttribute('YFHYUF_ROWS',Wb.encode(YFHYUF_ROWS));\nrequest.setAttribute('YFHLDC_ROWS',Wb.encode(YFHLDC_ROWS));\nrequest.setAttribute('YUFHLDC_ROWS',Wb.encode(YUFHLDC_ROWS));\nrequest.setAttribute('YFHYUF_L_ROWS',Wb.encode(YFHYUF_L_ROWS));\nrequest.setAttribute('YFHLDC_L_ROWS',Wb.encode(YFHLDC_L_ROWS));\nrequest.setAttribute('YUFHLDC_L_ROWS',Wb.encode(YUFHLDC_L_ROWS));\nrequest.setAttribute('rows',Wb.encode(rows));","itemId":"module"},"children":[{"configs":{"oracle":"DELETE FROM xc_ap_inv_trans WHERE SOURCE_ID={?AP_CANCEL_H_ID?}","itemId":"DELETE_TRANS_H","mysql":"DELETE FROM xc_ap_inv_trans WHERE SOURCE_ID={?AP_CANCEL_H_ID?}"},"children":[],"expanded":false,"type":"sqlswitcher"},{"configs":{"oracle":"DELETE FROM xc_ap_inv_trans WHERE SOURCE_ID={?AP_CANCEL_H_ID?} AND SOURCE_DTL_ID={?AP_CANCEL_L_ID?}","itemId":"DELETE_TRANS_L","mysql":"DELETE FROM xc_ap_inv_trans WHERE SOURCE_ID={?AP_CANCEL_H_ID?} AND SOURCE_DTL_ID={?AP_CANCEL_L_ID?}"},"children":[],"expanded":false,"type":"sqlswitcher"},{"configs":{"oracle":"update xc_ap_inv_gl_h set \nCANCEL_AMT = CANCEL_AMT - {?decimal.SRC_AMT?},\nNO_PAY_AMT=NO_PAY_AMT+{?decimal.SRC_AMT?},\nNO_REQ_AMT = NO_REQ_AMT+{?decimal.SRC_AMT?} \n\tWHERE (AP_INV_GL_H_ID={?SRC_ID?} OR AP_INV_GL_H_ID={?TARGET_ID?})","itemId":"UPDATE_GL","mysql":"update xc_ap_inv_gl_h set \nCANCEL_AMT = CANCEL_AMT - {?decimal.SRC_AMT?},\nNO_PAY_AMT=NO_PAY_AMT+{?decimal.SRC_AMT?},\nNO_REQ_AMT = NO_REQ_AMT+{?decimal.SRC_AMT?} \n\tWHERE (AP_INV_GL_H_ID={?SRC_ID?} OR AP_INV_GL_H_ID={?TARGET_ID?})"},"children":[],"expanded":false,"type":"sqlswitcher"},{"configs":{"sql":"{#DELETE_TRANS_H#}","transaction":"start","arrayName":"YFHYUF_ROWS","itemId":"query1"},"children":[],"expanded":false,"type":"query"},{"configs":{"sql":"{#DELETE_TRANS_L#}","arrayName":"YFHYUF_L_ROWS","itemId":"query2"},"children":[],"expanded":false,"type":"query"},{"configs":{"sql":"{#UPDATE_GL#}","arrayName":"YFHYUF_ROWS","itemId":"query3"},"children":[],"expanded":false,"type":"query"},{"configs":{"sql":"{#DELETE_TRANS_H#}","arrayName":"YFHLDC_ROWS","itemId":"query4"},"children":[],"expanded":false,"type":"query"},{"configs":{"sql":"{#DELETE_TRANS_L#}","arrayName":"YFHLDC_L_ROWS","itemId":"query5"},"children":[],"expanded":false,"type":"query"},{"configs":{"sql":"{#UPDATE_GL#}","arrayName":"YFHLDC_ROWS","itemId":"query6"},"children":[],"expanded":false,"type":"query"},{"configs":{"sql":"{#UPDATE_GL#}","arrayName":"YFHLDC_L_ROWS","itemId":"query7"},"children":[],"expanded":false,"type":"query"},{"configs":{"sql":"{#DELETE_TRANS_H#}","arrayName":"YUFHLDC_ROWS","itemId":"query8"},"children":[],"expanded":false,"type":"query"},{"configs":{"sql":"{#DELETE_TRANS_L#}","arrayName":"YUFHLDC_L_ROWS","itemId":"query9"},"children":[],"expanded":false,"type":"query"},{"configs":{"sql":"delete from xc_ap_cancel_l where AP_CANCEL_L_ID={?AP_CANCEL_L_ID?}","arrayName":"rows","itemId":"query11"},"children":[],"expanded":false,"type":"query"},{"configs":{"sql":"delete from xc_ap_cancel_h where AP_CANCEL_H_ID={?AP_CANCEL_H_ID?}","arrayName":"rows","itemId":"query10"},"children":[],"expanded":false,"type":"query"}],"expanded":true,"type":"module"}],"pageLink":"","iconCls":""}