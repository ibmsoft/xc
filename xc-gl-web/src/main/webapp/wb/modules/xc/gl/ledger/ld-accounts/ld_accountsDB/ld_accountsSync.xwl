{"inframe":false,"title":"同步账簿科目信息","hidden":false,"roles":{"default":1},"children":[{"configs":{"loginRequired":"false","serverScript":"var infoArray = request.getParameter(\"infoArray\");\nvar LEDGER_ID = request.getParameter(\"LEDGER_ID\");\nvar array = Wb.decode(infoArray) ;\nvar succRecord = 0;\n// var sql = 'SELECT b.ACC_CODE from xc_gl_ld_accounts a ,xc_gl_accounts b where a.ACC_ID = b.ACC_ID and a.LEDGER_ID = \\''+LEDGER_ID+'\\'' ;\n// var rs = app.run(sql,{type:'query'}) ;\n// var existsArray = [] ;\n// while(rs.next()){\n//     var exists_acc_code = rs.getString(\"ACC_CODE\") ;\n//     existsArray.push(exists_acc_code) ;\n// }\n// TODO: 计算可插入科目\nvar insertSql;\nvar levelArray = [4,6,8,10,12];\nWb.each(array,function(rec){\n    var upAccCode = rec.UP_ACC_CODE ;\n    var accCode = rec.ACC_CODE;\n\tinsertSql = 'INSERT INTO xc_gl_ld_accounts (LD_ACC_ID,LEDGER_ID,ACC_ID,START_DATE,END_DATE,CREATION_DATE,CREATED_BY,LAST_UPDATE_DATE,LAST_UPDATED_BY)VALUES(\"'+java.util.UUID.randomUUID()+'\",\"'+LEDGER_ID+'\",\"'+rec.ACC_ID+'\",\"'+rec.START_DATE+'\",\"'+rec.END_DATE+'\",{?timestamp.sys.date?},{?XIP.userId?},{?timestamp.sys.date?},{?XIP.userId?})';\n    if(upAccCode == '-1'){//一级 科目\n        app.run(insertSql,{});\n    }\n    for(var i = 0;i < levelArray.length;i++){\n\t\tif(upAccCode.length == levelArray[i]){//二级 科目\n            accountSync(rec);\n        }\n    }\n//     if(upAccCode.length == 4){//二级 科目\n//         accountSync(rec);\n//     }\n//     if(upAccCode.length == 6){//三级 科目\n//         accountSync(rec);\n//     }\n//     if(upAccCode.length == 8){//四级 科目\n//         accountSync(rec);\n//     }\n//     if(upAccCode.length == 10){//五 科目\n//         accountSync(rec);\n//     }\n//     if(upAccCode.length == 12){//六级 科目\n//         accountSync(rec);\n//     }\n//     for(var i = 0;0 < existsArray.length;i++){\n//         if(upAccCode == existsArray[i]){\n//             app.run(sql,{});\n//         }\n//     }\n  \n});\nfunction accountSync(rec){\n\tvar sqlLevel = \"select ga.ACC_CODE from xc_gl_ld_accounts gla,xc_gl_accounts ga where ga.ACC_ID=gla.ACC_ID and ga.ACC_CODE='\"+rec.UP_ACC_CODE+\"' and gla.LEDGER_ID = '\"+LEDGER_ID+\"'\";\n    var rsLevel = app.run(sqlLevel,{type:'query'}) ;\n    if((rsLevel.next()) === false){\n        Wb.error('上级编码没有同步，编码\"'+rec.ACC_CODE+'\"不能同步。');\n    }\n    else{\n        app.run(insertSql,{});\n    }\n}\n// Wb.each(array,function(rec){\n//     var UP_ACC_CODE = rec.UP_ACC_CODE;\n//     var ACC_CODE = rec.ACC_CODE;\n//   Wb.error(UP_ACC_CODE +'  '+ACC_CODE);\n//     var sql = 'select 1 from xc_gl_ld_accounts gla,xc_gl_accounts ga where ga.ACC_ID=gla.ACC_ID and ga.UP_ACC_CODE=\"'+rec.UP_ACC_CODE+'\" and gla.LEDGER_ID = \"'+LEDGER_ID+'\"';\n//     var rs = app.run(sql,{type:'query'}) ;\n//     if((rs.next()) === false){\n// //         app.run(\"select 1 from xc_gl_accounts ga where ga.ACC_HRCY_ID=(select ACC_HRCY_ID from xc_gl_ledgers where LEDGER_ID='\"+LEDGER_ID+\"') AND ga.ACC_CODE='\"+rec.UP_ACC_CODE+\"'AND ga.ACC_ID not in(select ACC_ID from xc_gl_ld_accounts where LEDGER_ID='\"+LEDGER_ID+\"')\",{\n// //             errorText: '上级编码没有同步，编码\"'+rec.ACC_CODE+'\"不能同步。'\n// //         });\n// //     }\n//     if(rec.END_DATE === null){\n//         Wb.error('账簿科目结束日期不能为空！');\n//     }\n//     rec.LD_ACC_ID = java.util.UUID.randomUUID();\n//     succRecord = succRecord + 1;\n// });\n// var newArr = Wb.encode(array);\n// request.setAttribute(\"batArray\",newArr);","itemId":"module"},"children":[],"expanded":true,"type":"module"}],"pageLink":"","iconCls":""}