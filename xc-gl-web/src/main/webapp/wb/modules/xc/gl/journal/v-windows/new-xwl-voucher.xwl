{"inframe":false,"title":"新建外部凭证","hidden":false,"roles":{"default":1},"children":[{"configs":{"serverScript":"//---------------------获取当前模块语言对应的.json文件，放到request中----------------\ncom.xzsoft.xip.platform.util.XipUtil.getCurrentLang(request,\"xc/gl/journal/v-windows/new-xwl-voucher\");","itemId":"module"},"events":{"initialize":"// TODO: 增加合计行\nfunction addTotalLine(){\n  Ext.define('lineModel', {  \n      extend: 'Ext.data.Model',  \n      fields: [  \n          {name: 'LINE_ID'},  \n          {name: 'CA_ID'},\n          {name: 'DIM_ID'},\n          {name: 'CCID'},\n          {name: 'SUMMARY'},  \n          {name: 'CCID_FULL_NAME'},  \n          {name: 'AMOUNT'},  \n          {name: 'EXCHANGE_RATE'},  \n          {name: 'ENTER_DR'},  \n          {name: 'ENTER_CR'},  \n          {name: 'ACCOUNT_DR'},  \n          {name: 'ACCOUNT_CR'},\n          {name: 'IS_SUM'}\n       ]  \n  });\n  var r = Ext.create('lineModel', {\n    'LINE_ID':'',\n    'CA_ID':'',\n    'DIM_ID':'',\n    'CCID':'',\n    'SUMMARY':'{#total#}', \n    'CCID_FULL_NAME':'',\n    'AMOUNT': '',\n    'EXCHANGE_RATE':'',\n    'ENTER_DR':'',\n    'ENTER_CR':'',\n    'ACCOUNT_DR':'',\n    'ACCOUNT_CR':'',\n    'IS_SUM':'Y'\n  });\n  var p = app.grid1.store.getCount() ;\n  app.grid1.store.insert(p,r);\n}\n  \n// TODO: 增加空科目分录行\nfunction addEntryLines(type){\n  Ext.define('lineModel', {  \n      extend: 'Ext.data.Model',  \n      fields: [  \n          {name: 'LINE_ID'},  \n          {name: 'CA_ID'},\n          {name: 'DIM_ID'},\n          {name: 'CCID'},\n          {name: 'SUMMARY'},  \n          {name: 'CCID_FULL_NAME'},  \n          {name: 'AMOUNT'},  \n          {name: 'EXCHANGE_RATE'},  \n          {name: 'ENTER_DR'},  \n          {name: 'ENTER_CR'},  \n          {name: 'ACCOUNT_DR'},  \n          {name: 'ACCOUNT_CR'},\n          {name: 'IS_SUM'}\n       ]  \n  });\n  var r = Ext.create('lineModel', {\n    'LINE_ID':'',\n    'CA_ID':'',\n    'DIM_ID':'',\n    'CCID':'',\n    'SUMMARY':(type=='auto' ? '' : app.v_summary.getValue()), \n    'CCID_FULL_NAME':'',\n    'AMOUNT': '',\n    'EXCHANGE_RATE':1,\n    'ENTER_DR':'',\n    'ENTER_CR':'',\n    'ACCOUNT_DR':'',\n    'ACCOUNT_CR':'',\n    'IS_SUM':'N'\n  });\n  var p = app.grid1.store.getCount()-1 ;\n  app.grid1.store.insert(p,r);\n}\n\n//加法函数，用来得到精确的加法结果\n//说明：javascript 的加法结果会有误差，在两个浮点数相加的时候会比较明显。这个函数返回较为精确的加法结果。\n//调用：accAdd(arg1,arg2)\n//返回值：arg1 加上 arg2 的精确结果\nfunction accAdd(arg1,arg2){\n  var r1,r2,m;\n  try{\n    r1 = arg1.toString().split('.')[1].length ;\n  }catch(e){\n    r1 = 0 ;\n  }\n  try{\n    r2 = arg2.toString().split('.')[1].length ;\n  }catch(e){\n    r2 = 0 ;\n  }\n  m = Math.pow(10,Math.max(r1,r2));\n  return (arg1 * m + arg2 * m) / m;\n}\n\n//乘法函数，用来得到精确的乘法结果\n//说明：javascript 的乘法结果会有误差，在两个浮点数相乘的时候会比较明显。这个函数返回较为精确的乘法结果。\n//调用：accMul(arg1,arg2)\n//返回值：arg1 乘以 arg2 的精确结果\nfunction accMul(arg1,arg2){\n    var m = 0,s1 = arg1.toString(),s2 = arg2.toString();\n    try{\n      m += s1.split('.')[1].length ;\n    }catch(e){\n    }\n    try{\n      m += s2.split('.')[1].length ;\n    }catch(e){\n    }\n    return Number(s1.replace('.',''))*Number(s2.replace('.','')) / Math.pow(10,m);\n}\n\n// TODO: 金额大写转换函数\nfunction amtTransChinese(num){ \n  var tmpNum = Number(num) ;\n  if(tmpNum < 0){\n    num = Math.abs(num) ;\n  }\n  \n  // 判断是否为数字\n  if (!/^(0|[1-9]\\d*)(\\.\\d{1,2})?$/.test(num)) {\n    num = 0;\n  }\n  \n  var unit = \"仟佰拾亿仟佰拾万仟佰拾元角分\", str = \"\";\n  num += \"00\";\n  var point = num.indexOf('.');\n  if (point >= 0) {\n    num = num.substring(0, point) + num.substr(point + 1, 2);\n  }\n  unit = unit.substr(unit.length - num.length);\n  for (var i = 0; i < num.length; i++) {\n    str += '零壹贰叁肆伍陆柒捌玖'.charAt(num.charAt(i)) + unit.charAt(i);\n  }  \n  var newVal = str.replace(/零(仟|佰|拾|角)/g, \"零\").replace(/(零)+/g, \"零\").replace(/零(万|亿|元)/g, \"$1\").replace(/(亿)万|(拾)/g, \"$1$2\").replace(/^元零?|零分/g, \"\").replace(/元$/g, \"元整\");\n  if(tmpNum <0){\n    newVal = '<font color=red>（负）'+ newVal + '<\/font>' ;\n  }\n  return newVal ;\n}\n\n// TODO: 计算借贷方的合计数\nfunction calTotal4DCR(){\n  var t_dr ; // 借方合计数\n  var t_cr ; // 贷方合计数\n  var flag = '0' ;\n  var a = [] ;\n  var records = Wb.getData(app.grid1) ;\n  if(records.length > 0){\n    Wb.each(records, function(r){\n      var ldr = r.ACCOUNT_DR ;\n      var lcr = r.ACCOUNT_CR ;\n      var ccid = r.CCID ; // 合法的凭证分录\n      if(ccid !== null && ccid !== \"\" && ccid !== undefined){\n        if(ldr >0 && lcr>0){\n          flag = '1' ;\n        }\n        if(t_dr === null || t_dr === \"\" || t_dr === undefined){\n          t_dr = accAdd(0,ldr) ;\n        }else{\n          t_dr = accAdd(t_dr,ldr) ;\n        }\n        if(t_cr === null || t_cr === \"\" || t_cr === undefined){\n          t_cr = accAdd(0,lcr) ;\n        }else{\n          t_cr = accAdd(t_cr,lcr) ;\n        }\n      }\n    });\n    a.push(t_dr) ;\n    a.push(t_cr) ;\n    a.push(flag) ;\n  }\n  return a ;\n}\n\n// TODO: 是否为银行或现金科目\nfunction isContainBankOrCashAcc(){\n  var tt = 0 ;\n  var records = Wb.getData(app.grid1) ;\n  if(records.length > 0){\n    Wb.each(records, function(r){\n      if(r.IS_BC_ACC == 'Y'){\n        tt = tt+1 ;\n      }\n    });\n  }\n  if(tt === 0){\n    return \"N\" ;\n  }else{\n    return \"Y\" ;\n  }\n}\n\n// TODO: 凭证保存前的校验函数\nfunction beforeSaveVerify(){\n  // TODO: 判断表单信息是否填写正确\n  var ledgerId = app.ledger.getValue() ;\n  if(ledgerId === \"\" || ledgerId === null || ledgerId === undefined){\n    Wb.toast(\"请选择账簿信息\");\n    return false ;\n  }\n  var accDate = app.accountDate.getValue() ;\n  if(accDate === \"\" || accDate === null || accDate === undefined){\n    Wb.toast(\"请选择会计日期\");\n    return false ;\n  }\n  var ldPeriod = app.ldPeriod.getValue() ;\n  if(ldPeriod === \"\" || ldPeriod === null || ldPeriod === undefined){\n    Wb.toast(\"会计期不能为空\");\n    return false ;\n  }\n  var vCategory = app.v_category.getValue() ;\n  if(vCategory === \"\" || vCategory === null || vCategory === undefined){\n    Wb.toast(\"请选择凭证分类\");\n    return false ;\n  }\n\n  // TODO: 判断分录信息是否填写正确\n  var entries = Wb.getData(app.grid1) ;\n  if(entries.length === 0){\n    Wb.toast(\"请填写凭证分录信息!\") ;\n    return false;\n  }else if(entries.length === 1){\n    // TODO: 如果只有一条凭证分录信息\n    Wb.toast(\"单个凭证中不能只存在一条凭证分录!\") ;\n    return false ;\n  }else{\n    // 判断凭证分录的CCID信息是否正确\n    var aa = 0 ;\n    var i = 0 ;\n    var entryMsg ;\n    Wb.each(entries, function(r){\n      i++ ;\n      var c1 = (r.CCID === '' || r.CCID === null || r.CCID === undefined) ;\n      var c2 = (r.CCID_FULL_NAME !== '' && r.CCID_FULL_NAME !== null && r.CCID_FULL_NAME !== undefined) ;\n      var isSum = r.IS_SUM ;\n      if(c1 && c2 && isSum !== 'Y'){\n        aa = aa+1 ;\n        entryMsg = '第'+i+'行分录的科目名称/辅助核算录入不正确!' ;\n      }\n    });       \n    if(aa !== 0){\n      Wb.info(entryMsg) ;\n      return false ;\n    }\n  }\n  return true ;\n}\n\n/**\n * 执行凭证保存处理。\n *\n * @param {type} btnType 当前操作类型: save-保存,submit-提交\n * @return {type} 返回值说明。\n */\nfunction handlerVoucher(btnType){\n  // TODO: 判断表单信息是否填写正确\n  if(beforeSaveVerify()){ \n    \n    // TODO: 计算借贷方合计数\n    var a = calTotal4DCR() ;\n    \n    // TODO: 判断同一行分录中是否存在借方和贷方均不为0\n    if(a[2] == '1'){\n      Wb.toast('凭证分录行中不能存在借方和贷方金额都大于0的分录信息!') ;\n      return false ;\n    }\n    \n    // TODO: 判断凭证分录信息是否满足借贷平衡\n    if(a[0] !== a[1]){\n      Wb.toast('凭证分录借贷不平衡,请确认!') ;\n      return false ;\n    }else{\n      app.v_total_dr.setValue(Number(a[0]));\n      app.v_total_cr.setValue(Number(a[1])) ;\n    }\n    \n    // TODO: 判读是否需要出纳签字\n    var signFlag = isContainBankOrCashAcc() ;\n    app.v_is_signed.setValue(signFlag) ;\n    \n    // 有效凭证分录行信息\n    var rows = Wb.getData(app.grid1) ;\n    var lines = [] ;\n    if(rows.length > 0){\n      Wb.each(rows, function(r){\n        if(r.CCID !== '' && r.CCID !== null && r.CCID !== undefined){\n          lines.push(r) ;\n        }\n      });\n    }  \n    var infoArray = Wb.encode(lines) ;\n    \n    // 凭证头信息\n    var infoJson = Wb.getValue(app.form1) ;\t\n    \n    // TODO: 调用业务系统方法执行凭证保存或提交处理\n    if(btnType == 'save'){\n      // 保存处理\n      saveVoucher(infoJson,infoArray);\n    }\n    if(btnType == 'submit'){\n      // 提交处理\n      submitVoucher(infoJson,infoArray);\n    }   \n  }\n}"},"children":[{"configs":{"title":"{#VOUCHER#}","layout":"border","itemId":"xwl_v_panel","border":"false"},"events":{"activate":"/**\n * 在嵌入页面的request或session对象中需要设置以下四个参数：\n * @param vtype    ： 必须参数;  模板类型: normal-金额式, amount-数量金额式, foreign-外币金额式\n * @param [opmode] ： 可选参数;  凭证模式：view-查看模式,其他-编辑模式\n * @param headId   ： 必须参数;  凭证头ID\n * @param contextPath ： 必须参数 ：系统根目录\n */\nvar vtype = '{#vtype#}' ;\nvar opmode = '{#opmode#}' ;\nvar headId = '{#headId#}' ;\nvar ctxPath = '{#contextPath#}' ;\n\n// TODO: 凭证模式：view-查看模式,其他-编辑模式\nif(opmode == 'view'){\n  // 置灰按钮\n  app.saveBtn.disable() ;\n  app.submitBtn.disable();  \n  app.addLine.disable() ;\n  app.delLine.disable() ;\n  \n  // 处理form1控件\n  app.accountDate.setReadOnly(true) ;\n  app.v_attchment_num.setReadOnly(true) ;\n  app.v_summary.setReadOnly(true) ;\n}\n\n// TODO: 编辑时加载凭证数据\nif(headId === null || headId === \"\" || headId === undefined) {\n  headId = app.v_head_id.getValue() ;\n}\n\nif(headId !== null && headId !== \"\" && headId !== undefined){\n  // 初始化凭证分录行\n  app.grid1.getStore().load({\n      params :{'headId':headId}\n  }) ;\n  // 初始化凭证头 \n  var formJson ;\n  Wb.request({\n    url: ctxPath +'/voucherHandlerAction.do?method=getVoucherById',\n    async:false ,\n    params: {'headId':headId},\n    success: function(resp) {\n      formJson = resp.responseText ;\n    }\n  });\n  var headJson = Wb.decode(formJson) ;\n  Wb.setValue(app.form1,headJson) ;\n  Wb.setValue(app.bbar,Wb.decode(formJson)) ;\n  \n  // 处理会计日期\n  var accDate = headJson.accountDate ;\n  app.accountDate.setValue(Wb.strToDate(accDate)) ;\n  \n  // 处理凭证标题\n  var catId = headJson.v_category ;\n  var catStore = app.v_category.getStore() ;\n  var idx = catStore.find('ID',catId) ;\n  var catName ;\n  if(idx == -1){\n    catName = '{#vouchers#}' ;\n  }else{\n    var rr = catStore.getAt(idx) ;\n    catName = rr.data.CAT_NAME ;  \n  }\n  app.label1.setText(\"<h2 align='center'><b>\"+catName+\"<\/b><\/h2>\",false) ;\n  \n  // 获取凭证头信息\n  var vs = headJson.v_status ;\n  var verifier = headJson.v_verifier ;\n  \n  // 处理按钮信息和form1控件\n  if(vs == '2'){\n    // 处理按钮\n    if(verifier !== \"\" && verifier !== \"\"){ \n      // 已审核\n      app.saveBtn.disable() ;\n      app.submitBtn.disable();  \n    }else{ \n      // 未审核\n      app.saveBtn.disable() ;\n      app.submitBtn.enable(); \n    }\n    // 处理form1控件\n    app.accountDate.setReadOnly(true) ;\n    app.v_attchment_num.setReadOnly(true) ;\n    app.v_summary.setReadOnly(true) ;\n  }\n  \n  // 处理grid1显示列\n  if(vtype === 'amount'){\n    app.v_dim_name.show() ;\n    app.v_dim_name.show() ;\n  }else if(vtype == 'foreign'){\n    app.v_exchange_rate.show() ;\n    app.v_cny_name.show() ;\n    app.v_enter_dr.show() ;\n    app.v_enter_cr.show() ;\n  }else{\n  }\n}"},"children":[{"configs":{"region":"north","itemId":"topPanel","border":"false"},"children":[{"configs":{"border":"true","itemId":"toolbar1"},"children":[{"configs":{"text":"{#saveBtn#}","itemId":"saveBtn","iconCls":"save_icon"},"events":{"click":"// 执行凭证校验并保存\nhandlerVoucher('save') ;\n"},"children":[],"expanded":false,"type":"button"},{"configs":{"text":"{#submitBtn#}","itemId":"submitBtn","iconCls":"up_icon"},"events":{"click":"// 执行凭证校验并提交\nhandlerVoucher('submit') ;\n"},"children":[],"expanded":false,"type":"button"}],"expanded":false,"type":"toolbar"}],"expanded":true,"type":"panel"},{"configs":{"region":"center","layout":"border","itemId":"mainPanel","border":"false"},"children":[{"configs":{"region":"north","itemId":"form1","border":"false"},"children":[{"configs":{"height":"60","layout":"fit","columnWidth":"1","itemId":"panel1","border":"false"},"children":[{"configs":{"itemId":"label1"},"events":{"afterrender":"app.label1.setText(\"<h2 align='center'><b>{#vouchers#}<\/b><\/h2>\",false);"},"children":[],"expanded":false,"type":"label"}],"expanded":true,"type":"panel"},{"configs":{"height":"40","layout":"column","columnWidth":"1","itemId":"panel2","border":"false"},"children":[{"configs":{"layout":"fit","columnWidth":".3","border":"false","itemId":"tr2_1"},"children":[{"configs":{"labelWidth":"50","readOnly":"true","displayField":"NAME","valueField":"ID","labelAlign":"right","itemId":"ledger","fieldLabel":"{#ledger#}"},"events":{"select":"app.ldPeriod.setValue() ;\napp.accountDate.setValue();\n\napp.pickComp.getStore().load();"},"children":[{"configs":{"autoLoad":"true","itemId":"store","url":"m?xwl=xc/com-qry/gl-ledgers/select-sec-ledger"},"children":[],"expanded":false,"type":"store"}],"expanded":false,"type":"combo"}],"expanded":true,"type":"panel"},{"configs":{"layout":"fit","columnWidth":".2","border":"false","itemId":"tr2_2"},"children":[{"configs":{"labelWidth":"80","labelAlign":"right","itemId":"accountDate","fieldLabel":"{#accountDate#}"},"events":{"change":"// TODO: 处理会计期\napp.ldPeriod.setValue() ;\napp.ldPeriod.store.load({\n\tcallback : function(){\t\n        if(app.ldPeriod.store.getCount()>1){\n           app.ldPeriod.setReadOnly(false);\n        }else{\n           app.ldPeriod.setReadOnly(true);\n        }\n        var r = app.ldPeriod.store.first() ;\n        app.ldPeriod.setValue(r.data.CODE) ;\n        app.ldPeriod.setRawValue(r.data.NAME) ;         \n    }\n}) ;"},"children":[],"expanded":false,"type":"date"}],"expanded":true,"type":"panel"},{"configs":{"layout":"fit","columnWidth":".25","border":"false","itemId":"tr2_3"},"children":[{"configs":{"labelWidth":"80","readOnly":"true","displayField":"CODE","valueField":"CODE","labelAlign":"right","itemId":"ldPeriod","fieldLabel":"{#ldPeriod#}","editable":"false"},"children":[{"configs":{"autoLoad":"true","itemId":"store","url":"m?xwl=xc/gl/journal/data-db/new-voucher-data/select-ld-period"},"events":{"beforeload":"store.proxy.extraParams.ledgerId=app.ledger.getValue();\nstore.proxy.extraParams.accDate=app.accountDate.getValue();"},"children":[],"expanded":false,"type":"store"}],"expanded":false,"type":"combo"}],"expanded":true,"type":"panel"},{"configs":{"layout":"fit","columnWidth":".25","border":"false","itemId":"tr2_4"},"children":[{"configs":{"labelWidth":"90","minValue":"0","value":"0","margin":"0 10 0 0","labelAlign":"right","itemId":"v_attchment_num","fieldLabel":"{#v_attchment_num#}"},"children":[],"expanded":false,"type":"number"}],"expanded":true,"type":"panel"}],"expanded":true,"type":"panel"},{"configs":{"height":"40","layout":"column","columnWidth":"1","itemId":"panel3","border":"false"},"children":[{"configs":{"layout":"fit","columnWidth":".3","border":"false","itemId":"tr3_1"},"children":[{"configs":{"labelWidth":"50","readOnly":"true","displayField":"NAME","valueField":"CODE","labelAlign":"right","itemId":"v_serial_no","fieldLabel":"{#v_serial_no#}","editable":"false"},"children":[{"configs":{"autoLoad":"true","itemId":"store","url":"m?xwl=xc/gl/journal/data-db/new-voucher-data/select-jump-serial-no"},"events":{"load":"// TODO: 处理凭证断号信息\nvar op = '{#optype#}' ;\nif(op == 'add' || op == 'copy' || op == 'write_off'){\n  if(store.getCount()>0){\n    app.v_serial_no.setReadOnly(false) ;\n  }else{\n    app.v_serial_no.setReadOnly(true) ;\n  }\n}","beforeload":"store.proxy.extraParams.ledgerId = app.ledger.getValue() ;"},"children":[],"expanded":false,"type":"store"}],"expanded":false,"type":"combo"}],"expanded":true,"type":"panel"},{"configs":{"layout":"fit","columnWidth":".2","border":"false","itemId":"tr3_2"},"children":[{"configs":{"labelWidth":"80","readOnly":"true","displayField":"NAME","valueField":"ID","labelAlign":"right","itemId":"v_category","fieldLabel":"{#v_category#}"},"events":{"select":"// TODO: 根据凭证分类转换凭证标题\nvar r = records[0] ;\nvar catName = r.data.CAT_NAME ;\nif(catName === null || catName === \"\"){\n  catName = '凭证' ;\n}\napp.label1.setText(\"<h2 align='center'><b>\"+r.data.CAT_NAME+\"<\/b><\/h2>\",false) ;\n"},"children":[{"configs":{"autoLoad":"true","itemId":"store","url":"m?xwl=xc/gl/journal/data-db/common-data/select-v-category"},"children":[],"expanded":false,"type":"store"}],"expanded":true,"type":"combo"}],"expanded":true,"type":"panel"},{"configs":{"layout":"fit","columnWidth":".5","border":"false","itemId":"tr3_3"},"children":[{"configs":{"labelWidth":"80","triggerCls":"x-form-search-trigger","margin":"0 10 0 0","labelAlign":"right","itemId":"v_summary","fieldLabel":"{#v_summary#}","editable":"true"},"children":[{"configs":{"tagConfigs":"minWidth:300","height":"200","forceFit":"true","itemId":"pickComp"},"events":{"itemclick":"var name = record.get('v_summary') ;\napp.v_summary.setValue(name) ;\napp.pickComp.hide();"},"children":[{"configs":{"autoLoad":"true","itemId":"store","url":"m?xwl=xc/gl/journal/data-db/common-data/select-ld-summaries"},"events":{"beforeload":"store.proxy.extraParams.ledgerId = app.ledger.getValue() ;"},"children":[],"expanded":false,"type":"store"},{"configs":{"itemId":"columns"},"children":[{"configs":{"text":"序号","hidden":"true","align":"center","xtype":"rownumberer","width":"60","itemId":"rownum"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"摘要ID","hidden":"true","dataIndex":"v_summary_id","itemId":"summary_id"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"摘要","width":"200","dataIndex":"v_summary","itemId":"summary_name"},"children":[],"expanded":false,"type":"column"}],"expanded":true,"type":"array"}],"expanded":true,"type":"grid"}],"expanded":false,"type":"picker"}],"expanded":true,"type":"panel"}],"expanded":true,"type":"panel"},{"configs":{"hidden":"true","columnWidth":"1","border":"false","itemId":"hiddenField"},"children":[{"configs":{"labelWidth":"80","readOnly":"true","width":"150","labelAlign":"right","itemId":"v_head_id","fieldLabel":"凭证头ID"},"children":[],"expanded":false,"type":"text"},{"configs":{"labelWidth":"80","readOnly":"true","width":"100","labelAlign":"right","itemId":"v_write_off","fieldLabel":"是否被冲销"},"children":[],"expanded":true,"type":"text"},{"configs":{"labelWidth":"90","readOnly":"true","width":"200","labelAlign":"right","itemId":"v_write_off_num","fieldLabel":"被冲销凭证号"},"children":[],"expanded":false,"type":"text"},{"configs":{"labelWidth":"80","minValue":"0","width":"200","labelAlign":"right","itemId":"v_total_dr","fieldLabel":"借方合计数"},"children":[],"expanded":false,"type":"number"},{"configs":{"labelWidth":"80","minValue":"0","width":"200","labelAlign":"right","itemId":"v_total_cr","fieldLabel":"贷方合计数"},"children":[],"expanded":false,"type":"number"},{"configs":{"itemId":"v_is_signed","fieldLabel":"是否需要出纳签字"},"children":[],"expanded":false,"type":"text"},{"configs":{"itemId":"v_status","fieldLabel":"凭证状态"},"children":[],"expanded":false,"type":"text"},{"configs":{"itemId":"v_template_type","fieldLabel":"凭证模板类型"},"children":[],"expanded":false,"type":"text"}],"expanded":false,"type":"panel"}],"expanded":true,"type":"form"},{"configs":{"region":"center","columnLines":"true","pagingBar":"false","cls":"my_custom_grid","enableColumnHide":"true","forceFit":"true","itemId":"grid1","border":"false","viewConfig":"{\n  enableTextSelection:true,\n  plugins: {\n    ptype: 'gridviewdragdrop',\n    dragText: 'Drag and drop to reorganize'\n  },\n  listeners: {\n    beforedrop: function(node, data, overModel, dropPosition, dropHandlers) {\n      //此处事件是gridviewdragdrop 的放置监听事件\n      /*\n      dropHandlers.wait = true;\n      Ext.MessageBox.confirm('Drop', 'Are you sure', function(btn){\n        if (btn === 'yes') {\n          dropHandlers.processDrop();\n        } else {\n          dropHandlers.cancelDrop();\n        }\n      });\n      */\n    },\n    drop: function(node, data, overModel, dropPosition, eOpts) {\n      //data.records[0].get('name') grid中的拖动行的name列数据值\n      //overModel.get('id') tree中被拖放到的节点的id值\n      //alert(data.records[0].get('PAR_CODE'));\n      \n      // 刷新行序号\n\t  app.grid1.getView().refresh() ;\n    }\n  }\n}","editable":"true","enableColumnMove":"false"},"events":{"afterrender":"\n\n","tagEvents":"'beforeedit' : function(editor,e,eOpts){\n  // TODO: 凭证录入、复制和修改分录行编辑列设置\n  var r = e.record  ;\n  var fd = e.field ; \n\n  // TODO: 合计行不能编辑\n  if(r.data.IS_SUM == 'Y'){\n    if(fd == 'SUMMARY' || fd == 'CCID_FULL_NAME' || fd == 'AMOUNT' || fd == 'EXCHANGE_RATE'\n       || fd == 'CURRENCY_CODE' || fd == 'ENTER_DR' || fd == 'ENTER_CR' || fd == 'ACCOUNT_DR' || fd == 'ACCOUNT_CR'){\n      return false ;\n    }\n  }else{ \n    // 非合计行,值允许编辑摘要和科目组合\n    if(fd == 'AMOUNT' || fd == 'EXCHANGE_RATE' || fd == 'CURRENCY_CODE' || fd == 'ENTER_DR' \n       || fd == 'ENTER_CR' || fd == 'ACCOUNT_DR' || fd == 'ACCOUNT_CR'){\n      return false ;\n    }\n    // 凭证状态\n    var vs = app.v_status.getValue() ; \n    if(vs == '2'){\n      if(fd == 'SUMMARY' || fd == 'CCID_FULL_NAME'){\n        return false ;\n      }\n    }\n  }\n},\n'cellclick' : function(grid1,td,cellIndex,record,tr,rowIndex,e,eOpts){\n  if(cellIndex == 6){ // 如果为行摘要列\n    // 头摘要\n    var hs = app.v_summary.getValue() ;\n    // 行摘要\n    var ls = record.data.SUMMARY ;\n    // 行摘要初始化\n    if(rowIndex === 0){\n      if(ls === '' || ls === null){\n        record.set('SUMMARY',hs) ;\n      }\n    }else{\n      if(ls === '' || ls === null){\n        var store = grid1.getStore() ;\n        var r = store.getAt(rowIndex-1) ;\n        record.set('SUMMARY',r.data.SUMMARY) ;\n      }\n    }\n  }\n}"},"children":[{"configs":{"autoLoad":"true","itemId":"store","url":"m?xwl=xc/gl/journal/data-db/new-voucher-data/init-v-lines"},"events":{"load":"// TODO: 初始化5行空分录\nvar len = 5 - records.length ;\n// 增加合计行\naddTotalLine();\nfor(var i=0; i<len; i++){\n  // 增加科目分录行\n  addEntryLines('auto') ;\n}\n// 刷新行序号\napp.grid1.getView().refresh() ;\n\n// 取得合计行\nvar i = store.find('IS_SUM','Y');\nvar r = store.getAt(i) ;\n\n// 设置合计行折后借方和贷方合计数 \nvar t_dr = app.v_total_dr.getValue() ;\nif(t_dr === \"\" || t_dr === null || t_dr === undefined){t_dr=0 ;} \nvar t_cr = app.v_total_cr.getValue() ;\nif(t_cr === \"\" || t_cr === null || t_cr === undefined){t_cr=0 ;} \n\nr.set('ACCOUNT_DR', t_dr) ; \nr.set('ACCOUNT_CR', t_cr) ;\n\n// TODO: 金额大写转换\nif(t_dr == t_cr && t_dr !== 0){\n  var cstr = amtTransChinese(t_dr) ;\n  r.set('CCID_FULL_NAME',cstr) ;\n}\nstore.commitChanges();\n"},"children":[],"expanded":false,"type":"store"},{"configs":{"itemId":"tbar"},"children":[{"configs":{"text":"{#addLine#}","itemId":"addLine","disabled":"true","iconCls":"file_add_icon"},"events":{"click":"// TODO: 新增凭证分录行\nvar ledgerId = app.ledger.getValue() ;\nif(Wb.isEmpty(ledgerId)){\n  Wb.info(\"请选择账簿!\") ;\n  return false ;\n}else{\n  // 增加科目分录行\n  addEntryLines('nonauto') ;\n  // 刷新行序号\n  app.grid1.getView().refresh();\n}"},"children":[],"expanded":false,"type":"button"},{"configs":{"text":"{#delLine#}","itemId":"delLine","disabled":"true","iconCls":"file_delete_icon"},"events":{"click":"var r = app.grid1.getSelection() ;\napp.grid1.store.remove(r[0]) ;\n// 刷新行序号\napp.grid1.getView().refresh() ;"},"children":[],"expanded":false,"type":"button"},{"configs":{"itemId":"help","iconCls":"help_icon","tooltip":"<font color=red>说明：拖动表格行可调整分录序号<\/font>"},"children":[],"expanded":false,"type":"button"}],"expanded":true,"type":"toolbar"},{"configs":{"itemId":"columns"},"children":[{"configs":{"text":"{#rowNumber#}","align":"center","xtype":"rownumberer","width":"50","dataIndex":"ORDERBY","titleAlign":"center","itemId":"rownum"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"凭证行ID","hidden":"true","dataIndex":"LINE_ID","itemId":"v_line_id"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"现金流量项目ID","hidden":"true","dataIndex":"CA_ID","itemId":"v_ca_id"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"单位ID","hidden":"true","dataIndex":"DIM_ID","itemId":"v_dim_id"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"科目组合ID","hidden":"true","dataIndex":"CCID","itemId":"v_ccid"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"是否银行或现金科目","hidden":"true","dataIndex":"IS_BC_ACC","itemId":"v_is_bc_acc"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#v_line_summary#}","sortable":"false","width":"180","align":"left","dataIndex":"SUMMARY","titleAlign":"center","itemId":"v_line_summary","renderer":"metaData.style = 'overflow:auto;padding: 3px 6px;text-overflow: ellipsis;white-space: nowrap;white-space:normal;line-height:45px;';   \nreturn value;"},"children":[{"configs":{"itemId":"editor"},"children":[],"expanded":false,"type":"text"}],"expanded":false,"type":"column"},{"configs":{"text":"{#v_line_account#}","sortable":"false","width":"250","align":"left","dataIndex":"CCID_FULL_NAME","titleAlign":"center","itemId":"v_line_account","renderer":"metaData.style = 'overflow:auto;padding: 3px 6px;text-overflow: ellipsis;white-space: nowrap;white-space:normal;line-height:45px;';   \nreturn value;"},"children":[{"configs":{"triggerCls":"x-form-search-trigger","itemId":"editor","onTriggerClick":"  // 账簿\n  var ledgerId = app.ledger.getValue() ;\n  if(ledgerId === \"\" ||ledgerId === null || ledgerId === undefined){\n    Wb.info('请选择账簿!') ;\n    return false ;\n  }\n  \n  // 会计日期\n  var accDate = app.accountDate.getValue() ;\n  if(accDate === \"\" ||accDate === null || accDate === undefined){\n    Wb.info('请选择会计日期!') ;\n    return false ;\n  }else{\n    // 账簿会计期\n    var accPeriod = app.ldPeriod.getValue() ;\n    if(accPeriod === \"\" ||accPeriod === null || accPeriod === undefined){\n      Wb.info('会计期不能为空!') ;\n      return false ;\n    }\n  }\n  \n  // TODO: 当前选中\n  var r = app.grid1.getSelection()[0] ; \n  \n  // TODO: 显示科目选择窗口\n  Wb.run({\n    url:'m?xwl=xc/gl/journal/v-windows/handler-ccid-win',\n    params : {\n      'ledgerId' : app.ledger.getValue() ,\n      'periodCode' : app.ldPeriod.getValue() \n    },          \n    success:function(appObj){\n      appObj.initWindow({\n        accName : r.data.CCID_FULL_NAME,\n        ledgerId : app.ledger.getValue(),\n        periodCode : app.ldPeriod.getValue() ,\n        caId : r.data.CA_ID ,\n        ccid : r.data.CCID,\n        groupId : 'ALL',\n        handlerCCID : function(returnObj){\n          // TODO: 处理CCID信息\n          var rObj = Wb.decode(returnObj) ;\n          r.set('CCID', rObj.acc_ccid) ;    \n          r.set('CCID_FULL_NAME', rObj.acc_ccid_name);\n          r.set('DIM_ID', rObj.dim_id) ;\n          r.set('DIM_NAME', rObj.dim_name) ;\n          r.set('IS_FOREIGN', rObj.f_cny) ;\n          r.set('CURRENCY_CODE',rObj.cny_code) ;\n          r.set('CURRENCY_NAME',rObj.cny_name) ;\n          r.set('CA_ID',rObj.ca_id) ;   \n          r.set('CA_NAME',rObj.ca_name) ;\n          r.set('IS_BC_ACC',rObj.is_sign);\n          r.set('BG_ITEM_ID',rObj.bgItemId);\n          r.set('DEPT_ID',rObj.deptId);\n          r.set('PROJECT_ID',rObj.projectId);\n          // 禁用账簿\n          app.ledger.setReadOnly(true) ;\n        }\n      });\n    }  \n  }) ;   "},"events":{"specialkey":"// TODO: 按回车键执行借方和贷方金额切换\nif (e.getKey() == e.ENTER) {\n  // 账簿\n  var ledgerId = app.ledger.getValue() ;\n  if(ledgerId === \"\" ||ledgerId === null || ledgerId === undefined){\n    Wb.info('请选择账簿!') ;\n    return false ;\n  }\n  \n  // 会计日期\n  var accDate = app.accountDate.getValue() ;\n  if(accDate === \"\" ||accDate === null || accDate === undefined){\n    Wb.info('请选择会计日期!') ;\n    return false ;\n  }else{\n    // 账簿会计期\n    var accPeriod = app.ldPeriod.getValue() ;\n    if(accPeriod === \"\" ||accPeriod === null || accPeriod === undefined){\n      Wb.info('会计期不能为空!') ;\n      return false ;\n    }\n  }\n  \n  // TODO: 当前选中\n  var r = app.grid1.getSelection()[0] ; \n  \n  // TODO: 显示科目选择窗口\n  Wb.run({\n    url:'m?xwl=xc/gl/journal/v-windows/handler-ccid-win',\n    params : {\n      'ledgerId' : app.ledger.getValue() ,\n      'periodCode' : app.ldPeriod.getValue() \n    },          \n    success:function(appObj){\n      appObj.initWindow({\n        accName : combo.getValue(),\n        ledgerId : app.ledger.getValue(),\n        periodCode : app.ldPeriod.getValue() ,\n        caId : r.data.CA_ID ,\n        ccid : r.data.CCID,\n        groupId : 'ALL',\n        handlerCCID : function(returnObj){\n          // TODO: 处理CCID信息\n          var rObj = Wb.decode(returnObj) ;\n          r.set('CCID', rObj.acc_ccid) ;    \n          r.set('CCID_FULL_NAME', rObj.acc_ccid_name);\n          r.set('DIM_ID', rObj.dim_id) ;\n          r.set('DIM_NAME', rObj.dim_name) ;\n          r.set('IS_FOREIGN', rObj.f_cny) ;\n          r.set('CURRENCY_CODE',rObj.cny_code) ;\n          r.set('CURRENCY_NAME',rObj.cny_name) ;\n          r.set('CA_ID',rObj.ca_id) ;   \n          r.set('CA_NAME',rObj.ca_name) ;\n          r.set('IS_BC_ACC',rObj.is_sign);\n          r.set('BG_ITEM_ID',rObj.bgItemId);\n          r.set('DEPT_ID',rObj.deptId);\n          r.set('PROJECT_ID',rObj.projectId);          \n          // 禁用账簿\n          app.ledger.setReadOnly(true) ;\n        }\n      });\n    }  \n  }) ;   \n}"},"children":[],"expanded":false,"type":"combo"}],"expanded":false,"type":"column"},{"configs":{"text":"{#v_ca_name#}","sortable":"false","width":"200","dataIndex":"CA_NAME","titleAlign":"center","itemId":"v_ca_name","renderer":"metaData.style = 'overflow:auto;padding: 3px 6px;text-overflow: ellipsis;white-space: nowrap;white-space:normal;line-height:45px;';   \nreturn value;"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"数量","hidden":"true","sortable":"false","xtype":"numbercolumn","align":"right","width":"150","dataIndex":"AMOUNT","titleAlign":"center","format":"0,000.0000","itemId":"v_line_amount","renderer":"metaData.style = 'overflow:auto;padding: 3px 6px;text-overflow: ellipsis;white-space: nowrap;white-space:normal;line-height:45px;';   \nif(value > 0){\n  return Wb.format(value,'0,000.0000') ;\n}else if(value < 0){\n  return '<font color=red>'+Wb.format(value,'0,000.0000')+'<\/font>' ;\n}else{\n  return '' ;\n}"},"children":[{"configs":{"decimalPrecision":"4","itemId":"editor"},"children":[],"expanded":false,"type":"number"}],"expanded":false,"type":"column"},{"configs":{"text":"单位","hidden":"true","sortable":"false","align":"center","dataIndex":"DIM_NAME","titleAlign":"center","itemId":"v_dim_name"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"汇率","hidden":"true","sortable":"false","xtype":"numbercolumn","width":"120","align":"right","dataIndex":"EXCHANGE_RATE","titleAlign":"center","format":"0,000.0000","itemId":"v_exchange_rate","renderer":"metaData.style = 'overflow:auto;padding: 3px 6px;text-overflow: ellipsis;white-space: nowrap;white-space:normal;line-height:45px;';   \nif(value < 0){\n  return '<font color=red>'+Wb.format(value,'0,000.0000')+'<\/font>' ;\n}else{\n  return Wb.format(value,'0,000.0000') ;\n}"},"children":[{"configs":{"decimalPrecision":"4","itemId":"editor"},"children":[],"expanded":false,"type":"number"}],"expanded":false,"type":"column"},{"configs":{"text":"是否外币","hidden":"true","dataIndex":"IS_FOREIGN","itemId":"v_is_foreign"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"币种编码","hidden":"true","dataIndex":"CURRENCY_CODE","titleAlign":"center","itemId":"v_line_currency"},"children":[],"expanded":true,"type":"column"},{"configs":{"text":"币种","hidden":"true","sortable":"false","align":"center","dataIndex":"CURRENCY_NAME","titleAlign":"center","itemId":"v_cny_name"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#v_enter_dr#}","hidden":"true","sortable":"false","xtype":"numbercolumn","align":"right","width":"150","dataIndex":"ENTER_DR","titleAlign":"center","format":"0,000.00","itemId":"v_enter_dr","renderer":"metaData.style = 'overflow:auto;padding: 3px 6px;text-overflow: ellipsis;white-space: nowrap;white-space:normal;line-height:45px;';   \nif(value > 0){\n  return Wb.format(value,'0,000.00') ;\n}else if(value < 0){\n  return '<font color=red>'+Wb.format(value,'0,000.00')+'<\/font>' ;\n}else{\n  return '' ;\n}"},"children":[{"configs":{"tagConfigs":"{\n  enableKeyEvents : true\n}","decimalPrecision":"2","itemId":"editor"},"children":[],"expanded":false,"type":"number"}],"expanded":false,"type":"column"},{"configs":{"text":"{#v_enter_cr#}","hidden":"true","sortable":"false","xtype":"numbercolumn","align":"right","width":"150","dataIndex":"ENTER_CR","titleAlign":"center","format":"0,000.00","itemId":"v_enter_cr","renderer":"metaData.style = 'overflow:auto;padding: 3px 6px;text-overflow: ellipsis;white-space: nowrap;white-space:normal;line-height:45px;';   \nif(value > 0){\n  return Wb.format(value,'0,000.00') ;\n}else if(value < 0){\n  return '<font color=red>'+Wb.format(value,'0,000.00')+'<\/font>' ;\n}else{\n  return '' ;\n}"},"children":[{"configs":{"decimalPrecision":"2","itemId":"editor"},"children":[],"expanded":false,"type":"number"}],"expanded":false,"type":"column"},{"configs":{"text":"{#v_account_dr#}","sortable":"false","xtype":"numbercolumn","align":"right","width":"150","dataIndex":"ACCOUNT_DR","titleAlign":"center","format":"0,000.00","itemId":"v_account_dr","renderer":"metaData.style = 'overflow:auto;padding: 3px 6px;text-overflow: ellipsis;white-space: nowrap;white-space:normal;line-height:45px;';   \nif(value > 0){\n  return Wb.format(value,'0,000.00') ;\n}else if(value < 0){\n  return '<font color=red>'+Wb.format(value,'0,000.00')+'<\/font>' ;\n}else{\n  return '' ;\n}"},"children":[{"configs":{"decimalPrecision":"2","itemId":"editor"},"children":[],"expanded":false,"type":"number"}],"expanded":false,"type":"column"},{"configs":{"text":"{#v_account_cr#}","sortable":"false","xtype":"numbercolumn","align":"right","width":"150","dataIndex":"ACCOUNT_CR","titleAlign":"center","format":"0,000.00","itemId":"v_account_cr","renderer":"metaData.style = 'overflow:auto;padding: 3px 6px;text-overflow: ellipsis;white-space: nowrap;white-space:normal;line-height:45px;';   \nif(value > 0){\n  return Wb.format(value,'0,000.00') ;\n}else if(value < 0){\n  return '<font color=red>'+Wb.format(value,'0,000.00')+'<\/font>' ;\n}else{\n  return '' ;\n}"},"children":[{"configs":{"decimalPrecision":"2","itemId":"editor"},"children":[],"expanded":false,"type":"number"}],"expanded":false,"type":"column"},{"configs":{"text":"是否合计行","hidden":"true","dataIndex":"IS_SUM","titleAlign":"center","itemId":"v_is_sum"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"预算项目ID","hidden":"true","dataIndex":"BG_ITEM_ID","itemId":"v_bg_item_id"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"成本中心ID","hidden":"true","dataIndex":"DEPT_ID","itemId":"v_dept_id"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"项目ID","hidden":"true","dataIndex":"PROJECT_ID","itemId":"v_project_id"},"children":[],"expanded":false,"type":"column"}],"expanded":true,"type":"array"},{"configs":{"border":"false","itemId":"bbar"},"children":[{"configs":{"layout":"fit","columnWidth":".25","border":"false","itemId":"panel1"},"children":[{"configs":{"hidden":"true","itemId":"v_created_by","fieldLabel":"制单人ID"},"children":[],"expanded":false,"type":"text"},{"configs":{"labelWidth":"50","readOnly":"true","labelAlign":"right","itemId":"v_created_name","fieldLabel":"{#v_created_name#}"},"children":[],"expanded":false,"type":"text"}],"expanded":true,"type":"panel"},{"configs":{"layout":"fit","columnWidth":".25","border":"false","itemId":"panel2"},"children":[{"configs":{"hidden":"true","itemId":"v_verifier_id","fieldLabel":"审核人ID"},"children":[],"expanded":false,"type":"text"},{"configs":{"labelWidth":"50","readOnly":"true","labelAlign":"right","itemId":"v_verifier","fieldLabel":"{#v_verifier#}"},"children":[],"expanded":false,"type":"text"}],"expanded":true,"type":"panel"},{"configs":{"layout":"fit","columnWidth":".25","border":"false","itemId":"panel3"},"children":[{"configs":{"hidden":"true","itemId":"v_signatory_id","fieldLabel":"出纳ID"},"children":[],"expanded":false,"type":"text"},{"configs":{"labelWidth":"50","readOnly":"true","labelAlign":"right","itemId":"v_signatory","fieldLabel":"{#v_signatory#}"},"children":[],"expanded":false,"type":"text"}],"expanded":true,"type":"panel"},{"configs":{"layout":"fit","columnWidth":".25","border":"false","itemId":"panel4"},"children":[{"configs":{"hidden":"true","itemId":"v_bookkeeper_id","fieldLabel":"记账人ID"},"children":[],"expanded":false,"type":"text"},{"configs":{"labelWidth":"50","readOnly":"true","labelAlign":"right","itemId":"v_bookkeeper","fieldLabel":"{#v_bookkeeper#}"},"children":[],"expanded":false,"type":"text"}],"expanded":true,"type":"panel"}],"expanded":false,"type":"toolbar"}],"expanded":true,"type":"grid"}],"expanded":true,"type":"panel"}],"expanded":true,"type":"panel"}],"expanded":true,"type":"module"}],"pageLink":"","iconCls":"file_xwl_icon"}