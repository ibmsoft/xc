{"inframe":false,"title":"凭证列表信息","hidden":false,"roles":{"default":1},"children":[{"configs":{"title":"凭证列表","loginRequired":"false","jsLinks":"[\"XCloud/js/XCVP.js\"]","serverScript":"// 获取当前模块语言对应的.json文件，放到request\ncom.xzsoft.xip.platform.util.XipUtil.getCurrentLang(request,\"xc/gl/journal/ld-voucher/json/voucher-list\");\n\n// TODO: 获取当前凭证的操作类型: record-凭证录入,check-凭证审核，sign-出纳签字,account-记账处理\nvar opType = request.getParameter(\"op\") ;\n\n// TODO: 将变量信息存入request对象\nrequest.setAttribute(\"op\",opType) ;\nrequest.setAttribute(\"ctxPath\",request.getContextPath()) ;\n\n// TODO: 当前数据库类型\nvar dbtype = com.xzsoft.xip.platform.util.PlatformUtil.getDbType() ;\nrequest.setAttribute(\"dbType\",dbtype) ;\n\n// TODO: 会话ID\nvar sessionId = request.getSession().getId() ;\nrequest.setAttribute(\"sessionId\",sessionId) ;\n// TODO: 当前语言环境\nvar la_sessionVars = request.getSession().getAttribute(com.xzsoft.xip.framework.common.SessionVariable.XZ_SESSION_VARS);\nvar la_system_language = la_sessionVars.get(com.xzsoft.xip.framework.common.SessionVariable.language);\nrequest.setAttribute('la_system_language',la_system_language);","head":"<style type=\"text/css\">\n  .my_custom_grid .x-grid-row{\n      height:50px;\n  }\n  .my_custom_grid .x-grid-editor .x-form-text{\n      height:49px;\n  }\n  .my_custom_grid .x-grid-cell{\n      font: normal 12px/13px tahoma, arial, verdana, sans-serif;\n  }\n  .my_custom_grid .x-grid-cell{\n      border-color: #d0d0d0;\n  }\n  .my_custom_grid .x-grid-with-col-lines .x-grid-cell {\n    border-right-width: 1px;\n  }\n  .my_custom_grid .x-grid-with-row-lines .x-grid-td {\n    border-bottom-width: 1px;\n}\n<\/style>\n<script language=\"javascript\" type=\"text/javascript\">\n  // 监听键盘组合键按下事件\n  document.onkeydown = function(){\n    var e = window.event; \n    // 组合键：Ctrl+Alt+9 \n    if (e.keyCode == 57 && e.ctrlKey && e.altKey) {  \n      // 取消记账处理\n      app.cancelAccountBtn.fireEvent('click') ;\n    }  \n  } ;\n<\/script>","itemId":"module"},"events":{"initialize":"// TODO: 凭证信息初始化函数\nfunction getInitVData(r,optype){\n // 执行参数封装\n  var paramJson = {'optype':optype} ;\n  \n  // 凭证信息\n  var headId = r.V_HEAD_ID;\n  paramJson.headId = headId ;\n  \n  var ledgerId = r.LEDGER_ID ;\n  paramJson.ledgerId = ledgerId;\n  \n  // 获取待重新的凭证头ID和凭证模板类型(1-金额凭证,2-数量凭证,3-外币凭证)\n  var voucherType = r.V_TEMPLATE_TYPE ;\n  if(voucherType == '1'){\n    paramJson.vt = 'normal' ;\n  }else if(voucherType == '2'){\n    paramJson.vt = 'amount' ;\n  }else if(voucherType == '3'){\n    paramJson.vt = 'foreign' ;\n  }else{\n    paramJson.vt = 'normal' ;       \n  } \n  \n  return paramJson ;\n}\n\n// TODO: 是否包含子模块凭证信息\nfunction isContainChildV(records){\n  var i = 0 ;\n  if(records.length === 0){\n    return false ;\n  }else{\n    Ext.each(records, function(r){\n      var srcCode = r.get('V_SRC_CODE') ; // 来源编码      \n      if(srcCode !== \"\" &&　srcCode　!== null && srcCode !== undefined){\n        i++ ;\n      }\n    });\n    if(i>0){\n      return true ;\n    }else{\n      return false ;\n    }\n  }\n}\n\n// TODO: 余额汇总处理函数\nfunction sumBalances(paramsJson,isAccount,isSumCash,ctxPath,isCanceled){\n  var params = Wb.decode(paramsJson) ;\n  if(params.length > 0){\n    \n    // TODO: 进度条\n    var process = Ext.MessageBox.show({\n      title:'请等待',\n      msg:'正在提交余额汇总请求，请稍后...',\n      width:240,\n      wait:true,\n      progress :true,\n      closable :false\n    });\t\n    \n    // 提交请求执行余额汇总处理\n    Wb.request({\n      url: ctxPath+'/sumBalanceAction.do?method=sumBalances',\n      timeout:3600000,\n      params: {'headArray':paramsJson,'isAccount':isAccount,'isSumCash':isSumCash,'isCanceled':isCanceled},\n      success: function(resp) {\n        process.hide();\n        var response = Wb.decode(resp.responseText);\n        var msg ; \n        if(response.flag == \"1\"){\n          if(isAccount == 'Y'){\n            msg = '凭证过账余额汇总处理失败!' ;\n          }else{\n            msg = '凭证提交余额汇总处理失败!' ;\n          }\n        }else{\n          if(isAccount == 'Y'){ \n            app.queryBtn.fireEvent('click') ;\t// 加载凭证信息\n            msg = '凭证过账余额汇总处理成功!' ;\n          }else{           \n            msg = '凭证提交余额汇总处理成功!' ;\n          }\n        }\n        Wb.info(msg) ;\n      }\n    });\n  }\n}"},"children":[{"configs":{"title":"凭证导入  <i>导入文件必须是xls格式的excel文件<\/i>","height":"400","layout":"border","closeAction":"hide","itemId":"impWin","modal":"true"},"events":{"show":"app.tmpVoucherList.getStore().load({\n  params : {\n    'sessionId' : '{#sessionId#}'\n  }\n}) ;"},"children":[{"configs":{"region":"north","layout":"column","border":"false","bodyPadding":"10","itemId":"uploadForm"},"children":[{"configs":{"layout":"fit","columnWidth":".85","border":"false","itemId":"td_1"},"children":[{"configs":{"labelWidth":"100","labelAlign":"right","itemId":"xlsFile","fieldLabel":"选择文件"},"children":[],"expanded":false,"type":"file"}],"expanded":true,"type":"panel"},{"configs":{"layout":"fit","columnWidth":".1","margin":"0 0 0 10","border":"false","itemId":"td_2"},"children":[{"configs":{"text":"导入","itemId":"impData","iconCls":"ok_icon"},"events":{"click":"if(!app.uploadForm.getForm().isValid()){\n  Wb.toast('请选择要上传的文件！');\n  return false;\n}\n// 文件类型\nvar fileType = app.xlsFile.getValue();\nif(!Ext.String.endsWith(fileType,'.xls')){\n  Wb.info('请选择xls格式excel文档!',function(){\n    app.uploadForm.getForm().reset();\n  });\n  \n}else{  \n  // 获取账簿ID\n  var ledgerId = app.ledger.getValue() ;\n  if(ledgerId === null || ledgerId === \"\" || ledgerId === undefined){\n    Wb.toast('请选择账簿') ;\n    return false ;\n  }  \n  // TODO: 清空Grid\n  app.tmpVoucherList.getStore().removeAll() ;\n  \n  // 进度条\n  var processMsg = Ext.Msg.show({\n     title : '提示',\n     msg   : '导入中，请稍后.....',\n     wait  : true,\n     width : 200\n  });  \n  // 将Office Excel数据导入凭证临时表中\n  app.uploadForm.getForm().submit({\n    url     : '{#ctxPath#}/voucherHandlerAction.do?method=impVoucher&ledgerId='+ledgerId,\n    timeout : 3600000,\n    success : function(form,action){\n      processMsg.hide();\n      var _flag = action.result.flag ; \n      if(_flag == \"0\"){ \n        // 导入成功\n        app.impWin.close() ;\n        app.queryBtn.fireEvent('click') ;\n        \n      }else{ \n        // 导入失败,存在非法数据\n        app.tmpVoucherList.getStore().load({\n          params : {\n            'sessionId' : '{#sessionId#}'\n          }\n        }) ;\n      }\n      Wb.info(action.result.msg,function(){});\n    },\n    failure : function(form,action){\n      processMsg.hide();\n      var _flag = action.result.flag;\n      Wb.info(action.result.msg, function(){}) ;\n    }   \n  }); \n}"},"children":[],"expanded":false,"type":"button"}],"expanded":true,"type":"panel"}],"expanded":true,"type":"form"},{"configs":{"region":"center","forceFit":"true","itemId":"tmpVoucherList"},"children":[{"configs":{"autoLoad":"true","itemId":"store","url":"m?xwl=xc/gl/journal/data-db/tmp-voucher-data/select-tmp-voucher"},"children":[],"expanded":false,"type":"store"},{"configs":{"itemId":"columns"},"children":[{"configs":{"text":"记录行号","align":"center","width":"80","dataIndex":"ROW_NUM","titleAlign":"center","itemId":"ROW_NUM"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"错误描述","width":"500","dataIndex":"ERROR_MSG","titleAlign":"center","itemId":"ERROR_MSG","renderer":"metaData.style = 'overflow:auto;padding: 3px 6px;text-overflow: ellipsis;white-space: nowrap;white-space:normal;line-height:20px;';   \nreturn value;"},"children":[],"expanded":false,"type":"column"}],"expanded":true,"type":"array"}],"expanded":true,"type":"grid"}],"expanded":false,"type":"window"},{"configs":{"title":"打印","height":"100","layout":"form","width":"350","closeAction":"hide","buttonAlign":"center","dialog":"true","itemId":"paperChooseWin","modal":"true"},"events":{"ok":"var _rows = app.grid4VoucherList.getSelection();\nvar _leaderId = app.ledger.getValue();\nvar _headerIds = '';\nExt.each(_rows,function(item){\n    _headerIds = _headerIds +'\\''+item.data.V_HEAD_ID+'\\',';\n  });\n  _headerIds = _headerIds.substring(0,_headerIds.length-1);\nif('A5' === app.paperSize.getValue()){\n   win.close();\n   XCVP.batchPrint('{#ctxPath#}',_headerIds,_leaderId,app.templateType.getValue(),'','{#la_system_language#}');\n}else{\n   win.close();\n   XCVP.batchA4Print('{#ctxPath#}',_headerIds,_leaderId,app.templateType.getValue(),'','{#la_system_language#}');\n}"},"children":[{"configs":{"labelWidth":"80","value":"A5","pickList":"[['A4','A4'],['A5','A5']]","labelAlign":"right","itemId":"paperSize","fieldLabel":"选择纸张"},"children":[],"expanded":true,"type":"combo"}],"expanded":true,"type":"window"},{"configs":{"layout":"border","itemId":"viewport1"},"children":[{"configs":{"region":"north","bodyPadding":"5","border":"false","itemId":"formPanel"},"children":[{"configs":{"height":"30","layout":"column","columnWidth":"1","border":"false","itemId":"panel1"},"children":[{"configs":{"layout":"fit","columnWidth":".3","border":"false","itemId":"tr1_1"},"children":[{"configs":{"labelWidth":"80","allowBlank":"false","displayField":"NAME","valueField":"ID","labelAlign":"right","itemId":"ledger","fieldLabel":"{#ledger#}"},"events":{"select":"// 加载凭证\napp.queryBtn.fireEvent('click') ;\n// 加载科目\napp.btnQryAcc.fireEvent('click') ;\n"},"children":[{"configs":{"autoLoad":"true","itemId":"store","url":"m?xwl=xc/com-qry/gl-ledgers/select-sec-ledger"},"events":{"load":"// TODO: 取第一条数据作为默认值\nif(store.getCount() == 1){\n  var r = records[0];\n  Wb.setValue(app.ledger,{'ledger':r.data.ID}) ;\n  app.queryBtn.fireEvent('click') ;\n}  \n\n"},"children":[],"expanded":false,"type":"store"}],"expanded":true,"type":"combo"}],"expanded":false,"type":"panel"},{"configs":{"layout":"column","columnWidth":".4","border":"false","itemId":"tr1_2"},"children":[{"configs":{"layout":"fit","columnWidth":".55","border":"false","itemId":"tr1_2_1"},"children":[{"configs":{"labelWidth":"120","labelAlign":"right","itemId":"startDate","fieldLabel":"{#startDate#}","editable":"false"},"events":{"afterrender":"// TODO: 按当前自然月计算开始日期\nvar dd = new Date() ;\nvar dataStr = Wb.dateToStr(dd) ;\ndataStr = dataStr.substring(0,7)+\"-01\" ;\n\napp.startDate.setValue(new Date(dataStr)) ;","change":"app.queryBtn.fireEvent('click') ;"},"children":[],"expanded":false,"type":"date"}],"expanded":true,"type":"panel"},{"configs":{"layout":"fit","columnWidth":".05","border":"false","itemId":"tr1_2_2"},"children":[{"configs":{"text":"--","margin":"0 0 0 10","itemId":"label1"},"children":[],"expanded":false,"type":"label"}],"expanded":false,"type":"panel"},{"configs":{"layout":"fit","columnWidth":".4","border":"false","itemId":"tr1_2_3"},"children":[{"configs":{"itemId":"endDate","editable":"false"},"events":{"afterrender":"app.endDate.setValue(new Date()) ;","change":"app.queryBtn.fireEvent('click') ;"},"children":[],"expanded":false,"type":"date"}],"expanded":true,"type":"panel"}],"expanded":false,"type":"panel"},{"configs":{"layout":"column","columnWidth":".3","border":"false","itemId":"tr1_3"},"children":[{"configs":{"layout":"fit","columnWidth":".5","border":"false","itemId":"tr1_3_1"},"children":[{"configs":{"labelWidth":"100","queryMode":"local","displayField":"NAME","valueField":"ID","labelAlign":"right","itemId":"vCategoryId","fieldLabel":"{#vCategoryId#}"},"events":{"select":"app.queryBtn.fireEvent('click') ;"},"children":[{"configs":{"autoLoad":"true","itemId":"store","url":"m?xwl=xc/gl/journal/data-db/common-data/select-v-category"},"events":{"load":"// TODO: 设置全部项\nExt.define('categoryModel', {  \n    extend: 'Ext.data.Model',  \n    fields: [  \n        {name: 'ID'},  \n        {name: 'NAME'}\n     ]  \n});\nvar r = Ext.create('categoryModel', {\n  'ID':'ALL', \n  'NAME':'全部'\n});\n\nstore.insert(0,r);\n\n// TODO: 设置默认值\nWb.setValue(app.vCategoryId,{'vCategoryId':'ALL'}) ;"},"children":[],"expanded":false,"type":"store"}],"expanded":false,"type":"combo"}],"expanded":true,"type":"panel"},{"configs":{"layout":"fit","columnWidth":".5","border":"false","itemId":"tr1_3_2"},"children":[{"configs":{"margin":"0 15 0 0","itemId":"vSerialNO"},"events":{"specialkey":"if (e.getKey() == Ext.EventObject.ENTER) {\n  app.queryBtn.fireEvent('click') ;\n}"},"children":[],"expanded":false,"type":"text"}],"expanded":true,"type":"panel"}],"expanded":true,"type":"panel"}],"expanded":false,"type":"panel"},{"configs":{"height":"30","layout":"column","columnWidth":"1","border":"false","itemId":"panel2"},"events":{"afterrender":"var opType = '{#op#}' ;\n\nif(opType == 'record'){\n  app.voucherStatus.show();\n  app.signStatus.hide();\n  \n}else if(opType == 'check'){\n  app.voucherStatus.show();\n  app.signStatus.hide();\n  \n}else if(opType == 'sign'){\n  app.voucherStatus.hide();\n  app.signStatus.show();\n  \n}else if(opType == 'account'){\n  app.voucherStatus.show();\n  app.signStatus.hide();\n  \n}else{\n  app.voucherStatus.show();\n  app.signStatus.hide();\n}"},"children":[{"configs":{"layout":"fit","columnWidth":".3","border":"false","itemId":"tr2_1"},"children":[{"configs":{"labelWidth":"40","hidden":"true","labelAlign":"right","itemId":"account","fieldLabel":"科目"},"children":[],"expanded":true,"type":"text"},{"configs":{"labelWidth":"80","triggerCls":"x-form-search-trigger","labelAlign":"right","itemId":"accountName","fieldLabel":"{#accountName#}","editable":"false"},"children":[{"configs":{"tagConfigs":"minWidth:470","multiSelect":"false","height":"300","border":"false","forceFit":"true","itemId":"pickComp"},"events":{"itemclick":"var accCode = record.get('ACC_CODE') ;\nvar accName = record.get('ACC_NAME') ;\n\napp.account.setValue(accCode) ;\napp.accountName.setValue(accCode+' '+accName) ;\napp.pickComp.hide() ;\napp.queryBtn.fireEvent('click') ;"},"children":[{"configs":{"itemId":"tbar"},"children":[{"configs":{"width":"300","itemId":"codeOrName"},"events":{"change":"// 动态筛选\nvar accStore = app.pickComp.getStore() ;\naccStore.filterBy(function(record,id){\n  var text = record.get('ACC_CODE');\n  return (text.indexOf(newValue)!=-1);\n});","specialkey":"if (e.getKey() == Ext.EventObject.ENTER) {\n  app.btnQryAcc.fireEvent('click') ;\n}"},"children":[],"expanded":false,"type":"text"},{"configs":{"itemId":"btnQryAcc","iconCls":"seek_icon"},"events":{"click":"app.pickComp.getStore().load() ;"},"children":[],"expanded":false,"type":"button"},{"configs":{"itemId":"btnClearAcc","iconCls":"cancel_icon","tooltip":"清空科目筛选条件"},"events":{"click":"app.account.setValue() ;\napp.accountName.setValue() ;\napp.pickComp.hide() ;\napp.queryBtn.fireEvent('click') ;"},"children":[],"expanded":false,"type":"button"}],"expanded":true,"type":"toolbar"},{"configs":{"autoLoad":"true","itemId":"store","url":"m?xwl=xc/gl/journal/data-db/common-data/select-accounts"},"events":{"beforeload":"store.proxy.extraParams.ledgerId = app.ledger.getValue() ;\nstore.proxy.extraParams.accName = app.codeOrName.getValue() ;"},"children":[],"expanded":false,"type":"store"},{"configs":{"itemId":"columns"},"children":[{"configs":{"text":"科目ID","hidden":"true","dataIndex":"ACC_ID","itemId":"ID"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#ACC_CODE#}","width":"140","dataIndex":"ACC_CODE","titleAlign":"center","itemId":"CODE"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#ACC_NAME#}","width":"250","dataIndex":"ACC_NAME","titleAlign":"center","itemId":"NAME"},"children":[],"expanded":false,"type":"column"}],"expanded":true,"type":"array"}],"expanded":true,"type":"grid"}],"expanded":true,"type":"picker"}],"expanded":false,"type":"panel"},{"configs":{"layout":"column","columnWidth":".4","border":"false","itemId":"tr2_2"},"children":[{"configs":{"layout":"fit","columnWidth":".55","border":"false","itemId":"tr2_2_1"},"children":[{"configs":{"labelWidth":"120","labelAlign":"right","itemId":"startAmount","fieldLabel":"{#startAmount#}"},"events":{"specialkey":"if (e.getKey() == e.ENTER) {\n  app.queryBtn.fireEvent('click') ;\n}"},"children":[],"expanded":false,"type":"number"}],"expanded":true,"type":"panel"},{"configs":{"layout":"fit","columnWidth":".05","border":"false","itemId":"tr2_2_2"},"children":[{"configs":{"text":"--","margin":"0 0 0 10","itemId":"label2"},"children":[],"expanded":true,"type":"label"}],"expanded":true,"type":"panel"},{"configs":{"layout":"fit","columnWidth":".4","border":"false","itemId":"tr2_2_3"},"children":[{"configs":{"width":"150","itemId":"endAmount"},"events":{"specialkey":"if (e.getKey() == e.ENTER) {\n  app.queryBtn.fireEvent('click') ;\n}"},"children":[],"expanded":false,"type":"number"}],"expanded":true,"type":"panel"}],"expanded":false,"type":"panel"},{"configs":{"layout":"fit","columnWidth":".3","border":"false","itemId":"tr2_3"},"children":[{"configs":{"labelWidth":"100","queryMode":"local","displayField":"NAME","width":"225","valueField":"CODE","margin":"0 15 0 0","labelAlign":"right","itemId":"voucherStatus","fieldLabel":"{#voucherStatus#}","editable":"false"},"events":{"select":"// TODO: 记录条件信息\nvar selVal = combo.getValue() ;\nvar _dbType = '{#dbType#}' ;\n\nif(selVal == '1'){ // 草稿\n  app.statusCondition.setValue(\"V_STATUS = '1'\") ;\n}else if(selVal == '2'){ // 审核中\n  app.statusCondition.setValue(\"V_STATUS = '2' AND VERIFIER_ID IS NULL\") ;\n}else if(selVal == '3'){// 审核通过\n  app.statusCondition.setValue(\"VERIFIER_ID IS NOT NULL AND BOOKKEEPER_ID IS NULL\") ;\n}else if(selVal == '4'){// 已记账\n  if(_dbType == 'mysql'){\n\tapp.statusCondition.setValue(\" IFNULL(IS_WRITE_OFF,'N') <> 'Y' AND BOOKKEEPER_ID IS NOT NULL \") ;\n  }else if(dbType == 'oracle'){\n    app.statusCondition.setValue(\" NVL(IS_WRITE_OFF,'N') <> 'Y' AND BOOKKEEPER_ID IS NOT NULL \") ;\n  }else{\n  }\n}else if(selVal == '5'){// 已冲销\n  app.statusCondition.setValue(\"IS_WRITE_OFF = 'Y'\") ;\n}else{\n  app.statusCondition.setValue(\"1=1\") ;\n}\n\n// TODO: 执行查询\napp.queryBtn.fireEvent('click') ;"},"children":[{"configs":{"autoLoad":"true","itemId":"store","url":"m?xwl=xc/gl/journal/data-db/ld-vouchers-data/select-v-status"},"events":{"load":"Ext.define('statusModel', {  \n    extend: 'Ext.data.Model',  \n    fields: [  \n        {name: 'CODE'},  \n        {name: 'NAME'}\n     ]  \n});\nvar r = Ext.create('statusModel', {\n  'CODE':'ALL', \n  'NAME':'全部'\n});\n\nstore.insert(0,r);\n\n// TODO: 设置默认值\nWb.setValue(app.voucherStatus,{'voucherStatus':'ALL'}) ;","beforeload":"store.proxy.extraParams.op = '{#op#}' ;"},"children":[],"expanded":false,"type":"store"}],"expanded":false,"type":"combo"},{"configs":{"labelWidth":"120","queryMode":"local","displayField":"NAME","hidden":"true","width":"225","valueField":"CODE","margin":"0 15 0 0","labelAlign":"right","itemId":"signStatus","fieldLabel":"{#signStatus#}"},"events":{"select":"// TODO: 记录条件信息\nvar selVal = combo.getValue() ;\nif(selVal == 'Y'){ // 已签字\n  app.statusCondition.setValue(\"SIGNATORY_ID IS NOT NULL\") ;\n}else if(selVal == 'N'){ // 未签字\n  app.statusCondition.setValue(\"IS_SIGNED = 'Y' AND SIGNATORY_ID IS NULL\") ;\n}else{\n  app.statusCondition.setValue(\"1=1\") ;\n}\n\n// TODO: 执行查询\napp.queryBtn.fireEvent('click') ;"},"children":[{"configs":{"autoLoad":"true","itemId":"store","url":"m?xwl=xc/gl/journal/data-db/ld-vouchers-data/select-v-sign"},"events":{"load":"Ext.define('statusModel', {  \n    extend: 'Ext.data.Model',  \n    fields: [  \n        {name: 'CODE'},  \n        {name: 'NAME'}\n     ]  \n});\nvar r = Ext.create('statusModel', {\n  'CODE':'ALL', \n  'NAME':'全部'\n});\n\nstore.insert(0,r);\n\n// TODO: 设置默认值\nWb.setValue(app.signStatus,{'signStatus':'ALL'}) ;"},"children":[],"expanded":false,"type":"store"}],"expanded":false,"type":"combo"}],"expanded":true,"type":"panel"}],"expanded":false,"type":"panel"},{"configs":{"height":"30","layout":"column","columnWidth":"1","border":"false","itemId":"panel3"},"children":[{"configs":{"layout":"fit","columnWidth":".3","border":"false","itemId":"tr3_1"},"children":[{"configs":{"labelWidth":"80","labelAlign":"right","itemId":"createdByName","fieldLabel":"{#createdByName#}"},"events":{"specialkey":"if (e.getKey() == Ext.EventObject.ENTER) {\n  app.queryBtn.fireEvent('click') ;\n}"},"children":[],"expanded":false,"type":"text"}],"expanded":true,"type":"panel"},{"configs":{"layout":"fit","columnWidth":".4","border":"false","itemId":"tr3_2"},"children":[{"configs":{"labelWidth":"120","labelAlign":"right","itemId":"summary","fieldLabel":"{#summary#}"},"events":{"specialkey":"if (e.getKey() == Ext.EventObject.ENTER) {\n  app.queryBtn.fireEvent('click') ;\n}"},"children":[],"expanded":false,"type":"text"}],"expanded":true,"type":"panel"},{"configs":{"layout":"fit","columnWidth":".15","border":"false","itemId":"tr3_3"},"children":[{"configs":{"labelWidth":"100","queryMode":"local","displayField":"NAME","value":"ALL","valueField":"CODE","labelAlign":"right","itemId":"templateType","fieldLabel":"凭证格式"},"events":{"select":"app.queryBtn.fireEvent('click') ;"},"children":[{"configs":{"data":"[{'CODE':'ALL','NAME':'全部'},{'CODE':'1','NAME':'金额式'},{'CODE':'2','NAME':'数量式'},{'CODE':'3','NAME':'外币式'}]","itemId":"store","fields":"[{name:'CODE'},{name:'NAME'}]"},"children":[],"expanded":false,"type":"store"}],"expanded":true,"type":"combo"}],"expanded":true,"type":"panel"},{"configs":{"layout":"column","columnWidth":".15","border":"false","itemId":"tr3_4"},"children":[{"configs":{"text":"{#queryBtn#}","margin":"0 10 0 25","itemId":"queryBtn","iconCls":"seek_icon"},"events":{"click":"app.grid4VoucherList.store.load({\n  out:app.formPanel\n});"},"children":[],"expanded":true,"type":"button"},{"configs":{"text":"{#resetBtn#}","itemId":"resetBtn","iconCls":"redo_icon"},"events":{"click":"app.formPanel.getForm().reset();\napp.grid4VoucherList.store.removeAll();\nWb.setValue(app.vCategoryId,{'vCategoryId':'ALL'}) ;\nWb.setValue(app.voucherStatus,{'voucherStatus':'ALL'}) ;\nWb.setValue(app.signStatus,{'signStatus':'ALL'}) ;"},"children":[],"expanded":false,"type":"button"}],"expanded":true,"type":"panel"}],"expanded":true,"type":"panel"},{"configs":{"itemId":"hiddenPanel"},"children":[{"configs":{"labelWidth":"80","readOnly":"true","hidden":"true","value":"1=1","labelAlign":"right","itemId":"statusCondition","fieldLabel":"状态条件"},"children":[],"expanded":false,"type":"text"}],"expanded":false,"type":"panel"}],"expanded":false,"type":"form"},{"configs":{"region":"center","multiSelect":"false","selType":"checkboxmodel","itemId":"grid4VoucherList","viewConfig":"{\n enableTextSelection:true\n}"},"events":{"itemclick":"var grid_cells_editor = document.getElementsByClassName('x-grid-cell-editor');\nfor(var i = 0; i < grid_cells_editor.length; i++){\n\tgrid_cells_editor[i].style.top = 50 * index + 'px';\n}\n","itemdblclick":"app.viewBtn.fireEvent('click') ;"},"children":[{"configs":{"itemId":"store","url":"m?xwl=xc/gl/journal/data-db/ld-vouchers-data/select-vouchers","showMask":"true"},"events":{"beforeload":"store.proxy.extraParams.op = '{#op#}' ;"},"children":[],"expanded":false,"type":"store"},{"configs":{"itemId":"tbar"},"events":{"afterrender":"var opType = '{#op#}' ;\n\nif(opType == 'record'){\n  app.addBtn.show() ;\n  app.copyBtn.show() ;\n  app.writeOffBtn.show();\n  app.delBtn.show();\n  app.editBtn.show();\n  app.submitBtn.show();\n  app.cancelSubmitBtn.show();  \n  app.checkBtn.hide();\n  app.cancelChkBtn.hide();\n  app.rejectBtn.hide();\n  app.viewBtn.show() ;\n  app.signBtn.hide() ;\n  app.cancelSignBtn.hide();\n  app.accountBtn.hide();\n  app.batchPrintBtn.show() ;\n  app.impBtn.show() ;\n  app.expBtn.show() ;\n  \n}else if(opType == 'check'){\n  app.addBtn.hide() ;\n  app.copyBtn.hide() ;\n  app.writeOffBtn.hide();\n  app.delBtn.hide();\n  app.editBtn.hide();\n  app.submitBtn.hide();\n  app.cancelSubmitBtn.hide();  \n  app.checkBtn.show();\n  app.cancelChkBtn.show();\n  app.rejectBtn.show();\n  app.viewBtn.show();\n  app.signBtn.hide() ;\n  app.cancelSignBtn.hide();\n  app.accountBtn.hide();  \n  \n}else if(opType == 'sign'){\n  app.addBtn.hide() ;\n  app.copyBtn.hide() ;\n  app.writeOffBtn.hide();\n  app.delBtn.hide();\n  app.editBtn.hide();\n  app.submitBtn.hide();\n  app.cancelSubmitBtn.hide();\n  app.checkBtn.hide();\n  app.cancelChkBtn.hide();\n  app.rejectBtn.hide();\n  app.signBtn.show() ;\n  app.cancelSignBtn.show();\n  app.viewBtn.show();\n  app.accountBtn.hide();\n  \n}else if(opType == 'account'){\n  app.addBtn.hide() ;\n  app.copyBtn.hide() ;\n  app.writeOffBtn.hide();\n  app.delBtn.hide();\n  app.editBtn.hide();\n  app.submitBtn.hide();\n  app.cancelSubmitBtn.hide();\n  app.checkBtn.hide();\n  app.cancelChkBtn.hide();\n  app.rejectBtn.hide();\n  app.viewBtn.show();\n  app.signBtn.hide() ;\n  app.cancelSignBtn.hide();  \n  app.accountBtn.show();\n  \n}else{\n  app.addBtn.show() ;\n  app.copyBtn.show() ;\n  app.writeOffBtn.show();\n  app.delBtn.show();\n  app.editBtn.show();\n  app.submitBtn.show();\n  app.cancelSubmitBtn.show();  \n  app.checkBtn.hide();\n  app.cancelChkBtn.hide();\n  app.rejectBtn.hide();\n  app.viewBtn.hide();\n  app.signBtn.hide() ;\n  app.cancelSignBtn.hide();\n  app.accountBtn.hide();  \n  app.cancelAccountBtn.hide() ;\n}"},"children":[{"configs":{"text":"{#addBtn#}","hidden":"true","itemId":"addBtn","iconCls":"file_add_icon"},"children":[{"configs":{"text":"{#addNormal#}","itemId":"addNormal","iconCls":"accept_icon"},"events":{"click":"// TODO: 调用公共窗口打开金额凭证录入界面\nWb.run({\n  url:'m?xwl=xc/gl/journal/v-windows/new-voucher-win',\n  params : {\n    'vt'      : 'normal',\n    'optype'  : 'add',\n    'method'  : 'list',\n    'ledgerId': app.ledger.getValue(),\n    'srctype' : 'manual'\n  },\n  success:function(appObj){\n    appObj.initWindow({\n      title : '金额凭证录入',\n      ledgerId : app.ledger.getValue(),\n      loadGridData : function(){\n        app.queryBtn.fireEvent('click') ;\n      }\n    });\n  }\n});\n"},"children":[],"expanded":false,"type":"item"},{"configs":{"text":"{#addAmount#}","itemId":"addAmount","iconCls":"accept_icon"},"events":{"click":"// TODO: 调用公共窗口打开数量凭证录入界面\nWb.run({\n  url:'m?xwl=xc/gl/journal/v-windows/new-voucher-win',\n  params : {\n    'vt'      : 'amount',\n    'optype'  : 'add',\n    'method'  : 'list',\n    'ledgerId': app.ledger.getValue(),\n    'srctype' : 'manual'\n  },\n  success:function(appObj){\n    appObj.initWindow({\n      title :'数量凭证录入',\n      ledgerId : app.ledger.getValue(),\n      loadGridData : function(){\n        app.queryBtn.fireEvent('click') ;\n      }\n    });\n  }\n}) ;"},"children":[],"expanded":false,"type":"item"},{"configs":{"text":"{#addForeign#}","itemId":"addForeign","iconCls":"accept_icon"},"events":{"click":"// TODO: 调用公共窗口打开外币凭证录入界面\nWb.run({\n  url:'m?xwl=xc/gl/journal/v-windows/new-voucher-win',\n  params : {\n    'vt'      : 'foreign',\n    'optype'  : 'add',\n    'method'  : 'list',\n    'ledgerId': app.ledger.getValue(),\n    'srctype' : 'manual'\n  },\n  success:function(appObj){\n    appObj.initWindow({\n      title :'外币凭证录入',\n      ledgerId : app.ledger.getValue(),\n      loadGridData : function(){\n        app.queryBtn.fireEvent('click') ;\n      }\n    });\n  }\n}) ;\n\n"},"children":[],"expanded":false,"type":"item"}],"expanded":true,"type":"button"},{"configs":{"text":"{#copyBtn#}","hidden":"true","itemId":"copyBtn","iconCls":"copy_icon"},"events":{"click":"// TODO: 判断所选的凭证信息\nvar records = app.grid4VoucherList.getSelection();\n\nif(records.length === 0){\n  Wb.info(\"请选择一条待复制的凭证!\") ;\n  return false ;\n  \n}else if(records.length > 1){\n  Wb.info(\"系统只支持对单条凭证的复制处理!\");\n  return false ;\n  \n}else{\n  // TODO: 复制单条凭证信息\n  var r = records[0].data ;\n  \n  // TODO: 获取初始化数据\n  var paramJson = getInitVData(r,'copy') ;\n  paramJson.srctype = 'manual' ; // 手工凭证\n    \n  // TODO: 调用公共窗口打开凭证复制界面\n  Wb.run({\n    url:'m?xwl=xc/gl/journal/v-windows/new-voucher-win',\n    params : paramJson,\n    success:function(appObj){\n      appObj.initWindow({\n        title :'凭证复制',\n        ledgerId : app.ledger.getValue(),\n        loadGridData : function(){\n          // 查询凭证信息\n          app.queryBtn.fireEvent('click') ;\n        }\n      });\n    }\n  });\n}"},"children":[],"expanded":false,"type":"button"},{"configs":{"text":"{#editBtn#}","hidden":"true","itemId":"editBtn","iconCls":"file_edit_icon"},"events":{"click":"// TODO: 判断所选的凭证信息\nvar records = app.grid4VoucherList.getSelection();\n\nif(records.length === 0){\n  Wb.info(\"请选择一条待修改的凭证信息!\") ;\n  return false ;\n  \n}else if(records.length > 1){\n  Wb.info(\"系统一次仅支持对单条凭证修改处理!\") ;\n  return false ;\n  \n}else{\n  // TODO: 判断是否为子模块凭证\n  if(isContainChildV(records)){\n    Wb.info(\"不能修改外部凭证\") ;\n    return false ;\n  }  \n  \n  // TODO: 判断当前凭证是否为未提交状态\n  var r = records[0].data ;\n  var vStatus = r.V_STATUS ;\n  if(vStatus != '1'){\n    Wb.info(\"所选凭证非草稿状态不能修改\") ;\n    return false ;\n  }\n  \n  // TODO: 获取初始化数据\n  var paramJson = getInitVData(r,'modify') ;\n  paramJson.srctype = 'manual' ; // 手工凭证\n  \n  // TODO: 调用公共窗口打开凭证修改界面\n  Wb.run({\n    url:'m?xwl=xc/gl/journal/v-windows/new-voucher-win',\n    params : paramJson,\n    success:function(appObj){\n      appObj.initWindow({\n        title :'凭证修改',\n        ledgerId : app.ledger.getValue(),\n        loadGridData : function(){\n          app.queryBtn.fireEvent('click') ;\n        }\n      });\n    }\n  });  \n}"},"children":[],"expanded":false,"type":"button"},{"configs":{"text":"{#delBtn#}","hidden":"true","itemId":"delBtn","iconCls":"file_delete_icon"},"events":{"click":"// TODO: 获取凭证信息\nvar records = app.grid4VoucherList.getSelection() ;\n\nif(records.length === 0){\n  Wb.info(\"请选择待删除的凭证信息!\") ;\n  return false ;\n}else{\n  // TODO: 判断是否存在子模块凭证\n  if(isContainChildV(records)){\n    Wb.info(\"不能删除外部凭证\") ;\n    return false ;\n  }\n  \n  var headArray = [] ; // 存储余额汇总参数\n  Ext.each(records, function(r){    \n    var vStatus = r.get('V_STATUS') ;\n    if(vStatus === '1'){\n      var headJson = {'V_HEAD_ID':r.get('V_HEAD_ID')} ;\n      headArray.push(headJson) ;\n    }\n  }) ;\n  // TODO: 判断所选的凭证是否存在未提交的凭证信息\n  if(headArray.length === 0){\n    Wb.info(\"所选凭证非草稿状态不能删除\") ;\n    return false ;\n  }else{\n    // TODO: 执行凭证删除处理\n    Wb.confirm('您确定要删除所选凭证吗?',function(){\n      Wb.request({\n        url: '{#ctxPath#}'+'/voucherHandlerAction.do?method=delVouchers',\n        timeout:3600000,\n        params: {\n          'headArray' : Wb.encode(headArray) \n        },\n        success: function(resp) {\n          var response = Wb.decode(resp.responseText) ;\n          if(response.flag === \"0\"){\n            // 加载凭证信息\n            app.queryBtn.fireEvent('click') ;\n            // 提示信息\n            Wb.info(\"凭证信息删除成功!\") ;\n          }else{\n            Wb.info(\"凭证信息删除失败!\") ;\n          }\n        }\n      });    \n    }) ;\n  }\n}"},"children":[],"expanded":false,"type":"button"},{"configs":{"text":"{#writeOffBtn#}","hidden":"true","itemId":"writeOffBtn","iconCls":"undo_icon"},"events":{"click":"// TODO: 判断所选的凭证信息\nvar records = app.grid4VoucherList.getSelection();\n\nif(records.length === 0){\n  Wb.info(\"请选择一条待冲销的凭证信息!\") ;\n  return false ;\n  \n}else if(records.length > 1){\n  Wb.info(\"系统一次仅支持对单条凭证执行冲销处理!\") ;\n  return false ;\n  \n}else{\n  // TODO: 判断当前所选凭证是否入账\n  var r = records[0].data ;\n  var isAccount = r.BOOKKEEPER ;\n  var isWriteOff = r.IS_WRITE_OFF ;\n  \n  if(isAccount === \"\" || isAccount === null || isAccount === undefined){\n    Wb.info(\"所选凭证尚未过账无须冲销!\") ;\n    return false ;\n  }\n  if(isWriteOff !== \"\" && isWriteOff !== null && isWriteOff !== undefined){\n    Wb.info(\"所选凭证已冲销!\") ;\n    return false ;\n  }\n  \n  // TODO: 获取初始化数据\n  var paramJson = getInitVData(r,'write_off') ;\n  \n  // TODO: 调用公共窗口打开凭证冲销处理界面\n  Wb.run({\n    url:'m?xwl=xc/gl/journal/v-windows/new-voucher-win',\n    params : paramJson,\n    success:function(appObj){\n      appObj.initWindow({\n        title :'凭证冲销',\n        loadGridData : function(){\n          app.queryBtn.fireEvent('click') ;\n        }\n      });\n    }\n  });  \n}"},"children":[],"expanded":false,"type":"button"},{"configs":{"text":"{#submitBtn#}","hidden":"true","itemId":"submitBtn","iconCls":"up_icon"},"events":{"click":"// TODO: 判断所选的凭证信息\nvar records = app.grid4VoucherList.getSelection();\n\nif(records.length === 0){\n  Wb.toast(\"请选择待提交审核的凭证信息!\") ;\n  return false ;  \n  \n}else{\n  // TODO: 判断是否为子模块凭证\n  if(isContainChildV(records)){\n    Wb.toast(\"不能提交外部凭证\") ;\n    return false ;\n  }  \n  \n  // TODO: 获取凭证头ID信息\n  var headArray = []  ;\n  Wb.each(records, function(a){\n    var r = a.data ;\n    var vStatus = r.V_STATUS ;    \n    if(vStatus == '1'){\n      var headId = r.V_HEAD_ID ;  \n      var paramJson = {'V_HEAD_ID':headId} ;\n      headArray.push(paramJson) ;\n    }\n  }) ;\n\n  // TODO: 判断凭证是否已提交审核\n  if(headArray.length === 0){\n    Wb.toast(\"所选凭证已审核\") ;\n    return false ;\n  }\n  \n  // TODO: 进度条\n  var msg = Ext.MessageBox.show({\n    title\t:\t'请等待',\n    msg\t\t:\t'正在提交请求，请稍后...',\n    width\t:\t240,\n    wait\t:\ttrue,\n    progress:\ttrue,\n    closable:\tfalse\n  });\n  \n  // TODO: 提交审核\n  Wb.request({\n    url: '{#ctxPath#}'+'/voucherHandlerAction.do?method=submitVouchers',\n    timeout : 3600000,\n    params : {'headArray':Wb.encode(headArray)},\n    success: function(resp) {\n      msg.hide();\n      var response = Wb.decode(resp.responseText) ;\n      var flag = response.flag ; \n      if(flag == '0'){       \n        app.queryBtn.fireEvent('click') ;\n      }\n      Wb.toast(response.msg) ;\n    }\n  });\n}"},"children":[],"expanded":false,"type":"button"},{"configs":{"text":"{#cancelSubmitBtn#}","hidden":"true","itemId":"cancelSubmitBtn","iconCls":"down_icon"},"events":{"click":"// TODO: 判断所选的凭证信息\nvar records = app.grid4VoucherList.getSelection();\n\nif(records.length === 0){\n  Wb.toast(\"请选择待撤销提交的凭证信息!\") ;\n  return false ;  \n  \n}else{\n  // TODO: 判断是否为子模块凭证\n  if(isContainChildV(records)){\n    Wb.toast(\"不能撤回外部凭证的提交处理\") ;\n    return false ;\n  }\n  \n  // TODO: 单条凭证\n  if(records.length === 1){\n    var rr = records[0] ;\n    var _verifier = rr.data.VERIFIER ;  // 审核人\n    if(_verifier !== null && _verifier !== \"\" && _verifier !== undefined){\n      Wb.toast('凭证已审核') ;\n      return false ;\n    }    \n    var _signatory = rr.data.SIGNATORY ;    // 签字人\n    if(_signatory !== null && _signatory !== \"\" && _signatory !== undefined){\n      Wb.toast('凭证已签字') ;\n      return false ;\n    }\n  }\n  \n  // TODO: 获取凭证头ID\n  var headArray = []  ;\n  Wb.each(records, function(a){\n    var r = a.data ;\n    var vStatus = r.V_STATUS ;\n    var verifier = r.VERIFIER ;\n    var sinatory = r.SIGNATORY ;\n    \n    var c1 = (verifier === null || verifier === \"\" || verifier === undefined) ;\n    var c2 = (sinatory === null || sinatory === \"\" || sinatory === undefined) ;\n    \n    //已提交、未审核、未签字\n    if(vStatus == '2' && c1 && c2){ \n      var headId = r.V_HEAD_ID ;  \n      var paramJson = {'V_HEAD_ID':headId} ;\n      headArray.push(paramJson) ;\n    }\n  }) ;\n  \n  // TODO: 判断凭证是否已撤销提交\n  if(headArray.length === 0){\n     Wb.toast(\"所选凭证尚未提交,无须取消提交\") ;\n    return false ;\n  }\n \n  // TODO: 进度条\n  var msg = Ext.MessageBox.show({\n    title\t:\t'请等待',\n    msg\t\t:\t'正在提交请求，请稍后...',\n    width\t:\t240,\n    wait\t:\ttrue,\n    progress:\ttrue,\n    closable:\tfalse\n  });\t\n  \n  // TODO: 撤销审核\n  Wb.request({\n    url: '{#ctxPath#}'+'/voucherHandlerAction.do?method=cancelSubmitVouchers',\n    timeout : 3600000,\n    params : {'headArray':Wb.encode(headArray)},\n    success: function(resp) {\n      msg.hide();\n      var response = Wb.decode(resp.responseText) ;\n      var flag = response.flag ; \n      if(flag == '0'){\n        app.queryBtn.fireEvent('click') ;\n      }\n      Wb.toast(response.msg) ;\n    }\n  });\n}"},"children":[],"expanded":false,"type":"button"},{"configs":{"text":"{#checkBtn#}","hidden":"true","itemId":"checkBtn","iconCls":"check_icon"},"events":{"click":"// TODO: 获取Grid选中记录行\nvar records = app.grid4VoucherList.getSelection() ;\n\n// TODO: 判断是否为子模块凭证\nif(isContainChildV(records)){\n  Wb.toast(\"不能审核外部凭证\") ;\n  return false ;\n}\n\n// TODO: 获取凭证头ID\nvar headArray = [] ;\nWb.each(records , function(r){\n  var headId = r.data.V_HEAD_ID ;  \n  var vs = r.data.V_STATUS ; \n  var verifier = r.data.VERIFIER ;\n  var c1 = (verifier === null || verifier === \"\" || verifier === undefined) ;\n  // 将已提交,未审核\n  if(vs == '2' && c1){ \n    var paramJson = {'V_HEAD_ID': headId} ;\n    headArray.push(paramJson) ;\n  }\n}) ;\n\n// TODO: 提示判断\nif(headArray.length === 0){\n  Wb.toast(\"所选凭证已审核\") ;\n  return false ;\n}\n\n// TODO: 进度条\nvar msg = Ext.MessageBox.show({\n  title\t:\t'请等待',\n  msg\t:\t'正在提交请求，请稍后...',\n  width\t:\t240,\n  wait\t:\ttrue,\n  progress:\ttrue,\n  closable:\tfalse\n});\n\n// TODO: 提交请求执行凭证批量审核处理\nWb.request({\n  url: '{#ctxPath#}'+'/voucherHandlerAction.do?method=checkVouchers' ,\n  timeout : 3600000,\n  params: {'headArray':Wb.encode(headArray)},\n  success: function(resp) {\n    msg.hide();\n    var response = Wb.decode(resp.responseText) ;\n\tif(response.flag == '0'){\n      app.queryBtn.fireEvent('click') ;\n    }\n    Wb.toast(response.msg) ;\n  }\n});"},"children":[],"expanded":false,"type":"button"},{"configs":{"text":"{#cancelChkBtn#}","hidden":"true","itemId":"cancelChkBtn","iconCls":"user_delete_icon"},"events":{"click":"// TODO: 获取Grid选中记录行\nvar records = app.grid4VoucherList.getSelection() ;\n\n// TODO: 判断是否为子模块凭证\nif(isContainChildV(records)){\n  Wb.toast(\"不能取消外部凭证的审核处理\") ;\n  return false ;\n}\n\n// TODO: 单条凭证\nif(records.length === 1){\n  var rr = records[0] ;\n  var _bookkeeper = rr.data.BOOKKEEPER ;  // 记账人\n  if(_bookkeeper !== null && _bookkeeper !== \"\" && _bookkeeper !== undefined){\n    Wb.toast('凭证已记账') ;\n    return false ;\n  }    \n}\n\n// TODO: 获取凭证头ID\nvar headArray = [] ;\nWb.each(records , function(r){\n  var headId = r.data.V_HEAD_ID ;  \n  var vs = r.data.V_STATUS ;\n  var verifier = r.data.VERIFIER ; // 审核人\n  var bookkeeper = r.data.BOOKKEEPER ; // 记账人\n  \n  var c1 = (verifier !== null && verifier !== \"\" && verifier !== undefined) ;\n  var c2 = (bookkeeper === null || bookkeeper === \"\" || bookkeeper === undefined) ;\n  \n  // 已提交、已审核和未记账\n  if(vs == '2' && c1 && c2){ \n    var paramJson = {'V_HEAD_ID':headId} ;\n    headArray.push(paramJson) ;\n  }\n}) ;\n\n// TODO: 提示判断\nif(headArray.length === 0){\n  Wb.toast(\"所选凭证未审核\") ;\n  return false ;\n}\n\n// TODO: 进度条\nvar msg = Ext.MessageBox.show({\n  title\t:\t'请等待',\n  msg\t:\t'正在提交请求，请稍后...',\n  width\t:\t240,\n  wait\t:\ttrue,\n  progress:\ttrue,\n  closable:\tfalse\n});\n\n// TODO: 提交请求执行凭证批量弃审处理\nWb.request({\n  url: '{#ctxPath#}'+'/voucherHandlerAction.do?method=uncheckVouchers' ,\n  timeout : 3600000,\n  params: {'headArray':Wb.encode(headArray)},\n  success: function(resp) {\n    msg.hide() ;\n    var response = Wb.decode(resp.responseText) ;\n\tif(response.flag == '0'){\n      app.queryBtn.fireEvent('click') ;\n    }\n    Wb.toast(response.msg) ;\n  }\n});"},"children":[],"expanded":false,"type":"button"},{"configs":{"text":"{#rejectBtn#}","hidden":"true","itemId":"rejectBtn","iconCls":"remove_icon"},"events":{"click":"// TODO: 获取Grid选中记录行\nvar records = app.grid4VoucherList.getSelection() ;\n\n// TODO: 判断是否为子模块凭证\nif(isContainChildV(records)){\n  Wb.toast(\"不能驳回外部凭证\") ;\n  return false ;\n}\n\n// TODO: 单条凭证\nif(records.length === 1){\n  var rr = records[0] ;\n  var _verifier = rr.data.VERIFIER ; // 审核人\n  if(_verifier !== null && _verifier !== \"\" && _verifier !== undefined){\n    Wb.toast('凭证已审核') ;\n    return false ;\n  }    \n  var _signatory = rr.data.SIGNATORY ; // 签字人\n  if(_signatory !== null && _signatory !== \"\" && _signatory !== undefined){\n    Wb.toast('凭证已签字') ;\n    return false ;\n  } \n}\n\n// TODO: 获取凭证头ID\nvar headArray = [] ;\nWb.each(records , function(r){\n  var headId = r.data.V_HEAD_ID ;  // 凭证头ID\n  var verifier = r.data.VERIFIER ; // 审核人\n  var signatory = r.data.SIGNATORY ; // 签字人\n  var vs = r.data.V_STATUS ; \n   \n  var c1 = (verifier === null || verifier === \"\" || verifier === undefined) ;\n  var c2 = (signatory === null || signatory === \"\" || signatory === undefined) ;\n  \n  // 已提交、未审核、未签字\n  if(vs == '2' && c1 && c2){ \n    var paramJson = {'V_HEAD_ID':headId} ;\n    headArray.push(paramJson) ;\n  }\n}) ;\n\n// TODO: 提示判断\nif(headArray.length === 0){\n  Wb.toast(\"所选凭证不符合驳回条件\") ;\n  return false ;\n}\n\n// TODO: 进度条\nvar msg = Ext.MessageBox.show({\n  title\t:\t'请等待',\n  msg\t:\t'正在提交请求，请稍后...',\n  width\t:\t240,\n  wait\t:\ttrue,\n  progress:\ttrue,\n  closable:\tfalse\n});\n\n// TODO: 提交请求执行凭证驳回处理\nWb.confirm('您确定要执行驳回处理吗?',function(){\n  Wb.request({\n    url: '{#ctxPath#}'+'/voucherHandlerAction.do?method=rejectVouchers' ,\n    timeout : 3600000,\n    params: {'headArray':Wb.encode(headArray)},\n    success: function(resp) {\n      msg.hide();\n      var response = Wb.decode(resp.responseText) ;\n      if(response.flag == '0'){\n        app.queryBtn.fireEvent('click') ;\n      }\n      Wb.toast(response.msg) ;\n    }\n  });\n}) ;"},"children":[],"expanded":false,"type":"button"},{"configs":{"text":"{#signBtn#}","hidden":"true","itemId":"signBtn","iconCls":"ok_icon"},"events":{"click":"// TODO: 获取Grid选中记录行\nvar records = app.grid4VoucherList.getSelection() ;\n\n// TODO: 判断是否为子模块凭证\nif(isContainChildV(records)){\n  Wb.toast(\"不能对外部凭证执行签字处理\") ;\n  return false ;\n}\n\n// TODO: 单条凭证\nif(records.length == 1){\n  var rr = records[0] ;\n  var signatory = rr.data.SIGNATORY ; \n  if(signatory !== null && signatory !== \"\" && signatory !== undefined){\n    Wb.toast('凭证已签字') ;\n    return false ;\n  }\n}\n\n// TODO: 获取凭证头ID\nvar headArray = [] ;\nWb.each(records , function(r){\n  var headId = r.data.V_HEAD_ID ;  \n  var is_signed = r.data.IS_SIGNED ; \n  var signatory = r.data.SIGNATORY ; \n  var vs = r.data.V_STATUS ;\n  \n  var c1 = (signatory === null || signatory === \"\" || signatory === undefined) ;\n  \n  // 已提交需要出纳签字,但未签字\n  if(vs == '2' && is_signed == 'Y' && c1){  \n   var paramJson = {'V_HEAD_ID':headId} ;\n   headArray.push(paramJson) ;\n  }\n}) ;\n\n// TODO: 提示判断\nif(headArray.length === 0){\n  Wb.toast(\"所选凭证已签字\") ;\n  return false ;\n}\n\n// TODO: 进度条\nvar msg = Ext.MessageBox.show({\n  title\t:\t'请等待',\n  msg\t\t:\t'正在提交审核请求，请稍后...',\n  width\t:\t240,\n  wait\t:\ttrue,\n  progress:\ttrue,\n  closable:\tfalse\n});\n\n// TODO: 提交请求执行签字处理\nWb.request({\n  url: '{#ctxPath#}'+'/voucherHandlerAction.do?method=signVouchers' ,\n  timeout : 3600000,\n  params: {'headArray':Wb.encode(headArray)},\n  success: function(resp) {\n    msg.hide() ;\n    var response = Wb.decode(resp.responseText) ;\n\tif(response.flag == '0'){\n      app.queryBtn.fireEvent('click') ;\n    }\n\tWb.toast(response.msg) ;\n  }\n});"},"children":[],"expanded":false,"type":"button"},{"configs":{"text":"{#cancelSignBtn#}","hidden":"true","itemId":"cancelSignBtn","iconCls":"delete_icon"},"events":{"click":"// TODO: 获取Grid选中记录行\nvar records = app.grid4VoucherList.getSelection() ;\n\n// TODO: 判断是否为子模块凭证\nif(isContainChildV(records)){\n  Wb.toast(\"不能取消外部凭证的签字处理\") ;\n  return false ;\n}\n\n// TODO: 单条凭证\nif(records.length == 1){\n  var rr = records[0] ;\n  var _signatory = rr.data.SIGNATORY ; \n  if(_signatory === null || _signatory === \"\" || _signatory === undefined){\n    Wb.toast('凭证尚未签字,无须取消') ;\n    return false ;\n  }\n  var _bookkeeper = rr.data.BOOKKEEPER ;\n  if(_bookkeeper !== null && _bookkeeper !== \"\" && _bookkeeper !== undefined){\n    Wb.toast('凭证已记账') ;\n    return false ;\n  }\n}\n\n// TODO: 获取凭证头ID\nvar headArray = [] ;\nWb.each(records , function(r){\n  var headId = r.data.V_HEAD_ID ;  // 凭证头ID\n  var signatory = r.data.SIGNATORY ;\n  var bookkeeper = r.data.BOOKKEEPER ; \n  var vs = r.data.V_STATUS ;\n  \n  var c1 = (bookkeeper === null || bookkeeper === \"\" || bookkeeper === undefined) ;\n  var c2 = (signatory !== null && signatory !== \"\" && signatory !== undefined) ;\n  \n  // 已提交、已签字但未记账\n  if(vs == '2' && c1 && c2){ \n    var paramJson = {'V_HEAD_ID':headId} ;\n     headArray.push(paramJson) ;\n  }\n}) ;\n\n// TODO: 提示判断\nif(headArray.length === 0){\n  Wb.toast(\"所选凭证均不符取消签字条件\") ;\n  return false ;\n}\n\n// TODO: 进度条\nvar msg = Ext.MessageBox.show({\n  title\t:\t'请等待',\n  msg\t:\t'正在提交请求，请稍后...',\n  width\t:\t240,\n  wait\t:\ttrue,\n  progress:\ttrue,\n  closable:\tfalse\n});\n\n// TODO: 提交请求执行签字处理\nWb.request({\n  url: '{#ctxPath#}'+'/voucherHandlerAction.do?method=unsignVouchers' ,\n  timeout : 3600000,\n  params: {'headArray':Wb.encode(headArray)},\n  success: function(resp) {\n    msg.hide() ;\n    var response = Wb.decode(resp.responseText) ;\n\tif(response.flag == '0'){\n      app.queryBtn.fireEvent('click') ;\n    }\n    Wb.toast(response.msg) ;\n  }\n});"},"children":[],"expanded":false,"type":"button"},{"configs":{"text":"{#accountBtn#}","hidden":"true","itemId":"accountBtn","iconCls":"record_edit_icon"},"events":{"click":"// TODO: 获取Grid选中记录行\nvar records = app.grid4VoucherList.getSelection() ;\n\n// TODO: 单条凭证\nif(records.length == 1){\n  var rr = records[0] ;\n  var _verifier = rr.data.VERIFIER ; // 审核人\n  if(_verifier === null || _verifier === \"\" || _verifier === undefined){\n    Wb.toast('凭证未审核') ;\n    return false ;\n  }\n  var isSign = rr.data.IS_SIGNED ;\n  var signatory = rr.data.SIGNATORY ; \n  if(isSign=='Y' && (signatory === null || signatory === \"\" || signatory === undefined)){\n    Wb.toast('凭证未签字') ;\n    return false ;\n  }\n  var bookkeeper = rr.data.BOOKKEEPER ;\n  if(bookkeeper !== null && bookkeeper !== \"\" && bookkeeper !== undefined){\n    Wb.toast('凭证已记账') ;\n    return false ;\n  }\n}\n\n// TODO: 获取凭证头ID\nvar headArray = [] ;\nWb.each(records , function(r){\n  var headId = r.data.V_HEAD_ID ;  // 凭证头ID\n  var vs = r.data.V_STATUS ;\n  var verifier = r.data.VERIFIER ; \n  var isSign = r.data.IS_SIGNED ;\n  var signatory = r.data.SIGNATORY ;\n  var bookkeeper = r.data.BOOKKEEPER ;\n  var paramJson = {'V_HEAD_ID':headId} ;\n  \n  var c1 = (verifier !== null && verifier !== \"\" && verifier !== undefined) ;\n  var c2 = ((isSign=='Y' && (signatory !== null && signatory !== \"\" && signatory !== undefined))|| isSign=='N') ;\n  var c3 = (bookkeeper === null || bookkeeper === \"\" || bookkeeper === undefined) ;\n  if(vs == '2' && c1 && c2 && c3){ // 已提交、已审核、已签字、未记账\n    headArray.push(paramJson) ;\n  }\n}) ;\n\n// TODO: 提示判断\nif(headArray.length === 0){\n  Wb.toast(\"所选凭证已记账\") ;\n  return false ;\n  \n}else{\n  // TODO: 进度条\n  var msg = Ext.MessageBox.show({\n    title\t:\t'请等待',\n    msg\t\t:\t'正在提交审核请求，请稍后...',\n    width\t:\t240,\n    wait\t:\ttrue,\n    progress:\ttrue,\n    closable:\tfalse\n  });\n  \n  // TODO: 提交请求执行记账处理\n  Wb.request({\n    url: '{#ctxPath#}'+'/voucherHandlerAction.do?method=account',\n    timeout : 3600000,\n    params: {'headArray':Wb.encode(headArray)},\n    success: function(resp) {\n      msg.hide() ;\n      var response = Wb.decode(resp.responseText) ;\n      if(response.flag == '0'){\n        app.queryBtn.fireEvent('click') ;\n      }\n      Wb.toast(response.msg) ;\n    }\n  });\n}\n"},"children":[],"expanded":false,"type":"button"},{"configs":{"text":"{#cancelAccountBtn#}","hidden":"true","itemId":"cancelAccountBtn","iconCls":"delete_icon"},"events":{"click":"// 操作类型: record-凭证录入,check-凭证审核，sign-出纳签字,account-记账处理\nvar op = '{#op#}' ;\n\n// 在记账页面按下:【Ctrl+Alt+9】 组合键时触发取消记账处理\nif(op !== 'account'){  \n  return  ;\n}\n\n// TODO: 判断所选的凭证信息\nvar records = app.grid4VoucherList.getSelection();\n\nif(records.length === 0){\n  Wb.toast(\"请选择待取消记账的凭证信息!\") ;\n  return false ;  \n  \n}else{ \n  // TODO: 获取凭证头ID信息\n  var headArray = []  ;\n  Wb.each(records, function(a){\n    var r = a.data ;\n    var vStatus = r.V_STATUS ;\n    var bookkeeper = r.BOOKKEEPER ;\n    var headId = r.V_HEAD_ID ;  \n    if(vStatus == '2' && bookkeeper !== null && bookkeeper !== \"\"　&&　bookkeeper !== undefined){\n      var paramJson = {'V_HEAD_ID':headId} ;\n      headArray.push(paramJson) ;\n    }\n  }) ;\n\n  // TODO: 判断凭证是否已提交审核\n  if(headArray.length === 0){\n    Wb.toast(\"所选凭证尚未记账\") ;\n    return false ;\n  }\n  \n  // TODO: 进度条\n  var msg = Ext.MessageBox.show({\n    title\t:\t'请等待',\n    msg\t\t:\t'正在提交请求，请稍后...',\n    width\t:\t240,\n    wait\t:\ttrue,\n    progress:\ttrue,\n    closable:\tfalse\n  });\n  \n  // TODO: 取消记账\n  Wb.request({\n    url: '{#ctxPath#}'+'/voucherHandlerAction.do?method=cancelAccount',\n    timeout : 3600000,\n    params : {'headArray':Wb.encode(headArray)},\n    success: function(resp) {\n      msg.hide();\n      var response = Wb.decode(resp.responseText) ;\n      var flag = response.flag ; \n      if(flag == '0'){       \n        app.queryBtn.fireEvent('click') ;\n      }\n      Wb.toast(response.msg) ;\n    }\n  });\n}"},"children":[],"expanded":false,"type":"button"},{"configs":{"text":"{#viewBtn#}","hidden":"true","itemId":"viewBtn","iconCls":"grid_icon"},"events":{"click":"// TODO: 判断所选的凭证信息\nvar records = app.grid4VoucherList.getSelection();\n\nif(records.length != 1){\n  if(records.length === 0){\n    Wb.info(\"请选择凭证信息!\") ;\n  }else if(records.length > 1){\n    Wb.info(\"系统仅支持对单条凭证查看处理!\") ;\n  }\n  return false ;\n  \n}else{\n  // TODO: 获取当前选中行记录\n  var r = records[0].data ;\n  var srcCode = r.V_SRC_CODE ;\n  var _isGL ; \n  if(srcCode !== null && srcCode !== \"\") {\n    _isGL = 'N' ;\n  }else{\n    _isGL = 'Y' ;\n  }\n  \n  // TODO: 获取初始化数据\n  var paramJson = getInitVData(r,'view') ;\n  // TODO: 页面处理模式: record-凭证录入,check-凭证审核，sign-出纳签字,account-记账处理\n  var pageMode = '{#op#}' ;\n  \n  // TODO: 调用公共窗口预览凭证信息\n  Wb.run({\n    url:'m?xwl=xc/gl/journal/v-windows/view-voucher-win',\n    params : paramJson,\n    success:function(appObj){\n      appObj.initWindow({\n        title : '凭证查看',\n        ledgerId : app.ledger.getValue(),\n        pageMode : pageMode,\n        isGL  : _isGL,\n        loadVouchers : function(){\n          app.queryBtn.fireEvent('click') ;\n        }\n      });\n    }\n  }); \n}\n\n"},"children":[],"expanded":false,"type":"button"},{"configs":{"text":"{#batchPrintBtn#}","hidden":"true","itemId":"batchPrintBtn","iconCls":"printer_icon"},"events":{"click":"var _rows = app.grid4VoucherList.getSelection();\nif(_rows === null || _rows.length === 0){\n  Wb.info('请选择要打印的凭证！');\n}else if('ALL' === app.templateType.getValue()){\n  Wb.info('请选择要打印的凭证格式');\n}else{\n  app.paperChooseWin.show();\n}"},"children":[],"expanded":false,"type":"button"},{"configs":{"text":"导入","hidden":"true","itemId":"impBtn","iconCls":"db_import_icon"},"events":{"click":"var _width = document.body.clientWidth*(0.5) ;\nvar _height = document.body.clientHeight*(0.7) ;\n\napp.impWin.setWidth(_width) ;\napp.impWin.setHeight(_height) ;\n\napp.impWin.show() ;"},"children":[],"expanded":false,"type":"button"},{"configs":{"text":"导出","hidden":"true","itemId":"expBtn","iconCls":"db_export_icon"},"events":{"click":"var rows = app.grid4VoucherList.getSelection() ;\nif(rows.length > 1){\n  Wb.toast('凭证导出一次只能导出单张凭证或空模板') ;\n  return false ;\n}else{\n  var url ; \n  if(rows.length === 0){\n    url = '{#ctxPath#}/voucherHandlerAction.do?method=expVoucher' ;\n  }else{\n    var r = rows[0] ;\n    var vHeadId = r.data.V_HEAD_ID ;    \n    url = '{#ctxPath#}/voucherHandlerAction.do?method=expVoucher&headId='+vHeadId;\n  } \n  // 执行导出\n  window.location.href = url ;\n}\n"},"children":[],"expanded":false,"type":"button"}],"expanded":true,"type":"toolbar"},{"configs":{"itemId":"columns"},"children":[{"configs":{"text":"{#rownum#}","align":"center","width":"50","xtype":"rownumberer","titleAlign":"center","itemId":"rownum"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#v_period_code#}","width":"100","dataIndex":"PERIOD_CODE","titleAlign":"center","itemId":"v_period_code"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#v_serial_num#}","width":"180","dataIndex":"V_SERIAL_NUM","titleAlign":"center","itemId":"v_serial_num"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#v_summary#}","width":"300","dataIndex":"SUMMARY","titleAlign":"center","itemId":"v_summary"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#v_t_dr#}","hidden":"true","align":"right","width":"150","dataIndex":"T_DR","format":"0,000.00","titleAlign":"center","itemId":"v_t_dr"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#v_t_cr#}","align":"right","width":"150","dataIndex":"T_CR","format":"0,000.00","titleAlign":"center","itemId":"v_t_cr"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#v_status#}","dataIndex":"V_STATUS","titleAlign":"center","itemId":"v_status","renderer":"//1-未草稿，2-已提交\n\nvar v_verifier = record.data.VERIFIER ;       // 审核人\nvar is_signed = record.data.IS_SIGNED ;       // 是否出纳签字\nvar v_signatory = record.data.SIGNATORY ;     // 签字人\nvar v_bookkeeper = record.data.BOOKKEEPER ;   // 记账人\nvar is_write_off = record.data.IS_WRITE_OFF ; // 已冲销\n\nif(value == \"1\"){\n  return '草稿';\n  \n}else if(value == \"2\"){\n  if(v_verifier !== \"\" && v_verifier !== null){\n    if(v_bookkeeper !== \"\" &&　v_bookkeeper !== null){\n      if(is_write_off !== \"\" && is_write_off !== null){\n        return '<font color=red>已冲销<\/font>';\n      }else{\n        return '<font color=red>已记账<\/font>';\n      }\n    }else{\n      return '<font color=red>审核通过<\/font>';\n    }\n  }else{\n\treturn '<font color=red>审核中<\/font>';\n  }\n}else{\n  return value;\n}"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#v_created_by#}","dataIndex":"CREATED_NAME","titleAlign":"center","itemId":"v_created_by"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"会计日期","hidden":"true","dataIndex":"CREATION_DATE","format":"Y-m-d H:i:s","itemId":"v_creation_date"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#v_verifier#}","dataIndex":"VERIFIER","titleAlign":"center","itemId":"v_verifier"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#is_signed#}","hidden":"false","align":"center","width":"100","dataIndex":"IS_SIGNED","titleAlign":"center","itemId":"is_signed","renderer":"if(value == 'Y'){\n  return '是' ;\n}else{\n  return '否' ;\n}"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#v_signatory#}","dataIndex":"SIGNATORY","titleAlign":"center","itemId":"v_signatory"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#v_bookkeeper#}","dataIndex":"BOOKKEEPER","titleAlign":"center","itemId":"v_bookkeeper"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#v_source#}","dataIndex":"V_SRC_CODE","titleAlign":"center","itemId":"v_source"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"凭证头ID","hidden":"true","dataIndex":"V_HEAD_ID","itemId":"v_head_id"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"账簿ID","hidden":"true","dataIndex":"LEDGER_ID","itemId":"ledger_id"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"凭证分类ID","hidden":"true","dataIndex":"V_CATEGORY_ID","itemId":"v_category_id"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"是否被冲销","hidden":"true","dataIndex":"IS_WRITE_OFF","itemId":"is_write_off"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"冲销号","hidden":"true","dataIndex":"WRITE_OFF_NUM","itemId":"write_off_num"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"凭证分类","hidden":"true","dataIndex":"V_TEMPLATE_TYPE","itemId":"v_template_num","renderer":"if(value == '1'){\n  return '金额凭证' ;\n}else if(value == '2'){\n  return '数量凭证' ;\n}else if(value == '2'){\n  return '外币凭证' ;\n}else{\n  return value ;\n}"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"附件个数","hidden":"true","dataIndex":"V_ATTCH_TOTAL","itemId":"v_attch_total"},"children":[],"expanded":false,"type":"column"}],"expanded":true,"type":"array"}],"expanded":true,"type":"grid"}],"expanded":true,"type":"viewport"}],"expanded":true,"type":"module"}],"pageLink":"","iconCls":"grid_icon"}