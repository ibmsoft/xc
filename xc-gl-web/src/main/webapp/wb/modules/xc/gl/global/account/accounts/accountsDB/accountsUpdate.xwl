{"inframe":false,"title":"科目更新","hidden":false,"roles":{"default":1},"children":[{"configs":{"loginRequired":"false","serverScript":"var id,ids = [],\nrecsInsert = Wb.decode(request.getParameter('create'));\nvar ASS_KEY = request.getParameter('ASS_KEY');\nWb.each(recsInsert,function(rec){\n    app.run(\"select 1 from xc_gl_accounts where ACC_CODE='\" + rec.ACC_CODE.replace(\"'\",\"\\\\'\") + \"' and ACC_HRCY_ID='\"+rec.ACC_HRCY_ID+\"'\",{\n        errorText: '编码\"' + rec.ACC_CODE + '\" 已经存在。'\n    });\n//     app.run(\"select 1 from xc_gl_accounts where ACC_NAME='\" + rec.ACC_NAME.replace(\"'\",\"\\\\'\") + \"' and ACC_HRCY_ID='\"+rec.ACC_HRCY_ID+\"'\",{\n//         errorText: '编码名称\"' + rec.ACC_NAME + '\" 已经存在。'\n//     });\n    app.run(\"UPDATE xc_gl_accounts SET IS_LEAF = 'N' WHERE ACC_CODE ='\" + rec.ACC_CODE.substring(0,rec.ACC_CODE.length-2) + \"' and ACC_HRCY_ID='\"+rec.ACC_HRCY_ID+\"'\",{});\n\tWb.apply(rec,{\n        ACC_LEVEL: ((rec.ACC_CODE.length - 4) / 2 + 1),\n        ASS_KEY: ASS_KEY,\n        CREATION_DATE : new Date(),\n        CREATED_BY : '{#XIP.userId#}',\n        LAST_UPDATE_DATE : new Date(),\n        LAST_UPDATED_BY : '{#XIP.userId#}',\n        UP_ACC_CODE : ((rec.ACC_CODE.length > 4) ? rec.ACC_CODE.substring(0,rec.ACC_CODE.length-2) : '-1'),\n        IS_LEAF : 'Y'\n    });\n});\nrecsUpdate = Wb.decode(request.getParameter('update'));\nWb.each(recsUpdate,function(rec){\n    app.run(\"select 1 from xc_gl_accounts where ACC_CODE='\" + rec.ACC_CODE.replace(\"'\",\"\\\\'\") + \"'and ACC_ID <> '\" + rec.ACC_ID+\"' and ACC_HRCY_ID='\"+rec.ACC_HRCY_ID+\"'\",{\n        errorText: '编码\"' + rec.ACC_CODE + '\" 已经存在。'\n    });\n//     app.run(\"select 1 from xc_gl_accounts where ACC_NAME='\" + rec.ACC_NAME.replace(\"'\",\"\\\\'\") + \"'and ACC_ID <> '\" + rec.ACC_ID+\"' and ACC_HRCY_ID='\"+rec.ACC_HRCY_ID+\"'\",{\n//         errorText: '编码名称\"' + rec.ACC_NAME + '\" 已经存在。'\n//     });\n    app.run(\"UPDATE xc_gl_accounts SET IS_LEAF = 'N' WHERE ACC_CODE ='\" + rec.ACC_CODE.substring(0,rec.ACC_CODE.length-2) + \"' and ACC_HRCY_ID='\"+rec.ACC_HRCY_ID+\"'\",{});\n    rec.ACC_LEVEL = ((rec.ACC_CODE.length - 4) / 2 + 1);\n    rec.UP_ACC_CODE = ((rec.ACC_CODE.length > 4) ? rec.ACC_CODE.substring(0,rec.ACC_CODE.length-2) : '-1'),\n    rec.ASS_KEY = ASS_KEY;\n    rec.LAST_UPDATE_DATE = new Date();\n    rec.LAST_UPDATED_BY = '{#XIP.userId#}';\n});\nrequest.setAttribute('update',Wb.encode(recsUpdate));//重置create记录\nrequest.setAttribute('create',Wb.encode(recsInsert));//重置create记录\napp.update({\n\ttableName: 'xc_gl_accounts'\n});\napp.send(ids);//把id列表发送到客户端以同步到表格\nvar infoArray = request.getParameter(\"infoArray\") ;\nvar array = Wb.decode(infoArray) ;\nvar newArr = Wb.encode(array);\nrequest.setAttribute(\"batArray\",newArr);","itemId":"module"},"children":[{"configs":{"oracle":"UPDATE xc_gl_ld_accounts gla\nSET gla.START_DATE = {?START_DATE?},\ngla.END_DATE = {?END_DATE?},\nLAST_UPDATE_DATE = {?timestamp.sys.date?},\nLAST_UPDATED_BY = {?XIP.userId?}\nWHERE\n\tgla.ACC_ID = {?ACC_ID?}\nAND gla.START_DATE <= (\n\tSELECT\n\t\tga.START_DATE\n\tFROM\n\t\txc_gl_accounts ga\n\tWHERE\n\t\tga.ACC_ID = {?ACC_ID?}\n\tAND ga.START_DATE = TO_DATE({?START_DATE?}, 'yy-MM-dd')\n)\nAND gla.END_DATE >= (\n\tSELECT\n\t\tga.END_DATE\n\tFROM\n\t\txc_gl_accounts ga\n\tWHERE\n\t\tga.ACC_ID = {?ACC_ID?}\n\tAND ga.END_DATE = TO_DATE({?END_DATE?}, 'yy-MM-dd')\n)","itemId":"ld_accountsEditDate","mysql":"UPDATE xc_gl_ld_accounts gla\nSET gla.START_DATE = {?START_DATE?},\ngla.END_DATE = {?END_DATE?},\nLAST_UPDATE_DATE = {?timestamp.sys.date?},\nLAST_UPDATED_BY = {?XIP.userId?}\nWHERE\n\tgla.ACC_ID = {?ACC_ID?}\nAND gla.START_DATE <= (\n\tSELECT\n\t\tga.START_DATE\n\tFROM\n\t\txc_gl_accounts ga\n\tWHERE\n\t\tga.ACC_ID = {?ACC_ID?}\n\tAND ga.START_DATE = DATE_FORMAT({?START_DATE?}, '%Y-%m-%d')\n)\nAND gla.END_DATE >= (\n\tSELECT\n\t\tga.END_DATE\n\tFROM\n\t\txc_gl_accounts ga\n\tWHERE\n\t\tga.ACC_ID = {?ACC_ID?}\n\tAND ga.END_DATE = DATE_FORMAT({?END_DATE?}, '%Y-%m-%d')\n)"},"children":[],"expanded":false,"type":"sqlswitcher"},{"configs":{"sql":"{#ld_accountsEditDate#}","arrayName":"batArray","itemId":"ld_accountsEdit"},"children":[],"expanded":false,"type":"query"}],"expanded":true,"type":"module"}],"pageLink":"","iconCls":""}