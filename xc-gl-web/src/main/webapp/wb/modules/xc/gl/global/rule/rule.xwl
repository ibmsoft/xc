{"inframe":false,"title":"","hidden":false,"roles":{"default":1},"children":[{"configs":{"title":"{#moduleTitle#}","loginRequired":"false","serverScript":"com.xzsoft.xip.platform.util.XipUtil.getCurrentLang(request,\"xc/gl/global/rule/rule\");","itemId":"module"},"events":{"initialize":"var new_val='';\nvar num=-1;\nvar new_val_1 = '';\nvar num_1=-1;\nvar val_code;\n"},"children":[{"configs":{"height":"390","autoScroll":"false","layout":"border","width":"600","closeAction":"hide","border":"false","itemId":"editWindow","dialog":"false","modal":"true","draggable":"false"},"children":[{"configs":{"region":"north","height":"50","layout":"form","border":"false","itemId":"form1"},"children":[{"configs":{"tagConfigs":"baseCls:'my-panel-no-border'","layout":"column","margin":"10 0 0 0 ","border":"false","itemId":"panel1"},"children":[{"configs":{"tagConfigs":"columnWidth:0.48","labelWidth":"{#la_labelWidth#}","readOnly":"true","labelAlign":"right","itemId":"RULE_CODE","fieldLabel":"{#la_ruleTypeCode#}"},"children":[],"expanded":false,"type":"text"},{"configs":{"tagConfigs":"columnWidth:0.48","labelWidth":"100","readOnly":"true","labelAlign":"right","itemId":"RULE_DESC","fieldLabel":"{#la_ruleDescription#}"},"children":[],"expanded":false,"type":"text"}],"expanded":true,"type":"panel"}],"expanded":true,"type":"form"},{"configs":{"region":"center","pagingBar":"false","cls":"my_custom_grid","barPageButton":"false","barExportButtons":"false","barExportAllButtons":"false","itemId":"ruleDtlGrid","editable":"true","viewConfig":"{\n  plugins:{\n\tptype:'gridviewdragdrop',\n  \tdragText:'拖拽以完成排序'\n},\n  listeners : {\n  \tdrop:function(node,data,model){\n      var store = app.ruleDtlGrid.store;\n  \t  for(var i=0;i<store.getCount();i++){\n      \tstore.getAt(i).set(\"ORDERBY\",i+1);\n  }\n      app.showBtn.fireEvent('click');\n    }\n  }\n}"},"children":[{"configs":{"itemId":"store","url":"m?xwl=xc/gl/global/rule/ruleDB/selectRuleDtl"},"events":{"load":"app.showBtn.fireEvent('click');"},"children":[],"expanded":true,"type":"store"},{"configs":{"itemId":"tbar"},"children":[{"configs":{"text":"增加","itemId":"addBtn","iconCls":"file_add_icon"},"events":{"click":"var orderby =app.ruleDtlGrid.store.getCount();\nif(orderby==0){\n  orderby=1;\n}else{\n\torderby = orderby+1;\n}\n\nWb.addEdit(app.ruleDtlGrid,[{RULE_CODE:app.RULE_CODE.getValue(),ORDERBY:orderby,CREATION_DATE:new Date(),CREATED_BY:'{#XIP.userID#}'}]); \n"},"children":[],"expanded":false,"type":"item"},{"configs":{"text":"删除","itemId":"delBtn","iconCls":"file_delete_icon"},"events":{"click":"Wb.remove(app.ruleDtlGrid); //更多选项可使用Wb.add方法\nvar store = app.ruleDtlGrid.store;\n  \t  for(var i=0;i<store.getCount();i++){\n      \tstore.getAt(i).set(\"ORDERBY\",i+1);\n  }\napp.showBtn.fireEvent('click');\n"},"children":[],"expanded":false,"type":"item"}],"expanded":false,"type":"toolbar"},{"configs":{"itemId":"columns"},"children":[{"configs":{"text":"{#rownum#}","hidden":"true","xtype":"rownumberer","width":"50","align":"center","itemId":"column1"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"序号","hidden":"true","width":"50","align":"center","dataIndex":"ORDERBY","titleAlign":"center","itemId":"ORDERBY_COL","renderer":"metaData.style = 'overflow:auto;text-overflow: ellipsis;white-space: nowrap;white-space:normal;line-height:20px;';   \nreturn value;"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"规则分类码","hidden":"true","width":"130","dataIndex":"RULE_CODE","titleAlign":"center","itemId":"RULE_CODE_COL"},"children":[],"expanded":true,"type":"column"},{"configs":{"text":"规则明细ID","hidden":"true","width":"130","dataIndex":"DTL_ID","titleAlign":"center","itemId":"DTL_ID_COL"},"children":[],"expanded":true,"type":"column"},{"configs":{"text":"规则明细编码","hidden":"true","width":"130","dataIndex":"DTL_CODE","titleAlign":"center","itemId":"DTL_CODE_COL"},"children":[],"expanded":true,"type":"column"},{"configs":{"text":"{#la_prefixItem#}","width":"178","dataIndex":"DTL_NAME","titleAlign":"center","itemId":"DTL_NAME_COL"},"children":[{"configs":{"allowBlank":"false","queryMode":"local","displayField":"VAL_NAME","valueField":"VAL_NAME","typeAhead":"false","itemId":"editor","editable":"false"},"events":{"select":"app.showBtn.fireEvent('click');\n","change":"var rec = app.ruleDtlGrid.getSelection()[0];\nnum = app.ruleDtlGrid.store.indexOf(rec);\n\nnew_val= newValue;\nWb.request({\n\turl:'m?xwl=xc/gl/global/rule/ruleDB/selectByValName',\n  \tparams:{'valName':newValue},\n  \tsuccess:function(resp){\n      var record =Wb.decode(resp.responseText);\n      rec.set('DTL_CODE',record.rows[0].VAL_CODE);\n    }\n});\n","focus":"var v_store = app.ruleDtlGrid.store;\nvar records = v_store.getRange(0,v_store.getCount()-1);\nval_code = \"and VAL_CODE not in ('\";\nif(records.length==0){\n  val_code=\"1=1\";\n}\nfor(var i=0;i<records.length;i++){\n  val_code+=records[i].data.DTL_CODE+\"','\";\n  if(i==records.length-1){\n    val_code+=records[i].data.DTL_CODE+\"')\";\n  }\n}\ncombo.store.load({params:{'VAL_CODE':val_code}});\n"},"children":[{"configs":{"itemId":"store","url":"m?xwl=xc/gl/global/rule/ruleDB/selectDtl_code"},"children":[],"expanded":false,"type":"store"}],"expanded":true,"type":"combo"}],"expanded":false,"type":"column"},{"configs":{"text":"{#la_separator#}","width":"150","dataIndex":"DTL_SEPARATOR","titleAlign":"center","itemId":"DTL_SEPARATOR_COL"},"children":[{"configs":{"itemId":"editor"},"events":{"change":"var rec = app.ruleDtlGrid.getSelection()[0];\nnum_1 = app.ruleDtlGrid.store.indexOf(rec);\nnew_val_1= newValue;","blur":"app.showBtn.fireEvent('click');"},"children":[],"expanded":false,"type":"text"}],"expanded":true,"type":"column"},{"configs":{"text":"创建日期","hidden":"true","dataIndex":"CREATION_DATE","itemId":"CREATION_DATE_COL"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"创建人","hidden":"true","dataIndex":"CREATED_BY","itemId":"CREATED_BY_COL"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"最后更新日期","hidden":"true","dataIndex":"LAST_UPDATE_DATE","itemId":"LAST_UPDATE_DATE_COL"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"最后更新人","hidden":"true","dataIndex":"LAST_UPDATED_BY","itemId":"LAST_UPDATED_BY_COL"},"children":[],"expanded":false,"type":"column"}],"expanded":true,"type":"array"}],"expanded":true,"type":"grid"},{"configs":{"region":"south","height":"90","layout":"form","border":"false","itemId":"form11"},"children":[{"configs":{"tagConfigs":"baseCls:'my-panel-no-border'","layout":"column","margin":"10 0 0 0 ","border":"false","itemId":"panel11"},"children":[{"configs":{"tagConfigs":"columnWidth:0.43","labelWidth":"100","allowBlank":"false","queryMode":"local","displayField":"VAL_NAME","valueField":"VAL_CODE","typeAhead":"false","labelAlign":"right","itemId":"SERIAL_CATEGORY","fieldLabel":"{#la_orderDepency#}","editable":"false"},"children":[{"configs":{"itemId":"store","autoLoad":"true","url":"m?xwl=xc/gl/global/rule/ruleDB/selectCategory"},"children":[],"expanded":false,"type":"store"}],"expanded":true,"type":"combo"},{"configs":{"tagConfigs":"regex:/^[1-9]/,\nregexText:'您输入的值有误，请输入正确的数字',\ncolumnWidth:0.25\n","labelWidth":"100","allowBlank":"false","emptyText":"{#la_tip#}","labelAlign":"right","itemId":"SERIAL_LENGTH","fieldLabel":"{#la_digit#}"},"events":{"change":"app.showBtn.fireEvent('click');"},"children":[],"expanded":false,"type":"text"},{"configs":{"tagConfigs":"columnWidth:0.28","labelWidth":"100","labelAlign":"right","itemId":"FIXED_PREFIX","fieldLabel":"{#la_fixedPrefix#}"},"events":{"change":"app.showBtn.fireEvent('click');"},"children":[],"expanded":false,"type":"text"}],"expanded":true,"type":"panel"},{"configs":{"tagConfigs":"baseCls:'my-panel-no-border'","layout":"column","margin":"10 0 10 0","border":"false","itemId":"panel3"},"children":[{"configs":{"tagConfigs":"columnWidth:0.958","labelWidth":"100","readOnly":"true","labelAlign":"right","itemId":"EXAMPLE","fieldLabel":"{#la_example#}"},"children":[],"expanded":false,"type":"text"},{"configs":{"tagConfigs":"border:false","itemId":"showBtn","iconCls":"seek_icon","tooltip":"{#la_seeExample#}"},"events":{"click":"var v_store = app.ruleDtlGrid.store;\nvar dtl_desc =new Array();\nvar dtl_separator = new Array();\nvar fixed = app.FIXED_PREFIX.getValue();\nvar str_length='';\nvar length = parseInt(app.SERIAL_LENGTH.getValue());\nfor(var j=0;j<length-1;j++){\n  str_length = str_length+'0';\n}\nvar example = '';\nfor(var i=0;i<v_store.getCount();i++){\n  var dtl_code = v_store.getAt(i).get('DTL_CODE');\n  \n  dtl_separator[i]=v_store.getAt(i).get('DTL_SEPARATOR');\n  if(num_1!=-1&&num_1==i){\n    dtl_separator[i]=new_val_1;\n  }\n  if(new_val!=''&&num!=-1&&num==i){\n    dtl_code = new_val;\n  }\n  if(dtl_code=='LEDGER'||dtl_code=='账簿'){\n    dtl_desc[i]='00';\n  }else if(dtl_code=='V_CATEGORY'||dtl_code=='凭证分类'){\n   dtl_desc[i]='记';\n  }else if(dtl_code=='YY'||dtl_code=='两位年'){\n    dtl_desc[i] = new Date().getFullYear().toString();\n    dtl_desc[i] = dtl_desc[i].substring(2,4);\n  }else if(dtl_code=='YYYY'||dtl_code=='4位年'){\n     dtl_desc[i]= new Date().getFullYear();\n  }else if(dtl_code=='MM'||dtl_code=='月'){\n     dtl_desc[i] = new Date().getMonth()+1;\n     if(parseInt(dtl_desc[i].toString())<10){\n       dtl_desc[i] = '0'+ dtl_desc[i];\n     }\n     \n  }else if(dtl_code==''){\n  \t dtl_desc[i]='';\n  }\n  //example = example+v_store.getAt(i).get('DTL_SEPARATOR')+dtl_desc[i];\n  example = example+dtl_desc[i]+dtl_separator[i];\n}\nexample = fixed+example+str_length+'1';\napp.EXAMPLE.setValue(example);\n"},"children":[],"expanded":false,"type":"button"}],"expanded":true,"type":"panel"}],"expanded":true,"type":"form"},{"configs":{"itemId":"buttons"},"children":[{"configs":{"text":"{#saveBtn#}","itemId":"saveBtn","iconCls":"save_icon"},"children":[],"expanded":false,"type":"button"}],"expanded":true,"type":"array"}],"expanded":true,"type":"window"},{"configs":{"layout":"fit","itemId":"viewport1"},"children":[{"configs":{"pagingBar":"true","cls":"my_custom_grid","itemId":"ruleGrid"},"events":{"itemdblclick":"app.editBtn.fireEvent('click');"},"children":[{"configs":{"itemId":"tbar"},"children":[{"configs":{"text":"{#editBtn#}","itemId":"editBtn","iconCls":"file_edit_icon"},"events":{"click":"var rec = app.ruleGrid.getSelection()[0];\nif (!rec) {\n  Wb.toast('请选择 1 条需要修改的记录。');\n  return;\n}\nvar win = new Ext.window.Window(app.editWindow); //app._win指向配置对象而非实例\nwin.setIconCls('record_edit_icon');\nWb.setTitle(win, '修改');\nWb.setValue(win, rec.data); //把记录数据应用到窗口\nvar v_rule_code = rec.get('RULE_CODE');\napp.ruleDtlGrid.store.load({params:{'RULE_CODE':v_rule_code}});\nwin.show();\nif(v_rule_code=='ZZ_PZ'){\n  app.SERIAL_CATEGORY.setDisabled(true);\n}else{\n  app.SERIAL_CATEGORY.setDisabled(false);\n}\n//窗口每次动态生成,方法在窗口销毁时自动销毁\nwin.mon(app.saveBtn, 'click', function() {\n  var rules = Wb.getValue(app.editWindow);\n  var ruleDtls = Wb.getData(app.ruleDtlGrid);\n  var deleteRuleDtl = app.ruleDtlGrid.store.getRemovedRecords();\n  Wb.request({\n  \turl:'m?xwl=xc/gl/global/rule/ruleDB/selectDtlId',//查询规则明细\n    async:false,\n    params:{'RULE_CODE':app.RULE_CODE.getValue()},\n    success:function(resp){\n    \tvar rec = Wb.decode(resp.responseText);\n      \tfor(var i=0;i<rec.total;i++){\n          var dtlId = rec.rows[i].DTL_ID;\n          \n        }\n    }\n  });\n  for(var i=0;i<ruleDtls.length;i++){\n    if(ruleDtls[i].DTL_CODE==''){\n      Wb.toast('前缀项为空，不能保存！');\n      return;\n    }\n  }\n  Wb.request({\n    url: 'm?xwl=xc/gl/global/rule/ruleDB/updateRule',//更新规则和规则明细\n    async:false,\n    params: {'rules':Wb.encode(rules),'ruleDtls':Wb.encode(ruleDtls),'deleteRuleDtl':Wb.encode(Wb.getData(deleteRuleDtl))},\n    success: function(resp) {\n      app.ruleGrid.store.load();\n      Wb.toast('保存成功！');\n      win.hide(); //根据closeAction属性，默认为销毁\n    }\n  });\n});\n\n"},"children":[],"expanded":false,"type":"item"}],"expanded":true,"type":"toolbar"},{"configs":{"itemId":"store","autoLoad":"true","url":"m?xwl=xc/gl/global/rule/ruleDB/selectRule"},"children":[],"expanded":false,"type":"store"},{"configs":{"itemId":"columns"},"children":[{"configs":{"text":"{#rownum#}","width":"50","xtype":"rownumberer","align":"center","titleAlign":"center","itemId":"column1"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#la_ruleCode#}","width":"200","dataIndex":"RULE_CODE","titleAlign":"center","itemId":"RULE_CODE_COL","renderer":"metaData.style = 'overflow:auto;text-overflow: ellipsis;white-space: nowrap;white-space:normal;line-height:20px;';   \nreturn value;"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#la_ruleDescription#}","width":"300","dataIndex":"RULE_DESC","titleAlign":"center","itemId":"RULE_DESC_COL"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#la_finance#}","width":"180","dataIndex":"SERIAL_CATEGORY","titleAlign":"center","itemId":"SERIAL_CATEGORY_COL","renderer":"if(value=='LD_YYYY_MM') return '按账簿+年月流水';\nif(value=='LD_YYYY') return '按账簿+年流水';\nif(value=='LD') return '按账簿流水';"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#la_financeLength#}","width":"80","align":"right","dataIndex":"SERIAL_LENGTH","titleAlign":"center","itemId":"SERIAL_LENGTH_COL"},"children":[],"expanded":true,"type":"column"},{"configs":{"text":"创建日期","hidden":"true","dataIndex":"CREATION_DATE","itemId":"CREATION_DATE_COL"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"创建人","hidden":"true","dataIndex":"CREATED_BY","itemId":"CREATED_BY_COL"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"最后更新日期","hidden":"true","dataIndex":"LAST_UPDATE_DATE","itemId":"LAST_UPDATE_DATE_COL"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"最后更新人","hidden":"true","dataIndex":"LAST_UPDATED_BY","itemId":"LAST_UPDATED_BY_COL"},"children":[],"expanded":false,"type":"column"}],"expanded":true,"type":"array"}],"expanded":true,"type":"grid"}],"expanded":true,"type":"viewport"}],"expanded":true,"type":"module"}],"pageLink":"","iconCls":""}