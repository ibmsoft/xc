{"inframe":false,"title":"","hidden":false,"roles":{"default":1},"children":[{"configs":{"title":"{#moduleTitle#}","loginRequired":"false","serverScript":"com.xzsoft.xip.platform.util.XipUtil.getCurrentLang(request,\"xc/gl/global/product/XC_GL_GB_PRODUCT\");\nrequest.setAttribute('contextPath',request.getContextPath());","itemId":"module"},"children":[{"configs":{"itemId":"windows"},"children":[{"configs":{"maximized":"true","title":"{#importTitle#}","height":"400","minimizable":"true","width":"750","layout":"border","dialog":"false","border":"false","itemId":"importDataWin","modal":"true","maximizable":"true","createInstance":"false"},"events":{"close":"app.queryBtn.fireEvent('click');"},"children":[{"configs":{"region":"center","frame":"true","style":"border-width:0px","layout":"column","padding":"15 0 0 5","border":"false","itemId":"importForm"},"children":[{"configs":{"tagConfigs":"columnWidth:.35","labelWidth":"80","allowBlank":"false","emptyText":"{#fileTip#}","labelAlign":"right","itemId":"selectFile","fieldLabel":"{#fileName#}"},"children":[],"expanded":false,"type":"file"},{"configs":{"text":"{#importBtn#}","itemId":"importFile","iconCls":"ok_icon","x":"2"},"events":{"click":"if(!app.importForm.getForm().isValid()){\n  Wb.info('请选择要上传的文件！');\n  return false;\n}\nvar fileType = app.selectFile.getValue();\nif(!Ext.String.endsWith(fileType,'.xls')){\n  Wb.info('请选择以xls结尾的Office Excel文档!',function(){\n    app.importForm.getForm().reset();\n  });\n}else{\n  //导入前，先清除错误数据\n  app.importLogGrid.getStore().removeAll();\n  var msgProcessBar = Ext.Msg.show({\n     title:'提示',\n     msg  :'导入中，请稍后.....',\n     wait :true,\n     width:200\n  });\n  //将Office Excel数据导入到余额临时表中\n  app.importForm.getForm().submit({\n    url:'{#contextPath#}/glDataTransgerManageAction.do?method=importAccountData&templateCode=XC_GL_PRODUCTS',\n    timeout:3600*1000,\n    success:function(form,action){\n      msgProcessBar.hide();\n      Wb.info(action.result.msg,function(){\n        app.importDataWin.close();\n      });\n    },\n    failure:function(form,action){\n      msgProcessBar.hide();\n      var _flag = action.result.flag;\n      //flag =0,导入时发生异常，输出异常信息\n      if(_flag == '0'){\n        Wb.info(action.result.msg);\n      }else if(_flag == '2'){\n       //flag =2,数据导入临时表成功，数据校验发生异常\n        var _sessionId = action.result.msg;\n        Wb.info('导入数据不合法！');\n        app.importLogGrid.getStore().load({params:{'sessionId':_sessionId}});\n      }\n    }   \n  });\n}"},"children":[],"expanded":false,"type":"button"}],"expanded":true,"type":"form"},{"configs":{"region":"south","height":"'88%'","itemId":"southTab"},"children":[{"configs":{"title":"{#importLogs#}","selType":"checkboxmodel","itemId":"importLogGrid"},"children":[{"configs":{"itemId":"columns"},"children":[{"configs":{"text":"{#incorrectColumn#}","width":"70","dataIndex":"ROW_NUM","itemId":"ROW_NUM","renderer":"return '<font color=\"red\">'+value+'<\/font>';"},"children":[],"expanded":true,"type":"column"},{"configs":{"text":"{#productCode#}","width":"150","dataIndex":"PRODUCT_CODE","itemId":"PRODUCT_CODE"},"children":[],"expanded":true,"type":"column"},{"configs":{"text":"{#productName#}","width":"200","dataIndex":"PRODUCT_NAME","itemId":"PRODUCT_NAME"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#startDate#}","width":"150","dataIndex":"START_DATE","itemId":"START_DATE"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#endDate#}","width":"150","dataIndex":"END_DATE","itemId":"END_DATE"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#errorInformation#}","width":"300","dataIndex":"ERROR_MSG","itemId":"E_MSG","renderer":"metaData.style = 'overflow:auto;padding: 3px 6px;text-overflow: ellipsis;white-space: nowrap;white-space:normal;line-height:15px;';   \nreturn '<font color=\"red\">'+value+'<\/font>';","flex":"1"},"children":[],"expanded":false,"type":"column"}],"expanded":true,"type":"array"},{"configs":{"pageSize":"-1","autoLoad":"true","itemId":"store","url":"m?xwl=xc/gl/global/product/DB/getInvalidProduct"},"children":[],"expanded":false,"type":"store"}],"expanded":true,"type":"grid"}],"expanded":true,"type":"tab"}],"expanded":true,"type":"window"},{"configs":{"title":"{#batchEdit#}","height":"150","frame":"true","closable":"true","width":"320","resizable":"false","buttonAlign":"center","itemId":"win","modal":"true"},"children":[{"configs":{"tagConfigs":"baseCls : 'my-panel-no-border'","layout":"column","margin":"10 10 10 10","border":"false","itemId":"panel1"},"children":[{"configs":{"value":"true","itemId":"start_date_check"},"events":{"change":"if(newValue){ \n  app.start_date.setReadOnly(false);\n  app.start_date.allowBlank = false;\n}else{\n  app.start_date.allowBlank = true;\n  app.start_date.setReadOnly(true);\n}\napp.start_date.reset();"},"children":[],"expanded":false,"type":"check"},{"configs":{"labelWidth":"80","labelAlign":"right","itemId":"start_date","fieldLabel":"{#startDate#}"},"children":[],"expanded":false,"type":"date"}],"expanded":true,"type":"panel"},{"configs":{"tagConfigs":"baseCls : 'my-panel-no-border'","layout":"column","margin":"10 10 10 10","border":"false","itemId":"panel2"},"children":[{"configs":{"value":"true","itemId":"end_date_check"},"events":{"change":"if(newValue){ \n  app.end_date.setReadOnly(false);\n}else{\n  app.end_date.setReadOnly(true);\n}\napp.end_date.reset();"},"children":[],"expanded":false,"type":"check"},{"configs":{"labelWidth":"80","labelAlign":"right","itemId":"end_date","fieldLabel":"{#endDate#}"},"children":[],"expanded":false,"type":"date"}],"expanded":true,"type":"panel"},{"configs":{"itemId":"buttons"},"children":[{"configs":{"text":"{#confirmBtn#}","itemId":"confirmBtn","iconCls":"ok_icon"},"events":{"click":"var recs = app.grid1.getSelection();\nvar start_date_check=app.start_date_check.getValue();\nvar end_date_check=app.end_date_check.getValue();\nvar start_date=app.start_date.getValue();\nvar end_date=app.end_date.getValue();\nvar news='';\n//验证日期是否合法\nif(start_date_check){//修改开始日期\n  if(end_date_check){//修改结束日期\n    if(end_date===null){\n      end_date=Ext.Date.parse('9999-12-31','Y-m-d');\n    }\n    if(start_date>=end_date){\n      news='开始日期必须小于结束日期！';\n    }\n  }else{//不修改结束日期\n    for(var i=0;i<recs.length;i++){\n      if(start_date>=recs[i].data.END_DATE){\n        news='开始日期必须小于所选记录的结束日期！';\n      }\n    }\n  }\n}else{//不修改开始日期\n  if(end_date_check){//修改结束日期\n    if(end_date===null){\n      end_date=Ext.Date.parse('9999-12-31','Y-m-d');\n    }else{\n      for(var i=0;i<recs.length;i++){\n        if(end_date<=recs[i].data.START_DATE){\n          news='结束日期必须大于所选记录的开始日期！';\n        }\n      }\n    }\n  }else{//不修改结束日期\n    return;\n  }\n}\nif(news!==''){\n  Wb.toast(news);\n  return;\n}\n//请求修改\nWb.request({\n  url:'m?xwl=xc/gl/global/product/DB/update',\n  async:false,\n  params:{datas:Wb.getData(recs),start_date:start_date,end_date:end_date},\n  success:function(resp){\n    app.queryBtn.fireEvent('click');\n    Wb.toast('修改成功！');\n    //数据缓存\n    Wb.request({\n      url:'m?xwl=xc/common/sync-redis',\n      params:{type:'shared',segCode:'XC_GL_PRODUCTS'}\n    });\n  },\n  failure:function(resp){\n    Wb.toast('修改失败！');\n  }\n});\nwin.close();"},"children":[],"expanded":false,"type":"button"},{"configs":{"text":"{#cancelBtn#}","itemId":"cancelBtn","iconCls":"cancel_icon"},"events":{"click":"app.win.close();"},"children":[],"expanded":false,"type":"button"}],"expanded":true,"type":"array"}],"expanded":false,"type":"window"}],"expanded":true,"type":"folder"},{"configs":{"layout":"border","itemId":"viewport1"},"children":[{"configs":{"region":"north","itemId":"form1"},"children":[{"configs":{"layout":"column","padding":"10 10 10 10","border":"false","itemId":"panel1"},"children":[{"configs":{"labelWidth":"{#labelWidth#}","width":"300","emptyText":"{#enterTip#}","labelAlign":"right","itemId":"text1","fieldLabel":"{#codeName#}"},"events":{"specialkey":"if(e.getKey()==13){\n  app.queryBtn.fireEvent('click');\n}"},"children":[],"expanded":false,"type":"text"},{"configs":{"text":"查询","hidden":"true","itemId":"queryBtn","iconCls":"seek_icon","x":"50"},"events":{"click":"app.grid1.store.load({\n  params:{codeOrName:Ext.String.escape(app.text1.getValue())}\n});"},"children":[],"expanded":false,"type":"button"},{"configs":{"text":"重置","hidden":"true","itemId":"resetBtn","iconCls":"refresh_icon","x":"80"},"events":{"click":"app.text1.setValue();\napp.queryBtn.fireEvent('click');"},"children":[],"expanded":false,"type":"button"}],"expanded":true,"type":"panel"}],"expanded":true,"type":"form"},{"configs":{"region":"center","selType":"checkboxmodel","itemId":"grid1","editable":"true"},"children":[{"configs":{"autoLoad":"true","itemId":"store","url":"m?xwl=xc/gl/global/product/DB/select"},"children":[],"expanded":false,"type":"store"},{"configs":{"itemId":"tbar"},"children":[{"configs":{"text":"{#addBtn#}","itemId":"addBtn","iconCls":"file_add_icon"},"events":{"click":"Wb.addEdit(app.grid1,[{START_DATE:Ext.Date.parse('1900-01-01','Y-m-d'),END_DATE:Ext.Date.parse('9999-12-31','Y-m-d')}]);"},"children":[],"expanded":false,"type":"button"},{"configs":{"text":"{#delBtn#}","itemId":"deleteBtn","iconCls":"file_delete_icon"},"events":{"click":"var recs = app.grid1.getSelection();\nvar recs1 = app.grid1.getSelection();//可以删除的记录\nvar recs2 = app.grid1.getSelection();\nif(recs.length<1){\n  Wb.toast('请选择需要删除的记录');\n  return;\n}\nvar ids;\nvar flag = true;//是否有原记录\nvar num2 = 0;\nfor(var i=0;i<recs2.length;i++){\n  //未保存的记录直接删除\n  if(recs2[i].data.PRODUCT_ID==''){\n    app.grid1.getStore().remove(recs2[i]);\n    Ext.Array.remove(recs,recs2[i]);\n    Ext.Array.remove(recs1,recs2[i]);\n  }else{\n    var id = recs2[i].data.PRODUCT_ID;\n    if(num2===0){\n      ids = \"'\"+id+\"'\";\n      num2++;\n    }else{\n      ids = ids+\",\"+\"'\"+id+\"'\";\n    }\n    flag = false;\n  }\n}\n//验证数据是否合法\nif (!Wb.verifyGrid(app.grid1)) \n  return;\nif(flag){return;}\n//验证并删除记录\nWb.request({\n  url:'m?xwl=xc/gl/global/product/DB/validate',\n  params:{ids:ids},\n  success:function(resp){\n    Wb.confirm('是否要删除所选记录？',function(){\n        var data = Wb.decode(resp.responseText);\n        //alert(resp.responseText);\n        var names = '';//不能删除的用户名称\n        var num=0;//计数\n        for(var i=0;i<data.total;i++){\n          var id = data.rows[i].ID;\n          //比对用户是否可以删除\n          for(var j=0;j<recs.length;j++){\n            if(id==recs[j].data.PRODUCT_ID){\n              //记录不可以删除的用户名称\n              if(num===0){\n                names = recs[j].data.PRODUCT_NAME;\n                num=1;\n              }else{\n                names = names+\",\"+recs[j].data.PRODUCT_NAME;\n              }\n               Ext.Array.remove(recs1,recs[j]);//移除不可删除项\n            }\n          }\n        }    \n    for(var a=0;a<recs1.length;a++){\n      Wb.remove(app.grid1,recs1[a]);\n    }\n    app.saveBtn.fireEvent('click');//保存\n    if(names!=''){\n      Wb.toast(names+'已被引用，不可删除');\n    }\n\n    });\n  }\n});\n"},"children":[],"expanded":false,"type":"button"},{"configs":{"text":"{#saveBtn#}","itemId":"saveBtn","iconCls":"save_icon"},"events":{"click":"if (!Wb.verifyGrid(app.grid1)) //验证数据是否合法\n  return;\nWb.sync({\n  grid: app.grid1,\n  url: 'm?xwl=xc/gl/global/product/DB/save',\n  message: '正在保存中...',\n  success: function(resp) {\n    Wb.syncCreate(app.grid1, Wb.decode(resp.responseText));\n    app.queryBtn.fireEvent('click');\n    //数据缓存\n    Wb.request({\n      url:'m?xwl=xc/common/sync-redis',\n      params:{type:'shared',segCode:'XC_GL_PRODUCTS'}\n    });\n  }\n});"},"children":[],"expanded":false,"type":"button"},{"configs":{"text":"{#batchEdit#}","itemId":"lotUpdateBtn","iconCls":"table_edit_icon"},"events":{"click":"var recs = app.grid1.getSelection();\nif (recs.length<1) {\n  Wb.toast('请选择要修改的记录。');\n  return;\n}\nvar win = new Ext.window.Window(app._win); //app._win指向配置对象而非实例\nwin.show();\nwin.setIconCls('checkgroup_icon');\n\n\n\n\n\n\n"},"children":[],"expanded":false,"type":"button"},{"configs":{"text":"{#importBtn#}","itemId":"importBtn","iconCls":"import_icon"},"events":{"click":"var win = new Ext.window.Window(app._importDataWin);\nwin.setTitle('导入产品数据');\nwin.show();"},"children":[],"expanded":false,"type":"button"},{"configs":{"text":"{#exprotBtn#}","itemId":"exportBtn","iconCls":"export_icon"},"events":{"click":"window.location.href = '{#contextPath#}/glDataTransgerManageAction.do?method=exportBaseDataByModel&templateCode=XC_GL_PRODUCTS';"},"children":[],"expanded":false,"type":"button"}],"expanded":true,"type":"toolbar"},{"configs":{"itemId":"columns"},"children":[{"configs":{"text":"{#rownum#}","align":"center","xtype":"rownumberer","width":"50","itemId":"rownum"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"PRODUCT_ID","hidden":"true","align":"left","dataIndex":"PRODUCT_ID","titleAlign":"center","itemId":"PRODUCT_ID_COL"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#productCode#}","align":"left","dataIndex":"PRODUCT_CODE","titleAlign":"center","itemId":"PRODUCT_CODE_COL"},"children":[{"configs":{"allowBlank":"false","itemId":"editor"},"children":[],"expanded":false,"type":"text"}],"expanded":true,"type":"column"},{"configs":{"text":"{#productName#}","width":"300","align":"left","dataIndex":"PRODUCT_NAME","titleAlign":"center","itemId":"PRODUCT_NAME_COL"},"children":[{"configs":{"allowBlank":"false","itemId":"editor"},"children":[],"expanded":false,"type":"text"}],"expanded":true,"type":"column"},{"configs":{"text":"{#startDate#}","align":"left","dataIndex":"START_DATE","titleAlign":"center","itemId":"START_DATE_COL"},"children":[{"configs":{"allowBlank":"false","itemId":"editor","editable":"false"},"events":{"select":"var rec = app.grid1.getSelection()[0];\nif(rec.data.END_DATE!==null&&value>=rec.data.END_DATE){\n  Wb.warn('启用日期必须小于停用日期');\n  this.setValue(null);\n}"},"children":[],"expanded":false,"type":"date"}],"expanded":true,"type":"column"},{"configs":{"text":"{#endDate#}","align":"left","dataIndex":"END_DATE","titleAlign":"center","itemId":"END_DATE_COL","renderer":"if(Ext.util.Format.date(value, 'Y-m-d') == '9999-12-31'){\n  return null;\n}else{\n  return Ext.util.Format.date(value, 'Y-m-d');\n}"},"children":[{"configs":{"itemId":"editor","editable":"false"},"events":{"select":"var rec = app.grid1.getSelection()[0];\nif(rec.data.START_DATE>=value){\n  Wb.warn('停用日期必须大于启用日期');\n  this.setValue(null);\n}\n","focus":"if(Ext.util.Format.date(this.getValue(), 'Y-m-d') == '9999-12-31'){\n  this.setValue('');\n}","blur":"if(Ext.util.Format.date(this.getValue(), 'Y-m-d') == ''){\n  this.setValue(Ext.Date.parse('9999-12-31','Y-m-d'));\n}\n"},"children":[],"expanded":false,"type":"date"}],"expanded":true,"type":"column"}],"expanded":true,"type":"array"}],"expanded":true,"type":"grid"}],"expanded":true,"type":"viewport"}],"expanded":true,"type":"module"}],"pageLink":"","iconCls":""}