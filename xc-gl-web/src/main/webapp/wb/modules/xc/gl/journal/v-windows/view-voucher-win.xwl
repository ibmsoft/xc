{"inframe":false,"title":"凭证查看","hidden":false,"roles":{"default":1},"children":[{"configs":{"title":"凭证查看","loginRequired":"false","serverScript":"//---------------------获取当前模块语言对应的.json文件，放到request中----------------\ncom.xzsoft.xip.platform.util.XipUtil.getCurrentLang(request,\"xc/gl/journal/v-windows/json/view-voucher-win\");\n\nvar ctxPath = request.getContextPath();\nrequest.setAttribute('contextPath',ctxPath);\n// 控制台日志输出对象,调试使用\nvar out = java.lang.System.out ;\n\n// TODO: 获取凭证类型：normal-金额凭证，amount-数量凭证，foreign-外币凭证\nvar vtype = request.getParameter(\"vt\") ;\nrequest.setAttribute(\"vtype\",vtype);\n// TODO: 根据凭证类型生成凭证模板分类: 1-金额式模板,2-金额数量式模板,3-外币金额式模板\nif(vtype == 'normal'){\n  request.setAttribute(\"templateType\",\"1\");\n}else if(vtype == 'amount'){\n  request.setAttribute(\"templateType\",\"2\");\n}else if(vtype == 'foreign'){\n  request.setAttribute(\"templateType\",\"3\");\n}else{\n  request.setAttribute(\"templateType\",\"1\");\n}\n\n// TODO: 获取当前凭证操作类型（add-新增，copy-复制，write_off-冲销，modify-修改，view-查看）\nvar optype = request.getParameter(\"optype\") ;\nrequest.setAttribute(\"optype\",optype) ;\n\n// TODO: 根据凭证操作类型执行数据初始化处理\nvar vheadId = request.getParameter(\"headId\") ;\t// 凭证头ID\nrequest.setAttribute(\"headId\", vheadId) ;\n\n// TODO: 初始化凭证头信息\nif(vheadId !== null && vheadId !== null && vheadId !== undefined){\n  var formJson = com.xzsoft.xc.gl.util.XCGLWebBuilderUtil.viewVoucher(vheadId) ; \n  request.setAttribute(\"formJSON\",formJson) ;\n}\n\n// TODO: 获取当前数据库信息，并存入request对象\nvar dbType = com.xzsoft.xip.platform.util.PlatformUtil.getDbType();\nrequest.setAttribute(\"dbType\",dbType);\nvar la_sessionVars = request.getSession().getAttribute(com.xzsoft.xip.framework.common.SessionVariable.XZ_SESSION_VARS);\nvar la_system_language = la_sessionVars.get(com.xzsoft.xip.framework.common.SessionVariable.language);\nrequest.setAttribute('la_system_language',la_system_language);\n","itemId":"module"},"events":{"initialize":"// TODO: 定义窗口对象\nExt.apply(app,{\n  initWindow:function(params){\n    Ext.apply(app, params);\n    app.newWin.setTitle(params.title);\n    Wb.setValue(app.ledger,{'ledger':params.ledgerId}) ;\n    // 是否为总账进入：Y-总账,N-其他外部系统\n    var isGL = params.isGL;\n    // 操作模式:record-凭证录入,check-凭证审核，sign-出纳签字,account-记账处理\n    var pageMode = params.pageMode ;\n    if(isGL === 'Y'){\n      // 判断按钮\n      if(pageMode === 'check'){ \n        app.checkBtn.show() ;\n        app.uncheckBtn.show() ;\n        app.rejectBtn.show() ; \n      }else if(pageMode === 'sign'){\n        app.signBtn.show() ;\n        app.unsignBtn.show() ;\n      }else if(pageMode === 'account'){\n        app.accountBtn.show() ;\n      }else{\n      }\n    }else{\n      if(pageMode === 'account'){ \n        app.accountBtn.show() ;\n      }\n    }\n    // 设置窗口高度与宽度\n    var _width = params.width ;\n    if(_width === \"\" || _width === null || _width === undefined){\n      _width = document.body.clientWidth*(0.8) ;\n    }\n    var _height = params.height ;\n    if(_height === \"\" || _height === null || _height === undefined){\n      _height = document.body.clientHeight*(0.85) ;\n    }\n    app.newWin.setWidth(_width) ;\n    app.newWin.setHeight(_height) ; \n    \n    app.newWin.show() ;\n  }\n});\n\n// TODO: 增加合计行\nfunction addTotalLine(){\n  Ext.define('lineModel', {  \n      extend: 'Ext.data.Model',  \n      fields: [  \n          {name: 'LINE_ID'},  \n          {name: 'CA_ID'},\n          {name: 'DIM_ID'},\n          {name: 'CCID'},\n          {name: 'SUMMARY'},  \n          {name: 'CCID_FULL_NAME'},  \n          {name: 'AMOUNT'},  \n          {name: 'EXCHANGE_RATE'},  \n          {name: 'ENTER_DR'},  \n          {name: 'ENTER_CR'},  \n          {name: 'ACCOUNT_DR'},  \n          {name: 'ACCOUNT_CR'},\n          {name: 'IS_SUM'}\n       ]  \n  });\n  var r = Ext.create('lineModel', {\n    'LINE_ID':'',\n    'CA_ID':'',\n    'DIM_ID':'',\n    'CCID':'',\n    'SUMMARY':'合计', \n    'CCID_FULL_NAME':'',\n    'AMOUNT': '',\n    'EXCHANGE_RATE':'',\n    'ENTER_DR':'',\n    'ENTER_CR':'',\n    'ACCOUNT_DR':'',\n    'ACCOUNT_CR':'',\n    'IS_SUM':'Y'\n  });\n  var p = app.grid1.store.getCount() ;\n  app.grid1.store.insert(p,r);\n}\n\n// TODO: 增加空科目分录行\nfunction addEntryLines(){\n  Ext.define('lineModel', {  \n      extend: 'Ext.data.Model',  \n      fields: [  \n          {name: 'LINE_ID'},  \n          {name: 'CA_ID'},\n          {name: 'DIM_ID'},\n          {name: 'CCID'},\n          {name: 'SUMMARY'},  \n          {name: 'CCID_FULL_NAME'},  \n          {name: 'AMOUNT'},  \n          {name: 'EXCHANGE_RATE'},  \n          {name: 'ENTER_DR'},  \n          {name: 'ENTER_CR'},  \n          {name: 'ACCOUNT_DR'},  \n          {name: 'ACCOUNT_CR'}\n       ]  \n  });\n  var r = Ext.create('lineModel', {\n    'LINE_ID':'',\n    'CA_ID':'',\n    'DIM_ID':'',\n    'CCID':'',\n    'SUMMARY':'', \n    'CCID_FULL_NAME':'',\n    'AMOUNT': 0,\n    'EXCHANGE_RATE':1,\n    'ENTER_DR':0,\n    'ENTER_CR':0,\n    'ACCOUNT_DR':0,\n    'ACCOUNT_CR':0\n  });\n  var p = app.grid1.store.getCount() ;\n  app.grid1.store.insert(p,r);\n}\n\n// TODO: 金额大写转换函数\nfunction amtTransChinese(num){ \n  var tmpNum = Number(num) ;\n  if(tmpNum < 0){\n    num = Math.abs(num) ;\n  }\n  \n  // 判断是否为数字\n  if (!/^(0|[1-9]\\d*)(\\.\\d{1,2})?$/.test(num)) {\n    num = 0;\n  }\n  \n  var unit = \"仟佰拾亿仟佰拾万仟佰拾元角分\", str = \"\";\n  num += \"00\";\n  var point = num.indexOf('.');\n  if (point >= 0) {\n    num = num.substring(0, point) + num.substr(point + 1, 2);\n  }\n  unit = unit.substr(unit.length - num.length);\n  for (var i = 0; i < num.length; i++) {\n    str += '零壹贰叁肆伍陆柒捌玖'.charAt(num.charAt(i)) + unit.charAt(i);\n  }  \n  var newVal = str.replace(/零(仟|佰|拾|角)/g, \"零\").replace(/(零)+/g, \"零\").replace(/零(万|亿|元)/g, \"$1\").replace(/(亿)万|(拾)/g, \"$1$2\").replace(/^元零?|零分/g, \"\").replace(/元$/g, \"元整\");\n  if(tmpNum <0){\n    newVal = '<font color=red>（负）'+ newVal + '<\/font>' ;\n  }\n  return newVal ;\n}\n\n"},"children":[{"configs":{"maximized":"false","layout":"border","itemId":"newWin","modal":"true","maximizable":"true"},"children":[{"configs":{"region":"north","itemId":"topPanel","border":"false"},"children":[{"configs":{"border":"true","itemId":"toolbar1"},"children":[{"configs":{"text":"{#checkBtn#}","hidden":"true","itemId":"checkBtn","iconCls":"check_icon"},"events":{"click":"// TODO: 凭证头信息\nvar formJson = '{#formJSON#}' ;\nvar headJo = Wb.decode(formJson) ;\n\n// TODO: 是否为外部凭证\nvar srcCode = headJo.v_src_code ;\nif(srcCode !== null && srcCode !== \"\" && srcCode !== undefined){\n  Wb.toast('不能审核外部凭证') ;\n  return false ;\n}\n\n// 审核人\nvar verifier = headJo.v_verifier ;\n// 判断是否已审核\nif(verifier !== null && verifier !== \"\" && verifier !== undefined){\n  Wb.toast('凭证已审核') ;\n  return false ;\n}else{\n  // 凭证头ID\n  var headArray = [] ;\n  var paramJson = {'V_HEAD_ID':headJo.v_head_id} ;\n  headArray.push(paramJson) ;\n  \n  // TODO: 提交请求执行凭证批量审核处理\n  Wb.request({\n    url: '{#contextPath#}'+'/voucherHandlerAction.do?method=checkVouchers' ,\n    params: {'headArray':Wb.encode(headArray)},\n    success: function(resp) {\n      msg.hide();\n      var response = Wb.decode(resp.responseText) ;\n      if(response.flag == '0'){\n        // 加载凭证列表\n        if(typeof app.loadVouchers == 'function'){\n          app.loadVouchers() ;\n        }\n        // 设置审核人\n        app.v_verifier_id.setValue('{#XIP.userId#}') ;\n        app.v_verifier.setValue('{#XIP.empName#}') ;\n      }\n      Wb.toast(response.msg) ;\n    }\n  });\n}"},"children":[],"expanded":false,"type":"button"},{"configs":{"text":"{#uncheckBtn#}","hidden":"true","itemId":"uncheckBtn","iconCls":"user_delete_icon"},"events":{"click":"// TODO: 凭证头信息\nvar formJson = '{#formJSON#}' ;\nvar headJo = Wb.decode(formJson) ;\n\n// TODO: 是否为外部凭证\nvar srcCode = headJo.v_src_code ;\nif(srcCode !== null && srcCode !== \"\" && srcCode !== undefined){\n  Wb.toast('不能取消外部凭证的审核处理') ;\n  return false ;\n}\n\n// 审核人\nvar verifier = headJo.v_verifier ;\n// 判断是否已审核\nif(verifier !== null && verifier !== \"\" && verifier !== undefined){\n  // 凭证头ID\n  var headArray = [] ;\n  var paramJson = {'V_HEAD_ID':headJo.v_head_id} ;\n  headArray.push(paramJson) ;\n  \n  // TODO: 提交请求执行凭证批量弃审处理\n  Wb.request({\n    url: '{#contextPath#}'+'/voucherHandlerAction.do?method=uncheckVouchers' ,\n    params: {'headArray':Wb.encode(headArray)},\n    success: function(resp) {\n      msg.hide() ;\n      var response = Wb.decode(resp.responseText) ;\n      if(response.flag == '0'){\n        // 加载数据\n        if(typeof app.loadVouchers == 'function'){\n          app.loadVouchers() ;\n        }\n        // 设置审核人\n        app.v_verifier_id.setValue() ;\n        app.v_verifier.setValue() ;\n      }\n      Wb.toast(response.msg) ;\n    }\n  });\n  \n}else{\n  Wb.toast('凭证尚未审核,无须取消审核') ;\n  return false ;\n}"},"children":[],"expanded":false,"type":"button"},{"configs":{"text":"{#rejectBtn#}","hidden":"true","itemId":"rejectBtn","iconCls":"remove_icon"},"events":{"click":"// TODO: 凭证头信息\nvar formJson = '{#formJSON#}' ;\nvar headJo = Wb.decode(formJson) ;\n\n// TODO: 是否为外部凭证\nvar srcCode = headJo.v_src_code ;\nif(srcCode !== null && srcCode !== \"\" && srcCode !== undefined){\n  Wb.toast('不能驳回外部凭证') ;\n  return false ;\n}\n\n// 审核人\nvar verifier = headJo.v_verifier ;\n// 判断是否已审核\nif(verifier !== null && verifier !== \"\" && verifier !== undefined){\n  Wb.toast('凭证已审核不能驳回!') ;\n  return false ;\n  \n}else{\n  // 凭证头ID\n  var headArray = [] ;\n  var paramJson = {'V_HEAD_ID':headJo.v_head_id} ;\n  headArray.push(paramJson) ;\n  \n  // TODO: 提交请求执行凭证驳回处理\n  Wb.confirm('您确定要执行驳回处理吗?',function(){\n    Wb.request({\n      url: '{#contextPath#}'+'/voucherHandlerAction.do?method=rejectVouchers' ,\n      params: {'headArray':Wb.encode(headArray)},\n      success: function(resp) {\n        msg.hide();\n        var response = Wb.decode(resp.responseText) ;\n        if(response.flag == '0'){\n          // 加载数据\n          if(typeof app.loadVouchers == 'function'){\n            app.loadVouchers() ;\n          }\n          // 关闭窗口\n          app.newWin.hide() ;\n        }\n        Wb.toast(response.msg) ;\n      }\n    });\n  }) ;\n}"},"children":[],"expanded":false,"type":"button"},{"configs":{"text":"{#signBtn#}","hidden":"true","itemId":"signBtn","iconCls":"ok_icon"},"events":{"click":"// TODO: 凭证头信息\nvar formJson = '{#formJSON#}' ;\nvar headJo = Wb.decode(formJson) ;\n\n// TODO: 是否为外部凭证\nvar srcCode = headJo.v_src_code ;\nif(srcCode !== null && srcCode !== \"\" && srcCode !== undefined){\n  Wb.toast('不能对外部凭证执行签字处理') ;\n  return false ;\n}\n\n// TODO: 是否需要签字\nvar isSign = headJo.v_is_signed ;\nif(isSign !== 'Y'){\n  Wb.toast('当前凭证不需要出纳签字') ;\n  return false ;\n}\n\n// 签字人\nvar signatory = headJo.v_signatory ;\n// 判断是否已签字\nif(signatory !== null && signatory !== \"\" && signatory !== undefined){\n  Wb.toast('凭证已签字') ;\n  return false ;\n  \n}else{\n  // 凭证头ID\n  var headArray = [] ;\n  var paramJson = {'V_HEAD_ID':headJo.v_head_id} ;\n  headArray.push(paramJson) ;  \n  \n  // TODO: 提交请求执行签字处理\n  Wb.request({\n    url: '{#contextPath#}'+'/voucherHandlerAction.do?method=signVouchers' ,\n    params: {'headArray':Wb.encode(headArray)},\n    success: function(resp) {\n      msg.hide() ;\n      var response = Wb.decode(resp.responseText) ;\n      if(response.flag == '0'){\n        // 加载数据\n        if(typeof app.loadVouchers == 'function'){\n          app.loadVouchers() ;\n        }\n        // 设置签字人\n        app.v_signatory_id.setValue('{#XIP.userId#}') ;\n        app.v_signatory.setValue('{#XIP.empName#}') ;\n      }\n      Wb.toast(response.msg) ;\n    }\n  });\n}"},"children":[],"expanded":false,"type":"button"},{"configs":{"text":"{#unsignBtn#}","hidden":"true","itemId":"unsignBtn","iconCls":"delete_icon"},"events":{"click":"// TODO: 凭证头信息\nvar formJson = '{#formJSON#}' ;\nvar headJo = Wb.decode(formJson) ;\n\n// TODO: 是否为外部凭证\nvar srcCode = headJo.v_src_code ;\nif(srcCode !== null && srcCode !== \"\" && srcCode !== undefined){\n  Wb.toast('不能取消外部凭证的签字处理') ;\n  return false ;\n}\n\n// 签字人\nvar signatory = headJo.v_signatory ;\nif(signatory !== null && signatory !== \"\" && signatory !== undefined){\n  // 凭证头ID\n  var headArray = [] ;\n  var paramJson = {'V_HEAD_ID':headJo.v_head_id} ;\n  headArray.push(paramJson) ;  \n  \n  // TODO: 提交请求执行签字处理\n  Wb.request({\n    url: '{#contextPath#}'+'/voucherHandlerAction.do?method=unsignVouchers' ,\n    params: {'headArray':Wb.encode(headArray)},\n    success: function(resp) {\n      msg.hide() ;\n      var response = Wb.decode(resp.responseText) ;\n      if(response.flag == '0'){\n        // 加载数据\n        if(typeof app.loadVouchers == 'function'){\n          app.loadVouchers() ;\n        }\n        // 设置签字人\n        app.v_signatory_id.setValue() ;\n        app.v_signatory.setValue() ;\n      }\n      Wb.toast(response.msg) ;\n    }\n  });\n  \n}else{\n  Wb.toast('凭证尚未签字,无须取消签字') ;\n  return false ;\n}"},"children":[],"expanded":false,"type":"button"},{"configs":{"text":"{#accountBtn#}","hidden":"true","itemId":"accountBtn","iconCls":"record_edit_icon"},"events":{"click":"// TODO: 凭证头信息\nvar formJson = '{#formJSON#}' ;\nvar headJo = Wb.decode(formJson) ;\n// 记账人\nvar bookkeeper = headJo.v_bookkeeper ;\nif(bookkeeper !== null && bookkeeper !== \"\" && bookkeeper !== undefined){\n  Wb.toast('凭证已记账') ;\n  return false ;\n  \n}else{\n  // 凭证头ID\n  var headArray = [] ;\n  var paramJson = {'V_HEAD_ID':headJo.v_head_id} ;\n  headArray.push(paramJson) ;  \n  \n  // TODO: 进度条\n  var msg = Ext.MessageBox.show({\n    title\t:\t'请等待',\n    msg\t\t:\t'正在提交审核请求，请稍后...',\n    width\t:\t240,\n    wait\t:\ttrue,\n    progress:\ttrue,\n    closable:\tfalse\n  });\n  \n  // 执行记账处理\n  Wb.request({\n    url: '{#contextPath#}'+'/voucherHandlerAction.do?method=account',\n    params: {'headArray':Wb.encode(headArray)},\n    success: function(resp) {\n      msg.hide() ;\n      var response = Wb.decode(resp.responseText) ;\n      if(response.flag == '0'){\n        // 加载数据\n        if(typeof app.loadVouchers == 'function'){\n          app.loadVouchers() ;\n        }\n        // 设置记账人\n        app.v_bookkeeper_id.setValue('{#XIP.userId#}') ;\n        app.v_bookkeeper.setValue('{#XIP.empName#}') ;\n      }\n      Wb.toast(response.msg) ;\n    }\n  });\n}"},"children":[],"expanded":false,"type":"button"},{"configs":{"text":"{#printBtn#}","itemId":"printBtn","iconCls":"printer_icon"},"events":{"click":"// TODO: 打印凭证\nvar _headId = app.v_head_id.getValue();\nvar _ledgerId = app.ledger.getValue();\n\n//凭证类型\nvar _voucherType = '{#templateType#}';\n\n// 打印地址\nvar params = '&isFirst=N&ledgerId=' + _ledgerId + '&headerIds='+ _headId+'&language={#la_system_language#}';\nvar url = '{#contextPath#}' + '/ReportServer?reportlet=xc_voucher/voucher_print_cash_t.cpt';\nif (_voucherType == '2') {\n  url = '{#contextPath#}' + '/ReportServer?reportlet=xc_voucher/voucher_print_amount_t.cpt';\n}\nif (_voucherType == '3') {\n  url = '{#contextPath#}' + '/ReportServer?reportlet=xc_voucher/voucher_print_foreign_t.cpt';\n}\nwindow.open(url + params, '_blank');"},"children":[],"expanded":false,"type":"button"},{"configs":{"text":"{#backBtn#}","hidden":"true","itemId":"backBtn","iconCls":"undo_icon"},"events":{"click":"Wb.info('开发中...') ;"},"children":[],"expanded":false,"type":"button"},{"configs":{"text":"{#nextBtn#}","hidden":"true","itemId":"nextBtn","iconCls":"redo_icon"},"events":{"click":"Wb.info('开发中...') ;"},"children":[],"expanded":false,"type":"button"},{"configs":{"hidden":"true","width":"250","labelAlign":"right","itemId":"v_serial_num","fieldLabel":"{#v_serial_num#}"},"children":[],"expanded":false,"type":"text"}],"expanded":true,"type":"toolbar"}],"expanded":true,"type":"panel"},{"configs":{"region":"center","layout":"border","itemId":"mainPanel","border":"false"},"children":[{"configs":{"region":"north","autoScroll":"true","itemId":"form1","border":"false"},"events":{"afterrender":"var fdata = '{#formJSON#}' ;\nvar initdata = Wb.decode(fdata);\nWb.setValue(app.form1,initdata) ;\n\n// TODO: 设置会计日期\nvar accDate = initdata.accountDate ;\napp.accountDate.setValue(Wb.strToDate(accDate));"},"children":[{"configs":{"height":"60","layout":"fit","columnWidth":"1","itemId":"panel1","border":"false"},"children":[{"configs":{"columnWidth":"1","html":"<h2 align='center'><b>凭证<\/b><\/h2>","itemId":"label1"},"children":[],"expanded":false,"type":"label"}],"expanded":false,"type":"panel"},{"configs":{"height":"40","layout":"column","columnWidth":"1","itemId":"panel2","border":"false"},"children":[{"configs":{"layout":"fit","columnWidth":".3","border":"false","itemId":"tr2_1"},"children":[{"configs":{"labelWidth":"80","readOnly":"true","displayField":"NAME","valueField":"ID","labelAlign":"right","itemId":"ledger","fieldLabel":"{#ledger#}"},"events":{"afterrender":"var op = '{#optype#}' ;\nif(op == 'write_off' || op == 'modify'){\n  app.ledger.disable() ;\n}else{\n  app.ledger.enable();\n}","select":"app.ldPeriod.setValue() ;\napp.accountDate.setValue();"},"children":[{"configs":{"autoLoad":"true","itemId":"store","url":"m?xwl=xc/com-qry/gl-ledgers/select-all-ledgers"},"children":[],"expanded":false,"type":"store"}],"expanded":true,"type":"combo"}],"expanded":true,"type":"panel"},{"configs":{"layout":"fit","columnWidth":".2","border":"false","itemId":"tr2_2"},"children":[{"configs":{"labelWidth":"100","readOnly":"true","labelAlign":"right","itemId":"accountDate","fieldLabel":"{#accountDate#}"},"events":{"change":"// TODO: 处理会计期\napp.ldPeriod.setValue() ;\napp.ldPeriod.store.load({\n\tcallback : function(){\t\n        if(app.ldPeriod.store.getCount()>1){\n           app.ldPeriod.setReadOnly(false);\n        }else{\n           app.ldPeriod.setReadOnly(true);\n        }\n        var r = app.ldPeriod.store.first() ;\n        app.ldPeriod.setValue(r.data.CODE) ;\n        app.ldPeriod.setRawValue(r.data.NAME) ;         \n    }\n}) ;"},"children":[],"expanded":false,"type":"date"}],"expanded":true,"type":"panel"},{"configs":{"layout":"fit","columnWidth":".25","border":"false","itemId":"tr2_3"},"children":[{"configs":{"labelWidth":"100","readOnly":"true","displayField":"CODE","valueField":"CODE","labelAlign":"right","itemId":"ldPeriod","fieldLabel":"{#ldPeriod#}","editable":"false"},"children":[{"configs":{"autoLoad":"true","itemId":"store","url":"m?xwl=xc/gl/journal/data-db/new-voucher-data/select-ld-period"},"events":{"beforeload":"store.proxy.extraParams.ledgerId=app.ledger.getValue();\nstore.proxy.extraParams.accDate=app.accountDate.getValue();"},"children":[],"expanded":false,"type":"store"}],"expanded":false,"type":"combo"}],"expanded":true,"type":"panel"},{"configs":{"layout":"fit","columnWidth":".25","border":"false","itemId":"tr2_4"},"children":[{"configs":{"labelWidth":"100","readOnly":"true","value":"0","margin":"0 10 0 0","labelAlign":"right","itemId":"v_attchment_num","fieldLabel":"{#v_attchment_num#}"},"children":[],"expanded":false,"type":"number"}],"expanded":true,"type":"panel"}],"expanded":false,"type":"panel"},{"configs":{"height":"40","layout":"column","columnWidth":"1","itemId":"panel3","border":"false"},"children":[{"configs":{"layout":"fit","columnWidth":".3","border":"false","itemId":"tr3_1"},"children":[{"configs":{"labelWidth":"80","readOnly":"true","displayField":"NAME","valueField":"CODE","labelAlign":"right","itemId":"v_serial_no","fieldLabel":"{#v_serial_no#}","editable":"false"},"children":[{"configs":{"autoLoad":"true","itemId":"store","url":"m?xwl=xc/gl/journal/data-db/new-voucher-data/select-jump-serial-no"},"events":{"load":"// TODO: 处理凭证断号信息\nvar op = '{#optype#}' ;\nif(op == 'add' || op == 'copy' || op == 'write_off'){\n  if(store.getCount()>0){\n    app.v_serial_no.setReadOnly(false) ;\n  }else{\n    app.v_serial_no.setReadOnly(true) ;\n  }\n}","beforeload":"store.proxy.extraParams.ledgerId = app.ledger.getValue() ;"},"children":[],"expanded":false,"type":"store"}],"expanded":false,"type":"combo"}],"expanded":true,"type":"panel"},{"configs":{"layout":"fit","columnWidth":".2","border":"false","itemId":"tr3_2"},"children":[{"configs":{"labelWidth":"100","readOnly":"true","displayField":"NAME","valueField":"ID","labelAlign":"right","itemId":"v_category","fieldLabel":"{#v_category#}"},"children":[{"configs":{"autoLoad":"true","itemId":"store","url":"m?xwl=xc/gl/journal/data-db/common-data/select-v-category"},"events":{"load":"// 凭证标题\nvar catId = app.v_category.getValue() ;\nvar idx = store.find('ID',catId) ;\nvar catName ;\nif(idx == -1){\n  catName = '凭证' ;\n}else{\n  var rr = store.getAt(idx) ;\n  catName = rr.data.CAT_NAME ;  \n}\napp.label1.setText(\"<h2 align='center'><b>\"+catName+\"<\/b><\/h2>\",false) ;\n"},"children":[],"expanded":false,"type":"store"}],"expanded":true,"type":"combo"}],"expanded":true,"type":"panel"},{"configs":{"layout":"fit","columnWidth":".5","border":"false","itemId":"tr3_3"},"children":[{"configs":{"labelWidth":"100","readOnly":"true","margin":"0 10 0 0","labelAlign":"right","itemId":"v_summary","fieldLabel":"{#v_summary#}"},"children":[],"expanded":false,"type":"text"}],"expanded":true,"type":"panel"}],"expanded":false,"type":"panel"},{"configs":{"columnWidth":"1","border":"false","itemId":"hiddenField"},"children":[{"configs":{"labelWidth":"80","readOnly":"true","hidden":"true","width":"150","labelAlign":"right","itemId":"v_head_id","fieldLabel":"凭证头ID"},"children":[],"expanded":false,"type":"text"},{"configs":{"labelWidth":"80","readOnly":"true","hidden":"true","width":"100","labelAlign":"right","itemId":"v_write_off","fieldLabel":"是否被冲销"},"children":[],"expanded":true,"type":"text"},{"configs":{"labelWidth":"90","readOnly":"true","hidden":"true","width":"200","labelAlign":"right","itemId":"v_write_off_num","fieldLabel":"被冲销凭证号"},"children":[],"expanded":false,"type":"text"},{"configs":{"labelWidth":"80","hidden":"true","minValue":"0","width":"200","labelAlign":"right","itemId":"v_total_dr","fieldLabel":"借方合计数"},"children":[],"expanded":false,"type":"number"},{"configs":{"labelWidth":"80","hidden":"true","minValue":"0","width":"200","labelAlign":"right","itemId":"v_total_cr","fieldLabel":"贷方合计数"},"children":[],"expanded":false,"type":"number"},{"configs":{"hidden":"true","itemId":"v_is_signed","fieldLabel":"是否需要出纳签字"},"children":[],"expanded":false,"type":"text"},{"configs":{"hidden":"true","itemId":"v_status","fieldLabel":"凭证状态"},"children":[],"expanded":false,"type":"text"},{"configs":{"hidden":"true","itemId":"v_template_type","fieldLabel":"凭证模板类型"},"children":[],"expanded":false,"type":"text"}],"expanded":false,"type":"panel"}],"expanded":false,"type":"form"},{"configs":{"region":"center","columnLines":"true","pagingBar":"false","cls":"my_custom_grid","enableColumnHide":"true","forceFit":"true","itemId":"grid1","border":"false","viewConfig":"{\n enableTextSelection:true\n}","editable":"false","enableColumnMove":"false"},"events":{"afterrender":"// 加载数据\napp.grid1.getStore().load({\n  params : {'headId':'{#headId#}'}\n}) ;","beforerender":"// TODO: 根据凭证类型动态显示Grid列信息\nvar vtype = '{#vtype#}' ;\n\nif(vtype == 'normal'){\n  \n}else if(vtype == 'amount'){\n  app.v_line_amount.show() ;\n  app.v_dim_name.show() ;\n  \n}else if(vtype == 'foreign'){\n  app.v_exchange_rate.show() ;\n  app.v_cny_name.show() ;\n  app.v_enter_dr.show() ;\n  app.v_enter_cr.show() ;\n  \n}else{\n  \n}"},"children":[{"configs":{"autoLoad":"false","itemId":"store","url":"m?xwl=xc/gl/journal/data-db/new-voucher-data/init-v-lines"},"events":{"load":"  // TODO: 初始化5行空分录\n  var len = 5 - records.length ; \n  for(var i=0; i<len; i++){\n    // 增加科目分录行\n    addEntryLines() ;\n  }\n  // 增加合计行\n  addTotalLine() ;\n\n\n  // 取得合计行\n  var i = store.find('IS_SUM','Y');\n  var r = store.getAt(i) ;\n\n  // 设置原币借方和贷方合计数\n  var t_edr = 0;\n  var t_ecr = 0 ;\n  Wb.each(records, function(rec){\n    var edr = rec.data.ENTER_DR ;\n    if(edr === \"\" || edr === null || edr === undefined){edr = 0 ;}\n    var ecr = rec.data.ENTER_CR ;\n    if(ecr === \"\" || ecr === null || ecr === undefined){ecr = 0 ;}\n    t_edr += edr ;\n    t_ecr += ecr ;\n  }) ;\n  r.set('ENTER_DR', t_edr) ;\n  r.set('ENTER_CR', t_ecr) ;\n\n  // 设置合计行折后借方和贷方合计数 \n  var t_dr = app.v_total_dr.getValue() ;\n  var t_cr = app.v_total_cr.getValue() ;\n  r.set('ACCOUNT_DR', t_dr) ; \n  r.set('ACCOUNT_CR', t_cr) ;\n\n  // TODO: 金额大写转换\n  var cstr = amtTransChinese(t_dr) ;\n  r.set('CCID_FULL_NAME',cstr) ;\n\n  store.commitChanges();\n\n"},"children":[],"expanded":false,"type":"store"},{"configs":{"itemId":"tbar"},"children":[],"expanded":false,"type":"toolbar"},{"configs":{"itemId":"columns"},"children":[{"configs":{"text":"序号","align":"center","xtype":"rownumberer","width":"55","dataIndex":"ORDERBY","titleAlign":"center","itemId":"rownum"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"凭证行ID","hidden":"true","dataIndex":"LINE_ID","itemId":"v_line_id"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"现金流量项目ID","hidden":"true","dataIndex":"CA_ID","itemId":"v_ca_id"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"单位ID","hidden":"true","dataIndex":"DIM_ID","itemId":"v_dim_id"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"科目组合ID","hidden":"true","dataIndex":"CCID","itemId":"v_ccid"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"是否银行或现金科目","hidden":"true","dataIndex":"IS_BC_ACC","itemId":"v_is_bc_acc"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#v_line_summary#}","sortable":"false","width":"250","align":"left","dataIndex":"SUMMARY","titleAlign":"center","itemId":"v_line_summary","renderer":"metaData.style = 'overflow:auto;padding: 3px 6px;text-overflow: ellipsis;white-space: nowrap;white-space:normal;line-height:15px;';   \nreturn value;"},"children":[],"expanded":true,"type":"column"},{"configs":{"text":"{#v_line_account#}","sortable":"false","width":"320","align":"left","dataIndex":"CCID_FULL_NAME","titleAlign":"center","itemId":"v_line_account","renderer":"metaData.style = 'overflow:auto;padding: 3px 6px;text-overflow: ellipsis;white-space: nowrap;white-space:normal;line-height:18px;';   \nreturn value;"},"children":[],"expanded":true,"type":"column"},{"configs":{"text":"{#v_ca_name#}","sortable":"false","width":"180","dataIndex":"CA_NAME","titleAlign":"center","itemId":"v_ca_name","renderer":"metaData.style = 'overflow:auto;padding: 3px 6px;text-overflow: ellipsis;white-space: nowrap;white-space:normal;line-height:45px;';   \nreturn value;"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#v_line_amount#}","hidden":"true","xtype":"numbercolumn","sortable":"false","align":"right","width":"150","dataIndex":"AMOUNT","titleAlign":"center","format":"0,000.0000","itemId":"v_line_amount","renderer":"if(value > 0){\n  return Wb.format(value,'0,000.0000') ;\n}else if(value < 0){\n  return '<font color=red>'+Wb.format(value,'0,000.0000')+'<\/font>' ;\n}else{\n  return '' ;\n}"},"children":[],"expanded":true,"type":"column"},{"configs":{"text":"{#v_dim_name#}","hidden":"true","sortable":"false","align":"center","dataIndex":"DIM_NAME","titleAlign":"center","itemId":"v_dim_name"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#v_exchange_rate#}","hidden":"true","xtype":"numbercolumn","sortable":"false","width":"120","align":"right","dataIndex":"EXCHANGE_RATE","titleAlign":"center","format":"0,000.0000","itemId":"v_exchange_rate","renderer":"if(value < 0){\n  return '<font color=red>'+Wb.format(value,'0,000.0000')+'<\/font>' ;\n}else{\n  return Wb.format(value,'0,000.0000') ;\n}"},"children":[],"expanded":true,"type":"column"},{"configs":{"text":"币种编码","hidden":"true","dataIndex":"CURRENCY_CODE","titleAlign":"center","itemId":"v_line_currency"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#v_cny_name#}","hidden":"true","sortable":"false","align":"center","dataIndex":"CURRENCY_NAME","titleAlign":"center","itemId":"v_cny_name"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#v_enter_dr#}","hidden":"true","xtype":"numbercolumn","sortable":"false","align":"right","width":"150","dataIndex":"ENTER_DR","titleAlign":"center","format":"0,000.00","itemId":"v_enter_dr","renderer":"if(value > 0){\n  return Wb.format(value,'0,000.00') ;\n}else if(value < 0){\n  return '<font color=red>'+Wb.format(value,'0,000.00')+'<\/font>' ;\n}else{\n  return '' ;\n}"},"children":[],"expanded":true,"type":"column"},{"configs":{"text":"{#v_enter_cr#}","hidden":"true","xtype":"numbercolumn","sortable":"false","align":"right","width":"150","dataIndex":"ENTER_CR","titleAlign":"center","format":"0,000.00","itemId":"v_enter_cr","renderer":"if(value > 0){\n  return Wb.format(value,'0,000.00') ;\n}else if(value < 0){\n  return '<font color=red>'+Wb.format(value,'0,000.00')+'<\/font>' ;\n}else{\n  return '' ;\n}"},"children":[],"expanded":true,"type":"column"},{"configs":{"text":"{#v_account_dr#}","xtype":"numbercolumn","sortable":"false","align":"right","width":"150","dataIndex":"ACCOUNT_DR","titleAlign":"center","format":"0,000.00","itemId":"v_account_dr","renderer":"if(value > 0){\n  return Wb.format(value,'0,000.00') ;\n}else if(value < 0){\n  return '<font color=red>'+Wb.format(value,'0,000.00')+'<\/font>' ;\n}else{\n  return '' ;\n}"},"children":[],"expanded":true,"type":"column"},{"configs":{"text":"{#v_account_cr#}","xtype":"numbercolumn","sortable":"false","align":"right","width":"150","dataIndex":"ACCOUNT_CR","titleAlign":"center","format":"0,000.00","itemId":"v_account_cr","renderer":"if(value > 0){\n  return Wb.format(value,'0,000.00') ;\n}else if(value < 0){\n  return '<font color=red>'+Wb.format(value,'0,000.00')+'<\/font>' ;\n}else{\n  return '' ;\n}"},"children":[],"expanded":true,"type":"column"},{"configs":{"text":"预算项目ID","hidden":"true","dataIndex":"BG_ITEM_ID","itemId":"v_bg_item_id"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"成本中心ID","hidden":"true","dataIndex":"DEPT_ID","itemId":"v_dept_id"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"项目ID","hidden":"true","dataIndex":"PROJECT_ID","itemId":"v_project_id"},"children":[],"expanded":false,"type":"column"}],"expanded":true,"type":"array"},{"configs":{"border":"false","itemId":"bbar"},"events":{"afterrender":"var fdata = '{#formJSON#}' ;\nWb.setValue(app.bbar,Wb.decode(fdata)) ;"},"children":[{"configs":{"layout":"fit","columnWidth":".25","border":"false","itemId":"panel1"},"children":[{"configs":{"hidden":"true","itemId":"v_created_by","fieldLabel":"制单人ID"},"children":[],"expanded":false,"type":"text"},{"configs":{"labelWidth":"50","readOnly":"true","labelAlign":"right","itemId":"v_created_name","fieldLabel":"{#v_created_name#}"},"children":[],"expanded":false,"type":"text"}],"expanded":true,"type":"panel"},{"configs":{"layout":"fit","columnWidth":".25","border":"false","itemId":"panel2"},"children":[{"configs":{"hidden":"true","itemId":"v_verifier_id","fieldLabel":"审核人ID"},"children":[],"expanded":false,"type":"text"},{"configs":{"labelWidth":"50","readOnly":"true","labelAlign":"right","itemId":"v_verifier","fieldLabel":"{#v_verifier#}"},"children":[],"expanded":false,"type":"text"}],"expanded":true,"type":"panel"},{"configs":{"layout":"fit","columnWidth":".25","border":"false","itemId":"panel3"},"children":[{"configs":{"hidden":"true","itemId":"v_signatory_id","fieldLabel":"出纳ID"},"children":[],"expanded":false,"type":"text"},{"configs":{"labelWidth":"50","readOnly":"true","labelAlign":"right","itemId":"v_signatory","fieldLabel":"{#v_signatory#}"},"children":[],"expanded":false,"type":"text"}],"expanded":true,"type":"panel"},{"configs":{"layout":"fit","columnWidth":".25","border":"false","itemId":"panel4"},"children":[{"configs":{"hidden":"true","itemId":"v_bookkeeper_id","fieldLabel":"记账人ID"},"children":[],"expanded":false,"type":"text"},{"configs":{"labelWidth":"50","readOnly":"true","labelAlign":"right","itemId":"v_bookkeeper","fieldLabel":"{#v_bookkeeper#}"},"children":[],"expanded":false,"type":"text"}],"expanded":true,"type":"panel"}],"expanded":false,"type":"toolbar"}],"expanded":true,"type":"grid"}],"expanded":true,"type":"panel"}],"expanded":true,"type":"window"}],"expanded":true,"type":"module"}],"pageLink":"","iconCls":"preview_icon"}