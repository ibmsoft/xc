{"inframe":false,"title":"","hidden":false,"roles":{"default":1},"children":[{"configs":{"title":"会计期管理","initScript":"var contextPath = request.getContextPath();\nrequest.setAttribute(\"contextPath\",contextPath);","loginRequired":"false","jsLinks":"[\"platform/util/platformUtil.js\",\"workflow/util/workflowUtil4.0.js\"]","serverScript":"com.xzsoft.xip.platform.util.XipUtil.getCurrentLang(request,\"xc/gl/global/period/period\");","itemId":"module"},"events":{"initialize":"var beforecheckChange;\nvar sm;\nvar code;\nvar sm1;"},"children":[{"configs":{"title":"{#addYearBtn#}","height":"140","width":"450","closeAction":"hide","buttonAlign":"right","defaultFocus":"YEAR","dialog":"true","itemId":"window1","modal":"true","createInstance":"false"},"children":[{"configs":{"tagConfigs":"baseCls : 'my-panel-no-border'","layout":"column","itemId":"panel1"},"children":[{"configs":{"labelWidth":"80","columnWidth":".80","emptyText":"{#yearTip#}","margin":"20 0 0 20 ","labelAlign":"right","itemId":"YEAR","fieldLabel":"{#yearName#}"},"children":[],"expanded":false,"type":"text"}],"expanded":true,"type":"panel"},{"configs":{"itemId":"buttons"},"children":[{"configs":{"text":"{#confirmBtn#}","itemId":"confirmBtn","iconCls":"ok_icon"},"events":{"click":"var values = app.YEAR.getValue();\nif (isNaN(values)) {\n  Wb.warn(\"请输入纯数字！\");\n  app.YEAR.setValue();\n  return false;\n}\nif (values === '') {\n  Wb.warn(\"请输入年度！\");\n  app.YEAR.setValue();\n  return false;\n}\nif (values < 1970 || values > 3000) {\n  Wb.warn(\"您输入的值不合法,请输入在1970到3000年之间的值！\");\n  app.YEAR.setValue();\n  return false;\n}\n//验证是否存在\nWb.request({\n  url: 'm?xwl=xc/gl/global/period/periodDB/validatePeriod',\n  params: {\n    YEAR: values\n  },\n  success: function(resp) {\n    var a = Wb.decode(resp.responseText);\n    if (a.total !== 0) {\n      //存在\n      Wb.toast(\"该年度已经存在,请输入其他的值！\");\n      app.YEAR.setValue();\n      return false;\n    } else {\n      //则执行插入     \n      var year = [];\n      if ((values % 400 === 0) || (values % 4 === 0) && (values % 100 !== 0)) {\n        //闰年\n        //var a={\"pp\":year};\n        var o = {\n          \"PERIOD_CODE\": values + \"-02\",\n          \"YEAR\": values,\n          \"QUARTER\": \"1\",\n          \"START_DATE\": values + \"-02-01\",\n          \"END_DATE\": values + \"-02-29\",\n          \"IS_ADJ_PERIOD\": \"N\",\n          \"IS_ENABLED\": \"1\"\n        };\n        year.push(o);\n      } else {\n        //平年     \n        var o1 = {\n          \"PERIOD_CODE\": values + \"-02\",\n          \"YEAR\": values,\n          \"QUARTER\": \"1\",\n          \"START_DATE\": values + \"-02-01\",\n          \"END_DATE\": values + \"-02-28\",\n          \"IS_ADJ_PERIOD\": \"N\",\n          \"IS_ENABLED\": \"1\"\n        };\n        year.push(o1);\n      }\n      for (var i = 1; i < 13; i++) {\n        //增加1-12月的,不包括2月的\n        //1-10月会记期编码为01等格式\n        if (i === 1 || i === 3) {\n          var m = {\n            \"PERIOD_CODE\": values + \"-0\" + i,\n            \"YEAR\": values,\n            \"QUARTER\": \"1\",\n            \"START_DATE\": values + \"-0\" + i + \"-01\",\n            \"END_DATE\": values + \"-0\" + i + \"-31\",\n            \"IS_ADJ_PERIOD\": \"N\",\n            \"IS_ENABLED\": \"1\"\n          };\n          year.push(m);\n        }\n\n        if (i === 5) {\n          var e = {\n            \"PERIOD_CODE\": values + \"-0\" + i,\n            \"YEAR\": values,\n            \"QUARTER\": \"2\",\n            \"START_DATE\": values + \"-0\" + i + \"-01\",\n            \"END_DATE\": values + \"-0\" + i + \"-31\",\n            \"IS_ADJ_PERIOD\": \"N\",\n            \"IS_ENABLED\": \"1\"\n          };\n          year.push(e);\n        }\n        if (i === 7 || i === 8) {\n          var r = {\n            \"PERIOD_CODE\": values + \"-0\" + i,\n            \"YEAR\": values,\n            \"QUARTER\": \"3\",\n            \"START_DATE\": values + \"-0\" + i + \"-01\",\n            \"END_DATE\": values + \"-0\" + i + \"-31\",\n            \"IS_ADJ_PERIOD\": \"N\",\n            \"IS_ENABLED\": \"1\"\n          };\n          year.push(r);\n        }\n\n        if (i === 9) {\n          var w = {\n            \"PERIOD_CODE\": values + \"-0\" + i,\n            \"YEAR\": values,\n            \"QUARTER\": \"3\",\n            \"START_DATE\": values + \"-0\" + i + \"-01\",\n            \"END_DATE\": values + \"-0\" + i + \"-30\",\n            \"IS_ADJ_PERIOD\": \"N\",\n            \"IS_ENABLED\": \"1\"\n          };\n          year.push(w);\n        }\n\n        if (i === 4 || i === 6) {\n          var y = {\n            \"PERIOD_CODE\": values + \"-0\" + i,\n            \"YEAR\": values,\n            \"QUARTER\": \"2\",\n            \"START_DATE\": values + \"-0\" + i + \"-01\",\n            \"END_DATE\": values + \"-0\" + i + \"-30\",\n            \"IS_ADJ_PERIOD\": \"N\",\n            \"IS_ENABLED\": \"1\"\n          };\n          year.push(y);\n\n        }\n        if (i === 10 || i === 12) {\n          var n = {\n            \"PERIOD_CODE\": values + \"-\" + i,\n            \"YEAR\": values,\n            \"QUARTER\": \"4\",\n            \"START_DATE\": values + \"-\" + i + \"-01\",\n            \"END_DATE\": values + \"-\" + i + \"-31\",\n            \"IS_ADJ_PERIOD\": \"N\",\n            \"IS_ENABLED\": \"1\"\n          };\n          year.push(n);\n        }\n        if (i === 11) {\n          var x = {\n            \"PERIOD_CODE\": values + \"-\" + i,\n            \"YEAR\": values,\n            \"QUARTER\": \"4\",\n            \"START_DATE\": values + \"-\" + i + \"-01\",\n            \"END_DATE\": values + \"-\" + i + \"-30\",\n            \"IS_ADJ_PERIOD\": \"N\",\n            \"IS_ENABLED\": \"1\"\n          };\n          year.push(x);\n        } else {}\n      }\n\n      // 增加四个调整前的\n      var t1 = {\n        \"PERIOD_CODE\": values + \"-Q1\",\n        \"YEAR\": values,\n        \"QUARTER\": \"1\",\n        \"START_DATE\": values + \"-03-31\",\n        \"END_DATE\": values + \"-03-31\",\n        \"IS_ADJ_PERIOD\": \"Y\",\n        \"IS_ENABLED\": \"0\"\n      };\n      year.push(t1);\n      var t2 = {\n        \"PERIOD_CODE\": values + \"-Q2\",\n        \"YEAR\": values,\n        \"QUARTER\": \"2\",\n        \"START_DATE\": values + \"-06-30\",\n        \"END_DATE\": values + \"-06-30\",\n        \"IS_ADJ_PERIOD\": \"Y\",\n        \"IS_ENABLED\": \"0\"\n      };\n      year.push(t2);\n      var t3 = {\n        \"PERIOD_CODE\": values + \"-Q3\",\n        \"YEAR\": values,\n        \"QUARTER\": \"3\",\n        \"START_DATE\": values + \"-09-30\",\n        \"END_DATE\": values + \"-09-30\",\n        \"IS_ADJ_PERIOD\": \"Y\",\n        \"IS_ENABLED\": \"0\"\n      };\n      year.push(t3);\n      var t4 = {\n        \"PERIOD_CODE\": values + \"-Q4\",\n        \"YEAR\": values,\n        \"QUARTER\": \"4\",\n        \"START_DATE\": values + \"-12-31\",\n        \"END_DATE\": values + \"-12-31\",\n        \"IS_ADJ_PERIOD\": \"Y\",\n        \"IS_ENABLED\": \"0\"\n      };\n      year.push(t4);\n      Wb.request({\n        url: 'm?xwl=xc/gl/global/period/periodDB/addPeriod',\n        params: {\n          'datas': year\n        },\n        success: function() {\n          app.window1.hide() ;\n          Wb.toast('增加成功！');\n          app.grid1.store.load({\n            params: {\n              annual: app.annual.getValue()\n            }\n          });\n        }\n      });\n    }\n  }\n\n});"},"children":[],"expanded":false,"type":"button"},{"configs":{"text":"{#cancelBtn#}","itemId":"cancelBtn","iconCls":"cancel_icon"},"events":{"click":"app.window1.close();"},"children":[],"expanded":false,"type":"button"}],"expanded":true,"type":"array"}],"expanded":true,"type":"window"},{"configs":{"layout":"border","itemId":"viewport1"},"children":[{"configs":{"region":"north","layout":"fit","border":"false","itemId":"form1"},"children":[{"configs":{"tagConfigs":"baseCls : 'my-panel-no-border'","layout":"column","margin":"10 0 10 0 ","border":"false","itemId":"panel1"},"children":[{"configs":{"labelWidth":"40","width":"200","margin":"4 0 0 30","labelAlign":"right","itemId":"annual","fieldLabel":"{#yearName#}"},"events":{"afterrender":"if(app.annual.getValue()===null||app.annual.getValue()===''){\n//如果值为空，则要渲染为当前的年份\n  app.annual.setValue(Ext.util.Format.date(new Date(),'Y'));\n}\napp.grid1.store.load(\n  {\n  params:{\n    annual:app.annual.getValue()\n  }\n  }\n);","specialkey":"if(Ext.EventObject.getKey()==13){\napp.grid1.store.load(\n  {\n  params:{\n    annual:app.annual.getValue()\n  }\n  }\n);\n}\n"},"children":[],"expanded":false,"type":"text"},{"configs":{"text":"{#queryBtn#}","width":"70","margin":"4 0 0 4","itemId":"queryBtn","iconCls":"seek_icon"},"events":{"click":"app.grid1.store.load(\n  {\n  params:{\n    annual:app.annual.getValue()\n  }\n  }\n);"},"children":[],"expanded":false,"type":"button"}],"expanded":true,"type":"panel"}],"expanded":true,"type":"form"},{"configs":{"region":"center","pagingBar":"true","multiSelect":"true","itemId":"grid1","editable":"false"},"events":{"tagEvents":"{\n  itemmouseenter:function(view, record, item, index, e, options){\n    app.grid1.getSelectionModel().select(index);\n  }\n}"},"children":[{"configs":{"pageSize":"16","itemId":"store","url":"m?xwl=xc/gl/global/period/periodDB/selectPeriodForYear"},"children":[],"expanded":false,"type":"store"},{"configs":{"itemId":"tbar"},"children":[{"configs":{"text":"{#addYearBtn#}","margin":"0 0 0 5","itemId":"addBtn","iconCls":"file_add_icon"},"events":{"click":"var win = new Ext.window.Window(app.window1); //_window1为配置对象，window1为实例\nwin.show();\nwin.setIconCls('file_add_icon');\n \n\n"},"children":[],"expanded":false,"type":"button"}],"expanded":true,"type":"toolbar"},{"configs":{"itemId":"columns"},"children":[{"configs":{"text":"{#rownum#}","align":"center","width":"50","xtype":"rownumberer","itemId":"rowNumCol"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#accountPeriod#}","align":"left","dataIndex":"PERIOD_CODE","titleAlign":"center","itemId":"periodCodeCol"},"children":[],"expanded":true,"type":"column"},{"configs":{"text":"{#yearName#}","align":"left","width":"60","dataIndex":"YEAR","titleAlign":"center","itemId":"yearCol"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#quarterName#}","align":"left","width":"60","dataIndex":"QUARTER","titleAlign":"center","itemId":"quarterCol"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#startDate#}","align":"left","width":"150","dataIndex":"START_DATE","titleAlign":"center","itemId":"startDateCol"},"children":[],"expanded":true,"type":"column"},{"configs":{"text":"{#endDate#}","align":"left","width":"150","dataIndex":"END_DATE","titleAlign":"center","itemId":"endDateCol"},"children":[],"expanded":true,"type":"column"},{"configs":{"text":"{#adjustPeriod#}","keyName":"enable_flag","align":"left","width":"80","dataIndex":"IS_ADJ_PERIOD","titleAlign":"center","itemId":"isAdjPeriodCol"},"children":[],"expanded":true,"type":"column"},{"configs":{"text":"{#isEnabled#}","xtype":"checkcolumn","align":"center","width":"80","dataIndex":"IS_ENABLED","titleAlign":"center","itemId":"isEnabledCol"},"events":{"checkchange":"sm=app.grid1.getSelectionModel().getSelection();\nif(sm.length!==0){\ncode=sm[0].data.PERIOD_CODE;\nif(beforecheckChange=='1'){\n   Wb.request({\n   params:{\n   PERIOD_CODE:code\n   },\n  url: 'm?xwl=xc/gl/global/period/periodDB/validateIsEnabled',\n  success: function(resp) {\n     var a = Wb.decode(resp.responseText);\n      if(a.total!==0){\n        Wb.toast('已被账簿中使用，无法禁用');\n        app.grid1.store.load(\n  {\n  params:{\n    annual:app.annual.getValue()\n  }\n  }\n);\n      }\n    else{\n      Wb.request({\n        params:{\n       after:'0',\n       PERIOD_CODE:code\n        },\n  url: 'm?xwl=xc/gl/global/period/periodDB/updatePeriod',\n  message: '正在保存中...',\n  success: function(resp) {\n    //ID_FIELD值在后台生成，把返回的ID_FIELD值列表同步到表格中\n             app.grid1.store.load(\n  {\n  params:{\n    annual:app.annual.getValue()\n  }\n  }\n);\n    \n      }\n        }   \n  );\n    }\n      }\n        }   \n      );\n      }\n\nif(beforecheckChange===0){\n Wb.request({\n   params:{\n   after:'1',\n   PERIOD_CODE:code\n   },\n  url: 'm?xwl=xc/gl/global/period/periodDB/updatePeriod',\n  message: '正在保存中...',\n  success: function() {\n          app.grid1.store.load(\n  {\n  params:{\n    annual:app.annual.getValue()\n  }\n  }\n);\n      }\n        }   \n  );\n}\n  }\n  \n","beforecheckchange":"sm1=app.grid1.getSelectionModel().getSelection();\nif(sm1.length!==0){\n  beforecheckChange=sm1[0].data.IS_ENABLED;\nvar code1=sm1[0].data.IS_ADJ_PERIOD;\n  if(code1==='N'){\n    return false;\n  }\n}\n"},"children":[],"expanded":true,"type":"column"}],"expanded":true,"type":"array"}],"expanded":true,"type":"grid"}],"expanded":true,"type":"viewport"}],"expanded":true,"type":"module"}],"pageLink":"","iconCls":""}