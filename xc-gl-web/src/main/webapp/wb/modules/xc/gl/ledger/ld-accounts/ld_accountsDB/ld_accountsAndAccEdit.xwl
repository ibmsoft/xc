{"inframe":false,"title":"账簿科目批量修改","hidden":false,"roles":{"default":1},"children":[{"configs":{"loginRequired":"false","serverScript":"// 判断是否可以修改辅助核算段信息\nvar isUpdatedAss = request.getParameter(\"UPDATE_ASS\") ;\nif(isUpdatedAss == 1){\n  var accId = request.getParameter(\"ACC_ID\") ;\n  var ledgerId = request.getParameter(\"ledgerId\") ;\n  \n  // 判断是否存在未提交凭证信息\n  var vsql = \" select 1 from xc_gl_v_lines xl,xc_gl_ccid gc , xc_gl_v_heads xh \" ;\n  vsql += \" where xl.CCID = gc.CCID and xl.V_HEAD_ID = xh.V_HEAD_ID and xh.LEDGER_ID = gc.LEDGER_ID \" ;\n  vsql += \" and xh.LEDGER_ID = '\" + ledgerId + \"'\" ;\n  vsql += \" and xh.V_STATUS = '1' \" ;\n  vsql += \" and gc.ACC_ID = '\" + accId + \"'\" ;\n  app.run(vsql,{errorText:'所选科目存在未提交凭证,不能修改辅助核算段'})  ;\n  \n  // 科目余额借贷是否平衡\n  var dbType = com.xzsoft.xip.platform.util.PlatformUtil.getDbType() ; // 数据库类型：mysql / oracle\n  // 定义SQL\n  var sql = \"\" ;\n  if(dbType == \"mysql\"){\n    sql = \" SELECT 1 FROM ( \" ;\n    sql += \" select (case IFNULL((SUM(IFNULL(xb.T_PJTD_DR,0))-SUM(IFNULL(xb.T_PJTD_CR,0))),0) when 0 then 0 else 1 end ) as total \" ;\n    sql += \" from xc_gl_balance xb ,xc_gl_ccid gc \" ;\n    sql += \" where xb.CCID = gc.CCID \" ;\n    sql += \" and gc.ACC_ID = '\" + accId + \"'\" ;\n    sql += \" and xb.LEDGER_ID = '\"+ ledgerId + \"'\" ;\n    sql += \" and xb.PERIOD_CODE = (select IFNULL(max(PERIOD_CODE),'1900-01') from xc_gl_ld_period xp \" ;\n    sql += \" where xp.LEDGER_ID = '\" + ledgerId + \"') \" ;\n    sql += \" ) t where total = 1 \" ;\n    \n  }else if(dbType == \"oracle\"){\n    sql = \" SELECT 1 FROM ( \" ;\n    sql += \" select (case nvl((SUM(nvl(xb.T_PJTD_DR,0))-SUM(nvl(xb.T_PJTD_CR,0))),0) when 0 then 0 else 1 end) as total \" ;\n    sql += \" from xc_gl_balance xb ,xc_gl_ccid gc \" ;\n    sql += \" where xb.CCID = gc.CCID \" ;\n    sql += \" and gc.ACC_ID = '\" + accId + \"'\" ;\n    sql += \" and xb.LEDGER_ID = '\"+ ledgerId + \"'\" ;\n    sql += \" and xb.PERIOD_CODE = (select nvl(max(PERIOD_CODE),'1900-01') from xc_gl_ld_period xp \" ;\n    sql += \" where xp.LEDGER_ID = '\" + ledgerId + \"') \" ;\n    sql += \" ) t where total = 1 \" ;\n    \n  }else{\n    sql = \"select 1 from dual \" ;\n  }\n  app.run(sql,{errorText:'所选科目余额借贷不平衡,不能修改辅助核算段'})  ;\n}","itemId":"module"},"children":[{"configs":{"sql":"UPDATE xc_gl_ld_accounts \nSET\n\tEND_DATE = {?END_DATE?},\n    START_DATE = {?START_DATE?},\n\tDIM_ID = {?DIM_ID?},\n\tIS_AMOUNT = {?IS_AMOUNT?},\n\tDEFAULT_CURRENCY = {?DEFAULT_CURRENCY?},\n\tIS_FOREGIN_CNY = {?IS_FOREGIN_CNY?},\n    ACC_SEG_UNION = {?ACC_SEG_UNION?},\n    BG_ITEM_ID = {?BG_ITEM_ID?},\n    LAST_UPDATE_DATE={?timestamp.sys.date?},\n    LAST_UPDATED_BY={?XIP.userId?}\nWHERE LD_ACC_ID = {?LD_ACC_ID?}","itemId":"ld_accounts_edit"},"children":[],"expanded":false,"type":"query"},{"configs":{"sql":"DELETE\nFROM\n\txc_gl_ld_acc_ass_seg\nWHERE\n\tLD_ACC_ID = {?LD_ACC_ID?}\nAND LD_SEG_ID = {?LD_SEG_ID?}","transaction":"start","arrayName":"modifyArray","itemId":"ld_acc_assDelete"},"children":[],"expanded":false,"type":"query"},{"configs":{"sql":"INSERT INTO xc_gl_ld_acc_ass_seg (\n\tLD_ACC_ID,\n\tLD_SEG_ID,\n\tIS_ENABLED,\n    CREATION_DATE,\n    CREATED_BY\n)\nVALUES\n(\n    {?LD_ACC_ID?},\n    {?LD_SEG_ID?},\n    {?IS_ENABLED?},\n    {?timestamp.sys.date?},\n    {?XIP.userId?}\n)","arrayName":"modifyArray","itemId":"ld_acc_assInsert"},"children":[],"expanded":false,"type":"query"},{"configs":{"sql":"DELETE\nFROM\n\txc_gl_ld_acc_ass_seg\nWHERE IS_ENABLED = 0","itemId":"ld_acc_assDeleteIS_ENABLEDIs0"},"children":[],"expanded":false,"type":"query"}],"expanded":true,"type":"module"}],"pageLink":"","iconCls":""}