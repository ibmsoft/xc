{"inframe":false,"title":"资产分类","hidden":false,"roles":{"default":1},"children":[{"configs":{"loginRequired":"false","initScript":"//---------------------获取当前模块语言对应的.json文件，放到request中----------------\ncom.xzsoft.xip.platform.util.XipUtil.getCurrentLang(request,\"xc/fa/base/fa-ccf/fa-ccf\");\n\n\nvar userId = request.getSession().getAttribute(\"XzSessionVars\").get('userId');\nrequest.setAttribute(\"userId\",userId);\nvar ctxPath = request.getContextPath();\nrequest.setAttribute(\"contextPath\",ctxPath);","itemId":"module"},"events":{"initialize":"/**\nname:treeNodeQuery(实现树的模糊查找)\ndesc:根据名称查询节点在树中的位置\nparams:text(节点名称)\nparams:by(依据字段<树查询默认为'text'>)\nparams:treeId(树的ID)\n*/\nfunction treeNodeQuery(text,by,treeId) { \n  if(Ext.isEmpty(by))\n    by = 'text';\n  var menuFunTree = treeId;\n  var code = 'CAT_CODE';\n  menuFunTree.expandAll(function(){\n      var view = menuFunTree.getView(),\n      nodesAndParents = [];\n  menuFunTree.getRootNode().cascadeBy(function(tree, view) {\n        var uiNode = view.getNodeByRecord(this);\n        if (uiNode) {\n            Ext.get(uiNode).setDisplayed('table-row');\n        }\n    }, null, [menuFunTree, view]);\n    //添加匹配的节点和他们的父节点到nodesAndParents数组.\n    menuFunTree.getRootNode().cascadeBy(function(tree, view) {\n      var currNode = this;\n      if (currNode && currNode.data[by] && currNode.data[by].toString().toLowerCase().indexOf(text.toLowerCase()) > -1||(currNode && currNode.data[code] && currNode.data[code].toString().toLowerCase().indexOf(text.toLowerCase()) > -1)) {\n        \n             menuFunTree.expandPath(currNode.getPath());\n             while (currNode.parentNode) {\n                nodesAndParents.push(currNode.id);\n                currNode = currNode.parentNode;\n            }\n        }\n    }, null, [menuFunTree, view]);\n    // 将不在nodesAndParents数组中的节点隐藏\n    // 将根节点放在显示数组中\n    nodesAndParents.push(menuFunTree.getRootNode().id);\n    menuFunTree.getRootNode().cascadeBy(function(tree, view){\n        var uiNode = view.getNodeByRecord(this);\n        if (uiNode && !Ext.Array.contains(nodesAndParents, this.id)) {\n            Ext.get(uiNode).setDisplayed('none');\n        }\n    }, null, [menuFunTree, view]);\n  });\n}\n"},"children":[{"configs":{"itemId":"isLeaf","url":"m?xwl=xc/fa/base/fa-ccf/data/getFaIsLeaf"},"children":[],"expanded":false,"type":"store"},{"configs":{"itemId":"checkRelation","url":"m?xwl=xc/fa/base/fa-ccf/data/checkRelation"},"children":[],"expanded":false,"type":"store"},{"configs":{"itemId":"getDownFa","url":"m?xwl=xc/fa/base/fa-ccf/data/getDownFa"},"children":[],"expanded":false,"type":"store"},{"configs":{"itemId":"getDownFaCode","url":"m?xwl=xc/fa/base/fa-ccf/data/selectDownCatCode"},"children":[],"expanded":false,"type":"store"},{"configs":{"itemId":"getAssetInfo","url":"m?xwl=xc/fa/base/fa-ccf/data/getAssetInfoByCatCode"},"children":[],"expanded":false,"type":"store"},{"configs":{"itemId":"saveStore","url":"m?xwl=xc/fa/base/fa-ccf/data/saveFa"},"children":[],"expanded":false,"type":"store"},{"configs":{"itemId":"updateStore","url":"m?xwl=xc/fa/base/fa-ccf/data/updateFa"},"children":[],"expanded":false,"type":"store"},{"configs":{"title":"{#add#}","height":"220","width":"360","layout":"form","closeAction":"hide","dialog":"true","itemId":"newWin","modal":"true"},"events":{"ok":"// if(Ext.isEmpty(app.CAT_CODE.getValue())){\n// Wb.toast('{#asCodeNotNull#}');\n// app.CAT_CODE.focus();\n// return false;\n// }\nif(Ext.isEmpty(app.CAT_NAME.getValue())){\nWb.toast('{#asNameNotNull#}');\napp.CAT_NAME.focus();\nreturn false;\n}\n//-------- 如果不选上级资产属性不能为空----------\nif(Ext.isEmpty(app.UP_CODE_ID.getValue())){\n  if(Ext.isEmpty(app.FA_PROPERTY.getValue())){\n    Wb.toast('{#asAttrNotNull#}');\n    app.FA_PROPERTY.focus();\n    return false;\n   }\n  \n}\nif(Ext.isEmpty(app.CAT_ID.getValue())){\n  //--------------- 新增保存---------------------\n    app.saveStore.load({params:{CAT_NAME:app.CAT_NAME.getValue()},callback:function(){\n    \n       if(app.saveStore.getAt(0).get('COU')===0){\n            Ext.Ajax.request({\n             url: '{#contextPath#}' + '/assetCcfAction.do?method=saveAsset',\n             method: 'post',\n             params:  {\n                  user_id : '{#userId#}',\n                  cat_name : app.CAT_NAME.getValue(),\n                  property : app.FA_PROPERTY.getValue(),\n                  up_code :  app.CAT_UP_CODE.getValue()\n             },\n             success: function(response, options) {\n               var res = Ext.decode(response.responseText);\n               if(res.flag==\"0\"){\n                 Wb.toast('{#saveSuc#}');\n                 app.queryBtn.fireEvent('click');\n                 app.newWin.close();\n               }else{\n                 Wb.toast(res.msg);\n               }\n\n             },\n             failure: function(response, options) {\n                Wb.toast('{#noresponse#}');\n             }\n           });\n       }else{\n         Wb.error('{#nameExist#}');\n         return false;\n       }\n \n    }});\n    \n   \n \n}else{\n     //--------------- 更新---------------------\n  app.updateStore.load({params:{CAT_NAME:app.CAT_NAME.getValue(),CAT_ID:app.CAT_ID.getValue()},callback:function(){\n     if(app.updateStore.getAt(0).get('COU')===0){\n        Ext.Ajax.request({\n          url: '{#contextPath#}' + '/assetCcfAction.do?method=updateAsset',\n          method: 'post',\n          params:  {\n            user_id : '{#userId#}',\n            cat_id  : app.CAT_ID.getValue(),\n            cat_name : app.CAT_NAME.getValue(),\n            property : app.FA_PROPERTY.getValue(),\n            up_code :  app.CAT_UP_CODE.getValue(),\n            cat_code : app.CAT_CODE.getValue()\n          },\n          success: function(response, options) {\n            var res = Ext.decode(response.responseText);\n            if(res.flag==\"0\"){\n              Wb.toast('{#saveSuc#}');\n              app.queryBtn.fireEvent('click');\n              app.newWin.close();\n            }else{\n              Wb.toast(res.msg);\n            }\n\n          },\n          failure: function(response, options) {\n            Wb.toast('{#noresponse#}');\n          }\n        });\n\n     }else{\n         Wb.error('{#nameExist#}');\n         return false;\n       \n     }\n  }});\n     \n  \n}\n\n"},"children":[{"configs":{"tagConfigs":"baseCls:'my-panel-no-border'","style":"border-width:0px","layout":"column","itemId":"tr_code"},"children":[{"configs":{"tagConfigs":"baseCls:'my-panel-no-border'","style":"border-width:0px","hidden":"true","margin":"10 0 0 0 ","itemId":"tr1_td1"},"children":[{"configs":{"labelWidth":"60","width":"220","margin":"0 0 0 50","labelAlign":"right","itemId":"CAT_CODE","fieldLabel":"<font color=\"red\">*<\/font>{#code#}"},"children":[],"expanded":false,"type":"text"}],"expanded":true,"type":"panel"}],"expanded":true,"type":"panel"},{"configs":{"tagConfigs":"baseCls:'my-panel-no-border'","style":"border-width:0px","layout":"column","itemId":"tr_name"},"children":[{"configs":{"tagConfigs":"baseCls:'my-panel-no-border'","style":"border-width:0px","margin":"10 0 0 0 ","itemId":"tr1_td2"},"children":[{"configs":{"labelWidth":"60","width":"220","margin":"0 0 0 50","labelAlign":"right","itemId":"CAT_NAME","fieldLabel":"{#name#}<font color=\"red\">*<\/font>"},"children":[],"expanded":false,"type":"text"}],"expanded":true,"type":"panel"}],"expanded":true,"type":"panel"},{"configs":{"tagConfigs":"baseCls:'my-panel-no-border'","style":"border-width:0px","layout":"column","itemId":"tr2"},"children":[{"configs":{"tagConfigs":"baseCls:'my-panel-no-border'","style":"border-width:0px","margin":"10 0 0 0 ","itemId":"tr2_td1"},"children":[{"configs":{"tagConfigs":"columnWidth:0.3","labelWidth":"60","hidden":"false","width":"220","margin":"0 0 0 50","labelAlign":"right","itemId":"UP_CODE_ID","fieldLabel":"{#up#}","editable":"false"},"events":{"expand":"app.UP_CODE_ID.getPicker().store.load({params:{fa_property:app.FA_PROPERTY.getValue()}});"},"children":[{"configs":{"tagConfigs":"minWidth:350","height":"210","width":"200","barNavigateButtons":"true","itemId":"pickComp","barInfoLabel":"false"},"events":{"itemclick":"var picker = this.ownerCmp;\npicker.setValue(record.data.CAT_NAME);\napp.CAT_UP_CODE.setValue(record.get('CAT_CODE')); //保存CODE\napp.CAT_UP_PRO.setValue(record.get('FA_PROPERTY'));//保存该资产属性\npicker.collapse();\napp.upQuery.setValue();\napp.FA_PROPERTY.store.load(function(){\n  app.FA_PROPERTY.setValue(record.get('FA_PROPERTY'));\n});\napp.FA_PROPERTY.setReadOnly(true);"},"children":[{"configs":{"itemId":"columns"},"children":[{"configs":{"text":"{#num#}","align":"center","width":"45","xtype":"rownumberer","titleAlign":"center","itemId":"rownumber"},"children":[],"expanded":false,"type":"column"},{"configs":{"hidden":"true","width":"0","align":"center","dataIndex":"CAT_ID","titleAlign":"center","itemId":"id"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#code#}","align":"left","width":"100","dataIndex":"CAT_CODE","titleAlign":"center","itemId":"code"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#name#}","align":"left","width":"160","dataIndex":"CAT_NAME","titleAlign":"center","itemId":"name"},"children":[],"expanded":false,"type":"column"}],"expanded":false,"type":"array"},{"configs":{"pageSize":"6","autoLoad":"true","itemId":"store","url":"m?xwl=xc/fa/base/fa-ccf/data/getUpFa"},"events":{"beforeload":"var whereSql = 'AND 1=1';\nvar likeThree = \"_\\____\\_\";\nwhereSql =\"and CAT_CODE not like '%\"+likeThree+\"%'\";\nstore.getProxy().extraParams.whereSql = whereSql;\nif(!Ext.isEmpty(app.FA_PROPERTY.getValue())){\n  store.getProxy().extraParams.fa_property = app.FA_PROPERTY.getValue();\n  var threeCode = app.FA_PROPERTY.getValue()+\"___\\____\\_\";\n  whereSql =\"and CAT_CODE not like '%\"+threeCode+\"%'\";\n  \n}\nif(!Ext.isEmpty(app.CAT_CODE.getValue())){\n  store.getProxy().extraParams.up_code = app.CAT_CODE.getValue();\n  var threeCode = app.FA_PROPERTY.getValue()+\"___\\____\\_\";\n  whereSql = \"and CAT_CODE <>'\"+app.CAT_CODE.getValue()+\"'\"+\"and CAT_CODE not like '%\"+threeCode+\"%'\";\n  \n}\nstore.getProxy().extraParams.whereSql = whereSql;\n"},"children":[],"expanded":false,"type":"store"},{"configs":{"width":"200","itemId":"tbar"},"children":[{"configs":{"width":"180","emptyText":"{#inputQuery#}","itemId":"upQuery"},"events":{"change":"//app.queryBtn1.fireEvent('click');","specialkey":"if(Ext.EventObject.getKey()==13){\napp.upQueryBtn.fireEvent('click');\n}"},"children":[],"expanded":false,"type":"text"},{"configs":{"text":"{#query#}","hidden":"false","margin":"0 0 0 10","itemId":"upQueryBtn","iconCls":"seek_icon"},"events":{"click":"app.pickComp.store.load({\nparams:{\ncat_name:app.upQuery.getValue(),\nfa_property:app.FA_PROPERTY.getValue() \n}\n});"},"children":[],"expanded":false,"type":"button"},{"configs":{"text":"{#cancle#}","itemId":"upCancelBtn","iconCls":"cancel_icon"},"events":{"click":"app.UP_CODE_ID.reset();\napp.upQuery.reset();\napp.UP_CODE_ID.getPicker().setVisible(false);\napp.CAT_UP_CODE.setValue('');\napp.CAT_UP_PRO.setValue('');\nif(Ext.isEmpty(app.CAT_ID.getValue())){\n  app.FA_PROPERTY.setReadOnly(false);\n}\n"},"children":[],"expanded":false,"type":"button"}],"expanded":false,"type":"toolbar"}],"expanded":true,"type":"grid"}],"expanded":true,"type":"picker"}],"expanded":true,"type":"panel"}],"expanded":true,"type":"panel"},{"configs":{"tagConfigs":"baseCls:'my-panel-no-border'","style":"border-width:0px","layout":"column","itemId":"tr3"},"children":[{"configs":{"tagConfigs":"baseCls:'my-panel-no-border'","style":"border-width:0px","margin":"10 0 0 0 ","itemId":"tr3_td1"},"children":[{"configs":{"labelWidth":"60","displayField":"VAL_NAME","width":"220","valueField":"VAL_CODE","margin":"0 0 0 50","labelAlign":"right","itemId":"FA_PROPERTY","forceSelection":"true","fieldLabel":"{#property#}<font color=\"red\">*<\/font>"},"events":{"select":"app.UP_CODE_ID.getPicker().store.getProxy().extraParams.fa_property = app.FA_PROPERTY.getValue();\napp.UP_CODE_ID.getPicker().store.load({params:{fa_property:app.FA_PROPERTY.getValue()}});\napp.UP_CODE_ID.reset();\napp.CAT_UP_CODE.setValue('');\napp.CAT_UP_PRO.setValue('');"},"children":[{"configs":{"autoLoad":"true","itemId":"store","url":"m?xwl=xc/fa/base/fa-ccf/data/getFaProperty"},"children":[],"expanded":false,"type":"store"}],"expanded":true,"type":"combo"}],"expanded":true,"type":"panel"}],"expanded":true,"type":"panel"},{"configs":{"tagConfigs":"baseCls:'my-panel-no-border'","style":"border-width:0px","hidden":"true","layout":"column","itemId":"tr4"},"children":[{"configs":{"tagConfigs":"baseCls:'my-panel-no-border'","style":"border-width:0px","margin":"10 0 0 0 ","itemId":"tr4_td1"},"children":[{"configs":{"hidden":"true","itemId":"CAT_ID"},"children":[],"expanded":false,"type":"text"},{"configs":{"itemId":"CAT_UP_CODE"},"children":[],"expanded":false,"type":"hidden"},{"configs":{"itemId":"CAT_UP_PRO"},"children":[],"expanded":false,"type":"hidden"}],"expanded":true,"type":"panel"}],"expanded":false,"type":"panel"}],"expanded":true,"type":"window"},{"configs":{"layout":"border","itemId":"viewport1"},"children":[{"configs":{"region":"north","border":"false","itemId":"queryForm"},"children":[{"configs":{"layout":"column","border":"false","itemId":"queryPanel"},"children":[{"configs":{"tagConfigs":"columnWidth:0.25","labelWidth":"100","displayField":"VAL_NAME","valueField":"VAL_CODE","emptyText":"{#plSelect#}","labelAlign":"right","padding":"10","itemId":"faProperty","fieldLabel":"{#faPro#}","editable":"false"},"events":{"select":"app.codeName.setValue('');\napp.queryBtn.fireEvent('click');"},"children":[{"configs":{"autoLoad":"true","itemId":"store","url":"m?xwl=xc/fa/base/fa-ccf/data/getFaProperty"},"children":[],"expanded":false,"type":"store"}],"expanded":false,"type":"combo"},{"configs":{"tagConfigs":"columnWidth:0.25","labelWidth":"80","labelAlign":"right","padding":"10","itemId":"codeName","fieldLabel":"{#codeName#}"},"events":{"change":"app.tree.expandAll();","specialkey":"if(Ext.EventObject.getKey()==13){\n  app.queryBtn.fireEvent('click');\n}"},"children":[],"expanded":false,"type":"text"},{"configs":{"text":"{#query#}","margin":"0 0 0 20","itemId":"queryBtn","y":"10","iconCls":"seek_icon"},"events":{"click":"app.tree.store.load({\n  params:{\n    UP_CODE: app.faProperty.getValue() + \"_ROOT\", \n    fa_pro: app.faProperty.getValue(),\n    codeName: app.codeName.getValue()\n  }\n});\n\n\n/*if(Ext.isEmpty(app.codeName.getValue())){\n  app.tree.store.load({params:{UP_CODE:app.faProperty.getValue()+\"_ROOT\",fa_pro:app.faProperty.getValue()},callback:function(){\n  }});\n}else{\n}\n\nsetTimeout(function(){\n  treeNodeQuery(app.codeName.getValue(),'text',app.tree);\n},100);*/"},"children":[],"expanded":false,"type":"button"},{"configs":{"text":"{#reset#}","margin":"0 0 0 20","itemId":"resetBtn","y":"10","iconCls":"refresh_icon"},"events":{"click":"Wb.reset(app.queryForm);\napp.tree.store.load({params:{fa_pro:app.faProperty.getValue()}});\napp.tree.expandAll();"},"children":[],"expanded":false,"type":"button"}],"expanded":true,"type":"panel"}],"expanded":true,"type":"form"},{"configs":{"rootVisible":"false","region":"center","multiSelect":"true","root":"{id:'root',text:'root',cat_code:'root',expanded:true}","itemId":"tree"},"events":{"itemdblclick":"app.editBtn.fireEvent('click');","beforerender":"//app.tree1.getRootNode().appendChild({id:'fa_root',text:'固定资产',UP_CODE:'-1',CAT_CODE:'FA_ROOT'});\n"},"children":[{"configs":{"itemId":"store","url":"m?xwl=xc/fa/base/fa-ccf/data/faTree"},"events":{"load":"app.tree.expandAll(function(){});","beforeload":"var node = operation.node;\noperation.params.UP_CODE = node.isRoot() ? -1 : operation.node.data.CAT_CODE;\nvar whereSql= ' AND 1=1';\nif(node.isRoot()){\n  whereSql = 'union select \\'固定资产\\' AS \\'text\\',\\' \\' AS CAT_ID,\\'FA_ROOT\\' AS CAT_CODE,'+\n             '\\'固定资产\\' AS CAT_NAME,\\'-1\\' AS UP_CODE,\\'\\' AS UP_NAME, 0 AS IS_LEAF,'+\n              '\\'\\' AS FA_PROPERTY,\\'\\' AS FA_PRO_NAME,\\'false\\' as \\'leaf\\' FROM XC_FA_CATS '+\n              'union select \\'无形资产\\' AS \\'text\\',\\' \\' AS CAT_ID,\\'IA_ROOT\\' AS CAT_CODE,'+\n             '\\'无形资产\\' AS CAT_NAME,\\'-1\\' AS UP_CODE,\\'\\' AS UP_NAME, 0 AS IS_LEAF,'+\n              '\\'\\' AS FA_PROPERTY,\\'\\' AS FA_PRO_NAME,\\'false\\' as \\'leaf\\' FROM XC_FA_CATS '+\n    'union select \\'生物性资产\\' AS \\'text\\',\\' \\' AS CAT_ID,\\'BA_ROOT\\' AS CAT_CODE,'+\n             '\\'生物性资产\\' AS CAT_NAME,\\'-1\\' AS UP_CODE,\\'\\' AS UP_NAME, 0 AS IS_LEAF,'+\n              '\\'\\' AS FA_PROPERTY,\\'\\' AS FA_PRO_NAME,\\'false\\' as \\'leaf\\' FROM XC_FA_CATS '+\n    'union select \\'低值易耗品\\' AS \\'text\\',\\' \\' AS CAT_ID,\\'LV_ROOT\\' AS CAT_CODE,'+\n             '\\'低值易耗品\\' AS CAT_NAME,\\'-1\\' AS UP_CODE,\\'\\' AS UP_NAME, 0 AS IS_LEAF,'+\n              '\\'\\' AS FA_PROPERTY,\\'\\' AS FA_PRO_NAME,\\'false\\' as \\'leaf\\' FROM XC_FA_CATS '\n    ;\n}\nif(!Ext.isEmpty(app.faProperty.getValue())){\n   if(app.faProperty.getValue()=='FA'){\n     if(node.isRoot()){\n       whereSql = 'union select \\'固定资产\\' AS \\'text\\',\\' \\' AS CAT_ID,\\'FA_ROOT\\' AS CAT_CODE,'+\n             '\\'固定资产\\' AS CAT_NAME,\\'-1\\' AS UP_CODE,\\'\\' AS UP_NAME, 0 AS IS_LEAF,'+\n              '\\'\\' AS FA_PROPERTY,\\'\\' AS FA_PRO_NAME,\\'false\\' as \\'leaf\\' FROM XC_FA_CATS ';\n     }\n   }\n   if(app.faProperty.getValue()=='IA'){\n     if(node.isRoot()){\n     whereSql = 'union select \\'无形资产\\' AS \\'text\\',\\' \\' AS CAT_ID,\\'IA_ROOT\\' AS CAT_CODE,'+\n             '\\'无形资产\\' AS CAT_NAME,\\'-1\\' AS UP_CODE,\\'\\' AS UP_NAME, 0 AS IS_LEAF,'+\n              '\\'\\' AS FA_PROPERTY,\\'\\' AS FA_PRO_NAME,\\'false\\' as \\'leaf\\' FROM XC_FA_CATS ';\n     }\n   }\n   if(app.faProperty.getValue()=='BA'){\n     if(node.isRoot()){\n     whereSql = 'union select \\'生物性资产\\' AS \\'text\\',\\' \\' AS CAT_ID,\\'BA_ROOT\\' AS CAT_CODE,'+\n             '\\'生物性资产\\' AS CAT_NAME,\\'-1\\' AS UP_CODE,\\'\\' AS UP_NAME, 0 AS IS_LEAF,'+\n              '\\'\\' AS FA_PROPERTY,\\'\\' AS FA_PRO_NAME,\\'false\\' as \\'leaf\\' FROM XC_FA_CATS ';\n     }\n   }\n   if(app.faProperty.getValue()=='LV'){\n     if(node.isRoot()){\n     whereSql = 'union select \\'低值易耗品\\' AS \\'text\\',\\' \\' AS CAT_ID,\\'LV_ROOT\\' AS CAT_CODE,'+\n             '\\'低值易耗品\\' AS CAT_NAME,\\'-1\\' AS UP_CODE,\\'\\' AS UP_NAME, 0 AS IS_LEAF,'+\n              '\\'\\' AS FA_PROPERTY,\\'\\' AS FA_PRO_NAME,\\'false\\' as \\'leaf\\' FROM XC_FA_CATS ';\n     }\n   }\n}\nstore.getProxy().extraParams.whereSql = whereSql;\nstore.getProxy().extraParams.fa_pro = app.faProperty.getValue();\nstore.getProxy().extraParams.codeName = app.codeName.getValue();\n"},"children":[],"expanded":false,"type":"treestore"},{"configs":{"itemId":"columns"},"children":[{"configs":{"text":"序号","hidden":"true","align":"center","width":"45","xtype":"rownumberer","titleAlign":"center","itemId":"XUHAO"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"CAT_ID","hidden":"true","dataIndex":"CAT_ID","itemId":"CAT_ID_COL"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#faName#}","xtype":"treecolumn","align":"left","width":"200","dataIndex":"text","titleAlign":"left","itemId":"CAT_NAME_COL"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#faCode#}","hidden":"true","align":"left","width":"150","dataIndex":"CAT_CODE","titleAlign":"left","itemId":"CAT_CODE_COL","renderer":"if(value=='FA_ROOT'||value=='IA_ROOT'||value=='BA_ROOT'||value=='LV_ROOT'){\n  return '';\n}else{\n  return value;\n}"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"是否末级分类","hidden":"true","dataIndex":"IS_LEAF","itemId":"IS_LEAF_COL"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#faPro#}","align":"left","width":"150","dataIndex":"FA_PRO_NAME","titleAlign":"left","itemId":"FA_PRO_NAME_COL"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"资产属性编码","hidden":"true","width":"150","dataIndex":"FA_PROPERTY","itemId":"FA_PROPERTY_COL"},"children":[],"expanded":false,"type":"column"}],"expanded":false,"type":"array"},{"configs":{"itemId":"tbar"},"children":[{"configs":{"text":"{#add#}","itemId":"newBtn","iconCls":"file_add_icon"},"events":{"click":"var rows = app.tree.getSelection();\nif(rows.length>1){\n  Wb.toast('{#selectFa#}');\n  return false;\n}\n\napp.UP_CODE_ID.getPicker().store.load();\n//------------新增的资产都是末级资产IS_LEAF=1,如果选中3级资产则返回--------------\nif(rows.length==1){\n  var flag = true;\n  \n  //资产分类中已经被资产分类设置引用不能够增加下级\n  Ext.Ajax.request({\n    url : 'm?xwl=xc/fa/base/fa-ccf/data/checkRefCatSetting',\n    method: 'POST',\n    params: {catCode: rows[0].get('CAT_CODE')},\n    async: false,\n    success: function(response,options){\n      var resp = Ext.decode(response.responseText);\n      \n      if(resp.CNT > 0){\n        Wb.toast('{#checkRefCatSetting#}');\n        flag = false;\n      }\n    },\n    failure: function(response,options){\n      Wb.toast('failure');\n    }\n  });\n  if(flag==false){\n    return;\n  }\n  //资产分类时如果选中的是3级节点控制不能增加下级\n  var spArray = rows[0].get('CAT_CODE').split('_');\n  if(spArray.length==3){\n    Wb.toast('{#threeLevelNodeNotAdd#}');\n    return;\n  }\n\n  var win = new Ext.window.Window(app._newWin);\n  win.show();\n  \n  var upCode = rows[0].get('UP_CODE');\n  var faPro = rows[0].get('FA_PROPERTY');\n  if(upCode == '-1'){\n    //-------当前选中的资产为根资产------\n//     var win = new Ext.window.Window(app._newWin);\n//     win.show();\n//     app.UP_CODE_ID.getPicker().store.load();\n    var cat_code = rows[0].get('CAT_CODE');\n    //---资产属性赋值--\n    app.FA_PROPERTY.store.load(function(){\n      app.FA_PROPERTY.setValue(cat_code.substring(0,2));\n    });\n    app.UP_CODE_ID.setReadOnly(true);\n  }else if(upCode == faPro+\"_ROOT\"){\n       //-------当前资产为1级资产--------\n//        var win = new Ext.window.Window(app._newWin);\n//        win.show();\n//        app.UP_CODE_ID.getPicker().store.load();\n       //-----资产属性赋值-----\n       app.FA_PROPERTY.store.load(function(){\n        app.FA_PROPERTY.setValue(rows[0].get('FA_PROPERTY'));\n       });\n       //-----上级资产赋值------\n       app.UP_CODE_ID.setValue(rows[0].get('CAT_NAME'));\n       app.CAT_UP_CODE.setValue(rows[0].get('CAT_CODE'));\n       app.CAT_UP_PRO.setValue(rows[0].get('FA_PROPERTY'));\n       //-----资产属性上级不可更改\n       app.UP_CODE_ID.setReadOnly(true);\n       app.FA_PROPERTY.setReadOnly(true);\n  }else{\n    //-------------获取当前资产的上级资产的UP_CODE,如果不等于资产属性+\"_ROOT\",说明是3级资产----------------\n    app.getAssetInfo.load({params:{cat_code:upCode},callback:function(){\n      if(app.getAssetInfo.getCount()>0){\n         if(app.getAssetInfo.getAt(0).get('UP_CODE')!= faPro+\"_ROOT\"){\n           //--------------- 当前资产为3级资产---------------\n           return false;\n         }else{\n             //--------------- 当前资产为2级资产---------------\n//              var win = new Ext.window.Window(app._newWin);\n//              win.show();\n//              app.UP_CODE_ID.getPicker().store.load();\n             //-----资产属性赋值-----\n             app.FA_PROPERTY.store.load(function(){\n              app.FA_PROPERTY.setValue(rows[0].get('FA_PROPERTY'));\n             });\n             //-----上级资产赋值------\n             app.UP_CODE_ID.setValue(rows[0].get('CAT_NAME'));\n             app.CAT_UP_CODE.setValue(rows[0].get('CAT_CODE'));\n             app.CAT_UP_PRO.setValue(rows[0].get('FA_PROPERTY'));\n             //-----资产属性上级不可更改\n             app.UP_CODE_ID.setReadOnly(true);\n             app.FA_PROPERTY.setReadOnly(true);\n         }\n      }\n    }});\n  }\n}else{\n  app.FA_PROPERTY.setReadOnly(false);\n  app.UP_CODE_ID.setReadOnly(false);\n  \n  var win = new Ext.window.Window(app._newWin);\n  win.show();\n}"},"children":[],"expanded":false,"type":"button"},{"configs":{"text":"{#edit#}","itemId":"editBtn","iconCls":"file_edit_icon"},"events":{"click":"var rows = app.tree.getSelection();\nif(rows.length!==1){\n  Wb.toast('{#selectFa#}');\n  return false;\n}\n//跟节点不可编辑\nif(rows[0].get('UP_CODE')=='-1'){\n  return false;\n}\nvar win = new Ext.window.Window(app._newWin);\nwin.show();\nwin.setTitle('{#edit#}');\napp.FA_PROPERTY.store.load(function(){\n  app.FA_PROPERTY.setValue(rows[0].get('FA_PROPERTY'));\n});\napp.CAT_CODE.setReadOnly(true);\napp.CAT_ID.setValue(rows[0].get('CAT_ID'));\napp.CAT_CODE.setValue(rows[0].get('CAT_CODE'));\napp.CAT_NAME.setValue(rows[0].get('CAT_NAME'));\nif(rows[0].get('UP_CODE')==\"FA_ROOT\"||rows[0].get('UP_CODE')==\"IA_ROOT\"||rows[0].get('UP_CODE')==\"BA_ROOT\"||rows[0].get('UP_CODE')==\"LV_ROOT\"){\n}else{\n  app.UP_CODE_ID.setValue(rows[0].get('UP_NAME'));\n  app.CAT_UP_CODE.setValue(rows[0].get('UP_CODE'));\n  app.CAT_UP_PRO.setValue(rows[0].get('FA_PROPERTY'));\n}\n//---------------------当前资产存在下级，属性不可改--------------------\napp.getDownFa.load({params:{cat_code:rows[0].get('CAT_CODE')},callback:function(){\n    \n    if(app.getDownFa.getCount()!==0){\n      var up_code = app.getDownFa.getAt(0).get('CAT_CODE');\n      //----存在下级----\n       app.FA_PROPERTY.setReadOnly(true);\n      //-----------------是否存在上级--------------\n       if(!Ext.isEmpty(rows[0].get('UP_CODE')) && rows[0].get('UP_CODE')!=rows[0].get('FA_PROPERTY')+\"_ROOT\"){\n         //--------------存在上级，重新加载上级grid,只能选1级资产（层级为1）----------\n         app.UP_CODE_ID.getPicker().store.getProxy().url = 'm?xwl=xc/fa/base/fa-ccf/data/getEditUpFa';\n         app.UP_CODE_ID.getPicker().store.getProxy().extraParams.rootCode = rows[0].get('FA_PROPERTY')+\"_ROOT\";\n         app.UP_CODE_ID.getPicker().store.load({params:{rootCode:rows[0].get('FA_PROPERTY')+\"_ROOT\",cat_code:app.CAT_CODE.getValue()}});\n       }else{\n         //---------------不存在上级，判断当前资产的所在的资产层级是否为3-------------\n          app.getDownFa.load({params:{cat_code:up_code},callback:function(){\n            if(app.getDownFa.getCount()!==0){\n              //---------------当前资产为1级资产(层级为3)，不可改属性及上级----------\n              app.FA_PROPERTY.setReadOnly(true);\n              app.UP_CODE_ID.setReadOnly(true);\n               \n            }else{\n              //-------------当前资产为1级资产（层级为2），重新加载上级grid,只能选1级资产（层级为1）\n               app.UP_CODE_ID.getPicker().store.getProxy().url = 'm?xwl=xc/fa/base/fa-ccf/data/getEditUpFa';\n               app.UP_CODE_ID.getPicker().store.getProxy().extraParams.rootCode = rows[0].get('FA_PROPERTY')+\"_ROOT\";\n               app.UP_CODE_ID.getPicker().store.load({params:{rootCode:rows[0].get('FA_PROPERTY')+\"_ROOT\",cat_code:app.CAT_CODE.getValue()}});\n            }\n            \n          }});\n       }\n    }else{\n      //app.FA_PROPERTY.setReadOnly(false);\n      app.FA_PROPERTY.setReadOnly(true);\n    }\n  \n  app.UP_CODE_ID.setReadOnly(true);\n  app.FA_PROPERTY.setReadOnly(true);\n}});"},"children":[],"expanded":false,"type":"button"},{"configs":{"text":"{#delete#}","itemId":"deleteBtn","iconCls":"file_delete_icon"},"events":{"click":"var recs = app.tree.getSelection();\nif (!recs.length) {\n  Wb.toast('{#selectDeleDa#}');\n  return;\n}\nWb.confirm('{#confirm#}', function() {\n  //校验是否被关联\n  var code = \"\";\n  for(var i=0;i<recs.length;i++){\n    code +=\"'\"+recs[i].get('CAT_CODE')+\"',\";\n  }\n  code = code.substring(0,code.length-1);\n  //-----------获取下级资产编码\n  app.getDownFaCode.load({params:{CAT_CODE:code},callback:function(){\n    var upCode = \"\";\n    for(var j=0;j<app.getDownFaCode.getCount();j++){\n      upCode +=\"'\"+app.getDownFaCode.getAt(j).get('CAT_CODE')+\"',\";\n    }\n    upCode = upCode.substring(0,upCode.length-1);\n    //获取下级\n    app.getDownFaCode.load({params:{CAT_CODE:code},callback:function(){\n      var upupCode = \"\";\n      for(var j=0;j<app.getDownFaCode.getCount();j++){\n        upupCode +=\"'\"+app.getDownFaCode.getAt(j).get('CAT_CODE')+\"',\";\n      }\n      upupCode = upupCode.substring(0,upupCode.length-1);\n      var checkCodeArr = code;\n      if(upCode!==''){\n        checkCodeArr = code +\",\" +upCode;\n      }else if(upupCode!==''){\n        checkCodeArr = code +\",\" +upCode +\",\"+upupCode;\n      }\n      //校验\n      app.checkRelation.load({params:{cat_code:checkCodeArr},callback:function(){\n         if(app.checkRelation.getCount()>0){\n           Wb.error('{#relation#}');\n         }else{\n              Wb.request({\n                url: 'm?xwl=xc/fa/base/fa-ccf/data/deleteFa',\n                params: {data:Wb.getData(recs)},\n                success: function(resp) {\n                  //------删除当前资产的下级资产------\n                   Wb.request({\n                     url:'m?xwl=xc/fa/base/fa-ccf/data/deleteLeafFa',\n                     params :{data:Wb.getData(recs)},\n                     success:function(){\n                       var code = \"\";\n                       for(var i=0;i<recs.length;i++){\n                         code +=\"'\"+recs[i].get('CAT_CODE')+\"',\";\n                       }\n                       code = code.substring(0,code.length-1);\n                       //-----------获取下级资产编码\n                       app.getDownFaCode.load({params:{CAT_CODE:code},callback:function(){\n                           var upCode = \"\";\n                           for(var j=0;j<app.getDownFaCode.getCount();j++){\n                             upCode +=\"'\"+app.getDownFaCode.getAt(j).get('CAT_CODE')+\"',\";\n                           }\n                           upCode = upCode.substring(0,upCode.length-1);\n                           if(!Ext.isEmpty(upCode)){\n                              //----------删掉下级的下级资产\n                              Wb.request({\n                               url:'m?xwl=xc/fa/base/fa-ccf/data/deleteLastLeafFa',\n                               params :{upCode:upCode},\n                               success:function(){\n                                 Wb.toast('{#deleteSuc#}');\n                                 app.queryBtn.fireEvent('click');\n                               }\n                             });\n                           }else{\n                             Wb.toast('{#deleteSuc#}');\n                             app.queryBtn.fireEvent('click');\n                           }\n                         //UPDATE IS_LEAF\n                            Wb.request({\n                               url:'m?xwl=xc/fa/base/fa-ccf/data/updateIsLeafAfterDelete',\n                               success:function(){\n                               }\n                             });\n\n                       }});\n\n\n                     }\n                   });\n                }\n              });\n           \n         }\n      }});\n   }});\n }});\n\n  \n\n});"},"children":[],"expanded":false,"type":"button"},{"configs":{"text":"{#import#}","itemId":"importBtn","iconCls":"import_icon"},"events":{"click":"Xip.importExcel('XC_FA_CAT_CCF', null);"},"children":[],"expanded":false,"type":"button"},{"configs":{"text":"{#export#}","itemId":"exportBtn","iconCls":"export_icon"},"events":{"click":"Xip.exportExcel('XC_FA_CAT_CCF','', '{#assetClass#}');"},"children":[],"expanded":false,"type":"button"}],"expanded":true,"type":"toolbar"}],"expanded":true,"type":"tree"}],"expanded":true,"type":"viewport"}],"expanded":true,"type":"module"}],"pageLink":"","iconCls":""}