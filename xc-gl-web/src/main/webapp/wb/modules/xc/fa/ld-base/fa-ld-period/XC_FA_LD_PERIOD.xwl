{"inframe":false,"title":"会计期管理","hidden":false,"roles":{"default":1},"children":[{"configs":{"initScript":"//---------------------获取当前模块语言对应的.json文件，放到request中----------------\ncom.xzsoft.xip.platform.util.XipUtil.getCurrentLang(request,\"xc/fa/ld-base/fa-ld-period/XC_FA_LD_PERIOD\");","loginRequired":"false","serverScript":"var ctx = request.getContextPath();\nrequest.setAttribute(\"contextPath\",ctx);","itemId":"module"},"events":{"initialize":"var ledgerArray = [];//存储所有账薄信息  暂时未用\nvar start_period_code;//存储账薄的开始会计期\nvar ledger_id;//存储账薄的ID\nvar statuArray = [];//存放账薄的会计期的状态\n\nvar ledger_flag = false;//区分账簿下拉选择框的单击事件与选择事件\n//var period_flag = false;\n\n\n"},"children":[{"configs":{"height":"500","width":"700","layout":"border","closeAction":"destroy","buttonAlign":"center","dialog":"true","itemId":"window1"},"events":{"ok":"var books = app.ledgerIdText.getValue();\nvar insertArray = [];\n\nif(Ext.isEmpty(books)){\n   Wb.toast('{#selectBo#}');\n   return false;\n}else{\n  var rec = app.ld_period_grid.getSelection();\n // var count = app.ld_period_grid.store.getCount();\n  for(var i=0 ;i<rec.length ;i++){\n    //账簿ID\n    var bookId = rec[i].data.LEDGER_ID;\n    //分类编码\n    var periodCode = rec[i].data.PERIOD_CODE;\n    //年度\n    var year = rec[i].data.YEAR;\n    //开始日期\n    var start = rec[i].data.START_DATE;\n    //结束日期\n    var end = rec[i].data.END_DATE;\n    //状态\n    var status = rec[i].data.LD_PERIOD_STATUS;\n    if(status==1){\n      status = 1;\n    }else if(status==2){\n      status = 2;\n    }else if(status==3){\n      status = 0;\n    }\n    //计提折旧\n    var jtzj = 'N';\n    var json = { \n                 LD_PERIOD_ID : Xip.getId(),\n                 LEDGER_ID : bookId,\n                 PERIOD_CODE : periodCode,\n                 STATUS   : 0,\n                 JTZJ    : jtzj\n                 \n               };\n   \n\n    insertArray.push(json);\n\n    \n    \n  }\n  \n   Wb.request({\n            url:'m?xwl=xc/fa/ld-base/fa-ld-period/data/insert_fa_ld_periods',\n            params:Wb.apply({array:Wb.encode(insertArray)}),\n            success:function(){\n                Wb.remove(app.ld_period_grid);\n                Wb.reload(app.fa_period_grid);\n                Wb.toast('{#success#}');\n                win.hide();\n            }\n        });\n \n  \n  \n}\n"},"children":[{"configs":{"labelWidth":"80","hidden":"true","labelAlign":"right","itemId":"ledgerIdText"},"children":[],"expanded":false,"type":"text"},{"configs":{"region":"north","hidden":"true","itemId":"query_form","border":"false"},"children":[{"configs":{"layout":"column","itemId":"ld_sec","border":"false"},"children":[{"configs":{"tagConfigs":"columnWidth:0.22","labelWidth":"40","displayField":"LEDGER_NAME","valueField":"LEDGER_ID","typeAhead":"true","emptyText":"{#selectBo#}","itemId":"query_ledger","padding":"10","fieldLabel":"{#books#}","forceSelection":"true","editable":"true","selectOnFocus":"true"},"events":{"select":"app.query_fa_period_year.setValue();//清空年度\n\napp.ld_period_grid.store.load({params:{ledger_id:combo.getValue()}\n                              \n                              });\n\n","beforequery":"var combo = plan.combo ;\nif(!plan.forceAll){\n  var flag = false;\n  var value = plan.query;\n  combo.store.filterBy(function(record,id){\n    var text = record.get(combo.displayField);\n    return (text.indexOf(value)!=-1);\n  });\n  combo.expand();\n  return false;\n}","specialkey":"// if(e.getKey()===13){\n//   ledger_flag = true;\n//   combo.fireEvent('select');\n// }"},"children":[{"configs":{"pageSize":"-1","itemId":"store","autoLoad":"true","url":"m?xwl=xc/com-qry/gl-ledgers/select-sec-fd-ledgers"},"events":{"success":"\n"},"children":[],"expanded":false,"type":"store"}],"expanded":true,"type":"combo"},{"configs":{"tagConfigs":"columnWidth:0.15","labelWidth":"40","displayField":"YEAR","valueField":"YEAR","itemId":"query_ld_period_year","padding":"10","fieldLabel":"{#year#}"},"events":{"afterrender":"// 设置显示当前年度\n// app.query_ld_period_year.setValue(Ext.Date.format(new Date(),'Y'));","select":"var temp_year = combo.getValue();\nledger_id = app.query_ledger.getValue();\n\napp.query_ld_period_store.load({\n\tparams:{\n    ledger_id:ledger_id,\n    year : temp_year\n    }\n});","beforequery":"var combo = plan.combo ;\nif(!plan.forceAll){\n  var flag = false;\n  var value = plan.query;\n  combo.store.filterBy(function(record,id){\n    var text = record.get(combo.displayField);\n    return (text.indexOf(value)!=-1);\n  });\n  combo.expand();\n  return false;\n}","specialkey":"if(e.getKey()===13){\n\n  var temp_year = app.query_ld_period_year.getValue();\n  ledger_id = app.query_ledger.getValue();\n\n  app.query_ld_period_store.load({\n    params:{\n      ledger_id:ledger_id,\n      year : temp_year\n    }\n  });\n}"},"children":[{"configs":{"pageSize":"-1","itemId":"store","url":"m?xwl=xc/fa/ld-base/fa-ld-period/data/select_ld_period_year"},"events":{"beforeload":"//动态传递参数\nExt.apply(store.proxy.extraParams,{ledger_id:ledger_id});    "},"children":[],"expanded":false,"type":"store"}],"expanded":true,"type":"combo"},{"configs":{"tagConfigs":"columnWidth:0.08","text":"{#query#}","margin":"0 0 0 20","itemId":"queryBtn","iconCls":"seek_icon","y":"10"},"events":{"click":"var temp_year = app.query_ld_period_year.getValue();\nledger_id = app.query_ledger.getValue();\n\nif(ledger_id==='' || ledger_id===null) {\n   Wb.toast('{#selectBo#}');\n   return;\n}\n\napp.query_ld_period_store.load({\n  params:{\n    ledger_id:ledger_id,\n    year : temp_year\n  }\n});"},"children":[],"expanded":false,"type":"button"},{"configs":{"tagConfigs":"columnWidth:0.08","text":"{#reset#}","margin":"0 0 0 20","itemId":"resetBtn","iconCls":"refresh_icon","y":"10"},"events":{"click":"app.query_ledger.reset();\napp.query_ld_period_year.reset();\n//设置显示当前年度\n// app.query_ld_period_year.setValue(Ext.Date.format(new Date(),'Y'));\napp.query_ld_period_store.load();"},"children":[],"expanded":false,"type":"button"}],"expanded":true,"type":"panel"}],"expanded":false,"type":"form"},{"configs":{"region":"center","selType":"checkboxmodel","itemId":"ld_period_grid","editable":"true"},"children":[{"configs":{"pageSize":"-1","autoLoad":"false","itemId":"store","url":"m?xwl=xc/fa/ld-base/fa-ld-period/data/select_ld_period"},"children":[],"expanded":false,"type":"store"},{"configs":{"itemId":"columns"},"children":[{"configs":{"text":"{#no#}","xtype":"rownumberer","width":"50","align":"center","titleAlign":"center","itemId":"period_row1"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"账薄ID","hidden":"true","dataIndex":"LEDGER_ID","itemId":"ledger_id_col1"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#classCode#}","width":"100","dataIndex":"PERIOD_CODE","titleAlign":"left","itemId":"period_code_col1"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#year#}","width":"60","dataIndex":"YEAR","titleAlign":"left","itemId":"year_col1"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#start#}","width":"100","dataIndex":"START_DATE","titleAlign":"left","itemId":"start_date_col1"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#end#}","width":"100","dataIndex":"END_DATE","titleAlign":"left","itemId":"end_date_col1"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"调整期","hidden":"true","dataIndex":"IS_ADJ_PERIOD","titleAlign":"left","itemId":"is_adj_period_col1","renderer":"if(value==='N')\n  return '否';\nif(value==='Y')\n  return '是';"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#status#}","width":"100","dataIndex":"LD_PERIOD_STATUS","titleAlign":"left","itemId":"ld_period_status_col1","renderer":"//改变显示值\nif(value==1){\n   \n  return '{#open#}';\n}else if(value==2){\n  return '{#close#}';\n  \n}else if(value==3){\n  return '{#lastingClose#}';\n}"},"children":[],"expanded":true,"type":"column"}],"expanded":true,"type":"array"}],"expanded":true,"type":"grid"}],"expanded":false,"type":"window"},{"configs":{"itemId":"storeFolder"},"children":[{"configs":{"pageSize":"-1","itemId":"query_ld_period_store","autoLoad":"false","url":"m?xwl=xc/fa/ld-base/fa-ld-period/data/select_ld_period"},"children":[],"expanded":true,"type":"store"},{"configs":{"itemId":"checkExistPeriod","url":"m?xwl=xc/fa/ld-base/fa-ld-period/data/checkExistPeriod"},"children":[],"expanded":false,"type":"store"},{"configs":{"itemId":"queryOpenStore","url":"m?xwl=xc/fa/ld-base/fa-ld-period/data/select_fa_open_period"},"children":[],"expanded":false,"type":"store"}],"expanded":true,"type":"folder"},{"configs":{"layout":"border","itemId":"viewport1"},"events":{"afterrender":"app.fa_ledger.getStore().load(function(){\n  if(app.fa_ledger.getStore().getCount()>0){\n    app.fa_ledger.setValue(app.fa_ledger.getStore().getAt(0).get('LEDGER_ID'));\n    app.queryBtn.fireEvent('click');\n  }\n});"},"children":[{"configs":{"region":"north","itemId":"form","border":"false"},"children":[{"configs":{"layout":"column","itemId":"ld_sec","border":"false"},"children":[{"configs":{"tagConfigs":"columnWidth:0.22","labelWidth":"40","displayField":"LEDGER_NAME","valueField":"LEDGER_ID","typeAhead":"true","emptyText":"{#selectBo#}","itemId":"fa_ledger","padding":"10","fieldLabel":"{#books#}","forceSelection":"true","editable":"true","selectOnFocus":"true"},"events":{"select":"app.query_fa_period_year.setValue();//清空年度\napp.fa_period_grid.store.load({params:{ledger_id:combo.getValue()}});","beforequery":"// var combo = plan.combo ;\n// if(!plan.forceAll){\n//   var flag = false;\n//   var value = plan.query;\n//   combo.store.filterBy(function(record,id){\n//     var text = record.get(combo.displayField);\n//     return (text.indexOf(value)!=-1);\n//   });\n//   combo.expand();\n//   return false;\n// }","specialkey":"// if(e.getKey()===13){\n//   ledger_flag = true;\n//   combo.fireEvent('select');\n// }"},"children":[{"configs":{"pageSize":"-1","itemId":"store","autoLoad":"true","url":"m?xwl=xc/com-qry/gl-ledgers/select-sec-fd-ledgers"},"events":{"success":"//存储所有账薄信息：为了后面获取账薄的开始会计期。\nledgerArray = [];\nvar count=store.getCount();\nfor(var i=0;i<count;i++) {\n\tledgerArray.push(store.getAt(i).data);\n}\n"},"children":[],"expanded":false,"type":"store"}],"expanded":false,"type":"combo"},{"configs":{"tagConfigs":"columnWidth:0.15","labelWidth":"40","displayField":"YEAR","valueField":"YEAR","itemId":"query_fa_period_year","padding":"10","fieldLabel":"{#year#}"},"events":{"afterrender":"// 设置显示当前年度\n// app.query_ld_period_year.setValue(Ext.Date.format(new Date(),'Y'));","select":"var temp_year = combo.getValue();\nledger_id = app.fa_ledger.getValue();\n\napp.fa_period_grid.store.load({\n\tparams:{\n    ledger_id:ledger_id,\n    year : temp_year\n    }\n});","beforequery":"var combo = plan.combo ;\nif(!plan.forceAll){\n  var flag = false;\n  var value = plan.query;\n  combo.store.filterBy(function(record,id){\n    var text = record.get(combo.displayField);\n    return (text.indexOf(value)!=-1);\n  });\n  combo.expand();\n  return false;\n}"},"children":[{"configs":{"pageSize":"-1","itemId":"store","url":"m?xwl=xc/fa/ld-base/fa-ld-period/data/select_ld_period_year"},"events":{"beforeload":"if(Ext.isEmpty(app.fa_ledger.getValue())){\n  return;\n}\n\n//动态传递参数\nExt.apply(store.proxy.extraParams,{ledger_id:app.fa_ledger.getValue()});    "},"children":[],"expanded":false,"type":"store"}],"expanded":false,"type":"combo"},{"configs":{"tagConfigs":"columnWidth:0.08","text":"{#query#}","margin":"0 0 0 20","itemId":"queryBtn","iconCls":"seek_icon","y":"10"},"events":{"click":"var temp_year = app.query_fa_period_year.getValue();\nledger_id = app.fa_ledger.getValue();\n\nif(ledger_id==='' || ledger_id===null) {\n   Wb.toast('{#selectBo#}');\n   return;\n}\n\napp.fa_period_grid.store.load({\n  params:{\n    ledger_id:ledger_id,\n    year : temp_year\n  }\n});"},"children":[],"expanded":false,"type":"button"},{"configs":{"tagConfigs":"columnWidth:0.08","text":"{#reset#}","margin":"0 0 0 20","itemId":"resetBtn","iconCls":"refresh_icon","y":"10"},"events":{"click":"app.fa_ledger.reset();\napp.query_fa_period_year.reset();\n//设置显示当前年度\n// app.query_ld_period_year.setValue(Ext.Date.format(new Date(),'Y'));\napp.fa_period_grid.store.load();"},"children":[],"expanded":false,"type":"button"}],"expanded":true,"type":"panel"}],"expanded":true,"type":"form"},{"configs":{"region":"center","itemId":"fa_period_grid","editable":"true"},"children":[{"configs":{"autoLoad":"false","itemId":"store","url":"m?xwl=xc/fa/ld-base/fa-ld-period/data/select_fa_period"},"children":[],"expanded":false,"type":"store"},{"configs":{"itemId":"tbar"},"children":[{"configs":{"text":" {#sync#}","itemId":"sync","iconCls":"record_copy_icon"},"events":{"click":"if(app.fa_ledger.getValue()===null){\n  Wb.toast('{#selectBo#}');\n  return false;\n}\n\n// 资产账簿的参数设置时的启用会计期没有值时，不允许进行会计期同步\nExt.Msg.wait('');\nvar _flag = true;\nExt.Ajax.request({\n  url : 'm?xwl=xc/fa/ld-base/fa-ld-period/data/checkSettingEnablePeriod',\n  method: 'POST',\n  async:false,\n  params:{ledger: app.fa_ledger.getValue()},\n  success: function(response,options){\n    Ext.Msg.hide();\n    var resp = Ext.JSON.decode(response.responseText);\n\n    if(resp.CNT==0){\n      _flag = false;\n    }\n  },\n  failure: function(response,options){\n    Ext.Msg.hide();\n    Wb.error('{#requestFailure#}');\n  }\n});\n\nif(_flag==false){\n  Wb.toast('{#checkEnablePeriod#}');\n  return;\n}\n\nvar win = new Ext.window.Window(app._window1); //app._win指向配置对象而非实例\nwin.show();\nwin.setIconCls('record_add_icon');\nWb.setTitle(win, '{#sync#}');\n\napp.ld_period_grid.store.load({params:{ledger_id:app.fa_ledger.getValue()}\n                              \n                              });\napp.ledgerIdText.setValue(app.fa_ledger.getValue());//ledgerIdText赋值"},"children":[],"expanded":true,"type":"button"},{"configs":{"text":"{#openPeriod#}","itemId":"open","iconCls":"open_icon"},"events":{"click":"/**\n  期间打开规则: \n    1、只能打开未打开的 \n    2、只有全部关闭之后才能打开未打开的 \n    3、打开期间时，需要验证要打开的期间的前一个期间是否关闭，如果关闭，则可以打开（简而言之，期间必须按照时间顺序打开，不能跳跃打开）\n**/\n\nvar rows = app.fa_period_grid.getSelection();\n/*----------同一个账簿下只能有一个打开会计期----*/\nif (rows.length === 0) {\n  Wb.toast('{#selRecord#}');\n  return false;\n}\n\nif (rows.length !== 1) {\n  Wb.toast('{#oneRecord#}');\n  return false;\n}\n\nif(rows[0].data.STATUS==1 || rows[0].data.STATUS==2){\n  Wb.toast('{#openCheck#}');\n  return;\n}\n\nWb.request({\n  url: 'm?xwl=xc/fa/ld-base/fa-ld-period/data/setDefault',\n  params: {\n    LD_PERIOD_ID: rows[0].data.LD_PERIOD_ID,\n    LEDGER_ID: rows[0].data.LEDGER_ID,\n    PERIOD: rows[0].data.PERIOD_CODE\n  },\n  success: function(response) {\n    Wb.reload(app.fa_period_grid);\n  }\n});\n\n/*if (rows[0].data.STATUS === '0'){\n  app.queryOpenStore.load({\n    params: {\n      LEDGER_ID: rows[0].data.LEDGER_ID\n    },\n    callback: function() {\n      var a = app.queryOpenStore.getCount();\n\n      if (a > 0) {\n        Wb.toast('{#openCheckRecord#}');\n        return false;\n      } else {\n        Wb.request({\n          url: 'm?xwl=xc/fa/ld-base/fa-ld-period/data/setDefault',\n          params: {\n            LD_PERIOD_ID: rows[0].data.LD_PERIOD_ID,\n            LEDGER_ID: rows[0].data.LEDGER_ID\n          },\n          success: function(response) {\n            Wb.reload(app.fa_period_grid);\n          }\n        });\n      }\n    }\n  });\n}*/"},"children":[],"expanded":false,"type":"button"},{"configs":{"text":"{#cloasePeriod#}","itemId":"close","iconCls":"close_icon"},"events":{"click":"var rows = app.fa_period_grid.getSelection();\n/*----------同一个账簿下只能有一个打开会计期----*/\nif(rows.length === 0){\n  Wb.toast('{#selRecord#}');\n  return false;\n}\nif(rows.length !==1){\n  Wb.toast('{#oneRecord#}');\n  return false;\n}\nif(rows[0].data.STATUS === '0'){\n  Wb.toast('{#notOpen#}');\n  return false;\n}\nif(rows[0].data.STATUS === '2'){\n  Wb.toast('{#hashBeenClose#}');\n  return false;\n}\n\n/* \n  期间关闭校验规则\n    1、没有未计提折旧的资产\n    2、本期间的凭证接口的数据都已经生成凭证\n    3、本期间调整单都已经提交\n*/\n/*Wb.request({\n  async:false,\n  url : 'm?xwl=xc/fa/ld-base/fa-ld-period/data/closeCheck',\n  params: {\n    PERIOD_CODE : rows[0].data.PERIOD_CODE,\n    LEDGER_ID : rows[0].data.LEDGER_ID\n  },\n  success:function(response){\n  }\n});*/\n\nWb.request({\n     url : 'm?xwl=xc/fa/ld-base/fa-ld-period/data/setDefaultClose',\n     params: {\n       LD_PERIOD_ID:rows[0].data.LD_PERIOD_ID,\n       PERIOD_CODE : rows[0].data.PERIOD_CODE,\n       LEDGER_ID : rows[0].data.LEDGER_ID\n     },\n     success:function(response){\n      Wb.reload(app.fa_period_grid);\n     }\n});"},"children":[],"expanded":false,"type":"button"}],"expanded":true,"type":"toolbar"},{"configs":{"itemId":"columns"},"children":[{"configs":{"text":"{#no#}","xtype":"rownumberer","width":"50","align":"center","titleAlign":"center","itemId":"period_row"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"ID","hidden":"true","dataIndex":"LD_PERIOD_ID","itemId":"LD_PERIOD_ID_col"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"账薄ID","hidden":"true","dataIndex":"LEDGER_ID","itemId":"ledger_id_col"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#classCode#}","width":"100","dataIndex":"PERIOD_CODE","titleAlign":"left","itemId":"period_code_col"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#year#}","width":"60","dataIndex":"YEAR","titleAlign":"left","itemId":"year_col"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#start#}","width":"100","dataIndex":"START_DATE","titleAlign":"left","itemId":"start_date_col"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#end#}","width":"100","dataIndex":"END_DATE","titleAlign":"left","itemId":"end_date_col"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"调整期","hidden":"true","dataIndex":"IS_ADJ_PERIOD","titleAlign":"left","itemId":"is_adj_period_col","renderer":"if(value==='N')\n  return '否';\nif(value==='Y')\n  return '是';"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#status#}","width":"100","dataIndex":"STATUS","titleAlign":"left","itemId":"ld_period_status_col","renderer":"//改变显示值\nif(value==1){\n   \n  return '{#open#}';\n}else if(value==2){\n  return '{#close#}';\n  \n}else if(value==0){\n  return '{#lastingClose#}';\n}"},"children":[],"expanded":true,"type":"column"}],"expanded":true,"type":"array"}],"expanded":true,"type":"grid"}],"expanded":true,"type":"viewport"}],"expanded":true,"type":"module"}],"pageLink":"","iconCls":""}