{"inframe":false,"title":"","hidden":false,"roles":{"default":1},"children":[{"configs":{"serverScript":"// 获取模块语言对应的json文件\ncom.xzsoft.xip.platform.util.XipUtil.getCurrentLang(request,\"xc/fa/report/xc_fa_zcmxz/xc_fa_zcmxz\");\n\nrequest.setAttribute('contextPath',request.getContextPath());\n\nvar dbType = com.xzsoft.xip.platform.util.PlatformUtil.getDbType() ;\nvar language = request.getSession().getAttribute(\"XzSessionVars\").get(\"language\");\n\nrequest.setAttribute(\"dbType\",dbType);\nrequest.setAttribute(\"language\",language);\n","itemId":"module"},"events":{"finalize":"app.treeFirstLoad = true;//树是否是第一次加载"},"children":[{"configs":{"layout":"border","itemId":"viewport1"},"children":[{"configs":{"region":"north","itemId":"queryForm"},"children":[{"configs":{"layout":"column","margin":"10 0 10 0","border":"false","itemId":"tr1"},"children":[{"configs":{"layout":"column","columnWidth":"0.33","border":"false","itemId":"tr1_td1"},"children":[{"configs":{"width":"80","html":"<font color='red'>*<\/font>{#LEDGER#}：","labelAlign":"right","itemId":"label1"},"children":[],"expanded":false,"type":"label"},{"configs":{"allowBlank":"false","displayField":"LEDGER_NAME","valueField":"LEDGER_ID","columnWidth":"1","emptyText":"{#qxxzzb#}","itemId":"LEDGER_ID","editable":"false"},"events":{"change":"app.DEPT_ID.reset();\napp.PERIOD_START.reset();\napp.PERIOD_END.reset();\napp.ASSET_ATTRIBUTE.reset();\napp.CAT_CODE.reset();"},"children":[{"configs":{"pageSize":"-1","autoLoad":"true","itemId":"store","url":"m?xwl=xc/fa/report/xc_fa_zcmxz/DB/get_ledger"},"children":[],"expanded":false,"type":"store"}],"expanded":false,"type":"combo"}],"expanded":false,"type":"panel"},{"configs":{"layout":"column","columnWidth":"0.33","border":"false","itemId":"tr1_td2"},"children":[{"configs":{"width":"80","html":"<font color='red'>*<\/font>{#PERIOD#}：","labelAlign":"right","itemId":"label1"},"children":[],"expanded":false,"type":"label"},{"configs":{"allowBlank":"false","displayField":"PERIOD_CODE","valueField":"PERIOD_CODE","columnWidth":"0.5","itemId":"PERIOD_START","editable":"false"},"children":[{"configs":{"pageSize":"-1","itemId":"store","url":"m?xwl=xc/fa/report/xc_fa_zcmxz/DB/get_period"},"events":{"beforeload":"var ledgerId = app.LEDGER_ID.getValue();\nvar periodEnd = app.PERIOD_END.getValue();\n\nif(Wb.isEmpty(ledgerId)){\n  Wb.toast(\"{#qxxzzb#}\");//请先选择账簿！\n  return false;\n}else{\n  operation.params = {\n    LEDGER_ID : ledgerId,\n    PERIOD_END : periodEnd\n  };\n}"},"children":[],"expanded":false,"type":"store"}],"expanded":false,"type":"combo"},{"configs":{"text":"{#TO#}","width":"20","html":"{#TO#}","labelAlign":"center","itemId":"label11"},"children":[],"expanded":false,"type":"label"},{"configs":{"allowBlank":"false","displayField":"PERIOD_CODE","valueField":"PERIOD_CODE","columnWidth":"0.5","itemId":"PERIOD_END","editable":"false"},"children":[{"configs":{"pageSize":"-1","itemId":"store","url":"m?xwl=xc/fa/report/xc_fa_zcmxz/DB/get_period"},"events":{"beforeload":"var ledgerId = app.LEDGER_ID.getValue();\nvar periodStart = app.PERIOD_START.getValue();\n\nif(Wb.isEmpty(ledgerId)){\n  Wb.toast(\"{#qxxzzb#}\");//请先选择账簿！\n  return false;\n}else{\n  operation.params = {\n    LEDGER_ID : ledgerId,\n    PERIOD_START : periodStart\n  };\n}"},"children":[],"expanded":false,"type":"store"}],"expanded":false,"type":"combo"}],"expanded":false,"type":"panel"},{"configs":{"layout":"column","columnWidth":"0.33","border":"false","itemId":"tr1_td3"},"children":[{"configs":{"width":"80","html":"{#DEPT#}：","labelAlign":"right","itemId":"label1"},"children":[],"expanded":false,"type":"label"},{"configs":{"displayField":"DEPT_NAME","valueField":"DEPT_ID","columnWidth":"1","itemId":"DEPT_ID"},"children":[{"configs":{"pageSize":"-1","itemId":"store","url":"m?xwl=xc/fa/report/fa_dgzcmxz/data/select-dept-info-by-ledger"},"events":{"beforeload":"var ledgerId = app.LEDGER_ID.getValue();\n\nif(Wb.isEmpty(ledgerId)){\n  Wb.toast(\"{#qxxzzb#}\");//请先选择账簿！\n  return false;\n}else{\n  operation.params = {\n    ledgerId : ledgerId\n  };\n}"},"children":[],"expanded":false,"type":"store"}],"expanded":true,"type":"combo"}],"expanded":false,"type":"panel"}],"expanded":true,"type":"panel"},{"configs":{"layout":"column","margin":"0 0 10 0","border":"false","itemId":"tr2"},"children":[{"configs":{"layout":"column","columnWidth":"0.33","border":"false","itemId":"tr2_td1"},"children":[{"configs":{"width":"80","html":"<font color='red'>*<\/font>{#AssetAttributes#}：","labelAlign":"right","itemId":"label1"},"children":[],"expanded":false,"type":"label"},{"configs":{"allowBlank":"false","displayField":"VAL_NAME","valueField":"VAL_CODE","columnWidth":"1","itemId":"ASSET_ATTRIBUTE","editable":"false"},"events":{"change":"//资产属性值改变的时候，需要清空资产分类的相关值\napp.CAT_ID.setValue();\napp.CAT_CODE.setValue();\napp.CAT_CODE_NAME.setValue();"},"children":[{"configs":{"pageSize":"-1","autoLoad":"true","itemId":"store","url":"m?xwl=xc/fa/report/xc_fa_zcmxz/DB/getFaProperty"},"events":{"success":"// var assetAttribute = app.ASSET_ATTRIBUTE.getValue();\n\n// if(Wb.isEmpty(assetAttribute)){\n//   app.ASSET_ATTRIBUTE.setValue(records[0].data.VAL_CODE);\n// }"},"children":[],"expanded":false,"type":"store"}],"expanded":true,"type":"combo"}],"expanded":false,"type":"panel"},{"configs":{"layout":"column","columnWidth":"0.33","border":"false","itemId":"tr2_td2"},"children":[{"configs":{"itemId":"CAT_ID"},"children":[],"expanded":false,"type":"hidden"},{"configs":{"itemId":"CAT_CODE"},"children":[],"expanded":false,"type":"hidden"},{"configs":{"width":"80","html":"{#FA_CAT#}：","labelAlign":"right","itemId":"label1"},"children":[],"expanded":false,"type":"label"},{"configs":{"tagConfigs":"{\n   columnWidth : 1\n}","itemId":"CAT_CODE_NAME"},"events":{"expand":"//判断是否是第一次加载，如果是第一次加载，则不需要再次加载，否则数据会重复（我也不清楚这是为什么）\nif(app.treeFirstLoad){\n  app.treeFirstLoad = false;\n  return false;\n}\napp.tree.store.load();"},"children":[{"configs":{"rootVisible":"false","tagConfigs":"{\n  minWidth : 300,\n  maxHeight : 500\n}","multiSelect":"true","normalName":"tree","itemId":"pickComp"},"events":{"itemdblclick":"var catId = record.data.id;\nvar catCode = record.data.CAT_CODE;\nvar catName = record.data.text;\napp.CAT_ID.setValue(catId);\napp.CAT_CODE.setValue(catCode);\napp.CAT_CODE_NAME.setValue(catName);\napp.CAT_CODE_NAME.collapse();\n"},"children":[{"configs":{"autoLoad":"true","itemId":"store","url":"m?xwl=xc/fa/report/xc_fa_zcmxz/DB/getFaCats"},"events":{"load":"app.tree.expandAll(function(){});","beforeload":"var assetAttribute = app.ASSET_ATTRIBUTE.getValue();\nif(Wb.isEmpty(assetAttribute)){\n  Wb.toast(\"{#qxxzzcsx#}\");\n  return false;\n}\n\nvar node = operation.node;\noperation.params.UP_CODE = node.isRoot() ? (assetAttribute+\"_ROOT\") : operation.node.data.CAT_CODE;\n"},"children":[],"expanded":false,"type":"treestore"}],"expanded":true,"type":"tree"}],"expanded":true,"type":"picker"}],"expanded":false,"type":"panel"},{"configs":{"layout":"column","columnWidth":"0.33","border":"false","itemId":"tr2_td3"},"children":[{"configs":{"width":"80","itemId":"space"},"children":[],"expanded":false,"type":"label"},{"configs":{"text":"{#QUERY#}","itemId":"queryBtn","iconCls":"seek_icon"},"events":{"click":"//验证必填项是否为空\nif(!Wb.verify(app.queryForm)){\n    Wb.toast(\"{#qtxsybtx#}\");\n    return false;\n}\n\nvar ledgerId = app.LEDGER_ID.getValue();\nvar ledgerRecord = app.LEDGER_ID.getStore().findRecord(\"LEDGER_ID\",ledgerId);\nvar orgName = ledgerRecord.data.ORG_NAME;\nvar periodStart = app.PERIOD_START.getValue();\nvar periodEnd = app.PERIOD_END.getValue();\nvar deptId = app.DEPT_ID.getValue();\nvar assetAttribute = app.ASSET_ATTRIBUTE.getValue();\nvar catCode = app.CAT_CODE.getValue();\n\n//获取上一个会计期\nvar lastPeriod = null;\nvar store = app.PERIOD_START.store;\nvar count = store.getCount();\nfor(var i = 0;i < count;i++){\n    if(store.getAt(i).data.PERIOD_CODE == app.PERIOD_START.getValue() && (i - 1) >= 0)\n\t\tlastPeriod = store.getAt(i-1).data.PERIOD_CODE;\n}\nvar sql = \"\";//待拼接的sql\n\n//成本中心\nif(!Wb.isEmpty(deptId)){\n    sql += \" AND a.CBZX = '\"+deptId+\"'\";\n}\n\n//资产属性、资产分类\nif(!Wb.isEmpty(assetAttribute)){\n    sql += \" AND a.FA_PROPERTY = '\"+assetAttribute+\"'\";\n    //被选中的当前节点\n    var catCodes = \"\";//当前节点下的所有资产分类（用,隔开）\n    if(!Wb.isEmpty(catCode)){\n        var first = true;\n        var currentNode = app.tree.store.getNodeById(app.CAT_ID.getValue());\n        // cascadeby 遍历该节点下的所有节点（包括自己）\n        currentNode.cascadeBy(function(node){\n            if(node.isLeaf()){\n              if(first){\n                  catCodes += \"'\"+node.data.CAT_CODE+\"'\";\n                  first = false;\n              }else{\n                  catCodes += \",'\"+node.data.CAT_CODE+\"'\";\n              }\n            }\n        });\n    }\n\n    if(!Wb.isEmpty(catCodes)){\n        sql += \" AND a.CAT_CODE IN (\"+catCodes+\")\";\n    }\n}\n\n//参数\nvar map = new Ext.util.HashMap();\nmap.add(\"LEDGER_ID\",ledgerId);\nmap.add(\"ORG_NAME\",orgName);\nmap.add(\"lastPeriod\",lastPeriod);\nmap.add(\"PERIOD_START\",Wb.dateToStr(periodStart));\nmap.add(\"PERIOD_END\",Wb.dateToStr(periodEnd));\nmap.add(\"dbType\",\"{#dbType#}\");\nmap.add(\"language\",\"{#language#}\");\nmap.add('query',\"click\");\nmap.add(\"sql\",sql);\n\nvar targetUrl = \"{#contextPath#}/ReportServer?reportlet=xc_fa/XC_FA_ZCMXZ.cpt&language={#language#}&__bypagesize__=false\";\nvar reportPanel = document.getElementById(\"reportPanel\");\nvar params = \"\";\nmap.each(function(key, value, length){\n  params += \"&\" + key + \"=\" + value;\n});\nreportPanel.src = targetUrl + params;\n"},"children":[],"expanded":false,"type":"button"},{"configs":{"width":"20","itemId":"space1"},"children":[],"expanded":false,"type":"label"},{"configs":{"text":"{#RESET#}","itemId":"resetBtn","iconCls":"refresh_icon"},"events":{"click":"app.queryForm.getForm().reset();\n\n//没有参数的查询\nvar map = new Ext.util.HashMap();\nmap.add(\"dbType\",\"{#dbType#}\");\nmap.add(\"language\",\"{#language#}\");\nvar targetUrl = \"{#contextPath#}/ReportServer?reportlet=xc_fa/XC_FA_ZCMXZ.cpt&language={#language#}&__bypagesize__=false\";\nvar reportPanel = document.getElementById(\"reportPanel\");\nvar params = \"\";\nmap.each(function(key, value, length){\n  params += \"&\" + key + \"=\" + value;\n});\nreportPanel.src = targetUrl + params;\n"},"children":[],"expanded":false,"type":"button"}],"expanded":true,"type":"panel"}],"expanded":true,"type":"panel"}],"expanded":true,"type":"form"},{"configs":{"region":"center","layout":"fit","html":"<iframe  scrolling=auto frameborder=0 width=100% height=100% id=reportPanel src='{#contextPath#}/ReportServer?reportlet=xc_fa/XC_FA_ZCMXZ.cpt&language={#language#}&__bypagesize__=false'><\/iframe>\n","itemId":"reportPanel"},"children":[],"expanded":false,"type":"panel"}],"expanded":true,"type":"viewport"}],"expanded":true,"type":"module"}],"pageLink":"","iconCls":""}