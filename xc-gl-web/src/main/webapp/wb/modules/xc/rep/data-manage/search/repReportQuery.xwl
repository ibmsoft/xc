{"inframe":false,"title":"报表查询","hidden":false,"roles":{"default":1},"children":[{"configs":{"cssLinks":"[\"xip/es/EnterpriseSheet/resources/css/common.css\", \"xip/es/EnterpriseSheet/resources/css/sheet.css\", \"xip/es/EnterpriseSheet/resources/css/toolbar.css\"]","initScript":"request.setAttribute('contenxtPath',request.getContextPath());\ncom.xzsoft.xip.platform.util.XipUtil.getCurrentLang(request,\"xc/rep/data-manage/search/repReportQuery\");","jsLinks":"[\"xip/es/EnterpriseSheet/src/EnterpriseSheet/Config.js\", \"xip/es/EnterpriseSheet/src/language/zh_CN.js\", \"xip/es/EnterpriseSheet/enterprisesheet.js\", \"xip/es/EnterpriseSheet/templates/CenterPanel.js\"]","itemId":"module"},"events":{"finalize":"/*\n *定义Enterprise Sheet 的tabChange事件\n *切换tab页签时，根据页签的sheetId获取要查询的报表的id\n */\nvar reportSheet = SHEET_API_HD.sheet, \n    reportStore = reportSheet.getStore();\nreportSheet.on({\n  scope: this,\n  'switchsheet': function(oldSheetId, sheetId) {\n    Ext.Msg.wait('数据加载中，请稍后....');\n    var win_querySheetId = orderMap.get(sheetId);\n    Wb.request({\n        url:'{#contenxtPath#}/xCRepFormulaManageAction.do?method=loadSheet',\n        params:{'sheetIds':openArray,'querySheetId':win_querySheetId},\n        showMask:false,\n        success:function(response,options){\n          var returnObj = Wb.decode(response.responseText);\n          var json = {\n             fileName    : returnObj.fileName,\n             sheets      : returnObj.sheets,\n             cells       : returnObj.cells,\n             floatings   : returnObj.floatings,\n             sheetReflect:returnObj.sheetReflect\n           };\n          //记录打开报表的顺序,记录顺序前先清空于map中的顺序\n           var reflectObj = Wb.decode(returnObj.sheetReflect);\n           orderMap.clear();\n           Ext.each(reflectObj,function(item){\n             orderMap.add(item.tabOrder,item.sheetId);\n           });\n          SHEET_API.loadData(SHEET_API_HD, json, function(){\n            //加载单元格数据\n            SHEET_API.updateCells(SHEET_API_HD, returnObj.formulas);\n          }, this);\n         Ext.Msg.hide();\n        },\n        failure:function(response,options){\n          Ext.Msg.hide();\n          Wb.info('加载报表失败！');\n        }\n  });\n }\n});","initialize":"/*\n *全局查询凭借条件\n */\nvar whereSql = '';\n//记录要打开报表的arry\nvar openArray ='';\n//记录报表顺序的Map\nvar orderMap = new Ext.util.HashMap();\n/*\n *Enterprise Sheet Initialize\n */\nSCONFIG.setupDir('');\nSHEET_API = Ext.create('EnterpriseSheet.api.SheetAPI', {\n  openFileByOnlyLoadDataFlag: true\n});\nSHEET_API_HD = SHEET_API.createSheetApp({\n  withoutTitlebar: true,\n  withoutSheetbar: false,\n  withoutToolbar: true,\n  withoutContentbar: false,\n  withoutSidebar: true,\n  style: 'background:white;border-left:1px solid silver;',\n  height: '100%'\n});\nvar globalSheetPanel = Ext.create('enterpriseSheet.templates.CenterPanel', {\n    border : false \n});"},"children":[{"configs":{"itemId":"windows"},"children":[{"configs":{"maximized":"true","title":"{#la_reportTitle#}","layout":"fit","minimizable":"true","closeAction":"hide","itemId":"reportShowWin","modal":"true","createInstance":"false","maximizable":"true"},"children":[{"configs":{"region":"center","layout":"fit","itemId":"sheetPanel"},"events":{"beforerender":"app.viewport.suspendLayouts();\napp.sheetPanel.add(globalSheetPanel);\napp.viewport.doLayout();"},"children":[],"expanded":true,"type":"panel"}],"expanded":true,"type":"window"},{"configs":{"title":"{#la_exportTypeTip#}","height":"120","layout":"fit","width":"300","closeAction":"hide","buttonAlign":"center","dialog":"true","itemId":"exportWin","createInstance":"false"},"children":[{"configs":{"frame":"true","style":"border-style:none","layout":"form","border":"false","itemId":"exportPanel","y":"10"},"children":[{"configs":{"labelWidth":"100","value":"LEDGER","pickList":"[['LEDGER','{#la_ledgerExport#}'],['MODAL','{#la_moduleExport#}']]","labelAlign":"right","itemId":"expExcelType"},"children":[],"expanded":true,"type":"combo"}],"expanded":true,"type":"panel"},{"configs":{"itemId":"buttons"},"children":[{"configs":{"text":"{#la_confirmBtn#}","itemId":"exportConfirmBtn","iconCls":"ok_icon"},"events":{"click":"/*\n *批量导出所选择的报表\n */\nvar records = app.reportGrid.getSelection();\nif(records.length === 0){\n  Wb.info('{#la_selectTip#}');\n  return false;\n}\nvar expType = app.expExcelType.getValue();\nvar sheetArry = [];\nWb.each(records,function(item){\n  sheetArry.push(item.data.SHEET_ID);\n});\nExt.Msg.wait('{#la_exportMsg#}');\nWb.request({\n  url:'{#contenxtPath#}'+'/xcRepSheetExportAction.do?method=exportSheetExcel',\n  params:{'exportType' : expType,\n          'sheetIds': sheetArry.join(',')\n         },\n  timeout:60*60*1000,\n  success:function(resp){\n    Ext.Msg.hide();\n    var resultObj = Wb.decode(resp.responseText);\n    if(resultObj.flag === '0'){\n      Wb.download('{#contenxtPath#}'+'/xcRepSheetExportAction.do?method=exportSheetZip', \n                  {'fileName' : resultObj.fileName,'filePath':resultObj.filePathAndName,'delFolderPath':resultObj.delFolder\n                  },false);\n      app.exportWin.close();\n    }else{\n      Wb.info(resultObj.msg);\n    }\n  },\n  failure:function(resp){\n     Wb.info('{#la_exportFailure#}');\n  }\n});"},"children":[],"expanded":false,"type":"button"}],"expanded":true,"type":"array"}],"expanded":true,"type":"window"}],"expanded":false,"type":"folder"},{"configs":{"layout":"border","itemId":"viewport"},"children":[{"configs":{"region":"north","height":"220","layout":"border","split":"true","itemId":"northPanel","border":"false"},"children":[{"configs":{"region":"west","frame":"false","width":"'45%'","itemId":"westPanel","bodyPadding":"5","border":"false"},"children":[{"configs":{"style":"border-width:0px","layout":"column","bodyPadding":"10","itemId":"tr1","border":"false"},"children":[{"configs":{"tagConfigs":"baseCls:'my-panel-no-border'","layout":"form","columnWidth":"1","itemId":"tr0.0","border":"false"},"children":[{"configs":{"labelWidth":"{#la_labelWidth#}","displayField":"ACC_HRCY_NAME","valueField":"ACC_HRCY_ID","labelAlign":"right","itemId":"queryAccHrcyId","fieldLabel":"{#la_accHrcyName#}"},"events":{"select":"app.querySheetTab.clearValue();\napp.querySheetTab.getStore().load();","beforequery":"var combo = plan.combo;\nif (!plan.forceAll) {\n  var value = plan.query;\n  combo.store.filterBy(function(record, id) {\n    var text = record.get(combo.displayField);\n    return (text.indexOf(value) != -1);\n  });\n  combo.expand();\n  return false;\n}"},"children":[{"configs":{"pageSize":"-1","itemId":"store","autoLoad":"true","url":"m?xwl=xc/rep/data-manage/search/db/select-sheet-accHrcy"},"events":{"load":"if(store.getCount() == 1){\n  var r = records[0].data ;\n  Wb.setValue(app.queryAccHrcyId, {'queryAccHrcyId':r.ACC_HRCY_ID}) ;\n}"},"children":[],"expanded":false,"type":"store"}],"expanded":true,"type":"combo"}],"expanded":true,"type":"panel"},{"configs":{"tagConfigs":"baseCls:'my-panel-no-border'","layout":"form","columnWidth":"1","itemId":"tr1.1","border":"false"},"children":[{"configs":{"labelWidth":"{#la_labelWidth#}","displayField":"TAB_NAME","valueField":"TAB_ID","emptyText":"{#la_allTip#}","labelAlign":"right","itemId":"querySheetTab","fieldLabel":"{#la_moduleName#}"},"events":{"change":"\n\n\n","beforequery":"var combo = plan.combo;\nif (!plan.forceAll) {\n  var value = plan.query;\n  combo.store.filterBy(function(record, id) {\n    var text = record.get(combo.displayField);\n    return (text.indexOf(value) != -1);\n  });\n  combo.expand();\n  return false;\n}"},"children":[{"configs":{"pageSize":"-1","itemId":"store","autoLoad":"true","url":"m?xwl=xc/rep/data-manage/search/db/select-sheet-tab"},"events":{"beforeload":"store.getProxy().extraParams.accHrcyId = app.queryAccHrcyId.getValue();"},"children":[],"expanded":false,"type":"store"}],"expanded":true,"type":"combo"}],"expanded":true,"type":"panel"},{"configs":{"tagConfigs":"baseCls:'my-panel-no-border'","layout":"form","columnWidth":"1","itemId":"tr2.1","border":"false"},"children":[{"configs":{"labelWidth":"{#la_labelWidth#}","displayField":"CURRENCY_NAME","valueField":"CURRENCY_CODE","emptyText":"{#la_allTip#}","labelAlign":"right","itemId":"queryCny","fieldLabel":"{#la_currency#}"},"events":{"beforequery":"var combo = plan.combo;\nif (!plan.forceAll) {\n  var value = plan.query;\n  combo.store.filterBy(function(record, id) {\n    var text = record.get(combo.displayField);\n    return (text.indexOf(value) != -1);\n  });\n  combo.expand();\n  return false;\n}"},"children":[{"configs":{"pageSize":"-1","itemId":"store","autoLoad":"true","url":"m?xwl=xc/rep/base-settings/formulas/collection-formulas/db/select-formula-currnecy"},"children":[],"expanded":false,"type":"store"}],"expanded":true,"type":"combo"}],"expanded":true,"type":"panel"},{"configs":{"tagConfigs":"baseCls:'my-panel-no-border'","layout":"form","columnWidth":"1","itemId":"tr5.1","border":"false"},"children":[{"configs":{"labelWidth":"{#la_labelWidth#}","allowBlank":"false","format":"Y-m","labelAlign":"right","itemId":"startPeriod","fieldLabel":"{#la_startPeriod#}"},"events":{"afterrender":"date.setValue(new Date()) ;"},"children":[],"expanded":false,"type":"date"}],"expanded":true,"type":"panel"},{"configs":{"tagConfigs":"baseCls:'my-panel-no-border'","layout":"form","columnWidth":"1","itemId":"tr6.1","border":"false"},"children":[{"configs":{"labelWidth":"{#la_labelWidth#}","allowBlank":"false","format":"Y-m","labelAlign":"right","itemId":"endPeriod","fieldLabel":"{#la_endPeriod#}"},"events":{"afterrender":"date.setValue(new Date()) ;"},"children":[],"expanded":false,"type":"date"}],"expanded":true,"type":"panel"},{"configs":{"tagConfigs":"baseCls:'my-panel-no-border'","layout":"form","columnWidth":"1","itemId":"tr3.1","border":"false"},"children":[{"configs":{"labelWidth":"{#la_labelWidth#}","labelAlign":"right","itemId":"sheetDesc","fieldLabel":"{#la_reportDesc#}"},"children":[],"expanded":false,"type":"text"}],"expanded":true,"type":"panel"},{"configs":{"tagConfigs":"baseCls:'my-panel-no-border'","layout":"form","columnWidth":".35","itemId":"tr7.1","border":"false"},"children":[{"configs":{"itemId":"label1"},"children":[],"expanded":false,"type":"label"}],"expanded":true,"type":"panel"},{"configs":{"tagConfigs":"baseCls:'my-panel-no-border'","layout":"form","columnWidth":".15","itemId":"tr7.2","border":"false"},"children":[{"configs":{"text":"{#queryBtn#}","width":"65","itemId":"reportQuery","iconCls":"seek_icon"},"events":{"click":"if(!app.tr1.getForm().isValid()){\n  Wb.info('{#la_requiredMsg#}');\n  return ;\n}\nvar _rows = app.queryLedgerGrid.getSelection();\nif(_rows.length === 0){\n  Wb.info('{#la_selectLedgerMsg#}');\n  return ;\n}\nvar ledgerArray = [];\nExt.each(_rows,function(item){\n  ledgerArray.push('\\''+item.get('LEDGER_ID')+'\\'');\n});\napp.reportGrid.getStore().load({\n  params:{\n    'ledgerIds':ledgerArray.join(',')\n  }\n});\n\n"},"children":[],"expanded":false,"type":"button"}],"expanded":true,"type":"panel"},{"configs":{"tagConfigs":"baseCls:'my-panel-no-border'","layout":"form","columnWidth":".15","itemId":"tr7.3","border":"false"},"children":[{"configs":{"text":"{#resetBtn#}","width":"65","itemId":"reportReset","iconCls":"refresh_icon"},"events":{"click":"app.reportGrid.getStore().removeAll();\napp.queryLedgerName.setValue('');\napp.queryLedgerGrid.getStore().load();"},"children":[],"expanded":false,"type":"button"}],"expanded":true,"type":"panel"},{"configs":{"tagConfigs":"baseCls:'my-panel-no-border'","layout":"form","columnWidth":".35","itemId":"tr7.4","border":"false"},"children":[{"configs":{"itemId":"label2"},"children":[],"expanded":false,"type":"label"}],"expanded":true,"type":"panel"}],"expanded":true,"type":"form"}],"expanded":true,"type":"panel"},{"configs":{"region":"center","layout":"fit","split":"true","itemId":"centerPanel","border":"false"},"children":[{"configs":{"pagingBar":"false","selType":"checkboxmodel","itemId":"queryLedgerGrid"},"children":[{"configs":{"pageSize":"-1","itemId":"store","autoLoad":"true","url":"m?xwl=xc/rep/data-manage/search/db/select_ledger_org"},"events":{"beforeload":"var fuzzyLedger = app.queryLedgerName.getValue();\nif(Ext.isEmpty(fuzzyLedger)){\n  fuzzyLedger ='%%';\n}else{\n  fuzzyLedger = '%'+fuzzyLedger+'%';\n}\nstore.getProxy().extraParams.ledgerName = fuzzyLedger;"},"children":[],"expanded":false,"type":"store"},{"configs":{"itemId":"tbar"},"children":[{"configs":{"labelWidth":"100","width":"300","labelAlign":"right","itemId":"queryLedgerName","fieldLabel":"{#la_ledgerName#}"},"events":{"specialkey":"if (e.getKey() == Ext.EventObject.ENTER) {\n  app.ledgerQuery.fireEvent('click');\n}"},"children":[],"expanded":false,"type":"text"},{"configs":{"text":"-","itemId":"item1"},"children":[],"expanded":false,"type":"item"},{"configs":{"itemId":"ledgerQuery","iconCls":"seek_icon"},"events":{"click":"app.queryLedgerGrid.getStore().load();"},"children":[],"expanded":false,"type":"button"}],"expanded":true,"type":"toolbar"},{"configs":{"itemId":"columns"},"children":[{"configs":{"text":"公司ID","hidden":"true","dataIndex":"ORG_ID","itemId":"ORG_ID_COL"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#la_ledgerName#}","dataIndex":"LEDGER_NAME","itemId":"LEDGER_NAME_COL","flex":"4"},"children":[],"expanded":true,"type":"column"},{"configs":{"text":"{#la_orgCode#}","dataIndex":"ORG_CODE","itemId":"ORG_CODE_COL","flex":"2"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#la_orgName#}","dataIndex":"ORG_NAME","itemId":"ORG_NAME_COL","flex":"4"},"children":[],"expanded":true,"type":"column"}],"expanded":false,"type":"array"}],"expanded":true,"type":"grid"}],"expanded":true,"type":"panel"}],"expanded":true,"type":"panel"},{"configs":{"region":"center","selType":"checkboxmodel","itemId":"reportGrid","border":"false"},"children":[{"configs":{"itemId":"store","url":"m?xwl=xc/rep/data-manage/search/db/selectReportData"},"events":{"beforeload":"if(!Ext.isEmpty(app.querySheetTab.getValue())){\n  whereSql +=' AND t.TAB_ID =\\''+app.querySheetTab.getValue()+'\\''; \n}\nif(!Ext.isEmpty(app.queryCny.getValue())){\n   whereSql +=' AND t.CNY_CODE =\\''+app.queryCny.getValue()+'\\''; \n}\nif(!Ext.isEmpty(app.sheetDesc.getValue())){\n  whereSql +=' AND t.SHEET_DESC  like \\'%'+app.sheetDesc.getValue()+'%\\''; \n}\n\nif(Ext.isEmpty(whereSql))\n  whereSql = ' AND 1=1';\nstore.getProxy().extraParams.WHERESQL = whereSql;\n\nvar sPeriod = app.startPeriod.getValue() ;\nsPeriod = Wb.dateToStr(sPeriod).substr (0,7) ;\n\nvar ePeriod = app.endPeriod.getValue() ;\nePeriod = Wb.dateToStr(ePeriod).substr (0,7) ;\n\nstore.getProxy().extraParams.sPeriod = sPeriod ;\nstore.getProxy().extraParams.ePeriod = ePeriod ;"},"children":[],"expanded":false,"type":"store"},{"configs":{"itemId":"tbar"},"children":[{"configs":{"text":"{#la_openBtn#}","itemId":"openBtn","iconCls":"open_icon"},"events":{"click":"/*\n *@功能：打开报表\n *@注意点：1、允许同时打开多张报表；\n *        2、打开报表与公式设置类似；\n *@报表打开后的命名规则：\n *1、不同的公司，同一类报表<公司为A,B,C；报表为【资产负债表】>，打开报表后的页签名为【公司名称】\n *2、同一个公司，不同类报表<公司为A；表报为【资产负债表】、【利润表】>，打开报表后的页签名为【报表名】\n *3、不同公司，不同类报表，打开报表后的页签名为【公司名-报表名】\n *4、单张报表，打开后的页签名为【报表名】\n */\nvar wait = Ext.MessageBox.wait(\"{#la_processing#}\");\nvar records = app.reportGrid.getSelection();\nif (records.length === 0) {\n  Wb.warn('{#la_selectTip#}');\n  return false;\n}\nvar sheetArray = [];\nExt.each(records,function(item){\n  sheetArray.push(item.data.SHEET_ID);\n});\nopenArray = sheetArray.join();\nWb.request({\n  url:'{#contenxtPath#}/xCRepFormulaManageAction.do?method=loadSheet',\n  params:{'sheetIds':sheetArray.join(),'querySheetId':'-1'},\n  success:function(response,options){\n    var returnObj = Wb.decode(response.responseText);\n    var json = {\n       fileName    : returnObj.fileName,\n       sheets      : returnObj.sheets,\n       cells       : returnObj.cells,\n       floatings   : returnObj.floatings,\n       sheetReflect:returnObj.sheetReflect\n\t\t\t\t};\n    //记录打开报表的顺序,记录顺序前先清空于map中的顺序\n     orderMap.clear();\n     var tmpObj = Wb.decode(returnObj.sheetReflect);\n     Ext.each(tmpObj,function(item){\n       orderMap.add(item.tabOrder,item.sheetId);\n     });\n    //打开报表页面\n     var win = new Ext.window.Window(app._reportShowWin);\n     win.show(null,function(){\n        wait.hide();\n        SHEET_API.loadData(SHEET_API_HD, json, function(){\n          //加载单元格数据\n          SHEET_API.updateCells(SHEET_API_HD, returnObj.formulas);\n       }, this);\t\t\n    });\n  },\n  failure:function(response,options){\n    Wb.info('{#la_openFailure#}');\n  }\n});"},"children":[],"expanded":false,"type":"button"},{"configs":{"text":"{#la_delBtn#}","itemId":"delBtn","iconCls":"delete_icon"},"events":{"click":"var record = app.reportGrid.getSelection();\nif(record.length===0){\n  Wb.info(\"{#la_selectTip#}\");\n  return ;\n}\nvar lockedSheet=[];\nvar delArray = [] ;\nWb.each(record,function(item){\n  if(item.data.APP_STATUS === 'E'){\n    lockedSheet.push(item);\n  }else{\n    delArray.push(item) ;\n  }\n});\nif(lockedSheet.length>0){\n   Wb.info('{#la_reportLocked#}');\n  return false;\n}else{\n  Wb.confirm(\"{#la_confirmMsg#}\",function(){\n      //执行删除\n      Wb.request({\n       url: 'm?xwl=xc/rep/data-manage/search/db/delReport',\n       params: {\n         'destroy':Wb.getData(delArray)\n       },\n       success: function(resp) {\n         Wb.info(\"{#la_modifySuccTip#}\");\n         Wb.remove(app.reportGrid,delArray);\n       }\n     });\n  });\n}\n  "},"children":[],"expanded":false,"type":"button"},{"configs":{"text":"{#la_exportBtn#}","itemId":"exportBtn","iconCls":"export_icon"},"events":{"click":"if (app.reportGrid.getSelection().length ===0) {\n  Wb.warn('{#la_selectExportMsg#}');\n  return false;\n}\nvar win=new Ext.window.Window(app._exportWin);\nwin.show();"},"children":[],"expanded":false,"type":"button"}],"expanded":true,"type":"toolbar"},{"configs":{"itemId":"columns"},"children":[{"configs":{"text":"{#la_rowNumber#}","xtype":"rownumberer","width":"45","align":"center","titleAlign":"center","itemId":"rowNum"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#la_moduleName#}","width":"180","dataIndex":"TAB_NAME","titleAlign":"center","itemId":"TAB_NAME_COL"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#la_reportName#}","width":"200","dataIndex":"SHEET_DESC","titleAlign":"center","itemId":"SHEET_DESC_COL"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#la_ledgerName#}","width":"180","dataIndex":"LEDGER_NAME","titleAlign":"center","itemId":"LEDGER_NAME_COL"},"children":[],"expanded":true,"type":"column"},{"configs":{"text":"{#la_orgName#}","width":"160","dataIndex":"ORG_NAME","titleAlign":"center","itemId":"ORG_NAME_COL"},"children":[],"expanded":true,"type":"column"},{"configs":{"text":"{#la_period#}","width":"110","dataIndex":"PERIOD_CODE","titleAlign":"center","itemId":"PERIOD_CODE_COL"},"children":[],"expanded":true,"type":"column"},{"configs":{"text":"{#la_currency#}","width":"80","dataIndex":"CURRENCY_NAME","titleAlign":"center","itemId":"CNY_NAME_COL"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#la_reportStatus#}","width":"70","dataIndex":"APP_STATUS_NAME","titleAlign":"center","itemId":"APP_STATUS_NAME_COL"},"children":[],"expanded":false,"type":"column"}],"expanded":true,"type":"array"}],"expanded":true,"type":"grid"}],"expanded":true,"type":"viewport"}],"expanded":true,"type":"module"}],"pageLink":"","iconCls":""}