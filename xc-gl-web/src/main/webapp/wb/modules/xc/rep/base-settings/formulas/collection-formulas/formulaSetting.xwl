{"inframe":false,"title":"采集公式设置","hidden":false,"roles":{"default":1},"children":[{"configs":{"cssLinks":"[\"xip/es/EnterpriseSheet/resources/css/common.css\", \"xip/es/EnterpriseSheet/resources/css/sheet.css\", \"xip/es/EnterpriseSheet/resources/css/toolbar.css\"]","jsLinks":"[\"xip/es/EnterpriseSheet/src/EnterpriseSheet/Config.js\", \"xip/es/EnterpriseSheet/src/language/zh_CN.js\", \"xip/es/EnterpriseSheet/enterprisesheet.js\", \"xip/es/EnterpriseSheet/templates/CenterPanel.js\"]","serverScript":"request.setAttribute(\"contextPath\", request.getContextPath());\ncom.xzsoft.xip.platform.util.XipUtil.getCurrentLang(request,\"xc/rep/base-settings/formulas/collection-formulas/formulaSetting\");\n\n// 操作级别 ： ledger-账簿级, common-公共级\nvar level = request.getParameter(\"op\") ;\nrequest.setAttribute(\"level\",level) ;\n","itemId":"module"},"events":{"finalize":"/**\n * 公式信息查询函数\n * @param {type} [tabOrder] 页签序号\n * @return {type} 返回值说明。\n */\nfunction findTabFormulas(tabOrder){\n  // 公式级别\n  var _reportLevel = app.formulaLevel.getValue();\n  var _paramLedgerId = '-1';\n  if(_reportLevel === 'COMMON'){\n    if(Ext.isEmpty(app.accHrcy.getValue())){\n      Wb.info('{#la_selAccHrcyMsg#}');\n      return ;\n    }\n  }else{\n    if(Ext.isEmpty(app.formulaLedger.getValue())){\n      Wb.info('{#la_selLedgerMsg#}');\n      return ;\n    }else{\n      _paramLedgerId = app.formulaLedger.getValue();\n    }\n  }\n  // 科目体系ID\n  var _paramHrcyId = app.accHrcy.getValue();\n  \n  var paramJson = {\n    tabOrder  : tabOrder,\n    ledgerId  : _paramLedgerId,\n    accHrcyId : _paramHrcyId\n  };\n\n  var processbar = Ext.Msg.wait(\"{#la_waitProcessMsg#}\", \"{#la_tipTitle#}\") ;\n\n  // 提交请求\n  Wb.request({\n    url : '{#contextPath#}/xCRepFormulaManageAction.do?method=loadReportModule',\n    params : paramJson,\n    timeout : 60*60*1000,\n    success:function(response,options){\n      processbar.hide();\n      // 报表已加载标志\n      reportIsLoad = true ;\n      // 处理加载结果\n      var obj = Wb.decode(response.responseText);\n      var fileName = obj.fileName;\n      var sheets = obj.sheets;\n      var cells = obj.cells;\n      var floatings = obj.floatings;\n      var json = {\n        fileName : fileName,\n        sheets   : sheets,\n        cells    : cells,\n        floatings: floatings\n      };\n      SHEET_API.loadData(SHEET_API_HD, json, function(){}, this);\t\n    }\n  });\n}\n\n/**\n * 报表页签切换处理\n */\nvar sheet = SHEET_API_HD.sheet;\nsheet.on({\n    scope: this,\n    'switchsheet': function(oldSheetId, sheetId) {\n      findTabFormulas(sheetId) ;\n    }\n});\n","initialize":"var  tabOrder = '-1';              //当前查询的报表序号\nvar  reportIsLoad = false;         //报表是否查询标志\n\n// 创建Enterprise Sheet对象\nSCONFIG.setupDir('');\nSHEET_API = Ext.create('EnterpriseSheet.api.SheetAPI', {\n  openFileByOnlyLoadDataFlag: true\n});\nSHEET_API_HD = SHEET_API.createSheetApp({\n  withoutTitlebar: true,\n  withoutSheetbar: false,\n  withoutToolbar: true,\n  withoutContentbar: false,\n  withoutSidebar: true,\n  style: 'background:white;border-left:1px solid silver;',\n  height: '100%'\n});\n\n// sheet页签\nvar globalSheetPanel = Ext.create('enterpriseSheet.templates.CenterPanel', {\n    border : false \n});\n\n"},"children":[{"configs":{"itemId":"windows"},"children":[{"configs":{"height":"400","width":"800","layout":"border","closeAction":"hide","buttonAlign":"center","border":"false","dialog":"false","itemId":"formulaOrderWin","createInstance":"false"},"children":[{"configs":{"region":"center","selType":"checkboxmodel","itemId":"formulaOrderGrid","editable":"true"},"children":[{"configs":{"autoLoad":"false","itemId":"store","url":"m?xwl=xc/rep/base-settings/formulas/collection-formulas/db/select-tab-formula"},"children":[],"expanded":false,"type":"store"},{"configs":{"itemId":"columns"},"children":[{"configs":{"text":"{#la_rowNumber#}","width":"45","align":"center","xtype":"rownumberer","itemId":"rowCol"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"公式ID","hidden":"true","dataIndex":"FORMULA_ID","itemId":"ORDER_FORMULA_ID"},"children":[],"expanded":true,"type":"column"},{"configs":{"text":"{#la_tabName#}","width":"100","dataIndex":"TAB_NAME","itemId":"ORDER_TAB_NAME"},"children":[],"expanded":true,"type":"column"},{"configs":{"text":"{#la_rowItemName#}","width":"120","dataIndex":"ROWITEM_NAME","itemId":"ORDER_ROWITEM_NAME"},"children":[],"expanded":true,"type":"column"},{"configs":{"text":"{#la_colItemName#}","width":"120","dataIndex":"COLITEM_NAME","itemId":"ORDER_COLITEM_NAME"},"children":[],"expanded":true,"type":"column"},{"configs":{"text":"{#la_dataFormula#}","width":"270","dataIndex":"FORMULA","itemId":"ORDER_FORMULA"},"children":[],"expanded":true,"type":"column"},{"configs":{"text":"{#la_formulaOrder#}","dataIndex":"ORDERBY","itemId":"ORDER_ORDERBY"},"children":[{"configs":{"minValue":"0","itemId":"editor"},"children":[],"expanded":false,"type":"number"}],"expanded":true,"type":"column"}],"expanded":true,"type":"array"}],"expanded":true,"type":"grid"},{"configs":{"itemId":"buttons"},"children":[{"configs":{"text":"{#la_SaveBtn#}","itemId":"saveOrderBtn","iconCls":"save_icon"},"events":{"click":"var _modifyRecords = Wb.getModified(app.formulaOrderGrid);\nif(!Ext.isEmpty(_modifyRecords)){\n  var _updateRecords = _modifyRecords.update;\n  if(_updateRecords.length >0){\n    _updateRecords = Wb.getData(_updateRecords);\n    Wb.request({\n      url:'m?xwl=xc/rep/base-settings/formulas/collection-formulas/db/update-formula-order',\n      params:{'updateArray':_updateRecords},\n      success:function(){\n        Wb.info('保存成功！');\n        app.formulaOrderGrid.getStore().reload();\n      },\n      failure:function(){\n        Wb.info('保存失败!');\n      }\n    });\n  }\n}\n\n\n\n\n\n"},"children":[],"expanded":false,"type":"button"},{"configs":{"text":"{#la_formulaCancelBtn#}","itemId":"cancelOrderBtn","iconCls":"cancel_icon"},"events":{"click":"app.formulaOrderWin.close();"},"children":[],"expanded":true,"type":"button"}],"expanded":true,"type":"array"}],"expanded":true,"type":"window"}],"expanded":false,"type":"folder"},{"configs":{"itemId":"formBar"},"children":[{"configs":{"text":"{#la_formulaSetter#}","itemId":"formulaSetBtn","iconCls":"settings1_icon"},"events":{"click":"/*@methodName：公式设置\n *@notice：公式设置必须在报表加载后的情况下进行，并且只能对有批注的单元格进行公式设置\n *@param formulaSheetId 用来记录报表序号的变量\n *@param reportIsLoad 是否执行查询标志\n */\nif(!reportIsLoad){\n  Wb.info('{#la_queryReportMsg#}');\n  return false;\n}\nvar formulaSheet = SHEET_API_HD.sheet;\nvar formulaSheetId = formulaSheet.getSheetId();\nvar _formulaTitle = '{#la_commonTitle#}';\n//获取报表选择区域\nvar _selRangeData = SHEET_API.getSelectedRangeData(SHEET_API_HD);\nif(_selRangeData.length != 1){\n  Wb.info('{#la_needFormulaMsg#}');\n  return ;\n}\nvar _formulaCell = _selRangeData[0];\nvar _cellObj=formulaSheet.getCellValue(formulaSheet.getSheetId(), _formulaCell.row, _formulaCell.col);\nif(_cellObj.cal){\n  Wb.info('{#la_innerFormulaMsg#}');\n}else{\n  var _comment = _cellObj.vname;//批注\n  var rowItemId, colItemId ;\n  if(Ext.isEmpty(_comment)){\n    Wb.info('{#la_commnetCellMsg#}');\n    return ;\n  }else{\n    var _commentArray = _comment.split(\"/\") ;\n    rowItemId = _commentArray[0] ;\n    colItemId = _commentArray[1] ;\n  }\n  var x=_formulaCell.row;\n  var y=_formulaCell.col;\n  var _formulaLevel = 'common';\n  var _formulaLedger = '-1';\n  if('LEDGER' === app.formulaLevel.getValue()){\n    _formulaLevel = 'ledger';\n    _formulaLedger = app.formulaLedger.getValue();\n    _formulaTitle = '{#la_ledgerFormulaTitle#}';\n  }\n  var param = [];\n  param[0] = app.accHrcy.getValue();            //账簿科目体系ID,仅仅只做显示用\n  param[1] = x ;\n  param[2] = y ;\t\t\n  param[3] = _formulaLevel;                     //公式级别 common-公共级；ledger-账簿级\n  param[4] = _formulaLedger ;                   //账簿id，公共级时账簿id为'-1',账簿级时为所选账簿id\n  param[5] = rowItemId ;\n  param[6] = colItemId ;\n  var _cellData = _cellObj.data;                //单元格中的公式内容\n  //获取当前编辑公式的名称\n  var _titleParam = {'accHrcyId':app.accHrcy.getValue(),'tabOrder':formulaSheetId,'rowItemId':rowItemId,'colItemId':colItemId,'ledgerId':app.formulaLedger.getValue()};\n  Wb.request({\n    url:'m?xwl=xc/rep/base-settings/formulas/collection-formulas/db/select-formula-title',\n    params:_titleParam,\n    success:function(response,options){\n        var titleObj = Wb.decode(response.responseText);\n        var titleRow = titleObj.rows;\n        var titleFormula ='';\n        if(titleRow.length>0){\n          var rowTmp = titleRow[0].ROWITEM_NAME;\n          var colTmp = titleRow[0].COLITEM_NAME;\n          if(Ext.isEmpty(rowTmp))\n            rowTmp = \"\";\n          if(Ext.isEmpty(colTmp))\n            colTmp = \"\";\n          titleFormula = \"<b>{#la_tmpMsg1#}<\/b><br/>\"+\"<font color=blue>&nbsp;&nbsp;&nbsp;{#la_tmpMsg2#}<\/font>\"+\n           titleRow[0].TAB_NAME+\"<br/><font color=blue>&nbsp;&nbsp;&nbsp;{#la_tmpMsg3#}<\/font>\"+\n           rowTmp+\"<br/><font color=blue>&nbsp;&nbsp;&nbsp;{#la_tmpMsg4#}<\/font>\"+\n           colTmp+\"<br/>\";\n        }\n        var _setParams = {'param':param.join(','),'data':_cellData,'title':_formulaTitle,'itemTitle':titleFormula};\n        //打开公式设置页面\n        Wb.run({\n          url:'m?xwl=xc/rep/base-settings/formulas/collection-formulas/cellFormulaSet',\n          params:_setParams,\n          success:function(appObj,responseText){\n            appObj.initWindow({\n              saveFormula:function(resultObj){\n                //设置新的公式\n                var _newCellContent = [{dataformula:formulaSheetId,row:x,col:y,json:{data:resultObj},applyWay:'apply'}];\n                SHEET_API.updateCells(SHEET_API_HD, _newCellContent);\n              }\n            });\n          },\n          failure:function(scope,responseText){\n            Wb.info('{#la_openRepFailureMsg#}');\n          }\n        });\n    }\n  });\n}"},"children":[],"expanded":false,"type":"button"},{"configs":{"text":"{#la_formulaSaveBtn#}","itemId":"formulaSaveBtn","iconCls":"save_icon"},"events":{"click":"// 报表保存,保存报表前需判断报表是否已经加载\nif(!reportIsLoad){\n  Wb.info('请先查询报表！');\n  return false;\n}\nvar saveAccHrcyId = app.accHrcy.getValue();\nif(Wb.isEmpty(saveAccHrcyId)){\n  Wb.toast('请选择科目体系') ;\n  return false ;\n}\n// 公式级别\nvar formulaLevel = app.formulaLevel.getValue() ;\nvar saveOrgId ;\nvar saveLedgerId ;\nif(formulaLevel == 'COMMON'){\n  saveOrgId = \"-1\" ;\n  saveLedgerId = \"-1\" ;\n}else if(formulaLevel == 'LEDGER'){\n  saveOrgId = app.formulaOrg.getValue();\n  saveLedgerId = app.formulaLedger.getValue();\n  if(Wb.isEmpty(saveLedgerId)){\n    Wb.toast('请选择账簿信息');\n    return false ;\n  }\n  if(Wb.isEmpty(saveOrgId)){\n    Wb.toast('账簿未绑定组织信息') ;\n    return false ;\n  }\n}else{\n  Wb.toast('请选择公式级别')　;\n  return false ;\n}\n\nvar progressBar = Ext.Msg.wait(\"正在保存数据...\", \"提示\");\n\n// 公式信息\nvar reportData = SHEET_API.getJsonData(SHEET_API_HD,false);\t\n\n// 提交请求\nExt.Ajax.request({\n  url : '{#contextPath#}/xCRepFormulaManageAction.do?method=saveCellFormula',\n  method : 'POST',\n  timeout : 3600000 ,\n  params : {\n    sheetJson : Ext.encode(reportData),\n    orgId     : saveOrgId,\n    ledgerId  : saveLedgerId,\n    accHrcyId : saveAccHrcyId\n  },\n  success : function(response, options) {\n    progressBar.hide();\n    var obj = Ext.JSON.decode(response.responseText);\n    var flag = obj.flag;\n    var msg = obj.msg;\n    Ext.Msg.alert(\"提示\",msg);\n  },\n  failure : function() {\n    progressBar.hide();\n    Ext.Msg.alert(\"提示\",\"保存公式失败\");\n  }\n});\n"},"children":[],"expanded":false,"type":"button"},{"configs":{"text":"{#la_formulaOrderSetter#}","itemId":"formulaOrderBtn","iconCls":"unordered_list_icon"},"events":{"click":"/*\n *报表采集公式顺序设置<!是采集的顺序设置，并非排序>\n */\nif(!reportIsLoad){\n  Wb.info('请先查询报表！');\n  return false;\n}\nvar _orderSheetId = sheet.getSheetId();\nvar _orderLedgerId = app.formulaLedger.getValue();\nvar _orderAccHrcyId = app.accHrcy.getValue();\nvar _orderWin = new Ext.window.Window(app._formulaOrderWin);\nif(Ext.isEmpty(_orderLedgerId)){\n  _orderLedgerId = '-1';\n}\n_orderWin.setTitle('公式排序');\n_orderWin.show(null,function(){\n  app.formulaOrderGrid.getStore().load({\n  params:{'accHrcyId':_orderAccHrcyId,'tabOrder':_orderSheetId,'ledgerId':_orderLedgerId}\n});\n});\n"},"children":[],"expanded":false,"type":"button"}],"expanded":true,"type":"toolbar"},{"configs":{"layout":"border","itemId":"viewport"},"children":[{"configs":{"region":"north","frame":"false","style":"border-width:0px","itemId":"queryFrom","border":"false","bbar":"app.formBar"},"children":[{"configs":{"tagConfigs":"{\n  baseCls:'my-panel-no-border'\n\n}","layout":"column","itemId":"tr1","border":"false"},"children":[{"configs":{"tagConfigs":"{\n  baseCls:'my-panel-no-border'\n\n}","layout":"form","columnWidth":".3","itemId":"td1.1"},"children":[{"configs":{"labelWidth":"{#la_labelWidth#}","displayField":"VAL_NAME","valueField":"VAL_CODE","labelAlign":"right","itemId":"formulaLevel","fieldLabel":"{#la_formulaLevel#}"},"events":{"afterrender":"// 操作级别\nvar level = '{#level#}';\nif(level === \"ledger\"){\n  Wb.setValue(app.formulaLevel,{'formulaLevel':'LEDGER'});\n}","change":"/*\n *账簿级别，解放账簿选择框，冻结科目体系框；公共级别时刚好相反\n */\nif(combo.getValue() === 'LEDGER'){\n  var level = '{#level#}' ;\n  if(level === \"ledger\"){\n    app.formulaLevel.setReadOnly(true);\n  }else{\n    app.formulaLevel.setReadOnly(false) ;\n  }\n  app.formulaLedger.setReadOnly(false);\n  app.accHrcy.setReadOnly(true);\n  Wb.reset(app.queryFrom,['formulaLedger','accHrcy','formulaOrg']);\n}else{\n  app.formulaLedger.setReadOnly(true);\n  app.accHrcy.setReadOnly(false);\n  Wb.reset(app.queryFrom,['formulaLedger','accHrcy','formulaOrg']);\n}"},"children":[{"configs":{"pageSize":"-1","autoLoad":"true","itemId":"store","url":"m?xwl=xc/rep/base-settings/formulas/collection-formulas/db/select-formula-level"},"children":[],"expanded":false,"type":"store"}],"expanded":true,"type":"combo"}],"expanded":true,"type":"panel"},{"configs":{"tagConfigs":"{\n  baseCls:'my-panel-no-border'\n\n}","layout":"form","columnWidth":".3","itemId":"td1.2"},"children":[{"configs":{"labelWidth":"80","readOnly":"true","displayField":"LEDGER_NAME","valueField":"LEDGER_ID","labelAlign":"right","itemId":"formulaLedger","fieldLabel":"{#la_formulaLedger#}"},"events":{"select":"// 查询报表\napp.accHrcy.setValue(records[0].data.ACC_HRCY_ID);\napp.formulaOrg.setValue(records[0].data.ORG_ID);\napp.queryBtn.fireEvent('click') ;"},"children":[{"configs":{"pageSize":"-1","itemId":"store","autoLoad":"true","url":"m?xwl=xc/com-qry/gl-ledgers/select-sec-fd-ledgers"},"children":[],"expanded":false,"type":"store"}],"expanded":true,"type":"combo"}],"expanded":true,"type":"panel"},{"configs":{"tagConfigs":"{\n  baseCls:'my-panel-no-border'\n\n}","layout":"form","columnWidth":".02","itemId":"td1.4"},"children":[{"configs":{"itemId":"label1"},"children":[],"expanded":false,"type":"label"}],"expanded":true,"type":"panel"},{"configs":{"tagConfigs":"{\n  baseCls:'my-panel-no-border'\n\n}","layout":"form","columnWidth":".2","itemId":"td1.3"},"children":[{"configs":{"text":"{#la_queryBtn#}","width":"70","itemId":"queryBtn","y":"1","iconCls":"seek_icon"},"events":{"click":"// 查询公式信息\nfindTabFormulas('-1') ;"},"children":[],"expanded":false,"type":"button"}],"expanded":true,"type":"panel"}],"expanded":true,"type":"panel"},{"configs":{"tagConfigs":"{\n  baseCls:'my-panel-no-border'\n\n}","layout":"column","itemId":"tr2","border":"false"},"children":[{"configs":{"tagConfigs":"{\n  baseCls:'my-panel-no-border'\n\n}","layout":"form","columnWidth":".3","itemId":"td2.1"},"children":[{"configs":{"labelWidth":"{#la_labelWidth#}","displayField":"ACC_HRCY_NAME","valueField":"ACC_HRCY_ID","labelAlign":"right","itemId":"accHrcy","fieldLabel":"{#la_accHrcyName#}"},"events":{"select":"// 查询报表\napp.queryBtn.fireEvent('click') ;"},"children":[{"configs":{"pageSize":"-1","itemId":"store","autoLoad":"true","url":"m?xwl=xc/rep/base-settings/formulas/collection-formulas/db/select-acc-hrcy"},"children":[],"expanded":false,"type":"store"}],"expanded":true,"type":"combo"}],"expanded":true,"type":"panel"},{"configs":{"tagConfigs":"{\n  baseCls:'my-panel-no-border'\n\n}","layout":"form","columnWidth":".3","itemId":"td2.2"},"children":[{"configs":{"labelWidth":"80","readOnly":"true","displayField":"ORG_NAME","valueField":"ORG_ID","labelAlign":"right","itemId":"formulaOrg","fieldLabel":"{#la_formulaOrg#}"},"children":[{"configs":{"pageSize":"-1","itemId":"store","autoLoad":"true","url":"m?xwl=xc/com-qry/gl-segments/select-all-orgs"},"children":[],"expanded":false,"type":"store"}],"expanded":true,"type":"combo"}],"expanded":true,"type":"panel"},{"configs":{"tagConfigs":"{\n  baseCls:'my-panel-no-border'\n\n}","layout":"form","columnWidth":".02","itemId":"td2.4"},"children":[{"configs":{"itemId":"label1"},"children":[],"expanded":false,"type":"label"}],"expanded":true,"type":"panel"},{"configs":{"tagConfigs":"{\n  baseCls:'my-panel-no-border'\n\n}","layout":"form","columnWidth":".2","itemId":"td2.3"},"children":[{"configs":{"text":"{#la_resetBtn#}","width":"70","itemId":"resetBtn","y":"1","iconCls":"refresh_icon"},"events":{"click":"Wb.reset(app.queryFrom);\ntabOrder = '-1';\n reportIsLoad = false;\n"},"children":[],"expanded":false,"type":"button"}],"expanded":true,"type":"panel"}],"expanded":true,"type":"panel"}],"expanded":true,"type":"form"},{"configs":{"region":"center","layout":"fit","itemId":"sheetPanel"},"events":{"beforerender":"app.viewport.suspendLayouts();\napp.sheetPanel.add(globalSheetPanel);\napp.viewport.doLayout();"},"children":[],"expanded":true,"type":"panel"}],"expanded":true,"type":"viewport"}],"expanded":true,"type":"module"}],"pageLink":"","iconCls":""}