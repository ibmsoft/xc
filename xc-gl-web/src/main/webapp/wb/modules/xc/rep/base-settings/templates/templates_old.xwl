{"title":"报表模板管理","inframe":false,"hidden":false,"roles":{"default":1},"pageLink":"","children":[{"configs":{"cssLinks":"[\"es/EnterpriseSheet/resources/css/common.css\", \"es/EnterpriseSheet/resources/css/sheet.css\", \"es/EnterpriseSheet/resources/css/toolbar.css\"]","jsLinks":"[\"es/EnterpriseSheet/src/EnterpriseSheet/Config.js\", \"es/EnterpriseSheet/src/language/zh_CN.js\", \"es/EnterpriseSheet/enterprisesheet.js\", \"es/EnterpriseSheet/templates/CenterPanel.js\"]","serverScript":"// 获取当前模块语言对应的.json文件，放到request中\ncom.xzsoft.xip.platform.util.XipUtil.getCurrentLang(request,'xc/rep/base-settings/templates/json/templates');\n\nrequest.setAttribute(\"ctxPath\",request.getContextPath()) ;","itemId":"module"},"events":{"initialize":"// 创建EnterpriseSheet的全局变量\nSCONFIG.setupDir('');\nSHEET_API = Ext.create('EnterpriseSheet.api.SheetAPI', {\n  openFileByOnlyLoadDataFlag: true\n});\n\nSHEET_API_HD = SHEET_API.createSheetApp({\n  withoutTitlebar: false,\n  withoutSheetbar: false,\n  withoutToolbar: true,\n  withoutContentbar: false,\n  withoutSidebar: true,\n  style: 'background:white;border-left:1px solid silver;',\n  height: '100%'\n});\n\n// sheet页签\nvar centralPanel = Ext.create('enterpriseSheet.templates.CenterPanel', {\n  border : false \n});"},"children":[{"configs":{"itemId":"wins"},"children":[{"configs":{"title":"{#newTabWin#}","width":"500","layout":"fit","closeAction":"hide","itemId":"newTabWin","modal":"true"},"children":[{"configs":{"height":"90","layout":"form","itemId":"newTplForm","bodyPadding":"10"},"children":[{"configs":{"labelWidth":"90","labelAlign":"right","itemId":"tabCode","fieldLabel":"<font color=red>*<\/font>{#tabCode#}"},"children":[],"type":"text","expanded":false},{"configs":{"labelWidth":"90","labelAlign":"right","itemId":"tabName","fieldLabel":"<font color=red>*<\/font>{#tabName#}"},"children":[],"type":"text","expanded":false}],"type":"form","expanded":false},{"configs":{"itemId":"buttons"},"children":[{"configs":{"text":"{#btnOK#}","itemId":"btnOK","iconCls":"ok_icon"},"events":{"click":"// TODO: 报表模板基础信息\nvar tabCode = app.tabCode.getValue() ;\nvar tabName = app.tabName.getValue() ;\nif(Wb.isEmpty(tabCode)){\n  Wb.toast('请录入模板编码') ;\n  return false ;\n}\nif(Wb.isEmpty(tabName)){\n  Wb.toast('请录入模板名称') ;\n  return false ;\n}\n\n// TODO: 参数信息\nvar paramJson = Wb.getValue(app.newTplForm) ;\nparamJson.accHrcyId = app.cbx_hrcy.getValue() ;\n\nvar msg = Ext.MessageBox.show({\n  title:'请等待',\n  msg:'正在提交请求，请稍后...',\n  width:240,\n  wait:true,\n  progress :true,\n  closable :false\n});\n\n// TODO: 提交请求\nWb.request({\n  url: '{#ctxPath#}'+'/esAction.do?method=createTemplate',\n  params: {\n    'reqParams' : Wb.encode(paramJson)\n  },\n  success: function(resp) {\n    msg.hide() ;\n    var response = Wb.decode(resp.responseText) ;\n    if(response.flag == \"0\"){\n      app.newTabWin.hide() ;\n      var tabName = response.tabName ;\n      var sheetId = response.tabOrder ;\n      \n      // 添加es页签\n      var newTab = {\n          name: tabName,\n          color: 'red',\n          position: sheetId\n      };\n      SHEET_API.addSheetTab(SHEET_API_HD, newTab, function(sheetId){\n      }, this, true); \n      \n    }else{\n      Wb.info(response.msg) ;\n    }\n  }\n});"},"children":[],"type":"button","expanded":false},{"configs":{"text":"{#btnCancel#}","itemId":"btnCancel","iconCls":"cancel_icon"},"events":{"click":"app.newTabWin.hide();"},"children":[],"type":"button","expanded":false}],"type":"array","expanded":true}],"type":"window","expanded":false},{"configs":{"title":"模板导入","width":"500","closeAction":"hide","itemId":"impTabWin","modal":"true"},"children":[{"configs":{"layout":"fit","itemId":"uploadForm","bodyPadding":"10"},"children":[{"configs":{"labelWidth":"80","labelAlign":"right","itemId":"excelFile","fieldLabel":"选择文件"},"children":[],"type":"file","expanded":false}],"type":"form","expanded":true},{"configs":{"itemId":"buttons"},"children":[{"configs":{"text":"{#btnOK#}","itemId":"btnOK","iconCls":"ok_icon"},"events":{"click":"// 所选文件\nvar file = app.excelFile.getValue() ;\n\nif(Wb.isEmpty(file)){\n  Wb.toast('请选择导入文件') ;\n  return false ;\n}"},"children":[],"type":"button","expanded":false},{"configs":{"text":"{#btnCancel#}","itemId":"btnCancel","iconCls":"cancel_icon"},"events":{"click":"app.impTabWin.hide() ;"},"children":[],"type":"button","expanded":false}],"type":"array","expanded":true}],"type":"window","expanded":false},{"configs":{"maximized":"false","title":"{#createRowItemWin#}","height":"450","width":"700","layout":"fit","closeAction":"hide","itemId":"createRowItemWin","dialog":"true","modal":"true","maximizable":"true"},"children":[{"configs":{"pagingBar":"false","itemId":"gridRowitems","border":"false","forceFit":"true","editable":"true"},"children":[{"configs":{"pageSize":"-1","itemId":"store","fields":"[\n  {name:'ROWITEM_ID'},\n  {name:'ROWITEM_CODE'},\n  {name:'ROWITEM_NAME'},\n  {name:'LANNO'},\n  {name:'ROWNO'},\n  {name:'X'},\n  {name:'Y'},\n  {name:'ROWNO_Y'},\n  {name:'IS_NEW'}\n]\n"},"children":[],"type":"store","expanded":false},{"configs":{"itemId":"columns"},"children":[{"configs":{"text":"序号","width":"50","xtype":"rownumberer","align":"center","titleAlign":"center","itemId":"rownum"},"children":[],"type":"column","expanded":false},{"configs":{"text":"行指标ID","hidden":"true","dataIndex":"ROWITEM_ID","itemId":"ROWITEM_ID"},"children":[],"type":"column","expanded":false},{"configs":{"text":"行指标编码","hidden":"true","width":"150","dataIndex":"ROWITEM_CODE","titleAlign":"center","itemId":"ROWITEM_CODE"},"children":[],"type":"column","expanded":false},{"configs":{"text":"行指标名称","width":"400","sortable":"false","dataIndex":"ROWITEM_NAME","titleAlign":"center","itemId":"ROWITEM_NAME"},"children":[{"configs":{"itemId":"editor"},"children":[],"type":"textarea","expanded":false}],"type":"column","expanded":false},{"configs":{"text":"栏次","width":"50","align":"center","dataIndex":"LANNO","titleAlign":"center","itemId":"LANNO"},"children":[],"type":"column","expanded":false},{"configs":{"text":"行次","width":"50","align":"center","sortable":"false","dataIndex":"ROWNO","titleAlign":"center","itemId":"ROWNO"},"children":[],"type":"column","expanded":false},{"configs":{"text":"横坐标","hidden":"true","dataIndex":"X","itemId":"X"},"children":[],"type":"column","expanded":false},{"configs":{"text":"列坐标","hidden":"true","dataIndex":"Y","itemId":"Y"},"children":[],"type":"column","expanded":false},{"configs":{"text":"行次所有列","hidden":"true","dataIndex":"ROWNO_Y","itemId":"ROWNO_Y"},"children":[],"type":"column","expanded":false},{"configs":{"text":"新增","width":"50","align":"center","dataIndex":"IS_NEW","titleAlign":"center","itemId":"IS_NEW","renderer":"if(value=='Y'){\n  return '<font color=red>是<\/font>' ;\n}else if(value == 'N'){\n  return '否' ;\n}else{\n  return value ;\n}"},"children":[],"type":"column","expanded":true}],"type":"array","expanded":true}],"type":"grid","expanded":false},{"configs":{"itemId":"buttons"},"children":[{"configs":{"text":"{#btnOK#}","itemId":"btnOK","iconCls":"ok_icon"},"events":{"click":"// 科目体系ID\nvar hrcyId = app.cbx_hrcy.getValue() ;\nif(Wb.isEmpty(hrcyId)){\n  Wb.toast('请选择科目体系') ;\n  return false ;\n}\n// 序号\nvar sheet = SHEET_API_HD.sheet;\n\n// 行指标数据信息\nvar rowArray = Wb.getData(app.gridRowitems) ;\nif(rowArray.length === 0){\n  Wb.toast('未发现行指标信息无须执行保存处理') ;\n  return false ;\n}\n\nvar processbar = Ext.Msg.wait(\"正在保存行指标信息...\", \"提示\") ;\n\n// 提交请求\nWb.request({\n  url: '{#ctxPath#}'+'/esAction.do?method=saveRowItems',\n  params: {\n    'accHrcyId' : hrcyId,\n    'sheetId'   : sheet.getSheetId(),\n    'rowArray'  : Wb.encode(rowArray) \n  },\n  timeout : 3600000,\n  success: function(resp) {\n    processbar.hide() ;\n    var response  = Wb.decode(resp.responseText) ;\n    if(response.flag == \"0\"){\n      // 保存成功后在行次单元格上标注指标编码和ID信息\n      SHEET_API.updateCells(SHEET_API_HD, response.cells);\n      app.createRowItemWin.hide() ;  \n      app.btnSaveActived.fireEvent('click') ;\n    }\n    Wb.info(response.msg) ;\n  }\n});"},"children":[],"type":"button","expanded":false},{"configs":{"text":"{#btnCancel#}","itemId":"btnCancel","iconCls":"cancel_icon"},"events":{"click":"app.createRowItemWin.hide();"},"children":[],"type":"button","expanded":false}],"type":"array","expanded":true}],"type":"window","expanded":true},{"configs":{"maximized":"false","title":"{#createColItemWin#}","height":"450","width":"650","layout":"fit","closeAction":"hide","itemId":"createColItemWin","dialog":"true","modal":"true","maximizable":"true"},"children":[{"configs":{"pagingBar":"false","multiSelect":"true","itemId":"gridColitems","border":"false","forceFit":"true","simpleSelect":"true","editable":"true"},"children":[{"configs":{"pageSize":"-1","itemId":"store","fields":"[\n  {name:'COLITEM_ID'},\n  {name:'COLITEM_CODE'},\n  {name:'COLITEM_NAME'},\n  {name:'LANNO'},\n  {name:'COLNO'},\n  {name:'DATATYPE'},\n  {name:'X'},\n  {name:'Y'},\n  {name:'IS_NEW'}\n]\n"},"children":[],"type":"store","expanded":false},{"configs":{"itemId":"columns"},"children":[{"configs":{"text":"序号","width":"55","xtype":"rownumberer","align":"center","itemId":"rownum"},"children":[],"type":"column","expanded":false},{"configs":{"text":"列指标ID","hidden":"true","dataIndex":"COLITEM_ID","itemId":"COLITEM_ID"},"children":[],"type":"column","expanded":false},{"configs":{"text":"列指标编码","hidden":"true","width":"150","dataIndex":"COLITEM_CODE","titleAlign":"center","itemId":"COLITEM_CODE"},"children":[],"type":"column","expanded":false},{"configs":{"text":"列指标名称","width":"350","sortable":"false","dataIndex":"COLITEM_NAME","titleAlign":"center","itemId":"COLITEM_NAME"},"children":[{"configs":{"itemId":"editor"},"children":[],"type":"textarea","expanded":false}],"type":"column","expanded":false},{"configs":{"text":"栏次","width":"50","align":"center","dataIndex":"LANNO","titleAlign":"center","itemId":"LANNO"},"children":[],"type":"column","expanded":false},{"configs":{"text":"列次","width":"50","align":"center","sortable":"false","dataIndex":"COLNO","titleAlign":"center","itemId":"COLNO"},"children":[],"type":"column","expanded":false},{"configs":{"text":"数据类型","align":"center","width":"90","dataIndex":"DATATYPE","titleAlign":"center","itemId":"DATATYPE","renderer":"if(value == 1){\n  return '项目' ;\n}else if(value == 3){\n  return '数值' ;\n}else if(value == 5){\n  return '文本' ;\n}else{\n  return value ;\n}"},"children":[{"configs":{"readOnly":"false","displayField":"NAME","queryMode":"local","valueField":"CODE","value":"3","itemId":"editor"},"children":[{"configs":{"data":"[{'CODE':'1','NAME':'项目'},{'CODE':'3','NAME':'数值'},{'CODE':'5','NAME':'文本'}]","itemId":"store","fields":"[{name:'CODE'},{name:'NAME'}]"},"children":[],"type":"store","expanded":false}],"type":"combo","expanded":true}],"type":"column","expanded":false},{"configs":{"text":"横坐标","hidden":"true","dataIndex":"X","itemId":"X"},"children":[],"type":"column","expanded":false},{"configs":{"text":"列坐标","hidden":"true","dataIndex":"Y","itemId":"Y"},"children":[],"type":"column","expanded":false},{"configs":{"text":"新增","width":"50","align":"center","dataIndex":"IS_NEW","titleAlign":"center","itemId":"IS_NEW","renderer":"if(value=='Y'){\n  return '<font color=red>是<\/font>' ;\n}else if(value == 'N'){\n  return '否' ;\n}else{\n  return value ;\n}"},"children":[],"type":"column","expanded":true}],"type":"array","expanded":true}],"type":"grid","expanded":false},{"configs":{"itemId":"buttons"},"children":[{"configs":{"text":"{#btnOK#}","itemId":"btnOK","iconCls":"ok_icon"},"events":{"click":"// 科目体系ID\nvar hrcyId = app.cbx_hrcy.getValue() ;\nif(Wb.isEmpty(hrcyId)){\n  Wb.toast('请选择科目体系') ;\n  return false ;\n}\n// 序号\nvar sheet = SHEET_API_HD.sheet;\nvar sheetTabId = sheet.getSheetId() ;\n\n// 列指标数据信息\nvar colArray = Wb.getData(app.gridColitems) ;\nif(colArray.length === 0){\n  Wb.toast('未发现列指标信息无须执行保存处理') ;\n  return false ;\n}\n\nvar processbar = Ext.Msg.wait(\"正在保存列指标信息...\", \"提示\") ;\n\n// 提交请求\nWb.request({\n  url: '{#ctxPath#}'+'/esAction.do?method=saveColItems',\n  params: {\n    'accHrcyId' : hrcyId,\n    'sheetId'   : sheetTabId,\n    'colArray'  : Wb.encode(colArray) \n  },\n  timeout : 3600000,\n  success: function(resp) {\n    processbar.hide() ;\n    var response  = Wb.decode(resp.responseText) ;\n    if(response.flag == \"0\"){\n      // 保存成功后在第一行单元格上标注批注和值信息\n      SHEET_API.updateCells(SHEET_API_HD, response.cells);\n      SHEET_API.hideRow(SHEET_API_HD, 1, 1, sheet.getSheetId());\n      app.createColItemWin.hide() ;  \n      app.btnSaveActived.fireEvent('click') ;\n    }\n    Wb.info(response.msg) ;\n  }\n});\n"},"children":[],"type":"button","expanded":false},{"configs":{"text":"{#btnCancel#}","itemId":"btnCancel","iconCls":"cancel_icon"},"events":{"click":"app.createColItemWin.hide();"},"children":[],"type":"button","expanded":false}],"type":"array","expanded":true}],"type":"window","expanded":true}],"type":"folder","expanded":true},{"configs":{"itemId":"form_bbar"},"children":[{"configs":{"text":"{#btnNew#}","itemId":"btnNew","iconCls":"file_add_icon"},"events":{"click":"// TODO: 创建报表模板\nvar accHrcyId = app.cbx_hrcy.getValue() ;\nif(Wb.isEmpty(accHrcyId)){\n  Wb.toast('{#selAccHrcy#}') ;\n  return false ;\n}\n\napp.newTplForm.getForm().reset() ;\n\napp.newTabWin.show() ;"},"children":[],"type":"button","expanded":false},{"configs":{"text":"{#btnDel#}","itemId":"btnDel","iconCls":"file_delete_icon"},"events":{"click":"// 科目体系ID\nvar accHrcyId = app.cbx_hrcy.getValue() ;\nif(Wb.isEmpty(accHrcyId)){\n  Wb.toast('请选择科目体系') ;\n  return false ;\n}\n\n// TODO: 删除当前模板格式\nvar sheet = SHEET_API_HD.sheet;\t// 当前活动页签\nvar tabOrder = sheet.getSheetId() ;\t// 页签ID\n\n// 参数信息\nvar reqParams = {'accHrcyId':accHrcyId,'sheetId':tabOrder} ;\n\n// 进度条\nvar processbar = Ext.Msg.wait(\"正在执行模板删除操作...\", \"提示\") ;\n\n// 提交请求\nWb.request({\n  url: '{#ctxPath#}'+'/esAction.do?method=deleteTemplate',\n  params: {\n    'reqParams' : Wb.encode(reqParams)\n  },\n  timeout : 3600000,\n  success: function(resp) {\n    processbar.hide() ;\n    var response  = Wb.decode(resp.responseText) ;\n    // 删除成功\n    if(response.flag == \"0\"){\n      var store = SHEET_API_HD.store;\n      SHEET_API.deleteSheetTab(SHEET_API_HD, store.getActivedSheetId(), function(){\n      });\n    }\n    Wb.info(response.msg) ;\n  }\n});\n"},"children":[],"type":"button","expanded":true},{"configs":{"text":"{#btnSave#}","itemId":"btnSave","iconCls":"save_icon"},"events":{"click":"// app.btnSaveActived.fireEvent('click') ;"},"children":[{"configs":{"text":"保存当前模板","itemId":"btnSaveActived"},"events":{"click":"// 科目体系ID\nvar accHrcyId = app.cbx_hrcy.getValue() ;\nif(Wb.isEmpty(accHrcyId)){\n  Wb.toast('请选择科目体系') ;\n  return false ;\n}\n// 获取表格数据信息\nvar dataJson = SHEET_API.getJsonData(SHEET_API_HD,false) ;\n\nvar sheet = SHEET_API_HD.sheet;\n\nvar processbar = Ext.Msg.wait(\"正在执行模板保存操作...\", \"提示\") ;\n\n// 提交请求\nWb.request({\n  url: '{#ctxPath#}'+'/esAction.do?method=saveTemplate',\n  params: {\n    'accHrcyId' : accHrcyId,\n    'sheetId' : sheet.getSheetId(),\n    'dataJson':Wb.encode(dataJson) \n  },\n  timeout : 3600000,\n  success: function(resp) {\n    processbar.hide() ;\n    var response  = Wb.decode(resp.responseText) ;\n    Wb.info(response.msg) ;\n  }\n});\n"},"children":[],"type":"item","expanded":false},{"configs":{"text":"保存全部模板","itemId":"btnSaveAll"},"events":{"click":"// 科目体系ID\nvar accHrcyId = app.cbx_hrcy.getValue() ;\nif(Wb.isEmpty(accHrcyId)){\n  Wb.toast('请选择科目体系') ;\n  return false ;\n}\n// 获取表格数据信息\nvar dataJson = SHEET_API.getJsonData(SHEET_API_HD,false) ;\n\nvar processbar = Ext.Msg.wait(\"正在执行模板保存操作...\", \"提示\") ;\n\n// 提交请求\nWb.request({\n  url: '{#ctxPath#}'+'/esAction.do?method=saveTemplate',\n  params: {\n    'accHrcyId' : accHrcyId,\n    'sheetId' : -1,\n    'dataJson':Wb.encode(dataJson) \n  },\n  timeout : 3600000,\n  success: function(resp) {\n    processbar.hide() ;\n    var response  = Wb.decode(resp.responseText) ;\n    Wb.info(response.msg) ;\n  }\n});\n"},"children":[],"type":"item","expanded":false}],"type":"button","expanded":false},{"configs":{"text":"{#btnUpload#}","itemId":"btnUpload","iconCls":"up_icon","disabled":"true"},"events":{"click":"// TODO: 导入模板\nvar accHrcyId = app.cbx_hrcy.getValue() ;\nif(Wb.isEmpty(accHrcyId)){\n  Wb.toast('{#selAccHrcy#}') ;\n  return false ;\n}\n\nvar dataJson = SHEET_API.getJsonData(SHEET_API_HD,false) ;\nvar cells = dataJson.cells ;\nvar floating = dataJson.floatings ;\nif(cells.length > 1 || floating.length > 0){\n  Wb.confirm('当前模板已存在格式信息，您确定要覆盖原格式信息吗?', function(){\n    app.uploadForm.getForm().reset() ;\n\tapp.impTabWin.show();\n  });\n  \n}else{\n  app.uploadForm.getForm().reset() ;\n  app.impTabWin.show();\n}\n\n"},"children":[],"type":"button","expanded":false},{"configs":{"text":"{#btnRecOrg#}","itemId":"btnRecOrg","iconCls":"rename_icon"},"events":{"click":"// TODO: 标定公司单元格\nvar sheet = SHEET_API_HD.sheet;\t// 当前活动页签\nvar sm = sheet.getSelectionModel(); // 选择器对象\nvar focus = sm.getFocusCell();\t// 选中区域\nvar cells = [];\ncells.push({sheet:sheet.getSheetId(), row:focus.row, col:focus.col, json: { comment: \"getcorp\", commentEdit: \"hide\" },  applyWay: 'apply'});\nSHEET_API.updateCells(SHEET_API_HD, cells);"},"children":[],"type":"button","expanded":false},{"configs":{"text":"{#btnRecPeriod#}","itemId":"btnRecPeriod","iconCls":"rename_icon"},"events":{"click":"// TODO: 标定期间单元格\nvar sheet = SHEET_API_HD.sheet;\t// 当前活动页签\nvar sm = sheet.getSelectionModel(); // 选择器对象\nvar focus = sm.getFocusCell();\t// 选中区域\nvar cells = [];\ncells.push({sheet:sheet.getSheetId(), row:focus.row, col:focus.col, json: { comment: \"getperiod\", commentEdit: \"hide\" },  applyWay: 'apply'});\nSHEET_API.updateCells(SHEET_API_HD, cells);"},"children":[],"type":"button","expanded":false},{"configs":{"text":"{#btnRecRowNo#}","itemId":"btnRecRowNo","iconCls":"rename_icon"},"events":{"click":"// TODO: 标定行次单元格\nvar sheet = SHEET_API_HD.sheet;\t// 当前活动页签\nvar sm = sheet.getSelectionModel(); // 选择器对象\nvar focus = sm.getFocusCell();\t// 选中区域\nvar cells = [];\ncells.push({sheet:sheet.getSheetId(), row:focus.row, col:focus.col, json: { comment: \"rowno\", commentEdit: \"hide\" },  applyWay: 'apply'});\nSHEET_API.updateCells(SHEET_API_HD, cells);"},"children":[],"type":"button","expanded":false},{"configs":{"text":"{#btnRecItem#}","itemId":"btnRecItem","iconCls":"rename_icon"},"events":{"click":"// TODO: 标定行指标项目基准单元格\nvar sheet = SHEET_API_HD.sheet;\t// 当前活动页签\nvar sm = sheet.getSelectionModel(); // 选择器对象\nvar focus = sm.getFocusCell();\t// 选中区域\nvar cells = [];\ncells.push({sheet:sheet.getSheetId(), row:focus.row, col:focus.col, json: { comment: \"rowitem\", commentEdit: \"hide\" },  applyWay: 'apply'});\nSHEET_API.updateCells(SHEET_API_HD, cells);"},"children":[],"type":"button","expanded":false},{"configs":{"text":"{#btnRowItem#}","itemId":"btnRowItem","iconCls":"edit_icon"},"events":{"click":"// 科目体系\nvar accHrcyId = app.cbx_hrcy.getValue() ;\nif(Wb.isEmpty(accHrcyId)){\n  Wb.toast('请选择科目体系');\n  return false ;\n}\n\n// 获取选中区域, 返回值[{row: 2, col: 2, val: 100}, {row: 2, col: 3, val: \"test\"}]\nvar selectedRange = SHEET_API.getSelectedRangeData(SHEET_API_HD) ;\nif(selectedRange.length === 0){\n  Wb.toast('请选择行指标区域') ;\n  return false ;\n}\n// 第一个单元格\nvar firstCell = selectedRange[0];\nvar x = firstCell.row ;\nvar y = firstCell.col ;\n// 当前活动页签\nvar sheet = SHEET_API_HD.sheet;\nvar cellJson = sheet.getCellValue(sheet.getSheetId(),x, y);\n\nif(cellJson.data === undefined) {\n  Ext.Msg.alert(\"提示\", \"请选择标定的行指标区域\");\n  return;\n}\nif(cellJson.comment != \"rowitem\") {\n  Ext.Msg.alert(\"提示\", \"行指标区域应从标定项目单元格开始,您选择的区域不正确!\");\n  return;\n}\n// 获取所有带批注的单元格信息:[{sheetId: 1, x: 2, y: 2, comment: \"great work\"}, ...]\nvar allCells = SHEET_API.getCellsComment(SHEET_API_HD,sheet.getSheetId());\nvar rownoArray = [] ;\nvar rowitemArray = [] ;\nWb.each(allCells,function(r){\n  var _comment = r.comment ;\n  if(_comment === 'rowno'){\n    rownoArray.push(r) ;\n  }\n  if(_comment === 'rowitem'){\n    rowitemArray.push(r) ;\n  }\n}) ;\nif (rowitemArray.length <= 0) {\n  Ext.Msg.alert(\"提示\", \"请标定项目之后再复核行指标。\");\n  return ;\n}else if(rowitemArray.length > 1){\n  // 按列坐标排序\n  rowitemArray.sort(function(a,b){\n    if(a.y<b.y){  \n      return -1;  \n    }else if(a.y>b.y){  \n      return 1;  \n    }  \n    return 0; \n  }) ;\n}\n// 插入栏次\nvar i=1;\nWb.each(rowitemArray, function(r){\n  r.lanno = i ;\n  i++ ;\n}) ;\nif (rownoArray.length <= 0) {\n  Ext.Msg.alert(\"提示\", \"请标定行次之后再复核行指标。\");\n  return;\n}else if(rownoArray.length > 1){\n  // 按行次列坐标号排序\n  rownoArray.sort(function(a,b){\n    if(a.y<b.y){  \n      return -1;  \n    }else if(a.y>b.y){  \n      return 1;  \n    }  \n    return 0; \n  }) ;\n}\n// 插入栏次\nvar i=1 ;\nWb.each(rownoArray,function(r){\n  r.lanno = i ;\n  i++ ;\n}) ;\n\n// 计算每列行指标项目对应的行次列坐标\nfor(var i=0; i<rowitemArray.length; i++){\n  var r = rowitemArray[i] ;\n  for(var j=0; j<rownoArray.length; j++){\n    var rr = rownoArray[j] ;\n    if(r.lanno == rr.lanno){\n      r.rownoy = rr.y ;\n    }\n  }\n}\n\n// 获取行次列坐标\nvar rowitemCell ;\nWb.each(rowitemArray, function(r){\n  if(r.y == y && r.x ==x){\n    rowitemCell = r ;\n  }\n}) ;\n\n// 处理表格记录\nvar celldata = [] ;\nvar count= 0 ;\nWb.each(selectedRange, function(r){\n  // 判断是否选择了多列\n  if(y != r.col){\n    count++ ;\n  }\n  var val = r.val ;\n  val = val.replace(/(^\\s*)|(\\s*$)/g,'');\t// 去除前后空格\n  // 行次\n  var cell = SHEET_API.getCellValue(SHEET_API_HD, sheet.getSheetId(), r.row, rowitemCell.rownoy);\n  var _rowno = cell.data ;\n  \n  var _rowId = '' ;\n  var _rowCode = '' ;\n  var _isNew = 'Y' ;\n  var cc = cell.comment ;\n  if(!Wb.isEmpty(cc)){\n    var a = cc.split('/') ;\n    _rowCode = a[0] ;\n    _rowId = a[1] ;\n    _isNew = 'N' ;\n  }\n  // 如果行次不为空且为数值\n  if(!Wb.isEmpty(_rowno) && !isNaN(_rowno)){\n    var json = {\n      'ROWITEM_ID' : _rowId,\n      'ROWITEM_CODE' : _rowCode,\n      'ROWITEM_NAME' : val,\n      'LANNO' : rowitemCell.lanno ,\n      'ROWNO' : _rowno ,\n      'X' : r.row,\n      'Y' : r.col,\n      'ROWNO_Y' : rowitemCell.rownoy,\n      'IS_NEW': _isNew\n    } ;\n    celldata.push(json) ;\n  }\n}) ;\n\nif(count >0){\n  Wb.info('提取行指标时只能选择其中一列数据');\n  return false ;\n}\n\n// 加载表格\napp.gridRowitems.getStore().loadData(celldata)  ;\napp.createRowItemWin.show() ;\n\n"},"children":[],"type":"button","expanded":false},{"configs":{"text":"{#btnColItem#}","itemId":"btnColItem","iconCls":"edit_icon"},"events":{"click":"// 科目体系\nvar accHrcyId = app.cbx_hrcy.getValue() ;\nif(Wb.isEmpty(accHrcyId)){\n  Wb.toast('请选择科目体系');\n  return false ;\n}\n// 获取选中区域, 返回值[{row: 2, col: 2, val: 100}, {row: 2, col: 3, val: \"test\"}]\nvar selectedRange = SHEET_API.getSelectedRangeData(SHEET_API_HD) ;\nif(selectedRange.length === 0){\n  Wb.toast('请选择列指标区域') ;\n  return false ;\n}\n// 表格序号\nvar sheet = SHEET_API_HD.sheet;\nvar sheetTabId = sheet.getSheetId()　;\n// 第一个单元格\nvar firstCell = selectedRange[0];\nvar x = firstCell.row ;\nvar y = firstCell.col ;\n\n\n// 获取所有带批注的单元格信息:[{sheetId: 1, x: 2, y: 2, comment: \"great work\"}, ...]\nvar allCells = SHEET_API.getCellsComment(SHEET_API_HD,sheet.getSheetId());\nvar rownoArray = [] ;\nvar rowitemArray = [] ;\nvar rownoYArray = [] ;\nvar rowitemYArray = [] ;\nWb.each(allCells,function(r){\n  var _comment = r.comment ;\n  if(_comment === 'rowno'){\n    rownoArray.push(r) ;\n  }\n  if(_comment === 'rowitem'){\n    rowitemArray.push(r) ;\n  }\n}) ;\nif (rowitemArray.length <= 0) {\n  Ext.Msg.alert(\"提示\", \"请标定项目之后再复核列指标。\");\n  return ;\n}else if(rowitemArray.length > 1){\n  // 按列坐标排序\n  rowitemArray.sort(function(a,b){\n    if(a.y<b.y){  \n      return -1;  \n    }else if(a.y>b.y){  \n      return 1;  \n    }  \n    return 0; \n  }) ;\n}\n// 计算列次数组\nvar i = 0 ;\nWb.each(rowitemArray, function(r){\n  rowitemYArray[i] = r.y ;\n  i++ ;\n}) ;\n\nif (rownoArray.length <= 0) {\n  Ext.Msg.alert(\"提示\", \"请标定行次之后再复核列指标。\");\n  return;\n}else if(rownoArray.length > 1){\n  // 按行次列坐标号排序\n  rownoArray.sort(function(a,b){\n    if(a.y<b.y){  \n      return -1;  \n    }else if(a.y>b.y){  \n      return 1;  \n    }  \n    return 0; \n  }) ;\n}\n// 计算列次数组\nvar i = 0 ;\nWb.each(rownoArray, function(r){\n  rownoYArray[i] = r.y ;\n  i++ ;\n}) ;\n\n\n// 处理表格记录\nvar celldata = [] ;\nvar count= 0 ;\nvar isFirstCreated = true ;\t// 第一次创建列指标\nWb.each(selectedRange, function(r){\n  // 判断是否选择了多行\n  if(x != r.row){\n    count++ ;\n  }\n  var val = r.val ; // 单元格值\n  val = val.replace(/(^\\s*)|(\\s*$)/g,'');\t// 去除前后空格\n  \n  // 计算栏次\n  var _lanno = 0 ;\n  for(var i=0; i<rownoYArray.length; i++){\n    if(r.col > rownoYArray[i]){\n      _lanno++ ;\n    }\n  }\n  if(_lanno === 0) {\n    _lanno = 1 ;\n  }\n  // 判断当前单元格是否与rowitem单元格在同一列, 如果不考虑浮动行此列可以去除\n  var flag = 0 ;\n  for(var k=0; k<rowitemYArray.length; k++){\n    if(r.col == rowitemYArray[k]){\n      flag = 1 ;\n    }\n  }\n  \n  // 计算列指标ID和编码\n  var _rowId = '' ;\n  var _rowCode = '' ;\n  var _isNew = 'Y' ;\n  var colCell = SHEET_API.getCell(SHEET_API_HD, sheetTabId, 1, r.col ) ;\n  if(!Wb.isEmpty(colCell.data) && !Wb.isEmpty(colCell.comment)){\n    var _cellComment = colCell.comment ;\n    var a = _cellComment.split('/') ;\n    _rowCode = a[0] ;\n    _rowId = a[1] ;\n    _isNew = 'N' ;\n    isFirstCreated = false ;\n  }\n  var cell = SHEET_API.getCell(SHEET_API_HD, sheetTabId, r.row, r.col ) ; // 单元格值和格式信息\n  // 如果单元格不为空且不包括批注rowno\n  if(!Wb.isEmpty(val) && cell.comment != 'rowno' && flag === 0){ \n    var json = {\n      'COLITEM_ID' : _rowId,\n      'COLITEM_CODE' : _rowCode,\n      'COLITEM_NAME' : val,\n      'LANNO' : _lanno ,\n      'COLNO' : r.col ,\n      'DATATYPE':'3',\n      'X' : r.row,\n      'Y' : r.col,\n      'IS_NEW': _isNew\n    } ;\n    celldata.push(json) ;\n  }\n}) ;\n\nif(count >0){\n  Wb.info('提取列指标时只能选择其中一行数据');\n  return false ;\n}\n\n// 如果第一次创建列指标则在第一行位置创建空行存储列指标信息\nif(isFirstCreated){\n  SHEET_API.insertRow(SHEET_API_HD, sheetTabId, 1, 1 ) ;\n}\n\n// 加载表格\napp.gridColitems.getStore().loadData(celldata)  ;\napp.createColItemWin.show() ;\n\n"},"children":[],"type":"button","expanded":false},{"configs":{"text":"{#btnRecDataArea#}","itemId":"btnRecDataArea","iconCls":"rename_icon"},"events":{"click":"// 科目体系ID\nvar accHrcyId = app.cbx_hrcy.getValue() ;\nif(Wb.isEmpty(accHrcyId)){\n  Wb.toast('请选择科目体系') ;\n  return false ;\n}\n\n// 表格序号\nvar sheet = SHEET_API_HD.sheet;\nvar sheetTabId = sheet.getSheetId()　;\n\n// 获取所有带批注的单元格信息:[{sheetId: 1, x: 2, y: 2, comment: \"great work\"}, ...]\nvar allCells = SHEET_API.getCellsComment(SHEET_API_HD,sheet.getSheetId());\nvar rownoArray = [] ;\nvar rownoYArray = [] ;\nWb.each(allCells,function(r){\n  var _comment = r.comment ;\n  if(_comment === 'rowno'){\n    rownoArray.push(r) ;\n  }\n}) ;\nif (rownoArray.length <= 0) {\n  Ext.Msg.alert(\"提示\", \"请标定行次之后再复核列指标。\");\n  return ;\n}else if(rownoArray.length > 1){\n  // 按行次列坐标号排序\n  rownoArray.sort(function(a,b){\n    if(a.y<b.y){  \n      return -1;  \n    }else if(a.y>b.y){  \n      return 1;  \n    }  \n    return 0; \n  }) ;\n}\n// 计算列次数组\nvar i = 0 ;\nWb.each(rownoArray, function(r){\n  rownoYArray[i] = r.y ;\n  i++ ;\n}) ;\n\n// 获取选中区域, 返回值[{row: 2, col: 2, val: 100}, {row: 2, col: 3, val: \"test\"}]\nvar selectedRange = SHEET_API.getSelectedRangeData(SHEET_API_HD) ;\nif(selectedRange.length === 0){\n  Wb.toast('请选择列指标区域') ;\n  return false ;\n}else{\n  var cells = [] ;\n  var isCreateItems = false ;\n  Wb.each(selectedRange, function(r){\n    var cell = {} ;\n    cell.sheet = sheetTabId ;\n    cell.row = r.row ;\n    cell.col = r.col ;\n    var cellJson = SHEET_API.getCell(SHEET_API_HD, sheetTabId, r.row, r.col) ;\n   \n    // 列指标ID\n    var colitemId ;\n    var colCell = SHEET_API.getCell(SHEET_API_HD, sheetTabId, 1, r.col) ;\n    if(!Wb.isEmpty(colCell)){\n      var _colitem = colCell.comment ;\n      if(_colitem !== undefined){\n        var a = _colitem.split(\"/\") ;\n        colitemId = a[1] ;\n      }\n    }\n\n    // 行指标ID\n    var y ;\n    var rowitemId ;\n    Wb.each(rownoYArray, function(ry){\n      if(r.col>ry){\n        y = ry ; \n      }\n    }) ;\n    if(!Wb.isEmpty(y)){\n      var rowCell = SHEET_API.getCell(SHEET_API_HD, sheetTabId, r.row, y) ;\n      var _rowitem = rowCell.comment ;\n      if(_rowitem !== undefined){\n        var b = _rowitem.split(\"/\") ;\n        rowitemId = b[1] ;\n      }\n    }\n\tif(!Wb.isEmpty(rowitemId) && !Wb.isEmpty(colitemId)){\n      cellJson.comment = \"data>>\"+rowitemId+\"/\"+colitemId ;\n      cellJson.commentEdit = \"hide\" ;\n      cell.json = cellJson ;\n      \n      cells.push(cell) ;\n    }else{\n      isCreateItems = true ;\n    }\n  }) ;\n  \n  if(isCreateItems){\n    Wb.toast('在标定数据区域时须先设置行列指标信息!') ;\n    return false ;\n  }\n  \n  SHEET_API.updateCells(SHEET_API_HD, cells, function(){\n    // 执行模板保存处理\n    app.btnSaveActived.fireEvent('click') ;\n  },this);\n  \n}\n\n"},"children":[],"type":"button","expanded":false},{"configs":{"text":"{#btnClearComment#}","itemId":"btnClearComment","iconCls":"cancel_icon"},"events":{"click":"// TODO: 清空选中区域的批注信息\nvar sheet = SHEET_API_HD.sheet;\nvar sheetId = sheet.getSheetId();\n//选择的区域\nvar selectedRange = SHEET_API.getSelectedRangeData(SHEET_API_HD);\nfor (var i=0; i<selectedRange.length; i++) {\n  var cell = selectedRange[i];\n  SHEET_API.deleteCommentForCoord(SHEET_API_HD, [sheetId, cell.row, cell.col, cell.row, cell.col]);\n} "},"children":[],"type":"button","expanded":false}],"type":"toolbar","expanded":true},{"configs":{"layout":"border","itemId":"viewport1"},"children":[{"configs":{"region":"north","tagConfigs":"columnWidth:0.35","layout":"column","itemId":"form","bodyPadding":"10","bbar":"app.form_bbar"},"children":[{"configs":{"tagConfigs":"columnWidth:0.35","labelWidth":"120","displayField":"ACC_HRCY_NAME","valueField":"ACC_HRCY_ID","labelAlign":"right","itemId":"cbx_hrcy","fieldLabel":"{#cbx_hrcy#}"},"events":{"select":"app.btnQuery.fireEvent('click') ;"},"children":[{"configs":{"itemId":"store","url":"m?xwl=xc/rep/base-settings/templates/data/select-acc-hrcy"},"children":[],"type":"store","expanded":false}],"type":"combo","expanded":false},{"configs":{"tagConfigs":"columnWidth:0.35","labelWidth":"90","labelAlign":"right","itemId":"txt_tpl","fieldLabel":"{#txt_tpl#}"},"events":{"specialkey":"if(e.keyCode == 13){\n  app.btnQuery.fireEvent('click') ;\n}"},"children":[],"type":"text","expanded":false},{"configs":{"columnWidth":".3","itemId":"buttons","border":"false"},"children":[{"configs":{"text":"{#btnQuery#}","margin":"0 0 0 10","itemId":"btnQuery","iconCls":"seek_icon"},"events":{"click":"// 科目体系ID\nvar hrcyId = app.cbx_hrcy.getValue() ;\n\nif(Wb.isEmpty(hrcyId)) return ;\n\nvar processbar = Ext.Msg.wait(\"正在提交请求...\", \"提示\") ;\n\n// 提交请求\nWb.request({\n  url: '{#ctxPath#}'+'/esAction.do?method=findTemplate',\n  params: {\n    'accHrcyId' : hrcyId\n  },\n  timeout : 3600000,\n  success: function(resp) {\n    processbar.hide() ;\n    var response  = Wb.decode(resp.responseText) ;\n    if(response.flag == \"0\"){ // 加载成功\n      var json = {\n        fileName: response.fileName,\n        sheets: response.sheets,\n        cells: response.cells,\n        floatings : response.floatings\n      };\n      SHEET_API.loadData(SHEET_API_HD, json ,function(){},this);\n//       SHEET_API.hideRow(SHEET_API_HD, 1, 1, response.activedSheetId);\n      \n    }else if(response.flag == \"2\"){ // 无模板信息\n      var emptyJson = {\n        fileName: '模板格式设置',\n        sheets: [\n          {id:0,name:'sheet1',actived:true},\n          {id:1,name:'sheet2',actived:false},\n          {id:2,name:'sheet3',actived:false}\n        ],\n        cells:[],\n        floatings:[]\n      };\n      SHEET_API.loadData(SHEET_API_HD, emptyJson ,function(){},this);\n      Wb.toast(response.msg) ;\n      \n    }else{ // 加载失败\n      Wb.info(response.msg) ;\n    }\n  }\n});"},"children":[],"type":"button","expanded":false}],"type":"panel","expanded":true}],"type":"form","expanded":true},{"configs":{"region":"center","layout":"border","itemId":"es_panel","border":"false"},"events":{"beforerender":"// 将ES组件添加到ExtJS的Panel容器中\npanel.add(centralPanel) ;\n\n"},"children":[],"type":"panel","expanded":true}],"type":"viewport","expanded":true}],"type":"module","expanded":true}],"iconCls":""}