{"inframe":false,"title":"报表公式设置","hidden":false,"roles":{"default":1},"children":[{"configs":{"serverScript":"// TODO: 公式描述：itemTitle\nvar formulaParam=request.getParameter('param');\nvar formulaData=request.getParameter('data');\nif(Wb.isEmpty(formulaData)){\n  formulaData = '无公式' ;\n}\nvar arr = formulaParam.split(\",\") ;\nvar accHrcyId = arr[0] ;\nvar ledgerId = arr[4] ;\nif(Wb.isEmpty(ledgerId)){\n  ledgerId = \"\" ;\n}\nvar rowItemId = arr[5] ;\nvar colItemId = arr[6] ;\nrequest.setAttribute(\"ACC_HRCY_ID\", accHrcyId) ;\nrequest.setAttribute(\"LEDGER_ID\", ledgerId) ;\nrequest.setAttribute('param',formulaParam);\nrequest.setAttribute('ROW_ITEM_ID',rowItemId);\nrequest.setAttribute('COL_ITEM_ID',colItemId);\nrequest.setAttribute('contextPath',request.getContextPath());\n\nrequest.getSession().setAttribute(\"XC_REP_ACC_HRCY_ID\", accHrcyId) ;\nrequest.getSession().setAttribute(\"XC_REP_LEDGER_ID\", accHrcyId) ;\ncom.xzsoft.xip.platform.util.XipUtil.getCurrentLang(request,\"xc/rep/base-settings/formulas/collection-formulas/formulaSetting\");","itemId":"module"},"events":{"finalize":"/**\n *判断参数取值sql中是否存在引用参数\n */\nfunction hasReferenceParam(sql) {\n  var regu = /\\{\\{\\w+\\}\\}/;\n  var re = new RegExp(regu);\n  if (sql.search(re) != -1) {\n    var s=re.exec(sql);\n    return s + '';\n  }else {\n    return '';\n  }\n}\n/**\n *单元格设置公式翻译\n */\nfunction ruleTranslate(){\n  var formulaText = app.formulaStr.getValue();\n  if(Ext.isEmpty(formulaText)){\n    return false;\n  }\n  var _tmpLedgerId = '{#ledgerId#}';\n  if(Ext.isEmpty(_tmpLedgerId)){\n    _tmpLedgerId = '-1';\n  }\n  Wb.request({\n    url : '{#contextPath#}/xCRepFormulaManageAction.do?method=translateFormula',\n\tparams:{\n      'formulaText' : formulaText,\n      'accHrcyId' : '{#ACC_HRCY_ID#}',\n      'ledgerId':_tmpLedgerId\n    },\n\tsuccess:function(response,options){\n      var returnObj = Wb.decode(response.responseText);\n      if(returnObj.flag == \"0\"){\n        app.formulaDesc.setValue(returnObj.msg);\n      }\n\t},\n\tfailure:function(response,options){\n\t\tvar returnObj = Wb.decode(response.responseText);\n\t\tWb.info(returnObj.msg);\n\t}\n});\n}\n","initialize":"/*窗口初始化函数\n *initialize最先加载，然后按照Ext组件的包含被包含关系依次加载，最后加载finalize的内容\n *Wb在Ext.onReady的回调函数里定义了自身的contextOwner变量，并且在函数开始时定了包含所有组件的app={} JSON结构体对象。\n */\nvar globalSql = '';\nExt.apply(app,{\n  initWindow:function(params){\n    Ext.apply(app, params);\n    app.formulaWin = new Ext.window.Window(app.formulaWin);\n    app.formulaWin.setTitle('{#title#}');      \n    var p = '{#param#}';\n    var param=p.split(',');\n    if(!Ext.isEmpty(param)){\n      var globalX=param[1];      //x坐标\n      var globalY=param[2];      //y坐标\n      var globalData='{#data#}'; //公式\n      app.cbxAccHrcy.setValue('{#ACC_HRCY_ID#}');\n      app.cbxFormulaLedger.setValue('{#LEDGER_ID#}');\n//       app.cbxRowItems.getStore().load();\n//       app.cbxColItems.getStore().load();\n      if(!Ext.isEmpty(globalData)){\n        globalData=globalData.replace(/amp/g,'&');\n        var arrEntities={'lt':'<','gt':'>','nbsp':' ','amp':'&','quot':'\"'};\n        globalData=globalData.replace(/&(lt|gt|nbsp|amp|quot);/ig,function(all,t){return arrEntities[t];});\n        app.formulaStr.setValue(globalData);\n        ruleTranslate();\n      }\n    }\n    app.formulaWin.show();\n  }\n});\n"},"children":[{"configs":{"itemId":"bbar"},"children":[{"configs":{"text":"->","itemId":"sep"},"children":[],"expanded":false,"type":"item"},{"configs":{"text":"确定","margin":"0 1 0 0","itemId":"okBtn","iconCls":"ok_icon"},"events":{"click":"var famulaText=app.formulaStr.getValue();\nif(app.saveFormula){\n  app.saveFormula(famulaText);\n}\napp.formulaWin.close();"},"children":[],"expanded":false,"type":"button"}],"expanded":false,"type":"toolbar"},{"configs":{"maximized":"true","height":"670","width":"800","layout":"fit","dialog":"false","itemId":"formulaWin","modal":"true","maximizable":"true","createInstance":"false"},"children":[{"configs":{"layout":"column","border":"false","itemId":"formulaPanel","bbar":"app.bbar"},"children":[{"configs":{"height":"600","layout":"border","columnWidth":".47","itemId":"condition","border":"false"},"children":[{"configs":{"region":"center","activeTab":"itemPanel","itemId":"tab"},"children":[{"configs":{"title":"{#la_title1#}","layout":"form","border":"false","itemId":"itemPanel","bodyPadding":"10"},"children":[{"configs":{"itemId":"cbxFormulaLedger"},"children":[],"expanded":false,"type":"hidden"},{"configs":{"labelWidth":"{#la_labelWidth#}","readOnly":"true","displayField":"ACC_HRCY_NAME","valueField":"ACC_HRCY_ID","labelAlign":"right","itemId":"cbxAccHrcy","fieldLabel":"{#la_accHrcyName#}"},"events":{"beforequery":"var combo = plan.combo;\nif (!plan.forceAll) {\n  var value = plan.query;\n  combo.store.filterBy(function(record, id) {\n    var text = record.get(combo.displayField);\n    return (text.indexOf(value) != -1);\n  });\n  combo.expand();\n  return false;\n}"},"children":[{"configs":{"pageSize":"-1","itemId":"store","autoLoad":"true","url":"m?xwl=xc/rep/base-settings/formulas/collection-formulas/db/select-acc-hrcy"},"children":[],"expanded":false,"type":"store"}],"expanded":false,"type":"combo"},{"configs":{"labelWidth":"{#la_labelWidth#}","allowBlank":"false","displayField":"PERIOD_NAME","valueField":"PERIOD_CODE","emptyText":"{#la_empTips#}","labelAlign":"right","itemId":"cbxPeriod","fieldLabel":"{#la_periodFormula#}"},"events":{"beforequery":"var combo = plan.combo;\nif (!plan.forceAll) {\n  var value = plan.query;\n  combo.store.filterBy(function(record, id) {\n    var text = record.get(combo.displayField);\n    return (text.indexOf(value) != -1);\n  });\n  combo.expand();\n  return false;\n}"},"children":[{"configs":{"pageSize":"-1","autoLoad":"true","itemId":"store","url":"m?xwl=xc/rep/base-settings/formulas/collection-formulas/db/select-formula-period"},"events":{"load":"// 默认值\nWb.setValue(app.cbxPeriod, {'cbxPeriod':'XZRQ'}) ;"},"children":[],"expanded":false,"type":"store"}],"expanded":false,"type":"combo"},{"configs":{"labelWidth":"{#la_labelWidth#}","decimalPrecision":"0","labelAlign":"right","itemId":"offsetPeriod","fieldLabel":"{#la_offsetPeriod#}"},"children":[],"expanded":false,"type":"number"},{"configs":{"labelWidth":"{#la_labelWidth#}","allowBlank":"false","displayField":"NAME","valueField":"CODE","labelAlign":"right","itemId":"cbx_ledgers","fieldLabel":"{#la_ledgerFormula#}"},"children":[{"configs":{"autoLoad":"true","itemId":"store","url":"m?xwl=xc/com-qry/gl-ledgers/select-all-ledgers"},"events":{"load":"Ext.define('ledgerModel', {  \n    extend: 'Ext.data.Model',  \n    fields: [  \n        {name: 'CODE'},  \n        {name: 'NAME'}\n     ]  \n});\nvar r = Ext.create('ledgerModel', {\n  'CODE' : 'XZDW', \n  'NAME' : '当前账簿'\n});\n\nstore.insert(0,r);\n\n// TODO: 设置默认值\nWb.setValue(app.cbx_ledgers,{'cbx_ledgers':'XZDW'}) ;"},"children":[],"expanded":false,"type":"store"}],"expanded":true,"type":"combo"},{"configs":{"labelWidth":"{#la_labelWidth#}","allowBlank":"false","displayField":"CURRENCY_NAME","valueField":"CURRENCY_CODE","emptyText":"{#la_empTips#}","labelAlign":"right","itemId":"cbxCurrenies","fieldLabel":"{#la_currencyFormula#}"},"events":{"beforequery":"var combo = plan.combo;\nif (!plan.forceAll) {\n  var value = plan.query;\n  combo.store.filterBy(function(record, id) {\n    var text = record.get(combo.displayField);\n    return (text.indexOf(value) != -1);\n  });\n  combo.expand();\n  return false;\n}"},"children":[{"configs":{"pageSize":"-1","autoLoad":"true","itemId":"store","url":"m?xwl=xc/rep/base-settings/formulas/collection-formulas/db/select-formula-currnecy"},"events":{"load":"// 设置默认值\nWb.setValue(app.cbxCurrenies, {'cbxCurrenies':'CNY'}) ;","beforeload":"store.getProxy().extraParams.accHrcyId = '{#ACC_HRCY_ID#}';"},"children":[],"expanded":false,"type":"store"}],"expanded":false,"type":"combo"},{"configs":{"labelWidth":"{#la_labelWidth#}","displayField":"TAB_NAME","valueField":"TAB_ID","labelAlign":"right","itemId":"cbx_tabs","fieldLabel":"{#la_tabFormula#}"},"events":{"select":"app.tabRowItems.setReadOnly(false) ;\napp.tabColItems.setReadOnly(false) ;\n\napp.tabRowItems.setValue() ;\napp.tabColItems.setValue() ;\napp.cbxRowItems.setValue() ;\napp.cbxColItems.setValue() ;\n\napp.rowitemsGrid.getStore().load();\napp.colitemsGrid.getStore().load();"},"children":[{"configs":{"autoLoad":"true","itemId":"store","url":"m?xwl=xc/rep/base-settings/formulas/collection-formulas/db/select-tabs"},"events":{"beforeload":"store.proxy.extraParams.accHrcyId = app.cbxAccHrcy.getValue() ;"},"children":[],"expanded":true,"type":"store"}],"expanded":true,"type":"combo"},{"configs":{"itemId":"cbxRowItems"},"children":[],"expanded":false,"type":"hidden"},{"configs":{"itemId":"cbxColItems"},"children":[],"expanded":false,"type":"hidden"},{"configs":{"labelWidth":"{#la_labelWidth#}","readOnly":"true","allowBlank":"false","triggerCls":"x-form-search-trigger","emptyText":"{#la_empRowItemTip#}","labelAlign":"right","itemId":"tabRowItems","fieldLabel":"{#la_rowItemFormula#}"},"children":[{"configs":{"tagConfigs":"minWidth:650","multiSelect":"false","height":"350","forceFit":"true","normalName":"rowitemsGrid","itemId":"pickComp","simpleSelect":"false"},"events":{"itemclick":"app.cbxRowItems.setValue(record.data.ROWITEM_CODE) ;\napp.tabRowItems.setValue(record.data.ROWITEM_NAME) ;\napp.tabRowItems.collapse() ;"},"children":[{"configs":{"itemId":"tbar"},"children":[{"configs":{"labelWidth":"80","labelAlign":"right","itemId":"txt_rowitem_name","fieldLabel":"{#la_itemFormula#}"},"events":{"specialkey":"if(e.keyCode == 13){\n  app.rowitemsGrid.getStore().load() ;\n}"},"children":[],"expanded":false,"type":"text"}],"expanded":true,"type":"toolbar"},{"configs":{"autoLoad":"true","itemId":"store","url":"m?xwl=xc/rep/base-settings/formulas/collection-formulas/db/select-tab-rowitems"},"events":{"beforeload":"store.proxy.extraParams.accHrcyId = app.cbxAccHrcy.getValue() ;\nstore.proxy.extraParams.tabId = app.cbx_tabs.getValue() ;\nstore.proxy.extraParams.textStr = app.txt_rowitem_name.getValue() ;\n"},"children":[],"expanded":false,"type":"store"},{"configs":{"itemId":"columns"},"children":[{"configs":{"text":"{#la_rowNumber#}","align":"center","xtype":"rownumberer","width":"55","titleAlign":"center","itemId":"rownum"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"ID","hidden":"true","dataIndex":"ROWITEM_ID","itemId":"ROWITEM_ID"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#la_rowItemCode#}","width":"150","dataIndex":"ROWITEM_CODE","titleAlign":"center","itemId":"ROWITEM_CODE"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#la_rowItemName#}","width":"350","dataIndex":"ROWITEM_NAME","titleAlign":"center","itemId":"ROWITEM_NAME"},"children":[],"expanded":false,"type":"column"}],"expanded":true,"type":"array"}],"expanded":true,"type":"grid"}],"expanded":false,"type":"picker"},{"configs":{"labelWidth":"{#la_labelWidth#}","readOnly":"true","allowBlank":"false","triggerCls":"x-form-search-trigger","emptyText":"{#la_empColItemTip#}","labelAlign":"right","itemId":"tabColItems","fieldLabel":"{#la_colItemFormula#}"},"children":[{"configs":{"tagConfigs":"minWidth:650","multiSelect":"false","height":"350","normalName":"colitemsGrid","itemId":"pickComp","simpleSelect":"false"},"events":{"itemclick":"app.cbxColItems.setValue(record.get('COLITEM_CODE')) ;\napp.tabColItems.setValue(record.get('COLITEM_NAME')) ;\napp.tabColItems.collapse() ;"},"children":[{"configs":{"itemId":"tbar"},"children":[{"configs":{"labelWidth":"80","labelAlign":"right","itemId":"txt_colitem_name","fieldLabel":"{#la_itemFormula#}"},"events":{"specialkey":"if(e.keyCode == 13){\n  app.colitemsGrid.getStore().load() ;\n}"},"children":[],"expanded":false,"type":"text"}],"expanded":true,"type":"toolbar"},{"configs":{"autoLoad":"true","itemId":"store","url":"m?xwl=xc/rep/base-settings/formulas/collection-formulas/db/select-tab-colitems"},"events":{"beforeload":"store.proxy.extraParams.accHrcyId = app.cbxAccHrcy.getValue() ;\nstore.proxy.extraParams.tabId = app.cbx_tabs.getValue() ;\nstore.proxy.extraParams.textStr = app.txt_colitem_name.getValue() ;\n"},"children":[],"expanded":false,"type":"store"},{"configs":{"itemId":"columns"},"children":[{"configs":{"text":"序号","align":"center","xtype":"rownumberer","width":"55","itemId":"rownum"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"ID","hidden":"true","dataIndex":"COLITEM_ID","itemId":"COLITEM_ID"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#la_colItemCode#}","width":"150","dataIndex":"COLITEM_CODE","titleAlign":"center","itemId":"COLITEM_CODE"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#la_colItemName#}","width":"350","dataIndex":"COLITEM_NAME","titleAlign":"center","itemId":"COLITEM_NAME"},"children":[],"expanded":false,"type":"column"}],"expanded":true,"type":"array"}],"expanded":true,"type":"grid"}],"expanded":false,"type":"picker"}],"expanded":false,"type":"panel"},{"configs":{"title":"{#la_title2#}","layout":"border","border":"false","itemId":"customPanel"},"children":[{"configs":{"region":"north","height":"70","style":"border-wdith:0px","layout":"form","itemId":"form1","border":"false","bodyPadding":"5"},"children":[{"configs":{"labelWidth":"{#la_labelWidth#}","allowBlank":"false","displayField":"VAL_NAME","width":"200","valueField":"VAL_CODE","value":"JAVA","labelAlign":"right","itemId":"cbxFuncType","fieldLabel":"{#la_functionType#}"},"events":{"select":"app.cbxFncName.clearValue();\napp.cbxFunParams.getStore().removeAll();"},"children":[{"configs":{"pageSize":"-1","itemId":"store","url":"m?xwl=xc/rep/rep-common/select-func-type"},"children":[],"expanded":false,"type":"store"}],"expanded":false,"type":"combo"},{"configs":{"labelWidth":"{#la_labelWidth#}","allowBlank":"false","displayField":"FUNC_NAME","width":"300","valueField":"FUNC_ID","labelAlign":"right","itemId":"cbxFncName","fieldLabel":"{#la_functionName#}"},"events":{"select":"app.cbxFunParams.getStore().load();"},"children":[{"configs":{"pageSize":"-1","itemId":"store","url":"m?xwl=xc/rep/base-settings/formulas/collection-formulas/db/select-formula-functions"},"events":{"beforeload":"store.getProxy().extraParams.functionType = app.cbxFuncType.getValue();"},"children":[],"expanded":false,"type":"store"}],"expanded":false,"type":"combo"}],"expanded":true,"type":"form"},{"configs":{"region":"center","pagingBar":"false","height":"490","itemId":"cbxFunParams","forceFit":"true","editable":"true","viewConfig":"{\n  enableTextSelection:true\n}"},"children":[{"configs":{"pageSize":"-1","itemId":"store","url":"m?xwl=xc/rep/base-settings/formulas/collection-formulas/db/select-function-params"},"events":{"beforeload":"store.getProxy().extraParams.functionId = app.cbxFncName.getValue();"},"children":[],"expanded":false,"type":"store"},{"configs":{"itemId":"columns"},"children":[{"configs":{"text":"{#la_code#}","sortable":"false","width":"150","dataIndex":"PARAM_CODE","titleAlign":"center","itemId":"PARAM_CODE"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#la_name#}","sortable":"false","width":"175","dataIndex":"PARAM_NAME","titleAlign":"center","itemId":"PARAM_NAME"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#la_value#}","width":"200","sortable":"false","dataIndex":"PARAM_VAL_NAME","titleAlign":"center","itemId":"PARAM_VAL_NAME"},"children":[{"configs":{"itemId":"editor","editable":"true"},"events":{"expand":"/*@date 2016-09-06\n *1、校验取数sql是否存在。\n *2、获取参数值的取数sql，替换取数sql中的参数,判断函数-->hasReferenceParam\n *3、加载数据\n */\n//获取当前选中行的数据\nvar _selRows = app.cbxFunParams.getSelection();\nvar _selRecord = _selRows[0];\n//参数的取数sql\nvar _paramSql = _selRecord.data.PARAM_LOV;\nvar _isSql = /select|SELECT .+/;\nif(Ext.isEmpty(_paramSql)){\n  Wb.info('内置参数值SQL不存在！');\n}else{\n  if(_isSql.test(_paramSql)){\n    var matchStr = '';\n    while((matchStr = hasReferenceParam(_paramSql)) !== ''){\n      var tmpObj = matchStr.replace('{{', '').replace('}}', '');\n      var refParamVal = '';\n      /*判断参数SQL中是否存在着当前函数内的参数引用\n       *例如：函数getX()有3个参数 A B C，其中A参数的取数SQL中又以B参数为条件，此时参数B必须先于参数A设置值，\n       *picker 是翻译PARAM_LOV的结果集\n       *选择picker的结果后，将其名称设置到PARAM_VAL_NAME字段，将其编码设置到 PARAM_VAL_CODE 字段上\n       *注意：【上述两个字段并不存在参数表中，只是用来存放函数参数的选择值】\n       */\n      var tmpRefRecord = app.cbxFunParams.getStore().findRecord('PARAM_CODE',tmpObj);\n      if(!Ext.isEmpty(tmpRefRecord)){\n        refParamVal = tmpRefRecord.data.PARAM_VAL_CODE;\n        if(Ext.isEmpty(refParamVal)){\n          Wb.info('当前参数依赖于参数【' + tmpObj + '】,请先设置该参数');\n          return ;\n        }else{\n          //替换取数SQL中的【依赖参数】\n          _paramSql = _paramSql.replace(matchStr, \"'\" + refParamVal + \"'\");\n        }\n      }else{\n        //依赖参数不存在\n        Wb.info('不存在依赖参数【' + tmpObj + '】请检查');\n        return ;\n      }\n    }\n    //依赖参数校验完毕，加载参数值\n    _paramSql = 'select tmp.* from ('+_paramSql+') tmp';\n    //赋值全局变量\n    globalSql = _paramSql;\n    app.paramValComp.getStore().load({\n      params:{'sql':_paramSql}\n    });\n  }else{\n    Wb.info('内置参数值SQL语法错误，请检查函数公式！');\n    return ;\n  }\n}\n"},"children":[{"configs":{"tagConfigs":"minWidth:650","multiSelect":"false","pagingBar":"false","height":"350","itemId":"pickComp","forceFit":"true","normalName":"paramValComp"},"events":{"itemclick":"var rec = app.cbxFunParams.getSelection()[0];\nrec.set('PARAM_VAL_CODE',record.get('CODE'));\nrec.set('PARAM_VAL_NAME',record.get('NAME'));\nvar picker = this.ownerCmp;\npicker.setValue(record.get('NAME'));\npicker.collapse();"},"children":[{"configs":{"pageSize":"-1","itemId":"store","url":"m?xwl=xc/rep/base-settings/formulas/collection-formulas/db/select-params-val"},"children":[],"expanded":false,"type":"store"},{"configs":{"itemId":"tbar"},"children":[{"configs":{"width":"240","emptyText":"{#la_queryByCodeOrName#}","itemId":"codeOrName"},"events":{"change":"var accStore = app.paramValComp.getStore();\naccStore.filterBy(function(record,id){\n  var text = record.get('NAME');\n  return (text.indexOf(newValue)!=-1);\n});","specialkey":"if (e.getKey() == Ext.EventObject.ENTER) {\n  app.btnQuery.fireEvent('click') ;\n}"},"children":[],"expanded":false,"type":"text"},{"configs":{"itemId":"btnQuery","iconCls":"seek_icon"},"events":{"click":"if(!Ext.isEmpty(globalSql)){\n  var _queryCodeOrName = app.codeOrName.getValue();\n  var _querySql = globalSql + ' where tmp.CODE like \\'%'+_queryCodeOrName+'%\\' OR tmp.NAME like \\'%'+_queryCodeOrName+'%\\'';\n  app.paramValComp.getStore().load({\n      params:{'sql':_querySql}\n    });\n}"},"children":[],"expanded":false,"type":"button"},{"configs":{"itemId":"btnReset","iconCls":"cancel_icon"},"events":{"click":"app.codeOrName.setValue('') ;\nvar pickGrid = app.paramValComp.ownerCmp;\npickGrid.setValue('');\n//清空已经选择的参数值\nvar _rows = app.cbxFunParams.getSelection();\nvar _row = _rows[0];\n _row.set('PARAM_VAL_CODE','');\n _row.set('PARAM_VAL_NAME','');"},"children":[],"expanded":false,"type":"button"}],"expanded":true,"type":"toolbar"},{"configs":{"itemId":"columns"},"children":[{"configs":{"hidden":"true","dataIndex":"ID","itemId":"ID"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#la_code#}","dataIndex":"CODE","titleAlign":"center","itemId":"CODE","flex":"2"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#la_name#}","dataIndex":"NAME","titleAlign":"center","itemId":"NAME","flex":"4"},"children":[],"expanded":false,"type":"column"}],"expanded":true,"type":"array"}],"expanded":true,"type":"grid"}],"expanded":true,"type":"picker"}],"expanded":false,"type":"column"},{"configs":{"text":"参数ID","hidden":"true","dataIndex":"PARAM_ID","itemId":"PARAM_ID"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"参数取数SQL","hidden":"true","dataIndex":"PARAM_LOV","itemId":"PARAM_LOV"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"选择后的参数值","hidden":"true","sortable":"false","width":"175","dataIndex":"PARAM_VAL_CODE","titleAlign":"center","itemId":"PARAM_VAL_CODE"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"{#la_mustFillout#}","width":"100","align":"center","dataIndex":"MANDATORY","titleAlign":"center","itemId":"MANDATORY","renderer":"if(value === 'Y'){\n  return '<font style=\"color:#FF0000\">'+record.get('MANDATORY_NAME')+'<\/font>';\n}else{\n  return '<font style=\"color:#3CB371\">'+record.get('MANDATORY_NAME')+'<\/font>';\n}"},"children":[],"expanded":false,"type":"column"}],"expanded":true,"type":"array"}],"expanded":true,"type":"grid"}],"expanded":false,"type":"panel"}],"expanded":true,"type":"tab"},{"configs":{"region":"south","height":"170","style":"border-wdith:0px","itemId":"calForm","border":"true","bodyPadding":"10"},"children":[{"configs":{"height":"30","layout":"column","columnWidth":"1","itemId":"td1","border":"false"},"children":[{"configs":{"itemId":"testHrcyId"},"children":[],"expanded":false,"type":"hidden"},{"configs":{"tagConfigs":"columnWidth:1","labelWidth":"60","displayField":"LEDGER_NAME","valueField":"LEDGER_ID","labelAlign":"right","itemId":"cbxLedgers","fieldLabel":"{#la_formulaLedger#}"},"events":{"change":"var idx = combo.store.find('LEDGER_ID',newValue) ;\nvar r = combo.store.getAt(idx) ;\n\nvar orgId = r.get('ORG_ID') ;\nvar cnyCode = r.get('CURRENCY_CODE') ;\n\nWb.setValue(app.cbxEntity,{'cbxEntity':orgId}) ;\nWb.setValue(app.cbxTestCny,{'cbxTestCny':cnyCode}) ;\napp.testHrcyId.setValue(r.get('ACC_HRCY_ID'));"},"children":[{"configs":{"itemId":"store","autoLoad":"true","url":"m?xwl=xc/com-qry/gl-ledgers/select-sec-fd-ledgers"},"events":{"load":"/*\n *若为账簿级公式设置，测试区域的账簿、公司、币种都不能被选择\n */\nif('{#LEDGER_ID#}' !== '-1'){\n  app.cbxLedgers.setValue('{#LEDGER_ID#}');\n  app.cbxLedgers.setReadOnly(true);\n  app.cbxTestCny.setReadOnly(true);\n}"},"children":[],"expanded":false,"type":"store"}],"expanded":true,"type":"combo"}],"expanded":false,"type":"panel"},{"configs":{"height":"30","layout":"column","columnWidth":"1","itemId":"td2","border":"false"},"children":[{"configs":{"tagConfigs":"columnWidth:1","labelWidth":"60","readOnly":"true","displayField":"ORG_NAME","valueField":"ORG_ID","labelAlign":"right","itemId":"cbxEntity","fieldLabel":"{#la_orgFormula#}"},"events":{"beforequery":"var combo = plan.combo;\nif (!plan.forceAll) {\n  var value = plan.query;\n  combo.store.filterBy(function(record, id) {\n    var text = record.get(combo.displayField);\n    return (text.indexOf(value) != -1);\n  });\n  combo.expand();\n  return false;\n}"},"children":[{"configs":{"pageSize":"-1","itemId":"store","autoLoad":"true","url":"m?xwl=xc/rep/base-settings/formulas/collection-formulas/db/select-test-org"},"children":[],"expanded":true,"type":"store"}],"expanded":true,"type":"combo"}],"expanded":false,"type":"panel"},{"configs":{"height":"30","layout":"column","columnWidth":"1","itemId":"td3","border":"false"},"children":[{"configs":{"tagConfigs":"columnWidth:0.5","labelWidth":"60","displayField":"PERIOD_CODE","valueField":"PERIOD_CODE","labelAlign":"right","itemId":"cbxTestPeriod","fieldLabel":"{#la_periodFormula#}"},"events":{"beforequery":"var combo = plan.combo;\nif (!plan.forceAll) {\n  var value = plan.query;\n  combo.store.filterBy(function(record, id) {\n    var text = record.get(combo.displayField);\n    return (text.indexOf(value) != -1);\n  });\n  combo.expand();\n  return false;\n}"},"children":[{"configs":{"pageSize":"-1","itemId":"store","autoLoad":"true","url":"m?xwl=xc/rep/base-settings/formulas/collection-formulas/db/select-test-period"},"events":{"beforeload":"store.getProxy().extraParams.ledgerId = app.cbxLedgers.getValue();"},"children":[],"expanded":true,"type":"store"}],"expanded":true,"type":"combo"},{"configs":{"tagConfigs":"columnWidth:0.5","labelWidth":"60","readOnly":"true","displayField":"CURRENCY_NAME","valueField":"CURRENCY_CODE","labelAlign":"right","itemId":"cbxTestCny","fieldLabel":"{#la_currencyFormula#}"},"children":[{"configs":{"itemId":"store","autoLoad":"true","url":"m?xwl=xc/rep/base-settings/formulas/collection-formulas/db/select-formula-currnecy"},"children":[],"expanded":false,"type":"store"}],"expanded":true,"type":"combo"}],"expanded":true,"type":"panel"},{"configs":{"height":"30","layout":"column","columnWidth":"1","itemId":"td4","border":"false"},"children":[{"configs":{"tagConfigs":"columnWidth:1","labelWidth":"60","labelAlign":"right","itemId":"testResult","fieldLabel":"{#la_testResult#}"},"children":[],"expanded":false,"type":"text"}],"expanded":true,"type":"panel"}],"expanded":true,"type":"form"}],"expanded":true,"type":"panel"},{"configs":{"height":"600","layout":"form","columnWidth":".075","itemId":"operator","border":"true"},"children":[{"configs":{"text":"   >>","width":"60","itemId":"writeFormula","y":"250","tooltip":"{#la_writeFormula#}","x":"8"},"events":{"click":"/*公式设置校验\n *1、必填项\n *2、设置绝对期间时，【前移期间】必须为空\n *3、写入公式包含两部分：【1】指标间取数公式；【2】自定义取数公式\n */\n//指标间取数\nif(app.tab.getActiveTab().itemId === 'itemPanel'){\n  if(!Wb.verify(app.itemPanel)){\n  Wb.info('{#la_mustFilloutMsg#}');\n}else{\n  var periodCode = app.cbxPeriod.getValue();\n  var periodCodeName = app.cbxPeriod.getRawValue();\n  if(!Ext.isEmpty(app.offsetPeriod.getValue()) && periodCodeName.indexOf('<') === -1){\n     Wb.info('{#la_absolutePeriodMsg#}');\n     return false;\n  }\n  //构造公式\n  var originalRule = app.formulaStr.getValue();\n  originalRule +='GetRepVal(\"';\n  //要追加的公式\n  var appendRule = '';\n  var offsetPeriod = app.offsetPeriod.getValue();\n    //偏移期间不为空\n  if(!Ext.isEmpty(offsetPeriod) && offsetPeriod !== 0){\n    if(appendRule === ''){\n      appendRule = '|QJ|=|'+periodCode+\":\"+offsetPeriod+\"|\";\n    }else{\n      appendRule += ',|QJ|=|'+periodCode+\"|\";\n    }\n  }else{\n   //偏移期间为空\n    if(appendRule === \"\"){\n      appendRule = '|QJ|=|'+periodCode+\"|\";\n    }else{\n      appendRule = appendRule+',|QJ|=|'+periodCode+\"|\";\n    }\n  }\n \n  // 组合账簿\n  var vDW = app.cbx_ledgers.getValue();\n  if(!Ext.isEmpty(vDW)){\n    if(appendRule === \"\"){\n       appendRule = '|DW|='+\"|\"+vDW+\"|\";\n    }else{\n      appendRule += ',|DW|='+\"|\"+vDW+\"|\";\n    }\n  }  \n  \n  //组合行指标\n  var vRow = app.cbxRowItems.getValue();\n  if(!Ext.isEmpty(vRow)){\n    if(appendRule === \"\"){\n       appendRule = '|ROW|='+\"|\"+vRow+\"|\";\n    }else{\n      appendRule += ',|ROW|='+\"|\"+vRow+\"|\";\n    }\n  }\n  //组合列指标\n  var vCol = app.cbxColItems.getValue();\n  if(!Ext.isEmpty(vCol)){\n    if(appendRule === \"\"){\n       appendRule = '|COL|='+\"|\"+vCol+\"|\";\n    }else{\n      appendRule += ',|COL|='+\"|\"+vCol+\"|\";\n    }\n  }\n  //组合币种指标\n  var vCny = app.cbxCurrenies.getValue();\n  if(!Ext.isEmpty(vCny)){\n    if(appendRule === \"\"){\n       appendRule = '|BZ|='+\"|\"+vCny+\"|\";\n    }else{\n      appendRule += ',|BZ|='+\"|\"+vCny+\"|\";\n    }\n  }\nappendRule = originalRule+appendRule+'\"'+\")\";\n//设置新的公式值\napp.formulaStr.setValue(appendRule);\n}\n}else{\n//自定义取数\nif(app.form1.getForm().isValid()=== false){\n  Wb.info('{#la_mustFilloutMsg#}');\n  return ;\n}\nvar isValid = true;\nvar _innerCode = '';\nvar _paramsName = '';\nvar _paramsCode = '';\nvar P_CODE = \"\";\napp.cbxFunParams.getStore().each(function(item){\n    _innerCode  = item.get(\"PARAM_VAL_CODE\");\n\t_paramsName = item.get(\"PARAM_NAME\");\n\t_paramsCode = item.get(\"PARAM_CODE\");\n  if(item.get('MANDATORY') === 'Y' && Ext.isEmpty(_innerCode)){\n    Wb.info('【'+_paramsName+'】'+'{#la_partialMustMsg#}');\n    isValid = false;\n    return ;\n  }else{\n      if(!Ext.isEmpty(_innerCode)){\n        P_CODE = P_CODE+_paramsCode+\"=\"+_innerCode+\",\";\n      }\n  }\n});\nif(!isValid)\n  return ;\nvar funRecord = app.cbxFncName.getStore().findRecord('FUNC_ID',app.cbxFncName.getValue());\nP_CODE = P_CODE.substring(0,P_CODE.length-1);\nvar defineRule = \"GetExpVal(\"+\"\\\"\"+funRecord.data.FUNC_CODE+\">>\"+P_CODE+\"\\\")\";\nvar rule = app.formulaStr.getValue();\t\nrule =rule+defineRule;\napp.formulaStr.setValue(rule);\t\t\t\t\nruleTranslate();\t\t\t\t\t\t\t\t\n\n  \n  \n  \n  \n  \n  \n  \n  \n}\n\n\n\n\n\n"},"children":[],"expanded":false,"type":"button"},{"configs":{"text":"{#la_formulaTestBtn#}","width":"60","itemId":"calcFormula","y":"500","x":"8"},"events":{"click":"//获取单元格公式\nvar formulaText = app.formulaStr.getValue();\nif(Ext.isEmpty(formulaText)){\n\tWb.info('{#la_setFormulaFirst#}');\n\treturn false;\n}\nformulaText = formulaText.replace(/\\ /g,\"\").replace(/\\s/g,\"\");\n//试运行账簿\nvar _testLedgerId = app.cbxLedgers.getValue() ;\nif(Ext.isEmpty(_testLedgerId)){\n\tWb.info('{#la_selLedgerMsg#}');\n\treturn false;\n}\n//试运行组织\nvar testOrgId = app.cbxEntity.getValue();\n//试运行期间\nvar testPeriod = app.cbxTestPeriod.getValue();\nif(Ext.isEmpty(testPeriod)){\n\tWb.info('{#la_selPeriodMsg#}');\n\treturn false;\n}\n//试运算币种\nvar textCnyCode = app.cbxTestCny.getValue() ;\n\n// 式运算参数\nvar params = {\n  'formula'    : formulaText,\n  'ledgerId'   : _testLedgerId,\n  'accHrcyId'  : app.testHrcyId.getValue(),\n  'orgId'      : testOrgId,\n  'cnyCode'    : textCnyCode,\n  'periodCode' : testPeriod\n} ;\n\nvar processbar = Ext.Msg.wait(\"{#la_testForTip#}\", \"{#la_tipTitle#}\") ;\n\n// 提交请求\nWb.request({\n\turl : '{#contextPath#}'+'/xcRepDataAction.do?method=testFormulaCal',\n\tmethod :'post',\n\ttimeout : 3600000,\n\tparams: {\n      'reqParams' : Wb.encode(params)\n    },\n\tsuccess:function(response,options){\n      processbar.hide() ;\n      var retObj = Wb.decode(response.responseText);\n      if(retObj.flag == \"0\"){\n        app.testResult.setValue(retObj.result);\n      }else{\n        Wb.info(retObj.msg);\n      }\n\t}\n});\n"},"children":[],"expanded":false,"type":"button"}],"expanded":true,"type":"panel"},{"configs":{"height":"600","layout":"fit","columnWidth":".44","itemId":"result","border":"false"},"children":[{"configs":{"title":"公式信息","style":"border-wdith:0px","layout":"form","itemId":"form"},"children":[{"configs":{"enableLinks":"false","enableColors":"true","enableLists":"false","enableSourceEdit":"false","itemId":"rcItemDesc","enableFormat":"true","enableFontSize":"true","height":"150","enableFont":"false","enableAlignments":"true","split":"true","border":"false","disabled":"false"},"events":{"afterrender":"app.rcItemDesc.setValue('{#itemTitle#}') ;"},"children":[],"expanded":false,"type":"htmleditor"},{"configs":{"itemId":"calSpace","border":"false"},"children":[{"configs":{"itemId":"tbar","border":"false"},"children":[{"configs":{"text":"{#la_operatorFlag#}","itemId":"label1"},"children":[],"expanded":false,"type":"label"},{"configs":{"text":"(","itemId":"("},"events":{"click":"var vfa = app.formulaStr.getValue();\napp.formulaStr.setValue(vfa+\"(\");"},"children":[],"expanded":false,"type":"button"},{"configs":{"text":")","itemId":")"},"events":{"click":"var vfa = app.formulaStr.getValue();\napp.formulaStr.setValue(vfa+\")\");"},"children":[],"expanded":false,"type":"button"},{"configs":{"text":"+","itemId":"plus"},"events":{"click":"var vfa = app.formulaStr.getValue();\napp.formulaStr.setValue(vfa+\"+\");"},"children":[],"expanded":false,"type":"button"},{"configs":{"text":"--","itemId":"minus"},"events":{"click":"var vfa = app.formulaStr.getValue();\napp.formulaStr.setValue(vfa+\"-\");"},"children":[],"expanded":false,"type":"button"},{"configs":{"text":"*","itemId":"multiply"},"events":{"click":"var vfa = app.formulaStr.getValue();\napp.formulaStr.setValue(vfa+\"*\");"},"children":[],"expanded":false,"type":"button"},{"configs":{"text":"/","itemId":"divide"},"events":{"click":"var vfa = app.formulaStr.getValue();\napp.formulaStr.setValue(vfa+\"/\");"},"children":[],"expanded":false,"type":"button"},{"configs":{"text":"{#la_formulaClearBtn#}","itemId":"clear"},"events":{"click":"app.formulaStr.setValue(\"\");\napp.formulaDesc.setValue('');\napp.testResult.setValue('');"},"children":[],"expanded":false,"type":"button"},{"configs":{"text":"{#la_translateBtn#}","itemId":"translate"},"events":{"click":"if(!Ext.isEmpty(app.formulaStr.getValue())){\n  ruleTranslate();\n}else{\n  Wb.info('{#la_setFormulaFirst#}');\n}"},"children":[],"expanded":false,"type":"button"}],"expanded":true,"type":"toolbar"}],"expanded":true,"type":"panel"},{"configs":{"labelWidth":"60","height":"200","emptyText":"{#la_noFormula#}","labelAlign":"right","itemId":"formulaStr","fieldLabel":"{#la_tmpMsg5#}"},"events":{"afterrender":"// 处理公式字符串\nvar formulaStr = '{#data#}' ;\nif(!Ext.isEmpty(formulaStr) && 'null' !== formulaStr){\n  formulaStr = decodeURIComponent(formulaStr) ;\n  formulaStr = formulaStr.replace(/&quot;/g,'\"')  ;\n  formulaStr = formulaStr.replace(/&gt;/g,'>') ;\n  textarea.setValue(formulaStr) ;\n}else{\n   textarea.setValue('') ;\n}"},"children":[],"expanded":false,"type":"textarea"},{"configs":{"labelWidth":"60","readOnly":"true","height":"150","labelAlign":"right","itemId":"formulaDesc","fieldLabel":"{#la_tmpMsg6#}"},"children":[],"expanded":false,"type":"textarea"}],"expanded":true,"type":"form"}],"expanded":true,"type":"panel"}],"expanded":true,"type":"panel"}],"expanded":true,"type":"window"}],"expanded":true,"type":"module"}],"pageLink":"","iconCls":""}